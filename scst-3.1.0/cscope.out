cscope 15 $HOME/src_code/scst-3.1.0 -q 0000006886 0001939555
	@scst/include/backport.h

1 #iâdeà
_SCST_BACKPORT_H_


2 
	#_SCST_BACKPORT_H_


	)

23 
	~<lšux/¦ab.h
>

24 
	~<lšux/wr™eback.h
>

28 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(3, 16, 0)

29 
	#smp_mb__aá”_©omic_šc
 
smp_mb__aá”_©omic


	)

30 
	#smp_mb__aá”_þ—r_b™
 
smp_mb__aá”_©omic


	)

31 
	#smp_mb__befÜe_©omic_dec
 
smp_mb__befÜe_©omic


	)

32 
	#smp_mb__aá”_©omic_dec
 
smp_mb__aá”_©omic


	)

37 #ià
LINUX_VERSION_CODE
 <ð
KERNEL_VERSION
(2, 6, 32)

38 #iâdeà
O_DSYNC


39 
	#O_DSYNC
 
O_SYNC


	)

45 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 31)

46 
šlše
 
	$queue_max_hw_£ùÜs
(
»que¡_queue
 *
q
)

48  
q
->
max_hw_£ùÜs
;

49 
	}
}

54 #ià
LINUX_VERSION_CODE
 <ð
KERNEL_VERSION
(2, 6, 20)

55 #iâdeà
__´štf


56 
	#__´štf
(
a
, 
b
è
	`__©Œibu‹__
((
	`fÜm©
(
´štf
,a,b)))

	)

60 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 21)

61 #iâdeà
__®igÃd


62 
	#__®igÃd
(
x
è
	`__©Œibu‹__
((
	`®igÃd
(x)))

	)

64 #iâdeà
__·cked


65 
	#__·cked
 
	`__©Œibu‹__
((
·cked
))

	)

69 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 26)

74 
	#ACCESS_ONCE
(
x
è(*(vÞ©ž
	`ty³of
(xè*)&(x))

	)

79 #ià
LINUX_VERSION_CODE
 <ð
KERNEL_VERSION
(2, 6, 20è&& !
defšed
(
BACKPORT_LINUX_CPUMASK_H
)

80 
	#Ä_ýu_ids
 
NR_CPUS


	)

83 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 28è&& 
defšed
(
__LINUX_CPUMASK_H
)

88 
ýumask_t
 
	týumask_v¬_t
[1];

89 
	#ýumask_b™s
(
maskp
è((maskp)->
b™s
)

	)

90 #ifdeà
CONFIG_CPUMASK_OFFSTACK


93 
	#Ä_ýumask_b™s
 
Ä_ýu_ids


	)

95 
	#Ä_ýumask_b™s
 
NR_CPUS


	)

98 #ifdeà
CONFIG_CPUMASK_OFFSTACK


99 
boÞ
 
®loc_ýumask_v¬
(
ýumask_v¬_t
 *
mask
, 
gå_t
 
æags
);

100 
ä“_ýumask_v¬
(
ýumask_v¬_t
 
mask
);

102 
šlše
 
	$ä“_ýumask_v¬
(
ýumask_v¬_t
 
mask
)

104 
	}
}

106 
šlše
 
boÞ
 
	$®loc_ýumask_v¬
(
ýumask_v¬_t
 *
mask
, 
gå_t
 
æags
)

108  
Œue
;

109 
	}
}

113 
šlše
 
	$ýumask_check
(
ýu
)

115 #ifdeà
CONFIG_DEBUG_PER_CPU_MAPS


116 
	`WARN_ON_ONCE
(
ýu
 >ð
Ä_ýumask_b™s
);

118  
ýu
;

119 
	}
}

128 
šlše
 
	$ýumask_Ãxt
(
n
, cÚ¡ 
ýumask_t
 *
¤ý
)

131 ià(
n
 != -1)

132 
	`ýumask_check
(
n
);

133  
	`fšd_Ãxt_b™
(
	`ýumask_b™s
(
¤ý
), 
Ä_ýumask_b™s
, 
n
+1);

134 
	}
}

143 
	#fÜ_—ch_ýu
(
ýu
, 
mask
) \

144 (
ýu
) = -1; \

145 (
ýu
èð
	`ýumask_Ãxt
((ýu), (
mask
)), \

146 (
ýu
è< 
Ä_ýu_ids
;)

	)

153 
šlše
 
	$ýumask_£t_ýu
(
ýu
, 
ýumask_t
 *
d¡p
)

155 
	`£t_b™
(
ýu
, 
	`ýumask_b™s
(
d¡p
));

156 
	}
}

163 
šlše
 
	$ýumask_cÝy
(
ýumask_t
 *
d¡p
,

164 cÚ¡ 
ýumask_t
 *
¤ý
)

166 
	`b™m­_cÝy
(
	`ýumask_b™s
(
d¡p
), cpumask_b™s(
¤ý
), 
Ä_ýumask_b™s
);

167 
	}
}

173 
šlše
 
	$ýumask_£Î
(
ýumask_t
 *
d¡p
)

175 
	`b™m­_fžl
(
	`ýumask_b™s
(
d¡p
), 
Ä_ýumask_b™s
);

176 
	}
}

183 
šlše
 
boÞ
 
	$ýumask_equ®
(cÚ¡ 
ýumask_t
 *
¤c1p
,

184 cÚ¡ 
ýumask_t
 *
¤c2p
)

186  
	`b™m­_equ®
(
	`ýumask_b™s
(
¤c1p
), cpumask_b™s(
¤c2p
),

187 
Ä_ýumask_b™s
);

188 
	}
}

194 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 28)

196 
	mDLM_LSFL_NEWEXCL
 = 0

202 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 9, 0) && \

203 !
	$defšed
(
CONFIG_COMPAT_KERNEL_3_12
)

209 
šlše
 
šode
 *
	$fže_šode
(cÚ¡ 
fže
 *
f
)

211  
f
->
f_d’Œy
->
d_šode
;

212 
	}
}

215 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 35)

216 
šlše
 
	$vfs_fsync_backpÜt
(
fže
 *fže, 
d©async
)

218 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 29)

219 
šode
 *šodð
	`fže_šode
(
fže
);

221  
	`sync_·ge_¿nge
(
šode
, 
fže
->
f_m­pšg
, 0, 
	`i_size_»ad
(inode));

223  
	`vfs_fsync
(
fže
, fže->
f_·th
.
d’Œy
, 
d©async
);

225 
	}
}

227 
	#vfs_fsync
 
vfs_fsync_backpÜt


	)

232 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 19)

233 #iâdeà
RHEL_RELEASE_CODE


234 
_BoÞ
 
	tboÞ
;

236 
	#Œue
 1

	)

237 
	#çl£
 0

	)

240 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 29)

241 #iâdeà
sw­


242 
	#sw­
(
a
, 
b
) \

243 dØ{ 
	`ty³of
(
a
è
__tmp
 = (a); (aèð(
b
); (bèð__tmp; } 0)

	)

247 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 35) && \

248 (!
defšed
(
RHEL_MAJOR
è|| 
	gRHEL_MAJOR
 -0 < 6 || \

249 
	gRHEL_MAJOR
 -0 =ð6 && 
RHEL_MINOR
 -0 < 1)

250 
hex_to_bš
(
ch
);

253 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 38)

258 
šlše
 
	$hex2bš
(
u8
 *
d¡
, cÚ¡ *
¤c
, 
size_t
 
couÁ
)

260 
couÁ
--) {

261 *
d¡
 = 
	`hex_to_bš
(*
¤c
++) << 4;

262 *
d¡
 +ð
	`hex_to_bš
(*
¤c
++);

263 
d¡
++;

265 
	}
}

268 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 39) && \

269 
	gLINUX_VERSION_CODE
 !ð
KERNEL_VERSION
(2, 6, 38) && \

270 (!
defšed
(
RHEL_MAJOR
è|| 
	gRHEL_MAJOR
 -0 < 6)

271 
šlše
 
__mu¡_check
 
	$k¡¹ouÎ
(cÚ¡ *
s
, 
ba£
,

272 *
»s
)

274  
	`¡riù_¡¹ouÎ
(
s
, 
ba£
, 
»s
);

275 
	}
}

277 
šlše
 
__mu¡_check
 
	$k¡¹Þl
(cÚ¡ *
s
, 
ba£
,

278 *
»s
)

280  
	`¡riù_¡¹Þl
(
s
, 
ba£
, 
»s
);

281 
	}
}

283 
šlše
 
__mu¡_check
 
	$k¡¹oul
(cÚ¡ *
s
, 
ba£
,

284 *
»s
)

286  
	`¡riù_¡¹oul
(
s
, 
ba£
, 
»s
);

287 
	}
}

289 
šlše
 
__mu¡_check
 
	$k¡¹Þ
(cÚ¡ *
s
, 
ba£
,

290 *
»s
)

292  
	`¡riù_¡¹Þ
(
s
, 
ba£
, 
»s
);

293 
	}
}

298 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 23)

299 
	eumh_wa™
 {

300 
	mUMH_NO_WAIT
 = -1,

301 
	mUMH_WAIT_EXEC
 = 0,

302 
	mUMH_WAIT_PROC
 = 1,

308 #iâdeà
__li¡_fÜ_—ch


310 
	#__li¡_fÜ_—ch
 
li¡_fÜ_—ch


	)

317 
šlše
 
boÞ
 
	$li¡_’Œy_š_li¡
(cÚ¡ 
li¡_h—d
 *
’Œy
)

319  !
	`li¡_em±y
(
’Œy
);

320 
	}
}

324 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 32)

325 
	#lockd•_as£¹_h–d
(
l
èdØ{ ()Ö); } 0)

	)

330 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 37)

335 #iâdeà
š_£rvšg_soáœq


336 
	#š_£rvšg_soáœq
(è
	`š_soáœq
()

	)

342 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 28)

343 #iâdeà
´_”r


344 
	#´_”r
(
fmt
, ...è
	`´štk
(
KERN_ERR
 
	`´_fmt
(fmt), ##
__VA_ARGS__
)

	)

348 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 35)

353 #iâdeà
´_w¬n


354 
	#´_w¬n
 
´_w¬nšg


	)

358 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 36) && \

359 (!
defšed
(
RHEL_MAJOR
è|| 
	gRHEL_MAJOR
 -0 < 6)

364 
šlše
 
__©Œibu‹__
 ((
	$fÜm©
 (
´štf
, 1, 2)))

365 
	$no_´štk
(cÚ¡ *
s
, ...è{  0; 
	}
}

370 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 0, 0è&& !
defšed
(
kä“_rcu
)

371 (*
	trcu_ÿÎback_t
)(
	trcu_h—d
 *);

372 
	#__is_kä“_rcu_off£t
(
off£t
è((off£tè< 4096)

	)

373 
	#kä“_ÿÎ_rcu
(
h—d
, 
rcb
è
	`ÿÎ_rcu
(h—d,„cb)

	)

374 
	#__kä“_rcu
(
h—d
, 
off£t
) \

376 
	`BUILD_BUG_ON
(!
	`__is_kä“_rcu_off£t
(
off£t
)); \

377 
	`kä“_ÿÎ_rcu
(
h—d
, (
rcu_ÿÎback_t
)()(
off£t
)); \

378 
	}
} 0)

	)

379 
	#kä“_rcu
(
±r
, 
rcu_h—d
) \

380 
	`__kä“_rcu
(&((
±r
)->
rcu_h—d
), 
	`off£tof
(
	`ty³of
(*ÕŒ)),„cu_h—d))

	)

385 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 26) && \

386 (!
defšed
(
RHEL_MAJOR
è|| 
	gRHEL_MAJOR
 -0 < 6)

387 
	#£t_ýus_®lowed_±r
(
p
, 
Ãw_mask
è
	`£t_ýus_®lowed
(Õ), *Òew_mask))

	)

392 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 24)

402 
šlše
 
boÞ
 
	$sg_is_chaš
(
sÿ‰”li¡
 *
sg
)

404  
çl£
;

405 
	}
}

407 
šlše
 
sÿ‰”li¡
 *
	$sg_chaš_±r
(
sÿ‰”li¡
 *
sg
)

409  
NULL
;

410 
	}
}

412 
	#sg_is_Ï¡
(
sg
è
çl£


	)

414 #iâdeà
sg_·ge


415 
šlše
 
·ge
 *
	$sg_·ge
(
sÿ‰”li¡
 *
sg
)

417  
sg
->
·ge
;

418 
	}
}

421 
šlše
 *
	$sg_vœt
(
sÿ‰”li¡
 *
sg
)

423  
	`·ge_add»ss
(
	`sg_·ge
(
sg
)è+ sg->
off£t
;

424 
	}
}

426 
šlše
 
	$sg_m¬k_’d
(
sÿ‰”li¡
 *
sg
)

428 
	}
}

430 #iâdeà
__BACKPORT_LINUX_SCATTERLIST_H_TO_2_6_23__


432 
šlše
 
	$sg_š™_bË
(
sÿ‰”li¡
 *
sgl
, 
ÃÁs
)

434 
	`mem£t
(
sgl
, 0, (*sglè* 
ÃÁs
);

435 
	}
}

437 
šlše
 
	$sg_assign_·ge
(
sÿ‰”li¡
 *
sg
, 
·ge
 *page)

439 
sg
->
·ge
 =…age;

440 
	}
}

442 
šlše
 
	$sg_£t_·ge
(
sÿ‰”li¡
 *
sg
, 
·ge
 *page,

443 
Ën
, 
off£t
)

445 
	`sg_assign_·ge
(
sg
, 
·ge
);

446 
sg
->
off£t
 = offset;

447 
sg
->
Ëngth
 = 
Ën
;

448 
	}
}

450 #iâdeà
fÜ_—ch_sg


452 
	#fÜ_—ch_sg
(
sgli¡
, 
sg
, 
Ä
, 
__i
) \

453 
__i
 = 0, 
sg
 = (
sgli¡
); __˜< (
Ä
); __i++, sg = 
	`sg_Ãxt_šlše
(sg))

	)

461 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 22)

462 
	#KMEM_CACHE
(
__¡ruù
, 
__æags
è
	`kmem_ÿche_ü—‹
(#__struct,\

463 (
__¡ruù
), 
	`__®ignof__
(__struct),\

464 (
__æags
), 
NULL
, NULL)

	)

467 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 4, 0) && \

468 !(
	gLINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(3, 2, 52) && \

469 
	gLINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 3, 0)) && \

470 (!
defšed
(
RHEL_MAJOR
è|| 
	gRHEL_MAJOR
 -0 < 6)

471 
šlše
 *
	$km®loc_¬¿y
(
size_t
 
n
, size_ˆ
size
, 
gå_t
 
æags
)

473 ià(
size
 !ð0 && 
n
 > 
ULONG_MAX
 / size)

474  
NULL
;

475  
	`km®loc
(
n
 * 
size
, 
æags
);

476 
	}
}

481 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 18, 0)

482 
	st10_pi_tu¶e
 {

483 
__be16
 
	mgu¬d_g
;

484 
__be16
 
	m­p_g
;

485 
__be32
 
	m»f_g
;

491 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 24)

496 
	tušŒ_t
;

499 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 22)

500 *
kva¥rštf
(
gå_t
 
gå
, cÚ¡ *
fmt
, 
va_li¡
 
­
);

505 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 37) && \

506 (!
defšed
(
RHEL_MAJOR
è|| 
	gRHEL_MAJOR
 -0 < 5 || \

507 
	gRHEL_MAJOR
 -0 =ð5 && 
RHEL_MINOR
 -0 < 10 || \

508 
RHEL_MAJOR
 -0 =ð6 && 
RHEL_MINOR
 -0 < 1)

513 
šlše
 *
	$vz®loc
(
size
)

515  
	`__vm®loc
(
size
, 
GFP_KERNEL
 | 
__GFP_HIGHMEM
 | 
__GFP_ZERO
,

516 
PAGE_KERNEL
);

517 
	}
}

522 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 23è&& !
defšed
(
BACKPORT_LINUX_WORKQUEUE_TO_2_6_19
)

523 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 20))

524 
šlše
 
	$ÿnûl_d–ayed_wÜk_sync
(
d–ayed_wÜk
 *
wÜk
)

526 
»s
;

528 
»s
 = 
	`ÿnûl_d–ayed_wÜk
(
wÜk
);

529 
	`æush_scheduËd_wÜk
();

530  
»s
;

531 
	}
}

540 
	#ÿnûl_d–ayed_wÜk_sync
(
wÜk
) \

542 
»s
; \

544 
»s
 = 
	`ÿnûl_d–ayed_wÜk
((
wÜk
)); \

545 
	`æush_scheduËd_wÜk
(); \

546 
»s
; \

547 })

	)

553 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 24)

558 
šlše
 
	$scsi_bidi_cmnd
(
scsi_cmnd
 *
cmd
)

560  
çl£
;

561 
	}
}

	@scst/include/scst.h

22 #iâdeà
__SCST_H


23 
	#__SCST_H


	)

31 
	#CONFIG_SCST_DIF_INJECT_CORRUPTED_TAGS


	)

33 
	~<lšux/ty³s.h
>

34 #iâdeà
INSIDE_KERNEL_TREE


35 
	~<lšux/v”siÚ.h
>

37 
	~<lšux/blkdev.h
>

38 
	~<lšux/š‹¼u±.h
>

39 
	~<lšux/wa™.h
>

40 
	~<lšux/ýumask.h
>

41 
	~<lšux/dlm.h
>

42 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


43 
	~<lšux/log2.h
>

45 
	~<asm/uÇligÃd.h
>

48 
	#CONFIG_SCST_PER_DEVICE_CMD_COUNT_LIMIT


	)

53 #ifdeà
CONFIG_SCST_PROC


54 
	~<lšux/´oc_fs.h
>

55 
	~<lšux/£q_fže.h
>

56 #–ià
defšed
(
RHEL_MAJOR
) && RHEL_MAJOR -0 <= 5

57 #”rÜ 
The
 
SCST
 
sysfs
 
š‹rçû
 
is
 
nÙ
 
suµÜ‹d
 
Ú
 
RHEL
 5. 
PËa£
 
run
 
make
 
’abË_´oc
.

58 #–ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 26)

59 #”rÜ 
The
 
SCST
 
sysfs
 
š‹rçû
 
is
 
suµÜ‹d
 
äom
 
k”Ãl
 
v”siÚ
 2.6.26 
Ú
. 
PËa£
 
run
 
make
 
’abË_´oc
.

62 
	~<scsi/scsi_cmnd.h
>

63 
	~<scsi/scsi_deviû.h
>

64 
	~<scsi/scsi_eh.h
>

65 
	~<scsi/scsi.h
>

67 #ifdeà
INSIDE_KERNEL_TREE


68 
	~<sc¡/backpÜt.h
>

69 
	~<sc¡/sc¡_cÚ¡.h
>

71 
	~<backpÜt.h
>

72 
	~<sc¡_cÚ¡.h
>

75 #ifdeà
INSIDE_KERNEL_TREE


76 
	~<sc¡/sc¡_sgv.h
>

78 
	~"sc¡_sgv.h
"

81 
	#SCST_INTERFACE_VERSION
 \

82 
SCST_VERSION_STRING
 
SCST_INTF_VER
 
SCST_CONST_VERSION


	)

84 
	#SCST_LOCAL_NAME
 "sc¡_loÿl"

	)

99 
	mSCST_CMD_STATE_PARSE
 = 0,

102 
	mSCST_CMD_STATE_PREPARE_SPACE
,

105 
	mSCST_CMD_STATE_PREPROCESSING_DONE
,

108 
	mSCST_CMD_STATE_RDY_TO_XFER
,

111 
	mSCST_CMD_STATE_TGT_PRE_EXEC
,

117 
	mSCST_CMD_STATE_EXEC_CHECK_SN
,

120 
	mSCST_CMD_STATE_PRE_DEV_DONE
,

123 
	mSCST_CMD_STATE_MODE_SELECT_CHECKS
,

126 
	mSCST_CMD_STATE_DEV_DONE
,

129 
	mSCST_CMD_STATE_PRE_XMIT_RESP
,

132 
	mSCST_CMD_STATE_PRE_XMIT_RESP1
,

135 
	mSCST_CMD_STATE_PRE_XMIT_RESP2
,

138 
	mSCST_CMD_STATE_XMIT_RESP
,

141 
	mSCST_CMD_STATE_FINISHED
,

144 
	mSCST_CMD_STATE_FINISHED_INTERNAL
,

146 
	mSCST_CMD_STATE_LAST_ACTIVE
 = (
SCST_CMD_STATE_FINISHED_INTERNAL
+100),

151 
	mSCST_CMD_STATE_INIT_WAIT
,

154 
	mSCST_CMD_STATE_INIT
,

157 
	mSCST_CMD_STATE_PREPROCESSING_DONE_CALLED
,

160 
	mSCST_CMD_STATE_DATA_WAIT
,

166 
	mSCST_CMD_STATE_EXEC_CHECK_BLOCKING
,

169 
	mSCST_CMD_STATE_LOCAL_EXEC
,

172 
	mSCST_CMD_STATE_REAL_EXEC
,

175 
	mSCST_CMD_STATE_EXEC_WAIT
,

178 
	mSCST_CMD_STATE_XMIT_WAIT
,

185 
	#SCST_CMD_STATE_DEFAULT
 500

	)

193 
	#SCST_CMD_STATE_NEED_THREAD_CTX
 1000

	)

200 
	#SCST_CMD_STATE_STOP
 1001

	)

210 
	mSCST_MCMD_STATE_INIT
 = 0,

213 
	mSCST_MCMD_STATE_EXEC
,

216 
	mSCST_MCMD_STATE_WAITING_AFFECTED_CMDS_DONE
,

219 
	mSCST_MCMD_STATE_AFFECTED_CMDS_DONE
,

222 
	mSCST_MCMD_STATE_WAITING_AFFECTED_CMDS_FINISHED
,

225 
	mSCST_MCMD_STATE_DONE
,

228 
	mSCST_MCMD_STATE_FINISHED
,

234 
	#SCST_NON_ATOMIC
 0

	)

235 
	#SCST_ATOMIC
 1

	)

243 
	esc¡_exec_cÚ‹xt
 {

248 
	mSCST_CONTEXT_DIRECT_ATOMIC
,

254 
	mSCST_CONTEXT_DIRECT
,

257 
	mSCST_CONTEXT_TASKLET
,

260 
	mSCST_CONTEXT_THREAD
,

270 
	mSCST_CONTEXT_SAME


278 
	#SCST_RX_STATUS_SUCCESS
 0

	)

284 
	#SCST_RX_STATUS_ERROR
 1

	)

290 
	#SCST_RX_STATUS_ERROR_SENSE_SET
 2

	)

296 
	#SCST_RX_STATUS_ERROR_FATAL
 3

	)

303 
	#SCST_PREPROCESS_STATUS_SUCCESS
 0

	)

309 
	#SCST_PREPROCESS_STATUS_ERROR
 1

	)

315 
	#SCST_PREPROCESS_STATUS_ERROR_SENSE_SET
 2

	)

321 
	#SCST_PREPROCESS_STATUS_ERROR_FATAL
 3

	)

336 
	#SCST_AEN_SCSI
 0

	)

341 
	#SCST_AEN_CPU_MASK_CHANGED
 1

	)

349 
	#SCST_AEN_RES_SUCCESS
 0

	)

352 
	#SCST_AEN_RES_NOT_SUPPORTED
 -1

	)

355 
	#SCST_AEN_RES_FAILED
 -2

	)

362 
	#SCST_TGT_RES_SUCCESS
 0

	)

365 
	#SCST_TGT_RES_QUEUE_FULL
 -1

	)

371 
	#SCST_TGT_RES_NEED_THREAD_CTX
 -2

	)

378 
	#SCST_TGT_RES_FATAL_ERROR
 -3

	)

391 
	#SCST_EXEC_COMPLETED
 0

	)

394 
	#SCST_EXEC_NOT_COMPLETED
 1

	)

401 
	#SCST_SESS_IPH_INITING
 0

	)

404 
	#SCST_SESS_IPH_SUCCESS
 1

	)

407 
	#SCST_SESS_IPH_FAILED
 2

	)

410 
	#SCST_SESS_IPH_READY
 3

	)

417 
	#SCST_SESS_SPH_READY
 0

	)

420 
	#SCST_SESS_SPH_SHUTDOWN
 1

	)

423 
	#SCST_SESS_SPH_UNREG_DONE_CALLING
 2

	)

430 
	#SCST_SESS_HW_PENDING_WORK_SCHEDULED
 0

	)

444 
	#SCST_CMD_ABORTED
 0

	)

447 
	#SCST_CMD_ABORTED_OTHER
 1

	)

454 
	#SCST_CMD_NO_RESP
 2

	)

457 
	#SCST_CMD_CAN_BE_DESTROYED
 3

	)

463 
	#SCST_CMD_DEVICE_TAS
 4

	)

465 #ifdeà
CONFIG_SCST_EXTRACHECKS


467 
	#SCST_CMD_INC_EXPECTED_SN_PASSED
 10

	)

475 
	#SCST_TGT_DEV_UA_PENDING
 0

	)

478 
	#SCST_TGT_DEV_BLACK_HOLE
 1

	)

481 
	#SCST_TGT_DEV_FORWARDING
 5

	)

493 
	#SCST_IO_GROUPING_AUTO
 0

	)

496 
	#SCST_IO_GROUPING_THIS_GROUP_ONLY
 -1

	)

499 
	#SCST_IO_GROUPING_NEVER
 -2

	)

501 #ifdeà
CONFIG_SCST_PROC


506 
	#SCST_PROC_ENTRY_NAME
 "scsi_tgt"

	)

514 
	#SCST_SENSE_KEY_VALID
 1

	)

515 
	#SCST_SENSE_ASC_VALID
 2

	)

516 
	#SCST_SENSE_ASCQ_VALID
 4

	)

518 
	#SCST_SENSE_ASCx_VALID
 (
SCST_SENSE_ASC_VALID
 | \

519 
SCST_SENSE_ASCQ_VALID
)

	)

521 
	#SCST_SENSE_ALL_VALID
 (
SCST_SENSE_KEY_VALID
 | \

522 
SCST_SENSE_ASC_VALID
 | \

523 
SCST_SENSE_ASCQ_VALID
)

	)

533 
	esc¡_dif_mode
 {

534 
	mSCST_DIF_MODE_NONE
 = 0,

537 
	mSCST_DIF_MODE_TGT
 = 1,

540 
	mSCST_DIF_MODE_SCST
 = 2,

543 
	mSCST_DIF_MODE_DEV_CHECK
 = 4,

546 
	mSCST_DIF_MODE_DEV_STORE
 = 8,

548 
	#SCST_DIF_MODE_DEV
 (
SCST_DIF_MODE_DEV_CHECK
|
SCST_DIF_MODE_DEV_STORE
)

	)

550 
	#SCST_DIF_MODE_TGT_STR
 "tgt"

	)

551 
	#SCST_DIF_MODE_SCST_STR
 "sc¡"

	)

552 
	#SCST_DIF_MODE_DEV_CHECK_STR
 "dev_check"

	)

553 
	#SCST_DIF_MODE_DEV_STORE_STR
 "dev_¡Üe"

	)

560 
	esc¡_dif_aùiÚs
 {

561 
	mSCST_DIF_ACTION_NONE
 = 0,

563 
	#SCST_DIF_CHECKS_SHIFT
 0

	)

565 
	mSCST_DIF_CHECK_GUARD_TAG
 = 1,

566 
	mSCST_DIF_CHECK_APP_TAG
 = 2,

567 
	mSCST_DIF_CHECK_REF_TAG
 = 4,

568 
	#SCST_DIF_CHECKS_MASK
 (
SCST_DIF_CHECK_GUARD_TAG
|
SCST_DIF_CHECK_APP_TAG
| \

569 
SCST_DIF_CHECK_REF_TAG
)

	)

571 
	#SCST_DIF_ACTION_SHIFT
 4

	)

573 
	mSCST_DIF_ACTION_STRIP
 = (1 << 
SCST_DIF_ACTION_SHIFT
),

574 
	mSCST_DIF_ACTION_INSERT
 = (2 << 
SCST_DIF_ACTION_SHIFT
),

575 
	mSCST_DIF_ACTION_PASS_CHECK
 = (3 << 
SCST_DIF_ACTION_SHIFT
),

576 
	mSCST_DIF_ACTION_PASS
 = (4 << 
SCST_DIF_ACTION_SHIFT
),

578 
	#SCST_DIF_ACTION_MASK
 (
SCST_DIF_ACTION_STRIP
|
SCST_DIF_ACTION_INSERT
| \

579 
SCST_DIF_ACTION_PASS_CHECK
|
SCST_DIF_ACTION_PASS
)

	)

583 
	#SCST_DIF_TGT_ACTION_SHIFT
 0

	)

586 
	#SCST_DIF_SCST_ACTION_SHIFT
 (
SCST_DIF_TGT_ACTION_SHIFT
+4)

	)

589 
	#SCST_DIF_DEV_ACTION_SHIFT
 (
SCST_DIF_SCST_ACTION_SHIFT
+4)

	)

592 
šlše
 
sc¡_dif_aùiÚs
 
	$sc¡_g‘_dif_checks
(
sc¡_dif_aùiÚs
 
a
)

594  
a
 & 
SCST_DIF_CHECKS_MASK
;

595 
	}
}

598 
šlše
 
	$sc¡_£t_dif_checks
(
sc¡_dif_aùiÚs
 *
a
,

599 
sc¡_dif_aùiÚs
 
checks
)

601 
checks
 &ð~
SCST_DIF_CHECKS_MASK
;

602 *
a
 |ð
checks
 << 
SCST_DIF_CHECKS_SHIFT
;

604 
	}
}

607 
šlše
 
sc¡_dif_aùiÚs
 
	$sc¡_g‘_dif_aùiÚ
(
sc¡_dif_aùiÚs
 
a
)

609  
a
 & 
SCST_DIF_ACTION_MASK
;

610 
	}
}

613 
šlše
 
	$sc¡_£t_dif_aùiÚ
(
sc¡_dif_aùiÚs
 *
a
,

614 
sc¡_dif_aùiÚs
 
aùiÚ
)

616 
aùiÚ
 &ð~
SCST_DIF_ACTION_MASK
;

617 *
a
 |ð
aùiÚ
;

619 
	}
}

622 
šlše
 
sc¡_dif_aùiÚs
 
	$sc¡_g‘_tgt_dif_aùiÚs
(
sc¡_dif_aùiÚs
 
a
)

624 
	`BUILD_BUG_ON
(
SCST_DIF_CHECKS_SHIFT
 != 0);

625  ((
a
 >> 
SCST_DIF_TGT_ACTION_SHIFT
è& 
SCST_DIF_ACTION_MASK
) |

626 (
a
 & 
SCST_DIF_CHECKS_MASK
);

627 
	}
}

630 
šlše
 
	$sc¡_£t_tgt_dif_aùiÚ
(
sc¡_dif_aùiÚs
 *
a
,

631 
sc¡_dif_aùiÚs
 
tgt_a
)

633 
tgt_a
 &ð
SCST_DIF_ACTION_MASK
;

634 *
a
 |ð
tgt_a
 << 
SCST_DIF_TGT_ACTION_SHIFT
;

636 
	}
}

639 
šlše
 
sc¡_dif_aùiÚs
 
	$sc¡_g‘_sc¡_dif_aùiÚs
(
sc¡_dif_aùiÚs
 
a
)

641 
	`BUILD_BUG_ON
(
SCST_DIF_CHECKS_SHIFT
 != 0);

642  ((
a
 >> 
SCST_DIF_SCST_ACTION_SHIFT
è& 
SCST_DIF_ACTION_MASK
) |

643 (
a
 & 
SCST_DIF_CHECKS_MASK
);

644 
	}
}

647 
šlše
 
	$sc¡_£t_sc¡_dif_aùiÚ
(
sc¡_dif_aùiÚs
 *
a
,

648 
sc¡_dif_aùiÚs
 
sc¡_a
)

650 
sc¡_a
 &ð
SCST_DIF_ACTION_MASK
;

651 *
a
 |ð
sc¡_a
 << 
SCST_DIF_SCST_ACTION_SHIFT
;

653 
	}
}

656 
šlše
 
sc¡_dif_aùiÚs
 
	$sc¡_g‘_dev_dif_aùiÚs
(
sc¡_dif_aùiÚs
 
a
)

658 
	`BUILD_BUG_ON
(
SCST_DIF_CHECKS_SHIFT
 != 0);

659  ((
a
 >> 
SCST_DIF_DEV_ACTION_SHIFT
è& 
SCST_DIF_ACTION_MASK
) |

660 (
a
 & 
SCST_DIF_CHECKS_MASK
);

661 
	}
}

664 
šlše
 
	$sc¡_£t_dev_dif_aùiÚ
(
sc¡_dif_aùiÚs
 *
a
,

665 
sc¡_dif_aùiÚs
 
dev_a
)

667 
dev_a
 &ð
SCST_DIF_ACTION_MASK
;

668 *
a
 |ð
dev_a
 << 
SCST_DIF_DEV_ACTION_SHIFT
;

670 
	}
}

676 
	gsc¡_tgt
;

677 
	gsc¡_£ssiÚ
;

678 
	gsc¡_cmd
;

679 
	gsc¡_mgmt_cmd
;

680 
	gsc¡_deviû
;

681 
	gsc¡_tgt_dev
;

682 
	gsc¡_dev_ty³
;

683 
	gsc¡_acg
;

684 
	gsc¡_acg_dev
;

685 
	gsc¡_aú
;

686 
	gsc¡_«n
;

687 
	gsc¡_ext_cÝy_£g_desü
;

688 
	gsc¡_Ýcode_desütÜ
;

694 
	#NO_SUCH_LUN
 ((
ušt64_t
)-1)

	)

696 
dma_d©a_dœeùiÚ
 
	tsc¡_d©a_dœeùiÚ
;

705 
	ssc¡_tgt_‹m¶©e
 {

718 cÚ¡ *cÚ¡ 
	msuµÜ‹d_dif_block_sizes
;

723 
sc¡_lun_addr_m‘hod
 
	m´eã¼ed_addr_m‘hod
;

733 
	mmax_hw_³ndšg_time
;

739 
	msg_bËsize
;

744 
	munchecked_i§_dma
:1;

750 
	mu£_þu¡”šg
:1;

755 
	mno_þu¡”šg
:1;

761 
	mxm™_»¥Ú£_©omic
:1;

762 
	mrdy_to_xãr_©omic
:1;

764 #ifdeà
CONFIG_SCST_PROC


766 
	mno_´oc_’Œy
:1;

769 
	m’abËd_©Œ_nÙ_Ãeded
:1;

777 
	mçke_aÿ
:1;

783 
	mmuÉ™h»aded_š™_dÚe
:1;

792 
	mdif_suµÜ‹d
:1;

802 
	mhw_dif_ty³1_suµÜ‹d
:1;

812 
	mhw_dif_ty³2_suµÜ‹d
:1;

822 
	mhw_dif_ty³3_suµÜ‹d
:1;

832 
	mhw_dif__suµÜ‹d
:1;

841 
	mhw_dif_§me_sg_Ïyout_»quœed
:1;

861 (*
	mxm™_»¥Ú£
)(
sc¡_cmd
 *
	mcmd
);

885 (*
	mrdy_to_xãr
)(
sc¡_cmd
 *
	mcmd
);

895 (*
	mÚ_hw_³ndšg_cmd_timeout
)(
sc¡_cmd
 *
	mcmd
);

911 (*
	mÚ_ä“_cmd
)(
sc¡_cmd
 *
	mcmd
);

942 (*
	mtgt_®loc_d©a_buf
)(
sc¡_cmd
 *
	mcmd
);

969 (*
	m´•roûssšg_dÚe
)(
sc¡_cmd
 *
	mcmd
);

982 (*
	m´e_exec
)(
sc¡_cmd
 *
	mcmd
);

995 (*
	msk_mgmt_afãùed_cmds_dÚe
)(
sc¡_mgmt_cmd
 *
	mmgmt_cmd
);

1008 (*
	msk_mgmt_â_dÚe
)(
sc¡_mgmt_cmd
 *
	mmgmt_cmd
);

1027 (*
	mÚ_abÜt_cmd
)(
sc¡_cmd
 *
	mcmd
);

1038 (*
	md‘eù
)(
sc¡_tgt_‹m¶©e
 *
	mtgt_‹m¶©e
);

1048 (*
	m»Ëa£
)(
sc¡_tgt
 *
	mtgt
);

1067 (*
	m»pÜt_«n
)(
sc¡_«n
 *
	m«n
);

1069 #ifdeà
CONFIG_SCST_PROC


1077 (*
	m»ad_´oc
)(
£q_fže
 *
	m£q
, 
sc¡_tgt
 *
	mtgt
);

1078 (*
	mwr™e_´oc
)(*
	mbufãr
, **
	m¡¬t
, 
off_t
 
	moff£t
,

1079 
	mËngth
, *
	meof
, 
sc¡_tgt
 *
	mtgt
);

1096 (*
	mg‘_š™ŸtÜ_pÜt_Œª¥Üt_id
)(
sc¡_tgt
 *
	mtgt
,

1097 
sc¡_£ssiÚ
 *
	m£ss
, 
ušt8_t
 **
	mŒª¥Üt_id
);

1111 (*
	m’abË_rg‘
)(
sc¡_tgt
 *
	mtgt
, 
boÞ
 
	m’abË
);

1118 
boÞ
 (*
is_rg‘_’abËd
)(
sc¡_tgt
 *
	mtgt
);

1138 
ssize_t
 (*
add_rg‘
)(cÚ¡ *
	mrg‘_Çme
, *
	m·¿ms
);

1146 
ssize_t
 (*
d–_rg‘
)(cÚ¡ *
	mrg‘_Çme
);

1155 
ssize_t
 (*
mgmt_cmd
)(*
	mcmd
);

1168 (*
	mþo£_£ssiÚ
)(
sc¡_£ssiÚ
 *
	m£ss
);

1176 
ušt16_t
 (*
g‘_phys_Œª¥Üt_v”siÚ
)(
sc¡_tgt
 *
	mtgt
);

1184 
ušt16_t
 (*
g‘_scsi_Œª¥Üt_v”siÚ
)(
sc¡_tgt
 *
	mtgt
);

1190 cÚ¡ 
	mÇme
[
SCST_MAX_NAME
];

1198 
	mth»ads_num
;

1201 cÚ¡ 
	mdeçuÉ_Œaû_æags
;

1204 *
	mŒaû_æags
;

1207 
sc¡_Œaû_log
 *
	mŒaû_tbl
;

1210 cÚ¡ *
	mŒaû_tbl_h–p
;

1212 #iâdeà
CONFIG_SCST_PROC


1214 cÚ¡ 
©Œibu‹
 **
	mtg‰_©Œs
;

1217 cÚ¡ 
©Œibu‹
 **
	mtgt_©Œs
;

1220 cÚ¡ 
©Œibu‹
 **
	m£ss_©Œs
;

1224 cÚ¡ *
	mmgmt_cmd_h–p
;

1227 cÚ¡ *
	madd_rg‘_·¿m‘”s
;

1234 cÚ¡ *
	mtg‰_ÝtiÚ®_©Œibu‹s
;

1241 cÚ¡ *
	mtgt_ÝtiÚ®_©Œibu‹s
;

1246 
li¡_h—d
 
	mtgt_li¡
;

1249 
li¡_h—d
 
	msc¡_‹m¶©e_li¡_’Œy
;

1251 #ifdeà
CONFIG_SCST_PROC


1253 
´oc_dœ_’Œy
 *
	m´oc_tgt_roÙ
;

1256 
	m´oc_dev_num
;

1258 
kobjeù
 
	mtg‰_kobj
;

1261 
	mtg‰_aùive_sysfs_wÜks_couÁ
;

1264 
com¶‘iÚ
 *
	mtg‰_kobj_»Ëa£_cm¶
;

1278 (*
	mg‘_£rŸl
)(cÚ¡ 
sc¡_tgt_dev
 *
	mtgt_dev
, *
	mbuf
,

1279 
	msize
);

1286 
	esc¡_dev_ty³_th»ads_poÞ_ty³
 {

1288 
	mSCST_THREADS_POOL_PER_INITIATOR
 = 0,

1291 
	mSCST_THREADS_POOL_SHARED
,

1294 
	mSCST_THREADS_POOL_TYPE_INVALID
,

1304 
	ssc¡_dev_ty³
 {

1306 
	mty³
;

1312 
	m·r£_©omic
:1;

1313 
	mdev_®loc_d©a_buf_©omic
:1;

1314 
	mdev_dÚe_©omic
:1;

1316 #ifdeà
CONFIG_SCST_PROC


1318 
	mno_´oc
:1;

1325 
	mexec_sync
:1;

1332 
	m´_cmds_nÙifiÿtiÚs
:1;

1338 
	mauto_cm_assignm’t_possibË
:1;

1358 (*
	m·r£
)(
sc¡_cmd
 *
	mcmd
);

1378 (*
	mdev_®loc_d©a_buf
)(
sc¡_cmd
 *
	mcmd
);

1400 (*
	mexec
)(
sc¡_cmd
 *
	mcmd
);

1419 (*
	mdev_dÚe
)(
sc¡_cmd
 *
	mcmd
);

1428 (*
	mÚ_ä“_cmd
)(
sc¡_cmd
 *
	mcmd
);

1447 (*
	mext_cÝy_»m­
)(
sc¡_cmd
 *
	mcmd
,

1448 
sc¡_ext_cÝy_£g_desü
 *
	mdesü
);

1459 (*
	mÚ_®ua_¡©e_chªge_¡¬t
)(
sc¡_deviû
 *
	mdev
,

1460 
sc¡_tg_¡©e
 
	mÞd_¡©e
, sc¡_tg_¡©
	mÃw_¡©e
);

1471 (*
	mÚ_®ua_¡©e_chªge_fšish
)(
sc¡_deviû
 *
	mdev
,

1472 
sc¡_tg_¡©e
 
	mÞd_¡©e
, sc¡_tg_¡©
	mÃw_¡©e
);

1487 (*
	msk_mgmt_â_»ûived
)(
sc¡_mgmt_cmd
 *
	mmgmt_cmd
,

1488 
sc¡_tgt_dev
 *
	mtgt_dev
);

1505 (*
	msk_mgmt_â_dÚe
)(
sc¡_mgmt_cmd
 *
	mmgmt_cmd
,

1506 
sc¡_tgt_dev
 *
	mtgt_dev
);

1517 (*
	m»assign_»šed_¡©es
)(
sc¡_tgt_dev
 *
	mÃw_tgt_dev
,

1518 
sc¡_tgt_dev
 *
	mÞd_tgt_dev
);

1530 
boÞ
 (*
Ú_sg_bËsize_low
)(
sc¡_cmd
 *
	mcmd
);

1541 (*
	mg‘_suµÜ‹d_Ýcodes
)(
sc¡_cmd
 *
	mcmd
,

1542 cÚ¡ 
sc¡_Ýcode_desütÜ
 ***
	mout_suµ_Ýcodes
,

1543 *
	mout_suµ_Ýcodes_út
);

1551 (*
	mput_suµÜ‹d_Ýcodes
)(
sc¡_cmd
 *
	mcmd
,

1552 cÚ¡ 
sc¡_Ýcode_desütÜ
 **
	msuµ_Ýcodes
,

1553 
	msuµ_Ýcodes_út
);

1561 (*
	m©ch
)(
sc¡_deviû
 *
	mdev
);

1568 (*
	md‘ach
)(
sc¡_deviû
 *
	mdev
);

1576 (*
	m©ch_tgt
)(
sc¡_tgt_dev
 *
	mtgt_dev
);

1583 (*
	md‘ach_tgt
)(
sc¡_tgt_dev
 *
	mtgt_dev
);

1585 #ifdeà
CONFIG_SCST_PROC


1593 (*
	m»ad_´oc
)(
£q_fže
 *
	m£q
, 
sc¡_dev_ty³
 *
	mdev_ty³
);

1594 (*
	mwr™e_´oc
)(*
	mbufãr
, **
	m¡¬t
, 
off_t
 
	moff£t
,

1595 
	mËngth
, *
	meof
, 
sc¡_dev_ty³
 *
	mdev_ty³
);

1615 
ssize_t
 (*
add_deviû
)(cÚ¡ *
	mdeviû_Çme
, *
	m·¿ms
);

1623 
ssize_t
 (*
d–_deviû
)(cÚ¡ *
	mdeviû_Çme
);

1632 
ssize_t
 (*
mgmt_cmd
)(*
	mcmd
);

1640 
	mÇme
[
SCST_MAX_NAME
 + 10];

1647 
	mth»ads_num
;

1650 
sc¡_dev_ty³_th»ads_poÞ_ty³
 
	mth»ads_poÞ_ty³
;

1653 cÚ¡ 
	mdeçuÉ_Œaû_æags
;

1656 *
	mŒaû_æags
;

1659 
sc¡_Œaû_log
 *
	mŒaû_tbl
;

1661 #iâdeà
CONFIG_SCST_PROC


1663 cÚ¡ *
	mŒaû_tbl_h–p
;

1666 cÚ¡ *
	mmgmt_cmd_h–p
;

1669 cÚ¡ *
	madd_deviû_·¿m‘”s
;

1676 cÚ¡ *
	mdevt_ÝtiÚ®_©Œibu‹s
;

1683 cÚ¡ *
	mdev_ÝtiÚ®_©Œibu‹s
;

1686 cÚ¡ 
©Œibu‹
 **
	mdevt_©Œs
;

1689 cÚ¡ 
©Œibu‹
 **
	mdev_©Œs
;

1693 *
	mdevt_´iv
;

1696 
sc¡_dev_ty³
 *
	m·»Á
;

1698 
moduË
 *
	mmoduË
;

1703 
li¡_h—d
 
	mdev_ty³_li¡_’Œy
;

1705 #ifdeà
CONFIG_SCST_PROC


1707 
´oc_dœ_’Œy
 *
	m´oc_dev_ty³_roÙ
;

1709 
kobjeù
 
	mdevt_kobj
;

1712 
	mdevt_aùive_sysfs_wÜks_couÁ
;

1715 
com¶‘iÚ
 *
	mdevt_kobj_»Ëa£_com¶
;

1722 
	ssc¡_tgt
 {

1724 
li¡_h—d
 
	m£ss_li¡
;

1730 
li¡_h—d
 
	msysfs_£ss_li¡
;

1733 
li¡_h—d
 
	mtgt_li¡_’Œy
;

1735 
sc¡_tgt_‹m¶©e
 *
	mtg‰
;

1737 #iâdeà
CONFIG_SCST_PROC


1738 
sc¡_acg
 *
	mdeçuÉ_acg
;

1740 
li¡_h—d
 
	mtgt_acg_li¡
;

1748 
	mtgt_fÜw¬dšg
:1;

1751 
	mtgt_dif_suµÜ‹d
:1;

1752 
	mtgt_hw_dif_ty³1_suµÜ‹d
:1;

1753 
	mtgt_hw_dif_ty³2_suµÜ‹d
:1;

1754 
	mtgt_hw_dif_ty³3_suµÜ‹d
:1;

1755 
	mtgt_hw_dif__suµÜ‹d
:1;

1756 
	mtgt_hw_dif_§me_sg_Ïyout_»quœed
:1;

1762 
	msg_bËsize
;

1764 cÚ¡ *
	mtgt_suµÜ‹d_dif_block_sizes
;

1767 *
	mtgt_´iv
;

1775 
boÞ
 
	m»Œy_tim”_aùive
;

1776 
	m»Œy_cmds
;

1777 
tim”_li¡
 
	m»Œy_tim”
;

1778 
li¡_h—d
 
	m»Œy_cmd_li¡
;

1779 
¥šlock_t
 
	mtgt_lock
;

1782 
wa™_queue_h—d_t
 
	muÄeg_wa™Q
;

1784 #ifdeà
CONFIG_SCST_PROC


1786 
	m´oc_num
;

1790 *
	mtgt_Çme
;

1793 *
	mtgt_comm’t
;

1795 
ušt16_t
 
	m»l_tgt_id
;

1798 
©omic_t
 
	mtgt_dif_­p_çžed_tgt
, 
	mtgt_dif_»f_çžed_tgt
, 
	mtgt_dif_gu¬d_çžed_tgt
;

1799 
©omic_t
 
	mtgt_dif_­p_çžed_sc¡
, 
	mtgt_dif_»f_çžed_sc¡
, 
	mtgt_dif_gu¬d_çžed_sc¡
;

1800 
©omic_t
 
	mtgt_dif_­p_çžed_dev
, 
	mtgt_dif_»f_çžed_dev
, 
	mtgt_dif_gu¬d_çžed_dev
;

1802 #ifdeà
CONFIG_SCST_PROC


1804 *
	mdeçuÉ_group_Çme
;

1807 
com¶‘iÚ
 *
	mtgt_kobj_»Ëa£_cm¶
;

1809 
kobjeù
 
	mtgt_kobj
;

1810 
kobjeù
 *
	mtgt_£ss_kobj
;

1811 
kobjeù
 *
	mtgt_luns_kobj
;

1812 
kobjeù
 *
	mtgt_ši_g½_kobj
;

1816 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


1819 
šlše
 
	$__sc¡_time_³r_cmd
(
ušt64_t
 *
t
, ušt64_ˆ
n
)

1821 
shiá
;

1823 ià(!
n
)

1825 
shiá
 = 
	`max
(0, 
	`žog2
(
n
) - 32 + 1);

1826 *
t
 >>ð
shiá
;

1827 
n
 >>ð
shiá
;

1828 
	`WARN_ON
(
n
 !ð(
ušt32_t
)n);

1829 
	`do_div
(*
t
, (
ušt32_t
)
n
);

1830 
	}
}

1832 
	#sc¡_time_³r_cmd
(
t
, 
n
è
	`__sc¡_time_³r_cmd
(&Ñ), (n))

	)

1835 
	ssc¡_ext_Ï‹ncy_¡©
 {

1836 
ušt64_t
 
	msc¡_time_rd
, 
	mtgt_time_rd
, 
	mdev_time_rd
;

1837 
ušt64_t
 
	m´oûs£d_cmds_rd
;

1838 
ušt64_t
 
	mmš_sc¡_time_rd
, 
	mmš_tgt_time_rd
, 
	mmš_dev_time_rd
;

1839 
ušt64_t
 
	mmax_sc¡_time_rd
, 
	mmax_tgt_time_rd
, 
	mmax_dev_time_rd
;

1841 
ušt64_t
 
	msc¡_time_wr
, 
	mtgt_time_wr
, 
	mdev_time_wr
;

1842 
ušt64_t
 
	m´oûs£d_cmds_wr
;

1843 
ušt64_t
 
	mmš_sc¡_time_wr
, 
	mmš_tgt_time_wr
, 
	mmš_dev_time_wr
;

1844 
ušt64_t
 
	mmax_sc¡_time_wr
, 
	mmax_tgt_time_wr
, 
	mmax_dev_time_wr
;

1847 
	#SCST_IO_SIZE_THRESHOLD_SMALL
 (8*1024)

	)

1848 
	#SCST_IO_SIZE_THRESHOLD_MEDIUM
 (32*1024)

	)

1849 
	#SCST_IO_SIZE_THRESHOLD_LARGE
 (128*1024)

	)

1850 
	#SCST_IO_SIZE_THRESHOLD_VERY_LARGE
 (512*1024)

	)

1852 
	#SCST_LATENCY_STAT_INDEX_SMALL
 0

	)

1853 
	#SCST_LATENCY_STAT_INDEX_MEDIUM
 1

	)

1854 
	#SCST_LATENCY_STAT_INDEX_LARGE
 2

	)

1855 
	#SCST_LATENCY_STAT_INDEX_VERY_LARGE
 3

	)

1856 
	#SCST_LATENCY_STAT_INDEX_OTHER
 4

	)

1857 
	#SCST_LATENCY_STATS_NUM
 (
SCST_LATENCY_STAT_INDEX_OTHER
 + 1)

	)

1861 
	ssc¡_io_¡©_’Œy
 {

1862 
ušt64_t
 
	mcmd_couÁ
;

1863 
ušt64_t
 
	mio_by‹_couÁ
;

1864 
ušt64_t
 
	muÇligÃd_cmd_couÁ
;

1870 
	ssc¡_£ssiÚ
 {

1875 
	mš™_pha£
;

1877 
sc¡_tgt
 *
	mtgt
;

1880 *
	m£ss_tgt_´iv
;

1883 
	m£ss_aæags
;

1890 
	#SESS_TGT_DEV_LIST_HASH_SIZE
 (1 << 5)

	)

1891 
	#SESS_TGT_DEV_LIST_HASH_FN
(
v®
è((v®è& (
SESS_TGT_DEV_LIST_HASH_SIZE
 - 1))

	)

1892 
li¡_h—d
 
	m£ss_tgt_dev_li¡
[
SESS_TGT_DEV_LIST_HASH_SIZE
];

1901 
li¡_h—d
 
£ss_cmd_li¡
 
	m____ÿch–še_®igÃd_š_smp
;

1903 
¥šlock_t
 
	m£ss_li¡_lock
;

1905 
©omic_t
 
	m»fút
;

1911 
©omic_t
 
	m£ss_cmd_couÁ
;

1914 
sc¡_io_¡©_’Œy
 
	mio_¡©s
[
SCST_DATA_DIR_MAX
];

1917 
sc¡_acg
 *
	macg
;

1920 
ušt8_t
 *
	mŒª¥Üt_id
;

1923 
li¡_h—d
 
	macg_£ss_li¡_’Œy
;

1925 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 20))

1926 
d–ayed_wÜk
 
	mhw_³ndšg_wÜk
;

1928 
wÜk_¡ruù
 
	mhw_³ndšg_wÜk
;

1932 cÚ¡ *
	mš™ŸtÜ_Çme
;

1935 cÚ¡ *
	m£ss_Çme
;

1938 
li¡_h—d
 
	m£ss_li¡_’Œy
;

1941 
li¡_h—d
 
	msysfs_£ss_li¡_’Œy
;

1944 
li¡_h—d
 
	m£ss_š™_li¡_’Œy
;

1949 
li¡_h—d
 
	m£ss_shut_li¡_’Œy
;

1955 
li¡_h—d
 
	mš™_deã¼ed_cmd_li¡
;

1956 
li¡_h—d
 
	mš™_deã¼ed_mcmd_li¡
;

1963 
	mshut_pha£
;

1966 
com¶‘iÚ
 *
	mshutdown_com¶
;

1972 
li¡_h—d
 
	m£ss_cm_li¡_id_li¡
;

1974 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 20)

1975 
wÜk_¡ruù
 
	m£ss_cm_li¡_id_þ—nup_wÜk
;

1977 
d–ayed_wÜk
 
	m£ss_cm_li¡_id_þ—nup_wÜk
;

1981 
com¶‘iÚ
 *
	m£ss_kobj_»Ëa£_cm¶
;

1983 #iâdeà
CONFIG_SCST_PROC


1984 
	m£ss_kobj_»ady
:1;

1986 
kobjeù
 
	m£ss_kobj
;

1993 *
	m»g_£ss_d©a
;

1994 (*
	mš™_»suÉ_â
)(
sc¡_£ssiÚ
 *
	m£ss
, *
	md©a
,

1995 
	m»suÉ
);

1996 (*
	muÄeg_dÚe_â
)(
sc¡_£ssiÚ
 *
	m£ss
);

1998 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


1999 
¥šlock_t
 
	mÏt_lock
;

2000 
ušt64_t
 
	msc¡_time
, 
	mtgt_time
, 
	mdev_time
;

2001 
ušt64_t
 
	m´oûs£d_cmds
;

2002 
ušt64_t
 
	mmš_sc¡_time
, 
	mmš_tgt_time
, 
	mmš_dev_time
;

2003 
ušt64_t
 
	mmax_sc¡_time
, 
	mmax_tgt_time
, 
	mmax_dev_time
;

2004 
sc¡_ext_Ï‹ncy_¡©
 
	m£ss_Ï‹ncy_¡©
[
SCST_LATENCY_STATS_NUM
];

2011 
	ssc¡_´_abÜt_®l_³ndšg_mgmt_cmds_couÁ”
 {

2016 
©omic_t
 
	m´_abÜt_³ndšg_út
;

2019 (*
	m§ved_cmd_dÚe
)(
sc¡_cmd
 *
	mcmd
, 
	mÃxt_¡©e
,

2020 
sc¡_exec_cÚ‹xt
 
	m´ef_cÚ‹xt
);

2027 
©omic_t
 
	m´_abÜtšg_út
;

2028 
com¶‘iÚ
 
	m´_abÜtšg_cm¶
;

2034 
	ssc¡_cmd_th»ads
 {

2035 
¥šlock_t
 
	mcmd_li¡_lock
;

2036 
li¡_h—d
 
	maùive_cmd_li¡
;

2037 
wa™_queue_h—d_t
 
	mcmd_li¡_wa™Q
;

2039 
io_cÚ‹xt
 *
	mio_cÚ‹xt
;

2040 
	mio_cÚ‹xt_»fút
;

2042 
boÞ
 
	mio_cÚ‹xt_»ady
;

2043 
wa™_queue_h—d_t
 
	mioùx_wq
;

2046 
mu‹x
 
	mio_cÚ‹xt_mu‹x
;

2048 
¥šlock_t
 
	mthr_lock
;

2049 
	mÄ_th»ads
;

2050 
li¡_h—d
 
	mth»ads_li¡
;

2052 
li¡_h—d
 
	mli¡s_li¡_’Œy
;

2055 
sc¡_£t_thr_ýu_mask
(
sc¡_cmd_th»ads
 *
cmd_th»ads
,

2056 
ýumask_t
 *
ýu_mask
);

2058 
	gsc¡_´_dlm_d©a
;

2064 
	ssc¡_lksb
 {

2065 
dlm_lksb
 
	mlksb
;

2066 
com¶‘iÚ
 
	mcom¶
;

2067 
sc¡_´_dlm_d©a
 *
	m´_dlm
;

2073 
	ssc¡_Üd”_d©a
 {

2079 
li¡_h—d
 
	msk³d_¢_li¡
;

2080 
li¡_h—d
 
	mdeã¼ed_cmd_li¡
;

2082 
¥šlock_t
 
	m¢_lock
;

2084 
	mhq_cmd_couÁ
;

2087 
boÞ
 
	m´ev_cmd_Üd”ed
;

2089 
	mdef_cmd_couÁ
;

2090 
	mex³ùed_¢
;

2091 
	mcu¼_¢
;

2092 
	m³ndšg_sim¶e_šc_ex³ùed_¢
;

2094 
©omic_t
 *
	mcur_¢_¦Ù
;

2095 
©omic_t
 
	m¢_¦Ùs
[15];

2101 
¥šlock_t
 
	mš™_dÚe_lock
;

2104 
	ssc¡_Üig_sg_d©a
 {

2105 *
	mp_Üig_sg_út
;

2106 
	mÜig_sg_út
;

2107 
sÿ‰”li¡
 *
	mÜig_sg_’Œy
;

2108 
	mÜig_’Œy_offs
, 
	mÜig_’Œy_Ën
;

2114 
	ssc¡_cmd
 {

2116 
li¡_h—d
 
	mcmd_li¡_’Œy
;

2119 
sc¡_cmd_th»ads
 *
	mcmd_th»ads
;

2121 
©omic_t
 
	mcmd_»f
;

2123 
sc¡_£ssiÚ
 *
	m£ss
;

2125 
©omic_t
 *
	mýu_cmd_couÁ”
;

2128 
	m¡©e
;

2140 
	m£Á_fÜ_exec
:1;

2143 
	m¢_£t
:1;

2146 
	mšc_ex³ùed_¢_Ú_dÚe
:1;

2149 
	mcom¶‘ed
:1;

2152 
	mua_ignÜe
:1;

2155 
	m©omic
:1;

2158 
	mdoubË_ua_possibË
:1;

2161 
	mdeã¼ed_dif_»ad_check
:1;

2164 
	mis_£nd_¡©us
:1;

2167 
	m»Œy
:1;

2170 
	mš‹º®
:1;

2173 
	mš‹º®_check_loÿl_ev’ts
:1;

2176 
	mby·ss_blockšg
:1;

2179 
	munblock_dev
:1;

2182 
	mdec_Ú_dev_Ãeded
:1;

2185 
	mÚ_dev_exec_li¡
:1;

2188 
	mscsi_©omic™y_checked
:1;

2191 
	mcmd_hw_³ndšg
:1;

2194 
	mcmd_Çÿ
:1;

2201 
	mtgt_Ãed_®loc_d©a_buf
:1;

2207 
	mtgt_i_d©a_buf_®loûd
:1;

2210 
	mdh_d©a_buf_®loûd
:1;

2216 
	mdif_sg_nÜm®ized
:1;

2219 
	mex³ùed_v®ues_£t
:1;

2222 
	msg_buff_modif›d
:1;

2225 
	mdif_sg_buff_modif›d
:1;

2231 
	msg_buff_vm®loÿ‹d
:1;

2237 
	m´•roûssšg_Úly
:1;

2240 
	mhq_cmd_šûd
:1;

2246 
	m£t_¢_Ú_»¡¬t_cmd
:1;

2249 
	mno_sgv
:1;

2256 
	mmay_Ãed_dma_sync
:1;

2259 
	mout_of_¢
:1;

2262 
	mtgt_¢_£t
:1;

2265 
	m»sid_possibË
:1;

2268 
	mtgt_dif_d©a_ex³ùed
:1;

2271 
	mdÚe
:1;

2277 
	mfšished
:1;

2280 
	m´e_®loûd
:1;

2283 
	m®»ady_Œªs™iÚšg
:1;

2286 
	mwr™e_nÙ_»ûived_£t
:1;

2289 
	mcmd_lšked
:1;

2292 
	mcmd_Ú_glob®_¡pg_li¡
:1;

2295 
	mcmd_glob®_¡pg_blocked
:1;

2300 
	mcmd_æags
;

2309 
gå_t
 
	mcmd_gå_mask
;

2312 
	md–iv”y_¡©us
;

2314 
sc¡_tgt_‹m¶©e
 *
	mtg‰
;

2315 
sc¡_tgt
 *
	mtgt
;

2316 
sc¡_deviû
 *
	mdev
;

2317 
sc¡_dev_ty³
 *
	mdevt
;

2320 
sc¡_tgt_dev
 *
	mtgt_dev
;

2322 
sc¡_Üd”_d©a
 *
	mcur_Üd”_d©a
;

2324 
ušt64_t
 
	mlun
;

2326 
	m¡¬t_time
;

2329 
li¡_h—d
 
	mdeã¼ed_cmd_li¡_’Œy
;

2332 
	m¢
;

2335 
©omic_t
 *
	m¢_¦Ù
;

2338 
li¡_h—d
 
	m£ss_cmd_li¡_’Œy
;

2344 
ušt64_t
 
	mg
;

2346 
ušt32_t
 
	mtgt_¢
;

2348 
ušt8_t
 *
	mcdb
;

2349 
	mcdb_Ën
;

2350 
ušt8_t
 
	mcdb_buf
[
SCST_MAX_CDB_SIZE
];

2353 
li¡_h—d
 
	mdev_exec_cmd_li¡_’Œy
;

2359 
sc¡_cmd
 **
	mscsi_©omic_blocked_cmds
;

2361 
ušt8_t
 
	mlba_off
;

2362 
ušt8_t
 
	mlba_Ën
;

2363 
ušt8_t
 
	mËn_off
;

2364 
ušt8_t
 
	mËn_Ën
;

2365 
ušt32_t
 
	mÝ_æags
;

2366 cÚ¡ *
	mÝ_Çme
;

2368 
sc¡_cmd_queue_ty³
 
	mqueue_ty³
;

2370 
	mtimeout
;

2371 
	m»Œ›s
;

2377 
sc¡_d©a_dœeùiÚ
 
	md©a_dœeùiÚ
;

2380 
sc¡_d©a_dœeùiÚ
 
	mex³ùed_d©a_dœeùiÚ
;

2381 
	mex³ùed_Œªsãr_Ën_fuÎ
;

2382 
	mex³ùed_out_Œªsãr_Ën
;

2384 
št64_t
 
	mlba
;

2391 
št64_t
 
	md©a_Ën
;

2394 (*
	msc¡_cmd_dÚe
)(
sc¡_cmd
 *
	mcmd
, 
	mÃxt_¡©e
,

2395 
sc¡_exec_cÚ‹xt
 
	m´ef_cÚ‹xt
);

2397 
sgv_poÞ_obj
 *
	msgv
;

2398 
	mbufæ’
;

2399 
	msg_út
;

2400 
sÿ‰”li¡
 *
	msg
;

2402 
sgv_poÞ_obj
 *
	mdif_sgv
;

2403 
sÿ‰”li¡
 *
	mdif_sg
;

2404 
	mdif_sg_út
;

2410 
	m»¥_d©a_Ën
;

2416 
	madju¡ed_»¥_d©a_Ën
;

2423 
	mwr™e_Ën
;

2429 
sÿ‰”li¡
 **
	mwr™e_sg
;

2430 *
	mwr™e_sg_út
;

2433 
sÿ‰”li¡
 *
	mg‘_sg_buf_cur_sg_’Œy
;

2434 
	mg‘_sg_buf_’Œy_num
;

2437 
	mout_bufæ’
;

2438 
sgv_poÞ_obj
 *
	mout_sgv
;

2439 
sÿ‰”li¡
 *
	mout_sg
;

2440 
	mout_sg_út
;

2452 
sÿ‰”li¡
 *
	mtgt_i_sg
;

2453 
	mtgt_i_sg_út
;

2454 
	mtgt_i_dif_sg_út
;

2455 
sÿ‰”li¡
 *
	mtgt_i_dif_sg
;

2460 
sÿ‰”li¡
 *
	mtgt_out_sg
;

2461 
	mtgt_out_sg_út
;

2468 
ušt8_t
 
	m¡©us
;

2469 
ušt8_t
 
	mmsg_¡©us
;

2470 
ušt8_t
 
	mho¡_¡©us
;

2471 
ušt8_t
 
	mdriv”_¡©us
;

2474 
sc¡_dif_aùiÚs
 
	mcmd_dif_aùiÚs
;

2475 #ifdeà
CONFIG_SCST_DIF_INJECT_CORRUPTED_TAGS


2476 
ušt32_t
 
	mcmd_cÜru±_dif_g
;

2479 
ušt8_t
 *
	m£n£
;

2480 
	m£n£_v®id_Ën
;

2481 
	m£n£_buæ’
;

2484 
	mhw_³ndšg_¡¬t
;

2487 *
	mtgt_i_´iv
;

2490 *
	mdh_´iv
;

2496 
	mscsi_©omic_block”s
;

2502 
	mscsi_©omic_blocked_cmds_couÁ
;

2505 
li¡_h—d
 
	mblocked_cmd_li¡_’Œy
;

2508 
	mdbl_ua_Üig_»¥_d©a_Ën
, 
	mdbl_ua_Üig_d©a_dœeùiÚ
;

2514 
li¡_h—d
 
	mmgmt_cmd_li¡
;

2517 
sc¡_Üig_sg_d©a
 
	mÜig_sg
, 
	mÜig_dif_sg
;

2522 
sc¡_´_abÜt_®l_³ndšg_mgmt_cmds_couÁ”
 *
	m´_abÜt_couÁ”
;

2530 *
	mcmd_d©a_desütÜs
;

2531 
	mcmd_d©a_desütÜs_út
;

2536 
li¡_h—d
 
	mglob®_¡pg_li¡_’Œy
;

2540 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

2541 
	mnÙ_·r£d_Ý_Çme
[8];

2544 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


2545 
ušt64_t
 
	m¡¬t
, 
	mcu¼_¡¬t
, 
	m·r£_time
, 
	m®loc_buf_time
;

2546 
ušt64_t
 
	m»¡¬t_wa™šg_time
, 
	mrdy_to_xãr_time
;

2547 
ušt64_t
 
	m´e_exec_time
, 
	mexec_time
, 
	mdev_dÚe_time
;

2548 
ušt64_t
 
	mxm™_time
;

2549 
boÞ
 
	mexec_time_couÁšg
;

2552 #ifdeà
CONFIG_SCST_DEBUG_TM


2554 
	mtm_dbg_d–ayed
:1;

2557 
	mtm_dbg_immut
:1;

2564 
	ssc¡_rx_mgmt_·¿ms
 {

2565 
	mâ
;

2566 
ušt64_t
 
	mg
;

2567 cÚ¡ 
ušt8_t
 *
	mlun
;

2568 
	mlun_Ën
;

2569 
ušt32_t
 
	mcmd_¢
;

2570 
	m©omic
;

2571 *
	mtgt_´iv
;

2572 
	mg_£t
;

2573 
	mlun_£t
;

2574 
	mcmd_¢_£t
;

2580 
	ssc¡_mgmt_cmd_¡ub
 {

2581 
sc¡_mgmt_cmd
 *
	mmcmd
;

2584 
li¡_h—d
 
	mcmd_mgmt_cmd_li¡_’Œy
;

2587 
	mdÚe_couÁed
:1;

2590 
	mfšish_couÁed
:1;

2596 
	ssc¡_mgmt_cmd
 {

2598 
li¡_h—d
 
	mmgmt_cmd_li¡_’Œy
;

2600 
sc¡_£ssiÚ
 *
	m£ss
;

2602 
©omic_t
 *
	mýu_cmd_couÁ”
;

2605 
	m¡©e
;

2607 
	mâ
;

2610 
	mÃeds_unblockšg
:1;

2611 
	mlun_£t
:1;

2612 
	mcmd_¢_£t
:1;

2613 
	msc¡_g‘_ÿÎed
:1;

2615 
	msk_mgmt_â_»ûived_ÿÎed
:1;

2616 
	mmcmd_drÝ³d
:1;

2622 
	mcmd_fšish_wa™_couÁ
;

2628 
	mcmd_dÚe_wa™_couÁ
;

2631 
	mcom¶‘ed_cmd_couÁ
;

2633 
ušt64_t
 
	mlun
;

2635 
ušt64_t
 
	mg
;

2637 
ušt32_t
 
	mcmd_¢
;

2640 
sc¡_cmd
 *
	mcmd_to_abÜt
;

2643 
sc¡_tgt_dev
 *
	mmcmd_tgt_dev
;

2646 
	m¡©us
;

2650 *
	mtgt_´iv
;

2651 
sc¡_cmd
 *
	mÜigš_´_cmd
;

2658 
	ssc¡_dev_»gi¡¿Á
 {

2659 
ušt8_t
 *
	mŒª¥Üt_id
;

2660 
ušt16_t
 
	m»l_tgt_id
;

2661 
__be64
 
	mkey
;

2664 
sc¡_tgt_dev
 *
	mtgt_dev
;

2667 
li¡_h—d
 
	mdev_»gi¡¿Ás_li¡_’Œy
;

2670 
li¡_h—d
 
	maux_li¡_’Œy
;

2671 
__be64
 
	mrÞlback_key
;

2674 
	mdlm_idx
;

2675 
sc¡_lksb
 
	mlksb
;

2676 
	mlvb
[
PR_DLM_LVB_LEN
];

2698 
	ssc¡_þ_Ýs
 {

2699 (*
	m´_š™
)(
sc¡_deviû
 *
	mdev
, cÚ¡ *
	mþ_dev_id
);

2700 (*
	m´_þ—nup
)(
sc¡_deviû
 *
	mdev
);

2701 
boÞ
 (*
´_is_£t
)(
sc¡_deviû
 *
	mdev
);

2702 (*
	m´_š™_»g
)(
sc¡_deviû
 *
	mdev
,

2703 
sc¡_dev_»gi¡¿Á
 *
	m»g
);

2704 (*
	m´_rm_»g
)(
sc¡_deviû
 *
	mdev
,

2705 
sc¡_dev_»gi¡¿Á
 *
	m»g
);

2706 (*
	m´_wr™e_lock
)(
sc¡_deviû
 *
	mdev
,

2707 
sc¡_lksb
 *
	m´_lksb
);

2708 (*
	m´_wr™e_uÆock
)(
sc¡_deviû
 *
	mdev
,

2709 
sc¡_lksb
 *
	m´_lksb
);

2711 
boÞ
 (*
»£rved
)(
sc¡_deviû
 *
	mdev
);

2712 (*
	m»s_lock
)(
sc¡_deviû
 *
	mdev
, 
sc¡_lksb
 *
	m´_lksb
);

2713 (*
	m»s_uÆock
)(
sc¡_deviû
 *
	mdev
, 
sc¡_lksb
 *
	m´_lksb
);

2714 
boÞ
 (*
is_rsv_hÞd”
)(
sc¡_deviû
 *
	mdev
,

2715 
sc¡_£ssiÚ
 *
	m£ss
);

2716 
boÞ
 (*
is_nÙ_rsv_hÞd”
)(
sc¡_deviû
 *
	mdev
,

2717 
sc¡_£ssiÚ
 *
	m£ss
);

2718 (*
	m»£rve
)(
sc¡_deviû
 *
	mdev
, 
sc¡_£ssiÚ
 *
	m£ss
);

2724 (*
	text_block”_dÚe_â_t
è(
	tsc¡_deviû
 *
	tdev
,

2725 
	tušt8_t
 *
	td©a
, 
	tËn
);

2727 
	ssc¡_ext_block”
 {

2728 
li¡_h—d
 
ext_block”s_li¡_’Œy
;

2730 
ext_block”_dÚe_â_t
 
ext_block”_dÚe_â
;

2731 
ext_block”_d©a_Ën
;

2732 
ušt8_t
 
ext_block”_d©a
[];

2738 
	ssc¡_deviû
 {

2739 
ty³
;

2747 
dev_doubË_ua_possibË
:1;

2750 
dev_rd_Úly
:1;

2753 
¡riùly_£rŸlized_cmd_wa™šg
:1;

2761 
dev_uÄegi¡”šg
:1;

2767 
ext_blockšg_³ndšg
:1;

2770 
ext_unblock_scheduËd
:1;

2773 
¡pg_ext_blocked
:1;

2776 
dev_dif__nÙ_suµÜ‹d
:1;

2788 
queue_®g
:4 
	`__®igÃd
(());

2789 
t¡
:3;

2790 
q”r
:2;

2791 
tmf_Úly
:1;

2792 
s
:1;

2793 
swp
:1;

2794 
d_£n£
:1;

2795 
dpicz
:1;

2796 
©o
:1;

2807 
queue_®g_§ved
:4;

2808 
queue_®g_deçuÉ
:4;

2810 
tmf_Úly_§ved
:1;

2811 
tmf_Úly_deçuÉ
:1;

2813 
q”r_§ved
:2;

2814 
q”r_deçuÉ
:2;

2816 
s_§ved
:1;

2817 
s_deçuÉ
:1;

2819 
swp_§ved
:1;

2820 
swp_deçuÉ
:1;

2822 
d_£n£_§ved
:1;

2823 
d_£n£_deçuÉ
:1;

2825 
dpicz_§ved
:1;

2826 
dpicz_deçuÉ
:1;

2833 
has_own_Üd”_mgmt
:1;

2842 
dif_­p_chk
;

2849 
dif_»f_chk
;

2857 
block_size
;

2858 
block_shiá
;

2860 
sc¡_dev_ty³
 *
hªdËr
;

2863 *
dh_´iv
;

2866 
scsi_deviû
 *
scsi_dev
;

2869 
¥šlock_t
 
dev_lock
 
____ÿch–še_®igÃd_š_smp
;

2871 #ifdeà
CONFIG_SCST_PER_DEVICE_CMD_COUNT_LIMIT


2873 
©omic_t
 
dev_cmd_couÁ
;

2880 
block_couÁ
;

2886 
Ú_dev_cmd_couÁ
;

2891 
dev_scsi_©omic_cmd_aùive
;

2897 
li¡_h—d
 
dev_exec_cmd_li¡
;

2900 
sc¡_mem_lim
 
dev_mem_lim
;

2903 
sc¡_cmd_th»ads
 
dev_cmd_th»ads
;

2909 
sc¡_dif_mode
 
dev_dif_mode
;

2910 
dev_dif_ty³
;

2919 (*
dev_dif_â
)(
sc¡_cmd
 *
cmd
);

2921 
__be16
 
dev_dif_¡©ic_­p_g
;

2926 
__be32
 
dev_dif_¡©ic_­p_»f_g
;

2929 
sc¡_dif_aùiÚs
 
dev_dif_rd_aùiÚs
;

2930 
sc¡_dif_aùiÚs
 
dev_dif_wr_aùiÚs
;

2931 
sc¡_dif_aùiÚs
 
dev_dif_rd_´Ù0_aùiÚs
;

2932 
sc¡_dif_aùiÚs
 
dev_dif_wr_´Ù0_aùiÚs
;

2933 
sc¡_dif_aùiÚs
 
dev_dif_vr_aùiÚs
;

2936 
sc¡_£ssiÚ
 *
»£rved_by
;

2939 cÚ¡ 
sc¡_þ_Ýs
 *
þ_Ýs
;

2953 
´_is_£t
:1 
	`__®igÃd
(());

2956 
´_­l
:1;

2959 
´_fže_Çme_is_£t
:1;

2965 
þu¡”_mode
:1;

2968 
ušt8_t
 
´_ty³
;

2971 
ušt8_t
 
´_scÝe
;

2974 
sc¡_´_dlm_d©a
 *
´_dlm
;

2977 
mu‹x
 
dev_´_mu‹x
;

2980 
ušt32_t
 
´_g’”©iÚ
;

2983 
sc¡_dev_»gi¡¿Á
 *
´_hÞd”
;

2986 
li¡_h—d
 
dev_»gi¡¿Ás_li¡
;

2995 
nÙ_´_suµÜtšg_tgt_devs_num
;

2997 
sc¡_Üd”_d©a
 
dev_Üd”_d©a
;

3003 *
´_fže_Çme
;

3004 *
´_fže_Çme1
;

3009 
li¡_h—d
 
blocked_cmd_li¡
;

3012 
ext_blocks_út
;

3015 
li¡_h—d
 
ext_block”s_li¡
;

3018 
wÜk_¡ruù
 
ext_block”s_wÜk
;

3021 
ušt64_t
 
max_wr™e_§me_Ën
;

3024 
li¡_h—d
 
tm_dev_li¡_’Œy
;

3026 
vœt_id
;

3029 *
vœt_Çme
;

3031 
li¡_h—d
 
dev_li¡_’Œy
;

3037 
li¡_h—d
 
dev_tgt_dev_li¡
;

3040 
li¡_h—d
 
dev_acg_dev_li¡
;

3043 
th»ads_num
;

3046 
sc¡_dev_ty³_th»ads_poÞ_ty³
 
th»ads_poÞ_ty³
;

3048 #iâdeà
CONFIG_SCST_PROC


3050 
com¶‘iÚ
 *
dev_kobj_»Ëa£_cm¶
;

3052 
kobjeù
 
dev_kobj
;

3053 
kobjeù
 *
dev_exp_kobj
;

3056 
dev_expÜ‹d_lun_num
;

3063 
	ssc¡_async_io_cÚ‹xt_k“³r
 {

3064 
k»f
 
aic_k“³r_k»f
;

3065 
boÞ
 
aic_»ady
;

3066 
io_cÚ‹xt
 *
aic
;

3067 
sk_¡ruù
 *
aic_k“³r_thr
;

3068 
wa™_queue_h—d_t
 
aic_k“³r_wa™Q
;

3075 
	ssc¡_tgt_dev
 {

3077 
li¡_h—d
 
£ss_tgt_dev_li¡_’Œy
;

3079 
sc¡_deviû
 *
dev
;

3080 
ušt64_t
 
lun
;

3086 
gå_t
 
tgt_dev_gå_mask
;

3089 
sgv_poÞ
 *
poÞ
;

3092 
max_sg_út
;

3099 
tgt_dev_rd_Úly
:1;

3102 
tgt_dev_aá”_š™_wr_©omic
:1;

3103 
tgt_dev_aá”_exec_©omic
:1;

3106 
tgt_dev_þu¡_poÞ
:1;

3109 
hw_dif_§me_sg_Ïyout_»quœed
:1;

3117 
tgt_dev_æags
;

3120 *
dh_´iv
;

3123 
	`__be16
 (*
tgt_dev_dif_üc_â
)(cÚ¡ *
bufãr
, 
Ën
);

3129 
tgt_dev_dif_gu¬d_fÜm©
;

3132 
©omic_t
 
tgt_dev_cmd_couÁ
 
____ÿch–še_®igÃd_š_smp
;

3135 
	#SCST_ALUA_CHECK_OK
 0

	)

3136 
	#SCST_ALUA_CHECK_DELAYED
 1

	)

3137 
	#SCST_ALUA_CHECK_ERROR
 -1

	)

3138 (*
®ua_fž‹r
)(
sc¡_cmd
 *
cmd
);

3140 
sc¡_Üd”_d©a
 *
cu¼_Üd”_d©a
;

3141 
sc¡_Üd”_d©a
 
tgt_dev_Üd”_d©a
;

3144 
sc¡_cmd_th»ads
 *
aùive_cmd_th»ads
;

3150 
io_cÚ‹xt
 *
async_io_cÚ‹xt
;

3152 
sc¡_async_io_cÚ‹xt_k“³r
 *
aic_k“³r
;

3156 
sc¡_cmd_th»ads
 
tgt_dev_cmd_th»ads
;

3159 
¥šlock_t
 
tgt_dev_lock
;

3162 
li¡_h—d
 
UA_li¡
;

3164 
sc¡_£ssiÚ
 *
£ss
;

3165 
sc¡_acg_dev
 *
acg_dev
;

3168 
sc¡_dev_»gi¡¿Á
 *
»gi¡¿Á
;

3171 
li¡_h—d
 
dev_tgt_dev_li¡_’Œy
;

3174 
li¡_h—d
 
exŒa_tgt_dev_li¡_’Œy
;

3177 
šq_chªged_ua_Ãeded
:1;

3180 
©omic_t
 
tgt_dev_dif_­p_çžed_tgt
, 
tgt_dev_dif_»f_çžed_tgt
, 
tgt_dev_dif_gu¬d_çžed_tgt
;

3181 
©omic_t
 
tgt_dev_dif_­p_çžed_sc¡
, 
tgt_dev_dif_»f_çžed_sc¡
, 
tgt_dev_dif_gu¬d_çžed_sc¡
;

3182 
©omic_t
 
tgt_dev_dif_­p_çžed_dev
, 
tgt_dev_dif_»f_çžed_dev
, 
tgt_dev_dif_gu¬d_çžed_dev
;

3188 
tgt_dev_v®id_£n£_Ën
;

3189 
ušt8_t
 
tgt_dev_£n£
[
SCST_SENSE_BUFFERSIZE
];

3191 #iâdeà
CONFIG_SCST_PROC


3193 
com¶‘iÚ
 *
tgt_dev_kobj_»Ëa£_cm¶
;

3195 
kobjeù
 
tgt_dev_kobj
;

3198 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


3202 
ušt64_t
 
sc¡_time
, 
tgt_time
, 
dev_time
;

3203 
ušt64_t
 
´oûs£d_cmds
;

3204 
sc¡_ext_Ï‹ncy_¡©
 
dev_Ï‹ncy_¡©
[
SCST_LATENCY_STATS_NUM
];

3211 
	ssc¡_acg_dev
 {

3212 
sc¡_deviû
 *
dev
;

3214 
ušt64_t
 
lun
;

3217 
acg_dev_rd_Úly
:1;

3220 
acg_dev_dif_gu¬d_fÜm©
;

3222 
sc¡_acg
 *
acg
;

3225 
li¡_h—d
 
dev_acg_dev_li¡_’Œy
;

3228 
li¡_h—d
 
acg_dev_li¡_’Œy
;

3230 #iâdeà
CONFIG_SCST_PROC


3231 
kobjeù
 
acg_dev_kobj
;

3234 
com¶‘iÚ
 *
acg_dev_kobj_»Ëa£_cm¶
;

3237 
acg_dev_lšk_Çme
[20];

3245 
	ssc¡_acg
 {

3247 
k»f
 
acg_k»f
;

3250 
sc¡_tgt
 *
tgt
;

3253 
li¡_h—d
 
acg_dev_li¡
;

3256 
li¡_h—d
 
acg_£ss_li¡
;

3259 
li¡_h—d
 
aú_li¡
;

3262 
li¡_h—d
 
acg_li¡_’Œy
;

3265 cÚ¡ *
acg_Çme
;

3267 #ifdeà
CONFIG_SCST_PROC


3269 
´oc_dœ_’Œy
 *
acg_´oc_roÙ
;

3273 
acg_io_groupšg_ty³
;

3276 
ýumask_t
 
acg_ýu_mask
;

3278 
tgt_acg
:1;

3281 
	#SCST_ACG_BLACK_HOLE_NONE
 0

	)

3284 
	#SCST_ACG_BLACK_HOLE_CMD
 1

	)

3292 
	#SCST_ACG_BLACK_HOLE_ALL
 2

	)

3295 
	#SCST_ACG_BLACK_HOLE_DATA_CMD
 3

	)

3304 
	#SCST_ACG_BLACK_HOLE_DATA_MCMD
 4

	)

3305 vÞ©ž
acg_bÏck_hÞe_ty³
;

3308 
com¶‘iÚ
 *
acg_kobj_»Ëa£_cm¶
;

3310 #iâdeà
CONFIG_SCST_PROC


3311 
kobjeù
 
acg_kobj
;

3313 
kobjeù
 *
luns_kobj
;

3314 
kobjeù
 *
š™ŸtÜs_kobj
;

3317 
sc¡_lun_addr_m‘hod
 
addr_m‘hod
;

3324 
	ssc¡_aú
 {

3325 
sc¡_acg
 *
acg
;

3327 cÚ¡ *
Çme
;

3330 
li¡_h—d
 
aú_li¡_’Œy
;

3333 
kobj_©Œibu‹
 *
aú_©Œ
;

3351 
	ssc¡_dev_group
 {

3352 *
Çme
;

3353 
li¡_h—d
 
’Œy
;

3354 
li¡_h—d
 
dev_li¡
;

3355 
li¡_h—d
 
tg_li¡
;

3356 
kobjeù
 
kobj
;

3357 
kobjeù
 *
dev_kobj
;

3358 
kobjeù
 *
tg_kobj
;

3359 
ušt8_t
 *
¡pg_Œª¥Üt_id
;

3360 
ušt16_t
 
¡pg_»l_tgt_id
;

3366 
	ssc¡_dg_dev
 {

3367 
li¡_h—d
 
’Œy
;

3368 
sc¡_deviû
 *
dev
;

3385 
	ssc¡_rg‘_group
 {

3386 
sc¡_dev_group
 *
dg
;

3387 *
Çme
;

3388 
ušt16_t
 
group_id
;

3389 
sc¡_tg_¡©e
 
¡©e
;

3390 
boÞ
 
´eã¼ed
;

3391 
li¡_h—d
 
’Œy
;

3392 
li¡_h—d
 
tgt_li¡
;

3393 
kobjeù
 
kobj
;

3404 
	ssc¡_tg_tgt
 {

3405 
li¡_h—d
 
’Œy
;

3406 
sc¡_rg‘_group
 *
tg
;

3407 
kobjeù
 
kobj
;

3408 
sc¡_tgt
 *
tgt
;

3409 *
Çme
;

3410 
ušt16_t
 
»l_tgt_id
;

3416 
	ssc¡_tgt_dev_UA
 {

3418 
li¡_h—d
 
UA_li¡_’Œy
;

3421 
glob®_UA
:1;

3424 
UA_v®id_£n£_Ën
;

3426 
ušt8_t
 
UA_£n£_bufãr
[
SCST_SENSE_BUFFERSIZE
];

3430 
	ssc¡_«n
 {

3431 
ev’t_â
;

3433 
sc¡_£ssiÚ
 *
£ss
;

3434 
__be64
 
lun
;

3439 
«n_£n£_Ën
;

3440 
ušt8_t
 
«n_£n£
[
SCST_STANDARD_SENSE_LEN
];

3445 
d–iv”y_¡©us
;

3448 
	#SCST_OD_DEFAULT_CONTROL_BYTE
 0

	)

3450 
	ssc¡_Ýcode_desütÜ
 {

3451 
ušt16_t
 
od_£rv_aùiÚ
;

3452 
ušt8_t
 
od_Ýcode
;

3453 
ušt8_t
 
od_£rv_aùiÚ_v®id
:1;

3454 
ušt8_t
 
od_suµÜt
:3;

3455 
ušt16_t
 
od_cdb_size
;

3456 
ušt8_t
 
od_comm_¥ecific_timeout
;

3457 
ušt32_t
 
od_nomš®_timeout
;

3458 
ušt32_t
 
od_»comm’ded_timeout
;

3459 
ušt8_t
 
od_cdb_u§ge_b™s
[];

3460 } 
__·cked
;

3462 cÚ¡ 
sc¡_Ýcode_desütÜ
 
sc¡_Ý_desü_log_£Ëù
;

3463 cÚ¡ 
sc¡_Ýcode_desütÜ
 
sc¡_Ý_desü_log_£n£
;

3464 cÚ¡ 
sc¡_Ýcode_desütÜ
 
sc¡_Ý_desü_mode_£Ëù6
;

3465 cÚ¡ 
sc¡_Ýcode_desütÜ
 
sc¡_Ý_desü_mode_£n£6
;

3466 cÚ¡ 
sc¡_Ýcode_desütÜ
 
sc¡_Ý_desü_mode_£Ëù10
;

3467 cÚ¡ 
sc¡_Ýcode_desütÜ
 
sc¡_Ý_desü_mode_£n£10
;

3468 cÚ¡ 
sc¡_Ýcode_desütÜ
 
sc¡_Ý_desü_¹pg
;

3469 cÚ¡ 
sc¡_Ýcode_desütÜ
 
sc¡_Ý_desü_¡pg
;

3470 cÚ¡ 
sc¡_Ýcode_desütÜ
 
sc¡_Ý_desü_£nd_dŸgno¡ic
;

3472 cÚ¡ 
sc¡_Ýcode_desütÜ
 
sc¡_Ý_desü_šquœy
;

3473 cÚ¡ 
sc¡_Ýcode_desütÜ
 
sc¡_Ý_desü_ex‹nded_cÝy
;

3474 cÚ¡ 
sc¡_Ýcode_desütÜ
 
sc¡_Ý_desü_tur
;

3475 cÚ¡ 
sc¡_Ýcode_desütÜ
 
sc¡_Ý_desü_»£rve6
;

3476 cÚ¡ 
sc¡_Ýcode_desütÜ
 
sc¡_Ý_desü_»Ëa£6
;

3477 cÚ¡ 
sc¡_Ýcode_desütÜ
 
sc¡_Ý_desü_»£rve10
;

3478 cÚ¡ 
sc¡_Ýcode_desütÜ
 
sc¡_Ý_desü_»Ëa£10
;

3479 cÚ¡ 
sc¡_Ýcode_desütÜ
 
sc¡_Ý_desü_´_š
;

3480 cÚ¡ 
sc¡_Ýcode_desütÜ
 
sc¡_Ý_desü_´_out
;

3481 cÚ¡ 
sc¡_Ýcode_desütÜ
 
sc¡_Ý_desü_»pÜt_luns
;

3482 cÚ¡ 
sc¡_Ýcode_desütÜ
 
sc¡_Ý_desü_»que¡_£n£
;

3483 cÚ¡ 
sc¡_Ýcode_desütÜ
 
sc¡_Ý_desü_»pÜt_suµ_tm_âs
;

3484 cÚ¡ 
sc¡_Ýcode_desütÜ
 
sc¡_Ý_desü_»pÜt_suµ_Ýcodes
;

3486 
	#SCST_OPCODE_DESCRIPTORS
 \

3487 &
sc¡_Ý_desü_šquœy
, \

3488 &
sc¡_Ý_desü_tur
, \

3489 &
sc¡_Ý_desü_»£rve6
, \

3490 &
sc¡_Ý_desü_»Ëa£6
, \

3491 &
sc¡_Ý_desü_»£rve10
, \

3492 &
sc¡_Ý_desü_»Ëa£10
, \

3493 &
sc¡_Ý_desü_´_š
, \

3494 &
sc¡_Ý_desü_´_out
, \

3495 &
sc¡_Ý_desü_»pÜt_luns
, \

3496 &
sc¡_Ý_desü_»que¡_£n£
, \

3497 &
sc¡_Ý_desü_»pÜt_suµ_Ýcodes
, \

3498 &
sc¡_Ý_desü_»pÜt_suµ_tm_âs
,

	)

3500 #iâdeà
smp_mb__aá”_£t_b™


3502 
	#smp_mb__aá”_£t_b™
(è
	`smp_mb
()

	)

3509 
	`__sc¡_»gi¡”_rg‘_‹m¶©e
(
sc¡_tgt_‹m¶©e
 *
v‰
,

3510 cÚ¡ *
v”siÚ
);

3511 
šlše
 
	$sc¡_»gi¡”_rg‘_‹m¶©e
(
sc¡_tgt_‹m¶©e
 *
v‰
)

3513  
	`__sc¡_»gi¡”_rg‘_‹m¶©e
(
v‰
, 
SCST_INTERFACE_VERSION
);

3514 
	}
}

3522 
__sc¡_»gi¡”_rg‘_‹m¶©e_nÚ_g¶
(
sc¡_tgt_‹m¶©e
 *
v‰
,

3523 cÚ¡ *
v”siÚ
);

3524 
šlše
 
	$sc¡_»gi¡”_rg‘_‹m¶©e_nÚ_g¶
(

3525 
sc¡_tgt_‹m¶©e
 *
v‰
)

3527  
	`__sc¡_»gi¡”_rg‘_‹m¶©e_nÚ_g¶
(
v‰
,

3528 
SCST_INTERFACE_VERSION
);

3529 
	}
}

3531 
sc¡_uÄegi¡”_rg‘_‹m¶©e
(
sc¡_tgt_‹m¶©e
 *
v‰
);

3533 
sc¡_tgt
 *
sc¡_»gi¡”_rg‘
(
sc¡_tgt_‹m¶©e
 *
v‰
,

3534 cÚ¡ *
rg‘_Çme
);

3535 
sc¡_uÄegi¡”_rg‘
(
sc¡_tgt
 *
tgt
);

3537 
sc¡_£ssiÚ
 *
sc¡_»gi¡”_£ssiÚ
(
sc¡_tgt
 *
tgt
, 
©omic
,

3538 cÚ¡ *
š™ŸtÜ_Çme
, *
tgt_´iv
, *
»suÉ_â_d©a
,

3539 (*
»suÉ_â
)(
sc¡_£ssiÚ
 *
£ss
, *
d©a
, 
»suÉ
));

3540 
sc¡_£ssiÚ
 *
	`sc¡_»gi¡”_£ssiÚ_nÚ_g¶
(
sc¡_tgt
 *
tgt
,

3541 cÚ¡ *
š™ŸtÜ_Çme
, *
tgt_´iv
);

3542 
	`sc¡_uÄegi¡”_£ssiÚ
(
sc¡_£ssiÚ
 *
£ss
, 
wa™
,

3543 (*
uÄeg_dÚe_â
)(
sc¡_£ssiÚ
 *
£ss
));

3544 
	`sc¡_uÄegi¡”_£ssiÚ_nÚ_g¶
(
sc¡_£ssiÚ
 *
£ss
);

3546 
	`__sc¡_»gi¡”_dev_driv”
(
sc¡_dev_ty³
 *
dev_ty³
,

3547 cÚ¡ *
v”siÚ
);

3548 
šlše
 
	$sc¡_»gi¡”_dev_driv”
(
sc¡_dev_ty³
 *
dev_ty³
)

3550  
	`__sc¡_»gi¡”_dev_driv”
(
dev_ty³
, 
SCST_INTERFACE_VERSION
);

3551 
	}
}

3552 
sc¡_uÄegi¡”_dev_driv”
(
sc¡_dev_ty³
 *
dev_ty³
);

3554 
__sc¡_»gi¡”_vœtu®_dev_driv”
(
sc¡_dev_ty³
 *
dev_ty³
,

3555 cÚ¡ *
v”siÚ
);

3560 
šlše
 
	$sc¡_»gi¡”_vœtu®_dev_driv”
(

3561 
sc¡_dev_ty³
 *
dev_ty³
)

3563  
	`__sc¡_»gi¡”_vœtu®_dev_driv”
(
dev_ty³
,

3564 
SCST_INTERFACE_VERSION
);

3565 
	}
}

3567 
sc¡_uÄegi¡”_vœtu®_dev_driv”
(
sc¡_dev_ty³
 *
dev_ty³
);

3569 
boÞ
 
sc¡_š™ŸtÜ_has_luns
(
sc¡_tgt
 *
tgt
, cÚ¡ *
š™ŸtÜ_Çme
);

3571 
sc¡_cmd
 *
sc¡_rx_cmd
(
sc¡_£ssiÚ
 *
£ss
,

3572 cÚ¡ 
ušt8_t
 *
lun
, 
lun_Ën
, cÚ¡ ušt8_ˆ*
cdb
,

3573 
cdb_Ën
, 
boÞ
 
©omic
);

3574 
sc¡_rx_cmd_´—Îoûd
(
sc¡_cmd
 *
cmd
, 
sc¡_£ssiÚ
 *
£ss
,

3575 cÚ¡ 
ušt8_t
 *
lun
, 
lun_Ën
, cÚ¡ ušt8_ˆ*
cdb
,

3576 
cdb_Ën
, 
boÞ
 
©omic
);

3577 
sc¡_cmd_š™_dÚe
(
sc¡_cmd
 *
cmd
,

3578 
sc¡_exec_cÚ‹xt
 
´ef_cÚ‹xt
);

3589 
šlše
 
	$sc¡_cmd_š™_¡age1_dÚe
(
sc¡_cmd
 *
cmd
,

3590 
sc¡_exec_cÚ‹xt
 
´ef_cÚ‹xt
, 
£t_¢
)

3592 
cmd
->
´•roûssšg_Úly
 = 1;

3593 
cmd
->
£t_¢_Ú_»¡¬t_cmd
 = !
£t_¢
;

3594 
	`sc¡_cmd_š™_dÚe
(
cmd
, 
´ef_cÚ‹xt
);

3595 
	}
}

3597 
sc¡_»¡¬t_cmd
(
sc¡_cmd
 *
cmd
, 
¡©us
,

3598 
sc¡_exec_cÚ‹xt
 
´ef_cÚ‹xt
);

3600 
sc¡_rx_d©a
(
sc¡_cmd
 *
cmd
, 
¡©us
,

3601 
sc¡_exec_cÚ‹xt
 
´ef_cÚ‹xt
);

3603 
sc¡_tgt_cmd_dÚe
(
sc¡_cmd
 *
cmd
,

3604 
sc¡_exec_cÚ‹xt
 
´ef_cÚ‹xt
);

3606 
sc¡_rx_mgmt_â
(
sc¡_£ssiÚ
 *
£ss
,

3607 cÚ¡ 
sc¡_rx_mgmt_·¿ms
 *
·¿ms
);

3609 
šlše
 
	$sc¡_rx_mgmt_·¿ms_š™
(

3610 
sc¡_rx_mgmt_·¿ms
 *
·¿ms
)

3612 
	`mem£t
(
·¿ms
, 0, (*params));

3613 
	}
}

3623 
šlše
 
	$sc¡_rx_mgmt_â_g
(
sc¡_£ssiÚ
 *
£ss
, 
â
,

3624 
ušt64_t
 
g
, 
©omic
, *
tgt_´iv
)

3626 
sc¡_rx_mgmt_·¿ms
 
·¿ms
;

3628 
	`BUG_ON
(
â
 !ð
SCST_ABORT_TASK
);

3630 
	`sc¡_rx_mgmt_·¿ms_š™
(&
·¿ms
);

3632 
·¿ms
.
â
 = fn;

3633 
·¿ms
.
g
 =ag;

3634 
·¿ms
.
g_£t
 = 1;

3635 
·¿ms
.
©omic
 =‡tomic;

3636 
·¿ms
.
tgt_´iv
 =gt_priv;

3637  
	`sc¡_rx_mgmt_â
(
£ss
, &
·¿ms
);

3638 
	}
}

3648 
šlše
 
	$sc¡_rx_mgmt_â_lun
(
sc¡_£ssiÚ
 *
£ss
, 
â
,

3649 cÚ¡ *
lun
, 
lun_Ën
, 
©omic
, *
tgt_´iv
)

3651 
sc¡_rx_mgmt_·¿ms
 
·¿ms
;

3653 
	`BUG_ON
(
â
 =ð
SCST_ABORT_TASK
);

3655 
	`sc¡_rx_mgmt_·¿ms_š™
(&
·¿ms
);

3657 
·¿ms
.
â
 = fn;

3658 
·¿ms
.
lun
 =†un;

3659 
·¿ms
.
lun_Ën
 =†un_len;

3660 
·¿ms
.
lun_£t
 = !!
lun
;

3661 
·¿ms
.
©omic
 =‡tomic;

3662 
·¿ms
.
tgt_´iv
 =gt_priv;

3663  
	`sc¡_rx_mgmt_â
(
£ss
, &
·¿ms
);

3664 
	}
}

3666 
sc¡_g‘_cdb_šfo
(
sc¡_cmd
 *
cmd
);

3668 
sc¡_£t_cmd_”rÜ_¡©us
(
sc¡_cmd
 *
cmd
, 
¡©us
);

3669 
sc¡_£t_cmd_”rÜ
(
sc¡_cmd
 *
cmd
, 
key
, 
asc
, 
ascq
);

3670 
sc¡_£t_cmd_”rÜ_ªd_šf
(
sc¡_cmd
 *
cmd
, 
key
, 
asc
,

3671 
ascq
, 
ušt64_t
 
šfÜm©iÚ
);

3672 
sc¡_£t_busy
(
sc¡_cmd
 *
cmd
);

3674 
sc¡_check_cÚv”t_£n£
(
sc¡_cmd
 *
cmd
);

3676 
sc¡_£t_š™Ÿl_UA
(
sc¡_£ssiÚ
 *
£ss
, 
key
, 
asc
, 
ascq
);

3678 
sc¡_ÿ·c™y_d©a_chªged
(
sc¡_deviû
 *
dev
);

3680 
sc¡_cmd
 *
sc¡_fšd_cmd_by_g
(
sc¡_£ssiÚ
 *
£ss
, 
ušt64_t
 
g
);

3681 
sc¡_cmd
 *
sc¡_fšd_cmd
(
sc¡_£ssiÚ
 *
£ss
, *
d©a
,

3682 (*
cmp_â
)(
sc¡_cmd
 *
cmd
,

3683 *
d©a
));

3685 
dma_d©a_dœeùiÚ
 
	`sc¡_to_dma_dœ
(
sc¡_dœ
);

3686 
dma_d©a_dœeùiÚ
 
	`sc¡_to_tgt_dma_dœ
(
sc¡_dœ
);

3688 
	`sc¡_»gi¡”_vœtu®_deviû
(
sc¡_dev_ty³
 *
dev_hªdËr
,

3689 cÚ¡ *
dev_Çme
);

3690 
	`sc¡_uÄegi¡”_vœtu®_deviû
(
id
);

3695 
šlše
 
	$sc¡_tgt_g‘_sg_bËsize
(
sc¡_tgt
 *
tgt
)

3697  
tgt
->
sg_bËsize
;

3698 
	}
}

3700 
šlše
 
	$sc¡_tgt_£t_sg_bËsize
(
sc¡_tgt
 *
tgt
, 
v®
)

3702 
tgt
->
sg_bËsize
 = 
v®
;

3703 
	}
}

3708 
šlše
 *
	$sc¡_tgt_g‘_tgt_´iv
(
sc¡_tgt
 *
tgt
)

3710  
tgt
->
tgt_´iv
;

3711 
	}
}

3713 
šlše
 
	$sc¡_tgt_£t_tgt_´iv
(
sc¡_tgt
 *
tgt
, *
v®
)

3715 
tgt
->
tgt_´iv
 = 
v®
;

3716 
	}
}

3721 
šlše
 
boÞ
 
	$sc¡_tgt_g‘_dif_suµÜ‹d
(
sc¡_tgt
 *
tgt
)

3723  
tgt
->
tgt_dif_suµÜ‹d
;

3724 
	}
}

3726 
šlše
 
	$sc¡_tgt_£t_dif_suµÜ‹d
(
sc¡_tgt
 *
tgt
, 
boÞ
 
v®
)

3728 
tgt
->
tgt_dif_suµÜ‹d
 = !!
v®
;

3729 
	}
}

3734 
šlše
 
boÞ
 
	$sc¡_tgt_g‘_hw_dif_ty³1_suµÜ‹d
(
sc¡_tgt
 *
tgt
)

3736  
tgt
->
tgt_hw_dif_ty³1_suµÜ‹d
;

3737 
	}
}

3739 
šlše
 
	$sc¡_tgt_£t_hw_dif_ty³1_suµÜ‹d
(
sc¡_tgt
 *
tgt
, 
boÞ
 
v®
)

3741 
tgt
->
tgt_hw_dif_ty³1_suµÜ‹d
 = !!
v®
;

3742 
	}
}

3747 
šlše
 
boÞ
 
	$sc¡_tgt_g‘_hw_dif_ty³2_suµÜ‹d
(
sc¡_tgt
 *
tgt
)

3749  
tgt
->
tgt_hw_dif_ty³2_suµÜ‹d
;

3750 
	}
}

3752 
šlše
 
	$sc¡_tgt_£t_hw_dif_ty³2_suµÜ‹d
(
sc¡_tgt
 *
tgt
, 
boÞ
 
v®
)

3754 
tgt
->
tgt_hw_dif_ty³2_suµÜ‹d
 = !!
v®
;

3755 
	}
}

3760 
šlše
 
boÞ
 
	$sc¡_tgt_g‘_hw_dif_ty³3_suµÜ‹d
(
sc¡_tgt
 *
tgt
)

3762  
tgt
->
tgt_hw_dif_ty³3_suµÜ‹d
;

3763 
	}
}

3765 
šlše
 
	$sc¡_tgt_£t_hw_dif_ty³3_suµÜ‹d
(
sc¡_tgt
 *
tgt
, 
boÞ
 
v®
)

3767 
tgt
->
tgt_hw_dif_ty³3_suµÜ‹d
 = !!
v®
;

3768 
	}
}

3773 
šlše
 
boÞ
 
	$sc¡_tgt_g‘_hw_dif__suµÜ‹d
(
sc¡_tgt
 *
tgt
)

3775  
tgt
->
tgt_hw_dif__suµÜ‹d
;

3776 
	}
}

3778 
šlše
 
	$sc¡_tgt_£t_hw_dif__suµÜ‹d
(
sc¡_tgt
 *
tgt
, 
boÞ
 
v®
)

3780 
tgt
->
tgt_hw_dif__suµÜ‹d
 = !!
v®
;

3781 
	}
}

3786 
šlše
 
boÞ
 
	$sc¡_tgt_g‘_hw_dif_§me_sg_Ïyout_»quœed
(
sc¡_tgt
 *
tgt
)

3788  
tgt
->
tgt_hw_dif_§me_sg_Ïyout_»quœed
;

3789 
	}
}

3791 
šlše
 
	$sc¡_tgt_£t_hw_dif_§me_sg_Ïyout_»quœed
(
sc¡_tgt
 *
tgt
, 
boÞ
 
v®
)

3793 
tgt
->
tgt_hw_dif_§me_sg_Ïyout_»quœed
 = !!
v®
;

3794 
	}
}

3799 
šlše
 cÚ¡ *
	$sc¡_tgt_g‘_suµÜ‹d_dif_block_sizes
(

3800 
sc¡_tgt
 *
tgt
)

3802  
tgt
->
tgt_suµÜ‹d_dif_block_sizes
;

3803 
	}
}

3805 
šlše
 
	$sc¡_tgt_£t_suµÜ‹d_dif_block_sizes
(
sc¡_tgt
 *
tgt
,

3806 cÚ¡ *cÚ¡ 
v®
)

3808 
tgt
->
tgt_suµÜ‹d_dif_block_sizes
 = 
v®
;

3809 
	}
}

3811 
sc¡_upd©e_hw_³ndšg_¡¬t
(
sc¡_cmd
 *
cmd
);

3816 
šlše
 *
	$sc¡_£ss_g‘_tgt_´iv
(
sc¡_£ssiÚ
 *
£ss
)

3818  
£ss
->
£ss_tgt_´iv
;

3819 
	}
}

3821 
šlše
 
	$sc¡_£ss_£t_tgt_´iv
(
sc¡_£ssiÚ
 *
£ss
,

3822 *
v®
)

3824 
£ss
->
£ss_tgt_´iv
 = 
v®
;

3825 
	}
}

3827 
ušt16_t
 
sc¡_lookup_tg_id
(
sc¡_deviû
 *
dev
, 
sc¡_tgt
 *
tgt
);

3828 
boÞ
 
sc¡_®ua_cÚfigu»d
(
sc¡_deviû
 *
dev
);

3829 
sc¡_tg_g‘_group_šfo
(**
buf
, 
ušt32_t
 *
»¥Ú£_Ëngth
,

3830 
sc¡_deviû
 *
dev
, 
ušt8_t
 
d©a_fÜm©
);

3831 
sc¡_tg_£t_group_šfo
(
sc¡_cmd
 *
cmd
);

3832 cÚ¡ *
sc¡_®ua_¡©e_Çme
(
sc¡_tg_¡©e
 
s
);

3833 
sc¡_¡pg_d–_unblock_Ãxt
(
sc¡_cmd
 *
cmd
);

3838 
šlše
 
__be16
 
	$sc¡_dev_g‘_dif_¡©ic_­p_g
(
sc¡_deviû
 *
dev
)

3840  
dev
->
dev_dif_¡©ic_­p_g
;

3841 
	}
}

3843 
šlše
 
__be32
 
	$sc¡_dev_g‘_dif_¡©ic_­p_»f_g
(
sc¡_deviû
 *
dev
)

3845  
dev
->
dev_dif_¡©ic_­p_»f_g
;

3846 
	}
}

3848 
šlše
 
__be64
 
	$sc¡_dev_g‘_dif_¡©ic_­p_g_combšed
(

3849 
sc¡_deviû
 *
dev
)

3851 
ušt64_t
 
a
 = (((ušt64_t)
	`be32_to_ýu
(
dev
->
dev_dif_¡©ic_­p_»f_g
)) << 16) |

3852 
	`be16_to_ýu
(
dev
->
dev_dif_¡©ic_­p_g
);

3853  
	`ýu_to_be64
(
a
);

3854 
	}
}

3856 
sc¡_dev_£t_dif_¡©ic_­p_g_combšed
(
sc¡_deviû
 *
dev
,

3857 
__be64
 
­p_g
);

3862 
šlše
 
boÞ
 
	$sc¡_dev_g‘_dif_­p_g_check
(
sc¡_deviû
 *
dev
)

3864  
dev
->
dif_­p_chk
 =ð
SCST_DIF_CHECK_APP_TAG
;

3865 
	}
}

3867 
sc¡_£t_dif_·¿ms
(
sc¡_deviû
 *
dev
,

3868 
sc¡_dif_mode
 
dif_mode
, 
dif_ty³
);

3873 
šlše
 
	$sc¡_dif_acc_­p_check_çžed_tgt
(
sc¡_cmd
 *
cmd
)

3875 
	`©omic_šc
(&
cmd
->
tgt
->
tgt_dif_­p_çžed_tgt
);

3876 
	`©omic_šc
(&
cmd
->
tgt_dev
->
tgt_dev_dif_­p_çžed_tgt
);

3877 
	}
}

3879 
šlše
 
	$sc¡_dif_acc_»f_check_çžed_tgt
(
sc¡_cmd
 *
cmd
)

3881 
	`©omic_šc
(&
cmd
->
tgt
->
tgt_dif_»f_çžed_tgt
);

3882 
	`©omic_šc
(&
cmd
->
tgt_dev
->
tgt_dev_dif_»f_çžed_tgt
);

3883 
	}
}

3885 
šlše
 
	$sc¡_dif_acc_gu¬d_check_çžed_tgt
(
sc¡_cmd
 *
cmd
)

3887 
	`©omic_šc
(&
cmd
->
tgt
->
tgt_dif_gu¬d_çžed_tgt
);

3888 
	`©omic_šc
(&
cmd
->
tgt_dev
->
tgt_dev_dif_gu¬d_çžed_tgt
);

3889 
	}
}

3891 
šlše
 
	$sc¡_dif_acc_­p_check_çžed_sc¡
(
sc¡_cmd
 *
cmd
)

3893 
	`©omic_šc
(&
cmd
->
tgt
->
tgt_dif_­p_çžed_sc¡
);

3894 
	`©omic_šc
(&
cmd
->
tgt_dev
->
tgt_dev_dif_­p_çžed_sc¡
);

3895 
	}
}

3897 
šlše
 
	$sc¡_dif_acc_»f_check_çžed_sc¡
(
sc¡_cmd
 *
cmd
)

3899 
	`©omic_šc
(&
cmd
->
tgt
->
tgt_dif_»f_çžed_sc¡
);

3900 
	`©omic_šc
(&
cmd
->
tgt_dev
->
tgt_dev_dif_»f_çžed_sc¡
);

3901 
	}
}

3903 
šlše
 
	$sc¡_dif_acc_gu¬d_check_çžed_sc¡
(
sc¡_cmd
 *
cmd
)

3905 
	`©omic_šc
(&
cmd
->
tgt
->
tgt_dif_gu¬d_çžed_sc¡
);

3906 
	`©omic_šc
(&
cmd
->
tgt_dev
->
tgt_dev_dif_gu¬d_çžed_sc¡
);

3907 
	}
}

3909 
šlše
 
	$sc¡_dif_acc_­p_check_çžed_dev
(
sc¡_cmd
 *
cmd
)

3911 
	`©omic_šc
(&
cmd
->
tgt
->
tgt_dif_­p_çžed_dev
);

3912 
	`©omic_šc
(&
cmd
->
tgt_dev
->
tgt_dev_dif_­p_çžed_dev
);

3913 
	}
}

3915 
šlše
 
	$sc¡_dif_acc_»f_check_çžed_dev
(
sc¡_cmd
 *
cmd
)

3917 
	`©omic_šc
(&
cmd
->
tgt
->
tgt_dif_»f_çžed_dev
);

3918 
	`©omic_šc
(&
cmd
->
tgt_dev
->
tgt_dev_dif_»f_çžed_dev
);

3919 
	}
}

3921 
šlše
 
	$sc¡_dif_acc_gu¬d_check_çžed_
(
sc¡_cmd
 *
cmd
)

3923 
	`©omic_šc
(&
cmd
->
tgt
->
tgt_dif_gu¬d_çžed_dev
);

3924 
	`©omic_šc
(&
cmd
->
tgt_dev
->
tgt_dev_dif_gu¬d_çžed_dev
);

3925 
	}
}

3935 
šlše
 
	$sc¡_dif_´oûss_»ad
(
sc¡_cmd
 *
cmd
)

3937  
cmd
->
dev
->
	`dev_dif_â
(cmd);

3938 
	}
}

3939 
šlše
 
	$sc¡_dif_´oûss_wr™e
(
sc¡_cmd
 *
cmd
)

3941  
cmd
->
dev
->
	`dev_dif_â
(cmd);

3942 
	}
}

3950 
šlše
 
boÞ
 
	$sc¡_cmd_©omic
(
sc¡_cmd
 *
cmd
)

3952 
»s
 = 
cmd
->
©omic
;

3953 #ifdeà
CONFIG_SCST_EXTRACHECKS


3959 ià(
	`uÆik–y
((
	`š_©omic
(è|| 
	`š_š‹¼u±
(è|| 
	`œqs_di§bËd
()) &&

3960 !
»s
)) {

3961 
	`´_”r
("ERROR:‡tomic context‡nd‚on-atomic cmd!\n");

3962 
	`dump_¡ack
();

3963 
cmd
->
©omic
 = 1;

3964 
»s
 = 1;

3967  
»s
;

3968 
	}
}

3971 
šlše
 
boÞ
 
	$sc¡_cmd_com¶‘ed_good
(
sc¡_cmd
 *
cmd
)

3973  
cmd
->
com¶‘ed
 && (cmd->
¡©us
 =ð
SAM_STAT_GOOD
);

3974 
	}
}

3980 
šlše
 
boÞ
 
	$sc¡_cmd_´–im_com¶‘ed
(
sc¡_cmd
 *
cmd
)

3982  
cmd
->
com¶‘ed
 || 
	`‹¡_b™
(
SCST_CMD_ABORTED
, &cmd->
cmd_æags
);

3983 
	}
}

3985 
šlše
 
sc¡_exec_cÚ‹xt
 
	$__sc¡_e¡im©e_cÚ‹xt
(
boÞ
 
©omic
)

3987 ià(
	`š_œq
())

3988  
SCST_CONTEXT_TASKLET
;

3996 ià(
	`œqs_di§bËd
())

3997  
SCST_CONTEXT_THREAD
;

3998 ià(
	`š_©omic
())

3999  
SCST_CONTEXT_DIRECT_ATOMIC
;

4001  
©omic
 ? 
SCST_CONTEXT_DIRECT
 :

4002 
SCST_CONTEXT_DIRECT_ATOMIC
;

4004  
SCST_CONTEXT_THREAD
;

4006 
	}
}

4008 
šlše
 
sc¡_exec_cÚ‹xt
 
	$sc¡_e¡im©e_cÚ‹xt
()

4010  
	`__sc¡_e¡im©e_cÚ‹xt
(
çl£
);

4011 
	}
}

4013 
šlše
 
sc¡_exec_cÚ‹xt
 
	$sc¡_e¡im©e_cÚ‹xt_©omic
()

4015  
	`__sc¡_e¡im©e_cÚ‹xt
(
Œue
);

4016 
	}
}

4019 
šlše
 cÚ¡ 
ušt8_t
 *
	$sc¡_cmd_g‘_cdb
(
sc¡_cmd
 *
cmd
)

4021  
cmd
->
cdb
;

4022 
	}
}

4025 
šlše
 
	$sc¡_cmd_g‘_cdb_Ën
(
sc¡_cmd
 *
cmd
)

4027  
cmd
->
cdb_Ën
;

4028 
	}
}

4030 
sc¡_cmd_£t_ext_cdb
(
sc¡_cmd
 *
cmd
,

4031 
ušt8_t
 *
ext_cdb
, 
ext_cdb_Ën
, 
gå_t
 
gå_mask
);

4034 
šlše
 
sc¡_£ssiÚ
 *
	$sc¡_cmd_g‘_£ssiÚ
(
sc¡_cmd
 *
cmd
)

4036  
cmd
->
£ss
;

4037 
	}
}

4040 
šlše
 
	$sc¡_cmd_g‘_»¥_d©a_Ën
(
sc¡_cmd
 *
cmd
)

4042  
cmd
->
»¥_d©a_Ën
;

4043 
	}
}

4046 
šlše
 
	$sc¡_cmd_g‘_adju¡ed_»¥_d©a_Ën
(
sc¡_cmd
 *
cmd
)

4048  
cmd
->
adju¡ed_»¥_d©a_Ën
;

4049 
	}
}

4052 
šlše
 
	$sc¡_cmd_g‘_is_£nd_¡©us
(
sc¡_cmd
 *
cmd
)

4054  
cmd
->
is_£nd_¡©us
;

4055 
	}
}

4063 
šlše
 
sÿ‰”li¡
 *
	$sc¡_cmd_g‘_sg
(
sc¡_cmd
 *
cmd
)

4065  
cmd
->
sg
;

4066 
	}
}

4074 
šlše
 
	$sc¡_cmd_g‘_sg_út
(
sc¡_cmd
 *
cmd
)

4076  
cmd
->
sg_út
;

4077 
	}
}

4085 
šlše
 
sÿ‰”li¡
 *
	$sc¡_cmd_g‘_dif_sg
(
sc¡_cmd
 *
cmd
)

4087  
cmd
->
dif_sg
;

4088 
	}
}

4096 
šlše
 
	$sc¡_cmd_g‘_dif_sg_út
(
sc¡_cmd
 *
cmd
)

4098  
cmd
->
dif_sg_út
;

4099 
	}
}

4102 
šlše
 
št64_t
 
	$sc¡_cmd_g‘_lba
(
sc¡_cmd
 *
cmd
)

4104  
cmd
->
lba
;

4105 
	}
}

4114 
šlše
 
	$sc¡_cmd_g‘_bufæ’
(
sc¡_cmd
 *
cmd
)

4116  
cmd
->
bufæ’
;

4117 
	}
}

4123 
šlše
 
št64_t
 
	$sc¡_cmd_g‘_d©a_Ën
(
sc¡_cmd
 *
cmd
)

4125  
cmd
->
d©a_Ën
;

4126 
	}
}

4129 
šlše
 
boÞ
 
	$sc¡_cmd_Ãeds_dif_buf
(
sc¡_cmd
 *
cmd
)

4131  (
	`sc¡_g‘_dif_aùiÚ
(
	`sc¡_g‘_sc¡_dif_aùiÚs
(
cmd
->
cmd_dif_aùiÚs
)è!ð
SCST_DIF_ACTION_NONE
) ||

4132 (
	`sc¡_g‘_dif_aùiÚ
(
	`sc¡_g‘_dev_dif_aùiÚs
(
cmd
->
cmd_dif_aùiÚs
)è!ð
SCST_DIF_ACTION_NONE
);

4133 
	}
}

4136 
šlše
 
	$__sc¡_cmd_g‘_bufæ’_dif
(
sc¡_cmd
 *
cmd
)

4138  (
cmd
->
bufæ’
 >> cmd->
dev
->
block_shiá
è<< 
SCST_DIF_TAG_SHIFT
;

4139 
	}
}

4141 
šlše
 
	$sc¡_cmd_g‘_bufæ’_dif
(
sc¡_cmd
 *
cmd
)

4143 ià(
	`sc¡_cmd_Ãeds_dif_buf
(
cmd
))

4144  
	`__sc¡_cmd_g‘_bufæ’_dif
(
cmd
);

4147 
	}
}

4155 
šlše
 
sÿ‰”li¡
 *
	$sc¡_cmd_g‘_out_sg
(
sc¡_cmd
 *
cmd
)

4157  
cmd
->
out_sg
;

4158 
	}
}

4166 
šlše
 
	$sc¡_cmd_g‘_out_sg_út
(
sc¡_cmd
 *
cmd
)

4168  
cmd
->
out_sg_út
;

4169 
	}
}

4171 
sc¡_»¡Üe_sg_buff
(
sc¡_cmd
 *
cmd
);

4174 
šlše
 
	$sc¡_check_»¡Üe_sg_buff
(
sc¡_cmd
 *
cmd
)

4176 ià(
	`uÆik–y
(
cmd
->
sg_buff_modif›d
 || cmd->
dif_sg_buff_modif›d
))

4177 
	`sc¡_»¡Üe_sg_buff
(
cmd
);

4178 
	}
}

4187 
šlše
 
	$sc¡_cmd_g‘_out_bufæ’
(
sc¡_cmd
 *
cmd
)

4189  
cmd
->
out_bufæ’
;

4190 
	}
}

4196 
šlše
 
sÿ‰”li¡
 *
	$sc¡_cmd_g‘_tgt_sg
(
sc¡_cmd
 *
cmd
)

4198  
cmd
->
tgt_i_sg
;

4199 
	}
}

4205 
šlše
 
	$sc¡_cmd_g‘_tgt_sg_út
(
sc¡_cmd
 *
cmd
)

4207  
cmd
->
tgt_i_sg_út
;

4208 
	}
}

4214 
šlše
 
	$sc¡_cmd_£t_tgt_sg
(
sc¡_cmd
 *
cmd
,

4215 
sÿ‰”li¡
 *
sg
, 
sg_út
)

4217 
cmd
->
tgt_i_sg
 = 
sg
;

4218 
cmd
->
tgt_i_sg_út
 = 
sg_út
;

4219 
cmd
->
tgt_i_d©a_buf_®loûd
 = 1;

4220 
	}
}

4226 
šlše
 
sÿ‰”li¡
 *
	$sc¡_cmd_g‘_tgt_dif_sg
(
sc¡_cmd
 *
cmd
)

4228  
cmd
->
tgt_i_dif_sg
;

4229 
	}
}

4235 
šlše
 
	$sc¡_cmd_g‘_tgt_dif_sg_út
(
sc¡_cmd
 *
cmd
)

4237  
cmd
->
tgt_i_dif_sg_út
;

4238 
	}
}

4244 
šlše
 
	$sc¡_cmd_£t_tgt_dif_sg
(
sc¡_cmd
 *
cmd
,

4245 
sÿ‰”li¡
 *
dif_sg
, 
út
)

4247 
cmd
->
tgt_i_dif_sg
 = 
dif_sg
;

4248 
cmd
->
tgt_i_dif_sg_út
 = 
út
;

4249 
	}
}

4252 
šlše
 
sÿ‰”li¡
 *
	$sc¡_cmd_g‘_out_tgt_sg
(
sc¡_cmd
 *
cmd
)

4254  
cmd
->
tgt_out_sg
;

4255 
	}
}

4258 
šlše
 
	$sc¡_cmd_g‘_tgt_out_sg_út
(
sc¡_cmd
 *
cmd
)

4260  
cmd
->
tgt_out_sg_út
;

4261 
	}
}

4264 
šlše
 
	$sc¡_cmd_£t_tgt_out_sg
(
sc¡_cmd
 *
cmd
,

4265 
sÿ‰”li¡
 *
sg
, 
sg_út
)

4267 
	`WARN_ON
(!
cmd
->
tgt_i_d©a_buf_®loûd
);

4269 
cmd
->
tgt_out_sg
 = 
sg
;

4270 
cmd
->
tgt_out_sg_út
 = 
sg_út
;

4271 
	}
}

4274 
šlše
 
sc¡_d©a_dœeùiÚ
 
	$sc¡_cmd_g‘_d©a_dœeùiÚ
(

4275 
sc¡_cmd
 *
cmd
)

4277  
cmd
->
d©a_dœeùiÚ
;

4278 
	}
}

4281 
šlše
 
	$sc¡_cmd_g‘_wr™e_f›lds
(
sc¡_cmd
 *
cmd
,

4282 
sÿ‰”li¡
 **
sg
, *
sg_út
)

4284 *
sg
 = *
cmd
->
wr™e_sg
;

4285 *
sg_út
 = *
cmd
->
wr™e_sg_út
;

4286  
cmd
->
wr™e_Ën
;

4287 
	}
}

4289 
sc¡_cmd_£t_wr™e_nÙ_»ûived_d©a_Ën
(
sc¡_cmd
 *
cmd
,

4290 
nÙ_»ûived
);

4292 
boÞ
 
__sc¡_g‘_»sid
(
sc¡_cmd
 *
cmd
, *
»sid
, *
bidi_out_»sid
);

4298 
šlše
 
boÞ
 
	$sc¡_g‘_»sid
(
sc¡_cmd
 *
cmd
,

4299 *
»sid
, *
bidi_out_»sid
)

4301 ià(
	`lik–y
(!
cmd
->
»sid_possibË
))

4302  
çl£
;

4303  
	`__sc¡_g‘_»sid
(
cmd
, 
»sid
, 
bidi_out_»sid
);

4304 
	}
}

4307 
šlše
 
ušt8_t
 
	$sc¡_cmd_g‘_¡©us
(
sc¡_cmd
 *
cmd
)

4309  
cmd
->
¡©us
;

4310 
	}
}

4313 
šlše
 
ušt8_t
 
	$sc¡_cmd_g‘_msg_¡©us
(
sc¡_cmd
 *
cmd
)

4315  
cmd
->
msg_¡©us
;

4316 
	}
}

4319 
šlše
 
ušt8_t
 
	$sc¡_cmd_g‘_ho¡_¡©us
(
sc¡_cmd
 *
cmd
)

4321  
cmd
->
ho¡_¡©us
;

4322 
	}
}

4325 
šlše
 
ušt8_t
 
	$sc¡_cmd_g‘_driv”_¡©us
(
sc¡_cmd
 *
cmd
)

4327  
cmd
->
driv”_¡©us
;

4328 
	}
}

4331 
šlše
 
ušt8_t
 *
	$sc¡_cmd_g‘_£n£_bufãr
(
sc¡_cmd
 *
cmd
)

4333  
cmd
->
£n£
;

4334 
	}
}

4337 
šlše
 
	$sc¡_cmd_g‘_£n£_bufãr_Ën
(
sc¡_cmd
 *
cmd
)

4339  
cmd
->
£n£_v®id_Ën
;

4340 
	}
}

4345 
šlše
 
sc¡_cmd_queue_ty³
 
	$sc¡_cmd_g‘_queue_ty³
(

4346 
sc¡_cmd
 *
cmd
)

4348  
cmd
->
queue_ty³
;

4349 
	}
}

4351 
šlše
 
	$sc¡_cmd_£t_queue_ty³
(
sc¡_cmd
 *
cmd
,

4352 
sc¡_cmd_queue_ty³
 
queue_ty³
)

4354 
cmd
->
queue_ty³
 = queue_type;

4355 
	}
}

4360 
šlše
 
ušt64_t
 
	$sc¡_cmd_g‘_g
(
sc¡_cmd
 *
cmd
)

4362  
cmd
->
g
;

4363 
	}
}

4365 
šlše
 
	$sc¡_cmd_£t_g
(
sc¡_cmd
 *
cmd
, 
ušt64_t
 
g
)

4367 
cmd
->
g
 =ag;

4368 
	}
}

4376 
šlše
 *
	$sc¡_cmd_g‘_tgt_´iv
(
sc¡_cmd
 *
cmd
)

4378  
cmd
->
tgt_i_´iv
;

4379 
	}
}

4381 
šlše
 
	$sc¡_cmd_£t_tgt_´iv
(
sc¡_cmd
 *
cmd
, *
v®
)

4383 
cmd
->
tgt_i_´iv
 = 
v®
;

4384 
	}
}

4389 
šlše
 
	$sc¡_cmd_g‘_tgt_Ãed_®loc_d©a_buf
(
sc¡_cmd
 *
cmd
)

4391  
cmd
->
tgt_Ãed_®loc_d©a_buf
;

4392 
	}
}

4394 
šlše
 
	$sc¡_cmd_£t_tgt_Ãed_®loc_d©a_buf
(
sc¡_cmd
 *
cmd
)

4396 
cmd
->
tgt_Ãed_®loc_d©a_buf
 = 1;

4397 
	}
}

4403 
šlše
 
	$sc¡_cmd_g‘_tgt_d©a_buff_®loûd
(
sc¡_cmd
 *
cmd
)

4405  
cmd
->
tgt_i_d©a_buf_®loûd
;

4406 
	}
}

4408 
šlše
 
	$sc¡_cmd_£t_tgt_d©a_buff_®loûd
(
sc¡_cmd
 *
cmd
)

4410 
cmd
->
tgt_i_d©a_buf_®loûd
 = 1;

4411 
	}
}

4416 
šlše
 
	$sc¡_cmd_g‘_dh_d©a_buff_®loûd
(
sc¡_cmd
 *
cmd
)

4418  
cmd
->
dh_d©a_buf_®loûd
;

4419 
	}
}

4421 
šlše
 
	$sc¡_cmd_£t_dh_d©a_buff_®loûd
(
sc¡_cmd
 *
cmd
)

4423 
cmd
->
dh_d©a_buf_®loûd
 = 1;

4424 
	}
}

4429 
šlše
 
	$sc¡_cmd_g‘_no_sgv
(
sc¡_cmd
 *
cmd
)

4431  
cmd
->
no_sgv
;

4432 
	}
}

4434 
šlše
 
	$sc¡_cmd_£t_no_sgv
(
sc¡_cmd
 *
cmd
)

4436 
cmd
->
no_sgv
 = 1;

4437 
	}
}

4442 
šlše
 
	$sc¡_cmd_g‘_tgt_¢
(
sc¡_cmd
 *
cmd
)

4444 
	`BUG_ON
(!
cmd
->
tgt_¢_£t
);

4445  
cmd
->
tgt_¢
;

4446 
	}
}

4448 
šlše
 
	$sc¡_cmd_£t_tgt_¢
(
sc¡_cmd
 *
cmd
, 
ušt32_t
 
tgt_¢
)

4450 
cmd
->
tgt_¢_£t
 = 1;

4451 
cmd
->
tgt_¢
 =gt_sn;

4452 
	}
}

4459 
šlše
 
	$sc¡_cmd_£t_noio_mem_®loc
(
sc¡_cmd
 *
cmd
)

4461 
cmd
->
cmd_gå_mask
 = 
GFP_NOIO
;

4462 
	}
}

4472 
šlše
 
boÞ
 
	$sc¡_cmd_abÜ‹d
(
sc¡_cmd
 *
cmd
)

4474  
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
);

4475 
	}
}

4486 
šlše
 
boÞ
 
	$sc¡_cmd_abÜ‹d_Ú_xm™
(
sc¡_cmd
 *
cmd
)

4488  
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
) &&

4489 !
	`‹¡_b™
(
SCST_CMD_ABORTED_OTHER
, &
cmd
->
cmd_æags
);

4490 
	}
}

4493 
šlše
 
boÞ
 
	$sc¡_g‘_cmd_dev_d_£n£
(
sc¡_cmd
 *
cmd
)

4495  (
cmd
->
dev
 !ð
NULL
è? cmd->dev->
d_£n£
 : 0;

4496 
	}
}

4502 
šlše
 
	$sc¡_cmd_is_ex³ùed_£t
(
sc¡_cmd
 *
cmd
)

4504  
cmd
->
ex³ùed_v®ues_£t
;

4505 
	}
}

4507 
šlše
 
sc¡_d©a_dœeùiÚ
 
	$sc¡_cmd_g‘_ex³ùed_d©a_dœeùiÚ
(

4508 
sc¡_cmd
 *
cmd
)

4510  
cmd
->
ex³ùed_d©a_dœeùiÚ
;

4511 
	}
}

4517 
šlše
 
	$sc¡_cmd_g‘_ex³ùed_Œªsãr_Ën_fuÎ
(

4518 
sc¡_cmd
 *
cmd
)

4520  
cmd
->
ex³ùed_Œªsãr_Ën_fuÎ
;

4521 
	}
}

4523 
sc¡_cmd_g‘_ex³ùed_Œªsãr_Ën_d©a
(
sc¡_cmd
 *
cmd
);

4524 
sc¡_cmd_g‘_ex³ùed_Œªsãr_Ën_dif
(
sc¡_cmd
 *
cmd
);

4526 
šlše
 
	$sc¡_cmd_g‘_ex³ùed_out_Œªsãr_Ën
(

4527 
sc¡_cmd
 *
cmd
)

4529  
cmd
->
ex³ùed_out_Œªsãr_Ën
;

4530 
	}
}

4532 
šlše
 
	$sc¡_cmd_£t_ex³ùed
(
sc¡_cmd
 *
cmd
,

4533 
sc¡_d©a_dœeùiÚ
 
ex³ùed_d©a_dœeùiÚ
,

4534 
ex³ùed_Œªsãr_Ën_fuÎ
)

4536 
cmd
->
ex³ùed_d©a_dœeùiÚ
 =ƒxpected_data_direction;

4537 
cmd
->
ex³ùed_Œªsãr_Ën_fuÎ
 =ƒxpected_transfer_len_full;

4538 
cmd
->
ex³ùed_v®ues_£t
 = 1;

4539 
	}
}

4541 
šlše
 
	$sc¡_cmd_£t_ex³ùed_out_Œªsãr_Ën
(
sc¡_cmd
 *
cmd
,

4542 
ex³ùed_out_Œªsãr_Ën
)

4544 
	`WARN_ON
(!
cmd
->
ex³ùed_v®ues_£t
);

4545 
cmd
->
ex³ùed_out_Œªsãr_Ën
 =ƒxpected_out_transfer_len;

4546 
	}
}

4551 
šlše
 
	$sc¡_g‘_may_Ãed_dma_sync
(
sc¡_cmd
 *
cmd
)

4553  
cmd
->
may_Ãed_dma_sync
;

4554 
	}
}

4556 
šlše
 
	$sc¡_þ—r_may_Ãed_dma_sync
(
sc¡_cmd
 *
cmd
)

4558 
cmd
->
may_Ãed_dma_sync
 = 0;

4559 
	}
}

4566 
šlše
 
	$sc¡_g‘_d–iv”y_¡©us
(
sc¡_cmd
 *
cmd
)

4568  
cmd
->
d–iv”y_¡©us
;

4569 
	}
}

4571 
šlše
 
	$sc¡_£t_d–iv”y_¡©us
(
sc¡_cmd
 *
cmd
,

4572 
d–iv”y_¡©us
)

4574 
cmd
->
d–iv”y_¡©us
 = delivery_status;

4575 
	}
}

4582 
šlše
 
sc¡_dif_aùiÚs
 
	$sc¡_g‘_»ad_dif_tgt_aùiÚs
(

4583 
sc¡_cmd
 *
cmd
)

4585  
	`sc¡_g‘_tgt_dif_aùiÚs
(
cmd
->
cmd_dif_aùiÚs
);

4586 
	}
}

4593 
šlše
 
sc¡_dif_aùiÚs
 
	$sc¡_g‘_wr™e_dif_tgt_aùiÚs
(

4594 
sc¡_cmd
 *
cmd
)

4596  
	`sc¡_g‘_tgt_dif_aùiÚs
(
cmd
->
cmd_dif_aùiÚs
);

4597 
	}
}

4604 
šlše
 
sc¡_dif_aùiÚs
 
	$sc¡_g‘_»ad_dif_dev_aùiÚs
(

4605 
sc¡_cmd
 *
cmd
)

4607  
	`sc¡_g‘_dev_dif_aùiÚs
(
cmd
->
cmd_dif_aùiÚs
);

4608 
	}
}

4615 
šlše
 
sc¡_dif_aùiÚs
 
	$sc¡_g‘_wr™e_dif_dev_aùiÚs
(

4616 
sc¡_cmd
 *
cmd
)

4618  
	`sc¡_g‘_dev_dif_aùiÚs
(
cmd
->
cmd_dif_aùiÚs
);

4619 
	}
}

4625 
šlše
 
	$sc¡_cmd_g‘_dif_´Ù_ty³
(
sc¡_cmd
 *
cmd
)

4627  
cmd
->
dev
->
dev_dif_ty³
;

4628 
	}
}

4641 
šlše
 
__be16
 
	$sc¡_cmd_g‘_dif_­p_g
(
sc¡_cmd
 *
cmd
,

4642 
ušt64_t
 
lba_¡¬t
 )

4644 #ifdeà
CONFIG_SCST_EXTRACHECKS


4645 
	`WARN_ON
(!(
	`sc¡_g‘_dif_checks
(
cmd
->
cmd_dif_aùiÚs
è& 
SCST_DIF_CHECK_APP_TAG
));

4647  
cmd
->
dev
->
dev_dif_¡©ic_­p_g
;

4648 
	}
}

4650 #ià
defšed
(
RHEL_MAJOR
) && RHEL_MAJOR -0 <= 5

4651 
šlše
 
ušt16_t
 
	$g‘_uÇligÃd_be16
(cÚ¡ *
p
)

4653  
	`be16_to_ýu
(
	`g‘_uÇligÃd
((
__be16
 *)
p
));

4654 
	}
}

4656 
šlše
 
	$put_uÇligÃd_be16
(
ušt16_t
 
i
, *
p
)

4658 
	`put_uÇligÃd
(
	`ýu_to_be16
(
i
), (
__be16
 *)
p
);

4659 
	}
}

4661 
šlše
 
ušt32_t
 
	$g‘_uÇligÃd_be32
(cÚ¡ *
p
)

4663  
	`be32_to_ýu
(
	`g‘_uÇligÃd
((
__be32
 *)
p
));

4664 
	}
}

4666 
šlše
 
	$put_uÇligÃd_be32
(
ušt32_t
 
i
, *
p
)

4668 
	`put_uÇligÃd
(
	`ýu_to_be32
(
i
), (
__be32
 *)
p
);

4669 
	}
}

4671 
šlše
 
ušt64_t
 
	$g‘_uÇligÃd_be64
(cÚ¡ *
p
)

4673  
	`be64_to_ýu
(
	`g‘_uÇligÃd
((
__be64
 *)
p
));

4674 
	}
}

4676 
šlše
 
	$put_uÇligÃd_be64
(
ušt64_t
 
i
, *
p
)

4678 
	`put_uÇligÃd
(
	`ýu_to_be64
(
i
), (
__be64
 *)
p
);

4679 
	}
}

4686 
šlše
 
ušt32_t
 
	$sc¡_cmd_g‘_dif_exp_»f_g
(
sc¡_cmd
 *
cmd
)

4688 #ifdeà
CONFIG_SCST_EXTRACHECKS


4689 
	`BUG_ON
(
cmd
->
dev
->
dev_dif_ty³
 != 2);

4690 
	`WARN_ON
(
cmd
->
cdb_Ën
 > 32);

4692 ià(
cmd
->
cdb_Ën
 == 32)

4693  
	`g‘_uÇligÃd_be32
(&
cmd
->
cdb
[20]);

4695  
cmd
->
lba
 & 0xFFFFFFFF;

4696 
	}
}

4702 
šlše
 
ušt16_t
 
	$sc¡_cmd_g‘_dif_exp_­p_g
(
sc¡_cmd
 *
cmd
)

4704 #ifdeà
CONFIG_SCST_EXTRACHECKS


4705 
	`BUG_ON
(
cmd
->
dev
->
dev_dif_ty³
 != 2);

4706 
	`WARN_ON
(
cmd
->
cdb_Ën
 > 32);

4708 ià(
cmd
->
cdb_Ën
 == 32)

4709  
	`g‘_uÇligÃd_be16
(&
cmd
->
cdb
[24]);

4712  
	`be16_to_ýu
(
cmd
->
dev
->
dev_dif_¡©ic_­p_g
);

4714 
	}
}

4720 
šlše
 
ušt16_t
 
	$sc¡_cmd_g‘_dif_­p_g_mask
(
sc¡_cmd
 *
cmd
)

4722 #ifdeà
CONFIG_SCST_EXTRACHECKS


4723 
	`BUG_ON
(
cmd
->
dev
->
dev_dif_ty³
 != 2);

4724 
	`WARN_ON
(
cmd
->
cdb_Ën
 > 32);

4726 ià(
cmd
->
cdb_Ën
 == 32)

4727  
	`g‘_uÇligÃd_be16
(&
cmd
->
cdb
[26]);

4729 ià(
	`sc¡_g‘_dif_checks
(
cmd
->
cmd_dif_aùiÚs
è& 
SCST_DIF_CHECK_APP_TAG
)

4734 
	}
}

4744 
šlše
 
__be32
 
	$sc¡_cmd_g‘_dif_­p_»f_g
(
sc¡_cmd
 *
cmd
)

4746 #ifdeà
CONFIG_SCST_EXTRACHECKS


4747 
	`BUG_ON
(
cmd
->
dev
->
dev_dif_ty³
 != 3);

4748 
	`WARN_ON
(!(
	`sc¡_g‘_dif_checks
(
cmd
->
cmd_dif_aùiÚs
è& 
SCST_DIF_CHECK_REF_TAG
));

4750  
cmd
->
dev
->
dev_dif_¡©ic_­p_»f_g
;

4751 
	}
}

4757 
šlše
 
	$sc¡_cmd_g‘_dif_gu¬d_fÜm©
(
sc¡_cmd
 *
cmd
)

4759  
cmd
->
tgt_dev
->
tgt_dev_dif_gu¬d_fÜm©
;

4760 
	}
}

4766 
šlše
 
	$sc¡_cmd_g‘_block_size
(
sc¡_cmd
 *
cmd
)

4768  
cmd
->
dev
->
block_size
;

4769 
	}
}

4771 
šlše
 
	$sc¡_g‘_aùive_cmd_couÁ
(
sc¡_cmd
 *
cmd
)

4773 ià(
	`lik–y
(
cmd
->
tgt_dev
 !ð
NULL
))

4774  
	`©omic_»ad
(&
cmd
->
tgt_dev
->
tgt_dev_cmd_couÁ
);

4777 
	}
}

4779 
sc¡_£t_cdb_lba
(
sc¡_cmd
 *
cmd
, 
št64_t
 
Ën
);

4780 
sc¡_£t_cdb_Œªsf_Ën
(
sc¡_cmd
 *
cmd
, 
Ën
);

4785 
šlše
 *
	$sc¡_mgmt_cmd_g‘_tgt_´iv
(
sc¡_mgmt_cmd
 *
mcmd
)

4787  
mcmd
->
tgt_´iv
;

4788 
	}
}

4790 
šlše
 
	$sc¡_mgmt_cmd_£t_tgt_´iv
(
sc¡_mgmt_cmd
 *
mcmd
,

4791 *
v®
)

4793 
mcmd
->
tgt_´iv
 = 
v®
;

4794 
	}
}

4797 
šlše
 
	$sc¡_mgmt_cmd_g‘_¡©us
(
sc¡_mgmt_cmd
 *
mcmd
)

4799  
mcmd
->
¡©us
;

4800 
	}
}

4802 
šlše
 
	$sc¡_mgmt_cmd_£t_¡©us
(
sc¡_mgmt_cmd
 *
mcmd
,

4803 
¡©us
)

4806 ià((
mcmd
->
¡©us
 =ð
SCST_MGMT_STATUS_SUCCESS
) &&

4807 (
¡©us
 !ð
SCST_MGMT_STATUS_RECEIVED_STAGE_COMPLETED
))

4808 
mcmd
->
¡©us
 = status;

4809 
	}
}

4812 
šlše
 
	$sc¡_mgmt_cmd_g‘_â
(
sc¡_mgmt_cmd
 *
mcmd
)

4814  
mcmd
->
â
;

4815 
	}
}

4818 
šlše
 
boÞ
 
	$sc¡_mgmt_cmd_drÝ³d
(
sc¡_mgmt_cmd
 *
mcmd
)

4820  
mcmd
->
mcmd_drÝ³d
;

4821 
	}
}

4827 
sc¡_´•¬e_async_mcmd
(
sc¡_mgmt_cmd
 *
mcmd
);

4833 
sc¡_async_mcmd_com¶‘ed
(
sc¡_mgmt_cmd
 *
mcmd
, 
¡©us
);

4836 
šlše
 
	$sc¡_«n_g‘_ev’t_â
(
sc¡_«n
 *
«n
)

4838  
«n
->
ev’t_â
;

4839 
	}
}

4842 
šlše
 
sc¡_£ssiÚ
 *
	$sc¡_«n_g‘_£ss
(
sc¡_«n
 *
«n
)

4844  
«n
->
£ss
;

4845 
	}
}

4848 
šlše
 
__be64
 
	$sc¡_«n_g‘_lun
(
sc¡_«n
 *
«n
)

4850  
«n
->
lun
;

4851 
	}
}

4854 
šlše
 cÚ¡ 
ušt8_t
 *
	$sc¡_«n_g‘_£n£
(
sc¡_«n
 *
«n
)

4856  
«n
->
«n_£n£
;

4857 
	}
}

4860 
šlše
 
	$sc¡_«n_g‘_£n£_Ën
(
sc¡_«n
 *
«n
)

4862  
«n
->
«n_£n£_Ën
;

4863 
	}
}

4870 
šlše
 
	$sc¡_g‘_«n_d–iv”y_¡©us
(
sc¡_«n
 *
«n
)

4872  
«n
->
d–iv”y_¡©us
;

4873 
	}
}

4875 
šlše
 
	$sc¡_£t_«n_d–iv”y_¡©us
(
sc¡_«n
 *
«n
,

4876 
¡©us
)

4878 
«n
->
d–iv”y_¡©us
 = 
¡©us
;

4879 
	}
}

4881 
sc¡_«n_dÚe
(
sc¡_«n
 *
«n
);

4883 
šlše
 
sÿ‰”li¡
 *
	$__sg_Ãxt_šlše
(
sÿ‰”li¡
 *
sg
)

4885 
sg
++;

4886 ià(
	`uÆik–y
(
	`sg_is_chaš
(
sg
)))

4887 
sg
 = 
	`sg_chaš_±r
(sg);

4889  
sg
;

4890 
	}
}

4892 
šlše
 
sÿ‰”li¡
 *
	$sg_Ãxt_šlše
(
sÿ‰”li¡
 *
sg
)

4894 ià(
	`sg_is_Ï¡
(
sg
))

4895  
NULL
;

4897  
	`__sg_Ãxt_šlše
(
sg
);

4898 
	}
}

4900 
šlše
 
	$sg_þ—r
(
sÿ‰”li¡
 *
sg
)

4902 
	`mem£t
(
sg
, 0, (*sg));

4903 #ifdeà
CONFIG_DEBUG_SG


4904 
sg
->
sg_magic
 = 
SG_MAGIC
;

4906 
	}
}

4908 
	esc¡_sg_cÝy_dœ
 {

4909 
	mSCST_SG_COPY_FROM_TARGET
,

4910 
	mSCST_SG_COPY_TO_TARGET


4913 
sc¡_cÝy_sg
(
sc¡_cmd
 *
cmd
, 
sc¡_sg_cÝy_dœ
 
cÝy_dœ
);

4928 
šlše
 
	$__sc¡_g‘_buf
(
sc¡_cmd
 *
cmd
, 
sg_út
,

4929 
ušt8_t
 **
buf
)

4931 
»s
 = 0;

4932 
sÿ‰”li¡
 *
sg
 = 
cmd
->
g‘_sg_buf_cur_sg_’Œy
;

4934 ià(
cmd
->
g‘_sg_buf_’Œy_num
 >ð
sg_út
) {

4935 *
buf
 = 
NULL
;

4936 
out
;

4939 *
buf
 = 
	`·ge_add»ss
(
	`sg_·ge
(
sg
));

4940 *
buf
 +ð
sg
->
off£t
;

4942 
»s
 = 
sg
->
Ëngth
;

4944 
cmd
->
g‘_sg_buf_’Œy_num
++;

4945 
cmd
->
g‘_sg_buf_cur_sg_’Œy
 = 
	`__sg_Ãxt_šlše
(
sg
);

4947 
out
:

4948  
»s
;

4949 
	}
}

4951 
šlše
 
	$sc¡_g‘_buf_fœ¡
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 **
buf
)

4953 ià(
	`uÆik–y
(
cmd
->
sg
 =ð
NULL
)) {

4954 *
buf
 = 
NULL
;

4957 
cmd
->
g‘_sg_buf_’Œy_num
 = 0;

4958 
cmd
->
g‘_sg_buf_cur_sg_’Œy
 = cmd->
sg
;

4959 
cmd
->
may_Ãed_dma_sync
 = 1;

4960  
	`__sc¡_g‘_buf
(
cmd
, cmd->
sg_út
, 
buf
);

4961 
	}
}

4963 
šlše
 
	$sc¡_g‘_buf_Ãxt
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 **
buf
)

4965  
	`__sc¡_g‘_buf
(
cmd
, cmd->
sg_út
, 
buf
);

4966 
	}
}

4968 
šlše
 
	$sc¡_put_buf
(
sc¡_cmd
 *
cmd
, *
buf
)

4971 
	}
}

4987 
šlše
 
ušt8_t
 *
	$sc¡_g‘_dif_buf
(
sc¡_cmd
 *
cmd
,

4988 
sÿ‰”li¡
 **
psg
, *
Ëngth
)

4990 
ušt8_t
 *
buf
;

4991 
sÿ‰”li¡
 *
sg
;

4993 ià(*
psg
 =ð
NULL
)

4994 
sg
 = 
cmd
->
dif_sg
;

4996 
sg
 = 
	`__sg_Ãxt_šlše
(*
psg
);

4998 
buf
 = 
	`·ge_add»ss
(
	`sg_·ge
(
sg
));

4999 
buf
 +ð
sg
->
off£t
;

5000 *
Ëngth
 = 
sg
->length;

5002 *
psg
 = 
sg
;

5004  
buf
;

5005 
	}
}

5007 
šlše
 
	$sc¡_put_dif_buf
(
sc¡_cmd
 *
cmd
, *
buf
)

5010 
	}
}

5012 
šlše
 
	$sc¡_g‘_out_buf_fœ¡
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 **
buf
)

5014 ià(
	`uÆik–y
(
cmd
->
out_sg
 =ð
NULL
)) {

5015 *
buf
 = 
NULL
;

5018 
cmd
->
g‘_sg_buf_’Œy_num
 = 0;

5019 
cmd
->
g‘_sg_buf_cur_sg_’Œy
 = cmd->
out_sg
;

5020 
cmd
->
may_Ãed_dma_sync
 = 1;

5021  
	`__sc¡_g‘_buf
(
cmd
, cmd->
out_sg_út
, 
buf
);

5022 
	}
}

5024 
šlše
 
	$sc¡_g‘_out_buf_Ãxt
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 **
buf
)

5026  
	`__sc¡_g‘_buf
(
cmd
, cmd->
out_sg_út
, 
buf
);

5027 
	}
}

5029 
šlše
 
	$sc¡_put_out_buf
(
sc¡_cmd
 *
cmd
, *
buf
)

5032 
	}
}

5034 
šlše
 
	$sc¡_g‘_sg_buf_fœ¡
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 **
buf
,

5035 
sÿ‰”li¡
 *
sg
, 
sg_út
)

5037 ià(
	`uÆik–y
(
sg
 =ð
NULL
)) {

5038 *
buf
 = 
NULL
;

5041 
cmd
->
g‘_sg_buf_’Œy_num
 = 0;

5042 
cmd
->
g‘_sg_buf_cur_sg_’Œy
 = cmd->
sg
;

5043 
cmd
->
may_Ãed_dma_sync
 = 1;

5044  
	`__sc¡_g‘_buf
(
cmd
, 
sg_út
, 
buf
);

5045 
	}
}

5047 
šlše
 
	$sc¡_g‘_sg_buf_Ãxt
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 **
buf
,

5048 
sÿ‰”li¡
 *
sg
, 
sg_út
)

5050  
	`__sc¡_g‘_buf
(
cmd
, 
sg_út
, 
buf
);

5051 
	}
}

5053 
šlše
 
	$sc¡_put_sg_buf
(
sc¡_cmd
 *
cmd
, *
buf
,

5054 
sÿ‰”li¡
 *
sg
, 
sg_út
)

5057 
	}
}

5069 
šlše
 
	$__sc¡_g‘_sg_·ge
(
sc¡_cmd
 *
cmd
, 
sg_út
,

5070 
·ge
 **·ge, *
off£t
)

5072 
»s
 = 0;

5073 
sÿ‰”li¡
 *
sg
 = 
cmd
->
g‘_sg_buf_cur_sg_’Œy
;

5075 ià(
cmd
->
g‘_sg_buf_’Œy_num
 >ð
sg_út
) {

5076 *
·ge
 = 
NULL
;

5077 *
off£t
 = 0;

5078 
out
;

5081 *
·ge
 = 
	`sg_·ge
(
sg
);

5082 *
off£t
 = 
sg
->offset;

5083 
»s
 = 
sg
->
Ëngth
;

5085 
cmd
->
g‘_sg_buf_’Œy_num
++;

5086 
cmd
->
g‘_sg_buf_cur_sg_’Œy
 = 
	`__sg_Ãxt_šlše
(
sg
);

5088 
out
:

5089  
»s
;

5090 
	}
}

5092 
šlše
 
	$sc¡_g‘_sg_·ge_fœ¡
(
sc¡_cmd
 *
cmd
,

5093 
·ge
 **·ge, *
off£t
)

5095 ià(
	`uÆik–y
(
cmd
->
sg
 =ð
NULL
)) {

5096 *
·ge
 = 
NULL
;

5097 *
off£t
 = 0;

5100 
cmd
->
g‘_sg_buf_’Œy_num
 = 0;

5101 
cmd
->
g‘_sg_buf_cur_sg_’Œy
 = cmd->
sg
;

5102  
	`__sc¡_g‘_sg_·ge
(
cmd
, cmd->
sg_út
, 
·ge
, 
off£t
);

5103 
	}
}

5105 
šlše
 
	$sc¡_g‘_sg_·ge_Ãxt
(
sc¡_cmd
 *
cmd
,

5106 
·ge
 **·ge, *
off£t
)

5108  
	`__sc¡_g‘_sg_·ge
(
cmd
, cmd->
sg_út
, 
·ge
, 
off£t
);

5109 
	}
}

5111 
šlše
 
	$sc¡_put_sg_·ge
(
sc¡_cmd
 *
cmd
,

5112 
·ge
 *·ge, 
off£t
)

5115 
	}
}

5117 
šlše
 
	$sc¡_g‘_out_sg_·ge_fœ¡
(
sc¡_cmd
 *
cmd
,

5118 
·ge
 **·ge, *
off£t
)

5120 ià(
	`uÆik–y
(
cmd
->
out_sg
 =ð
NULL
)) {

5121 *
·ge
 = 
NULL
;

5122 *
off£t
 = 0;

5125 
cmd
->
g‘_sg_buf_’Œy_num
 = 0;

5126 
cmd
->
g‘_sg_buf_cur_sg_’Œy
 = cmd->
out_sg
;

5127  
	`__sc¡_g‘_sg_·ge
(
cmd
, cmd->
out_sg_út
, 
·ge
, 
off£t
);

5128 
	}
}

5130 
šlše
 
	$sc¡_g‘_out_sg_·ge_Ãxt
(
sc¡_cmd
 *
cmd
,

5131 
·ge
 **·ge, *
off£t
)

5133  
	`__sc¡_g‘_sg_·ge
(
cmd
, cmd->
out_sg_út
, 
·ge
, 
off£t
);

5134 
	}
}

5136 
šlše
 
	$sc¡_put_out_sg_·ge
(
sc¡_cmd
 *
cmd
,

5137 
·ge
 *·ge, 
off£t
)

5140 
	}
}

5146 
šlše
 
	$sc¡_g‘_buf_couÁ
(
sc¡_cmd
 *
cmd
)

5148  (
cmd
->
sg_út
 == 0) ? 1 : cmd->sg_cnt;

5149 
	}
}

5155 
šlše
 
	$sc¡_g‘_out_buf_couÁ
(
sc¡_cmd
 *
cmd
)

5157  (
cmd
->
out_sg_út
 == 0) ? 1 : cmd->out_sg_cnt;

5158 
	}
}

5160 
sc¡_g‘_buf_fuÎ
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 **
buf
);

5161 
sc¡_g‘_buf_fuÎ_£n£
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 **
buf
);

5162 
sc¡_put_buf_fuÎ
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
buf
);

5164 
šlše
 
gå_t
 
	$sc¡_cmd_g‘_gå_mask
(
sc¡_cmd
 *
cmd
)

5166  
cmd
->
cmd_gå_mask
;

5167 
	}
}

5170 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 29è&& 
defšed
(
CONFIG_LOCKDEP
)

5171 
lockd•_m­
 
sc¡_su¥’d_d•_m­
;

5174 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 32) && \

5175 
	$defšed
(
CONFIG_DEBUG_LOCK_ALLOC
)

5176 
	#sc¡_as£¹_aùiv™y_su¥’ded
() \

5177 
	`WARN_ON
(
debug_locks
 && !
	`lock_is_h–d
(&
sc¡_su¥’d_d•_m­
))

	)

5183 
	#sc¡_as£¹_aùiv™y_su¥’ded
(èdØ{ 
	}
} 0)

	)

5187 
	#SCST_SUSPEND_TIMEOUT_USER
 (90 * 
HZ
)

	)

5190 
	#SCST_SUSPEND_TIMEOUT_UNLIMITED
 0

	)

5192 
sc¡_su¥’d_aùiv™y
(
timeout
);

5193 
sc¡_»sume_aùiv™y
();

5195 
sc¡_´oûss_aùive_cmd
(
sc¡_cmd
 *
cmd
, 
boÞ
 
©omic
);

5197 
sc¡_po¡_·r£
(
sc¡_cmd
 *
cmd
);

5198 
sc¡_po¡_®loc_d©a_buf
(
sc¡_cmd
 *
cmd
);

5200 
__sc¡_check_loÿl_ev’ts
(
sc¡_cmd
 *
cmd
, 
boÞ
 
´“m±_‹¡s_Úly
);

5211 
šlše
 
	$sc¡_check_loÿl_ev’ts
(
sc¡_cmd
 *
cmd
)

5213  
	`__sc¡_check_loÿl_ev’ts
(
cmd
, 
Œue
);

5214 
	}
}

5216 
sc¡_g‘_cmd_abnÜm®_dÚe_¡©e
(
sc¡_cmd
 *
cmd
);

5217 
sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
sc¡_cmd
 *
cmd
);

5219 
	ssc¡_Œaû_log
 {

5220 
	mv®
;

5221 cÚ¡ *
	mtok’
;

5224 
mu‹x
 
sc¡_mu‹x
;

5226 #ifdeà
CONFIG_SCST_PROC


5233 
´oc_dœ_’Œy
 *
sc¡_´oc_g‘_tgt_roÙ
(

5234 
sc¡_tgt_‹m¶©e
 *
v‰
);

5241 
´oc_dœ_’Œy
 *
sc¡_´oc_g‘_dev_ty³_roÙ
(

5242 
sc¡_dev_ty³
 *
d‰
);

5254 
sc¡_´oc_log_’Œy_»ad
(
£q_fže
 *
£q
, 
log_Ëv–
,

5255 cÚ¡ 
sc¡_Œaû_log
 *
tbl
);

5256 
sc¡_´oc_log_’Œy_wr™e
(
fže
 *fže, cÚ¡ 
__u£r
 *
buf
,

5257 
Ëngth
, *
log_Ëv–
,

5258 
deçuÉ_Ëv–
, cÚ¡ 
sc¡_Œaû_log
 *
tbl
);

5263 
	ssc¡_´oc_d©a
 {

5264 cÚ¡ 
fže_Ý”©iÚs
 
	m£q_Ý
;

5265 (*
	mshow
)(
	m£q_fže
 *, *);

5266 *
	md©a
;

5269 
sc¡_sšgË_£q_Ý’
(
šode
 *šode, 
fže
 *file);

5271 
´oc_dœ_’Œy
 *
sc¡_ü—‹_´oc_’Œy
(´oc_dœ_’Œy *
roÙ
,

5272 cÚ¡ *
Çme
, 
sc¡_´oc_d©a
 *
pd©a
);

5274 
	#SCST_DEF_RW_SEQ_OP
(
x
) \

5275 .
£q_Ý
 = { \

5276 .
owÃr
 = 
THIS_MODULE
, \

5277 .
Ý’
 = 
sc¡_sšgË_£q_Ý’
,\

5278 .
»ad
 = 
£q_»ad
, \

5279 .
wr™e
 = 
x
, \

5280 .
Î£ek
 = 
£q_l£ek
, \

5281 .
»Ëa£
 = 
sšgË_»Ëa£
, \

5282 },

	)

5286 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 34))

5287 cÚ¡ 
sysfs_Ýs
 *
sc¡_sysfs_g‘_sysfs_Ýs
();

5289 
sysfs_Ýs
 *
sc¡_sysfs_g‘_sysfs_Ýs
();

5292 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 29è&& 
defšed
(
CONFIG_LOCKDEP
)

5293 
	#SCST_SET_DEP_MAP
(
wÜk
, 
dm
è((wÜk)->
d•_m­
 = (dm))

	)

5294 
	#SCST_KOBJECT_PUT_AND_WAIT
(
kobj
, 
ÿ‹gÜy
, 
c
, 
d•_m­
) \

5295 
	`sc¡_kobjeù_put_ªd_wa™
(
kobj
, 
ÿ‹gÜy
, 
c
, 
d•_m­
)

	)

5296 
sc¡_kobjeù_put_ªd_wa™
(
kobjeù
 *
kobj
, cÚ¡ *
ÿ‹gÜy
,

5297 
com¶‘iÚ
 *
c
,

5298 
lockd•_m­
 *
d•_m­
);

5300 
	#SCST_SET_DEP_MAP
(
wÜk
, 
dm
èdØ{ } 0)

	)

5301 
	#SCST_KOBJECT_PUT_AND_WAIT
(
kobj
, 
ÿ‹gÜy
, 
c
, 
d•_m­
) \

5302 
	`sc¡_kobjeù_put_ªd_wa™
(
kobj
, 
ÿ‹gÜy
, 
c
)

	)

5303 
sc¡_kobjeù_put_ªd_wa™
(
kobjeù
 *
kobj
, cÚ¡ *
ÿ‹gÜy
,

5304 
com¶‘iÚ
 *
c
);

5311 
šlše
 
kobjeù
 *
	$sc¡_sysfs_g‘_tg‰_kobj
(

5312 
sc¡_tgt_‹m¶©e
 *
tg‰
)

5314  &
tg‰
->
tg‰_kobj
;

5315 
	}
}

5317 
sc¡_ü—‹_tg‰_©Œ
(
sc¡_tgt_‹m¶©e
 *
tg‰
,

5318 
kobj_©Œibu‹
 *
©Œibu‹
);

5324 
šlše
 
kobjeù
 *
	$sc¡_sysfs_g‘_tgt_kobj
(

5325 
sc¡_tgt
 *
tgt
)

5327  &
tgt
->
tgt_kobj
;

5328 
	}
}

5330 
sc¡_ü—‹_tgt_©Œ
(
sc¡_tgt
 *
tgt
,

5331 
kobj_©Œibu‹
 *
©Œibu‹
);

5337 
šlše
 
kobjeù
 *
	$sc¡_sysfs_g‘_devt_kobj
(

5338 
sc¡_dev_ty³
 *
devt
)

5340  &
devt
->
devt_kobj
;

5341 
	}
}

5343 
sc¡_ü—‹_devt_©Œ
(
sc¡_dev_ty³
 *
devt
,

5344 
kobj_©Œibu‹
 *
©Œibu‹
);

5350 
šlše
 
kobjeù
 *
	$sc¡_sysfs_g‘_dev_kobj
(

5351 
sc¡_deviû
 *
dev
)

5353  &
dev
->
dev_kobj
;

5354 
	}
}

5356 
sc¡_ü—‹_dev_©Œ
(
sc¡_deviû
 *
dev
,

5357 
kobj_©Œibu‹
 *
©Œibu‹
);

5363 
šlše
 
kobjeù
 *
	$sc¡_sysfs_g‘_£ss_kobj
(

5364 
sc¡_£ssiÚ
 *
£ss
)

5366  &
£ss
->
£ss_kobj
;

5367 
	}
}

5372 
šlše
 cÚ¡ *
	$sc¡_g‘_tgt_Çme
(cÚ¡ 
sc¡_tgt
 *
tgt
)

5374  
tgt
->
tgt_Çme
;

5375 
	}
}

5377 
sc¡_®loc_£n£
(
sc¡_cmd
 *
cmd
, 
©omic
);

5378 
sc¡_®loc_£t_£n£
(
sc¡_cmd
 *
cmd
, 
©omic
,

5379 cÚ¡ 
ušt8_t
 *
£n£
, 
Ën
);

5381 
sc¡_£t_£n£
(
ušt8_t
 *
bufãr
, 
Ën
, 
boÞ
 
d_£n£
,

5382 
key
, 
asc
, 
ascq
);

5384 
	#SCST_INVAL_FIELD_BIT_OFFS_VALID
 0x8000

	)

5385 
sc¡_£t_šv®id_f›ld_š_cdb
(
sc¡_cmd
 *
cmd
, 
f›ld_offs
,

5386 
b™_offs
);

5387 
sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
sc¡_cmd
 *
cmd
, 
f›ld_offs
,

5388 
b™_offs
);

5390 
boÞ
 
sc¡_is_ua_£n£
(cÚ¡ 
ušt8_t
 *
£n£
, 
Ën
);

5392 
boÞ
 
sc¡_ª®yze_£n£
(cÚ¡ 
ušt8_t
 *
£n£
, 
Ën
,

5393 
v®id_mask
, 
key
, 
asc
, 
ascq
);

5395 
sc¡_¿ndom
();

5397 
sc¡_£t_»¥_d©a_Ën
(
sc¡_cmd
 *
cmd
, 
»¥_d©a_Ën
);

5399 
sc¡_cmd_g‘
(
sc¡_cmd
 *
cmd
);

5400 
sc¡_cmd_put
(
sc¡_cmd
 *
cmd
);

5402 
sÿ‰”li¡
 *
sc¡_®loc_sg
(
size
, 
gå_t
 
gå_mask
, *
couÁ
);

5403 
sc¡_ä“_sg
(
sÿ‰”li¡
 *
sg
, 
couÁ
);

5405 
sc¡_ÿlc_block_shiá
(
£ùÜ_size
);

5406 
sc¡_sbc_g’”ic_·r£
(
sc¡_cmd
 *
cmd
);

5407 
sc¡_cdrom_g’”ic_·r£
(
sc¡_cmd
 *
cmd
);

5408 
sc¡_modisk_g’”ic_·r£
(
sc¡_cmd
 *
cmd
);

5409 
sc¡_³_g’”ic_·r£
(
sc¡_cmd
 *
cmd
);

5410 
sc¡_chªg”_g’”ic_·r£
(
sc¡_cmd
 *
cmd
);

5411 
sc¡_´oûssÜ_g’”ic_·r£
(
sc¡_cmd
 *
cmd
);

5412 
sc¡_¿id_g’”ic_·r£
(
sc¡_cmd
 *
cmd
);

5414 
sc¡_block_g’”ic_dev_dÚe
(
sc¡_cmd
 *
cmd
,

5415 (*
£t_block_shiá
)(
sc¡_cmd
 *
cmd
, 
block_shiá
));

5416 
	`sc¡_³_g’”ic_dev_dÚe
(
sc¡_cmd
 *
cmd
,

5417 (*
£t_block_size
)(
sc¡_cmd
 *
cmd
, 
block_size
));

5419 
	`sc¡_obš_deviû_·¿m‘”s
(
sc¡_deviû
 *
dev
,

5420 cÚ¡ 
ušt8_t
 *
mode_£Ëù_cdb
);

5422 
	`sc¡_»assign_»šed_£ss_¡©es
(
sc¡_£ssiÚ
 *
Ãw_£ss
,

5423 
sc¡_£ssiÚ
 *
Þd_£ss
);

5425 
	`sc¡_g‘_max_lun_commªds
(
sc¡_£ssiÚ
 *
£ss
, 
ušt64_t
 
lun
);

5432 
šlše
 
	$´•¬e_to_wa™_exþusive_h—d
(
wa™_queue_h—d_t
 *
q
,

5433 
wa™_queue_t
 *
wa™
, 
¡©e
)

5435 
æags
;

5437 
wa™
->
æags
 |ð
WQ_FLAG_EXCLUSIVE
;

5438 
	`¥š_lock_œq§ve
(&
q
->
lock
, 
æags
);

5439 ià(
	`li¡_em±y
(&
wa™
->
sk_li¡
))

5440 
	`__add_wa™_queue
(
q
, 
wa™
);

5441 
	`£t_cu¼’t_¡©e
(
¡©e
);

5442 
	`¥š_uÆock_œq»¡Üe
(&
q
->
lock
, 
æags
);

5443 
	}
}

5454 
	#wa™_ev’t_locked
(
wq
, 
cÚd™iÚ
, 
lock_ty³
, 
lock
) \

5455 ià(!(
cÚd™iÚ
)) { \

5456 
	`DEFINE_WAIT
(
__wa™
); \

5459 
	`´•¬e_to_wa™_exþusive_h—d
(&(
wq
), &
__wa™
, \

5460 
TASK_INTERRUPTIBLE
); \

5461 ià(
cÚd™iÚ
) \

5463 
¥š_un
 ## 
	`lock_ty³
(&(
lock
)); \

5464 
	`scheduË
(); \

5465 
¥š_
 ## 
	`lock_ty³
(&(
lock
)); \

5466 } !(
cÚd™iÚ
)); \

5467 
	`fšish_wa™
(&(
wq
), &
__wa™
); \

5468 }

	)

5471 
šlše
 
ušt32_t
 
	$g‘_uÇligÃd_be24
(cÚ¡ 
ušt8_t
 *cÚ¡ 
p
)

5473  
	`g‘_uÇligÃd_be32
(
p
 - 1) & 0xffffffU;

5474 
	}
}

5476 
šlše
 
	$put_uÇligÃd_be24
(cÚ¡ 
ušt32_t
 
v
, 
ušt8_t
 *cÚ¡ 
p
)

5478 
p
[0] = 
v
 >> 16;

5479 
p
[1] = 
v
 >> 8;

5480 
p
[2] = 
v
 >> 0;

5481 
	}
}

5483 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

5484 cÚ¡ *
sc¡_g‘_Ýcode_Çme
(
sc¡_cmd
 *
cmd
);

5486 
šlše
 cÚ¡ *
	$sc¡_g‘_Ýcode_Çme
(
sc¡_cmd
 *
cmd
)

5488  
cmd
->
Ý_Çme
;

5489 
	}
}

5492 #iâdeà
CONFIG_SCST_PROC


5497 
	ssc¡_sysfs_u£r_šfo
 {

5499 
ušt32_t
 
	mšfo_cook›
;

5502 
li¡_h—d
 
	mšfo_li¡_’Œy
;

5505 
	mšfo_bešg_execu‹d
:1;

5508 
	mšfo_š_li¡
:1;

5511 
com¶‘iÚ
 
	mšfo_com¶‘iÚ
;

5514 
	mšfo_¡©us
;

5515 *
	md©a
;

5518 
sc¡_sysfs_u£r_add_šfo
(
sc¡_sysfs_u£r_šfo
 **
out_šfo
);

5519 
sc¡_sysfs_u£r_d–_šfo
(
sc¡_sysfs_u£r_šfo
 *
šfo
);

5520 
sc¡_sysfs_u£r_šfo
 *
sc¡_sysfs_u£r_g‘_šfo
(
ušt32_t
 
cook›
);

5521 
sc¡_wa™_šfo_com¶‘iÚ
(
sc¡_sysfs_u£r_šfo
 *
šfo
,

5522 
timeout
);

5524 
sc¡_g‘_£tup_id
();

5537 
	ssc¡_sysfs_wÜk_™em
 {

5546 
boÞ
 
	m»ad_Úly_aùiÚ
;

5548 
li¡_h—d
 
	msysfs_wÜk_li¡_’Œy
;

5549 
k»f
 
	msysfs_wÜk_k»f
;

5550 (*
	msysfs_wÜk_â
)(
sc¡_sysfs_wÜk_™em
 *
	mwÜk
);

5551 
com¶‘iÚ
 
	msysfs_wÜk_dÚe
;

5552 *
	mbuf
;

5558 
lockd•_m­
 *
	md•_m­
;

5561 
sc¡_dev_ty³
 *
	mdevt
;

5562 
sc¡_tgt_‹m¶©e
 *
	mtg‰
;

5564 
sc¡_tgt
 *
	mtgt
;

5565 
sc¡_acg
 *
	macg
;

5567 
boÞ
 
	mis_tgt_kobj
;

5568 
	mio_groupšg_ty³
;

5569 
boÞ
 
	m’abË
;

5570 
ýumask_t
 
	mýu_mask
;

5574 
sc¡_deviû
 *
	mdev
;

5576 
	mÃw_th»ads_num
;

5577 
boÞ
 
	mdeçuÉ_v®
;

5579 
sc¡_dev_ty³_th»ads_poÞ_ty³
 
	mÃw_th»ads_poÞ_ty³
;

5581 
sc¡_£ssiÚ
 *
	m£ss
;

5583 
sc¡_tgt
 *
	mtgt_r
;

5584 
	m»l_tgt_id
;

5587 
kobjeù
 *
	mkobj
;

5590 
	mwÜk_»s
;

5591 *
	m»s_buf
;

5594 
sc¡_®loc_sysfs_wÜk
((*
sysfs_wÜk_â
)(
sc¡_sysfs_wÜk_™em
 *),

5595 
boÞ
 
»ad_Úly_aùiÚ
, 
sc¡_sysfs_wÜk_™em
 **
»s_wÜk
);

5596 
	`sc¡_sysfs_queue_wa™_wÜk
(
sc¡_sysfs_wÜk_™em
 *
wÜk
);

5597 
	`sc¡_sysfs_wÜk_g‘
(
sc¡_sysfs_wÜk_™em
 *
wÜk
);

5598 
	`sc¡_sysfs_wÜk_put
(
sc¡_sysfs_wÜk_™em
 *
wÜk
);

5600 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 29)

5601 #ifdeà
CONFIG_LOCKDEP


5602 
lockd•_m­
 
sc¡_dev_d•_m­
;

5608 *
	`sc¡_g‘_Ãxt_Ëxem
(**
tok’_¡r
);

5609 
	`sc¡_»¡Üe_tok’_¡r
(*
´ev_Ëxem
, *
tok’_¡r
);

5610 *
	`sc¡_g‘_Ãxt_tok’_¡r
(**
šput_¡r
);

5612 
	`sc¡_š™_th»ads
(
sc¡_cmd_th»ads
 *
cmd_th»ads
);

5613 
	`sc¡_deš™_th»ads
(
sc¡_cmd_th»ads
 *
cmd_th»ads
);

5615 
	`sc¡_·ss_through_cmd_dÚe
(*
d©a
, *
£n£
, 
»suÉ
, 
»sid
);

5616 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 30)

5617 
	`sc¡_scsi_exec_async
(
sc¡_cmd
 *
cmd
, *
d©a
,

5618 (*
dÚe
)(*
d©a
, *
£n£
, 
»suÉ
, 
»sid
));

5621 
	`sc¡_g‘_fže_mode
(cÚ¡ *
·th
);

5622 
boÞ
 
	`sc¡_·»Á_dœ_exi¡s
(cÚ¡ *
·th
);

5624 
	ssc¡_d©a_desütÜ
 {

5625 
ušt64_t
 
sdd_lba
;

5626 
ušt64_t
 
sdd_blocks
;

5629 
	`sc¡_wr™e_§me
(
sc¡_cmd
 *
cmd
, 
sc¡_d©a_desütÜ
 *
wh”e
);

5631 
__be64
 
	`sc¡_·ck_lun
(cÚ¡ 
ušt64_t
 
lun
, 
sc¡_lun_addr_m‘hod
 
addr_m‘hod
);

5632 
ušt64_t
 
	`sc¡_uÅack_lun
(cÚ¡ 
ušt8_t
 *
lun
, 
Ën
);

5634 
	`sc¡_§ve_glob®_mode_·ges
(cÚ¡ 
sc¡_deviû
 *
dev
,

5635 
ušt8_t
 *
buf
, 
size
);

5636 
	`sc¡_»¡Üe_glob®_mode_·ges
(
sc¡_deviû
 *
dev
, *
·¿ms
,

5637 **
Ï¡_·¿m
);

5639 
	`sc¡_»ad_fže_Œª§ùiÚ®
(cÚ¡ *
Çme
, cÚ¡ *
Çme1
,

5640 cÚ¡ *
sigÇtu»
, 
sigÇtu»_Ën
, 
ušt8_t
 *
buf
, 
size
);

5641 
	`sc¡_wr™e_fže_Œª§ùiÚ®
(cÚ¡ *
Çme
, cÚ¡ *
Çme1
,

5642 cÚ¡ *
sigÇtu»
, 
sigÇtu»_Ën
, cÚ¡ 
ušt8_t
 *
buf
, 
size
);

5644 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 39)

5645 
	`sc¡_·th_put
(
Çmeid©a
 *
nd
);

5647 
	`sc¡_»move_fže
(cÚ¡ *
Çme
);

5649 
	`sc¡_´_£t_þu¡”_mode
(
sc¡_deviû
 *
dev
, 
boÞ
 
þu¡”_mode
,

5650 cÚ¡ *
þ_dev_id
);

5651 
	`sc¡_´_š™_dev
(
sc¡_deviû
 *
dev
);

5652 
	`sc¡_´_þ—r_dev
(
sc¡_deviû
 *
dev
);

5654 
	ssc¡_ext_cÝy_d©a_desü
 {

5655 
ušt64_t
 
¤c_lba
;

5656 
ušt64_t
 
d¡_lba
;

5657 
d©a_Ën
;

5660 
	ssc¡_ext_cÝy_£g_desü
 {

5661 
	#SCST_EXT_COPY_SEG_DATA
 0

	)

5663 
	#SCST_EXT_COPY_SEG_PR_REG
 1

	)

5664 
	#SCST_EXT_COPY_SEG_PR_MOVE
 2

	)

5666 
ty³
;

5669 
sc¡_tgt_dev
 *
¤c_tgt_dev
;

5670 
sc¡_tgt_dev
 *
d¡_tgt_dev
;

5671 
sc¡_ext_cÝy_d©a_desü
 
d©a_desü
;

5675 
tgt_desü_offs
;

5678 #iâdeà
CONFIG_SCST_PROC


5679 
	`sc¡_ext_cÝy_»m­_dÚe
(
sc¡_cmd
 *
ec_cmd
,

5680 
sc¡_ext_cÝy_d©a_desü
 *
dds
, 
dds_út
);

5681 
	`sc¡_ext_cÝy_g‘_cur_£g_d©a_Ën
(
sc¡_cmd
 *
ec_cmd
);

	@scst/include/scst_const.h

21 #iâdeà
__SCST_CONST_H


22 
	#__SCST_CONST_H


	)

24 #iâdeà
GENERATING_UPSTREAM_PATCH


30 
	~<lšux/v”siÚ.h
>

32 
	~<scsi/scsi.h
>

34 #iâdeà
__KERNEL__


35 
	~<”ºo.h
>

38 
	~"sc¡_™f_v”.h
"

46 
	#SCST_VERSION
(
a
, 
b
, 
c
, 
d
è((×è<< 24è+ ((bè<< 16è+ ((cè<< 8è+ d)

	)

47 
	#SCST_VERSION_CODE
 
	`SCST_VERSION
(3, 1, 0, 0)

	)

48 #ifdeà
CONFIG_SCST_PROC


49 
	#SCST_VERSION_STRING_SUFFIX
 "-´ocfs"

	)

51 
	#SCST_VERSION_STRING_SUFFIX


	)

53 
	#SCST_VERSION_NAME
 "3.1.0"

	)

54 
	#SCST_VERSION_STRING
 
SCST_VERSION_NAME
 
SCST_VERSION_STRING_SUFFIX


	)

56 
	#SCST_CONST_VERSION
 
SCST_CONST_INTF_VER


	)

61 
	#SCST_MAX_CDB_SIZE
 16

	)

64 
	#SCST_MAX_LONG_CDB_SIZE
 65536

	)

67 
	#SCST_MAX_NAME
 50

	)

70 
	#SCST_MAX_EXTERNAL_NAME
 256

	)

73 
	#SCST_MAX_LUN
 ((1 << (16-2)è- 1)

	)

79 
	#SCST_STANDARD_SENSE_LEN
 18

	)

82 
	#SCST_SENSE_BUFFERSIZE
 252

	)

88 
	#SCST_CMD_DELIVERY_SUCCESS
 0

	)

89 
	#SCST_CMD_DELIVERY_FAILED
 -1

	)

90 
	#SCST_CMD_DELIVERY_ABORTED
 -2

	)

95 
	#SCST_ABORT_TASK
 0

	)

96 
	#SCST_ABORT_TASK_SET
 1

	)

97 
	#SCST_CLEAR_ACA
 2

	)

98 
	#SCST_CLEAR_TASK_SET
 3

	)

99 
	#SCST_LUN_RESET
 4

	)

100 
	#SCST_TARGET_RESET
 5

	)

113 
	#SCST_NEXUS_LOSS_SESS
 6

	)

116 
	#SCST_ABORT_ALL_TASKS_SESS
 7

	)

122 
	#SCST_NEXUS_LOSS
 8

	)

125 
	#SCST_ABORT_ALL_TASKS
 9

	)

136 
	#SCST_UNREG_SESS_TM
 10

	)

151 
	#SCST_PR_ABORT_ALL
 11

	)

156 
	#SCST_MGMT_STATUS_SUCCESS
 0

	)

157 
	#SCST_MGMT_STATUS_TASK_NOT_EXIST
 -1

	)

158 
	#SCST_MGMT_STATUS_LUN_NOT_EXIST
 -2

	)

159 
	#SCST_MGMT_STATUS_FN_NOT_SUPPORTED
 -5

	)

160 
	#SCST_MGMT_STATUS_REJECTED
 -255

	)

161 
	#SCST_MGMT_STATUS_FAILED
 -129

	)

164 
	#SCST_MGMT_STATUS_RECEIVED_STAGE_COMPLETED
 200

	)

170 
	esc¡_lun_addr_m‘hod
 {

171 
	mSCST_LUN_ADDR_METHOD_PERIPHERAL
 = 0,

172 
	mSCST_LUN_ADDR_METHOD_FLAT
 = 1,

173 
	mSCST_LUN_ADDR_METHOD_LUN
 = 2,

174 
	mSCST_LUN_ADDR_METHOD_EXTENDED_LUN
 = 3,

180 
	esc¡_cmd_queue_ty³
 {

181 
	mSCST_CMD_QUEUE_UNTAGGED
 = 0,

182 
	mSCST_CMD_QUEUE_SIMPLE
,

183 
	mSCST_CMD_QUEUE_ORDERED
,

184 
	mSCST_CMD_QUEUE_HEAD_OF_QUEUE
,

185 
	mSCST_CMD_QUEUE_ACA


194 
	esc¡_cdb_æags
 {

199 
	mSCST_SMALL_TIMEOUT
 = 0x0001,

200 
	mSCST_LONG_TIMEOUT
 = 0x0002,

201 
	#SCST_BOTH_TIMEOUTS
 (
SCST_SMALL_TIMEOUT
 | 
SCST_LONG_TIMEOUT
)

	)

202 
	mSCST_TRANSFER_LEN_TYPE_FIXED
 = 0x0004,

203 
	mSCST_UNKNOWN_LBA
 = 0x0008,

204 
	mSCST_UNKNOWN_LENGTH
 = 0x0010,

205 
	mSCST_INFO_VALID
 = 0x0020,

212 
	mSCST_LBA_NOT_VALID
 = 0x0040,

214 
	mSCST_IMPLICIT_HQ
 = 0x0080,

215 
	mSCST_SKIP_UA
 = 0x0100,

216 
	mSCST_WRITE_MEDIUM
 = 0x0200,

217 
	mSCST_LOCAL_CMD
 = 0x0400,

223 
	mSCST_FULLY_LOCAL_CMD
 = 0x0800,

225 
	mSCST_REG_RESERVE_ALLOWED
 = 0x1000,

226 
	mSCST_WRITE_EXCL_ALLOWED
 = 0x2000,

227 
	mSCST_EXCL_ACCESS_ALLOWED
 = 0x4000,

228 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


229 
	mSCST_TEST_IO_IN_SIRQ_ALLOWED
 = 0x8000,

231 
	mSCST_SERIALIZED
 = 0x10000,

232 
	mSCST_STRICTLY_SERIALIZED
 = 0x20000|
SCST_SERIALIZED
,

233 
	mSCST_CAN_GEN_3PARTY_COMMANDS
 = 0x40000,

234 
	mSCST_DESCRIPTORS_BASED
 = 0x80000,

235 
	mSCST_SCSI_ATOMIC
 = 0x100000,

242 
	#SCST_DATA_UNKNOWN
 0

	)

243 
	#SCST_DATA_WRITE
 1

	)

244 
	#SCST_DATA_READ
 2

	)

245 
	#SCST_DATA_BIDI
 (
SCST_DATA_WRITE
 | 
SCST_DATA_READ
)

	)

246 
	#SCST_DATA_NONE
 4

	)

248 
	#SCST_DATA_DIR_MAX
 (
SCST_DATA_NONE
+1)

	)

250 #ifdeà
CONFIG_SCST_PROC


255 
	#SCST_DEFAULT_ACG_NAME
 "DeçuÉ"

	)

262 
	#SCST_DEFAULT_TGT_NAME_SUFFIX
 "_rg‘_"

	)

267 
	#SCST_LOAD_SENSE
(
key_asc_ascq
è
	)
key_asc_ascq

269 
šlše
 
	$sc¡_£n£_v®id
(cÚ¡ 
ušt8_t
 *
£n£
)

271  (
£n£
 !ð
NULL
) && ((sense[0] & 0x70) == 0x70);

272 
	}
}

274 
šlše
 
	$sc¡_no_£n£
(cÚ¡ 
ušt8_t
 *
£n£
)

276  (
£n£
 !ð
NULL
) && (sense[2] == 0);

277 
	}
}

279 
šlše
 
	$sc¡_£n£_»¥Ú£_code
(cÚ¡ 
ušt8_t
 *
£n£
)

281  
£n£
[0] & 0x7F;

282 
	}
}

291 
	#sc¡_£n£_no_£n£
 
NO_SENSE
, 0x00, 0

	)

294 
	#sc¡_£n£_fÜm©_š_´og»ss
 
NOT_READY
, 0x04, 0x04

	)

295 
	#sc¡_£n£_®ua_Œªs™iÚšg
 
NOT_READY
, 0x04, 0x0A

	)

296 
	#sc¡_£n£_®ua_¡ªdby
 
NOT_READY
, 0x04, 0x0B

	)

297 
	#sc¡_£n£_®ua_uÇv
 
NOT_READY
, 0x04, 0x0C

	)

298 
	#sc¡_£n£_no_medium
 
NOT_READY
, 0x3a, 0

	)

301 
	#sc¡_£n£_wr™e_”rÜ
 
MEDIUM_ERROR
, 0x03, 0

	)

302 
	#sc¡_£n£_»ad_”rÜ
 
MEDIUM_ERROR
, 0x11, 0

	)

305 
	#sc¡_£n£_h¬dw_”rÜ
 
HARDWARE_ERROR
, 0x44, 0

	)

306 
	#sc¡_£n£_£t_rg‘_pgs_çžed
 
HARDWARE_ERROR
, 0x67, 0xA

	)

309 
	#sc¡_£n£_Ý”©iÚ_š_´og»ss
 
ILLEGAL_REQUEST
, 0x0, 0x16

	)

310 
	#sc¡_£n£_·¿m‘”_li¡_Ëngth_šv®id
 
ILLEGAL_REQUEST
, 0x1A, 0

	)

311 
	#sc¡_£n£_šv®id_Ýcode
 
ILLEGAL_REQUEST
, 0x20, 0

	)

312 
	#sc¡_£n£_block_out_¿nge_”rÜ
 
ILLEGAL_REQUEST
, 0x21, 0

	)

314 
	#sc¡_£n£_šv®id_f›ld_š_cdb
 
ILLEGAL_REQUEST
, 0x24, 0

	)

315 
	#sc¡_£n£_lun_nÙ_suµÜ‹d
 
ILLEGAL_REQUEST
, 0x25, 0

	)

317 
	#sc¡_£n£_šv®id_f›ld_š_·rm_li¡
 
ILLEGAL_REQUEST
, 0x26, 0

	)

318 
	#sc¡_£n£_·¿m‘”_v®ue_šv®id
 
ILLEGAL_REQUEST
, 0x26, 2

	)

319 
	#sc¡_£n£_šv®id_»Ëa£
 
ILLEGAL_REQUEST
, 0x26, 4

	)

320 
	#sc¡_£n£_too_mªy_rg‘_desütÜs
 
ILLEGAL_REQUEST
, 0x26, 6

	)

321 
	#sc¡_£n£_unsuµÜ‹d_tgt_desü_ty³
 
ILLEGAL_REQUEST
, 0x26, 7

	)

322 
	#sc¡_£n£_too_mªy_£gm’t_desütÜs
 
ILLEGAL_REQUEST
, 0x26, 8

	)

323 
	#sc¡_£n£_unsuµÜ‹d_£g_desü_ty³
 
ILLEGAL_REQUEST
, 0x26, 9

	)

324 
	#sc¡_£n£_šlše_d©a_Ëngth_exûeded
 
ILLEGAL_REQUEST
, 0x26, 0xB

	)

325 
	#sc¡_£n£_§všg_·¿ms_unsup
 
ILLEGAL_REQUEST
, 0x39, 0

	)

326 
	#sc¡_£n£_šv®id_mes§ge
 
ILLEGAL_REQUEST
, 0x49, 0

	)

327 
	#sc¡_£n£_·¿m‘”_li¡_Ëngth_šv®id
 
ILLEGAL_REQUEST
, 0x1A, 0

	)

328 
	#sc¡_£n£_šv®id_f›ld_š_commªd_šfÜm©iÚ_un™
 
ILLEGAL_REQUEST
, 0xE, 0x3

	)

331 
	#sc¡_£n£_medium_chªged_UA
 
UNIT_ATTENTION
, 0x28, 0

	)

332 
	#sc¡_£n£_»£t_UA
 
UNIT_ATTENTION
, 0x29, 0

	)

333 
	#sc¡_£n£_Ãxus_loss_UA
 
UNIT_ATTENTION
, 0x29, 0x7

	)

334 
	#sc¡_£n£_»£rv©iÚ_´“m±ed
 
UNIT_ATTENTION
, 0x2A, 0x03

	)

335 
	#sc¡_£n£_»£rv©iÚ_»Ëa£d
 
UNIT_ATTENTION
, 0x2A, 0x04

	)

336 
	#sc¡_£n£_»gi¡¿tiÚs_´“m±ed
 
UNIT_ATTENTION
, 0x2A, 0x05

	)

337 
	#sc¡_£n£_asym_acûss_¡©e_chªged
 
UNIT_ATTENTION
, 0x2A, 0x06

	)

338 
	#sc¡_£n£_ÿ·c™y_d©a_chªged
 
UNIT_ATTENTION
, 0x2A, 0x9

	)

339 
	#sc¡_£n£_þ—»d_by_ªÙh”_ši_UA
 
UNIT_ATTENTION
, 0x2F, 0

	)

340 
	#sc¡_£n£_šquœy_d©a_chªged
 
UNIT_ATTENTION
, 0x3F, 0x3

	)

341 
	#sc¡_£n£_»pÜ‹d_luns_d©a_chªged
 
UNIT_ATTENTION
, 0x3F, 0xE

	)

344 
	#sc¡_£n£_d©a_´Ùeù
 
DATA_PROTECT
, 0x27, 0

	)

347 
	#sc¡_£n£_abÜ‹d_commªd
 
ABORTED_COMMAND
, 0x00, 0

	)

348 
	#sc¡_logiÿl_block_gu¬d_check_çžed
 
ABORTED_COMMAND
, 0x10, 1

	)

349 
	#sc¡_logiÿl_block_­p_g_check_çžed
 
ABORTED_COMMAND
, 0x10, 2

	)

350 
	#sc¡_logiÿl_block_»f_g_check_çžed
 
ABORTED_COMMAND
, 0x10, 3

	)

351 
	#sc¡_£n£_š‹º®_çžu»
 
ABORTED_COMMAND
, 0x44, 0

	)

354 
	#sc¡_£n£_miscom·»_”rÜ
 
MISCOMPARE
, 0x1D, 0

	)

360 
	#INIT_ELEMENT_STATUS
 0x07

	)

361 
	#INIT_ELEMENT_STATUS_RANGE
 0x37

	)

362 
	#PREVENT_ALLOW_MEDIUM
 0x1E

	)

363 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 38) \

364 && (!
defšed
(
RHEL_MAJOR
è|| 
	gRHEL_MAJOR
 -0 <= 5)

365 
	#READ_ATTRIBUTE
 0x8C

	)

367 
	#REQUEST_VOLUME_ADDRESS
 0xB5

	)

368 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 38) \

369 && (!
defšed
(
RHEL_MAJOR
è|| 
	gRHEL_MAJOR
 -0 <= 5)

370 
	#WRITE_ATTRIBUTE
 0x8D

	)

372 
	#WRITE_VERIFY_16
 0x8E

	)

373 
	#VERIFY_6
 0x13

	)

374 #iâdeà
VERIFY_12


375 
	#VERIFY_12
 0xAF

	)

377 #ià!
defšed
(
GENERATING_UPSTREAM_PATCH
) || \

378 
LINUX_VERSION_CODE
 < 
	$KERNEL_VERSION
(2, 6, 38)

385 #iâdeà
GET_EVENT_STATUS_NOTIFICATION


387 
	#GET_EVENT_STATUS_NOTIFICATION
 0x4a

	)

389 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 26)

390 
	#VARIABLE_LENGTH_CMD
 0x7f

	)

392 #iâdeà
READ_16


393 
	#READ_16
 0x88

	)

395 #iâdeà
WRITE_16


396 
	#WRITE_16
 0x8a

	)

398 #iâdeà
VERIFY_16


399 
	#VERIFY_16
 0x8f

	)

401 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 38)

402 #iâdeà
MI_REPORT_IDENTIFYING_INFORMATION


403 
	#MI_REPORT_IDENTIFYING_INFORMATION
 0x05

	)

405 #iâdeà
MI_REPORT_SUPPORTED_OPERATION_CODES


406 
	#MI_REPORT_SUPPORTED_OPERATION_CODES
 0x0c

	)

408 #iâdeà
MI_REPORT_SUPPORTED_TASK_MANAGEMENT_FUNCTIONS


409 
	#MI_REPORT_SUPPORTED_TASK_MANAGEMENT_FUNCTIONS
 0x0d

	)

412 #iâdeà
SAI_READ_CAPACITY_16


414 
	#SAI_READ_CAPACITY_16
 0x10

	)

417 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 33)

418 #iâdeà
SAI_GET_LBA_STATUS


419 
	#SAI_GET_LBA_STATUS
 0x12

	)

422 #iâdeà
GENERATING_UPSTREAM_PATCH


423 #iâdeà
REPORT_LUNS


424 
	#REPORT_LUNS
 0xa0

	)

428 #iâdeà
WRITE_SAME_16


429 
	#WRITE_SAME_16
 0x93

	)

432 #iâdeà
EXTENDED_COPY


433 
	#EXTENDED_COPY
 0x83

	)

436 #iâdeà
RECEIVE_COPY_RESULTS


437 
	#RECEIVE_COPY_RESULTS
 0x84

	)

440 #iâdeà
SYNCHRONIZE_CACHE_16


441 
	#SYNCHRONIZE_CACHE_16
 0x91

	)

444 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 33)

449 
	#UNMAP
 0x42

	)

453 
	#SUBCODE_READ_32
 0x09

	)

454 
	#SUBCODE_VERIFY_32
 0x0a

	)

455 
	#SUBCODE_WRITE_32
 0x0b

	)

456 
	#SUBCODE_WRITE_VERIFY_32
 0x0c

	)

457 
	#SUBCODE_WRITE_SAME_32
 0x0d

	)

459 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3, 12, 0)

464 #iâdeà
COMPARE_AND_WRITE


465 
	#COMPARE_AND_WRITE
 0x89

	)

469 #ià!
	`defšed
(
__KERNEL__
è|| 
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3, 19, 0)

474 #iâdeà
SERVICE_ACTION_IN_16


475 
	#SERVICE_ACTION_IN_16
 0x9e

	)

479 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 28)

484 
	#BLKDISCARD
 
	`_IO
(0x12,119)

	)

491 
	#SAM_STAT_GOOD
 0x00

	)

492 
	#SAM_STAT_CHECK_CONDITION
 0x02

	)

493 
	#SAM_STAT_CONDITION_MET
 0x04

	)

494 
	#SAM_STAT_BUSY
 0x08

	)

495 
	#SAM_STAT_INTERMEDIATE
 0x10

	)

496 
	#SAM_STAT_INTERMEDIATE_CONDITION_MET
 0x14

	)

497 
	#SAM_STAT_RESERVATION_CONFLICT
 0x18

	)

498 
	#SAM_STAT_COMMAND_TERMINATED
 0x22

	)

499 
	#SAM_STAT_TASK_SET_FULL
 0x28

	)

500 
	#SAM_STAT_ACA_ACTIVE
 0x30

	)

501 
	#SAM_STAT_TASK_ABORTED
 0x40

	)

506 
	#CONTROL_BYTE_LINK_BIT
 0x01

	)

507 
	#CONTROL_BYTE_NACA_BIT
 0x04

	)

512 
	#SCST_INQ_EVPD
 0x01

	)

517 
	#SCST_INQ_BYTE3
 3

	)

519 
	#SCST_INQ_NORMACA_BIT
 0x20

	)

525 
SCST_INQ_TPGS_MODE_IMPLICIT
 = 0x10,

526 
SCST_INQ_TPGS_MODE_EXPLICIT
 = 0x20,

532 
	#SCST_RES_3RDPTY
 0x10

	)

533 
	#SCST_RES_LONGID
 0x02

	)

538 
	#SCST_TST_0_SINGLE_TASK_SET
 0

	)

539 
	#SCST_TST_1_SEP_TASK_SETS
 1

	)

544 
	#SCST_QUEUE_ALG_0_RESTRICTED_REORDER
 0

	)

545 
	#SCST_QUEUE_ALG_1_UNRESTRICTED_REORDER
 1

	)

550 
	#SCST_D_SENSE_0_FIXED_SENSE
 0

	)

551 
	#SCST_D_SENSE_1_DESCR_SENSE
 1

	)

556 
	#SCST_QERR_0_ALL_RESUME
 0

	)

557 
	#SCST_QERR_1_ABORT_ALL
 1

	)

558 
	#SCST_QERR_2_RESERVED
 2

	)

559 
	#SCST_QERR_3_ABORT_THIS_NEXUS_ONLY
 3

	)

566 
	#SCST_ATO_0_MODIFIED_BY_STORAGE
 0

	)

569 
	#SCST_ATO_1_NOT_MODIFIED_BY_STORAGE
 1

	)

574 
	#SCST_DPICZ_CHECK_ON_xPROT_0
 0

	)

575 
	#SCST_DPICZ_NO_CHECK_ON_xPROT_0
 1

	)

582 
	#SCST_DIF_NO_CHECK_ALL_APP_TAG
 
	`ýu_to_be16
(0xFFFF)

	)

583 
	#SCST_DIF_NO_CHECK_ALL_REF_TAG
 
	`ýu_to_be32
(0xFFFFFFFF)

	)

586 
	#SCST_DIF_NO_CHECK_APP_TAG
 0

	)

591 
	#SCST_DIF_TAG_SHIFT
 3

	)

596 
	#SCST_DIF_GUARD_FORMAT_CRC
 0

	)

597 
	#SCST_DIF_GUARD_FORMAT_IP
 1

	)

603 
	#SCSI_TRANSPORTID_PROTOCOLID_FCP2
 0

	)

604 
	#SCSI_TRANSPORTID_PROTOCOLID_SPI5
 1

	)

605 
	#SCSI_TRANSPORTID_PROTOCOLID_SRP
 4

	)

606 
	#SCSI_TRANSPORTID_PROTOCOLID_ISCSI
 5

	)

607 
	#SCSI_TRANSPORTID_PROTOCOLID_SAS
 6

	)

613 
	#SCST_TRANSPORTID_PROTOCOLID_COPY_MGR
 0xC

	)

620 
	esc¡_tg_¡©e
 {

621 
SCST_TG_STATE_UNDEFINED
 = -1,

622 
SCST_TG_STATE_OPTIMIZED
 = 0x0,

623 
SCST_TG_STATE_NONOPTIMIZED
 = 0x1,

624 
SCST_TG_STATE_STANDBY
 = 0x2,

625 
SCST_TG_STATE_UNAVAILABLE
 = 0x3,

626 
SCST_TG_STATE_LBA_DEPENDENT
 = 0x4,

627 
SCST_TG_STATE_OFFLINE
 = 0xe,

628 
SCST_TG_STATE_TRANSITIONING
 = 0xf,

637 
SCST_TG_PREFERRED
 = 0x80,

645 
	esc¡_tg_sup
 {

646 
SCST_TG_SUP_OPTIMIZED
 = 0x01,

647 
SCST_TG_SUP_NONOPTIMIZED
 = 0x02,

648 
SCST_TG_SUP_STANDBY
 = 0x04,

649 
SCST_TG_SUP_UNAVAILABLE
 = 0x08,

650 
SCST_TG_SUP_LBA_DEPENDENT
 = 0x10,

651 
SCST_TG_SUP_OFFLINE
 = 0x40,

652 
SCST_TG_SUP_TRANSITION
 = 0x80,

658 
	#SCST_SENSE_ASC_UA_RESET
 0x29

	)

659 
	#POSITION_LEN_SHORT
 20

	)

660 
	#POSITION_LEN_LONG
 32

	)

665 #iâdeà
DID_TRANSPORT_DISRUPTED


666 
	#DID_TRANSPORT_DISRUPTED
 0xe

	)

669 #iâdeà
DID_TRANSPORT_FAILFAST


670 
	#DID_TRANSPORT_FAILFAST
 0xf

	)

674 #iâdeà
DID_TARGET_FAILURE


675 
	#DID_TARGET_FAILURE
 0x10

	)

678 #iâdeà
DID_NEXUS_FAILURE


679 
	#DID_NEXUS_FAILURE
 0x11

	)

682 #iâdeà
DID_ALLOC_FAILURE


683 
	#DID_ALLOC_FAILURE
 0x12

	)

686 #iâdeà
DID_MEDIUM_ERROR


687 
	#DID_MEDIUM_ERROR
 0x13

	)

693 
	#SCST_DEFAULT_TIMEOUT
 (30 * 
HZ
)

	)

694 
	#SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
 1

	)

696 
	#SCST_GENERIC_CHANGER_TIMEOUT
 (3 * 
HZ
)

	)

697 
	#SCST_GENERIC_CHANGER_LONG_TIMEOUT
 (14000 * 
HZ
)

	)

699 
	#SCST_GENERIC_PROCESSOR_TIMEOUT
 (3 * 
HZ
)

	)

700 
	#SCST_GENERIC_PROCESSOR_LONG_TIMEOUT
 (14000 * 
HZ
)

	)

702 
	#SCST_GENERIC_TAPE_SMALL_TIMEOUT
 (3 * 
HZ
)

	)

703 
	#SCST_GENERIC_TAPE_REG_TIMEOUT
 (900 * 
HZ
)

	)

704 
	#SCST_GENERIC_TAPE_LONG_TIMEOUT
 (14000 * 
HZ
)

	)

706 
	#SCST_GENERIC_MODISK_SMALL_TIMEOUT
 (3 * 
HZ
)

	)

707 
	#SCST_GENERIC_MODISK_REG_TIMEOUT
 (900 * 
HZ
)

	)

708 
	#SCST_GENERIC_MODISK_LONG_TIMEOUT
 (14000 * 
HZ
)

	)

710 
	#SCST_GENERIC_DISK_SMALL_TIMEOUT
 (10 * 
HZ
)

	)

711 
	#SCST_GENERIC_DISK_REG_TIMEOUT
 (60 * 
HZ
)

	)

712 
	#SCST_GENERIC_DISK_LONG_TIMEOUT
 (3600 * 
HZ
)

	)

714 
	#SCST_GENERIC_RAID_TIMEOUT
 (3 * 
HZ
)

	)

715 
	#SCST_GENERIC_RAID_LONG_TIMEOUT
 (14000 * 
HZ
)

	)

717 
	#SCST_GENERIC_CDROM_SMALL_TIMEOUT
 (3 * 
HZ
)

	)

718 
	#SCST_GENERIC_CDROM_REG_TIMEOUT
 (900 * 
HZ
)

	)

719 
	#SCST_GENERIC_CDROM_LONG_TIMEOUT
 (14000 * 
HZ
)

	)

721 
	#SCST_MAX_OTHER_TIMEOUT
 (14000 * 
HZ
)

	)

727 
	#SCST_IO_GROUPING_AUTO_STR
 "auto"

	)

728 
	#SCST_IO_GROUPING_THIS_GROUP_ONLY_STR
 "this_group_Úly"

	)

729 
	#SCST_IO_GROUPING_NEVER_STR
 "Ãv”"

	)

735 
	#SCST_THREADS_POOL_PER_INITIATOR_STR
 "³r_š™ŸtÜ"

	)

736 
	#SCST_THREADS_POOL_SHARED_STR
 "sh¬ed"

	)

741 
	#SCST_SYSFS_BLOCK_SIZE
 
PAGE_SIZE


	)

743 
	#SCST_VAR_DIR
 "/v¬/lib/sc¡"

	)

744 
	#SCST_PR_DIR
 (
SCST_VAR_DIR
 "/´")

	)

746 
	#TID_COMMON_SIZE
 24

	)

748 
	#SCST_SYSFS_KEY_MARK
 "[key]"

	)

750 
	#SCST_MIN_REL_TGT_ID
 1

	)

751 
	#SCST_MAX_REL_TGT_ID
 65535

	)

759 
E_TGT_PRIV_NOT_YET_SET
 = 
EBUSY


763 
	#PR_DLM_LVB_LEN
 256

	)

	@scst/include/scst_debug.h

21 #iâdeà
__SCST_DEBUG_H


22 
	#__SCST_DEBUG_H


	)

24 #ià
LINUX_VERSION_CODE
 <ð
KERNEL_VERSION
(2, 6, 32)

25 
	~<lšux/autocÚf.h
>

27 
	~<g’”©ed/autocÚf.h
>

30 #ià
LINUX_VERSION_CODE
 > 
KERNEL_VERSION
(2, 6, 19)

31 
	~<lšux/bug.h
>

34 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 28)

41 #iâdeà
´_em”g


42 #iâdeà
´_fmt


43 
	#´_fmt
(
fmt
è
	)
fmt

46 
	#´_em”g
(
fmt
, ...) \

47 
	`´štk
(
KERN_EMERG
 
	`´_fmt
(
fmt
), ##
__VA_ARGS__
)

	)

48 
	#´_®”t
(
fmt
, ...) \

49 
	`´štk
(
KERN_ALERT
 
	`´_fmt
(
fmt
), ##
__VA_ARGS__
)

	)

50 
	#´_ü™
(
fmt
, ...) \

51 
	`´štk
(
KERN_CRIT
 
	`´_fmt
(
fmt
), ##
__VA_ARGS__
)

	)

52 
	#´_”r
(
fmt
, ...) \

53 
	`´štk
(
KERN_ERR
 
	`´_fmt
(
fmt
), ##
__VA_ARGS__
)

	)

54 
	#´_w¬nšg
(
fmt
, ...) \

55 
	`´štk
(
KERN_WARNING
 
	`´_fmt
(
fmt
), ##
__VA_ARGS__
)

	)

56 
	#´_nÙiû
(
fmt
, ...) \

57 
	`´štk
(
KERN_NOTICE
 
	`´_fmt
(
fmt
), ##
__VA_ARGS__
)

	)

59 #iâdeà
´_šfo


60 
	#´_šfo
(
fmt
, ...) \

61 
	`´štk
(
KERN_INFO
 
	`´_fmt
(
fmt
), ##
__VA_ARGS__
)

	)

64 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 30)

65 #iâdeà
´_cÚt


66 
	#´_cÚt
(
fmt
, ...) \

67 
	`´štk
(
KERN_CONT
 
fmt
, ##
__VA_ARGS__
)

	)

71 #ià!
defšed
(
INSIDE_KERNEL_TREE
)

72 #ifdeà
CONFIG_SCST_DEBUG


74 #ifdeà
__CHECKER__


79 
	#sBUG
(è
	`BUG
()

	)

80 
	#sBUG_ON
(
p
è
	`BUG_ON
(Õ))

	)

82 
	#sBUG
() do { \

83 
	`´_ü™
("BUG‡ˆ%s:%d\n", 
__FILE__
, 
__LINE__
); \

84 
	`loÿl_œq_’abË
(); \

85 
	`š_soáœq
()) \

86 
	`loÿl_bh_’abË
(); \

87 
	`BUG
(); \

88 } 0)

	)

90 
	#sBUG_ON
(
p
) do { \

91 ià(
	`uÆik–y
(
p
)) { \

92 
	`´_ü™
("BUG‡t %s:%d (%s)\n", \

93 
__FILE__
, 
__LINE__
, #p); \

94 
	`loÿl_œq_’abË
(); \

95 
	`š_soáœq
()) \

96 
	`loÿl_bh_’abË
(); \

97 
	`BUG
(); \

99 } 0)

	)

104 
	#sBUG
(è
	`BUG
()

	)

105 
	#sBUG_ON
(
p
è
	`BUG_ON
Õ)

	)

110 #ià
defšed
(
CONFIG_SCST_EXTRACHECKS
è|| defšed(
__COVERITY__
)

111 
	#EXTRACHECKS_BUG
(è
	`sBUG
()

	)

112 
	#EXTRACHECKS_BUG_ON
(
a
è
	`sBUG_ON
×)

	)

113 
	#EXTRACHECKS_WARN_ON
(
a
è
	`WARN_ON
×)

	)

114 
	#EXTRACHECKS_WARN_ON_ONCE
(
a
è
	`WARN_ON_ONCE
×)

	)

116 
	#EXTRACHECKS_BUG
(èdØ{ } 0)

	)

117 
	#EXTRACHECKS_BUG_ON
(
a
èdØ{ } 0)

	)

118 
	#EXTRACHECKS_WARN_ON
(
a
èdØ{ } 0)

	)

119 
	#EXTRACHECKS_WARN_ON_ONCE
(
a
èdØ{ } 0)

	)

122 
	#TRACE_NULL
 0x00000000

	)

123 
	#TRACE_DEBUG
 0x00000001

	)

124 
	#TRACE_FUNCTION
 0x00000002

	)

125 
	#TRACE_LINE
 0x00000004

	)

126 
	#TRACE_PID
 0x00000008

	)

127 #iâdeà
GENERATING_UPSTREAM_PATCH


128 
	#TRACE_ENTRYEXIT
 0x00000010

	)

130 
	#TRACE_BUFF
 0x00000020

	)

131 
	#TRACE_MEMORY
 0x00000040

	)

132 
	#TRACE_SG_OP
 0x00000080

	)

133 
	#TRACE_OUT_OF_MEM
 0x00000100

	)

134 
	#TRACE_MINOR
 0x00000200

	)

135 
	#TRACE_MGMT
 0x00000400

	)

136 
	#TRACE_MGMT_DEBUG
 0x00000800

	)

137 
	#TRACE_SCSI
 0x00001000

	)

138 
	#TRACE_SPECIAL
 0x00002000

	)

139 
	#TRACE_FLOW_CONTROL
 0x00004000

	)

140 
	#TRACE_PRES
 0x00008000

	)

141 
	#TRACE_BLOCKING
 0x00010000

	)

142 
	#TRACE_ALL
 0xffffffff

	)

145 
	#TRACE_MINOR_AND_MGMT_DBG
 (
TRACE_MINOR
|
TRACE_MGMT_DEBUG
)

	)

147 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 24è&& !
defšed
(
RHEL_MAJOR
)

148 
	#KERN_CONT
 ""

	)

155 
	#PRINT
(
log_æag
, 
fÜm©
, 
¬gs
...) \

156 
	`´štk
(
log_æag
 
fÜm©
 "\n", ## 
¬gs
)

	)

157 
	#PRINTN
(
log_æag
, 
fÜm©
, 
¬gs
...) \

158 
	`´štk
(
log_æag
 
fÜm©
, ## 
¬gs
)

	)

160 #ifdeà
LOG_PREFIX


161 
	#__LOG_PREFIX
 
LOG_PREFIX


	)

163 
	#__LOG_PREFIX
 
NULL


	)

166 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

168 #iâdeà
CONFIG_SCST_DEBUG


169 
	#___uÆik–y
(
a
è×)

	)

171 
	#___uÆik–y
(
a
è
	`uÆik–y
×)

	)

175 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 21è|| 
defšed
(
__´štf
)

176 
	$__´štf
(6, 7)

178 
	`__©Œibu‹__
((
	$fÜm©
(
´štf
, 6, 7)))

180 
	`debug_´št_w™h_´efix
(
Œaû_æag
,

181 cÚ¡ *
£v”™y
, cÚ¡ *
´efix
, cÚ¡ *
func
, 
lše
,

182 cÚ¡ *
fmt
, ...);

183 
	`debug_´št_bufãr
(cÚ¡ *
d©a
, 
Ën
);

184 cÚ¡ *
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(cÚ¡ 
ušt8_t
 *
Œª¥Üt_id
);

186 
	#TRACING_MINOR
(è(
Œaû_æag
 & 
TRACE_MINOR
)

	)

188 
	#TRACE
(
Œaû
, 
fÜm©
, 
¬gs
...) \

190 ià(
	`___uÆik–y
(
Œaû_æag
 & (
Œaû
))) { \

191 
	`debug_´št_w™h_´efix
(
Œaû_æag
, 
KERN_INFO
, \

192 
__LOG_PREFIX
, 
__func__
, 
__LINE__
, 
fÜm©
, ## 
¬gs
); \

194 
	}
} 0)

	)

196 #ifdeà
CONFIG_SCST_DEBUG


198 
	#PRINT_BUFFER
(
mes§ge
, 
buff
, 
Ën
) \

200 
	`PRINT
(
KERN_INFO
, "%s:%s:", 
__func__
, 
mes§ge
); \

201 
	`debug_´št_bufãr
(
buff
, 
Ën
); \

202 } 0)

	)

206 
	#PRINT_BUFFER
(
mes§ge
, 
buff
, 
Ën
) \

208 
	`PRINT
(
KERN_INFO
, "%s:", 
mes§ge
); \

209 
	`debug_´št_bufãr
(
buff
, 
Ën
); \

210 } 0)

	)

214 
	#PRINT_BUFF_FLAG
(
æag
, 
mes§ge
, 
buff
, 
Ën
) \

216 ià(
	`___uÆik–y
(
Œaû_æag
 & (
æag
))) { \

217 
	`debug_´št_w™h_´efix
(
Œaû_æag
, 
KERN_INFO
, 
NULL
, \

218 
__func__
, 
__LINE__
, "%s:", 
mes§ge
); \

219 
	`debug_´št_bufãr
(
buff
, 
Ën
); \

221 } 0)

	)

223 
	#PRINT_LOG_FLAG
(
log_æag
, 
fÜm©
, 
¬gs
...) \

224 
	`debug_´št_w™h_´efix
(
Œaû_æag
, 
KERN_INFO
, 
__LOG_PREFIX
, \

225 
__func__
, 
__LINE__
, 
fÜm©
, ## 
¬gs
)

	)

227 
	#PRINT_WARNING
(
fÜm©
, 
¬gs
...) \

228 
	`debug_´št_w™h_´efix
(
Œaû_æag
, 
KERN_WARNING
, 
__LOG_PREFIX
, \

229 
__func__
, 
__LINE__
, "***WARNING***: " 
fÜm©
, ## 
¬gs
)

	)

231 
	#PRINT_ERROR
(
fÜm©
, 
¬gs
...) \

232 
	`debug_´št_w™h_´efix
(
Œaû_æag
, 
KERN_ERR
, 
__LOG_PREFIX
, \

233 
__func__
, 
__LINE__
, "***ERROR***: " 
fÜm©
, ## 
¬gs
)

	)

235 
	#PRINT_CRIT_ERROR
(
fÜm©
, 
¬gs
...) \

236 
	`debug_´št_w™h_´efix
(
Œaû_æag
, 
KERN_CRIT
, 
__LOG_PREFIX
, \

237 
__func__
, 
__LINE__
, "***CRITICAL ERROR***: " 
fÜm©
, ## 
¬gs
)

	)

239 
	#PRINT_INFO
(
fÜm©
, 
¬gs
...) \

240 
	`debug_´št_w™h_´efix
(
Œaû_æag
, 
KERN_INFO
, 
__LOG_PREFIX
, \

241 
__func__
, 
__LINE__
, 
fÜm©
, ## 
¬gs
)

	)

245 
	#TRACING_MINOR
(è(
çl£
)

	)

247 
	#TRACE
(
Œaû
, 
fÜm©
, 
¬gs
...) \

248 (()(
Œaû
), 
	`no_´štk
(
fÜm©
, ##
¬gs
))

	)

249 
	#PRINT_BUFFER
(
mes§ge
, 
buff
, 
Ën
) \

250 (()(
mes§ge
), ()(
buff
), ()(
Ën
))

	)

251 
	#PRINT_BUFF_FLAG
(
æag
, 
mes§ge
, 
buff
, 
Ën
) \

252 (()(
æag
), ()(
mes§ge
), ()(
buff
), ()(
Ën
))

	)

254 #ifdeà
LOG_PREFIX


256 
	#PRINT_INFO
(
fÜm©
, 
¬gs
...) \

257 
	`PRINT
(
KERN_INFO
, "%s: " 
fÜm©
, 
LOG_PREFIX
, ## 
¬gs
)

	)

259 
	#PRINT_WARNING
(
fÜm©
, 
¬gs
...) \

260 
	`PRINT
(
KERN_WARNING
, "%s: ***WARNING***: " 
fÜm©
, 
LOG_PREFIX
, ## 
¬gs
)

	)

262 
	#PRINT_ERROR
(
fÜm©
, 
¬gs
...) \

263 
	`PRINT
(
KERN_ERR
, "%s: ***ERROR***: " 
fÜm©
, 
LOG_PREFIX
, ## 
¬gs
)

	)

265 
	#PRINT_CRIT_ERROR
(
fÜm©
, 
¬gs
...) \

266 
	`PRINT
(
KERN_CRIT
, "%s: ***CRITICAL ERROR***: " \

267 
fÜm©
, 
LOG_PREFIX
, ## 
¬gs
)

	)

271 
	#PRINT_INFO
(
fÜm©
, 
¬gs
...) \

272 
	`PRINT
(
KERN_INFO
, 
fÜm©
, ## 
¬gs
)

	)

274 
	#PRINT_WARNING
(
fÜm©
, 
¬gs
...) \

275 
	`PRINT
(
KERN_WARNING
, "***WARNING***: " 
fÜm©
, ## 
¬gs
)

	)

277 
	#PRINT_ERROR
(
fÜm©
, 
¬gs
...) \

278 
	`PRINT
(
KERN_ERR
, "***ERROR***: " 
fÜm©
, ## 
¬gs
)

	)

280 
	#PRINT_CRIT_ERROR
(
fÜm©
, 
¬gs
...) \

281 
	`PRINT
(
KERN_CRIT
, "***CRITICAL ERROR***: " 
fÜm©
, ## 
¬gs
)

	)

287 #ifdeà
CONFIG_SCST_DEBUG


289 
	#TRACE_DBG_FLAG
(
Œaû
, 
fÜm©
, 
¬gs
...) \

291 ià(
Œaû_æag
 & (
Œaû
)) { \

292 
	`debug_´št_w™h_´efix
(
Œaû_æag
, 
KERN_INFO
, 
NULL
, \

293 
__func__
, 
__LINE__
, 
fÜm©
, ## 
¬gs
); \

295 } 0)

	)

297 
	#TRACE_MEM
(
fÜm©
, 
¬gs
...) \

298 
	`TRACE_DBG_FLAG
(
TRACE_MEMORY
, 
fÜm©
, ## 
¬gs
)

	)

299 
	#TRACE_SG
(
fÜm©
, 
¬gs
...) \

300 
	`TRACE_DBG_FLAG
(
TRACE_SG_OP
, 
fÜm©
, ## 
¬gs
)

	)

301 
	#TRACE_DBG
(
fÜm©
, 
¬gs
...) \

302 
	`TRACE_DBG_FLAG
(
TRACE_DEBUG
, 
fÜm©
, ## 
¬gs
)

	)

303 
	#TRACE_DBG_SPECIAL
(
fÜm©
, 
¬gs
...) \

304 
	`TRACE_DBG_FLAG
(
TRACE_DEBUG
|
TRACE_SPECIAL
, 
fÜm©
, ## 
¬gs
)

	)

305 
	#TRACE_MGMT_DBG
(
fÜm©
, 
¬gs
...) \

306 
	`TRACE_DBG_FLAG
(
TRACE_MGMT_DEBUG
, 
fÜm©
, ## 
¬gs
)

	)

307 
	#TRACE_MGMT_DBG_SPECIAL
(
¬gs
...) \

308 
	`TRACE_DBG_FLAG
(
TRACE_MGMT_DEBUG
|
TRACE_SPECIAL
, 
fÜm©
, ## 
¬gs
)

	)

309 
	#TRACE_PR
(
fÜm©
, 
¬gs
...) \

310 
	`TRACE_DBG_FLAG
(
TRACE_PRES
, 
fÜm©
, ## 
¬gs
)

	)

311 
	#TRACE_BLOCK
(
fÜm©
, 
¬gs
...) \

312 
	`TRACE_DBG_FLAG
(
TRACE_BLOCKING
, 
fÜm©
, ## 
¬gs
)

	)

314 
	#TRACE_BUFFER
(
mes§ge
, 
buff
, 
Ën
) \

316 ià(
Œaû_æag
 & 
TRACE_BUFF
) { \

317 
	`debug_´št_w™h_´efix
(
Œaû_æag
, 
KERN_INFO
, 
NULL
, \

318 
__func__
, 
__LINE__
, "%s:", 
mes§ge
); \

319 
	`debug_´št_bufãr
(
buff
, 
Ën
); \

321 } 0)

	)

323 
	#TRACE_BUFF_FLAG
(
æag
, 
mes§ge
, 
buff
, 
Ën
) \

325 ià(
Œaû_æag
 & (
æag
)) { \

326 
	`debug_´št_w™h_´efix
(
Œaû_æag
, 
KERN_INFO
, 
NULL
, \

327 
__func__
, 
__LINE__
, "%s:", 
mes§ge
); \

328 
	`debug_´št_bufãr
(
buff
, 
Ën
); \

330 } 0)

	)

332 #iâdeà
GENERATING_UPSTREAM_PATCH


333 
	#TRACE_ENTRY
() \

335 ià(
Œaû_æag
 & 
TRACE_ENTRYEXIT
) { \

336 ià(
Œaû_æag
 & 
TRACE_PID
) { \

337 
	`PRINT
(
KERN_INFO
, "[%d]: ENTRY %s", 
cu¼’t
->
pid
, \

338 
__func__
); \

341 
	`PRINT
(
KERN_INFO
, "ENTRY %s", 
__func__
); \

344 } 0)

	)

346 
	#TRACE_EXIT
() \

348 ià(
Œaû_æag
 & 
TRACE_ENTRYEXIT
) { \

349 ià(
Œaû_æag
 & 
TRACE_PID
) { \

350 
	`PRINT
(
KERN_INFO
, "[%d]: EXIT %s", 
cu¼’t
->
pid
, \

351 
__func__
); \

354 
	`PRINT
(
KERN_INFO
, "EXIT %s", 
__func__
); \

357 } 0)

	)

359 
	#TRACE_EXIT_RES
(
»s
) \

361 ià(
Œaû_æag
 & 
TRACE_ENTRYEXIT
) { \

362 ià(
Œaû_æag
 & 
TRACE_PID
) { \

363 
	`PRINT
(
KERN_INFO
, "[%d]: EXIT %s: %ld", 
cu¼’t
->
pid
, \

364 
__func__
, ()(
»s
)); \

367 
	`PRINT
(
KERN_INFO
, "EXIT %s: %ld", \

368 
__func__
, ()(
»s
)); \

371 } 0)

	)

373 
	#TRACE_EXIT_HRES
(
»s
) \

375 ià(
Œaû_æag
 & 
TRACE_ENTRYEXIT
) { \

376 ià(
Œaû_æag
 & 
TRACE_PID
) { \

377 
	`PRINT
(
KERN_INFO
, "[%d]: EXIT %s: 0x%lx", 
cu¼’t
->
pid
, \

378 
__func__
, ()(
»s
)); \

381 
	`PRINT
(
KERN_INFO
, "EXIT %s: %lx", \

382 
__func__
, ()(
»s
)); \

385 } 0)

	)

390 
	#TRACE_MEM
(
fÜm©
, 
¬gs
...è
	`no_´štk
(fÜm©, ##¬gs)

	)

391 
	#TRACE_SG
(
fÜm©
, 
¬gs
...è
	`no_´štk
(fÜm©, ##¬gs)

	)

392 
	#TRACE_DBG
(
fÜm©
, 
¬gs
...è
	`no_´štk
(fÜm©, ##¬gs)

	)

393 
	#TRACE_DBG_FLAG
(
æag
, 
fÜm©
, 
¬gs
...) \

394 (()(
æag
), 
	`no_´štk
(
fÜm©
, ##
¬gs
))

	)

395 
	#TRACE_DBG_SPECIAL
(
fÜm©
, 
¬gs
...è
	`no_´štk
(fÜm©, ##¬gs)

	)

396 
	#TRACE_MGMT_DBG
(
fÜm©
, 
¬gs
...è
	`no_´štk
(fÜm©, ##¬gs)

	)

397 
	#TRACE_MGMT_DBG_SPECIAL
(
fÜm©
, 
¬gs
...è
	`no_´štk
(fÜm©, ##¬gs)

	)

398 
	#TRACE_PR
(
fÜm©
, 
¬gs
...èdØ{} 0)

	)

399 
	#TRACE_BLOCK
(
fÜm©
, 
¬gs
...è
	`no_´štk
(fÜm©, ##¬gs)

	)

400 
	#TRACE_BUFFER
(
mes§ge
, 
buff
, 
Ën
) \

401 (()(
mes§ge
), ()(
buff
), ()(
Ën
))

	)

402 
	#TRACE_BUFF_FLAG
(
æag
, 
mes§ge
, 
buff
, 
Ën
) \

403 (()(
æag
), ()(
mes§ge
), ()(
buff
), ()(
Ën
))

	)

405 #iâdeà
GENERATING_UPSTREAM_PATCH


406 
	#TRACE_ENTRY
(èdØ{} 0)

	)

407 
	#TRACE_EXIT
(èdØ{} 0)

	)

408 
	#TRACE_EXIT_RES
(
»s
èdØ{} 0)

	)

409 
	#TRACE_EXIT_HRES
(
»s
èdØ{} 0)

	)

414 #ià
defšed
(
CONFIG_SCST_DEBUG
è&& defšed(
CONFIG_DEBUG_SLAB
)

415 
	#SCST_SLAB_FLAGS
 (
SLAB_RED_ZONE
 | 
SLAB_POISON
)

	)

417 
	#SCST_SLAB_FLAGS
 0L

	)

	@scst/include/scst_event.h

9 #iâdeà
__SCST_EVENT_H


10 
	#__SCST_EVENT_H


	)

12 #ifdeà
__KERNEL__


13 
	~<lšux/ty³s.h
>

16 #ifdeà
INSIDE_KERNEL_TREE


17 
	~<sc¡/sc¡_cÚ¡.h
>

19 
	~"sc¡_cÚ¡.h
"

22 
	#SCST_EVENT_NAME
 "sc¡_ev’t"

	)

23 
	#SCST_EVENT_PATH
 "/dev/"

	)

24 
	#SCST_EVENT_DEV
 
SCST_EVENT_PATH
 
SCST_EVENT_NAME


	)

25 
	#SCST_EVENT_VERSION_NAME
 
SCST_VERSION_NAME


	)

26 
	#SCST_EVENT_VERSION
 \

27 
SCST_EVENT_VERSION_NAME
 "$RevisiÚ: 2454 $" 
SCST_CONST_VERSION


	)

29 #iâdeà
®igÃd_u64


30 
	#®igÃd_u64
 
ušt64_t
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

37 
	ssc¡_ev’t
 {

38 
št32_t
 
	m·ylßd_Ën
;

40 
ušt32_t
 
	mev’t_code
;

42 
ušt32_t
 
	mev’t_id
;

49 
	missu”_Çme
[
SCST_MAX_NAME
];

51 
ušt8_t
 
	m·ylßd
[];

54 #ifdeà
__KERNEL__


55 (*
	tsc¡_ev’t_dÚe_nÙify_â
è(
	tsc¡_ev’t
 *
	tev’t
,

56 *
	t´iv
, 
	t¡©us
);

58 
	ssc¡_ev’t_’Œy
 {

59 
li¡_h—d
 
ev’ts_li¡_’Œy
;

60 
sc¡_ev’t_dÚe_nÙify_â
 
ev’t_nÙify_â
;

61 *
nÙify_â_´iv
;

62 
ev’t_timeout
;

63 *
pqueued_ev’ts_út
;

65 
wÜk_¡ruù
 
sc¡_ev’t_queue_wÜk
;

66 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 20)

67 
wÜk_¡ruù
 
ev’t_timeout_wÜk
;

69 
d–ayed_wÜk
 
ev’t_timeout_wÜk
;

73 
sc¡_ev’t
 
ev’t
;

78 
	ssc¡_ev’t_u£r
 {

79 
št32_t
 
max_ev’t_size
;

80 
sc¡_ev’t
 
out_ev’t
;

83 
	ssc¡_ev’t_nÙify_dÚe
 {

84 
ušt32_t
 
ev’t_id
;

85 
¡©us
;

89 
	#SCST_EVENT_ALLOW_EVENT
 
	`_IOW
('u', 1, 
sc¡_ev’t
)

	)

90 
	#SCST_EVENT_DISALLOW_EVENT
 
	`_IOW
('u', 2, 
sc¡_ev’t
)

	)

91 
	#SCST_EVENT_GET_NEXT_EVENT
 
	`_IOWR
('u', 3, 
sc¡_ev’t_u£r
)

	)

92 
	#SCST_EVENT_NOTIFY_DONE
 
	`_IOW
('u', 4, 
sc¡_ev’t_nÙify_dÚe
)

	)

94 #ifdeà
__KERNEL__


95 
	`sc¡_ev’t_queue
(
ušt32_t
 
ev’t_code
, cÚ¡ *
issu”_Çme
,

96 
sc¡_ev’t_’Œy
 *
e
);

104 
	#SCST_EVENT_SCST_CORE_ISSUER
 "SCST cÜe"

	)

108 
	#SCST_EVENT_LUN_NOT_FOUND
 1

	)

109 
	ssc¡_ev’t_lun_nÙ_found_·ylßd
 {

110 
®igÃd_u64
 
lun
;

111 
ušt8_t
 
š™ŸtÜ_Çme
[
SCST_MAX_EXTERNAL_NAME
];

112 
ušt8_t
 
rg‘_Çme
[
SCST_MAX_EXTERNAL_NAME
];

115 
	#SCST_EVENT_NEGATIVE_LUNS_INQUIRY
 2

	)

116 
	ssc¡_ev’t_Ãg©ive_luns_šquœy_·ylßd
 {

117 
ušt8_t
 
š™ŸtÜ_Çme
[
SCST_MAX_EXTERNAL_NAME
];

118 
ušt8_t
 
rg‘_Çme
[
SCST_MAX_EXTERNAL_NAME
];

121 
	#SCST_EVENT_EXT_BLOCKING_DONE
 3

	)

122 
	ssc¡_ev’t_ext_blockšg_dÚe_·ylßd
 {

123 
ušt8_t
 
deviû_Çme
[
SCST_MAX_EXTERNAL_NAME
];

124 
ušt32_t
 
d©a_Ën
;

125 
ušt8_t
 
d©a
[];

128 
	#SCST_EVENT_TM_FN_RECEIVED
 4

	)

129 
	ssc¡_ev’t_tm_â_»ûived_·ylßd
 {

130 
ušt32_t
 
â
;

131 
®igÃd_u64
 
lun
;

132 
ušt8_t
 
deviû_Çme
[
SCST_MAX_EXTERNAL_NAME
];

133 
ušt8_t
 
š™ŸtÜ_Çme
[
SCST_MAX_EXTERNAL_NAME
];

134 
ušt8_t
 
rg‘_Çme
[
SCST_MAX_EXTERNAL_NAME
];

135 
ušt8_t
 
£ssiÚ_sysfs_Çme
[
SCST_MAX_EXTERNAL_NAME
];

137 
®igÃd_u64
 
cmd_to_abÜt_g
;

138 
ušt8_t
 
cdb
[
SCST_MAX_CDB_SIZE
];

142 
	#SCST_EVENT_STPG_USER_INVOKE
 5

	)

143 
	ssc¡_ev’t_¡pg_desü
 {

144 
ušt16_t
 
group_id
;

149 
ušt8_t
 
´ev_¡©e
[32];

150 
ušt8_t
 
Ãw_¡©e
[32];

151 
ušt8_t
 
dg_Çme
[64];

152 
ušt8_t
 
tg_Çme
[64];

154 
	ssc¡_ev’t_¡pg_·ylßd
 {

155 
®igÃd_u64
 
¡pg_cmd_g
;

156 
ušt8_t
 
deviû_Çme
[64];

157 
ušt16_t
 
¡pg_desütÜs_út
;

158 
sc¡_ev’t_¡pg_desü
 
¡pg_desütÜs
[0];

	@scst/include/scst_itf_ver.h

3 
	#SCST_INTF_VER
 "85ba1a7a31c39f4c1cb8b492cc7794f7f79156df"

	)

4 
	#SCST_CONST_INTF_VER
 "5522fdd24545344fÿ2ç11c64e2—a15ecb2c17"

	)

5 
	#DEV_USER_INTF_VER
 "48325û6b0075b0ç4f25cbdab2962a80b7f6487"

	)

	@scst/include/scst_sgv.h

19 #iâdeà
__SCST_SGV_H


20 
	#__SCST_SGV_H


	)

25 
	#SGV_POOL_ALLOC_NO_CACHED
 1

	)

28 
	#SGV_POOL_NO_ALLOC_ON_CACHE_MISS
 2

	)

31 
	#SGV_POOL_RETURN_OBJ_ON_ALLOC_FAIL
 4

	)

37 
	#SGV_POOL_ALLOC_GET_NEW
 8

	)

39 
	gsgv_poÞ_obj
;

40 
	gsgv_poÞ
;

45 
	ssc¡_mem_lim
 {

47 
©omic_t
 
	m®loûd_·ges
;

53 
	mmax_®lowed_·ges
;

57 
	esgv_þu¡”šg_ty³s
 {

59 
	msgv_no_þu¡”šg
 = 0,

65 
	msgv_ž_þu¡”šg
,

71 
	msgv_fuÎ_þu¡”šg
,

74 
sgv_poÞ
 *
sgv_poÞ_ü—‹
(cÚ¡ *
Çme
,

75 
sgv_þu¡”šg_ty³s
 
þu¡”ed
, 
sšgË_®loc_·ges
,

76 
boÞ
 
sh¬ed
, 
purge_š‹rv®
);

77 
sgv_poÞ_d–
(
sgv_poÞ
 *
poÞ
);

79 
sgv_poÞ_g‘
(
sgv_poÞ
 *
poÞ
);

80 
sgv_poÞ_put
(
sgv_poÞ
 *
poÞ
);

82 
sgv_poÞ_æush
(
sgv_poÞ
 *
poÞ
);

84 
sgv_poÞ_£t_®loÿtÜ
(
sgv_poÞ
 *
poÞ
,

85 
·ge
 *(*
®loc_·ges_â
)(
sÿ‰”li¡
 *, 
gå_t
, *),

86 (*
ä“_·ges_â
)(
sÿ‰”li¡
 *, , *));

88 
sÿ‰”li¡
 *
	`sgv_poÞ_®loc
(
sgv_poÞ
 *
poÞ
, 
size
,

89 
gå_t
 
gå_mask
, 
æags
, *
couÁ
,

90 
sgv_poÞ_obj
 **
sgv
, 
sc¡_mem_lim
 *
mem_lim
, *
´iv
);

91 
	`sgv_poÞ_ä“
(
sgv_poÞ_obj
 *
sgv
, 
sc¡_mem_lim
 *
mem_lim
);

93 *
	`sgv_g‘_´iv
(
sgv_poÞ_obj
 *
sgv
);

95 
	`sc¡_š™_mem_lim
(
sc¡_mem_lim
 *
mem_lim
);

	@scst/include/scst_user.h

22 #iâdeà
__SCST_USER_H


23 
	#__SCST_USER_H


	)

25 #ifdeà
INSIDE_KERNEL_TREE


26 
	~<sc¡/sc¡_cÚ¡.h
>

28 
	~<sc¡_cÚ¡.h
>

31 
	#DEV_USER_NAME
 "sc¡_u£r"

	)

32 
	#DEV_USER_PATH
 "/dev/"

	)

33 
	#DEV_USER_VERSION_NAME
 
SCST_VERSION_NAME


	)

34 
	#DEV_USER_VERSION
 \

35 
DEV_USER_VERSION_NAME
 
DEV_USER_INTF_VER
 
SCST_CONST_VERSION


	)

37 
	#SCST_USER_PARSE_STANDARD
 0

	)

38 
	#SCST_USER_PARSE_CALL
 1

	)

39 
	#SCST_USER_PARSE_EXCEPTION
 2

	)

40 
	#SCST_USER_MAX_PARSE_OPT
 
SCST_USER_PARSE_EXCEPTION


	)

42 
	#SCST_USER_ON_FREE_CMD_CALL
 0

	)

43 
	#SCST_USER_ON_FREE_CMD_IGNORE
 1

	)

44 
	#SCST_USER_MAX_ON_FREE_CMD_OPT
 
SCST_USER_ON_FREE_CMD_IGNORE


	)

46 
	#SCST_USER_MEM_NO_REUSE
 0

	)

47 
	#SCST_USER_MEM_REUSE_READ
 1

	)

48 
	#SCST_USER_MEM_REUSE_WRITE
 2

	)

49 
	#SCST_USER_MEM_REUSE_ALL
 3

	)

50 
	#SCST_USER_MAX_MEM_REUSE_OPT
 
SCST_USER_MEM_REUSE_ALL


	)

52 
	#SCST_USER_PARTIAL_TRANSFERS_NOT_SUPPORTED
 0

	)

53 
	#SCST_USER_PARTIAL_TRANSFERS_SUPPORTED_ORDERED
 1

	)

54 
	#SCST_USER_PARTIAL_TRANSFERS_SUPPORTED
 2

	)

55 
	#SCST_USER_MAX_PARTIAL_TRANSFERS_OPT
 \

56 
SCST_USER_PARTIAL_TRANSFERS_SUPPORTED


	)

58 #iâdeà
__KERNEL__


59 
	#®igÃd_u64
 
ušt64_t
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

62 #iâdeà
®igÃd_i64


63 
	#®igÃd_i64
 
št64_t
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

69 
	#UCMD_STATE_NEW
 0

	)

70 
	#UCMD_STATE_PARSING
 1

	)

71 
	#UCMD_STATE_BUF_ALLOCING
 2

	)

72 
	#UCMD_STATE_EXECING
 3

	)

73 
	#UCMD_STATE_ON_FREEING
 4

	)

74 
	#UCMD_STATE_ON_CACHE_FREEING
 5

	)

75 
	#UCMD_STATE_EXT_COPY_REMAPPING
 6

	)

76 
	#UCMD_STATE_ON_FREE_SKIPPED
 7

	)

77 
	#UCMD_STATE_TM_RECEIVED_EXECING
 8

	)

78 
	#UCMD_STATE_TM_DONE_EXECING
 9

	)

80 
	#UCMD_STATE_ATTACH_SESS
 0x20

	)

81 
	#UCMD_STATE_DETACH_SESS
 0x21

	)

83 
	ssc¡_u£r_Ýt
 {

84 
ušt8_t
 
	m·r£_ty³
;

85 
ušt8_t
 
	mÚ_ä“_cmd_ty³
;

86 
ušt8_t
 
	mmemÜy_»u£_ty³
;

87 
ušt8_t
 
	m·¹Ÿl_Œªsãrs_ty³
;

88 
št32_t
 
	m·¹Ÿl_Ën
;

91 
ušt8_t
 
	mt¡
;

92 
ušt8_t
 
	mtmf_Úly
;

93 
ušt8_t
 
	mqueue_®g
;

94 
ušt8_t
 
	mq”r
;

95 
ušt8_t
 
	ms
;

96 
ušt8_t
 
	mswp
;

97 
ušt8_t
 
	md_£n£
;

99 
ušt8_t
 
	mhas_own_Üd”_mgmt
;

101 
ušt8_t
 
	mext_cÝy_»m­_suµÜ‹d
;

104 
	ssc¡_u£r_dev_desc
 {

105 
®igÃd_u64
 
	mv”siÚ_¡r
;

106 
®igÃd_u64
 
	mliûn£_¡r
;

107 
ušt8_t
 
	mty³
;

108 
ušt8_t
 
	msgv_sh¬ed
;

109 
ušt8_t
 
	msgv_di§bË_þu¡”ed_poÞ
;

110 
št32_t
 
	msgv_sšgË_®loc_·ges
;

111 
št32_t
 
	msgv_purge_š‹rv®
;

112 
sc¡_u£r_Ýt
 
	mÝt
;

113 
ušt32_t
 
	mblock_size
;

114 
ušt8_t
 
	m’abË_´_cmds_nÙifiÿtiÚs
;

115 
	mÇme
[
SCST_MAX_NAME
];

116 
	msgv_Çme
[
SCST_MAX_NAME
];

119 
	ssc¡_u£r_£ss
 {

120 
®igÃd_u64
 
	m£ss_h
;

121 
®igÃd_u64
 
	mlun
;

122 
ušt16_t
 
	mth»ads_num
;

123 
ušt8_t
 
	mrd_Úly
;

124 
ušt16_t
 
	mscsi_Œª¥Üt_v”siÚ
;

125 
ušt16_t
 
	mphys_Œª¥Üt_v”siÚ
;

126 
	mš™ŸtÜ_Çme
[
SCST_MAX_EXTERNAL_NAME
];

127 
	mrg‘_Çme
[
SCST_MAX_EXTERNAL_NAME
];

130 
	ssc¡_u£r_scsi_cmd_·r£
 {

131 
®igÃd_u64
 
	m£ss_h
;

133 
ušt8_t
 
	mcdb
[
SCST_MAX_CDB_SIZE
];

134 
ušt16_t
 
	mcdb_Ën
;

136 
®igÃd_i64
 
	mlba
;

138 
®igÃd_i64
 
	md©a_Ën
;

139 
št32_t
 
	mbufæ’
;

140 
št32_t
 
	mout_bufæ’
;

141 
št32_t
 
	mtimeout
;

143 
ušt32_t
 
	mÝ_æags
;

145 
ušt8_t
 
	mqueue_ty³
;

146 
ušt8_t
 
	md©a_dœeùiÚ
;

148 
ušt8_t
 
	mex³ùed_v®ues_£t
;

149 
ušt8_t
 
	mex³ùed_d©a_dœeùiÚ
;

150 
št32_t
 
	mex³ùed_Œªsãr_Ën
;

151 
št32_t
 
	mex³ùed_out_Œªsãr_Ën
;

153 
ušt32_t
 
	m¢
;

156 
	ssc¡_u£r_scsi_cmd_®loc_mem
 {

157 
®igÃd_u64
 
	m£ss_h
;

159 
ušt8_t
 
	mcdb
[
SCST_MAX_CDB_SIZE
];

160 
ušt16_t
 
	mcdb_Ën
;

162 
št32_t
 
	m®loc_Ën
;

164 
ušt8_t
 
	mqueue_ty³
;

165 
ušt8_t
 
	md©a_dœeùiÚ
;

167 
ušt32_t
 
	m¢
;

170 
	ssc¡_u£r_scsi_cmd_exec
 {

171 
®igÃd_u64
 
	m£ss_h
;

173 
ušt8_t
 
	mcdb
[
SCST_MAX_CDB_SIZE
];

174 
ušt16_t
 
	mcdb_Ën
;

176 
®igÃd_i64
 
	mlba
;

178 
®igÃd_i64
 
	md©a_Ën
;

179 
št32_t
 
	mbufæ’
;

180 
št32_t
 
	m®loc_Ën
;

181 
®igÃd_u64
 
	mpbuf
;

182 
ušt8_t
 
	mqueue_ty³
;

183 
ušt8_t
 
	md©a_dœeùiÚ
;

184 
ušt8_t
 
	m·¹Ÿl
;

185 
št32_t
 
	mtimeout
;

187 
®igÃd_u64
 
	mp_out_buf
;

188 
št32_t
 
	mout_bufæ’
;

190 
ušt32_t
 
	m¢
;

192 
ušt32_t
 
	m·»Á_cmd_h
;

193 
št32_t
 
	m·»Á_cmd_d©a_Ën
;

194 
ušt32_t
 
	m·¹Ÿl_off£t
;

197 
	ssc¡_u£r_scsi_Ú_ä“_cmd
 {

198 
®igÃd_u64
 
	mpbuf
;

199 
št32_t
 
	m»¥_d©a_Ën
;

200 
ušt8_t
 
	mbufãr_ÿched
;

201 
ušt8_t
 
	mabÜ‹d
;

202 
ušt8_t
 
	m¡©us
;

203 
ušt8_t
 
	md–iv”y_¡©us
;

206 
	ssc¡_u£r_Ú_ÿched_mem_ä“
 {

207 
®igÃd_u64
 
	mpbuf
;

210 
	ssc¡_u£r_tm
 {

211 
®igÃd_u64
 
	m£ss_h
;

212 
ušt32_t
 
	mâ
;

213 
ušt32_t
 
	mcmd_h_to_abÜt
;

214 
ušt32_t
 
	mcmd_¢
;

215 
ušt8_t
 
	mcmd_¢_£t
;

218 
	ssc¡_u£r_ext_cÝy_d©a_desü
 {

219 
®igÃd_u64
 
	m¤c_lba
;

220 
®igÃd_u64
 
	md¡_lba
;

221 
št32_t
 
	md©a_Ën
;

224 
	ssc¡_u£r_ext_cÝy_»m­
 {

225 
®igÃd_u64
 
	m£ss_h
;

226 
®igÃd_u64
 
	m¤c_£ss_h
;

227 
®igÃd_u64
 
	md¡_£ss_h
;

228 
sc¡_u£r_ext_cÝy_d©a_desü
 
	md©a_desü
;

231 
	ssc¡_u£r_g‘_cmd
 {

232 
ušt32_t
 
	mcmd_h
;

233 
ušt32_t
 
	msubcode
;

235 
®igÃd_u64
 
	m´•ly
;

236 
sc¡_u£r_£ss
 
	m£ss
;

237 
sc¡_u£r_scsi_cmd_·r£
 
	m·r£_cmd
;

238 
sc¡_u£r_scsi_cmd_®loc_mem
 
	m®loc_cmd
;

239 
sc¡_u£r_scsi_cmd_exec
 
	mexec_cmd
;

240 
sc¡_u£r_scsi_Ú_ä“_cmd
 
	mÚ_ä“_cmd
;

241 
sc¡_u£r_Ú_ÿched_mem_ä“
 
	mÚ_ÿched_mem_ä“
;

242 
sc¡_u£r_tm
 
	mtm_cmd
;

243 
sc¡_u£r_ext_cÝy_»m­
 
	m»m­_cmd
;

248 
	ssc¡_u£r_scsi_cmd_»¶y_·r£
 {

249 
ušt8_t
 
	m¡©us
;

252 
ušt8_t
 
	mqueue_ty³
;

253 
ušt8_t
 
	md©a_dœeùiÚ
;

254 
ušt16_t
 
	mcdb_Ën
;

255 
®igÃd_i64
 
	mlba
;

256 
®igÃd_i64
 
	md©a_Ën
;

257 
št32_t
 
	mbufæ’
;

258 
ušt32_t
 
	mÝ_æags
;

259 
št32_t
 
	mout_bufæ’
;

262 
ušt8_t
 
	m£n£_Ën
;

263 
®igÃd_u64
 
	mp£n£_bufãr
;

269 
	ssc¡_u£r_scsi_cmd_»¶y_®loc_mem
 {

270 
®igÃd_u64
 
	mpbuf
;

277 
	ssc¡_u£r_d©a_desütÜ
 {

278 
®igÃd_u64
 
	musdd_lba
;

279 
®igÃd_u64
 
	musdd_blocks
;

283 
	ssc¡_u£r_scsi_cmd_»¶y_exec
 {

284 
št32_t
 
	m»¥_d©a_Ën
;

285 
®igÃd_u64
 
	mpbuf
;

287 
	#SCST_EXEC_REPLY_BACKGROUND
 0

	)

288 
	#SCST_EXEC_REPLY_COMPLETED
 1

	)

289 
	#SCST_EXEC_REPLY_DO_WRITE_SAME
 2

	)

290 
ušt8_t
 
	m»¶y_ty³
;

292 
ušt8_t
 
	m¡©us
;

295 
ušt8_t
 
	m£n£_Ën
;

296 
®igÃd_u64
 
	mp£n£_bufãr
;

299 
ušt16_t
 
	mws_desütÜs_Ën
;

300 
®igÃd_u64
 
	mws_desütÜs
;

306 
	ssc¡_u£r_ext_cÝy_»¶y_»m­
 {

307 
®igÃd_u64
 
	m»m­_desütÜs
;

308 
ušt16_t
 
	m»m­_desütÜs_Ën
;

309 
ušt8_t
 
	m¡©us
;

310 
ušt8_t
 
	m£n£_Ën
;

311 
®igÃd_u64
 
	mp£n£_bufãr
;

315 
	ssc¡_u£r_»¶y_cmd
 {

316 
ušt32_t
 
	mcmd_h
;

317 
ušt32_t
 
	msubcode
;

319 
št32_t
 
	m»suÉ
;

320 
sc¡_u£r_scsi_cmd_»¶y_·r£
 
	m·r£_»¶y
;

321 
sc¡_u£r_scsi_cmd_»¶y_®loc_mem
 
	m®loc_»¶y
;

322 
sc¡_u£r_scsi_cmd_»¶y_exec
 
	mexec_»¶y
;

323 
sc¡_u£r_ext_cÝy_»¶y_»m­
 
	m»m­_»¶y
;

328 
	ssc¡_u£r_g‘_ext_cdb
 {

329 
ušt32_t
 
	mcmd_h
;

330 
®igÃd_u64
 
	mext_cdb_bufãr
;

334 
	ssc¡_u£r_´—Îoc_bufãr_š
 {

335 
®igÃd_u64
 
	mpbuf
;

336 
ušt32_t
 
	mbufæ’
;

337 
ušt8_t
 
	mfÜ_þu¡_poÞ
;

341 
	ssc¡_u£r_´—Îoc_bufãr_out
 {

342 
ušt32_t
 
	mcmd_h
;

346 
	usc¡_u£r_´—Îoc_bufãr
 {

347 
sc¡_u£r_´—Îoc_bufãr_š
 
	mš
;

348 
sc¡_u£r_´—Îoc_bufãr_out
 
	mout
;

351 
	ssc¡_u£r_g‘_muÉi
 {

352 
®igÃd_u64
 
	m´•l›s
;

353 
št16_t
 
	m»¶›s_út
;

354 
št16_t
 
	m»¶›s_dÚe
;

355 
št16_t
 
	mcmds_út
;

356 
št16_t
 
	m·d
;

357 
sc¡_u£r_g‘_cmd
 
	mcmds
[0];

360 
	#SCST_USER_REGISTER_DEVICE
 
	`_IOW
('u', 1, 
sc¡_u£r_dev_desc
)

	)

361 
	#SCST_USER_UNREGISTER_DEVICE
 
	`_IO
('u', 2)

	)

362 
	#SCST_USER_SET_OPTIONS
 
	`_IOW
('u', 3, 
sc¡_u£r_Ýt
)

	)

363 
	#SCST_USER_GET_OPTIONS
 
	`_IOR
('u', 4, 
sc¡_u£r_Ýt
)

	)

364 
	#SCST_USER_REPLY_AND_GET_CMD
 
	`_IOWR
('u', 5, 
sc¡_u£r_g‘_cmd
)

	)

365 
	#SCST_USER_REPLY_CMD
 
	`_IOW
('u', 6, 
sc¡_u£r_»¶y_cmd
)

	)

366 
	#SCST_USER_FLUSH_CACHE
 
	`_IO
('u', 7)

	)

367 
	#SCST_USER_DEVICE_CAPACITY_CHANGED
 
	`_IO
('u', 8)

	)

368 
	#SCST_USER_GET_EXTENDED_CDB
 
	`_IOWR
('u', 9, 
sc¡_u£r_g‘_ext_cdb
)

	)

369 
	#SCST_USER_PREALLOC_BUFFER
 
	`_IOWR
('u', 10, 
sc¡_u£r_´—Îoc_bufãr
)

	)

370 
	#SCST_USER_REPLY_AND_GET_MULTI
 
	`_IOWR
('u', 11, 
sc¡_u£r_g‘_muÉi
)

	)

373 
	#SCST_USER_ATTACH_SESS
 \

374 
	`_IOR
('s', 
UCMD_STATE_ATTACH_SESS
, 
sc¡_u£r_£ss
)

	)

375 
	#SCST_USER_DETACH_SESS
 \

376 
	`_IOR
('s', 
UCMD_STATE_DETACH_SESS
, 
sc¡_u£r_£ss
)

	)

377 
	#SCST_USER_PARSE
 \

378 
	`_IOWR
('s', 
UCMD_STATE_PARSING
, 
sc¡_u£r_scsi_cmd_·r£
)

	)

379 
	#SCST_USER_ALLOC_MEM
 \

380 
	`_IOWR
('s', 
UCMD_STATE_BUF_ALLOCING
, 
sc¡_u£r_scsi_cmd_®loc_mem
)

	)

381 
	#SCST_USER_EXEC
 \

382 
	`_IOWR
('s', 
UCMD_STATE_EXECING
, 
sc¡_u£r_scsi_cmd_exec
)

	)

383 
	#SCST_USER_ON_FREE_CMD
 \

384 
	`_IOR
('s', 
UCMD_STATE_ON_FREEING
, 
sc¡_u£r_scsi_Ú_ä“_cmd
)

	)

385 
	#SCST_USER_ON_CACHED_MEM_FREE
 \

386 
	`_IOR
('s', 
UCMD_STATE_ON_CACHE_FREEING
, \

387 
sc¡_u£r_Ú_ÿched_mem_ä“
)

	)

388 
	#SCST_USER_TASK_MGMT_RECEIVED
 \

389 
	`_IOWR
('s', 
UCMD_STATE_TM_RECEIVED_EXECING
, 
sc¡_u£r_tm
)

	)

390 
	#SCST_USER_TASK_MGMT_DONE
 \

391 
	`_IOWR
('s', 
UCMD_STATE_TM_DONE_EXECING
, 
sc¡_u£r_tm
)

	)

392 
	#SCST_USER_EXT_COPY_REMAP
 \

393 
	`_IOWR
('s', 
UCMD_STATE_EXT_COPY_REMAPPING
, 
sc¡_u£r_ext_cÝy_»m­
)

	)

	@scst/src/dev_handlers/scst_cdrom.c

21 
	~<lšux/cdrom.h
>

22 
	~<scsi/scsi_ho¡.h
>

23 
	~<lšux/¦ab.h
>

24 
	~<asm/uÇligÃd.h
>

26 
	#LOG_PREFIX
 "dev_cdrom"

	)

28 #ifdeà
INSIDE_KERNEL_TREE


29 
	~<sc¡/sc¡.h
>

31 
	~"sc¡.h
"

33 
	~"sc¡_dev_hªdËr.h
"

35 
	#CDROM_NAME
 "dev_cdrom"

	)

37 
	#CDROM_DEF_BLOCK_SHIFT
 11

	)

39 
cdrom_©ch
(
sc¡_deviû
 *);

40 
cdrom_d‘ach
(
sc¡_deviû
 *);

41 
cdrom_·r£
(
sc¡_cmd
 *);

42 
cdrom_dÚe
(
sc¡_cmd
 *);

44 
sc¡_dev_ty³
 
	gcdrom_devty³
 = {

45 .
Çme
 = 
CDROM_NAME
,

46 .
	gty³
 = 
TYPE_ROM
,

47 .
	gth»ads_num
 = 1,

48 .
	g·r£_©omic
 = 1,

49 .
	gdev_dÚe_©omic
 = 1,

50 .
	g©ch
 = 
cdrom_©ch
,

51 .
	gd‘ach
 = 
cdrom_d‘ach
,

52 .
	g·r£
 = 
cdrom_·r£
,

53 .
	gdev_dÚe
 = 
cdrom_dÚe
,

54 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

55 .
	gdeçuÉ_Œaû_æags
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
,

56 .
	gŒaû_æags
 = &
Œaû_æag
,

60 
	$cdrom_©ch
(
sc¡_deviû
 *
dev
)

62 
»s
, 
rc
;

63 
ušt8_t
 
cmd
[10];

64 cÚ¡ 
bufãr_size
 = 512;

65 
ušt8_t
 *
bufãr
 = 
NULL
;

66 
»Œ›s
;

67 
£n£_bufãr
[
SCSI_SENSE_BUFFERSIZE
];

68 
dma_d©a_dœeùiÚ
 
d©a_dœ
;

70 
	`TRACE_ENTRY
();

72 ià(
dev
->
scsi_dev
 =ð
NULL
 ||

73 
dev
->
scsi_dev
->
ty³
 != dev->type) {

74 
	`PRINT_ERROR
("%s", "SCSI device‚ot define or illegalype");

75 
»s
 = -
ENODEV
;

76 
out
;

79 
bufãr
 = 
	`km®loc
(
bufãr_size
, 
GFP_KERNEL
);

80 ià(!
bufãr
) {

81 
	`PRINT_ERROR
("Buffer memory‡llocation (size %d) failure",

82 
bufãr_size
);

83 
»s
 = -
ENOMEM
;

84 
out
;

88 
	`mem£t
(
cmd
, 0, (cmd));

89 
cmd
[0] = 
READ_CAPACITY
;

90 
cmd
[1] = (
dev
->
scsi_dev
->
scsi_Ëv–
 <ð
SCSI_2
) ?

91 ((
dev
->
scsi_dev
->
lun
 << 5) & 0xe0) : 0;

92 
»Œ›s
 = 
SCST_DEV_RETRIES_ON_UA
;

94 
	`mem£t
(
bufãr
, 0, 
bufãr_size
);

95 
	`mem£t
(
£n£_bufãr
, 0, (sense_buffer));

96 
d©a_dœ
 = 
SCST_DATA_READ
;

98 
	`TRACE_DBG
("%s", "Doing READ_CAPACITY");

99 
rc
 = 
	`scsi_execu‹
(
dev
->
scsi_dev
, 
cmd
, 
d©a_dœ
, 
bufãr
,

100 
bufãr_size
, 
£n£_bufãr
,

101 
SCST_GENERIC_CDROM_REG_TIMEOUT
, 3, 0

102 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2,6,29)

103 , 
NULL


107 
	`TRACE_DBG
("READ_CAPACITY dÚe: %x", 
rc
);

109 ià((
rc
 == 0) ||

110 !
	`sc¡_ª®yze_£n£
(
£n£_bufãr
,

111 (
£n£_bufãr
), 
SCST_SENSE_KEY_VALID
,

112 
UNIT_ATTENTION
, 0, 0))

115 ià(!--
»Œ›s
) {

116 
	`PRINT_ERROR
("UA‚ot cleared‡fter %d„etries",

117 
SCST_DEV_RETRIES_ON_UA
);

118 
dev
->
block_shiá
 = 
CDROM_DEF_BLOCK_SHIFT
;

119 
»s
 = -
ENODEV
;

120 
out_ä“_buf
;

124 ià(
rc
 == 0) {

125 
ušt32_t
 
£ùÜ_size
 = 
	`g‘_uÇligÃd_be32
(&
bufãr
[4]);

127 ià(
£ùÜ_size
 == 0)

128 
dev
->
block_shiá
 = 
CDROM_DEF_BLOCK_SHIFT
;

130 
dev
->
block_shiá
 = 
	`sc¡_ÿlc_block_shiá
(
£ùÜ_size
);

131 
	`TRACE_DBG
("Sector size is %i scsi_level %d(SCSI_2 %d)",

132 
£ùÜ_size
, 
dev
->
scsi_dev
->
scsi_Ëv–
, 
SCSI_2
);

133 ià(
dev
->
block_shiá
 < 9) {

134 
	`PRINT_ERROR
("READ CAPACITY„eported‡n invalid sector size: %d",

135 
£ùÜ_size
);

136 
»s
 = -
EINVAL
;

137 
out_ä“_buf
;

140 
dev
->
block_shiá
 = 
CDROM_DEF_BLOCK_SHIFT
;

141 
	`TRACE
(
TRACE_MINOR
, "Read capacity failed: %x, using default "

142 "£ùÜ siz%d", 
rc
, 
dev
->
block_shiá
);

143 
	`PRINT_BUFF_FLAG
(
TRACE_MINOR
, "R‘uºed s’£", 
£n£_bufãr
,

144 (
£n£_bufãr
));

146 
dev
->
block_size
 = 1 << dev->
block_shiá
;

148 
»s
 = 
	`sc¡_obš_deviû_·¿m‘”s
(
dev
, 
NULL
);

149 ià(
»s
 != 0) {

150 
	`PRINT_ERROR
("Failedo obtain control…arameters for device "

151 "%s", 
dev
->
vœt_Çme
);

152 
out_ä“_buf
;

155 
out_ä“_buf
:

156 
	`kä“
(
bufãr
);

158 
out
:

159 
	`TRACE_EXIT
();

160  
»s
;

161 
	}
}

163 
	$cdrom_d‘ach
(
sc¡_deviû
 *
dev
)

167 
	}
}

169 
	$cdrom_·r£
(
sc¡_cmd
 *
cmd
)

171 
»s
 = 
SCST_CMD_STATE_DEFAULT
, 
rc
;

173 
rc
 = 
	`sc¡_cdrom_g’”ic_·r£
(
cmd
);

174 ià(
rc
 != 0) {

175 
»s
 = 
	`sc¡_g‘_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

176 
out
;

179 
cmd
->
»Œ›s
 = 
SCST_PASSTHROUGH_RETRIES
;

180 
out
:

181  
»s
;

182 
	}
}

184 
	$cdrom_£t_block_shiá
(
sc¡_cmd
 *
cmd
, 
block_shiá
)

186 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

187 
Ãw_block_shiá
;

193 
Ãw_block_shiá
 = 
block_shiá
 ? : 
CDROM_DEF_BLOCK_SHIFT
;

194 ià(
dev
->
block_shiá
 !ð
Ãw_block_shiá
) {

195 
	`PRINT_INFO
("%s: Changed block shift from %d into %d / %d",

196 
dev
->
vœt_Çme
, dev->
block_shiá
, block_shift,

197 
Ãw_block_shiá
);

198 
dev
->
block_shiá
 = 
Ãw_block_shiá
;

199 
dev
->
block_size
 = 1 << dev->
block_shiá
;

202 
	}
}

204 
	$cdrom_dÚe
(
sc¡_cmd
 *
cmd
)

206 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

208 
	`TRACE_ENTRY
();

210 
»s
 = 
	`sc¡_block_g’”ic_dev_dÚe
(
cmd
, 
cdrom_£t_block_shiá
);

212 
	`TRACE_EXIT_RES
(
»s
);

213  
»s
;

214 
	}
}

216 
__š™
 
	$cdrom_š™
()

218 
»s
 = 0;

220 
	`TRACE_ENTRY
();

222 
cdrom_devty³
.
moduË
 = 
THIS_MODULE
;

224 
»s
 = 
	`sc¡_»gi¡”_dev_driv”
(&
cdrom_devty³
);

225 ià(
»s
 < 0)

226 
out
;

228 #ifdeà
CONFIG_SCST_PROC


229 
»s
 = 
	`sc¡_dev_hªdËr_bužd_¡d_´oc
(&
cdrom_devty³
);

230 ià(
»s
 != 0)

231 
out_”r
;

234 
out
:

235 
	`TRACE_EXIT
();

236  
»s
;

238 #ifdeà
CONFIG_SCST_PROC


239 
out_”r
:

240 
	`sc¡_uÄegi¡”_dev_driv”
(&
cdrom_devty³
);

241 
out
;

243 
	}
}

245 
__ex™
 
	$cdrom_ex™
()

247 
	`TRACE_ENTRY
();

248 #ifdeà
CONFIG_SCST_PROC


249 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(&
cdrom_devty³
);

251 
	`sc¡_uÄegi¡”_dev_driv”
(&
cdrom_devty³
);

252 
	`TRACE_EXIT
();

254 
	}
}

256 
moduË_š™
(
cdrom_š™
);

257 
moduË_ex™
(
cdrom_ex™
);

259 
MODULE_LICENSE
("GPL");

260 
MODULE_AUTHOR
("Vladislav Bolkhovitin & Leonid Stoljar");

261 
MODULE_DESCRIPTION
("SCSI CDROM (type 5) dev handler for SCST");

262 
MODULE_VERSION
(
SCST_VERSION_STRING
);

	@scst/src/dev_handlers/scst_changer.c

21 
	~<scsi/scsi_ho¡.h
>

22 
	~<lšux/¦ab.h
>

24 
	#LOG_PREFIX
 "dev_chªg”"

	)

26 #ifdeà
INSIDE_KERNEL_TREE


27 
	~<sc¡/sc¡.h
>

29 
	~"sc¡.h
"

31 
	~"sc¡_dev_hªdËr.h
"

33 
	#CHANGER_NAME
 "dev_chªg”"

	)

35 
	#CHANGER_RETRIES
 2

	)

37 
chªg”_©ch
(
sc¡_deviû
 *);

39 
chªg”_·r£
(
sc¡_cmd
 *);

42 
sc¡_dev_ty³
 
	gchªg”_devty³
 = {

43 .
Çme
 = 
CHANGER_NAME
,

44 .
	gty³
 = 
TYPE_MEDIUM_CHANGER
,

45 .
	gth»ads_num
 = 1,

46 .
	g·r£_©omic
 = 1,

48 .
	g©ch
 = 
chªg”_©ch
,

50 .
	g·r£
 = 
chªg”_·r£
,

52 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

53 .
	gdeçuÉ_Œaû_æags
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
,

54 .
	gŒaû_æags
 = &
Œaû_æag
,

58 
	$chªg”_©ch
(
sc¡_deviû
 *
dev
)

60 
»s
, 
rc
;

61 
»Œ›s
;

63 
	`TRACE_ENTRY
();

65 ià(
dev
->
scsi_dev
 =ð
NULL
 ||

66 
dev
->
scsi_dev
->
ty³
 != dev->type) {

67 
	`PRINT_ERROR
("%s", "SCSI device‚ot define or illegalype");

68 
»s
 = -
ENODEV
;

69 
out
;

76 ià(
dev
->
scsi_dev
->
sdev_¡©e
 =ð
SDEV_OFFLINE
) {

77 
	`TRACE_DBG
("%s", "Device is offline");

78 
»s
 = -
ENODEV
;

79 
out
;

82 
»Œ›s
 = 
SCST_DEV_RETRIES_ON_UA
;

84 
	`TRACE_DBG
("%s", "Doing TEST_UNIT_READY");

85 
rc
 = 
	`scsi_‹¡_un™_»ady
(
dev
->
scsi_dev
,

86 
SCST_GENERIC_CHANGER_TIMEOUT
, 
CHANGER_RETRIES


87 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 25)

90 , 
NULL
);

92 
	`TRACE_DBG
("TEST_UNIT_READY dÚe: %x", 
rc
);

93 } (--
»Œ›s
 > 0è&& 
rc
);

95 ià(
rc
) {

96 
	`PRINT_WARNING
("Un™‚Ù„—dy: %x", 
rc
);

100 
»s
 = 
	`sc¡_obš_deviû_·¿m‘”s
(
dev
, 
NULL
);

101 ià(
»s
 != 0) {

102 
	`PRINT_ERROR
("Failedo obtain control…arameters for device "

103 "%s", 
dev
->
vœt_Çme
);

104 
out
;

107 
out
:

108 
	`TRACE_EXIT_HRES
(
»s
);

109  
»s
;

110 
	}
}

113 
	$chªg”_d‘ach
(
sc¡_deviû
 *
dev
)

115 
	`TRACE_ENTRY
();

117 
	`TRACE_EXIT
();

119 
	}
}

122 
	$chªg”_·r£
(
sc¡_cmd
 *
cmd
)

124 
»s
 = 
SCST_CMD_STATE_DEFAULT
, 
rc
;

126 
rc
 = 
	`sc¡_chªg”_g’”ic_·r£
(
cmd
);

127 ià(
rc
 != 0) {

128 
»s
 = 
	`sc¡_g‘_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

129 
out
;

132 
cmd
->
»Œ›s
 = 
SCST_PASSTHROUGH_RETRIES
;

133 
out
:

134  
»s
;

135 
	}
}

138 
	$chªg”_dÚe
(
sc¡_cmd
 *
cmd
)

140 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

142 
	`TRACE_ENTRY
();

151 
cmd
->
cdb
[0]) {

158 
	`TRACE_EXIT
();

159  
»s
;

160 
	}
}

163 
__š™
 
	$chªg”_š™
()

165 
»s
 = 0;

167 
	`TRACE_ENTRY
();

169 
chªg”_devty³
.
moduË
 = 
THIS_MODULE
;

171 
»s
 = 
	`sc¡_»gi¡”_dev_driv”
(&
chªg”_devty³
);

172 ià(
»s
 < 0)

173 
out
;

175 #ifdeà
CONFIG_SCST_PROC


176 
»s
 = 
	`sc¡_dev_hªdËr_bužd_¡d_´oc
(&
chªg”_devty³
);

177 ià(
»s
 != 0)

178 
out_”r
;

181 
out
:

182 
	`TRACE_EXIT_RES
(
»s
);

183  
»s
;

184 #ifdeà
CONFIG_SCST_PROC


185 
out_”r
:

186 
	`sc¡_uÄegi¡”_dev_driv”
(&
chªg”_devty³
);

187 
out
;

189 
	}
}

191 
__ex™
 
	$chªg”_ex™
()

193 
	`TRACE_ENTRY
();

194 #ifdeà
CONFIG_SCST_PROC


195 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(&
chªg”_devty³
);

197 
	`sc¡_uÄegi¡”_dev_driv”
(&
chªg”_devty³
);

198 
	`TRACE_EXIT
();

200 
	}
}

202 
moduË_š™
(
chªg”_š™
);

203 
moduË_ex™
(
chªg”_ex™
);

205 
MODULE_AUTHOR
("Vladislav Bolkhovitin & Leonid Stoljar");

206 
MODULE_LICENSE
("GPL");

207 
MODULE_DESCRIPTION
("SCSI medium changer (type 8) dev handler for SCST");

208 
MODULE_VERSION
(
SCST_VERSION_STRING
);

	@scst/src/dev_handlers/scst_dev_handler.h

1 #iâdeà
__SCST_DEV_HANDLER_H


2 
	#__SCST_DEV_HANDLER_H


	)

4 
	~<lšux/moduË.h
>

5 
	~<scsi/scsi_eh.h
>

6 #ifdeà
INSIDE_KERNEL_TREE


7 
	~<sc¡/sc¡_debug.h
>

9 
	~"sc¡_debug.h
"

12 
	#SCST_DEV_RETRIES_ON_UA
 5

	)

13 
	#SCST_PASSTHROUGH_RETRIES
 0

	)

15 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

17 #ifdeà
CONFIG_SCST_DEBUG


18 
	#SCST_DEFAULT_DEV_LOG_FLAGS
 (
TRACE_OUT_OF_MEM
 | 
TRACE_PID
 | \

19 
TRACE_LINE
 | 
TRACE_FUNCTION
 | 
TRACE_MGMT
 | 
TRACE_MINOR
 | \

20 
TRACE_MGMT_DEBUG
 | 
TRACE_SPECIAL
)

	)

22 
	#SCST_DEFAULT_DEV_LOG_FLAGS
 (
TRACE_OUT_OF_MEM
 | 
TRACE_MGMT
 | 
TRACE_PID
 | \

23 
TRACE_SPECIAL
)

	)

26 
	gdh_Œaû_æag
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
;

27 
	#Œaû_æag
 
dh_Œaû_æag


	)

29 #ifdeà
CONFIG_SCST_PROC


31 
	#DEV_HANDLER_LOG_ENTRY_NAME
 "Œaû_Ëv–"

	)

33 #iâdeà
Œaû_log_tbl


34 
	#Œaû_log_tbl
 
NULL


	)

37 
sc¡_´oc_d©a
 
	gdev_hªdËr_log_´oc_d©a
;

39 
	$dev_hªdËr_log_šfo_show
(
£q_fže
 *
£q
, *
v
)

41 
»s
 = 0;

43 
	`TRACE_ENTRY
();

45 
»s
 = 
	`sc¡_´oc_log_’Œy_»ad
(
£q
, 
Œaû_æag
, 
Œaû_log_tbl
);

47 
	`TRACE_EXIT_RES
(
»s
);

48  
»s
;

49 
	}
}

51 
ssize_t
 
	$sc¡_dev_hªdËr_´oc_log_’Œy_wr™e
(
fže
 *file,

52 cÚ¡ 
__u£r
 *
buf
, 
size_t
 
Ëngth
, 
loff_t
 *
off
)

54 
»s
 = 0;

56 
	`TRACE_ENTRY
();

58 
»s
 = 
	`sc¡_´oc_log_’Œy_wr™e
(
fže
, 
buf
, 
Ëngth
, &
Œaû_æag
,

59 
SCST_DEFAULT_DEV_LOG_FLAGS
, 
Œaû_log_tbl
);

61 
	`TRACE_EXIT_RES
(
»s
);

62  
»s
;

63 
	}
}

69 #ifdeà
CONFIG_SCST_PROC


71 
	$sc¡_dev_hªdËr_bužd_¡d_´oc
(
sc¡_dev_ty³
 *
dev_ty³
)

73 
»s
 = 0;

74 #ià
	`defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

75 
´oc_dœ_’Œy
 *
p
, *
roÙ
;

77 
	`TRACE_ENTRY
();

79 
roÙ
 = 
	`sc¡_´oc_g‘_dev_ty³_roÙ
(
dev_ty³
);

80 ià(
roÙ
) {

83 cÚ¡ *
Çme
;

84 ià(
	`¡rcmp
(
dev_ty³
->
Çme
, "vdisk_fileio") == 0)

85 
Çme
 = "vdisk";

87 
Çme
 = 
dev_ty³
->name;

88 
dev_hªdËr_log_´oc_d©a
.
d©a
 = (*)
Çme
;

89 
p
 = 
	`sc¡_ü—‹_´oc_’Œy
(
roÙ
, 
DEV_HANDLER_LOG_ENTRY_NAME
,

90 &
dev_hªdËr_log_´oc_d©a
);

91 ià(
p
 =ð
NULL
) {

92 
	`PRINT_ERROR
("Notƒnough memoryo„egister dev "

94 
Çme
, 
DEV_HANDLER_LOG_ENTRY_NAME
);

95 
»s
 = -
ENOMEM
;

96 
out
;

100 
out
:

101 
	`TRACE_EXIT_RES
(
»s
);

103  
»s
;

104 
	}
}

106 
	$sc¡_dev_hªdËr_de¡roy_¡d_´oc
(
sc¡_dev_ty³
 *
dev_ty³
)

108 #ià
	`defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

109 
´oc_dœ_’Œy
 *
roÙ
;

111 
	`TRACE_ENTRY
();

113 
roÙ
 = 
	`sc¡_´oc_g‘_dev_ty³_roÙ
(
dev_ty³
);

114 ià(
roÙ
)

115 
	`»move_´oc_’Œy
(
DEV_HANDLER_LOG_ENTRY_NAME
, 
roÙ
);

117 
	`TRACE_EXIT
();

119 
	}
}

121 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

122 
sc¡_´oc_d©a
 
	gdev_hªdËr_log_´oc_d©a
 = {

123 
SCST_DEF_RW_SEQ_OP
(
sc¡_dev_hªdËr_´oc_log_’Œy_wr™e
)

124 .
show
 = 
dev_hªdËr_log_šfo_show
,

	@scst/src/dev_handlers/scst_disk.c

24 
	~<lšux/moduË.h
>

25 
	~<lšux/š™.h
>

26 
	~<lšux/blkdev.h
>

27 
	~<scsi/scsi_ho¡.h
>

28 
	~<lšux/¦ab.h
>

29 
	~<asm/uÇligÃd.h
>

31 
	#LOG_PREFIX
 "dev_disk"

	)

33 #ifdeà
INSIDE_KERNEL_TREE


34 
	~<sc¡/sc¡.h
>

36 
	~"sc¡.h
"

38 
	~"sc¡_dev_hªdËr.h
"

40 
	#DISK_NAME
 "dev_disk"

	)

41 
	#DISK_PERF_NAME
 "dev_disk_³rf"

	)

43 
	#DISK_DEF_BLOCK_SHIFT
 9

	)

45 
disk_©ch
(
sc¡_deviû
 *
dev
);

46 
disk_d‘ach
(
sc¡_deviû
 *
dev
);

47 
disk_·r£
(
sc¡_cmd
 *
cmd
);

48 
disk_³rf_exec
(
sc¡_cmd
 *
cmd
);

49 
disk_dÚe
(
sc¡_cmd
 *
cmd
);

50 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 30)

51 
disk_exec
(
sc¡_cmd
 *
cmd
);

52 
boÞ
 
disk_Ú_sg_bËsize_low
(
sc¡_cmd
 *
cmd
);

55 
sc¡_dev_ty³
 
	gdisk_devty³
 = {

56 .
Çme
 = 
DISK_NAME
,

57 .
	gty³
 = 
TYPE_DISK
,

58 .
	gth»ads_num
 = 1,

59 .
	g·r£_©omic
 = 1,

60 .
	gdev_dÚe_©omic
 = 1,

61 .
	g©ch
 = 
disk_©ch
,

62 .
	gd‘ach
 = 
disk_d‘ach
,

63 .
	g·r£
 = 
disk_·r£
,

64 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 30)

65 .
	gexec
 = 
disk_exec
,

66 .
	gÚ_sg_bËsize_low
 = 
disk_Ú_sg_bËsize_low
,

68 .
	gdev_dÚe
 = 
disk_dÚe
,

69 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

70 .
	gdeçuÉ_Œaû_æags
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
,

71 .
	gŒaû_æags
 = &
Œaû_æag
,

75 
sc¡_dev_ty³
 
	gdisk_devty³_³rf
 = {

76 .
Çme
 = 
DISK_PERF_NAME
,

77 .
	gty³
 = 
TYPE_DISK
,

78 .
	g·r£_©omic
 = 1,

79 .
	gdev_dÚe_©omic
 = 1,

80 .
	g©ch
 = 
disk_©ch
,

81 .
	gd‘ach
 = 
disk_d‘ach
,

82 .
	g·r£
 = 
disk_·r£
,

83 .
	gexec
 = 
disk_³rf_exec
,

84 .
	gdev_dÚe
 = 
disk_dÚe
,

85 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 30)

86 .
	gÚ_sg_bËsize_low
 = 
disk_Ú_sg_bËsize_low
,

88 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

89 .
	gdeçuÉ_Œaû_æags
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
,

90 .
	gŒaû_æags
 = &
Œaû_æag
,

94 
__š™
 
	$š™_sc¡_disk_driv”
()

96 
»s
 = 0;

98 
	`TRACE_ENTRY
();

100 
disk_devty³
.
moduË
 = 
THIS_MODULE
;

102 
»s
 = 
	`sc¡_»gi¡”_dev_driv”
(&
disk_devty³
);

103 ià(
»s
 < 0)

104 
out
;

106 
disk_devty³_³rf
.
moduË
 = 
THIS_MODULE
;

108 
»s
 = 
	`sc¡_»gi¡”_dev_driv”
(&
disk_devty³_³rf
);

109 ià(
»s
 < 0)

110 
out_uÄeg
;

112 #ifdeà
CONFIG_SCST_PROC


113 
»s
 = 
	`sc¡_dev_hªdËr_bužd_¡d_´oc
(&
disk_devty³
);

114 ià(
»s
 != 0)

115 
out_uÄeg1
;

117 
»s
 = 
	`sc¡_dev_hªdËr_bužd_¡d_´oc
(&
disk_devty³_³rf
);

118 ià(
»s
 != 0)

119 
out_uÄeg2
;

122 
out
:

123 
	`TRACE_EXIT_RES
(
»s
);

124  
»s
;

126 #ifdeà
CONFIG_SCST_PROC


127 
out_uÄeg2
:

128 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(&
disk_devty³
);

130 
out_uÄeg1
:

131 
	`sc¡_uÄegi¡”_dev_driv”
(&
disk_devty³_³rf
);

134 
out_uÄeg
:

135 
	`sc¡_uÄegi¡”_dev_driv”
(&
disk_devty³
);

136 
out
;

137 
	}
}

139 
__ex™
 
	$ex™_sc¡_disk_driv”
()

141 
	`TRACE_ENTRY
();

143 #ifdeà
CONFIG_SCST_PROC


144 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(&
disk_devty³_³rf
);

145 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(&
disk_devty³
);

147 
	`sc¡_uÄegi¡”_dev_driv”
(&
disk_devty³_³rf
);

148 
	`sc¡_uÄegi¡”_dev_driv”
(&
disk_devty³
);

150 
	`TRACE_EXIT
();

152 
	}
}

154 
moduË_š™
(
š™_sc¡_disk_driv”
);

155 
moduË_ex™
(
ex™_sc¡_disk_driv”
);

157 
	$disk_©ch
(
sc¡_deviû
 *
dev
)

159 
»s
, 
rc
;

160 
ušt8_t
 
cmd
[10];

161 cÚ¡ 
bufãr_size
 = 512;

162 
ušt8_t
 *
bufãr
 = 
NULL
;

163 
»Œ›s
;

164 
£n£_bufãr
[
SCSI_SENSE_BUFFERSIZE
];

165 
dma_d©a_dœeùiÚ
 
d©a_dœ
;

167 
	`TRACE_ENTRY
();

169 ià(
dev
->
scsi_dev
 =ð
NULL
 ||

170 
dev
->
scsi_dev
->
ty³
 != dev->type) {

171 
	`PRINT_ERROR
("%s", "SCSI device‚ot define or illegalype");

172 
»s
 = -
ENODEV
;

173 
out
;

176 
bufãr
 = 
	`km®loc
(
bufãr_size
, 
GFP_KERNEL
);

177 ià(!
bufãr
) {

178 
	`PRINT_ERROR
("Buffer memory‡llocation (size %d) failure",

179 
bufãr_size
);

180 
»s
 = -
ENOMEM
;

181 
out
;

185 
	`mem£t
(
cmd
, 0, (cmd));

186 
cmd
[0] = 
READ_CAPACITY
;

187 
cmd
[1] = (
dev
->
scsi_dev
->
scsi_Ëv–
 <ð
SCSI_2
) ?

188 ((
dev
->
scsi_dev
->
lun
 << 5) & 0xe0) : 0;

189 
»Œ›s
 = 
SCST_DEV_RETRIES_ON_UA
;

191 
	`mem£t
(
bufãr
, 0, 
bufãr_size
);

192 
	`mem£t
(
£n£_bufãr
, 0, (sense_buffer));

193 
d©a_dœ
 = 
SCST_DATA_READ
;

195 
	`TRACE_DBG
("%s", "Doing READ_CAPACITY");

196 
rc
 = 
	`scsi_execu‹
(
dev
->
scsi_dev
, 
cmd
, 
d©a_dœ
, 
bufãr
,

197 
bufãr_size
, 
£n£_bufãr
,

198 
SCST_GENERIC_DISK_REG_TIMEOUT
, 3, 0

199 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2,6,29)

200 , 
NULL


204 
	`TRACE_DBG
("READ_CAPACITY dÚe: %x", 
rc
);

206 ià((
rc
 == 0) ||

207 !
	`sc¡_ª®yze_£n£
(
£n£_bufãr
,

208 (
£n£_bufãr
), 
SCST_SENSE_KEY_VALID
,

209 
UNIT_ATTENTION
, 0, 0))

211 ià(!--
»Œ›s
) {

212 
	`PRINT_ERROR
("UA‚ot clear‡fter %d„etries",

213 
SCST_DEV_RETRIES_ON_UA
);

214 
»s
 = -
ENODEV
;

215 
out_ä“_buf
;

218 ià(
rc
 == 0) {

219 
ušt32_t
 
£ùÜ_size
 = 
	`g‘_uÇligÃd_be32
(&
bufãr
[4]);

221 ià(
£ùÜ_size
 == 0)

222 
dev
->
block_shiá
 = 
DISK_DEF_BLOCK_SHIFT
;

224 
dev
->
block_shiá
 = 
	`sc¡_ÿlc_block_shiá
(
£ùÜ_size
);

225 ià(
dev
->
block_shiá
 < 9) {

226 
	`PRINT_ERROR
("READ CAPACITY„eported‡n invalid sector size: %d",

227 
£ùÜ_size
);

228 
»s
 = -
EINVAL
;

229 
out_ä“_buf
;

232 
dev
->
block_shiá
 = 
DISK_DEF_BLOCK_SHIFT
;

233 
	`TRACE
(
TRACE_MINOR
, "Read capacity failed: %x, using default "

234 "£ùÜ siz%d", 
rc
, 
dev
->
block_shiá
);

235 
	`PRINT_BUFF_FLAG
(
TRACE_MINOR
, "R‘uºed s’£", 
£n£_bufãr
,

236 (
£n£_bufãr
));

238 
dev
->
block_size
 = 1 << dev->
block_shiá
;

240 
»s
 = 
	`sc¡_obš_deviû_·¿m‘”s
(
dev
, 
NULL
);

241 ià(
»s
 != 0) {

242 
	`PRINT_ERROR
("Failedo obtain control…arameters for device "

243 "%s", 
dev
->
vœt_Çme
);

244 
out_ä“_buf
;

247 
out_ä“_buf
:

248 
	`kä“
(
bufãr
);

250 
out
:

251 
	`TRACE_EXIT_RES
(
»s
);

252  
»s
;

253 
	}
}

255 
	$disk_d‘ach
(
sc¡_deviû
 *
dev
)

259 
	}
}

261 
	$disk_·r£
(
sc¡_cmd
 *
cmd
)

263 
»s
 = 
SCST_CMD_STATE_DEFAULT
, 
rc
;

265 
rc
 = 
	`sc¡_sbc_g’”ic_·r£
(
cmd
);

266 ià(
rc
 != 0) {

267 
»s
 = 
	`sc¡_g‘_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

268 
out
;

271 
cmd
->
»Œ›s
 = 
SCST_PASSTHROUGH_RETRIES
;

272 
out
:

273  
»s
;

274 
	}
}

276 
	$disk_£t_block_shiá
(
sc¡_cmd
 *
cmd
, 
block_shiá
)

278 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

279 
Ãw_block_shiá
;

285 
Ãw_block_shiá
 = 
block_shiá
 ? : 
DISK_DEF_BLOCK_SHIFT
;

286 ià(
dev
->
block_shiá
 !ð
Ãw_block_shiá
) {

287 
	`PRINT_INFO
("%s: Changed block shift from %d into %d / %d",

288 
dev
->
vœt_Çme
, dev->
block_shiá
, block_shift,

289 
Ãw_block_shiá
);

290 
dev
->
block_shiá
 = 
Ãw_block_shiá
;

291 
dev
->
block_size
 = 1 << dev->
block_shiá
;

294 
	}
}

296 
	$disk_dÚe
(
sc¡_cmd
 *
cmd
)

298 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

300 
	`TRACE_ENTRY
();

302 
»s
 = 
	`sc¡_block_g’”ic_dev_dÚe
(
cmd
, 
disk_£t_block_shiá
);

304 
	`TRACE_EXIT_RES
(
»s
);

305  
»s
;

306 
	}
}

308 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 30)

310 
boÞ
 
	$disk_Ú_sg_bËsize_low
(
sc¡_cmd
 *
cmd
)

312 
boÞ
 
»s
;

314 
	`TRACE_ENTRY
();

316 
cmd
->
cdb
[0]) {

317 
WRITE_6
:

318 
READ_6
:

319 
WRITE_10
:

320 
READ_10
:

321 
WRITE_VERIFY
:

322 
WRITE_12
:

323 
READ_12
:

324 
WRITE_VERIFY_12
:

325 
WRITE_16
:

326 
READ_16
:

327 
WRITE_VERIFY_16
:

328 
»s
 = 
Œue
;

330 
cmd
->
šc_ex³ùed_¢_Ú_dÚe
 = 1;

333 
»s
 = 
çl£
;

337 
	`TRACE_EXIT_RES
(
»s
);

338  
»s
;

339 
	}
}

341 
	sdisk_wÜk
 {

342 
sc¡_cmd
 *
	mcmd
;

343 
com¶‘iÚ
 
	mdisk_wÜk_cm¶
;

344 
	m»suÉ
;

345 
	mËá
;

346 
št64_t
 
	m§ve_lba
;

347 
	m§ve_Ën
;

348 
sÿ‰”li¡
 *
	m§ve_sg
;

349 
	m§ve_sg_út
;

352 
	$disk_»¡Üe_sg
(
disk_wÜk
 *
wÜk
)

354 
	`sc¡_£t_cdb_lba
(
wÜk
->
cmd
, wÜk->
§ve_lba
);

355 
	`sc¡_£t_cdb_Œªsf_Ën
(
wÜk
->
cmd
, wÜk->
§ve_Ën
);

356 
wÜk
->
cmd
->
sg
 = wÜk->
§ve_sg
;

357 
wÜk
->
cmd
->
sg_út
 = wÜk->
§ve_sg_út
;

359 
	}
}

361 
	$disk_cmd_dÚe
(*
d©a
, *
£n£
, 
»suÉ
, 
»sid
)

363 
disk_wÜk
 *
wÜk
 = 
d©a
;

365 
	`TRACE_ENTRY
();

367 
	`TRACE_DBG
("work %p, cmd %p,†eft %d,„esult %d, sense %p,„esid %d",

368 
wÜk
, wÜk->
cmd
, wÜk->
Ëá
, 
»suÉ
, 
£n£
, 
»sid
);

370 
wÜk
->
»suÉ
 =„esult;

372 ià(
»suÉ
 =ð
SAM_STAT_GOOD
)

373 
out_com¶‘e
;

375 
	`disk_»¡Üe_sg
(
wÜk
);

377 
	`sc¡_·ss_through_cmd_dÚe
(
wÜk
->
cmd
, 
£n£
, 
»suÉ
, 
»sid
 + wÜk->
Ëá
);

379 
out_com¶‘e
:

380 
	`com¶‘e_®l
(&
wÜk
->
disk_wÜk_cm¶
);

382 
	`TRACE_EXIT
();

384 
	}
}

387 
	$disk_exec
(
sc¡_cmd
 *
cmd
)

389 
»s
, 
rc
;

390 
disk_wÜk
 
wÜk
;

391 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

392 
off£t
, 
cur_Ën
;

393 
sÿ‰”li¡
 *
sg
, *
¡¬t_sg
;

394 
cur_sg_út
;

395 
sg_bËsize
 = 
cmd
->
dev
->
scsi_dev
->
ho¡
->sg_tablesize;

396 
max_£ùÜs
;

397 
num
, 
j
, 
block_shiá
 = 
dev
->block_shift;

399 
	`TRACE_ENTRY
();

405 
max_£ùÜs
 = 
	`queue_max_hw_£ùÜs
(
dev
->
scsi_dev
->
»que¡_queue
);

407 ià(
	`uÆik–y
(
max_£ùÜs
 < (
PAGE_SIZE
 >> 
block_shiá
))) {

408 
	`PRINT_ERROR
("ToØlow max seùÜs: %u << %u < %lu", 
max_£ùÜs
,

409 
block_shiá
, 
PAGE_SIZE
);

410 
out_”rÜ
;

413 ià(
	`uÆik–y
((
cmd
->
bufæ’
 >> 
block_shiá
è> 
max_£ùÜs
)) {

414 ià((
cmd
->
out_bufæ’
 >> 
block_shiá
è> 
max_£ùÜs
) {

415 
	`PRINT_ERROR
("Too†imited max_sectors %d for "

417 
max_£ùÜs
, 
cmd
, 
	`sc¡_g‘_Ýcode_Çme
(cmd),

418 
cmd
->
out_bufæ’
);

420 
»s
 = 
SCST_EXEC_NOT_COMPLETED
;

421 
out
;

423 
¥l™
;

426 ià(
cmd
->
sg_út
 <ð
sg_bËsize
) {

427 
»s
 = 
SCST_EXEC_NOT_COMPLETED
;

428 
out
;

431 
¥l™
:

432 
	`sBUG_ON
(
cmd
->
out_sg_út
 > 
sg_bËsize
);

433 
	`sBUG_ON
((
cmd
->
out_bufæ’
 >> 
block_shiá
è> 
max_£ùÜs
);

440 
	`mem£t
(&
wÜk
, 0, (work));

441 
wÜk
.
cmd
 = cmd;

442 
wÜk
.
§ve_sg
 = 
cmd
->
sg
;

443 
wÜk
.
§ve_sg_út
 = 
cmd
->
sg_út
;

444 
wÜk
.
§ve_lba
 = 
cmd
->
lba
;

445 
wÜk
.
§ve_Ën
 = 
cmd
->
bufæ’
;

447 
	`EXTRACHECKS_BUG_ON
(
wÜk
.
§ve_Ën
 < 0);

449 
cmd
->
¡©us
 = 0;

450 
cmd
->
msg_¡©us
 = 0;

451 
cmd
->
ho¡_¡©us
 = 
DID_OK
;

452 
cmd
->
driv”_¡©us
 = 0;

454 
	`TRACE_DBG
("cmd %p, save_sg %p, save_sg_cnt %d, save_lba %lld, "

456 "sizeof(*sgè0x%zx)", 
cmd
, 
wÜk
.
§ve_sg
, wÜk.
§ve_sg_út
,

457 ()
wÜk
.
§ve_lba
, wÜk.
§ve_Ën
,

458 
sg_bËsize
, 
max_£ùÜs
, 
block_shiá
, (*
sg
));

466 
num
 = 1;

467 
j
 = 0;

468 
off£t
 = 0;

469 
cur_Ën
 = 0;

470 
sg
 = 
wÜk
.
§ve_sg
;

471 
¡¬t_sg
 = 
sg
;

472 
cur_sg_út
 = 0;

474 
l
;

476 ià(
	`uÆik–y
(
	`sg_is_chaš
(&
sg
[
j
]))) {

477 
boÞ
 
»£t_¡¬t_sg
 = (
¡¬t_sg
 =ð&
sg
[
j
]);

479 
sg
 = 
	`sg_chaš_±r
(&sg[
j
]);

480 
j
 = 0;

481 ià(
»£t_¡¬t_sg
)

482 
¡¬t_sg
 = 
sg
;

485 
l
 = 
sg
[
j
].
Ëngth
 >> 
block_shiá
;

486 
cur_Ën
 +ð
l
;

487 
cur_sg_út
++;

489 
	`TRACE_DBG
("l %d, j %d,‚um %d, offset %d, cur_len %d, "

490 "cur_sg_úˆ%d, s¹_sg %p", 
l
, 
j
, 
num
, 
off£t
,

491 
cur_Ën
, 
cur_sg_út
, 
¡¬t_sg
);

493 ià(((
num
 % 
sg_bËsize
) == 0) ||

494 (
num
 =ð
wÜk
.
§ve_sg_út
) ||

495 (
cur_Ën
 >ð
max_£ùÜs
)) {

496 
	`TRACE_DBG
("%s", "Execing...");

498 
	`sc¡_£t_cdb_lba
(
wÜk
.
cmd
, wÜk.
§ve_lba
 + 
off£t
);

499 
	`sc¡_£t_cdb_Œªsf_Ën
(
wÜk
.
cmd
, 
cur_Ën
);

500 
cmd
->
sg
 = 
¡¬t_sg
;

501 
cmd
->
sg_út
 = 
cur_sg_út
;

503 
wÜk
.
Ëá
 = wÜk.
§ve_Ën
 - (
off£t
 + 
cur_Ën
);

504 
	`š™_com¶‘iÚ
(&
wÜk
.
disk_wÜk_cm¶
);

506 
rc
 = 
	`sc¡_scsi_exec_async
(
cmd
, &
wÜk
, 
disk_cmd_dÚe
);

507 ià(
	`uÆik–y
(
rc
 != 0)) {

508 
	`PRINT_ERROR
("sc¡_scsi_exec_async(èçžed: %d", 
rc
);

509 
out_”r_»¡Üe
;

512 
	`wa™_fÜ_com¶‘iÚ
(&
wÜk
.
disk_wÜk_cm¶
);

514 ià(
wÜk
.
»suÉ
 !ð
SAM_STAT_GOOD
) {

516 
»s
 = 
SCST_EXEC_COMPLETED
;

517 
out
;

520 
off£t
 +ð
cur_Ën
;

521 
cur_Ën
 = 0;

522 
cur_sg_út
 = 0;

523 
¡¬t_sg
 = &
sg
[
j
+1];

525 ià(
num
 =ð
wÜk
.
§ve_sg_út
)

528 
num
++;

529 
j
++;

532 
cmd
->
com¶‘ed
 = 1;

534 
out_»¡Üe
:

535 
	`disk_»¡Üe_sg
(&
wÜk
);

537 
out_dÚe
:

538 
»s
 = 
SCST_EXEC_COMPLETED
;

539 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

541 
out
:

542 
	`TRACE_EXIT_RES
(
»s
);

543  
»s
;

545 
out_”r_»¡Üe
:

546 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_š‹º®_çžu»
));

547 
out_»¡Üe
;

549 
out_”rÜ
:

550 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

551 
out_dÚe
;

552 
	}
}

556 
	$disk_³rf_exec
(
sc¡_cmd
 *
cmd
)

558 
»s
;

559 
Ýcode
 = 
cmd
->
cdb
[0];

561 
	`TRACE_ENTRY
();

563 
cmd
->
¡©us
 = 0;

564 
cmd
->
msg_¡©us
 = 0;

565 
cmd
->
ho¡_¡©us
 = 
DID_OK
;

566 
cmd
->
driv”_¡©us
 = 0;

568 
Ýcode
) {

569 
WRITE_6
:

570 
WRITE_10
:

571 
WRITE_12
:

572 
WRITE_16
:

573 
READ_6
:

574 
READ_10
:

575 
READ_12
:

576 
READ_16
:

577 
WRITE_VERIFY
:

578 
WRITE_VERIFY_12
:

579 
WRITE_VERIFY_16
:

580 
out_com¶‘e
;

583 
»s
 = 
SCST_EXEC_NOT_COMPLETED
;

585 
out
:

586 
	`TRACE_EXIT_RES
(
»s
);

587  
»s
;

589 
out_com¶‘e
:

590 
cmd
->
com¶‘ed
 = 1;

591 
»s
 = 
SCST_EXEC_COMPLETED
;

592 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

593 
out
;

594 
	}
}

596 
MODULE_AUTHOR
("Vladislav Bolkhovitin & Leonid Stoljar");

597 
MODULE_LICENSE
("GPL");

598 
MODULE_DESCRIPTION
("SCSI disk (type 0) dev handler for SCST");

599 
MODULE_VERSION
(
SCST_VERSION_STRING
);

	@scst/src/dev_handlers/scst_modisk.c

24 
	~<lšux/moduË.h
>

25 
	~<lšux/š™.h
>

26 
	~<scsi/scsi_ho¡.h
>

27 
	~<lšux/¦ab.h
>

28 
	~<asm/uÇligÃd.h
>

30 
	#LOG_PREFIX
 "dev_modisk"

	)

32 #ifdeà
INSIDE_KERNEL_TREE


33 
	~<sc¡/sc¡.h
>

35 
	~"sc¡.h
"

37 
	~"sc¡_dev_hªdËr.h
"

39 
	#MODISK_NAME
 "dev_modisk"

	)

40 
	#MODISK_PERF_NAME
 "dev_modisk_³rf"

	)

42 
	#MODISK_DEF_BLOCK_SHIFT
 10

	)

44 
modisk_©ch
(
sc¡_deviû
 *);

45 
modisk_d‘ach
(
sc¡_deviû
 *);

46 
modisk_·r£
(
sc¡_cmd
 *);

47 
modisk_dÚe
(
sc¡_cmd
 *);

48 
modisk_³rf_exec
(
sc¡_cmd
 *);

50 
sc¡_dev_ty³
 
	gmodisk_devty³
 = {

51 .
Çme
 = 
MODISK_NAME
,

52 .
	gty³
 = 
TYPE_MOD
,

53 .
	gth»ads_num
 = 1,

54 .
	g·r£_©omic
 = 1,

55 .
	gdev_dÚe_©omic
 = 1,

56 .
	g©ch
 = 
modisk_©ch
,

57 .
	gd‘ach
 = 
modisk_d‘ach
,

58 .
	g·r£
 = 
modisk_·r£
,

59 .
	gdev_dÚe
 = 
modisk_dÚe
,

60 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

61 .
	gdeçuÉ_Œaû_æags
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
,

62 .
	gŒaû_æags
 = &
Œaû_æag
,

66 
sc¡_dev_ty³
 
	gmodisk_devty³_³rf
 = {

67 .
Çme
 = 
MODISK_PERF_NAME
,

68 .
	gty³
 = 
TYPE_MOD
,

69 .
	g·r£_©omic
 = 1,

70 .
	gdev_dÚe_©omic
 = 1,

71 .
	g©ch
 = 
modisk_©ch
,

72 .
	gd‘ach
 = 
modisk_d‘ach
,

73 .
	g·r£
 = 
modisk_·r£
,

74 .
	gdev_dÚe
 = 
modisk_dÚe
,

75 .
	gexec
 = 
modisk_³rf_exec
,

76 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

77 .
	gdeçuÉ_Œaû_æags
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
,

78 .
	gŒaû_æags
 = &
Œaû_æag
,

82 
__š™
 
	$š™_sc¡_modisk_driv”
()

84 
»s
 = 0;

86 
	`TRACE_ENTRY
();

88 
modisk_devty³
.
moduË
 = 
THIS_MODULE
;

90 
»s
 = 
	`sc¡_»gi¡”_dev_driv”
(&
modisk_devty³
);

91 ià(
»s
 < 0)

92 
out
;

94 
modisk_devty³_³rf
.
moduË
 = 
THIS_MODULE
;

96 
»s
 = 
	`sc¡_»gi¡”_dev_driv”
(&
modisk_devty³_³rf
);

97 ià(
»s
 < 0)

98 
out_uÄeg
;

100 #ifdeà
CONFIG_SCST_PROC


101 
»s
 = 
	`sc¡_dev_hªdËr_bužd_¡d_´oc
(&
modisk_devty³
);

102 ià(
»s
 != 0)

103 
out_uÄeg1
;

105 
»s
 = 
	`sc¡_dev_hªdËr_bužd_¡d_´oc
(&
modisk_devty³_³rf
);

106 ià(
»s
 != 0)

107 
out_uÄeg2
;

110 
out
:

111 
	`TRACE_EXIT_RES
(
»s
);

112  
»s
;

114 #ifdeà
CONFIG_SCST_PROC


115 
out_uÄeg2
:

116 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(&
modisk_devty³
);

118 
out_uÄeg1
:

119 
	`sc¡_uÄegi¡”_dev_driv”
(&
modisk_devty³_³rf
);

122 
out_uÄeg
:

123 
	`sc¡_uÄegi¡”_dev_driv”
(&
modisk_devty³
);

124 
out
;

125 
	}
}

127 
__ex™
 
	$ex™_sc¡_modisk_driv”
()

129 
	`TRACE_ENTRY
();

131 #ifdeà
CONFIG_SCST_PROC


132 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(&
modisk_devty³_³rf
);

133 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(&
modisk_devty³
);

135 
	`sc¡_uÄegi¡”_dev_driv”
(&
modisk_devty³_³rf
);

136 
	`sc¡_uÄegi¡”_dev_driv”
(&
modisk_devty³
);

138 
	`TRACE_EXIT
();

140 
	}
}

142 
moduË_š™
(
š™_sc¡_modisk_driv”
);

143 
moduË_ex™
(
ex™_sc¡_modisk_driv”
);

145 
	$modisk_©ch
(
sc¡_deviû
 *
dev
)

147 
»s
, 
rc
;

148 
ušt8_t
 
cmd
[10];

149 cÚ¡ 
bufãr_size
 = 512;

150 
ušt8_t
 *
bufãr
 = 
NULL
;

151 
»Œ›s
;

152 
£n£_bufãr
[
SCSI_SENSE_BUFFERSIZE
];

153 
dma_d©a_dœeùiÚ
 
d©a_dœ
;

155 
	`TRACE_ENTRY
();

157 ià(
dev
->
scsi_dev
 =ð
NULL
 ||

158 
dev
->
scsi_dev
->
ty³
 != dev->type) {

159 
	`PRINT_ERROR
("%s", "SCSI device‚ot define or illegalype");

160 
»s
 = -
ENODEV
;

161 
out
;

164 
dev
->
block_shiá
 = 
MODISK_DEF_BLOCK_SHIFT
;

165 
dev
->
block_size
 = 1 << dev->
block_shiá
;

171 ià(
dev
->
scsi_dev
->
sdev_¡©e
 =ð
SDEV_OFFLINE
) {

172 
	`TRACE_DBG
("%s", "Device is offline");

173 
»s
 = -
ENODEV
;

174 
out
;

177 
bufãr
 = 
	`km®loc
(
bufãr_size
, 
GFP_KERNEL
);

178 ià(!
bufãr
) {

179 
	`PRINT_ERROR
("Buffer memory‡llocation (size %d) failure",

180 
bufãr_size
);

181 
»s
 = -
ENOMEM
;

182 
out
;

189 
	`mem£t
(
cmd
, 0, (cmd));

190 
cmd
[0] = 
READ_CAPACITY
;

191 
cmd
[1] = (
dev
->
scsi_dev
->
scsi_Ëv–
 <ð
SCSI_2
) ?

192 ((
dev
->
scsi_dev
->
lun
 << 5) & 0xe0) : 0;

193 
»Œ›s
 = 
SCST_DEV_RETRIES_ON_UA
;

195 
	`mem£t
(
bufãr
, 0, 
bufãr_size
);

196 
	`mem£t
(
£n£_bufãr
, 0, (sense_buffer));

197 
d©a_dœ
 = 
SCST_DATA_READ
;

199 
	`TRACE_DBG
("%s", "Doing READ_CAPACITY");

200 
rc
 = 
	`scsi_execu‹
(
dev
->
scsi_dev
, 
cmd
, 
d©a_dœ
, 
bufãr
,

201 
bufãr_size
, 
£n£_bufãr
,

202 
SCST_GENERIC_MODISK_REG_TIMEOUT
, 3, 0

203 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2,6,29)

204 , 
NULL


208 
	`TRACE_DBG
("READ_CAPACITY dÚe: %x", 
rc
);

210 ià(!
rc
 || !
	`sc¡_ª®yze_£n£
(
£n£_bufãr
,

211 (
£n£_bufãr
), 
SCST_SENSE_KEY_VALID
,

212 
UNIT_ATTENTION
, 0, 0))

215 ià(!--
»Œ›s
) {

216 
	`PRINT_ERROR
("UA‚ot cleared‡fter %d„etries",

217 
SCST_DEV_RETRIES_ON_UA
);

218 
»s
 = -
ENODEV
;

219 
out_ä“_buf
;

223 ià(
rc
 == 0) {

224 
ušt32_t
 
£ùÜ_size
 = 
	`g‘_uÇligÃd_be32
(&
bufãr
[4]);

226 ià(
£ùÜ_size
 == 0)

227 
dev
->
block_shiá
 = 
MODISK_DEF_BLOCK_SHIFT
;

229 
dev
->
block_shiá
 = 
	`sc¡_ÿlc_block_shiá
(
£ùÜ_size
);

230 
	`TRACE_DBG
("Sector size is %i scsi_level %d(SCSI_2 %d)",

231 
£ùÜ_size
, 
dev
->
scsi_dev
->
scsi_Ëv–
, 
SCSI_2
);

232 ià(
dev
->
block_shiá
 < 9) {

233 
	`PRINT_ERROR
("READ CAPACITY„eported‡n invalid sector size: %d",

234 
£ùÜ_size
);

235 
»s
 = -
EINVAL
;

236 
out_ä“_buf
;

239 
dev
->
block_shiá
 = 
MODISK_DEF_BLOCK_SHIFT
;

240 
	`TRACE
(
TRACE_MINOR
, "Read capacity failed: %x, using default "

241 "£ùÜ siz%d", 
rc
, 
dev
->
block_shiá
);

242 
	`PRINT_BUFF_FLAG
(
TRACE_MINOR
, "R‘uºed s’£", 
£n£_bufãr
,

243 (
£n£_bufãr
));

245 
dev
->
block_size
 = 1 << dev->
block_shiá
;

247 
»s
 = 
	`sc¡_obš_deviû_·¿m‘”s
(
dev
, 
NULL
);

248 ià(
»s
 != 0) {

249 
	`PRINT_ERROR
("Failedo obtain control…arameters for device "

250 "%s: %x", 
dev
->
vœt_Çme
, 
»s
);

251 
out_ä“_buf
;

254 
out_ä“_buf
:

255 
	`kä“
(
bufãr
);

257 
out
:

258 
	`TRACE_EXIT_RES
(
»s
);

259  
»s
;

260 
	}
}

262 
	$modisk_d‘ach
(
sc¡_deviû
 *
dev
)

266 
	}
}

268 
	$modisk_·r£
(
sc¡_cmd
 *
cmd
)

270 
»s
 = 
SCST_CMD_STATE_DEFAULT
, 
rc
;

272 
rc
 = 
	`sc¡_modisk_g’”ic_·r£
(
cmd
);

273 ià(
rc
 != 0) {

274 
»s
 = 
	`sc¡_g‘_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

275 
out
;

278 
cmd
->
»Œ›s
 = 
SCST_PASSTHROUGH_RETRIES
;

279 
out
:

280  
»s
;

281 
	}
}

283 
	$modisk_£t_block_shiá
(
sc¡_cmd
 *
cmd
, 
block_shiá
)

285 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

286 
Ãw_block_shiá
;

292 
Ãw_block_shiá
 = 
block_shiá
 ? : 
MODISK_DEF_BLOCK_SHIFT
;

293 ià(
dev
->
block_shiá
 !ð
Ãw_block_shiá
) {

294 
	`PRINT_INFO
("%s: Changed block shift from %d into %d / %d",

295 
dev
->
vœt_Çme
, dev->
block_shiá
, block_shift,

296 
Ãw_block_shiá
);

297 
dev
->
block_shiá
 = 
Ãw_block_shiá
;

298 
dev
->
block_size
 = 1 << dev->
block_shiá
;

301 
	}
}

303 
	$modisk_dÚe
(
sc¡_cmd
 *
cmd
)

305 
»s
;

307 
	`TRACE_ENTRY
();

309 
»s
 = 
	`sc¡_block_g’”ic_dev_dÚe
(
cmd
, 
modisk_£t_block_shiá
);

311 
	`TRACE_EXIT_RES
(
»s
);

312  
»s
;

313 
	}
}

315 
	$modisk_³rf_exec
(
sc¡_cmd
 *
cmd
)

317 
»s
 = 
SCST_EXEC_NOT_COMPLETED
;

318 
Ýcode
 = 
cmd
->
cdb
[0];

320 
	`TRACE_ENTRY
();

322 
cmd
->
¡©us
 = 0;

323 
cmd
->
msg_¡©us
 = 0;

324 
cmd
->
ho¡_¡©us
 = 
DID_OK
;

325 
cmd
->
driv”_¡©us
 = 0;

327 
Ýcode
) {

328 
WRITE_6
:

329 
WRITE_10
:

330 
WRITE_12
:

331 
WRITE_16
:

332 
READ_6
:

333 
READ_10
:

334 
READ_12
:

335 
READ_16
:

336 
cmd
->
com¶‘ed
 = 1;

337 
out_dÚe
;

340 
out
:

341 
	`TRACE_EXIT_RES
(
»s
);

342  
»s
;

344 
out_dÚe
:

345 
»s
 = 
SCST_EXEC_COMPLETED
;

346 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

347 
out
;

348 
	}
}

350 
MODULE_AUTHOR
("Vladislav Bolkhovitin & Leonid Stoljar");

351 
MODULE_LICENSE
("GPL");

352 
MODULE_DESCRIPTION
("SCSI MO disk (type 7) dev handler for SCST");

353 
MODULE_VERSION
(
SCST_VERSION_STRING
);

	@scst/src/dev_handlers/scst_processor.c

21 
	~<scsi/scsi_ho¡.h
>

22 
	~<lšux/¦ab.h
>

24 
	#LOG_PREFIX
 "dev_´oûssÜ"

	)

26 #ifdeà
INSIDE_KERNEL_TREE


27 
	~<sc¡/sc¡.h
>

29 
	~"sc¡.h
"

31 
	~"sc¡_dev_hªdËr.h
"

33 
	#PROCESSOR_NAME
 "dev_´oûssÜ"

	)

35 
	#PROCESSOR_RETRIES
 2

	)

37 
´oûssÜ_©ch
(
sc¡_deviû
 *);

39 
´oûssÜ_·r£
(
sc¡_cmd
 *);

42 
sc¡_dev_ty³
 
	g´oûssÜ_devty³
 = {

43 .
Çme
 = 
PROCESSOR_NAME
,

44 .
	gty³
 = 
TYPE_PROCESSOR
,

45 .
	gth»ads_num
 = 1,

46 .
	g·r£_©omic
 = 1,

48 .
	g©ch
 = 
´oûssÜ_©ch
,

50 .
	g·r£
 = 
´oûssÜ_·r£
,

52 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

53 .
	gdeçuÉ_Œaû_æags
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
,

54 .
	gŒaû_æags
 = &
Œaû_æag
,

58 
	$´oûssÜ_©ch
(
sc¡_deviû
 *
dev
)

60 
»s
, 
rc
;

61 
»Œ›s
;

63 
	`TRACE_ENTRY
();

65 ià(
dev
->
scsi_dev
 =ð
NULL
 ||

66 
dev
->
scsi_dev
->
ty³
 != dev->type) {

67 
	`PRINT_ERROR
("%s", "SCSI device‚ot define or illegalype");

68 
»s
 = -
ENODEV
;

69 
out
;

76 ià(
dev
->
scsi_dev
->
sdev_¡©e
 =ð
SDEV_OFFLINE
) {

77 
	`TRACE_DBG
("%s", "Device is offline");

78 
»s
 = -
ENODEV
;

79 
out
;

82 
»Œ›s
 = 
SCST_DEV_RETRIES_ON_UA
;

84 
	`TRACE_DBG
("%s", "Doing TEST_UNIT_READY");

85 
rc
 = 
	`scsi_‹¡_un™_»ady
(
dev
->
scsi_dev
,

86 
SCST_GENERIC_PROCESSOR_TIMEOUT
, 
PROCESSOR_RETRIES


87 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 25)

90 , 
NULL
);

92 
	`TRACE_DBG
("TEST_UNIT_READY dÚe: %x", 
rc
);

93 } (--
»Œ›s
 > 0è&& 
rc
);

95 ià(
rc
) {

96 
	`PRINT_WARNING
("Un™‚Ù„—dy: %x", 
rc
);

100 
»s
 = 
	`sc¡_obš_deviû_·¿m‘”s
(
dev
, 
NULL
);

101 ià(
»s
 != 0) {

102 
	`PRINT_ERROR
("Failedo obtain control…arameters for device "

103 "%s", 
dev
->
vœt_Çme
);

104 
out
;

107 
out
:

108 
	`TRACE_EXIT
();

109  
»s
;

110 
	}
}

113 
	$´oûssÜ_d‘ach
(
sc¡_deviû
 *
dev
)

115 
	`TRACE_ENTRY
();

117 
	`TRACE_EXIT
();

119 
	}
}

122 
	$´oûssÜ_·r£
(
sc¡_cmd
 *
cmd
)

124 
»s
 = 
SCST_CMD_STATE_DEFAULT
, 
rc
;

126 
rc
 = 
	`sc¡_´oûssÜ_g’”ic_·r£
(
cmd
);

127 ià(
rc
 != 0) {

128 
»s
 = 
	`sc¡_g‘_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

129 
out
;

132 
cmd
->
»Œ›s
 = 
SCST_PASSTHROUGH_RETRIES
;

133 
out
:

134  
»s
;

135 
	}
}

138 
	$´oûssÜ_dÚe
(
sc¡_cmd
 *
cmd
)

140 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

142 
	`TRACE_ENTRY
();

151 
cmd
->
cdb
[0]) {

158 
	`TRACE_EXIT
();

159  
»s
;

160 
	}
}

163 
__š™
 
	$´oûssÜ_š™
()

165 
»s
 = 0;

167 
	`TRACE_ENTRY
();

169 
´oûssÜ_devty³
.
moduË
 = 
THIS_MODULE
;

171 
»s
 = 
	`sc¡_»gi¡”_dev_driv”
(&
´oûssÜ_devty³
);

172 ià(
»s
 < 0)

173 
out
;

175 #ifdeà
CONFIG_SCST_PROC


176 
»s
 = 
	`sc¡_dev_hªdËr_bužd_¡d_´oc
(&
´oûssÜ_devty³
);

177 ià(
»s
 != 0)

178 
out_”r
;

181 
out
:

182 
	`TRACE_EXIT_RES
(
»s
);

183  
»s
;

184 #ifdeà
CONFIG_SCST_PROC


185 
out_”r
:

186 
	`sc¡_uÄegi¡”_dev_driv”
(&
´oûssÜ_devty³
);

187 
out
;

189 
	}
}

191 
__ex™
 
	$´oûssÜ_ex™
()

193 
	`TRACE_ENTRY
();

194 #ifdeà
CONFIG_SCST_PROC


195 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(&
´oûssÜ_devty³
);

197 
	`sc¡_uÄegi¡”_dev_driv”
(&
´oûssÜ_devty³
);

198 
	`TRACE_EXIT
();

200 
	}
}

202 
moduË_š™
(
´oûssÜ_š™
);

203 
moduË_ex™
(
´oûssÜ_ex™
);

205 
MODULE_AUTHOR
("Vladislav Bolkhovitin & Leonid Stoljar");

206 
MODULE_LICENSE
("GPL");

207 
MODULE_DESCRIPTION
("SCSI medium…rocessor (type 3) dev handler for SCST");

208 
MODULE_VERSION
(
SCST_VERSION_STRING
);

	@scst/src/dev_handlers/scst_raid.c

21 
	#LOG_PREFIX
 "dev_¿id"

	)

23 
	~<scsi/scsi_ho¡.h
>

24 
	~<lšux/¦ab.h
>

26 #ifdeà
INSIDE_KERNEL_TREE


27 
	~<sc¡/sc¡.h
>

29 
	~"sc¡.h
"

31 
	~"sc¡_dev_hªdËr.h
"

33 
	#RAID_NAME
 "dev_¿id"

	)

35 
	#RAID_RETRIES
 2

	)

37 
¿id_©ch
(
sc¡_deviû
 *);

39 
¿id_·r£
(
sc¡_cmd
 *);

42 
sc¡_dev_ty³
 
	g¿id_devty³
 = {

43 .
Çme
 = 
RAID_NAME
,

44 .
	gty³
 = 
TYPE_RAID
,

45 .
	gth»ads_num
 = 1,

46 .
	g·r£_©omic
 = 1,

48 .
	g©ch
 = 
¿id_©ch
,

50 .
	g·r£
 = 
¿id_·r£
,

52 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

53 .
	gdeçuÉ_Œaû_æags
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
,

54 .
	gŒaû_æags
 = &
Œaû_æag
,

58 
	$¿id_©ch
(
sc¡_deviû
 *
dev
)

60 
»s
, 
rc
;

61 
»Œ›s
;

63 
	`TRACE_ENTRY
();

65 ià(
dev
->
scsi_dev
 =ð
NULL
 ||

66 
dev
->
scsi_dev
->
ty³
 != dev->type) {

67 
	`PRINT_ERROR
("%s", "SCSI device‚ot define or illegalype");

68 
»s
 = -
ENODEV
;

69 
out
;

76 ià(
dev
->
scsi_dev
->
sdev_¡©e
 =ð
SDEV_OFFLINE
) {

77 
	`TRACE_DBG
("%s", "Device is offline");

78 
»s
 = -
ENODEV
;

79 
out
;

82 
»Œ›s
 = 
SCST_DEV_RETRIES_ON_UA
;

84 
	`TRACE_DBG
("%s", "Doing TEST_UNIT_READY");

85 
rc
 = 
	`scsi_‹¡_un™_»ady
(
dev
->
scsi_dev
,

86 
SCST_GENERIC_RAID_TIMEOUT
, 
RAID_RETRIES


87 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 25)

90 , 
NULL
);

92 
	`TRACE_DBG
("TEST_UNIT_READY dÚe: %x", 
rc
);

93 } (--
»Œ›s
 > 0è&& 
rc
);

95 ià(
rc
) {

96 
	`PRINT_WARNING
("Un™‚Ù„—dy: %x", 
rc
);

100 
»s
 = 
	`sc¡_obš_deviû_·¿m‘”s
(
dev
, 
NULL
);

101 ià(
»s
 != 0) {

102 
	`PRINT_ERROR
("Failedo obtain control…arameters for device "

103 "%s", 
dev
->
vœt_Çme
);

104 
out
;

107 
out
:

108 
	`TRACE_EXIT
();

109  
»s
;

110 
	}
}

113 
	$¿id_d‘ach
(
sc¡_deviû
 *
dev
)

115 
	`TRACE_ENTRY
();

117 
	`TRACE_EXIT
();

119 
	}
}

122 
	$¿id_·r£
(
sc¡_cmd
 *
cmd
)

124 
»s
 = 
SCST_CMD_STATE_DEFAULT
, 
rc
;

126 
rc
 = 
	`sc¡_¿id_g’”ic_·r£
(
cmd
);

127 ià(
rc
 != 0) {

128 
»s
 = 
	`sc¡_g‘_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

129 
out
;

132 
cmd
->
»Œ›s
 = 
SCST_PASSTHROUGH_RETRIES
;

133 
out
:

134  
»s
;

135 
	}
}

138 
	$¿id_dÚe
(
sc¡_cmd
 *
cmd
)

140 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

142 
	`TRACE_ENTRY
();

151 
cmd
->
cdb
[0]) {

158 
	`TRACE_EXIT
();

159  
»s
;

160 
	}
}

163 
__š™
 
	$¿id_š™
()

165 
»s
 = 0;

167 
	`TRACE_ENTRY
();

169 
¿id_devty³
.
moduË
 = 
THIS_MODULE
;

171 
»s
 = 
	`sc¡_»gi¡”_dev_driv”
(&
¿id_devty³
);

172 ià(
»s
 < 0)

173 
out
;

175 #ifdeà
CONFIG_SCST_PROC


176 
»s
 = 
	`sc¡_dev_hªdËr_bužd_¡d_´oc
(&
¿id_devty³
);

177 ià(
»s
 != 0)

178 
out_”r
;

181 
out
:

182 
	`TRACE_EXIT_RES
(
»s
);

183  
»s
;

185 #ifdeà
CONFIG_SCST_PROC


186 
out_”r
:

187 
	`sc¡_uÄegi¡”_dev_driv”
(&
¿id_devty³
);

188 
out
;

190 
	}
}

192 
__ex™
 
	$¿id_ex™
()

194 
	`TRACE_ENTRY
();

195 #ifdeà
CONFIG_SCST_PROC


196 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(&
¿id_devty³
);

198 
	`sc¡_uÄegi¡”_dev_driv”
(&
¿id_devty³
);

199 
	`TRACE_EXIT
();

201 
	}
}

203 
moduË_š™
(
¿id_š™
);

204 
moduË_ex™
(
¿id_ex™
);

206 
MODULE_AUTHOR
("Vladislav Bolkhovitin & Leonid Stoljar");

207 
MODULE_LICENSE
("GPL");

208 
MODULE_DESCRIPTION
("SCSI„aid(controller) (type 0xC) dev handler for SCST");

209 
MODULE_VERSION
(
SCST_VERSION_STRING
);

	@scst/src/dev_handlers/scst_tape.c

24 
	~<lšux/moduË.h
>

25 
	~<lšux/š™.h
>

26 
	~<scsi/scsi_ho¡.h
>

27 
	~<lšux/¦ab.h
>

28 
	~<asm/uÇligÃd.h
>

30 
	#LOG_PREFIX
 "dev_³"

	)

32 #ifdeà
INSIDE_KERNEL_TREE


33 
	~<sc¡/sc¡.h
>

35 
	~"sc¡.h
"

37 
	~"sc¡_dev_hªdËr.h
"

39 
	#TAPE_NAME
 "dev_³"

	)

40 
	#TAPE_PERF_NAME
 "dev_³_³rf"

	)

42 
	#TAPE_RETRIES
 2

	)

44 
	#TAPE_DEF_BLOCK_SIZE
 512

	)

47 
	#SILI_BIT
 2

	)

49 
³_©ch
(
sc¡_deviû
 *);

50 
³_d‘ach
(
sc¡_deviû
 *);

51 
³_·r£
(
sc¡_cmd
 *);

52 
³_dÚe
(
sc¡_cmd
 *);

53 
³_³rf_exec
(
sc¡_cmd
 *);

55 
sc¡_dev_ty³
 
	g³_devty³
 = {

56 .
Çme
 = 
TAPE_NAME
,

57 .
	gty³
 = 
TYPE_TAPE
,

58 .
	gth»ads_num
 = 1,

59 .
	g·r£_©omic
 = 1,

60 .
	gdev_dÚe_©omic
 = 1,

61 .
	g©ch
 = 
³_©ch
,

62 .
	gd‘ach
 = 
³_d‘ach
,

63 .
	g·r£
 = 
³_·r£
,

64 .
	gdev_dÚe
 = 
³_dÚe
,

65 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

66 .
	gdeçuÉ_Œaû_æags
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
,

67 .
	gŒaû_æags
 = &
Œaû_æag
,

71 
sc¡_dev_ty³
 
	g³_devty³_³rf
 = {

72 .
Çme
 = 
TAPE_PERF_NAME
,

73 .
	gty³
 = 
TYPE_TAPE
,

74 .
	g·r£_©omic
 = 1,

75 .
	gdev_dÚe_©omic
 = 1,

76 .
	g©ch
 = 
³_©ch
,

77 .
	gd‘ach
 = 
³_d‘ach
,

78 .
	g·r£
 = 
³_·r£
,

79 .
	gdev_dÚe
 = 
³_dÚe
,

80 .
	gexec
 = 
³_³rf_exec
,

81 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

82 .
	gdeçuÉ_Œaû_æags
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
,

83 .
	gŒaû_æags
 = &
Œaû_æag
,

87 
__š™
 
	$š™_sc¡_³_driv”
()

89 
»s
 = 0;

91 
	`TRACE_ENTRY
();

93 
³_devty³
.
moduË
 = 
THIS_MODULE
;

95 
»s
 = 
	`sc¡_»gi¡”_dev_driv”
(&
³_devty³
);

96 ià(
»s
 < 0)

97 
out
;

99 
³_devty³_³rf
.
moduË
 = 
THIS_MODULE
;

101 
»s
 = 
	`sc¡_»gi¡”_dev_driv”
(&
³_devty³_³rf
);

102 ià(
»s
 < 0)

103 
out_uÄeg
;

105 #ifdeà
CONFIG_SCST_PROC


106 
»s
 = 
	`sc¡_dev_hªdËr_bužd_¡d_´oc
(&
³_devty³
);

107 ià(
»s
 != 0)

108 
out_uÄeg1
;

110 
»s
 = 
	`sc¡_dev_hªdËr_bužd_¡d_´oc
(&
³_devty³_³rf
);

111 ià(
»s
 != 0)

112 
out_uÄeg2
;

115 
out
:

116 
	`TRACE_EXIT_RES
(
»s
);

117  
»s
;

119 #ifdeà
CONFIG_SCST_PROC


120 
out_uÄeg2
:

121 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(&
³_devty³
);

123 
out_uÄeg1
:

124 
	`sc¡_uÄegi¡”_dev_driv”
(&
³_devty³_³rf
);

127 
out_uÄeg
:

128 
	`sc¡_uÄegi¡”_dev_driv”
(&
³_devty³
);

129 
out
;

130 
	}
}

132 
__ex™
 
	$ex™_sc¡_³_driv”
()

134 
	`TRACE_ENTRY
();

136 #ifdeà
CONFIG_SCST_PROC


137 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(&
³_devty³_³rf
);

138 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(&
³_devty³
);

140 
	`sc¡_uÄegi¡”_dev_driv”
(&
³_devty³_³rf
);

141 
	`sc¡_uÄegi¡”_dev_driv”
(&
³_devty³
);

143 
	`TRACE_EXIT
();

145 
	}
}

147 
moduË_š™
(
š™_sc¡_³_driv”
);

148 
moduË_ex™
(
ex™_sc¡_³_driv”
);

150 
	$³_©ch
(
sc¡_deviû
 *
dev
)

152 
»s
, 
rc
;

153 
»Œ›s
;

154 
scsi_mode_d©a
 
d©a
;

155 cÚ¡ 
bufãr_size
 = 512;

156 
ušt8_t
 *
bufãr
 = 
NULL
;

158 
	`TRACE_ENTRY
();

160 ià(
dev
->
scsi_dev
 =ð
NULL
 ||

161 
dev
->
scsi_dev
->
ty³
 != dev->type) {

162 
	`PRINT_ERROR
("%s", "SCSI device‚ot define or illegalype");

163 
»s
 = -
ENODEV
;

164 
out
;

167 
dev
->
block_size
 = 
TAPE_DEF_BLOCK_SIZE
;

168 
dev
->
block_shiá
 = -1;

170 
bufãr
 = 
	`km®loc
(
bufãr_size
, 
GFP_KERNEL
);

171 ià(!
bufãr
) {

172 
	`PRINT_ERROR
("Buffer memory‡llocation (size %d) failure",

173 
bufãr_size
);

174 
»s
 = -
ENOMEM
;

175 
out
;

178 
»Œ›s
 = 
SCST_DEV_RETRIES_ON_UA
;

180 
	`TRACE_DBG
("%s", "Doing TEST_UNIT_READY");

181 
rc
 = 
	`scsi_‹¡_un™_»ady
(
dev
->
scsi_dev
,

182 
SCST_GENERIC_TAPE_SMALL_TIMEOUT
, 
TAPE_RETRIES


183 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 25)

186 , 
NULL
);

188 
	`TRACE_DBG
("TEST_UNIT_READY dÚe: %x", 
rc
);

189 } (--
»Œ›s
 > 0è&& 
rc
);

191 ià(
rc
) {

192 
	`PRINT_WARNING
("Un™‚Ù„—dy: %x", 
rc
);

194 
obš
;

197 
	`TRACE_DBG
("%s", "Doing MODE_SENSE");

198 
rc
 = 
	`scsi_mode_£n£
(
dev
->
scsi_dev
,

199 ((
dev
->
scsi_dev
->
scsi_Ëv–
 <ð
SCSI_2
) ?

200 ((
dev
->
scsi_dev
->
lun
 << 5) & 0xe0) : 0),

202 
bufãr
, 
bufãr_size
,

203 
SCST_GENERIC_TAPE_SMALL_TIMEOUT
, 
TAPE_RETRIES
,

204 &
d©a
, 
NULL
);

205 
	`TRACE_DBG
("MODE_SENSE dÚe: %x", 
rc
);

207 ià(
rc
 == 0) {

208 
medium_ty³
, 
mode
, 
¥“d
, 
d’s™y
;

210 ià(
bufãr
[3] == 8)

211 
dev
->
block_size
 = 
	`g‘_uÇligÃd_be24
(&
bufãr
[9]);

213 
dev
->
block_size
 = 
TAPE_DEF_BLOCK_SIZE
;

214 
medium_ty³
 = 
bufãr
[1];

215 
mode
 = (
bufãr
[2] & 0x70) >> 4;

216 
¥“d
 = 
bufãr
[2] & 0x0f;

217 
d’s™y
 = 
bufãr
[4];

218 
	`TRACE_DBG
("Tape:†un %lld. bs %d.ype 0x%02x mode 0x%02x "

219 "¥“d 0x%02x d’ 0x%02x", (
u64
)
dev
->
scsi_dev
->
lun
,

220 
dev
->
block_size
, 
medium_ty³
, 
mode
, 
¥“d
, 
d’s™y
);

222 
	`PRINT_ERROR
("MODE_SENSE fažed: %x", 
rc
);

223 
»s
 = -
ENODEV
;

224 
out_ä“_buf
;

226 
dev
->
block_shiá
 = -1;

228 
obš
:

229 
»s
 = 
	`sc¡_obš_deviû_·¿m‘”s
(
dev
, 
NULL
);

230 ià(
»s
 != 0) {

231 
	`PRINT_ERROR
("Failedo obtain control…arameters for device "

232 "%s", 
dev
->
vœt_Çme
);

233 
out_ä“_buf
;

236 
out_ä“_buf
:

237 
	`kä“
(
bufãr
);

239 
out
:

240 
	`TRACE_EXIT_RES
(
»s
);

241  
»s
;

242 
	}
}

244 
	$³_d‘ach
(
sc¡_deviû
 *
dev
)

248 
	}
}

250 
	$³_·r£
(
sc¡_cmd
 *
cmd
)

252 
»s
 = 
SCST_CMD_STATE_DEFAULT
, 
rc
;

254 
rc
 = 
	`sc¡_³_g’”ic_·r£
(
cmd
);

255 ià(
rc
 != 0) {

256 
»s
 = 
	`sc¡_g‘_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

257 
out
;

260 
cmd
->
»Œ›s
 = 
SCST_PASSTHROUGH_RETRIES
;

261 
out
:

262  
»s
;

263 
	}
}

265 
	$³_£t_block_size
(
sc¡_cmd
 *
cmd
, 
block_size
)

267 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

272 
dev
->
block_size
 = block_size;

273 
dev
->
block_shiá
 = -1;

275 
	}
}

277 
	$³_dÚe
(
sc¡_cmd
 *
cmd
)

279 
Ýcode
 = 
cmd
->
cdb
[0];

280 
¡©us
 = 
cmd
->status;

281 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

283 
	`TRACE_ENTRY
();

285 ià((
¡©us
 =ð
SAM_STAT_GOOD
è|| (¡©u =ð
SAM_STAT_CONDITION_MET
))

286 
»s
 = 
	`sc¡_³_g’”ic_dev_dÚe
(
cmd
, 
³_£t_block_size
);

287 ià((
¡©us
 =ð
SAM_STAT_CHECK_CONDITION
) &&

288 
	`sc¡_£n£_v®id
(
cmd
->
£n£
)) {

289 
	`TRACE_DBG
("Ex‹nded s’£ %x", 
	`sc¡_£n£_»¥Ú£_code
(
cmd
->
£n£
));

291 ià(
	`sc¡_£n£_»¥Ú£_code
(
cmd
->
£n£
) != 0x70) {

292 
	`PRINT_ERROR
("Sense format 0x%x is‚ot supported",

293 
	`sc¡_£n£_»¥Ú£_code
(
cmd
->
£n£
));

294 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

295 
	`SCST_LOAD_SENSE
(
sc¡_£n£_š‹º®_çžu»
));

296 
out
;

299 ià(
Ýcode
 =ð
READ_6
 && !(
cmd
->
cdb
[1] & 
SILI_BIT
) &&

300 (
cmd
->
£n£
[2] & 0xe0)) {

302 
T¿nsãrL’gth
, 
Residue
 = 0;

304 ià((
cmd
->
£n£
[2] & 0x0fè=ð
BLANK_CHECK
)

306 
cmd
->
£n£
[2] &= 0xcf;

307 
T¿nsãrL’gth
 = 
	`g‘_uÇligÃd_be24
(&
cmd
->
cdb
[2]);

309 ià((
cmd
->
£n£
[0] & 0x80) != 0)

310 
Residue
 = 
	`g‘_uÇligÃd_be32
(&
cmd
->
£n£
[3]);

311 
	`TRACE_DBG
("Checkinghe sense key "

313 " %d/%d", ()
cmd
->
£n£
[2], cmd->
cdb
[0],

314 
cmd
->
cdb
[1], 
T¿nsãrL’gth
, 
Residue
);

315 ià(
T¿nsãrL’gth
 > 
Residue
) {

316 
»¥_d©a_Ën
 = 
T¿nsãrL’gth
 - 
Residue
;

318 ià(
cmd
->
cdb
[1] & 1) {

324 
»¥_d©a_Ën
 *ð
cmd
->
dev
->
block_size
;

326 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
»¥_d©a_Ën
);

331 
out
:

332 
	`TRACE_DBG
("cmd->is_send_status=%x, cmd->resp_data_len=%d, "

333 "»s=%d", 
cmd
->
is_£nd_¡©us
, cmd->
»¥_d©a_Ën
, 
»s
);

335 
	`TRACE_EXIT_RES
(
»s
);

336  
»s
;

337 
	}
}

339 
	$³_³rf_exec
(
sc¡_cmd
 *
cmd
)

341 
»s
 = 
SCST_EXEC_NOT_COMPLETED
;

342 
Ýcode
 = 
cmd
->
cdb
[0];

344 
	`TRACE_ENTRY
();

346 
cmd
->
¡©us
 = 0;

347 
cmd
->
msg_¡©us
 = 0;

348 
cmd
->
ho¡_¡©us
 = 
DID_OK
;

349 
cmd
->
driv”_¡©us
 = 0;

351 
Ýcode
) {

352 
WRITE_6
:

353 
READ_6
:

354 
cmd
->
com¶‘ed
 = 1;

355 
out_dÚe
;

358 
out
:

359 
	`TRACE_EXIT_RES
(
»s
);

360  
»s
;

362 
out_dÚe
:

363 
»s
 = 
SCST_EXEC_COMPLETED
;

364 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

365 
out
;

366 
	}
}

368 
MODULE_AUTHOR
("Vladislav Bolkhovitin & Leonid Stoljar");

369 
MODULE_LICENSE
("GPL");

370 
MODULE_DESCRIPTION
("SCSIape (type 1) dev handler for SCST");

371 
MODULE_VERSION
(
SCST_VERSION_STRING
);

	@scst/src/dev_handlers/scst_user.c

20 
	~<lšux/kth»ad.h
>

21 
	~<lšux/d–ay.h
>

22 
	~<lšux/pÞl.h
>

23 
	~<lšux/¡ddef.h
>

24 
	~<lšux/¦ab.h
>

26 
	#LOG_PREFIX
 
DEV_USER_NAME


	)

28 #ifdeà
INSIDE_KERNEL_TREE


29 
	~<sc¡/sc¡.h
>

30 
	~<sc¡/sc¡_u£r.h
>

32 
	~"sc¡.h
"

33 
	~"sc¡_u£r.h
"

35 
	~"sc¡_dev_hªdËr.h
"

37 #iâdeà
INSIDE_KERNEL_TREE


38 #ià
defšed
(
CONFIG_HIGHMEM4G
è|| defšed(
CONFIG_HIGHMEM64G
)

39 #w¬nšg 
HIGHMEM
 
k”Ãl
 
cÚfigu¿tiÚs
 
¬e
 
nÙ
 
suµÜ‹d
 
by
 
this
 
moduË
,\

40 
beÿu£
 
nowadays
 
™
 
is
 
nÙ
 
wÜth
 
the
 
	geffÜt
. 
CÚsid”
 
	gchªgšg
\

41 
VMSPLIT
 
ÝtiÚ
 
Ü
 
u£
 
	ga
 64-
b™
 
cÚfigu¿tiÚ
 
	gš¡—d
. 
S“
 
README
 
	gfže
\

42 
	gd‘ažs
.

46 
	#DEV_USER_CMD_HASH_ORDER
 6

	)

47 
	#DEV_USER_ATTACH_TIMEOUT
 (5*
HZ
)

	)

49 
	ssc¡_u£r_dev
 {

54 
sc¡_cmd_th»ads
 
	mudev_cmd_th»ads
;

57 
li¡_h—d
 
	m»ady_cmd_li¡
;

63 
	mblockšg
:1;

64 
	mþ—nup_dÚe
:1;

65 
	mt¡
:3;

66 
	mtmf_Úly
:1;

67 
	mqueue_®g
:4;

68 
	mq”r
:2;

69 
	ms
:1;

70 
	mswp
:1;

71 
	md_£n£
:1;

72 
	mhas_own_Üd”_mgmt
:1;

73 
	mext_cÝy_»m­_suµÜ‹d
:1;

75 (*
	mg’”ic_·r£
)(
sc¡_cmd
 *
	mcmd
);

77 
	mdef_block_size
;

79 
sc¡_mem_lim
 
	mudev_mem_lim
;

80 
sgv_poÞ
 *
	mpoÞ
;

81 
sgv_poÞ
 *
	mpoÞ_þu¡
;

83 
ušt8_t
 
	m·r£_ty³
;

84 
ušt8_t
 
	mÚ_ä“_cmd_ty³
;

85 
ušt8_t
 
	mmemÜy_»u£_ty³
;

86 
ušt8_t
 
	m·¹Ÿl_Œªsãrs_ty³
;

87 
ušt32_t
 
	m·¹Ÿl_Ën
;

89 
sc¡_dev_ty³
 
	mdevty³
;

92 
	mhªdË_couÁ”
;

93 
li¡_h—d
 
	mucmd_hash
[1 << 
DEV_USER_CMD_HASH_ORDER
];

95 
sc¡_deviû
 *
	msdev
;

97 
	mvœt_id
;

98 
li¡_h—d
 
	mdev_li¡_’Œy
;

99 
	mÇme
[
SCST_MAX_NAME
];

101 
li¡_h—d
 
	mþ—nup_li¡_’Œy
;

102 
com¶‘iÚ
 
	mþ—nup_cm¶
;

106 
	ssc¡_u£r_cmd
 {

107 
sc¡_cmd
 *
	mcmd
;

108 
sc¡_u£r_dev
 *
	mdev
;

116 
	mbuff_ÿched
:1;

117 
	mbuf_dœty
:1;

118 
	mbackground_exec
:1;

119 
	mabÜ‹d
:1;

121 
sc¡_u£r_cmd
 *
	mbuf_ucmd
;

123 
©omic_t
 
	mucmd_»f
;

125 
	mcur_d©a_·ge
;

126 
	mnum_d©a_·ges
;

127 
	mfœ¡_·ge_off£t
;

128 
	mubuff
;

129 
·ge
 **
	md©a_·ges
;

130 
sgv_poÞ_obj
 *
	msgv
;

136 
	m£Á_to_u£r
:1;

137 
	mjammed
:1;

138 
	mthis_¡©e_unjammed
:1;

139 
	m£’_by_u£r
:1;

141 
	m¡©e
;

143 
li¡_h—d
 
	m»ady_cmd_li¡_’Œy
;

145 
	mh
;

146 
li¡_h—d
 
	mhash_li¡_’Œy
;

148 
	mu£r_cmd_·ylßd_Ën
;

149 
sc¡_u£r_g‘_cmd
 
	mu£r_cmd
;

153 
com¶‘iÚ
 *
	mcm¶
;

154 
sc¡_mgmt_cmd
 *
	mmcmd
;

156 
	m»suÉ
;

159 
dev_u£r_ä“_ucmd
(
sc¡_u£r_cmd
 *
ucmd
);

161 
·ge
 *
dev_u£r_®loc_·ges
(
sÿ‰”li¡
 *
sg
,

162 
gå_t
 
gå_mask
, *
´iv
);

163 
dev_u£r_ä“_sg_’Œ›s
(
sÿ‰”li¡
 *
sg
, 
sg_couÁ
,

164 *
´iv
);

166 
dev_u£r_add_to_»ady
(
sc¡_u£r_cmd
 *
ucmd
);

168 
dev_u£r_unjam_cmd
(
sc¡_u£r_cmd
 *
ucmd
, 
busy
,

169 *
æags
);

171 
dev_u£r_´oûss_»¶y_Ú_ä“
(
sc¡_u£r_cmd
 *
ucmd
);

172 
dev_u£r_´oûss_»¶y_tm_exec
(
sc¡_u£r_cmd
 *
ucmd
,

173 
¡©us
);

174 
dev_u£r_´oûss_»¶y_£ss
(
sc¡_u£r_cmd
 *
ucmd
, 
¡©us
);

175 
dev_u£r_»gi¡”_dev
(
fže
 *file,

176 cÚ¡ 
sc¡_u£r_dev_desc
 *
dev_desc
);

177 
dev_u£r_uÄegi¡”_dev
(
fže
 *file);

178 
dev_u£r_æush_ÿche
(
fže
 *file);

179 
dev_u£r_ÿ·c™y_chªged
(
fže
 *file);

180 
dev_u£r_´—Îoc_bufãr
(
fže
 *fže, 
__u£r
 *
¬g
);

181 
__dev_u£r_£t_Ýt
(
sc¡_u£r_dev
 *
dev
,

182 cÚ¡ 
sc¡_u£r_Ýt
 *
Ýt
);

183 
dev_u£r_£t_Ýt
(
fže
 *fže, cÚ¡ 
sc¡_u£r_Ýt
 *
Ýt
);

184 
dev_u£r_g‘_Ýt
(
fže
 *fže, 
__u£r
 *
¬g
);

186 
dev_u£r_pÞl
(
fže
 *
fžp
, 
pÞl_bË
 *
wa™
);

187 
dev_u£r_ioùl
(
fže
 *fže, 
cmd
,

188 
¬g
);

189 
dev_u£r_»Ëa£
(
šode
 *šode, 
fže
 *file);

190 
dev_u£r_ex™_dev
(
sc¡_u£r_dev
 *
dev
);

192 #ifdeà
CONFIG_SCST_PROC


194 #ifdeà
CONFIG_SCST_DEBUG


195 
dev_u£r_»ad_´oc
(
£q_fže
 *
£q
,

196 
sc¡_dev_ty³
 *
dev_ty³
);

201 
ssize_t
 
dev_u£r_sysfs_commªds_show
(
kobjeù
 *
kobj
,

202 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

204 
kobj_©Œibu‹
 
	gdev_u£r_commªds_©Œ
 =

205 
__ATTR
(
commªds
, 
S_IRUGO
, 
dev_u£r_sysfs_commªds_show
, 
NULL
);

207 cÚ¡ 
©Œibu‹
 *
	gdev_u£r_dev_©Œs
[] = {

208 &
dev_u£r_commªds_©Œ
.
©Œ
,

209 
NULL
,

214 
dev_u¤_·r£
(
sc¡_cmd
 *
cmd
);

218 
kmem_ÿche
 *
	gu£r_dev_ÿch•
;

220 
kmem_ÿche
 *
	gu£r_cmd_ÿch•
;

222 cÚ¡ 
fže_Ý”©iÚs
 
	gdev_u£r_fÝs
 = {

223 .
pÞl
 = 
dev_u£r_pÞl
,

224 .
	guÆocked_ioùl
 = 
dev_u£r_ioùl
,

225 #ifdeà
CONFIG_COMPAT


226 .
	gcom·t_ioùl
 = 
dev_u£r_ioùl
,

228 .
	g»Ëa£
 = 
dev_u£r_»Ëa£
,

231 
sc¡_dev_ty³
 
	gdev_u£r_devty³
 = {

232 .
Çme
 = 
DEV_USER_NAME
,

233 .
	gty³
 = -1,

234 .
	g·r£
 = 
dev_u¤_·r£
,

235 #ià
defšed
(
CONFIG_SCST_PROC
è&& defšed(
CONFIG_SCST_DEBUG
)

236 .
	g»ad_´oc
 = 
dev_u£r_»ad_´oc
,

238 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

239 .
	gdeçuÉ_Œaû_æags
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
,

240 .
	gŒaû_æags
 = &
Œaû_æag
,

244 
	gdev_u£r_majÜ
;

246 
þass
 *
	gdev_u£r_sysfs_þass
;

248 
DEFINE_SPINLOCK
(
dev_li¡_lock
);

249 
LIST_HEAD
(
dev_li¡
);

251 
DEFINE_SPINLOCK
(
þ—nup_lock
);

252 
LIST_HEAD
(
þ—nup_li¡
);

253 
DECLARE_WAIT_QUEUE_HEAD
(
þ—nup_li¡_wa™Q
);

254 
sk_¡ruù
 *
	gþ—nup_th»ad
;

260 
šlše
 
boÞ
 
	$ucmd_g‘_check
(
sc¡_u£r_cmd
 *
ucmd
)

262 
r
 = 
	`©omic_šc_»tuº
(&
ucmd
->
ucmd_»f
);

263 
»s
;

265 ià(
	`uÆik–y
(
r
 == 1)) {

266 
	`TRACE_DBG
("ucmd %°i bešg de¡royed", 
ucmd
);

267 
	`©omic_dec
(&
ucmd
->
ucmd_»f
);

268 
»s
 = 
Œue
;

274 
	`TRACE_DBG
("ucmd %p,‚ew„ef_úˆ%d", 
ucmd
,

275 
	`©omic_»ad
(&
ucmd
->
ucmd_»f
));

276 
»s
 = 
çl£
;

278  
»s
;

279 
	}
}

281 
šlše
 
	$ucmd_g‘
(
sc¡_u£r_cmd
 *
ucmd
)

283 
	`TRACE_DBG
("ucmd %p, ucmd_»à%d", 
ucmd
, 
	`©omic_»ad
(&ucmd->
ucmd_»f
));

284 
	`©omic_šc
(&
ucmd
->
ucmd_»f
);

289 
	`smp_mb__aá”_©omic_šc
();

290 
	}
}

293 
šlše
 
	$ucmd_put
(
sc¡_u£r_cmd
 *
ucmd
)

295 
	`TRACE_DBG
("ucmd %p, ucmd_»à%d", 
ucmd
, 
	`©omic_»ad
(&ucmd->
ucmd_»f
));

297 
	`EXTRACHECKS_BUG_ON
(
	`©omic_»ad
(&
ucmd
->
ucmd_»f
) == 0);

299 ià(
	`©omic_dec_ªd_‹¡
(&
ucmd
->
ucmd_»f
))

300 
	`dev_u£r_ä“_ucmd
(
ucmd
);

301 
	}
}

303 
šlše
 
	$ÿlc_num_pg
(
buf
, 
Ën
)

305 
Ën
 +ð
buf
 & ~
PAGE_MASK
;

306  (
Ën
 >> 
PAGE_SHIFT
è+ (Ö’ & ~
PAGE_MASK
) != 0);

307 
	}
}

309 
	$__dev_u£r_nÙ_»g
()

311 
	`TRACE_MGMT_DBG
("%s", "Device‚ot„egistered");

313 
	}
}

315 
šlše
 
	$dev_u£r_check_»g
(
sc¡_u£r_dev
 *
dev
)

317 ià(
dev
 =ð
NULL
) {

318 
	`__dev_u£r_nÙ_»g
();

319  -
ENODEV
;

322 
	}
}

324 
šlše
 
	$sc¡_u£r_cmd_hashâ
(
h
)

326  
h
 & ((1 << 
DEV_USER_CMD_HASH_ORDER
) - 1);

327 
	}
}

329 
šlše
 
sc¡_u£r_cmd
 *
	$__ucmd_fšd_hash
(
sc¡_u£r_dev
 *
dev
,

330 
h
)

332 
li¡_h—d
 *
h—d
;

333 
sc¡_u£r_cmd
 *
ucmd
;

335 
h—d
 = &
dev
->
ucmd_hash
[
	`sc¡_u£r_cmd_hashâ
(
h
)];

336 
	`li¡_fÜ_—ch_’Œy
(
ucmd
, 
h—d
, 
hash_li¡_’Œy
) {

337 ià(
ucmd
->
h
 == h) {

338 
	`TRACE_DBG
("Found ucmd %p", 
ucmd
);

339  
ucmd
;

342  
NULL
;

343 
	}
}

345 
	$cmd_š£¹_hash
(
sc¡_u£r_cmd
 *
ucmd
)

347 
li¡_h—d
 *
h—d
;

348 
sc¡_u£r_dev
 *
dev
 = 
ucmd
->dev;

349 
sc¡_u£r_cmd
 *
u
;

350 
æags
;

352 
	`¥š_lock_œq§ve
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
, 
æags
);

354 
ucmd
->
h
 = 
dev
->
hªdË_couÁ”
++;

355 
u
 = 
	`__ucmd_fšd_hash
(
dev
, 
ucmd
->
h
);

356 } 
u
 !ð
NULL
);

357 
h—d
 = &
dev
->
ucmd_hash
[
	`sc¡_u£r_cmd_hashâ
(
ucmd
->
h
)];

358 
	`li¡_add_ž
(&
ucmd
->
hash_li¡_’Œy
, 
h—d
);

359 
	`¥š_uÆock_œq»¡Üe
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
, 
æags
);

361 
	`TRACE_DBG
("In£¹ed ucmd %p, h=%d (dev %s)", 
ucmd
, ucmd->
h
, 
dev
->
Çme
);

363 
	}
}

365 
šlše
 
	$cmd_»move_hash
(
sc¡_u£r_cmd
 *
ucmd
)

367 
æags
;

369 
	`¥š_lock_œq§ve
(&
ucmd
->
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
, 
æags
);

370 
	`li¡_d–
(&
ucmd
->
hash_li¡_’Œy
);

371 
	`¥š_uÆock_œq»¡Üe
(&
ucmd
->
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
, 
æags
);

373 
	`TRACE_DBG
("Removed ucmd %p, h=%d", 
ucmd
, ucmd->
h
);

375 
	}
}

377 
	$dev_u£r_ä“_ucmd
(
sc¡_u£r_cmd
 *
ucmd
)

379 
	`TRACE_ENTRY
();

381 
	`TRACE_MEM
("F»ešg ucmd %p", 
ucmd
);

383 
	`cmd_»move_hash
(
ucmd
);

384 
	`EXTRACHECKS_BUG_ON
(
ucmd
->
cmd
 !ð
NULL
);

386 
	`kmem_ÿche_ä“
(
u£r_cmd_ÿch•
, 
ucmd
);

388 
	`TRACE_EXIT
();

390 
	}
}

392 
·ge
 *
	$dev_u£r_®loc_·ges
(
sÿ‰”li¡
 *
sg
,

393 
gå_t
 
gå_mask
, *
´iv
)

395 
sc¡_u£r_cmd
 *
ucmd
 = 
´iv
;

396 
off£t
 = 0;

398 
	`TRACE_ENTRY
();

402 
	`TRACE_MEM
("ucmd %p, ubufà%lx, ucmd->cur_d©a_·g%d", 
ucmd
,

403 
ucmd
->
ubuff
, ucmd->
cur_d©a_·ge
);

405 ià(
ucmd
->
cur_d©a_·ge
 == 0) {

406 
	`TRACE_MEM
("ucmd->first_page_offset %d",

407 
ucmd
->
fœ¡_·ge_off£t
);

408 
off£t
 = 
ucmd
->
fœ¡_·ge_off£t
;

409 
	`ucmd_g‘
(
ucmd
);

412 ià(
ucmd
->
cur_d©a_·ge
 >ðucmd->
num_d©a_·ges
)

413 
out
;

415 
	`sg_£t_·ge
(
sg
, 
ucmd
->
d©a_·ges
[ucmd->
cur_d©a_·ge
],

416 
PAGE_SIZE
 - 
off£t
, offset);

417 
ucmd
->
cur_d©a_·ge
++;

419 
	`TRACE_MEM
("·ge=%p,†’gth=%d, off£t=%d", 
	`sg_·ge
(
sg
), sg->
Ëngth
,

420 
sg
->
off£t
);

421 
	`TRACE_BUFFER
("Pagd©a", 
	`sg_vœt
(
sg
), sg->
Ëngth
);

423 
out
:

424 
	`TRACE_EXIT
();

425  
	`sg_·ge
(
sg
);

426 
	}
}

428 
	$dev_u£r_Ú_ÿched_mem_ä“
(
sc¡_u£r_cmd
 *
ucmd
)

430 
	`TRACE_ENTRY
();

432 
	`TRACE_MEM
("Preparing ON_CACHED_MEM_FREE (ucmd %p, h %d, ubuff %lx)",

433 
ucmd
, ucmd->
h
, ucmd->
ubuff
);

435 
ucmd
->
u£r_cmd_·ylßd_Ën
 =

436 
	`off£tof
(
sc¡_u£r_g‘_cmd
, 
Ú_ÿched_mem_ä“
) +

437 (
ucmd
->
u£r_cmd
.
Ú_ÿched_mem_ä“
);

438 
ucmd
->
u£r_cmd
.
cmd_h
 = ucmd->
h
;

439 
ucmd
->
u£r_cmd
.
subcode
 = 
SCST_USER_ON_CACHED_MEM_FREE
;

440 
ucmd
->
u£r_cmd
.
Ú_ÿched_mem_ä“
.
pbuf
 = ucmd->
ubuff
;

442 
ucmd
->
¡©e
 = 
UCMD_STATE_ON_CACHE_FREEING
;

444 
	`dev_u£r_add_to_»ady
(
ucmd
);

446 
	`TRACE_EXIT
();

448 
	}
}

450 
	$dev_u£r_unm­_buf
(
sc¡_u£r_cmd
 *
ucmd
)

452 
i
;

454 
	`TRACE_ENTRY
();

456 
	`TRACE_MEM
("Unm­pšg d©¨·ge (ucmd %p, ubufà%lx,‚um %d)", 
ucmd
,

457 
ucmd
->
ubuff
, ucmd->
num_d©a_·ges
);

459 
i
 = 0; i < 
ucmd
->
num_d©a_·ges
; i++) {

460 
·ge
 *·gð
ucmd
->
d©a_·ges
[
i
];

462 ià(
ucmd
->
buf_dœty
)

463 
	`S‘PageDœty
(
·ge
);

465 
	`·ge_ÿche_»Ëa£
(
·ge
);

468 
	`kä“
(
ucmd
->
d©a_·ges
);

469 
ucmd
->
d©a_·ges
 = 
NULL
;

471 
	`TRACE_EXIT
();

473 
	}
}

475 
	$__dev_u£r_ä“_sg_’Œ›s
(
sc¡_u£r_cmd
 *
ucmd
)

477 
	`TRACE_ENTRY
();

479 
	`sBUG_ON
(
ucmd
->
d©a_·ges
 =ð
NULL
);

481 
	`TRACE_MEM
("Freeing data…ages (ucmd=%p, ubuff=%lx, buff_cached=%d)",

482 
ucmd
, ucmd->
ubuff
, ucmd->
buff_ÿched
);

484 
	`dev_u£r_unm­_buf
(
ucmd
);

486 ià(
ucmd
->
buff_ÿched
)

487 
	`dev_u£r_Ú_ÿched_mem_ä“
(
ucmd
);

489 
	`ucmd_put
(
ucmd
);

491 
	`TRACE_EXIT
();

493 
	}
}

495 
	$dev_u£r_ä“_sg_’Œ›s
(
sÿ‰”li¡
 *
sg
, 
sg_couÁ
,

496 *
´iv
)

498 
sc¡_u£r_cmd
 *
ucmd
 = 
´iv
;

500 
	`TRACE_MEM
("F»ešg d©¨·ge (sg=%p, sg_couÁ=%d,…riv %p)", 
sg
,

501 
sg_couÁ
, 
ucmd
);

503 
	`__dev_u£r_ä“_sg_’Œ›s
(
ucmd
);

506 
	}
}

508 
šlše
 
	$is_buff_ÿched
(
sc¡_u£r_cmd
 *
ucmd
)

510 
mem_»u£_ty³
 = 
ucmd
->
dev
->
memÜy_»u£_ty³
;

512 ià((
mem_»u£_ty³
 =ð
SCST_USER_MEM_REUSE_ALL
) ||

513 ((
ucmd
->
cmd
->
d©a_dœeùiÚ
 =ð
SCST_DATA_READ
) &&

514 (
mem_»u£_ty³
 =ð
SCST_USER_MEM_REUSE_READ
)) ||

515 ((
ucmd
->
cmd
->
d©a_dœeùiÚ
 =ð
SCST_DATA_WRITE
) &&

516 (
mem_»u£_ty³
 =ð
SCST_USER_MEM_REUSE_WRITE
)))

520 
	}
}

522 
šlše
 
	$is_Ãed_offs_·ge
(
buf
, 
Ën
)

524  ((
buf
 & ~
PAGE_MASK
) != 0) &&

525 ((
buf
 & 
PAGE_MASK
è!ð((buf+
Ën
-1) & PAGE_MASK));

526 
	}
}

532 
	$dev_u£r_®loc_sg
(
sc¡_u£r_cmd
 *
ucmd
, 
ÿched_buff
)

534 
»s
 = 0;

535 
sc¡_cmd
 *
cmd
 = 
ucmd
->cmd;

536 
sc¡_u£r_dev
 *
dev
 = 
ucmd
->dev;

537 
sgv_poÞ
 *
poÞ
;

538 
gå_t
 
gå_mask
;

539 
æags
 = 0;

540 
bufæ’
, 
Üig_bufæ’
;

541 
Ï¡_Ën
 = 0;

542 
out_sg_·ges
 = 0;

544 
	`TRACE_ENTRY
();

546 
gå_mask
 = 
__GFP_NOWARN
;

547 
gå_mask
 |ð(
	`sc¡_cmd_©omic
(
cmd
è? 
GFP_ATOMIC
 : 
GFP_KERNEL
);

549 ià(
cmd
->
d©a_dœeùiÚ
 !ð
SCST_DATA_BIDI
) {

550 
Üig_bufæ’
 = 
cmd
->
bufæ’
;

551 
poÞ
 = 
cmd
->
tgt_dev
->
dh_´iv
;

554 
Ën
 = 
cmd
->
bufæ’
 + 
ucmd
->
fœ¡_·ge_off£t
;

556 
out_sg_·ges
 = (
Ën
 >> 
PAGE_SHIFT
è+ (Ö’ & ~
PAGE_MASK
) != 0);

557 
Üig_bufæ’
 = (
out_sg_·ges
 << 
PAGE_SHIFT
è+ 
cmd
->
out_bufæ’
;

558 
poÞ
 = 
dev
->pool;

560 
bufæ’
 = 
Üig_bufæ’
;

562 
	`EXTRACHECKS_BUG_ON
(
bufæ’
 == 0);

564 ià(
ÿched_buff
) {

565 
æags
 |ð
SGV_POOL_RETURN_OBJ_ON_ALLOC_FAIL
;

566 ià(
ucmd
->
ubuff
 == 0)

567 
æags
 |ð
SGV_POOL_NO_ALLOC_ON_CACHE_MISS
;

569 
	`TRACE_MEM
("%s", "Not cached buff");

570 
æags
 |ð
SGV_POOL_ALLOC_NO_CACHED
;

571 ià(
ucmd
->
ubuff
 == 0) {

572 
»s
 = 1;

573 
out
;

575 
bufæ’
 +ð
ucmd
->
fœ¡_·ge_off£t
;

576 ià(
	`is_Ãed_offs_·ge
(
ucmd
->
ubuff
, 
Üig_bufæ’
))

577 
Ï¡_Ën
 = 
bufæ’
 & ~
PAGE_MASK
;

579 
Ï¡_Ën
 = 
Üig_bufæ’
 & ~
PAGE_MASK
;

581 
ucmd
->
buff_ÿched
 = 
ÿched_buff
;

583 
cmd
->
sg
 = 
	`sgv_poÞ_®loc
(
poÞ
, 
bufæ’
, 
gå_mask
, 
æags
, &cmd->
sg_út
,

584 &
ucmd
->
sgv
, &
dev
->
udev_mem_lim
, ucmd);

585 ià(
cmd
->
sg
 !ð
NULL
) {

586 
sc¡_u£r_cmd
 *
buf_ucmd
 = 
	`sgv_g‘_´iv
(
ucmd
->
sgv
);

588 
	`TRACE_MEM
("Buf ucmd %p (cmd->sg_cnt %d,†ast seg†en %d, "

589 "Ï¡_ËÀ%d, bufæ’ %d)", 
buf_ucmd
, 
cmd
->
sg_út
,

590 
cmd
->
sg
[cmd->
sg_út
-1].
Ëngth
, 
Ï¡_Ën
, 
bufæ’
);

592 
ucmd
->
ubuff
 = 
buf_ucmd
->ubuff;

593 
ucmd
->
buf_ucmd
 = buf_ucmd;

595 
	`EXTRACHECKS_BUG_ON
((
ucmd
->
d©a_·ges
 !ð
NULL
) &&

596 (
ucmd
 !ð
buf_ucmd
));

598 ià(
Ï¡_Ën
 != 0) {

599 
cmd
->
sg
[cmd->
sg_út
-1].
Ëngth
 &ð
PAGE_MASK
;

600 
cmd
->
sg
[cmd->
sg_út
-1].
Ëngth
 +ð
Ï¡_Ën
;

603 
	`TRACE_MEM
("Buf‡lloced (ucmd %p, cached_buff %d, ubuff %lx, "

604 "Ï¡ seg†’ %d)", 
ucmd
, 
ÿched_buff
, ucmd->
ubuff
,

605 
cmd
->
sg
[cmd->
sg_út
-1].
Ëngth
);

607 ià(
cmd
->
d©a_dœeùiÚ
 =ð
SCST_DATA_BIDI
) {

608 
cmd
->
out_sg
 = &cmd->
sg
[
out_sg_·ges
];

609 
cmd
->
out_sg_út
 = cmd->
sg_út
 - 
out_sg_·ges
;

610 
cmd
->
sg_út
 = 
out_sg_·ges
;

611 
	`TRACE_MEM
("cmd %p, out_sg %p, out_sg_cnt %d, sg_cnt %d",

612 
cmd
, cmd->
out_sg
, cmd->
out_sg_út
, cmd->
sg_út
);

615 ià(
	`uÆik–y
(
cmd
->
sg_út
 > cmd->
tgt_dev
->
max_sg_út
)) {

616 
Î
;

618 ià((
Î
 < 10è|| 
	`TRACING_MINOR
()) {

619 
	`PRINT_INFO
("Unableo complete command dueo "

622 
cmd
->
sg_út
, cmd->
tgt_dev
->
max_sg_út
,

623 
cmd
->
tgt
->
sg_bËsize
);

624 
Î
++;

626 
cmd
->
sg
 = 
NULL
;

628 
»s
 = -1;

631 
	`TRACE_MEM
("Buf‚ot‡lloced (ucmd %p, h %d, buff_cached, %d, "

632 "sg_úˆ%d, ubufà%lx, sgv %p", 
ucmd
, ucmd->
h
,

633 
ucmd
->
buff_ÿched
, 
cmd
->
sg_út
, ucmd->
ubuff
, ucmd->
sgv
);

634 ià(
	`uÆik–y
(
cmd
->
sg_út
 == 0)) {

635 
	`TRACE_MEM
("Refu£d‡ÎoÿtiÚ (ucmd %p)", 
ucmd
);

636 
	`sBUG_ON
(
ucmd
->
sgv
 !ð
NULL
);

637 
»s
 = -1;

639 
ucmd
->
¡©e
) {

640 
UCMD_STATE_BUF_ALLOCING
:

641 
»s
 = 1;

643 
UCMD_STATE_EXECING
:

644 
»s
 = -1;

647 
	`sBUG
();

653 
out
:

654 
	`TRACE_EXIT_RES
(
»s
);

655  
»s
;

656 
	}
}

658 
	$dev_u£r_®loc_¥aû
(
sc¡_u£r_cmd
 *
ucmd
)

660 
rc
, 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

661 
sc¡_cmd
 *
cmd
 = 
ucmd
->cmd;

663 
	`TRACE_ENTRY
();

665 
ucmd
->
¡©e
 = 
UCMD_STATE_BUF_ALLOCING
;

666 
	`sc¡_cmd_£t_dh_d©a_buff_®loûd
(
cmd
);

668 
rc
 = 
	`dev_u£r_®loc_sg
(
ucmd
, 
	`is_buff_ÿched
(ucmd));

669 ià(
rc
 == 0)

670 
out
;

671 ià(
rc
 < 0) {

672 
	`sc¡_£t_busy
(
cmd
);

673 
»s
 = 
	`sc¡_g‘_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

674 
out
;

677 ià(!(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
) &&

678 ((
cmd
->
Ý_æags
 & 
SCST_LOCAL_CMD
) == 0)) {

679 
	`TRACE_DBG
("D–ayed‡Îoc, ucmd %p", 
ucmd
);

680 
out
;

683 
ucmd
->
u£r_cmd_·ylßd_Ën
 =

684 
	`off£tof
(
sc¡_u£r_g‘_cmd
, 
®loc_cmd
) +

685 (
ucmd
->
u£r_cmd
.
®loc_cmd
);

686 
ucmd
->
u£r_cmd
.
cmd_h
 = ucmd->
h
;

687 
ucmd
->
u£r_cmd
.
subcode
 = 
SCST_USER_ALLOC_MEM
;

688 
ucmd
->
u£r_cmd
.
®loc_cmd
.
£ss_h
 = ()
cmd
->
tgt_dev
;

689 
	`memýy
(
ucmd
->
u£r_cmd
.
®loc_cmd
.
cdb
, 
cmd
->cdb,

690 
	`mš_t
(, 
SCST_MAX_CDB_SIZE
, 
cmd
->
cdb_Ën
));

691 
ucmd
->
u£r_cmd
.
®loc_cmd
.
cdb_Ën
 = 
cmd
->cdb_len;

692 
ucmd
->
u£r_cmd
.
®loc_cmd
.
®loc_Ën
 = ucmd->
buff_ÿched
 ?

693 (
cmd
->
sg_út
 << 
PAGE_SHIFT
è: cmd->
bufæ’
;

694 
ucmd
->
u£r_cmd
.
®loc_cmd
.
queue_ty³
 = 
cmd
->queue_type;

695 
ucmd
->
u£r_cmd
.
®loc_cmd
.
d©a_dœeùiÚ
 = 
cmd
->data_direction;

696 
ucmd
->
u£r_cmd
.
®loc_cmd
.
¢
 = 
cmd
->
tgt_¢
;

698 
	`TRACE_DBG
("Preparing ALLOC_MEM for user space (ucmd=%p, h=%d, "

699 "®loc_ËÀ%d)", 
ucmd
, ucmd->
h
, ucmd->
u£r_cmd
.
®loc_cmd
.
®loc_Ën
);

701 
	`dev_u£r_add_to_»ady
(
ucmd
);

703 
»s
 = 
SCST_CMD_STATE_STOP
;

705 
out
:

706 
	`TRACE_EXIT_RES
(
»s
);

707  
»s
;

708 
	}
}

710 
sc¡_u£r_cmd
 *
	$dev_u£r_®loc_ucmd
(
sc¡_u£r_dev
 *
dev
,

711 
gå_t
 
gå_mask
)

713 
sc¡_u£r_cmd
 *
ucmd
 = 
NULL
;

715 
	`TRACE_ENTRY
();

717 
ucmd
 = 
	`kmem_ÿche_z®loc
(
u£r_cmd_ÿch•
, 
gå_mask
);

718 ià(
	`uÆik–y
(
ucmd
 =ð
NULL
)) {

719 
	`TRACE
(
TRACE_OUT_OF_MEM
, "Unableo‡llocate "

720 "u£¸cmd (gå_mask %x)", 
gå_mask
);

721 
out
;

723 
ucmd
->
dev
 = dev;

724 
	`©omic_£t
(&
ucmd
->
ucmd_»f
, 1);

726 
	`cmd_š£¹_hash
(
ucmd
);

728 
	`TRACE_MEM
("ucmd %°®loÿ‹d", 
ucmd
);

730 
out
:

731 
	`TRACE_EXIT_HRES
(()
ucmd
);

732  
ucmd
;

733 
	}
}

735 
	$dev_u£r_·r£
(
sc¡_cmd
 *
cmd
)

737 
rc
, 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

738 
sc¡_u£r_cmd
 *
ucmd
;

739 
©omic
 = 
	`sc¡_cmd_©omic
(
cmd
);

740 
sc¡_u£r_dev
 *
dev
 = 
cmd
->dev->
dh_´iv
;

741 
gå_t
 
gå_mask
 = 
©omic
 ? 
GFP_ATOMIC
 : 
GFP_KERNEL
;

743 
	`TRACE_ENTRY
();

745 ià(
cmd
->
dh_´iv
 =ð
NULL
) {

746 
ucmd
 = 
	`dev_u£r_®loc_ucmd
(
dev
, 
gå_mask
);

747 ià(
	`uÆik–y
(
ucmd
 =ð
NULL
)) {

748 ià(
©omic
) {

749 
»s
 = 
SCST_CMD_STATE_NEED_THREAD_CTX
;

750 
out
;

752 
	`sc¡_£t_busy
(
cmd
);

753 
out_”rÜ
;

756 
ucmd
->
cmd
 = cmd;

757 
cmd
->
dh_´iv
 = 
ucmd
;

759 
ucmd
 = 
cmd
->
dh_´iv
;

760 
	`TRACE_DBG
("U£d ucmd %p, s‹ %x", 
ucmd
, ucmd->
¡©e
);

763 
	`TRACE_DBG
("ucmd %p, cmd %p, s‹ %x", 
ucmd
, 
cmd
, ucmd->
¡©e
);

765 ià(
ucmd
->
¡©e
 =ð
UCMD_STATE_PARSING
) {

767 
dÚe
;

770 
	`EXTRACHECKS_BUG_ON
(
ucmd
->
¡©e
 !ð
UCMD_STATE_NEW
);

772 
dev
->
·r£_ty³
) {

773 
SCST_USER_PARSE_STANDARD
:

774 
	`TRACE_DBG
("PARSE STANDARD: ucmd %p", 
ucmd
);

775 
rc
 = 
dev
->
	`g’”ic_·r£
(
cmd
);

776 ià(
rc
 != 0) {

777 
	`PRINT_ERROR
("PARSE fažed (ucmd %p,„ø%d)", 
ucmd
, 
rc
);

778 
out_”rÜ
;

782 
SCST_USER_PARSE_EXCEPTION
:

783 
	`TRACE_DBG
("PARSE EXCEPTION: ucmd %p", 
ucmd
);

784 
rc
 = 
dev
->
	`g’”ic_·r£
(
cmd
);

785 ià((
rc
 =ð0è&& (
cmd
->
Ý_æags
 & 
SCST_INFO_VALID
))

787 ià(
rc
 =ð
SCST_CMD_STATE_NEED_THREAD_CTX
) {

788 
	`TRACE_MEM
("Restarting PARSEohread context "

789 "(ucmd %p)", 
ucmd
);

790 
»s
 = 
SCST_CMD_STATE_NEED_THREAD_CTX
;

791 
out
;

795 
SCST_USER_PARSE_CALL
:

796 
	`TRACE_DBG
("Preparing PARSE for user space (ucmd=%p, h=%d, "

797 "bufæ’ %d)", 
ucmd
, ucmd->
h
, 
cmd
->
bufæ’
);

798 
ucmd
->
u£r_cmd_·ylßd_Ën
 =

799 
	`off£tof
(
sc¡_u£r_g‘_cmd
, 
·r£_cmd
) +

800 (
ucmd
->
u£r_cmd
.
·r£_cmd
);

801 
ucmd
->
u£r_cmd
.
cmd_h
 = ucmd->
h
;

802 
ucmd
->
u£r_cmd
.
subcode
 = 
SCST_USER_PARSE
;

803 
ucmd
->
u£r_cmd
.
·r£_cmd
.
£ss_h
 = ()
cmd
->
tgt_dev
;

804 
	`memýy
(
ucmd
->
u£r_cmd
.
·r£_cmd
.
cdb
, 
cmd
->cdb,

805 
	`mš_t
(, 
SCST_MAX_CDB_SIZE
, 
cmd
->
cdb_Ën
));

806 
ucmd
->
u£r_cmd
.
·r£_cmd
.
cdb_Ën
 = 
cmd
->cdb_len;

807 
ucmd
->
u£r_cmd
.
·r£_cmd
.
timeout
 = 
cmd
->timeouˆ/ 
HZ
;

808 
ucmd
->
u£r_cmd
.
·r£_cmd
.
lba
 = 
cmd
->lba;

809 
ucmd
->
u£r_cmd
.
·r£_cmd
.
bufæ’
 = 
cmd
->bufflen;

810 
ucmd
->
u£r_cmd
.
·r£_cmd
.
d©a_Ën
 = 
cmd
->data_len;

811 
ucmd
->
u£r_cmd
.
·r£_cmd
.
out_bufæ’
 = 
cmd
->out_bufflen;

812 
ucmd
->
u£r_cmd
.
·r£_cmd
.
queue_ty³
 = 
cmd
->queue_type;

813 
ucmd
->
u£r_cmd
.
·r£_cmd
.
d©a_dœeùiÚ
 = 
cmd
->data_direction;

814 
ucmd
->
u£r_cmd
.
·r£_cmd
.
ex³ùed_v®ues_£t
 =

815 
cmd
->
ex³ùed_v®ues_£t
;

816 
ucmd
->
u£r_cmd
.
·r£_cmd
.
ex³ùed_d©a_dœeùiÚ
 =

817 
cmd
->
ex³ùed_d©a_dœeùiÚ
;

818 
ucmd
->
u£r_cmd
.
·r£_cmd
.
ex³ùed_Œªsãr_Ën
 =

819 
cmd
->
ex³ùed_Œªsãr_Ën_fuÎ
;

820 
ucmd
->
u£r_cmd
.
·r£_cmd
.
ex³ùed_out_Œªsãr_Ën
 =

821 
cmd
->
ex³ùed_out_Œªsãr_Ën
;

822 
ucmd
->
u£r_cmd
.
·r£_cmd
.
¢
 = 
cmd
->
tgt_¢
;

823 
ucmd
->
u£r_cmd
.
·r£_cmd
.
Ý_æags
 = 
cmd
->op_flags;

824 
ucmd
->
¡©e
 = 
UCMD_STATE_PARSING
;

825 
	`dev_u£r_add_to_»ady
(
ucmd
);

826 
»s
 = 
SCST_CMD_STATE_STOP
;

827 
out
;

830 
	`sBUG
();

833 
dÚe
:

834 ià(
cmd
->
bufæ’
 == 0) {

839 
cmd
->
d©a_dœeùiÚ
 = 
SCST_DATA_NONE
;

842 
out
:

843 
	`TRACE_EXIT_RES
(
»s
);

844  
»s
;

846 
out_”rÜ
:

847 
»s
 = 
	`sc¡_g‘_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

848 
out
;

849 
	}
}

851 
	$dev_u£r_®loc_d©a_buf
(
sc¡_cmd
 *
cmd
)

853 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

854 
sc¡_u£r_cmd
 *
ucmd
 = 
cmd
->
dh_´iv
;

856 
	`TRACE_ENTRY
();

858 
	`EXTRACHECKS_BUG_ON
((
ucmd
->
¡©e
 !ð
UCMD_STATE_NEW
) &&

859 (
ucmd
->
¡©e
 !ð
UCMD_STATE_PARSING
) &&

860 (
ucmd
->
¡©e
 !ð
UCMD_STATE_BUF_ALLOCING
));

862 
»s
 = 
	`dev_u£r_®loc_¥aû
(
ucmd
);

864 
	`TRACE_EXIT_RES
(
»s
);

865  
»s
;

866 
	}
}

868 
	$dev_u£r_æush_dÿche
(
sc¡_u£r_cmd
 *
ucmd
)

870 
sc¡_u£r_cmd
 *
buf_ucmd
 = 
ucmd
->buf_ucmd;

871 
¡¬t
 = 
buf_ucmd
->
ubuff
;

872 
i
, 
bufæ’
 = 
ucmd
->
cmd
->bufflen;

874 
	`TRACE_ENTRY
();

876 ià(
¡¬t
 == 0)

877 
out
;

889 
i
 = 0; (
bufæ’
 > 0è&& (˜< 
buf_ucmd
->
num_d©a_·ges
); i++) {

890 
·ge
 *·g
	`__©Œibu‹__
((
unu£d
));

892 
·ge
 = 
buf_ucmd
->
d©a_·ges
[
i
];

893 #ifdeà
ARCH_HAS_FLUSH_ANON_PAGE


894 
vm_¬—_¡ruù
 *
vma
 = 
	`fšd_vma
(
cu¼’t
->
mm
, 
¡¬t
);

896 ià(
vma
 !ð
NULL
)

897 
	`æush_ªÚ_·ge
(
vma
, 
·ge
, 
¡¬t
);

899 
	`æush_dÿche_·ge
(
·ge
);

900 
¡¬t
 +ð
PAGE_SIZE
;

901 
bufæ’
 -ð
PAGE_SIZE
;

904 
out
:

905 
	`TRACE_EXIT
();

907 
	}
}

909 
	$dev_u£r_exec
(
sc¡_cmd
 *
cmd
)

911 
sc¡_u£r_cmd
 *
ucmd
 = 
cmd
->
dh_´iv
;

912 
»s
 = 
SCST_EXEC_COMPLETED
;

914 
	`TRACE_ENTRY
();

916 
	`TRACE_DBG
("Preparing EXEC for user space (ucmd=%p, h=%d,†ba %lld, "

917 "bufæ’ %d, d©a_ËÀ%Îd, ubufà%lx)", 
ucmd
, ucmd->
h
,

918 ()
cmd
->
lba
, cmd->
bufæ’
, ()cmd->
d©a_Ën
,

919 
ucmd
->
ubuff
);

921 ià(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
)

922 
	`dev_u£r_æush_dÿche
(
ucmd
);

924 
ucmd
->
u£r_cmd_·ylßd_Ën
 =

925 
	`off£tof
(
sc¡_u£r_g‘_cmd
, 
exec_cmd
) +

926 (
ucmd
->
u£r_cmd
.
exec_cmd
);

927 
ucmd
->
u£r_cmd
.
cmd_h
 = ucmd->
h
;

928 
ucmd
->
u£r_cmd
.
subcode
 = 
SCST_USER_EXEC
;

929 
ucmd
->
u£r_cmd
.
exec_cmd
.
£ss_h
 = ()
cmd
->
tgt_dev
;

930 
	`memýy
(
ucmd
->
u£r_cmd
.
exec_cmd
.
cdb
, 
cmd
->cdb,

931 
	`mš_t
(, 
SCST_MAX_CDB_SIZE
, 
cmd
->
cdb_Ën
));

932 
ucmd
->
u£r_cmd
.
exec_cmd
.
cdb_Ën
 = 
cmd
->cdb_len;

933 
ucmd
->
u£r_cmd
.
exec_cmd
.
lba
 = 
cmd
->lba;

934 
ucmd
->
u£r_cmd
.
exec_cmd
.
bufæ’
 = 
cmd
->bufflen;

935 
ucmd
->
u£r_cmd
.
exec_cmd
.
d©a_Ën
 = 
cmd
->data_len;

936 
ucmd
->
u£r_cmd
.
exec_cmd
.
pbuf
 = ucmd->
ubuff
;

937 ià((
ucmd
->
ubuff
 =ð0è&& (
cmd
->
d©a_dœeùiÚ
 !ð
SCST_DATA_NONE
)) {

938 
ucmd
->
u£r_cmd
.
exec_cmd
.
®loc_Ën
 = ucmd->
buff_ÿched
 ?

939 (
cmd
->
sg_út
 << 
PAGE_SHIFT
è: cmd->
bufæ’
;

941 
ucmd
->
u£r_cmd
.
exec_cmd
.
queue_ty³
 = 
cmd
->queue_type;

942 
ucmd
->
u£r_cmd
.
exec_cmd
.
d©a_dœeùiÚ
 = 
cmd
->data_direction;

943 
ucmd
->
u£r_cmd
.
exec_cmd
.
·¹Ÿl
 = 0;

944 
ucmd
->
u£r_cmd
.
exec_cmd
.
timeout
 = 
cmd
->timeouˆ/ 
HZ
;

945 
ucmd
->
u£r_cmd
.
exec_cmd
.
p_out_buf
 = ucmd->
ubuff
 +

946 (
cmd
->
sg_út
 << 
PAGE_SHIFT
);

947 
ucmd
->
u£r_cmd
.
exec_cmd
.
out_bufæ’
 = 
cmd
->out_bufflen;

948 
ucmd
->
u£r_cmd
.
exec_cmd
.
¢
 = 
cmd
->
tgt_¢
;

950 
ucmd
->
¡©e
 = 
UCMD_STATE_EXECING
;

952 
	`dev_u£r_add_to_»ady
(
ucmd
);

954 
	`TRACE_EXIT_RES
(
»s
);

955  
»s
;

956 
	}
}

958 #iâdeà
CONFIG_SCST_PROC


959 
	$dev_u£r_ext_cÝy_»m­
(
sc¡_cmd
 *
cmd
,

960 
sc¡_ext_cÝy_£g_desü
 *
£g
)

962 
sc¡_u£r_cmd
 *
ucmd
 = 
cmd
->
dh_´iv
;

964 
	`TRACE_ENTRY
();

966 
	`TRACE_DBG
("Preparing EXT_COPY_REMAP for user space (ucmd=%p, h=%d, "

967 "£g %p)", 
ucmd
, ucmd->
h
, 
£g
);

969 
ucmd
->
u£r_cmd_·ylßd_Ën
 =

970 
	`off£tof
(
sc¡_u£r_g‘_cmd
, 
»m­_cmd
) +

971 (
ucmd
->
u£r_cmd
.
»m­_cmd
);

972 
ucmd
->
u£r_cmd
.
cmd_h
 = ucmd->
h
;

973 
ucmd
->
u£r_cmd
.
subcode
 = 
SCST_USER_EXT_COPY_REMAP
;

974 
ucmd
->
u£r_cmd
.
»m­_cmd
.
£ss_h
 = ()
cmd
->
tgt_dev
;

976 
ucmd
->
u£r_cmd
.
»m­_cmd
.
¤c_£ss_h
 = ()
£g
->
¤c_tgt_dev
;

977 
ucmd
->
u£r_cmd
.
»m­_cmd
.
d¡_£ss_h
 = ()
£g
->
d¡_tgt_dev
;

978 
ucmd
->
u£r_cmd
.
»m­_cmd
.
d©a_desü
.
¤c_lba
 = 
£g
->data_descr.src_lba;

979 
ucmd
->
u£r_cmd
.
»m­_cmd
.
d©a_desü
.
d¡_lba
 = 
£g
->data_descr.dst_lba;

980 
ucmd
->
u£r_cmd
.
»m­_cmd
.
d©a_desü
.
d©a_Ën
 = 
£g
->data_descr.data_len;

982 
ucmd
->
¡©e
 = 
UCMD_STATE_EXT_COPY_REMAPPING
;

984 
	`dev_u£r_add_to_»ady
(
ucmd
);

986 
	`TRACE_EXIT
();

988 
	}
}

991 
	$dev_u£r_ä“_sgv
(
sc¡_u£r_cmd
 *
ucmd
)

993 ià(
ucmd
->
sgv
 !ð
NULL
) {

994 
	`sgv_poÞ_ä“
(
ucmd
->
sgv
, &ucmd->
dev
->
udev_mem_lim
);

995 
ucmd
->
sgv
 = 
NULL
;

996 } ià(
ucmd
->
d©a_·ges
 !ð
NULL
) {

998 
	`ucmd_g‘
(
ucmd
);

999 
	`__dev_u£r_ä“_sg_’Œ›s
(
ucmd
);

1002 
	}
}

1004 
	$dev_u£r_Ú_ä“_cmd
(
sc¡_cmd
 *
cmd
)

1006 
sc¡_u£r_cmd
 *
ucmd
 = 
cmd
->
dh_´iv
;

1008 
	`TRACE_ENTRY
();

1010 ià(
	`uÆik–y
(
ucmd
 =ð
NULL
))

1011 
out
;

1013 
	`TRACE_MEM
("ucmd %p, cmd %p, buff_ÿched %d, ubufà%lx", 
ucmd
, ucmd->
cmd
,

1014 
ucmd
->
buff_ÿched
, ucmd->
ubuff
);

1016 
ucmd
->
cmd
 = 
NULL
;

1017 ià((
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
è&& 
ucmd
->
buf_ucmd
 !ð
NULL
)

1018 
ucmd
->
buf_ucmd
->
buf_dœty
 = 1;

1020 ià(
ucmd
->
dev
->
Ú_ä“_cmd_ty³
 =ð
SCST_USER_ON_FREE_CMD_IGNORE
) {

1021 
ucmd
->
¡©e
 = 
UCMD_STATE_ON_FREE_SKIPPED
;

1023 
out_»¶y
;

1026 ià(
	`uÆik–y
(!
ucmd
->
£’_by_u£r
)) {

1027 
	`TRACE_MGMT_DBG
("NÙ s“Àby u£¸ucmd %p", 
ucmd
);

1028 
out_»¶y
;

1031 
	`TRACE_DBG
("P»·ršg ON_FREE_CMD (pbufà0x%lx)", 
ucmd
->
ubuff
);

1032 
ucmd
->
u£r_cmd_·ylßd_Ën
 =

1033 
	`off£tof
(
sc¡_u£r_g‘_cmd
, 
Ú_ä“_cmd
) +

1034 (
ucmd
->
u£r_cmd
.
Ú_ä“_cmd
);

1035 
ucmd
->
u£r_cmd
.
cmd_h
 = ucmd->
h
;

1036 
ucmd
->
u£r_cmd
.
subcode
 = 
SCST_USER_ON_FREE_CMD
;

1037 
ucmd
->
u£r_cmd
.
Ú_ä“_cmd
.
pbuf
 = ucmd->
ubuff
;

1038 
ucmd
->
u£r_cmd
.
Ú_ä“_cmd
.
»¥_d©a_Ën
 = 
cmd
->resp_data_len;

1039 
ucmd
->
u£r_cmd
.
Ú_ä“_cmd
.
bufãr_ÿched
 = ucmd->
buff_ÿched
;

1040 
ucmd
->
u£r_cmd
.
Ú_ä“_cmd
.
abÜ‹d
 = ucmd->aborted;

1041 
ucmd
->
u£r_cmd
.
Ú_ä“_cmd
.
¡©us
 = 
cmd
->status;

1042 
ucmd
->
u£r_cmd
.
Ú_ä“_cmd
.
d–iv”y_¡©us
 = 
cmd
->delivery_status;

1044 
ucmd
->
¡©e
 = 
UCMD_STATE_ON_FREEING
;

1046 
	`dev_u£r_add_to_»ady
(
ucmd
);

1048 
out
:

1049 
	`TRACE_EXIT
();

1052 
out_»¶y
:

1053 
	`dev_u£r_´oûss_»¶y_Ú_ä“
(
ucmd
);

1054 
out
;

1055 
	}
}

1057 
	$dev_u£r_£t_block_shiá
(
sc¡_cmd
 *
cmd
, 
block_shiá
)

1059 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

1060 
sc¡_u£r_dev
 *
udev
 = 
cmd
->
dev
->
dh_´iv
;

1061 
Ãw_block_shiá
;

1063 
	`TRACE_ENTRY
();

1069 
Ãw_block_shiá
 = 
block_shiá
 ? :

1070 
	`sc¡_ÿlc_block_shiá
(
udev
->
def_block_size
);

1071 ià(
Ãw_block_shiá
 < 9) {

1072 
	`PRINT_ERROR
("Inv®id block shiá %d", 
Ãw_block_shiá
);

1073 } ià(
dev
->
block_shiá
 !ð
Ãw_block_shiá
) {

1074 
	`PRINT_INFO
("%s: Changed block shift from %d into %d / %d",

1075 
dev
->
vœt_Çme
, dev->
block_shiá
, block_shift,

1076 
Ãw_block_shiá
);

1077 
dev
->
block_shiá
 = 
Ãw_block_shiá
;

1078 
dev
->
block_size
 = 1 << dev->
block_shiá
;

1081 
	`TRACE_EXIT
();

1083 
	}
}

1085 
	$dev_u£r_£t_block_size
(
sc¡_cmd
 *
cmd
, 
block_size
)

1087 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

1089 
	`TRACE_ENTRY
();

1095 
	`TRACE_DBG
("dev %p,‚ew block siz%d", 
dev
, 
block_size
);

1096 ià(
block_size
 != 0)

1097 
dev
->
block_size
 = block_size;

1099 
sc¡_u£r_dev
 *
udev
 = 
cmd
->
dev
->
dh_´iv
;

1101 
dev
->
block_size
 = 
udev
->
def_block_size
;

1103 
dev
->
block_shiá
 = -1;

1105 
	`TRACE_EXIT
();

1107 
	}
}

1109 
	$dev_u£r_disk_dÚe
(
sc¡_cmd
 *
cmd
)

1111 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

1113 
	`TRACE_ENTRY
();

1115 
»s
 = 
	`sc¡_block_g’”ic_dev_dÚe
(
cmd
, 
dev_u£r_£t_block_shiá
);

1117 
	`TRACE_EXIT_RES
(
»s
);

1118  
»s
;

1119 
	}
}

1121 
	$dev_u£r_³_dÚe
(
sc¡_cmd
 *
cmd
)

1123 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

1125 
	`TRACE_ENTRY
();

1127 
»s
 = 
	`sc¡_³_g’”ic_dev_dÚe
(
cmd
, 
dev_u£r_£t_block_size
);

1129 
	`TRACE_EXIT_RES
(
»s
);

1130  
»s
;

1131 
	}
}

1133 
šlše
 
boÞ
 
	$dev_u£r_mgmt_ucmd
(
sc¡_u£r_cmd
 *
ucmd
)

1135  (
ucmd
->
¡©e
 =ð
UCMD_STATE_TM_RECEIVED_EXECING
) ||

1136 (
ucmd
->
¡©e
 =ð
UCMD_STATE_TM_DONE_EXECING
) ||

1137 (
ucmd
->
¡©e
 =ð
UCMD_STATE_ATTACH_SESS
) ||

1138 (
ucmd
->
¡©e
 =ð
UCMD_STATE_DETACH_SESS
);

1139 
	}
}

1142 
šlše
 
	$dev_u£r_add_to_»ady_h—d
(
sc¡_u£r_cmd
 *
ucmd
)

1144 
sc¡_u£r_dev
 *
dev
 = 
ucmd
->dev;

1145 
li¡_h—d
 *
’Œy
;

1147 
	`TRACE_ENTRY
();

1149 
	`__li¡_fÜ_—ch
(
’Œy
, &
dev
->
»ady_cmd_li¡
) {

1150 
sc¡_u£r_cmd
 *
u
 = 
	`li¡_’Œy
(
’Œy
,

1151 
sc¡_u£r_cmd
, 
»ady_cmd_li¡_’Œy
);

1157 ià(
	`uÆik–y
(
	`dev_u£r_mgmt_ucmd
(
u
)))

1159 
	`TRACE_DBG
("Adding ucmd %p (state %d)‡fter mgmt ucmd %p (state "

1160 "%d)", 
ucmd
, ucmd->
¡©e
, 
u
, u->state);

1161 
	`li¡_add_ž
(&
ucmd
->
»ady_cmd_li¡_’Œy
,

1162 &
u
->
»ady_cmd_li¡_’Œy
);

1163 
out
;

1166 
	`TRACE_DBG
("Adding ucmd %p (state %d)oail "

1167 "oàmgmˆ»ady cmd†i¡", 
ucmd
, ucmd->
¡©e
);

1168 
	`li¡_add_ž
(&
ucmd
->
»ady_cmd_li¡_’Œy
,

1169 &
dev
->
»ady_cmd_li¡
);

1171 
out
:

1172 
	`TRACE_EXIT
();

1174 
	}
}

1176 
	$dev_u£r_add_to_»ady
(
sc¡_u£r_cmd
 *
ucmd
)

1178 
sc¡_u£r_dev
 *
dev
 = 
ucmd
->dev;

1179 
æags
;

1185 
do_wake
 = 
	`š_š‹¼u±
(è|| 
	`š_£rvšg_soáœq
();

1187 
	`TRACE_ENTRY
();

1189 ià(
ucmd
->
cmd
)

1190 
do_wake
 |ð
ucmd
->
cmd
->
´•roûssšg_Úly
;

1192 
	`¥š_lock_œq§ve
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
, 
æags
);

1194 
ucmd
->
this_¡©e_unjammed
 = 0;

1196 ià((
ucmd
->
¡©e
 =ð
UCMD_STATE_PARSING
) ||

1197 (
ucmd
->
¡©e
 =ð
UCMD_STATE_BUF_ALLOCING
)) {

1207 
	`dev_u£r_add_to_»ady_h—d
(
ucmd
);

1208 } ià(
	`uÆik–y
(
	`dev_u£r_mgmt_ucmd
(
ucmd
))) {

1209 
	`dev_u£r_add_to_»ady_h—d
(
ucmd
);

1210 
do_wake
 = 1;

1212 ià((
ucmd
->
cmd
 !ð
NULL
) &&

1213 
	`uÆik–y
((
ucmd
->
cmd
->
queue_ty³
 =ð
SCST_CMD_QUEUE_HEAD_OF_QUEUE
))) {

1214 
	`TRACE_DBG
("Adding HQ ucmd %po head of„eady cmd†ist",

1215 
ucmd
);

1216 
	`dev_u£r_add_to_»ady_h—d
(
ucmd
);

1218 
	`TRACE_DBG
("Addšg ucmd %°tØ»ady cmd†i¡", 
ucmd
);

1219 
	`li¡_add_ž
(&
ucmd
->
»ady_cmd_li¡_’Œy
,

1220 &
dev
->
»ady_cmd_li¡
);

1222 
do_wake
 |ð((
ucmd
->
¡©e
 =ð
UCMD_STATE_ON_CACHE_FREEING
) ||

1223 (
ucmd
->
¡©e
 =ð
UCMD_STATE_ON_FREEING
) ||

1224 (
ucmd
->
¡©e
 =ð
UCMD_STATE_EXT_COPY_REMAPPING
));

1227 ià(
do_wake
) {

1228 
	`TRACE_DBG
("Wakšg u°dev %p", 
dev
);

1229 
	`wake_up
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_wa™Q
);

1232 
	`¥š_uÆock_œq»¡Üe
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
, 
æags
);

1234 
	`TRACE_EXIT
();

1236 
	}
}

1238 
	$dev_u£r_m­_buf
(
sc¡_u£r_cmd
 *
ucmd
, 
ubuff
,

1239 
num_pg
)

1241 
»s
 = 0, 
rc
;

1242 
i
;

1243 
sk_¡ruù
 *
tsk
 = 
cu¼’t
;

1245 
	`TRACE_ENTRY
();

1247 ià(
	`uÆik–y
(
ubuff
 == 0))

1248 
out_nomem
;

1250 
	`sBUG_ON
(
ucmd
->
d©a_·ges
 !ð
NULL
);

1252 
ucmd
->
num_d©a_·ges
 = 
num_pg
;

1254 
ucmd
->
d©a_·ges
 = 
	`km®loc_¬¿y
(ucmd->
num_d©a_·ges
,

1255 (*
ucmd
->
d©a_·ges
),

1256 
GFP_KERNEL
);

1257 ià(
ucmd
->
d©a_·ges
 =ð
NULL
) {

1258 
	`TRACE
(
TRACE_OUT_OF_MEM
, "Unableo‡llocate data_pages‡rray "

1259 "Òum_d©a_·ges=%d)", 
ucmd
->
num_d©a_·ges
);

1260 
»s
 = -
ENOMEM
;

1261 
out_nomem
;

1264 
	`TRACE_MEM
("Mapping buffer (ucmd %p, ubuff %lx, ucmd->num_data_pages %d,"

1265 " fœ¡_·ge_off£ˆ%d,†’ %d)", 
ucmd
, 
ubuff
,

1266 
ucmd
->
num_d©a_·ges
, ()(
ubuff
 & ~
PAGE_MASK
),

1267 (
ucmd
->
cmd
 !ð
NULL
è? ucmd->cmd->
bufæ’
 : -1);

1269 
	`down_»ad
(&
tsk
->
mm
->
mm­_£m
);

1270 
rc
 = 
	`g‘_u£r_·ges
(
tsk
,sk->
mm
, 
ubuff
, 
ucmd
->
num_d©a_·ges
,

1271 1 , 0 , 
ucmd
->
d©a_·ges
, 
NULL
);

1272 
	`up_»ad
(&
tsk
->
mm
->
mm­_£m
);

1276 ià(
rc
 < 
ucmd
->
num_d©a_·ges
)

1277 
out_unm­
;

1279 
ucmd
->
ubuff
 = ubuff;

1280 
ucmd
->
fœ¡_·ge_off£t
 = (
ubuff
 & ~
PAGE_MASK
);

1282 
out
:

1283 
	`TRACE_EXIT_RES
(
»s
);

1284  
»s
;

1286 
out_nomem
:

1287 ià(
ucmd
->
cmd
 !ð
NULL
)

1288 
	`sc¡_£t_busy
(
ucmd
->
cmd
);

1291 
out_”r
:

1292 ià(
ucmd
->
cmd
 !ð
NULL
)

1293 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
ucmd
->
cmd
);

1294 
out
;

1296 
out_unm­
:

1297 
	`PRINT_ERROR
("Failedo get %d user…ages (rc %d)",

1298 
ucmd
->
num_d©a_·ges
, 
rc
);

1299 ià(
rc
 > 0) {

1300 
i
 = 0; i < 
rc
; i++)

1301 
	`·ge_ÿche_»Ëa£
(
ucmd
->
d©a_·ges
[
i
]);

1303 
	`kä“
(
ucmd
->
d©a_·ges
);

1304 
ucmd
->
d©a_·ges
 = 
NULL
;

1305 
»s
 = -
EFAULT
;

1306 ià(
ucmd
->
cmd
 !ð
NULL
)

1307 
	`sc¡_£t_cmd_”rÜ
(
ucmd
->
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_š‹º®_çžu»
));

1308 
out_”r
;

1309 
	}
}

1311 
	$dev_u£r_´oûss_»¶y_®loc
(
sc¡_u£r_cmd
 *
ucmd
,

1312 
sc¡_u£r_»¶y_cmd
 *
»¶y
)

1314 
»s
 = 0;

1315 
sc¡_cmd
 *
cmd
 = 
ucmd
->cmd;

1317 
	`TRACE_ENTRY
();

1319 
	`TRACE_DBG
("ucmd %p,…buà%Îx", 
ucmd
, 
»¶y
->
®loc_»¶y
.
pbuf
);

1321 ià(
	`lik–y
(
»¶y
->
®loc_»¶y
.
pbuf
 != 0)) {

1322 
·ges
;

1324 ià(
ucmd
->
buff_ÿched
) {

1325 ià(
	`uÆik–y
((
»¶y
->
®loc_»¶y
.
pbuf
 & ~
PAGE_MASK
) != 0)) {

1326 
	`PRINT_ERROR
("Supplied…buf %llx isn't "

1328 
»¶y
->
®loc_»¶y
.
pbuf
);

1329 
out_hw”r
;

1331 
·ges
 = 
cmd
->
sg_út
;

1333 
·ges
 = 
	`ÿlc_num_pg
(
»¶y
->
®loc_»¶y
.
pbuf
,

1334 
cmd
->
bufæ’
);

1335 
»s
 = 
	`dev_u£r_m­_buf
(
ucmd
, 
»¶y
->
®loc_»¶y
.
pbuf
, 
·ges
);

1337 
	`sc¡_£t_busy
(
ucmd
->
cmd
);

1338 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
ucmd
->
cmd
);

1341 
out_´oûss
:

1342 
	`sc¡_po¡_®loc_d©a_buf
(
cmd
);

1343 
	`sc¡_´oûss_aùive_cmd
(
cmd
, 
çl£
);

1345 
	`TRACE_DBG
("%s", "ALLOC_MEM finished");

1346 
	`TRACE_EXIT_RES
(
»s
);

1347  
»s
;

1349 
out_hw”r
:

1350 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1351 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
ucmd
->
cmd
);

1352 
»s
 = -
EINVAL
;

1353 
out_´oûss
;

1354 
	}
}

1356 
	$dev_u£r_´oûss_»¶y_·r£
(
sc¡_u£r_cmd
 *
ucmd
,

1357 
sc¡_u£r_»¶y_cmd
 *
»¶y
)

1359 
»s
 = 0, 
rc
;

1360 
sc¡_u£r_scsi_cmd_»¶y_·r£
 *
´•ly
 =

1361 &
»¶y
->
·r£_»¶y
;

1362 
sc¡_cmd
 *
cmd
 = 
ucmd
->cmd;

1364 
	`TRACE_ENTRY
();

1366 ià(
´•ly
->
¡©us
 != 0)

1367 
out_¡©us
;

1369 ià(
	`uÆik–y
(
´•ly
->
queue_ty³
 > 
SCST_CMD_QUEUE_ACA
))

1370 
out_šv®
;

1372 ià(
	`uÆik–y
((
´•ly
->
d©a_dœeùiÚ
 !ð
SCST_DATA_WRITE
) &&

1373 (
´•ly
->
d©a_dœeùiÚ
 !ð
SCST_DATA_READ
) &&

1374 (
´•ly
->
d©a_dœeùiÚ
 !ð
SCST_DATA_BIDI
) &&

1375 (
´•ly
->
d©a_dœeùiÚ
 !ð
SCST_DATA_NONE
)))

1376 
out_šv®
;

1378 ià(
	`uÆik–y
((
´•ly
->
d©a_dœeùiÚ
 !ð
SCST_DATA_NONE
) &&

1379 (
´•ly
->
bufæ’
 == 0)))

1380 
out_šv®
;

1382 ià(
	`uÆik–y
((
´•ly
->
bufæ’
 < 0è|| (´•ly->
out_bufæ’
 < 0) ||

1383 (
´•ly
->
d©a_Ën
 < 0è|| (´•ly->
lba
 < 0)))

1384 
out_šv®
;

1386 ià(
	`uÆik–y
(
´•ly
->
cdb_Ën
 > 
cmd
->cdb_len))

1387 
out_šv®
;

1389 ià(!(
´•ly
->
Ý_æags
 & 
SCST_INFO_VALID
))

1390 
out_šv®
;

1392 
	`TRACE_DBG
("ucmd %p, queue_type %x, data_direction, %x,†ba %lld, "

1394 
ucmd
, 
´•ly
->
queue_ty³
,…»¶y->
d©a_dœeùiÚ
,

1395 ()
´•ly
->
lba
,…»¶y->
bufæ’
, (í»¶y->
d©a_Ën
,

1396 
»¶y
->
®loc_»¶y
.
pbuf
, 
´•ly
->
cdb_Ën
,…»¶y->
Ý_æags
);

1398 
cmd
->
queue_ty³
 = 
´•ly
->queue_type;

1399 
cmd
->
d©a_dœeùiÚ
 = 
´•ly
->data_direction;

1400 
cmd
->
lba
 = 
´•ly
->lba;

1401 
cmd
->
bufæ’
 = 
´•ly
->bufflen;

1402 
cmd
->
out_bufæ’
 = 
´•ly
->out_bufflen;

1403 
cmd
->
d©a_Ën
 = 
´•ly
->data_len;

1404 ià(
´•ly
->
cdb_Ën
 > 0)

1405 
cmd
->
cdb_Ën
 = 
´•ly
->cdb_len;

1406 
cmd
->
Ý_æags
 = 
´•ly
->op_flags;

1408 
out_´oûss
:

1409 
	`sc¡_po¡_·r£
(
cmd
);

1410 
	`TRACE_DBG
("%s", "PARSE finished");

1412 
	`sc¡_´oûss_aùive_cmd
(
cmd
, 
çl£
);

1414 
	`TRACE_EXIT_RES
(
»s
);

1415  
»s
;

1417 
out_šv®
:

1418 
	`PRINT_ERROR
("Invalid…arse_reply…arameters (LUN %lld, op %s, cmd %p)",

1419 ()
cmd
->
lun
, 
	`sc¡_g‘_Ýcode_Çme
(cmd), cmd);

1420 
	`PRINT_BUFFER
("Inv®id…¬£_»¶y", 
»¶y
, (*reply));

1421 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1422 
»s
 = -
EINVAL
;

1423 
out_abnÜm®
;

1425 
out_š‹º_çž_»s_£t
:

1426 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_š‹º®_çžu»
));

1428 
out_abnÜm®
:

1429 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

1430 
out_´oûss
;

1432 
out_¡©us
:

1433 
	`TRACE_DBG
("ucmd %p„eturned withƒrror from user status %x",

1434 
ucmd
, 
´•ly
->
¡©us
);

1436 ià(
´•ly
->
£n£_Ën
 != 0) {

1437 
£n£_Ën
;

1439 
»s
 = 
	`sc¡_®loc_£n£
(
cmd
, 0);

1440 ià(
»s
 != 0)

1441 
out_š‹º_çž_»s_£t
;

1443 
£n£_Ën
 = 
	`mš_t
(, 
cmd
->
£n£_buæ’
, 
´•ly
->sense_len);

1445 
rc
 = 
	`cÝy_äom_u£r
(
cmd
->
£n£
,

1446 (
__u£r
 *)()
´•ly
->
p£n£_bufãr
,

1447 
£n£_Ën
);

1448 ià(
rc
 != 0) {

1449 
	`PRINT_ERROR
("FažedØcÝy %d s’£' by‹s", 
rc
);

1450 
»s
 = -
EFAULT
;

1451 
out_š‹º_çž_»s_£t
;

1453 
cmd
->
£n£_v®id_Ën
 = 
£n£_Ën
;

1455 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
´•ly
->
¡©us
);

1456 
out_abnÜm®
;

1457 
	}
}

1459 
	$dev_u£r_´oûss_»¶y_Ú_ä“
(
sc¡_u£r_cmd
 *
ucmd
)

1461 
»s
 = 0;

1463 
	`TRACE_ENTRY
();

1465 
	`TRACE_DBG
("ON FREE ucmd %p", 
ucmd
);

1467 
	`dev_u£r_ä“_sgv
(
ucmd
);

1468 
	`ucmd_put
(
ucmd
);

1470 
	`TRACE_DBG
("%s", "ON_FREE_CMD finished");

1471 
	`TRACE_EXIT_RES
(
»s
);

1472  
»s
;

1473 
	}
}

1475 
	$dev_u£r_´oûss_»¶y_Ú_ÿche_ä“
(
sc¡_u£r_cmd
 *
ucmd
)

1477 
»s
 = 0;

1479 
	`TRACE_ENTRY
();

1481 
	`TRACE_DBG
("ON CACHE FREE ucmd %p", 
ucmd
);

1483 
	`ucmd_put
(
ucmd
);

1485 
	`TRACE_MEM
("%s", "ON_CACHED_MEM_FREE finished");

1486 
	`TRACE_EXIT_RES
(
»s
);

1487  
»s
;

1488 
	}
}

1490 #iâdeà
CONFIG_SCST_PROC


1491 
	$dev_u£r_´oûss_»¶y_ext_cÝy_»m­
(
sc¡_u£r_cmd
 *
ucmd
,

1492 
sc¡_u£r_»¶y_cmd
 *
»¶y
)

1494 
»s
 = 0, 
rc
, 
couÁ
 = 0, 
i
, 
Ën
;

1495 
sc¡_u£r_ext_cÝy_»¶y_»m­
 *
¼•ly
 = &
»¶y
->
»m­_»¶y
;

1496 
sc¡_cmd
 *
cmd
 = 
ucmd
->cmd;

1497 
ušt8_t
 *
buf
;

1498 
sc¡_u£r_ext_cÝy_d©a_desü
 *
uËá
;

1499 
sc¡_ext_cÝy_d©a_desü
 *
Ëá
 = 
NULL
;

1501 
	`TRACE_ENTRY
();

1503 ià(
	`uÆik–y
((
¼•ly
->
¡©us
 !ð0è|| (¼•ly->
£n£_Ën
 != 0)))

1504 
out_¡©us
;

1506 ià(
¼•ly
->
»m­_desütÜs_Ën
 == 0) {

1507 
	`TRACE_DBG
("NØ»m­†eáov” (ucmd %p, cmd %p)", 
ucmd
, 
cmd
);

1508 
out_dÚe
;

1511 ià(
	`uÆik–y
(
¼•ly
->
»m­_desütÜs_Ën
 > 
PAGE_SIZE
)) {

1512 
	`PRINT_ERROR
("Too many†eftover REMAP descriptors (len %d, ucmd %p, "

1513 "cmd %p)", 
¼•ly
->
»m­_desütÜs_Ën
, 
ucmd
, 
cmd
);

1514 
»s
 = -
EOVERFLOW
;

1515 
out_hw_”r
;

1518 
buf
 = 
	`kz®loc
(
¼•ly
->
»m­_desütÜs_Ën
, 
GFP_KERNEL
);

1519 ià(
	`uÆik–y
(
buf
 =ð
NULL
)) {

1520 
	`PRINT_ERROR
("Unableo‡lloc†eftover„emap descriptors buf "

1521 "(siz%d)", 
¼•ly
->
»m­_desütÜs_Ën
);

1522 
out_busy
;

1525 
rc
 = 
	`cÝy_äom_u£r
(
buf
,

1526 (
__u£r
 *)()
¼•ly
->
»m­_desütÜs
,

1527 
¼•ly
->
»m­_desütÜs_Ën
);

1528 ià(
	`uÆik–y
(
rc
 != 0)) {

1529 
	`PRINT_ERROR
("Failedo copy %d†eftover„emap descriptors' "

1530 "by‹s", 
rc
);

1531 
»s
 = -
EFAULT
;

1532 
out_ä“_buf
;

1535 
uËá
 = (
sc¡_u£r_ext_cÝy_d©a_desü
 *)
buf
;

1536 
couÁ
 = 
¼•ly
->
»m­_desütÜs_Ën
 / (*
uËá
);

1537 ià(
	`uÆik–y
((
¼•ly
->
»m­_desütÜs_Ën
 % (*
uËá
)) != 0)) {

1538 
	`PRINT_ERROR
("Invalid†eftover„emap descriptors (ucmd %p, "

1539 "cmd %p, couÁ %d)", 
ucmd
, 
cmd
, 
couÁ
);

1540 
»s
 = -
EINVAL
;

1541 
out_hw_”r_ä“_buf
;

1544 
Ëá
 = 
	`km®loc_¬¿y
(
couÁ
, (*Ëá), 
GFP_KERNEL
);

1545 ià(
	`uÆik–y
(
Ëá
 =ð
NULL
)) {

1546 
	`PRINT_ERROR
("Unableo‡lloc†eftover„emap descriptors "

1547 "(siz%zd, couÁ %d)", (*
Ëá
è* 
couÁ
, count);

1548 
out_busy_ä“_buf
;

1551 
	`TRACE_DBG
("couÁ %d", 
couÁ
);

1553 
Ën
 = 0;

1554 
i
 = 0; i < 
couÁ
; i++) {

1555 
	`TRACE_DBG
("src_lba %lld, dst_lba %lld, data_len %d (len %d)",

1556 ()
uËá
[
i
].
¤c_lba
, ()uËá[i].
d¡_lba
,

1557 
uËá
[
i
].
d©a_Ën
, 
Ën
);

1558 ià(
	`uÆik–y
(
uËá
[
i
].
d©a_Ën
 == 0)) {

1559 
	`PRINT_ERROR
("Inv®id d©¨desü %d†’ %d (cmd %p)", 
i
,

1560 
uËá
[
i
].
d©a_Ën
, 
cmd
);

1561 
»s
 = -
EINVAL
;

1562 
out_hw_”r_ä“_buf
;

1564 
Ëá
[
i
].
¤c_lba
 = 
uËá
[i].src_lba;

1565 
Ëá
[
i
].
d¡_lba
 = 
uËá
[i].dst_lba;

1566 
Ëá
[
i
].
d©a_Ën
 = 
uËá
[i].data_len;

1567 
Ën
 +ð
uËá
[
i
].
d©a_Ën
;

1570 ià(
	`uÆik–y
(
Ën
 > 
	`sc¡_ext_cÝy_g‘_cur_£g_d©a_Ën
(
cmd
))) {

1571 
	`PRINT_ERROR
("Invalid data descr†en %d (cmd %p, seg descr†en %d)",

1572 
Ën
, 
cmd
, 
	`sc¡_ext_cÝy_g‘_cur_£g_d©a_Ën
(cmd));

1573 
»s
 = -
EINVAL
;

1574 
out_hw_”r_ä“_buf
;

1577 
out_ä“_buf
:

1578 
	`kä“
(
buf
);

1580 
out_dÚe
:

1581 ià(
	`uÆik–y
(
»s
 != 0)) {

1582 
	`kä“
(
Ëá
);

1583 
Ëá
 = 
NULL
;

1584 
couÁ
 = 0;

1587 
	`sc¡_ext_cÝy_»m­_dÚe
(
cmd
, 
Ëá
, 
couÁ
);

1589 
	`TRACE_EXIT_RES
(
»s
);

1590  
»s
;

1592 
out_hw_”r
:

1593 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1594 
out_dÚe
;

1596 
out_hw_”r_ä“_buf
:

1597 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1598 
out_ä“_buf
;

1600 
out_busy_ä“_buf
:

1601 
	`sc¡_£t_busy
(
cmd
);

1602 
out_ä“_buf
;

1604 
out_busy
:

1605 
	`sc¡_£t_busy
(
cmd
);

1606 
out_dÚe
;

1608 
out_¡©us
:

1609 
	`TRACE_DBG
("Remap finished with status %d (ucmd %p, cmd %p)",

1610 
¼•ly
->
¡©us
, 
ucmd
, 
cmd
);

1612 ià(
¼•ly
->
£n£_Ën
 != 0) {

1613 
£n£_Ën
;

1615 
»s
 = 
	`sc¡_®loc_£n£
(
cmd
, 0);

1616 ià(
»s
 != 0)

1617 
out_hw_”r
;

1619 
£n£_Ën
 = 
	`mš_t
(, 
cmd
->
£n£_buæ’
, 
¼•ly
->sense_len);

1621 
rc
 = 
	`cÝy_äom_u£r
(
cmd
->
£n£
,

1622 (
__u£r
 *)()
¼•ly
->
p£n£_bufãr
,

1623 
£n£_Ën
);

1624 ià(
rc
 != 0) {

1625 
	`PRINT_ERROR
("FažedØcÝy %d s’£' by‹s", 
rc
);

1626 
»s
 = -
EFAULT
;

1627 
out_hw_”r
;

1629 
cmd
->
£n£_v®id_Ën
 = 
£n£_Ën
;

1631 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
¼•ly
->
¡©us
);

1632 
out_dÚe
;

1633 
	}
}

1636 
	$dev_u£r_´oûss_ws_»¶y
(
sc¡_u£r_cmd
 *
ucmd
,

1637 
sc¡_u£r_scsi_cmd_»¶y_exec
 *
”•ly
)

1639 
»s
 = 0, 
rc
, 
couÁ
, 
i
;

1640 
sc¡_cmd
 *
cmd
 = 
ucmd
->cmd;

1641 
ušt8_t
 *
buf
;

1642 
sc¡_u£r_d©a_desütÜ
 *
uwh”e
;

1643 
sc¡_d©a_desütÜ
 *
wh”e
;

1645 
	`TRACE_ENTRY
();

1647 ià(
	`uÆik–y
(
cmd
->
cdb
[0] !ð
WRITE_SAME
) &&

1648 
	`uÆik–y
(
cmd
->
cdb
[0] !ð
WRITE_SAME_16
)) {

1649 
	`PRINT_ERROR
("Requesto…rocess WRITE SAME for‚ot WRITE SAME "

1650 "CDB (ucmd %p, cmd %p, o°%s)", 
ucmd
, 
cmd
,

1651 
	`sc¡_g‘_Ýcode_Çme
(
cmd
));

1652 
»s
 = -
EINVAL
;

1653 
out_hw_”r
;

1656 ià(
	`uÆik–y
(
”•ly
->
¡©us
 != 0)) {

1657 
	`PRINT_ERROR
("Requesto…rocess WRITE SAME with‚ot 0 status "

1658 "(ucmd %p, cmd %p, stu %d)", 
ucmd
, 
cmd
, 
”•ly
->
¡©us
);

1659 
»s
 = -
EINVAL
;

1660 
out_hw_”r
;

1663 ià(
”•ly
->
ws_desütÜs_Ën
 == 0) {

1664 
	`sc¡_wr™e_§me
(
cmd
, 
NULL
);

1665 
out
;

1668 ià(
	`uÆik–y
(
”•ly
->
ws_desütÜs_Ën
 > 
PAGE_SIZE
)) {

1669 
	`PRINT_ERROR
("Too many WRITE SAME descriptors (len %d, ucmd %p, "

1670 "cmd %p)", 
”•ly
->
ws_desütÜs_Ën
, 
ucmd
, 
cmd
);

1671 
»s
 = -
EOVERFLOW
;

1672 
out_hw_”r
;

1675 
buf
 = 
	`kz®loc
(
”•ly
->
ws_desütÜs_Ën
, 
GFP_KERNEL
);

1676 ià(
	`uÆik–y
(
buf
 =ð
NULL
)) {

1677 
	`PRINT_ERROR
("Unableo‡lloc WS descriptors buf (size %d)",

1678 
”•ly
->
ws_desütÜs_Ën
);

1679 
out_busy
;

1682 
rc
 = 
	`cÝy_äom_u£r
(
buf
,

1683 (
__u£r
 *)()
”•ly
->
ws_desütÜs
,

1684 
”•ly
->
ws_desütÜs_Ën
);

1685 ià(
	`uÆik–y
(
rc
 != 0)) {

1686 
	`PRINT_ERROR
("FažedØcÝy %d WS desütÜs' by‹s", 
rc
);

1687 
»s
 = -
EFAULT
;

1688 
out_ä“_buf
;

1691 
uwh”e
 = (
sc¡_u£r_d©a_desütÜ
 *)
buf
;

1692 
couÁ
 = 
”•ly
->
ws_desütÜs_Ën
 / (*
uwh”e
);

1693 ià(
	`uÆik–y
((
”•ly
->
ws_desütÜs_Ën
 % (*
uwh”e
)) != 0) ||

1694 
	`uÆik–y
(
uwh”e
[
couÁ
-1].
usdd_blocks
 != 0)) {

1695 
	`PRINT_ERROR
("Invalid WS descriptors (ucmd %p, cmd %p)",

1696 
ucmd
, 
cmd
);

1697 
»s
 = -
EINVAL
;

1698 
out_ä“_buf
;

1701 
wh”e
 = 
	`km®loc_¬¿y
(
couÁ
, (*wh”e), 
GFP_KERNEL
);

1702 ià(
	`uÆik–y
(
wh”e
 =ð
NULL
)) {

1703 
	`PRINT_ERROR
("Unableo‡lloc WS descriptors where (size %zd)",

1704 (*
wh”e
è* 
couÁ
);

1705 
out_busy_ä“_buf
;

1708 
i
 = 0; i < 
couÁ
; i++) {

1709 
wh”e
[
i
].
sdd_lba
 = 
uwh”e
[i].
usdd_lba
;

1710 
wh”e
[
i
].
sdd_blocks
 = 
uwh”e
[i].
usdd_blocks
;

1712 
	`kä“
(
buf
);

1714 
	`sc¡_wr™e_§me
(
cmd
, 
wh”e
);

1716 
out
:

1717 
	`TRACE_EXIT_RES
(
»s
);

1718  
»s
;

1720 
out_ä“_buf
:

1721 
	`kä“
(
buf
);

1723 
out_hw_”r
:

1724 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1726 
out_com¶
:

1727 
cmd
->
com¶‘ed
 = 1;

1728 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_DIRECT
);

1730 
out
;

1732 
out_busy_ä“_buf
:

1733 
	`kä“
(
buf
);

1735 
out_busy
:

1736 
	`sc¡_£t_busy
(
cmd
);

1737 
out_com¶
;

1738 
	}
}

1740 
	$dev_u£r_´oûss_»¶y_exec
(
sc¡_u£r_cmd
 *
ucmd
,

1741 
sc¡_u£r_»¶y_cmd
 *
»¶y
)

1743 
»s
 = 0;

1744 
sc¡_u£r_scsi_cmd_»¶y_exec
 *
”•ly
 =

1745 &
»¶y
->
exec_»¶y
;

1746 
sc¡_cmd
 *
cmd
 = 
ucmd
->cmd;

1748 
	`TRACE_ENTRY
();

1750 ià(
”•ly
->
»¶y_ty³
 =ð
SCST_EXEC_REPLY_COMPLETED
) {

1751 ià(
ucmd
->
background_exec
) {

1752 
	`TRACE_DBG
("Background ucmd %°fšished", 
ucmd
);

1753 
	`ucmd_put
(
ucmd
);

1754 
out
;

1756 ià(
	`uÆik–y
(
”•ly
->
»¥_d©a_Ën
 > 
cmd
->
bufæ’
))

1757 
out_šv®
;

1758 ià(
	`uÆik–y
((
cmd
->
d©a_dœeùiÚ
 !ð
SCST_DATA_READ
) &&

1759 (
”•ly
->
»¥_d©a_Ën
 != 0)))

1760 
out_šv®
;

1761 } ià(
”•ly
->
»¶y_ty³
 =ð
SCST_EXEC_REPLY_BACKGROUND
) {

1762 ià(
	`uÆik–y
(
ucmd
->
background_exec
))

1763 
out_šv®
;

1764 ià(
	`uÆik–y
((
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_READ
) ||

1765 (
cmd
->
»¥_d©a_Ën
 != 0)))

1766 
out_šv®
;

1772 
	`ucmd_g‘
(
ucmd
);

1773 
ucmd
->
background_exec
 = 1;

1774 
	`TRACE_DBG
("Background ucmd %p", 
ucmd
);

1775 
out_com¶
;

1776 } ià(
”•ly
->
»¶y_ty³
 =ð
SCST_EXEC_REPLY_DO_WRITE_SAME
) {

1777 
»s
 = 
	`dev_u£r_´oûss_ws_»¶y
(
ucmd
, 
”•ly
);

1778 
out
;

1780 
out_šv®
;

1782 
	`TRACE_DBG
("ucmd %p, stu %d,„e¥_d©a_ËÀ%d", 
ucmd
,

1783 
”•ly
->
¡©us
,ƒ»¶y->
»¥_d©a_Ën
);

1785 
cmd
->
©omic
 = 0;

1787 ià(
”•ly
->
»¥_d©a_Ën
 != 0) {

1788 ià(
ucmd
->
ubuff
 == 0) {

1789 
·ges
, 
rc
;

1791 ià(
	`uÆik–y
(
”•ly
->
pbuf
 == 0))

1792 
out_busy
;

1793 ià(
ucmd
->
buff_ÿched
) {

1794 ià(
	`uÆik–y
((
”•ly
->
pbuf
 & ~
PAGE_MASK
) != 0)) {

1795 
	`PRINT_ERROR
("Supplied…buf %llx isn't "

1796 "·g®igÃd", 
”•ly
->
pbuf
);

1797 
out_š‹º_çž
;

1799 
·ges
 = 
cmd
->
sg_út
;

1801 
·ges
 = 
	`ÿlc_num_pg
(
”•ly
->
pbuf
, 
cmd
->
bufæ’
);

1802 
rc
 = 
	`dev_u£r_m­_buf
(
ucmd
, 
”•ly
->
pbuf
, 
·ges
);

1803 ià((
rc
 !ð0è|| (
ucmd
->
ubuff
 == 0))

1804 
out_com¶
;

1806 
rc
 = 
	`dev_u£r_®loc_sg
(
ucmd
, ucmd->
buff_ÿched
);

1807 ià(
	`uÆik–y
(
rc
 != 0))

1808 
out_busy
;

1810 
	`dev_u£r_æush_dÿche
(
ucmd
);

1811 
cmd
->
may_Ãed_dma_sync
 = 1;

1812 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
”•ly
->
»¥_d©a_Ën
);

1813 } ià(
cmd
->
»¥_d©a_Ën
 !ð
”•ly
->resp_data_len) {

1814 ià(
ucmd
->
ubuff
 == 0) {

1819 
	`WARN_ON
(
”•ly
->
»¥_d©a_Ën
 != 0);

1820 
cmd
->
»¥_d©a_Ën
 = 0;

1821 
cmd
->
»sid_possibË
 = 1;

1823 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
”•ly
->
»¥_d©a_Ën
);

1826 
cmd
->
¡©us
 = 
”•ly
->status;

1827 ià(
”•ly
->
£n£_Ën
 != 0) {

1828 
£n£_Ën
, 
rc
;

1830 
»s
 = 
	`sc¡_®loc_£n£
(
cmd
, 0);

1831 ià(
»s
 != 0)

1832 
out_com¶
;

1834 
£n£_Ën
 = 
	`mš_t
(, 
cmd
->
£n£_buæ’
, 
”•ly
->sense_len);

1836 
rc
 = 
	`cÝy_äom_u£r
(
cmd
->
£n£
,

1837 (
__u£r
 *)()
”•ly
->
p£n£_bufãr
,

1838 
£n£_Ën
);

1839 ià(
rc
 != 0) {

1840 
	`PRINT_ERROR
("FažedØcÝy %d s’£' by‹s", 
rc
);

1841 
»s
 = -
EFAULT
;

1842 
out_š‹º_çž_»s_£t
;

1844 
cmd
->
£n£_v®id_Ën
 = 
£n£_Ën
;

1847 
out_com¶
:

1848 
cmd
->
com¶‘ed
 = 1;

1849 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_DIRECT
);

1852 
out
:

1853 
	`TRACE_DBG
("%s", "EXEC finished");

1854 
	`TRACE_EXIT_RES
(
»s
);

1855  
»s
;

1857 
out_šv®
:

1858 
	`PRINT_ERROR
("Invalidƒxec_reply…arameters (LUN %lld, op %s, cmd %p)",

1859 ()
cmd
->
lun
, 
	`sc¡_g‘_Ýcode_Çme
(cmd), cmd);

1860 
	`PRINT_BUFFER
("Inv®idƒxec_»¶y", 
»¶y
, (*reply));

1862 
out_š‹º_çž
:

1863 
»s
 = -
EINVAL
;

1865 
out_š‹º_çž_»s_£t
:

1866 ià(
ucmd
->
background_exec
) {

1867 
	`ucmd_put
(
ucmd
);

1868 
out
;

1870 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1871 
	`SCST_LOAD_SENSE
(
sc¡_£n£_š‹º®_çžu»
));

1872 
out_com¶
;

1875 
out_busy
:

1876 
	`sc¡_£t_busy
(
cmd
);

1877 
out_com¶
;

1878 
	}
}

1880 
	$dev_u£r_´oûss_»¶y
(
sc¡_u£r_dev
 *
dev
,

1881 
sc¡_u£r_»¶y_cmd
 *
»¶y
)

1883 
»s
 = 0;

1884 
sc¡_u£r_cmd
 *
ucmd
;

1885 
¡©e
;

1887 
	`TRACE_ENTRY
();

1889 
	`¥š_lock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

1891 
ucmd
 = 
	`__ucmd_fšd_hash
(
dev
, 
»¶y
->
cmd_h
);

1892 ià(
	`uÆik–y
(
ucmd
 =ð
NULL
)) {

1893 
	`TRACE_MGMT_DBG
("cmd_h %d‚Ù found", 
»¶y
->
cmd_h
);

1894 
»s
 = -
ESRCH
;

1895 
out_uÆock
;

1898 ià(
	`uÆik–y
(
	`ucmd_g‘_check
(
ucmd
))) {

1899 
	`TRACE_MGMT_DBG
("Found bešg de¡royed cmd_h %d", 
»¶y
->
cmd_h
);

1900 
»s
 = -
ESRCH
;

1901 
out_uÆock
;

1905 
	`smp_mb
();

1906 ià(
ucmd
->
background_exec
) {

1907 
¡©e
 = 
UCMD_STATE_EXECING
;

1908 
uÆock_´oûss
;

1911 ià(
	`uÆik–y
(
ucmd
->
this_¡©e_unjammed
)) {

1912 
	`TRACE_MGMT_DBG
("Reply on unjammed ucmd %p, ignoring",

1913 
ucmd
);

1914 
out_uÆock_put
;

1917 ià(
	`uÆik–y
(!
ucmd
->
£Á_to_u£r
)) {

1918 
	`TRACE_MGMT_DBG
("Ucmd %p isn't inhe sento user "

1919 "¡©%x", 
ucmd
, ucmd->
¡©e
);

1920 
»s
 = -
EINVAL
;

1921 
out_uÆock_put
;

1924 ià(
	`uÆik–y
(
»¶y
->
subcode
 !ð
ucmd
->
u£r_cmd
.subcode))

1925 
out_wrÚg_¡©e
;

1927 ià(
	`uÆik–y
(
	`_IOC_NR
(
»¶y
->
subcode
è!ð
ucmd
->
¡©e
))

1928 
out_wrÚg_¡©e
;

1930 
¡©e
 = 
ucmd
->state;

1931 
ucmd
->
£Á_to_u£r
 = 0;

1933 
uÆock_´oûss
:

1934 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

1936 
¡©e
) {

1937 
UCMD_STATE_PARSING
:

1938 
»s
 = 
	`dev_u£r_´oûss_»¶y_·r£
(
ucmd
, 
»¶y
);

1941 
UCMD_STATE_BUF_ALLOCING
:

1942 
»s
 = 
	`dev_u£r_´oûss_»¶y_®loc
(
ucmd
, 
»¶y
);

1945 
UCMD_STATE_EXECING
:

1946 
»s
 = 
	`dev_u£r_´oûss_»¶y_exec
(
ucmd
, 
»¶y
);

1949 
UCMD_STATE_ON_FREEING
:

1950 
»s
 = 
	`dev_u£r_´oûss_»¶y_Ú_ä“
(
ucmd
);

1953 
UCMD_STATE_ON_CACHE_FREEING
:

1954 
»s
 = 
	`dev_u£r_´oûss_»¶y_Ú_ÿche_ä“
(
ucmd
);

1957 #iâdeà
CONFIG_SCST_PROC


1958 
UCMD_STATE_EXT_COPY_REMAPPING
:

1959 
»s
 = 
	`dev_u£r_´oûss_»¶y_ext_cÝy_»m­
(
ucmd
, 
»¶y
);

1963 
UCMD_STATE_TM_RECEIVED_EXECING
:

1964 
UCMD_STATE_TM_DONE_EXECING
:

1965 
»s
 = 
	`dev_u£r_´oûss_»¶y_tm_exec
(
ucmd
,

1966 (
¡©e
 =ð
UCMD_STATE_TM_RECEIVED_EXECING
) ?

1967 
SCST_MGMT_STATUS_RECEIVED_STAGE_COMPLETED
 :

1968 
»¶y
->
»suÉ
);

1971 
UCMD_STATE_ATTACH_SESS
:

1972 
UCMD_STATE_DETACH_SESS
:

1973 
»s
 = 
	`dev_u£r_´oûss_»¶y_£ss
(
ucmd
, 
»¶y
->
»suÉ
);

1977 
	`sBUG
();

1981 
out_put
:

1982 
	`ucmd_put
(
ucmd
);

1984 
out
:

1985 
	`TRACE_EXIT_RES
(
»s
);

1986  
»s
;

1988 
out_wrÚg_¡©e
:

1989 
	`PRINT_ERROR
("Command's %p subcode %x doesn't match internal "

1991 "(%x)", 
ucmd
, 
	`_IOC_NR
(
»¶y
->
subcode
), ucmd->
¡©e
,

1992 
»¶y
->
subcode
, 
ucmd
->
u£r_cmd
.subcode);

1993 
»s
 = -
EINVAL
;

1994 
	`dev_u£r_unjam_cmd
(
ucmd
, 0, 
NULL
);

1996 
out_uÆock_put
:

1997 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

1998 
out_put
;

2000 
out_uÆock
:

2001 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2002 
out
;

2003 
	}
}

2005 
	$dev_u£r_»¶y_cmd
(
fže
 *fže, 
__u£r
 *
¬g
)

2007 
»s
 = 0, 
rc
;

2008 
sc¡_u£r_dev
 *
dev
;

2009 
sc¡_u£r_»¶y_cmd
 
»¶y
;

2011 
	`TRACE_ENTRY
();

2013 
dev
 = 
fže
->
´iv©e_d©a
;

2014 
»s
 = 
	`dev_u£r_check_»g
(
dev
);

2015 ià(
	`uÆik–y
(
»s
 != 0))

2016 
out
;

2018 
rc
 = 
	`cÝy_äom_u£r
(&
»¶y
, 
¬g
, (reply));

2019 ià(
	`uÆik–y
(
rc
 != 0)) {

2020 
	`PRINT_ERROR
("FažedØcÝy %d u£r' by‹s", 
rc
);

2021 
»s
 = -
EFAULT
;

2022 
out
;

2025 
	`TRACE_DBG
("R•ly fÜ dev %s", 
dev
->
Çme
);

2027 
	`TRACE_BUFFER
("R•ly", &
»¶y
, (reply));

2029 
»s
 = 
	`dev_u£r_´oûss_»¶y
(
dev
, &
»¶y
);

2030 ià(
	`uÆik–y
(
»s
 < 0))

2031 
out
;

2033 
out
:

2034 
	`TRACE_EXIT_RES
(
»s
);

2035  
»s
;

2036 
	}
}

2038 
	$dev_u£r_g‘_ext_cdb
(
fže
 *fže, 
__u£r
 *
¬g
)

2040 
»s
 = 0, 
rc
;

2041 
sc¡_u£r_dev
 *
dev
;

2042 
sc¡_u£r_cmd
 *
ucmd
;

2043 
sc¡_cmd
 *
cmd
 = 
NULL
;

2044 
sc¡_u£r_g‘_ext_cdb
 
g‘
;

2046 
	`TRACE_ENTRY
();

2048 
dev
 = 
fže
->
´iv©e_d©a
;

2049 
»s
 = 
	`dev_u£r_check_»g
(
dev
);

2050 ià(
	`uÆik–y
(
»s
 != 0))

2051 
out
;

2053 
rc
 = 
	`cÝy_äom_u£r
(&
g‘
, 
¬g
, (get));

2054 ià(
	`uÆik–y
(
rc
 != 0)) {

2055 
	`PRINT_ERROR
("FažedØcÝy %d u£r' by‹s", 
rc
);

2056 
»s
 = -
EFAULT
;

2057 
out
;

2060 
	`TRACE_MGMT_DBG
("G‘ƒxˆcdb fÜ dev %s", 
dev
->
Çme
);

2062 
	`TRACE_BUFFER
("G‘ƒxˆcdb", &
g‘
, (get));

2064 
	`¥š_lock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2066 
ucmd
 = 
	`__ucmd_fšd_hash
(
dev
, 
g‘
.
cmd_h
);

2067 ià(
	`uÆik–y
(
ucmd
 =ð
NULL
)) {

2068 
	`TRACE_MGMT_DBG
("cmd_h %d‚Ù found", 
g‘
.
cmd_h
);

2069 
»s
 = -
ESRCH
;

2070 
out_uÆock
;

2073 ià(
	`uÆik–y
(
	`ucmd_g‘_check
(
ucmd
))) {

2074 
	`TRACE_MGMT_DBG
("Found bešg de¡royed cmd_h %d", 
g‘
.
cmd_h
);

2075 
»s
 = -
ESRCH
;

2076 
out_uÆock
;

2079 ià((
ucmd
->
cmd
 !ð
NULL
è&& (ucmd->
¡©e
 <ð
UCMD_STATE_EXECING
) &&

2080 (
ucmd
->
£Á_to_u£r
 || ucmd->
background_exec
)) {

2081 
cmd
 = 
ucmd
->cmd;

2082 
	`sc¡_cmd_g‘
(
cmd
);

2084 
	`TRACE_MGMT_DBG
("Invalid ucmd state %d for cmd_h %d",

2085 
ucmd
->
¡©e
, 
g‘
.
cmd_h
);

2086 
»s
 = -
EINVAL
;

2087 
out_uÆock
;

2090 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2092 ià(
cmd
 =ð
NULL
)

2093 
out_put
;

2095 
	`BUILD_BUG_ON
((
cmd
->
cdb_buf
è!ð
SCST_MAX_CDB_SIZE
);

2097 ià(
cmd
->
cdb_Ën
 <ð
SCST_MAX_CDB_SIZE
)

2098 
out_cmd_put
;

2100 
	`EXTRACHECKS_BUG_ON
(
cmd
->
cdb_buf
 == cmd->cdb_buf);

2102 
	`TRACE_BUFFER
("EXT CDB", &
cmd
->
cdb
[(cmd->
cdb_buf
)],

2103 
cmd
->
cdb_Ën
 - (cmd->
cdb_buf
));

2104 
rc
 = 
	`cÝy_to_u£r
((
__u£r
 *)()
g‘
.
ext_cdb_bufãr
,

2105 &
cmd
->
cdb
[(cmd->
cdb_buf
)],

2106 
cmd
->
cdb_Ën
 - (cmd->
cdb_buf
));

2107 ià(
	`uÆik–y
(
rc
 != 0)) {

2108 
	`PRINT_ERROR
("FažedØcÝyØu£¸%d by‹s", 
rc
);

2109 
»s
 = -
EFAULT
;

2110 
out_cmd_put
;

2113 
out_cmd_put
:

2114 
	`sc¡_cmd_put
(
cmd
);

2116 
out_put
:

2117 
	`ucmd_put
(
ucmd
);

2119 
out
:

2120 
	`TRACE_EXIT_RES
(
»s
);

2121  
»s
;

2123 
out_uÆock
:

2124 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2125 
out
;

2126 
	}
}

2128 
	$dev_u£r_´oûss_sc¡_commªds
(
sc¡_u£r_dev
 *
dev
)

2129 
	`__»Ëa£s
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
)

2130 
	`__acquœes
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
)

2132 
»s
 = 0;

2134 
	`TRACE_ENTRY
();

2136 !
	`li¡_em±y
(&
dev
->
udev_cmd_th»ads
.
aùive_cmd_li¡
)) {

2137 
sc¡_cmd
 *
cmd
 = 
	`li¡_’Œy
(

2138 
dev
->
udev_cmd_th»ads
.
aùive_cmd_li¡
.
Ãxt
, 
	`ty³of
(*
cmd
),

2139 
cmd_li¡_’Œy
);

2140 
	`TRACE_DBG
("D–‘šg cmd %°äom‡ùivcmd†i¡", 
cmd
);

2141 
	`li¡_d–
(&
cmd
->
cmd_li¡_’Œy
);

2142 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2143 
	`sc¡_´oûss_aùive_cmd
(
cmd
, 
çl£
);

2144 
	`¥š_lock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2145 
»s
++;

2148 
	`TRACE_EXIT_RES
(
»s
);

2149  
»s
;

2150 
	}
}

2153 
sc¡_u£r_cmd
 *
	$__dev_u£r_g‘_Ãxt_cmd
(
li¡_h—d
 *
cmd_li¡
)

2154 
	`__»Ëa£s
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
)

2155 
	`__acquœes
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
)

2157 
sc¡_u£r_cmd
 *
u
;

2159 
agaš
:

2160 
u
 = 
NULL
;

2161 ià(!
	`li¡_em±y
(
cmd_li¡
)) {

2162 
u
 = 
	`li¡_fœ¡_’Œy
(
cmd_li¡
, 
	`ty³of
(*u),

2163 
»ady_cmd_li¡_’Œy
);

2165 
	`TRACE_DBG
("Found„—dy ucmd %p", 
u
);

2166 
	`li¡_d–
(&
u
->
»ady_cmd_li¡_’Œy
);

2168 
	`EXTRACHECKS_BUG_ON
(
u
->
this_¡©e_unjammed
);

2170 ià(
u
->
cmd
 !ð
NULL
) {

2171 ià(
u
->
¡©e
 =ð
UCMD_STATE_EXECING
) {

2172 
sc¡_u£r_dev
 *
dev
 = 
u
->dev;

2173 
rc
;

2175 
	`EXTRACHECKS_BUG_ON
(
u
->
jammed
);

2177 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2179 
rc
 = 
	`sc¡_check_loÿl_ev’ts
(
u
->
cmd
);

2180 ià(
	`uÆik–y
(
rc
 != 0)) {

2181 
u
->
cmd
->
	`sc¡_cmd_dÚe
(u->cmd,

2182 
SCST_CMD_STATE_DEFAULT
,

2183 
SCST_CONTEXT_DIRECT
);

2188 
	`¥š_lock_œq
(

2189 &
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2190 
agaš
;

2193 
	`¥š_lock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2194 } ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_CMD_ABORTED
,

2195 &
u
->
cmd
->
cmd_æags
))) {

2196 
u
->
¡©e
) {

2197 
UCMD_STATE_PARSING
:

2198 
UCMD_STATE_BUF_ALLOCING
:

2199 
	`TRACE_MGMT_DBG
("AbÜtšg ucmd %p", 
u
);

2200 
	`dev_u£r_unjam_cmd
(
u
, 0, 
NULL
);

2201 
agaš
;

2202 
UCMD_STATE_EXECING
:

2203 
	`EXTRACHECKS_BUG
();

2207 
u
->
£Á_to_u£r
 = 1;

2208 
u
->
£’_by_u£r
 = 1;

2210  
u
;

2211 
	}
}

2213 
šlše
 
	$‹¡_cmd_th»ads
(
sc¡_u£r_dev
 *
dev
, 
boÞ
 
ÿn_block
)

2215 
»s
 = !
	`li¡_em±y
(&
dev
->
udev_cmd_th»ads
.
aùive_cmd_li¡
) ||

2216 !
	`li¡_em±y
(&
dev
->
»ady_cmd_li¡
) ||

2217 !
ÿn_block
 || !
dev
->
blockšg
 || dev->
þ—nup_dÚe
 ||

2218 
	`sigÇl_³ndšg
(
cu¼’t
);

2219  
»s
;

2220 
	}
}

2223 
	$dev_u£r_g‘_Ãxt_cmd
(
sc¡_u£r_dev
 *
dev
,

2224 
sc¡_u£r_cmd
 **
ucmd
, 
boÞ
 
ÿn_block
)

2226 
»s
 = 0;

2228 
	`TRACE_ENTRY
();

2231 
	`wa™_ev’t_locked
(
dev
->
udev_cmd_th»ads
.
cmd_li¡_wa™Q
,

2232 
	`‹¡_cmd_th»ads
(
dev
, 
ÿn_block
), 
lock_œq
,

2233 
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2235 
	`dev_u£r_´oûss_sc¡_commªds
(
dev
);

2237 *
ucmd
 = 
	`__dev_u£r_g‘_Ãxt_cmd
(&
dev
->
»ady_cmd_li¡
);

2238 ià(*
ucmd
 !ð
NULL
)

2241 ià(!
ÿn_block
 || !
dev
->
blockšg
 || dev->
þ—nup_dÚe
) {

2242 
»s
 = -
EAGAIN
;

2243 
	`TRACE_DBG
("NØ»ady commªds,„‘uºšg %d", 
»s
);

2247 ià(
	`sigÇl_³ndšg
(
cu¼’t
)) {

2248 
»s
 = -
EINTR
;

2249 
	`TRACE_DBG
("SigÇÈ³ndšg,„‘uºšg %d", 
»s
);

2254 
	`TRACE_EXIT_RES
(
»s
);

2255  
»s
;

2256 
	}
}

2259 
	$dev_u£r_g‘_cmd_to_u£r
(
sc¡_u£r_dev
 *
dev
,

2260 
__u£r
 *
wh”e
, 
boÞ
 
ÿn_block
)

2262 
»s
;

2263 
sc¡_u£r_cmd
 *
ucmd
;

2265 
	`TRACE_ENTRY
();

2267 
	`¥š_lock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2268 
agaš
:

2269 
»s
 = 
	`dev_u£r_g‘_Ãxt_cmd
(
dev
, &
ucmd
, 
ÿn_block
);

2270 ià(
»s
 == 0) {

2271 
Ën
, 
rc
;

2278 ià(
	`uÆik–y
(
	`ucmd_g‘_check
(
ucmd
))) {

2280 
agaš
;

2282 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2284 
	`EXTRACHECKS_BUG_ON
(
ucmd
->
u£r_cmd_·ylßd_Ën
 == 0);

2286 
Ën
 = 
ucmd
->
u£r_cmd_·ylßd_Ën
;

2287 
	`TRACE_DBG
("ucmd %p (user_cmd %p),…ayload_len %d (len %d)",

2288 
ucmd
, &ucmd->
u£r_cmd
, ucmd->
u£r_cmd_·ylßd_Ën
, 
Ën
);

2289 
	`TRACE_BUFFER
("UCMD", &
ucmd
->
u£r_cmd
, 
Ën
);

2290 
rc
 = 
	`cÝy_to_u£r
(
wh”e
, &
ucmd
->
u£r_cmd
, 
Ën
);

2291 ià(
	`uÆik–y
(
rc
 != 0)) {

2292 
	`PRINT_ERROR
("Copyo user failed (%d),„equeuing ucmd "

2293 "%°backØh—d oà»ady cmd†i¡", 
»s
, 
ucmd
);

2294 
»s
 = -
EFAULT
;

2296 
	`¥š_lock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2297 
	`li¡_add
(&
ucmd
->
»ady_cmd_li¡_’Œy
,

2298 &
dev
->
»ady_cmd_li¡
);

2299 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2301 #ifdeà
CONFIG_SCST_EXTRACHECKS


2303 
ucmd
->
u£r_cmd_·ylßd_Ën
 = 0;

2305 
	`ucmd_put
(
ucmd
);

2307 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2309 
	`TRACE_EXIT_RES
(
»s
);

2310  
»s
;

2311 
	}
}

2313 
	$dev_u£r_»¶y_g‘_cmd
(
fže
 *fže, 
__u£r
 *
¬g
)

2315 
»s
 = 0, 
rc
;

2316 
sc¡_u£r_dev
 *
dev
;

2317 
sc¡_u£r_»¶y_cmd
 
»¶y
;

2318 
ušt64_t
 
u»¶y
;

2320 
	`TRACE_ENTRY
();

2322 
dev
 = 
fže
->
´iv©e_d©a
;

2323 
»s
 = 
	`dev_u£r_check_»g
(
dev
);

2324 ià(
	`uÆik–y
(
»s
 != 0))

2325 
out
;

2328 
rc
 = 
	`cÝy_äom_u£r
(&
u»¶y
, (
ušt64_t
 
__u£r
 *)

2329 &((
sc¡_u£r_g‘_cmd
 
__u£r
 *)
¬g
)->
´•ly
,

2330 (
u»¶y
));

2331 ià(
	`uÆik–y
(
rc
 != 0)) {

2332 
	`PRINT_ERROR
("FažedØcÝy %d u£r' by‹s", 
rc
);

2333 
»s
 = -
EFAULT
;

2334 
out
;

2337 
	`TRACE_DBG
("u»¶y %Îd (dev %s)", ()
u»¶y
,

2338 
dev
->
Çme
);

2340 ià(
u»¶y
 != 0) {

2341 
u
 = ()
u»¶y
;

2343 
rc
 = 
	`cÝy_äom_u£r
(&
»¶y
, (
__u£r
 *)
u
, (reply));

2344 ià(
	`uÆik–y
(
rc
 != 0)) {

2345 
	`PRINT_ERROR
("FažedØcÝy %d u£r' by‹s", 
rc
);

2346 
»s
 = -
EFAULT
;

2347 
out
;

2350 
	`TRACE_BUFFER
("R•ly", &
»¶y
, (reply));

2352 
»s
 = 
	`dev_u£r_´oûss_»¶y
(
dev
, &
»¶y
);

2353 ià(
	`uÆik–y
(
»s
 < 0))

2354 
out
;

2357 
»s
 = 
	`dev_u£r_g‘_cmd_to_u£r
(
dev
, 
¬g
, 
Œue
);

2359 
out
:

2360 
	`TRACE_EXIT_RES
(
»s
);

2361  
»s
;

2362 
	}
}

2364 
	$dev_u£r_»¶y_g‘_muÉi
(
fže
 *fže, 
__u£r
 *
¬g
)

2366 
»s
 = 0, 
rc
;

2367 
sc¡_u£r_dev
 *
dev
;

2368 
sc¡_u£r_»¶y_cmd
 
__u£r
 *
»¶›s
;

2369 
št16_t
 
i
, 
»¶›s_út
, 
»¶›s_dÚe
 = 0, 
cmds_út
 = 0;

2371 
	`TRACE_ENTRY
();

2373 
dev
 = (
sc¡_u£r_dev
 *)
fže
->
´iv©e_d©a
;

2374 
»s
 = 
	`dev_u£r_check_»g
(
dev
);

2375 ià(
	`uÆik–y
(
»s
 != 0))

2376 
out
;

2378 
»s
 = 
	`g‘_u£r
(
»¶›s_út
, (
št16_t
 
__u£r
 *)

2379 &((
sc¡_u£r_g‘_muÉi
 
__u£r
 *)
¬g
)->
»¶›s_út
);

2380 ià(
	`uÆik–y
(
»s
 < 0)) {

2381 
	`PRINT_ERROR
("%s", "Unableo get„eplies_cnt");

2382 
out
;

2385 
»s
 = 
	`g‘_u£r
(
cmds_út
, (
št16_t
 
__u£r
 *)

2386 &((
sc¡_u£r_g‘_muÉi
 
__u£r
 *)
¬g
)->
cmds_út
);

2387 ià(
	`uÆik–y
(
»s
 < 0)) {

2388 
	`PRINT_ERROR
("%s", "Unableo get cmds_cnt");

2389 
out
;

2392 
	`TRACE_DBG
("replies %d, space %d (dev %s)",

2393 
»¶›s_út
, 
cmds_út
, 
dev
->
Çme
);

2395 ià(
»¶›s_út
 == 0)

2396 
g‘_cmds
;

2399 
rc
 = 
	`cÝy_äom_u£r
(&
»¶›s
, (
ušt64_t
 
__u£r
 *)

2400 &((
sc¡_u£r_g‘_muÉi
 
__u£r
 *)
¬g
)->
´•l›s
, (
»¶›s
));

2401 ià(
	`uÆik–y
(
rc
 != 0)) {

2402 
	`PRINT_ERROR
("%s", "Unableo get…reply");

2403 
»s
 = -
EFAULT
;

2404 
out
;

2407 
i
 = 0; i < 
»¶›s_út
; i++) {

2408 
sc¡_u£r_»¶y_cmd
 
»¶y
;

2410 
rc
 = 
	`cÝy_äom_u£r
(&
»¶y
, &
»¶›s
[
i
], (reply));

2411 ià(
	`uÆik–y
(
rc
 != 0)) {

2412 
	`PRINT_ERROR
("UÇbËØg‘„•ly %d", 
i
);

2413 
»s
 = -
EFAULT
;

2414 
out_·¹_»¶›s_dÚe
;

2417 
	`TRACE_BUFFER
("R•ly", &
»¶y
, (reply));

2419 
»s
 = 
	`dev_u£r_´oûss_»¶y
(
dev
, &
»¶y
);

2420 ià(
	`uÆik–y
(
»s
 < 0))

2421 
out_·¹_»¶›s_dÚe
;

2423 
»¶›s_dÚe
++;

2426 
	`TRACE_DBG
("R‘uºšg %d„•l›s_dÚe", 
»¶›s_dÚe
);

2427 
»s
 = 
	`put_u£r
(
»¶›s_dÚe
, (
št16_t
 
__u£r
 *)

2428 &((
sc¡_u£r_g‘_muÉi
 
__u£r
 *)
¬g
)->
»¶›s_dÚe
);

2429 ià(
	`uÆik–y
(
»s
 < 0))

2430 
out
;

2432 
g‘_cmds
:

2433 
i
 = 0; i < 
cmds_út
; i++) {

2434 
»s
 = 
	`dev_u£r_g‘_cmd_to_u£r
(
dev
,

2435 &((
sc¡_u£r_g‘_muÉi
 
__u£r
 *)
¬g
)->
cmds
[
i
], i == 0);

2436 ià(
»s
 != 0) {

2437 ià((
»s
 =ð-
EAGAIN
è&& (
i
 > 0))

2438 
»s
 = 0;

2443 
	`TRACE_DBG
("R‘uºšg %d cmds_»t", 
i
);

2444 
rc
 = 
	`put_u£r
(
i
, (
št16_t
 
__u£r
 *)

2445 &((
sc¡_u£r_g‘_muÉi
 
__u£r
 *)
¬g
)->
cmds_út
);

2446 ià(
	`uÆik–y
(
rc
 < 0)) {

2447 
»s
 = 
rc
;

2448 
out
;

2451 
out
:

2452 
	`TRACE_EXIT_RES
(
»s
);

2453  
»s
;

2455 
out_·¹_»¶›s_dÚe
:

2456 
	`TRACE_DBG
("P¬tŸÈ»tuºšg %d„•l›s_dÚe", 
»¶›s_dÚe
);

2457 
	`put_u£r
(
»¶›s_dÚe
, (
št16_t
 
__u£r
 *)

2458 &((
sc¡_u£r_g‘_muÉi
 
__u£r
 *)
¬g
)->
»¶›s_dÚe
);

2459 
rc
 = 
	`put_u£r
(0, (
št16_t
 
__u£r
 *)

2460 &((
sc¡_u£r_g‘_muÉi
 
__u£r
 *)
¬g
)->
cmds_út
);

2461 
out
;

2462 
	}
}

2464 
	$dev_u£r_ioùl
(
fže
 *fže, 
cmd
,

2465 
¬g
)

2467 
»s
, 
rc
;

2469 
	`TRACE_ENTRY
();

2471 
cmd
) {

2472 
SCST_USER_REPLY_AND_GET_CMD
:

2473 
	`TRACE_DBG
("%s", "REPLY_AND_GET_CMD");

2474 
»s
 = 
	`dev_u£r_»¶y_g‘_cmd
(
fže
, (
__u£r
 *)
¬g
);

2477 
SCST_USER_REPLY_CMD
:

2478 
	`TRACE_DBG
("%s", "REPLY_CMD");

2479 
»s
 = 
	`dev_u£r_»¶y_cmd
(
fže
, (
__u£r
 *)
¬g
);

2482 
SCST_USER_REPLY_AND_GET_MULTI
:

2483 
	`TRACE_DBG
("%s", "REPLY_AND_GET_MULTI");

2484 
»s
 = 
	`dev_u£r_»¶y_g‘_muÉi
(
fže
, (
__u£r
 *)
¬g
);

2487 
SCST_USER_GET_EXTENDED_CDB
:

2488 
	`TRACE_DBG
("%s", "GET_EXTENDED_CDB");

2489 
»s
 = 
	`dev_u£r_g‘_ext_cdb
(
fže
, (
__u£r
 *)
¬g
);

2492 
SCST_USER_REGISTER_DEVICE
:

2494 
sc¡_u£r_dev_desc
 *
dev_desc
;

2496 
	`TRACE_DBG
("%s", "REGISTER_DEVICE");

2497 
dev_desc
 = 
	`km®loc
((*dev_desc), 
GFP_KERNEL
);

2498 ià(
dev_desc
 =ð
NULL
) {

2499 
»s
 = -
ENOMEM
;

2500 
out
;

2502 
rc
 = 
	`cÝy_äom_u£r
(
dev_desc
, (
__u£r
 *)
¬g
,

2503 (*
dev_desc
));

2504 ià(
rc
 != 0) {

2505 
	`PRINT_ERROR
("FažedØcÝy %ld u£r' by‹s", 
rc
);

2506 
»s
 = -
EFAULT
;

2507 
	`kä“
(
dev_desc
);

2508 
out
;

2510 
	`TRACE_BUFFER
("dev_desc", 
dev_desc
, (*dev_desc));

2511 
dev_desc
->
Çme
[(dev_desc->name)-1] = '\0';

2512 
dev_desc
->
sgv_Çme
[(dev_desc->sgv_name)-1] = '\0';

2513 
»s
 = 
	`dev_u£r_»gi¡”_dev
(
fže
, 
dev_desc
);

2514 
	`kä“
(
dev_desc
);

2518 
SCST_USER_UNREGISTER_DEVICE
:

2519 
	`TRACE_DBG
("%s", "UNREGISTER_DEVICE");

2520 
»s
 = 
	`dev_u£r_uÄegi¡”_dev
(
fže
);

2523 
SCST_USER_FLUSH_CACHE
:

2524 
	`TRACE_DBG
("%s", "FLUSH_CACHE");

2525 
»s
 = 
	`dev_u£r_æush_ÿche
(
fže
);

2528 
SCST_USER_SET_OPTIONS
:

2530 
sc¡_u£r_Ýt
 
Ýt
;

2532 
	`TRACE_DBG
("%s", "SET_OPTIONS");

2533 
rc
 = 
	`cÝy_äom_u£r
(&
Ýt
, (
__u£r
 *)
¬g
, (opt));

2534 ià(
rc
 != 0) {

2535 
	`PRINT_ERROR
("FažedØcÝy %ld u£r' by‹s", 
rc
);

2536 
»s
 = -
EFAULT
;

2537 
out
;

2539 
	`TRACE_BUFFER
("Ýt", &
Ýt
, (opt));

2540 
»s
 = 
	`dev_u£r_£t_Ýt
(
fže
, &
Ýt
);

2544 
SCST_USER_GET_OPTIONS
:

2545 
	`TRACE_DBG
("%s", "GET_OPTIONS");

2546 
»s
 = 
	`dev_u£r_g‘_Ýt
(
fže
, (
__u£r
 *)
¬g
);

2549 
SCST_USER_DEVICE_CAPACITY_CHANGED
:

2550 
	`TRACE_DBG
("%s", "CAPACITY_CHANGED");

2551 
»s
 = 
	`dev_u£r_ÿ·c™y_chªged
(
fže
);

2554 
SCST_USER_PREALLOC_BUFFER
:

2555 
	`TRACE_DBG
("%s", "PREALLOC_BUFFER");

2556 
»s
 = 
	`dev_u£r_´—Îoc_bufãr
(
fže
, (
__u£r
 *)
¬g
);

2560 
	`PRINT_ERROR
("Inv®id ioùÈcmd %x", 
cmd
);

2561 
»s
 = -
EINVAL
;

2562 
out
;

2565 
out
:

2566 
	`TRACE_EXIT_RES
(
»s
);

2567  
»s
;

2568 
	}
}

2570 
	$dev_u£r_pÞl
(
fže
 *fže, 
pÞl_bË
 *
wa™
)

2572 
»s
 = 0;

2573 
sc¡_u£r_dev
 *
dev
;

2575 
	`TRACE_ENTRY
();

2577 
dev
 = 
fže
->
´iv©e_d©a
;

2578 
»s
 = 
	`dev_u£r_check_»g
(
dev
);

2579 ià(
	`uÆik–y
(
»s
 != 0))

2580 
out
;

2582 
	`¥š_lock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2584 ià(!
	`li¡_em±y
(&
dev
->
»ady_cmd_li¡
) ||

2585 !
	`li¡_em±y
(&
dev
->
udev_cmd_th»ads
.
aùive_cmd_li¡
)) {

2586 
»s
 |ð
POLLIN
 | 
POLLRDNORM
;

2587 
out_uÆock
;

2590 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2592 
	`TRACE_DBG
("BefÜpÞl_wa™(è(dev %s)", 
dev
->
Çme
);

2593 
	`pÞl_wa™
(
fže
, &
dev
->
udev_cmd_th»ads
.
cmd_li¡_wa™Q
, 
wa™
);

2594 
	`TRACE_DBG
("Aá”…Þl_wa™(è(dev %s)", 
dev
->
Çme
);

2596 
	`¥š_lock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2598 ià(!
	`li¡_em±y
(&
dev
->
»ady_cmd_li¡
) ||

2599 !
	`li¡_em±y
(&
dev
->
udev_cmd_th»ads
.
aùive_cmd_li¡
)) {

2600 
»s
 |ð
POLLIN
 | 
POLLRDNORM
;

2601 
out_uÆock
;

2604 
out_uÆock
:

2605 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2607 
out
:

2608 
	`TRACE_EXIT_HRES
(
»s
);

2609  
»s
;

2610 
	}
}

2616 
	$dev_u£r_unjam_cmd
(
sc¡_u£r_cmd
 *
ucmd
, 
busy
,

2617 *
æags
)

2618 
	`__»Ëa£s
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
)

2619 
	`__acquœes
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
)

2621 
¡©e
 = 
ucmd
->state;

2622 
sc¡_u£r_dev
 *
dev
 = 
ucmd
->dev;

2624 
	`TRACE_ENTRY
();

2626 ià(
ucmd
->
this_¡©e_unjammed
)

2627 
out
;

2629 
	`TRACE_MGMT_DBG
("Unjammšg ucmd %°(busy %d, s‹ %x)", 
ucmd
, 
busy
,

2630 
¡©e
);

2632 
ucmd
->
jammed
 = 1;

2633 
ucmd
->
this_¡©e_unjammed
 = 1;

2634 
ucmd
->
£Á_to_u£r
 = 0;

2636 
¡©e
) {

2637 
UCMD_STATE_PARSING
:

2638 
UCMD_STATE_BUF_ALLOCING
:

2639 ià(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
ucmd
->
cmd
->
cmd_æags
))

2640 
ucmd
->
abÜ‹d
 = 1;

2642 ià(
busy
)

2643 
	`sc¡_£t_busy
(
ucmd
->
cmd
);

2645 
	`sc¡_£t_cmd_”rÜ
(
ucmd
->
cmd
,

2646 
	`SCST_LOAD_SENSE
(
sc¡_£n£_lun_nÙ_suµÜ‹d
));

2648 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
ucmd
->
cmd
);

2650 ià(
¡©e
 =ð
UCMD_STATE_PARSING
)

2651 
	`sc¡_po¡_·r£
(
ucmd
->
cmd
);

2653 
	`sc¡_po¡_®loc_d©a_buf
(
ucmd
->
cmd
);

2655 
	`TRACE_MGMT_DBG
("Addšg ucmd %°tØaùivli¡", 
ucmd
);

2656 
	`li¡_add
(&
ucmd
->
cmd
->
cmd_li¡_’Œy
,

2657 &
ucmd
->
cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

2658 
	`wake_up
(&
ucmd
->
cmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

2661 
UCMD_STATE_EXECING
:

2662 
UCMD_STATE_EXT_COPY_REMAPPING
:

2663 ià(
æags
 !ð
NULL
)

2664 
	`¥š_uÆock_œq»¡Üe
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
,

2665 *
æags
);

2667 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2669 
	`TRACE_MGMT_DBG
("EXEC: unjammšg ucmd %p", 
ucmd
);

2671 ià(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
ucmd
->
cmd
->
cmd_æags
))

2672 
ucmd
->
abÜ‹d
 = 1;

2674 ià(
busy
)

2675 
	`sc¡_£t_busy
(
ucmd
->
cmd
);

2677 
	`sc¡_£t_cmd_”rÜ
(
ucmd
->
cmd
,

2678 
	`SCST_LOAD_SENSE
(
sc¡_£n£_lun_nÙ_suµÜ‹d
));

2681 ià(
¡©e
 =ð
UCMD_STATE_EXECING
)

2682 
ucmd
->
cmd
->
	`sc¡_cmd_dÚe
(ucmd->cmd, 
SCST_CMD_STATE_DEFAULT
,

2683 
SCST_CONTEXT_THREAD
);

2685 
	`sBUG_ON
(
¡©e
 !ð
UCMD_STATE_EXT_COPY_REMAPPING
);

2686 #iâdeà
CONFIG_SCST_PROC


2687 
	`sc¡_ext_cÝy_»m­_dÚe
(
ucmd
->
cmd
, 
NULL
, 0);

2689 
	`sBUG
();

2694 ià(
æags
 !ð
NULL
)

2695 
	`¥š_lock_œq§ve
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
,

2696 *
æags
);

2698 
	`¥š_lock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2701 
UCMD_STATE_ON_FREEING
:

2702 
UCMD_STATE_ON_CACHE_FREEING
:

2703 
UCMD_STATE_TM_RECEIVED_EXECING
:

2704 
UCMD_STATE_TM_DONE_EXECING
:

2705 
UCMD_STATE_ATTACH_SESS
:

2706 
UCMD_STATE_DETACH_SESS
:

2707 ià(
æags
 !ð
NULL
)

2708 
	`¥š_uÆock_œq»¡Üe
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
,

2709 *
æags
);

2711 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2713 
¡©e
) {

2714 
UCMD_STATE_ON_FREEING
:

2715 
	`dev_u£r_´oûss_»¶y_Ú_ä“
(
ucmd
);

2718 
UCMD_STATE_ON_CACHE_FREEING
:

2719 
	`dev_u£r_´oûss_»¶y_Ú_ÿche_ä“
(
ucmd
);

2722 
UCMD_STATE_TM_RECEIVED_EXECING
:

2723 
UCMD_STATE_TM_DONE_EXECING
:

2724 
	`dev_u£r_´oûss_»¶y_tm_exec
(
ucmd
,

2725 (
¡©e
 =ð
UCMD_STATE_TM_RECEIVED_EXECING
) ?

2726 
SCST_MGMT_STATUS_RECEIVED_STAGE_COMPLETED
 :

2727 
SCST_MGMT_STATUS_FAILED
);

2730 
UCMD_STATE_ATTACH_SESS
:

2731 
UCMD_STATE_DETACH_SESS
:

2732 
	`dev_u£r_´oûss_»¶y_£ss
(
ucmd
, -
EFAULT
);

2736 ià(
æags
 !ð
NULL
)

2737 
	`¥š_lock_œq§ve
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
,

2738 *
æags
);

2740 
	`¥š_lock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2744 
	`PRINT_CRIT_ERROR
("WrÚg ucmd s‹ %x", 
¡©e
);

2745 
	`sBUG
();

2749 
out
:

2750 
	`TRACE_EXIT
();

2752 
	}
}

2754 
	$dev_u£r_unjam_dev
(
sc¡_u£r_dev
 *
dev
)

2755 
	`__»Ëa£s
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
)

2756 
	`__acquœes
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
)

2758 
i
, 
»s
 = 0;

2759 
sc¡_u£r_cmd
 *
ucmd
;

2761 
	`TRACE_ENTRY
();

2763 
	`TRACE_MGMT_DBG
("Unjammšg dev %p", 
dev
);

2765 
	`sgv_poÞ_æush
(
dev
->
poÞ
);

2766 
	`sgv_poÞ_æush
(
dev
->
poÞ_þu¡
);

2768 
	`¥š_lock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2770 
»³©
:

2771 
i
 = 0; i < ()
	`ARRAY_SIZE
(
dev
->
ucmd_hash
); i++) {

2772 
li¡_h—d
 *
h—d
 = &
dev
->
ucmd_hash
[
i
];

2774 
	`li¡_fÜ_—ch_’Œy
(
ucmd
, 
h—d
, 
hash_li¡_’Œy
) {

2775 
»s
++;

2777 ià(!
ucmd
->
£Á_to_u£r
)

2780 ià(
	`ucmd_g‘_check
(
ucmd
))

2783 
	`TRACE_MGMT_DBG
("ucmd %p, s‹ %x, sc¡_cmd %p", 
ucmd
,

2784 
ucmd
->
¡©e
, ucmd->
cmd
);

2786 
	`dev_u£r_unjam_cmd
(
ucmd
, 0, 
NULL
);

2788 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2789 
	`ucmd_put
(
ucmd
);

2790 
	`¥š_lock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2792 
»³©
;

2796 ià(
	`dev_u£r_´oûss_sc¡_commªds
(
dev
) != 0)

2797 
»³©
;

2799 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2801 
	`TRACE_EXIT_RES
(
»s
);

2802  
»s
;

2803 
	}
}

2805 
	$dev_u£r_´oûss_»¶y_tm_exec
(
sc¡_u£r_cmd
 *
ucmd
,

2806 
¡©us
)

2808 
»s
 = 0;

2810 
	`TRACE_ENTRY
();

2812 
	`TRACE_MGMT_DBG
("TM„•ly (ucmd %p, fÀ%d, stu %d)", 
ucmd
,

2813 
ucmd
->
u£r_cmd
.
tm_cmd
.
â
, 
¡©us
);

2815 ià(
¡©us
 =ð
SCST_MGMT_STATUS_TASK_NOT_EXIST
) {

2823 
¡©us
 = 
SCST_MGMT_STATUS_SUCCESS
;

2826 
	`sc¡_async_mcmd_com¶‘ed
(
ucmd
->
mcmd
, 
¡©us
);

2828 
	`ucmd_put
(
ucmd
);

2830 
	`TRACE_EXIT_RES
(
»s
);

2831  
»s
;

2832 
	}
}

2834 
	$dev_u£r_abÜt_»ady_commªds
(
sc¡_u£r_dev
 *
dev
)

2836 
sc¡_u£r_cmd
 *
ucmd
;

2837 
æags
;

2839 
	`TRACE_ENTRY
();

2841 
	`¥š_lock_œq§ve
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
, 
æags
);

2842 
agaš
:

2843 
	`li¡_fÜ_—ch_’Œy
(
ucmd
, &
dev
->
»ady_cmd_li¡
, 
»ady_cmd_li¡_’Œy
) {

2844 ià((
ucmd
->
cmd
 !ð
NULL
è&& !ucmd->
£’_by_u£r
 &&

2845 
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
ucmd
->
cmd
->
cmd_æags
)) {

2846 
ucmd
->
¡©e
) {

2847 
UCMD_STATE_PARSING
:

2848 
UCMD_STATE_BUF_ALLOCING
:

2849 
UCMD_STATE_EXECING
:

2850 
	`TRACE_MGMT_DBG
("AbÜtšg„—dy ucmd %p", 
ucmd
);

2851 
	`li¡_d–
(&
ucmd
->
»ady_cmd_li¡_’Œy
);

2852 
	`dev_u£r_unjam_cmd
(
ucmd
, 0, &
æags
);

2853 
agaš
;

2858 
	`¥š_uÆock_œq»¡Üe
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
, 
æags
);

2860 
	`TRACE_EXIT
();

2862 
	}
}

2865 
	$__dev_u£r_sk_mgmt_â
(
sc¡_mgmt_cmd
 *
mcmd
,

2866 
sc¡_tgt_dev
 *
tgt_dev
, 
boÞ
 
dÚe
)

2868 
sc¡_u£r_cmd
 *
ucmd
;

2869 
sc¡_u£r_dev
 *
dev
 = 
tgt_dev
->dev->
dh_´iv
;

2870 
sc¡_u£r_cmd
 *
ucmd_to_abÜt
 = 
NULL
;

2872 
	`TRACE_ENTRY
();

2912 ià(!
dÚe
)

2913 
	`dev_u£r_abÜt_»ady_commªds
(
dev
);

2916 
ucmd
 = 
	`dev_u£r_®loc_ucmd
(
dev
, 
GFP_ATOMIC
|
__GFP_NOFAIL
);

2917 ià(
ucmd
 =ð
NULL
) {

2918 
	`PRINT_CRIT_ERROR
("Unableo‡llocate TM %d message "

2919 "(dev %s)", 
mcmd
->
â
, 
dev
->
Çme
);

2920 
out
;

2923 
ucmd
->
u£r_cmd_·ylßd_Ën
 =

2924 
	`off£tof
(
sc¡_u£r_g‘_cmd
, 
tm_cmd
) +

2925 (
ucmd
->
u£r_cmd
.
tm_cmd
);

2926 
ucmd
->
u£r_cmd
.
cmd_h
 = ucmd->
h
;

2927 ià(
dÚe
)

2928 
ucmd
->
u£r_cmd
.
subcode
 = 
SCST_USER_TASK_MGMT_DONE
;

2930 
ucmd
->
u£r_cmd
.
subcode
 = 
SCST_USER_TASK_MGMT_RECEIVED
;

2931 
ucmd
->
u£r_cmd
.
tm_cmd
.
£ss_h
 = ()
tgt_dev
;

2932 
ucmd
->
u£r_cmd
.
tm_cmd
.
â
 = 
mcmd
->fn;

2933 
ucmd
->
u£r_cmd
.
tm_cmd
.
cmd_¢
 = 
mcmd
->cmd_sn;

2934 
ucmd
->
u£r_cmd
.
tm_cmd
.
cmd_¢_£t
 = 
mcmd
->cmd_sn_set;

2936 ià(
mcmd
->
cmd_to_abÜt
 !ð
NULL
) {

2937 
ucmd_to_abÜt
 = 
mcmd
->
cmd_to_abÜt
->
dh_´iv
;

2938 ià(
ucmd_to_abÜt
 !ð
NULL
)

2939 
ucmd
->
u£r_cmd
.
tm_cmd
.
cmd_h_to_abÜt
 = 
ucmd_to_abÜt
->
h
;

2942 
	`TRACE_MGMT_DBG
("Preparing TM ucmd %p (h %d, fn %d, cmd_to_abort %p, "

2943 "ucmd_to_abÜˆ%p, cmd_h_to_abÜˆ%d, mcmd %p)", 
ucmd
, ucmd->
h
,

2944 
mcmd
->
â
, mcmd->
cmd_to_abÜt
, 
ucmd_to_abÜt
,

2945 
ucmd
->
u£r_cmd
.
tm_cmd
.
cmd_h_to_abÜt
, 
mcmd
);

2947 
ucmd
->
mcmd
 = mcmd;

2948 ià(
dÚe
)

2949 
ucmd
->
¡©e
 = 
UCMD_STATE_TM_DONE_EXECING
;

2951 
ucmd
->
¡©e
 = 
UCMD_STATE_TM_RECEIVED_EXECING
;

2953 
	`sc¡_´•¬e_async_mcmd
(
mcmd
);

2955 
	`dev_u£r_add_to_»ady
(
ucmd
);

2957 
out
:

2958 
	`TRACE_EXIT
();

2960 
	}
}

2962 
	$dev_u£r_sk_mgmt_â_»ûived
(
sc¡_mgmt_cmd
 *
mcmd
,

2963 
sc¡_tgt_dev
 *
tgt_dev
)

2965 
	`TRACE_ENTRY
();

2966 
	`__dev_u£r_sk_mgmt_â
(
mcmd
, 
tgt_dev
, 
çl£
);

2967 
	`TRACE_EXIT
();

2969 
	}
}

2971 
	$dev_u£r_sk_mgmt_â_dÚe
(
sc¡_mgmt_cmd
 *
mcmd
,

2972 
sc¡_tgt_dev
 *
tgt_dev
)

2974 
	`TRACE_ENTRY
();

2975 
	`__dev_u£r_sk_mgmt_â
(
mcmd
, 
tgt_dev
, 
Œue
);

2976 
	`TRACE_EXIT
();

2978 
	}
}

2980 
	$dev_u£r_©ch
(
sc¡_deviû
 *
sdev
)

2982 
»s
 = 0;

2983 
sc¡_u£r_dev
 *
dev
 = 
NULL
, *
d
;

2985 
	`TRACE_ENTRY
();

2987 
	`¥š_lock
(&
dev_li¡_lock
);

2988 
	`li¡_fÜ_—ch_’Œy
(
d
, &
dev_li¡
, 
dev_li¡_’Œy
) {

2989 ià(
	`¡rcmp
(
d
->
Çme
, 
sdev
->
vœt_Çme
) == 0) {

2990 
dev
 = 
d
;

2994 
	`¥š_uÆock
(&
dev_li¡_lock
);

2995 ià(
dev
 =ð
NULL
) {

2996 
	`PRINT_ERROR
("Deviû % nÙ found", 
sdev
->
vœt_Çme
);

2997 
»s
 = -
EINVAL
;

2998 
out
;

3001 
sdev
->
block_size
 = 
dev
->
def_block_size
;

3002 
sdev
->
ty³
) {

3003 
TYPE_DISK
:

3004 
TYPE_ROM
:

3005 
TYPE_MOD
:

3006 
sdev
->
block_shiá
 = 
	`sc¡_ÿlc_block_shiá
(sdev->
block_size
);

3007 ià(
sdev
->
block_shiá
 < 9) {

3008 
	`PRINT_ERROR
("Inv®id block siz%d", 
sdev
->
block_size
);

3009 
»s
 = -
EINVAL
;

3010 
out
;

3014 
sdev
->
block_shiá
 = -1;

3018 
sdev
->
dh_´iv
 = 
dev
;

3019 
sdev
->
t¡
 = 
dev
->tst;

3020 
sdev
->
tmf_Úly
 = 
dev
->tmf_only;

3021 
sdev
->
tmf_Úly_§ved
 = 
dev
->
tmf_Úly
;

3022 
sdev
->
tmf_Úly_deçuÉ
 = 
dev
->
tmf_Úly
;

3023 
sdev
->
queue_®g
 = 
dev
->queue_alg;

3024 
sdev
->
q”r
 = 
dev
->qerr;

3025 
sdev
->
q”r_§ved
 = 
dev
->
q”r
;

3026 
sdev
->
q”r_deçuÉ
 = 
dev
->
q”r
;

3027 
sdev
->
swp
 = 
dev
->swp;

3028 
sdev
->
swp_§ved
 = 
dev
->
swp
;

3029 
sdev
->
swp_deçuÉ
 = 
dev
->
swp
;

3030 
sdev
->
s
 = 
dev
->tas;

3031 
sdev
->
s_§ved
 = 
dev
->
s
;

3032 
sdev
->
s_deçuÉ
 = 
dev
->
s
;

3033 
sdev
->
d_£n£
 = 
dev
->d_sense;

3034 
sdev
->
d_£n£_§ved
 = 
dev
->
d_£n£
;

3035 
sdev
->
d_£n£_deçuÉ
 = 
dev
->
d_£n£
;

3036 
sdev
->
has_own_Üd”_mgmt
 = 
dev
->has_own_order_mgmt;

3038 
dev
->
sdev
 = sdev;

3040 
	`PRINT_INFO
("Attached user space virtual device \"%s\"",

3041 
dev
->
Çme
);

3043 
out
:

3044 
	`TRACE_EXIT
();

3045  
»s
;

3046 
	}
}

3048 
	$dev_u£r_d‘ach
(
sc¡_deviû
 *
sdev
)

3050 
sc¡_u£r_dev
 *
dev
 = 
sdev
->
dh_´iv
;

3052 
	`TRACE_ENTRY
();

3054 
	`TRACE_DBG
("vœt_id %d", 
sdev
->
vœt_id
);

3056 
	`PRINT_INFO
("Detached user space virtual device \"%s\"",

3057 
dev
->
Çme
);

3060 
sdev
->
dh_´iv
 = 
NULL
;

3061 
dev
->
sdev
 = 
NULL
;

3063 
	`TRACE_EXIT
();

3065 
	}
}

3067 
	$dev_u£r_´oûss_»¶y_£ss
(
sc¡_u£r_cmd
 *
ucmd
, 
¡©us
)

3069 
»s
 = 0;

3070 
æags
;

3072 
	`TRACE_ENTRY
();

3074 
	`TRACE_MGMT_DBG
("ucmd %p, cm¶ %p, stu %d", 
ucmd
, ucmd->
cm¶
, 
¡©us
);

3076 
	`¥š_lock_œq§ve
(&
ucmd
->
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
, 
æags
);

3078 ià(
ucmd
->
¡©e
 =ð
UCMD_STATE_ATTACH_SESS
) {

3079 
	`TRACE_MGMT_DBG
("%s", "ATTACH_SESS finished");

3080 
ucmd
->
»suÉ
 = 
¡©us
;

3081 } ià(
ucmd
->
¡©e
 =ð
UCMD_STATE_DETACH_SESS
) {

3082 
	`TRACE_MGMT_DBG
("%s", "DETACH_SESS finished");

3084 
	`sBUG
();

3086 ià(
ucmd
->
cm¶
 !ð
NULL
)

3087 
	`com¶‘e_®l
(
ucmd
->
cm¶
);

3089 
	`¥š_uÆock_œq»¡Üe
(&
ucmd
->
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
, 
æags
);

3091 
	`ucmd_put
(
ucmd
);

3093 
	`TRACE_EXIT_RES
(
»s
);

3094  
»s
;

3095 
	}
}

3097 
	$dev_u£r_©ch_tgt
(
sc¡_tgt_dev
 *
tgt_dev
)

3099 
sc¡_u£r_dev
 *
dev
 = 
tgt_dev
->dev->
dh_´iv
;

3100 
»s
 = 0, 
rc
;

3101 
sc¡_u£r_cmd
 *
ucmd
;

3102 
	`DECLARE_COMPLETION_ONSTACK
(
cm¶
);

3103 
sc¡_tgt_‹m¶©e
 *
tg‰
 = 
tgt_dev
->
£ss
->
tgt
->tgtt;

3104 
sc¡_tgt
 *
tgt
 = 
tgt_dev
->
£ss
->tgt;

3106 
	`TRACE_ENTRY
();

3108 
tgt_dev
->
aùive_cmd_th»ads
 = &
dev
->
udev_cmd_th»ads
;

3115 ià(
tgt_dev
->
tgt_dev_þu¡_poÞ
)

3116 
tgt_dev
->
dh_´iv
 = 
dev
->
poÞ_þu¡
;

3118 
tgt_dev
->
dh_´iv
 = 
dev
->
poÞ
;

3120 
ucmd
 = 
	`dev_u£r_®loc_ucmd
(
dev
, 
GFP_KERNEL
);

3121 ià(
ucmd
 =ð
NULL
)

3122 
out_nomem
;

3124 
ucmd
->
cm¶
 = &cmpl;

3126 
ucmd
->
u£r_cmd_·ylßd_Ën
 = 
	`off£tof
(
sc¡_u£r_g‘_cmd
, 
£ss
) +

3127 (
ucmd
->
u£r_cmd
.
£ss
);

3128 
ucmd
->
u£r_cmd
.
cmd_h
 = ucmd->
h
;

3129 
ucmd
->
u£r_cmd
.
subcode
 = 
SCST_USER_ATTACH_SESS
;

3130 
ucmd
->
u£r_cmd
.
£ss
.
£ss_h
 = ()
tgt_dev
;

3131 
ucmd
->
u£r_cmd
.
£ss
.
lun
 = (
ušt64_t
)
tgt_dev
->lun;

3132 
ucmd
->
u£r_cmd
.
£ss
.
th»ads_num
 = 
tgt_dev
->£ss->
tgt
->
tg‰
->threads_num;

3133 
ucmd
->
u£r_cmd
.
£ss
.
rd_Úly
 = 
tgt_dev
->
tgt_dev_rd_Úly
;

3134 ià(
tg‰
->
g‘_phys_Œª¥Üt_v”siÚ
 !ð
NULL
)

3135 
ucmd
->
u£r_cmd
.
£ss
.
phys_Œª¥Üt_v”siÚ
 =

3136 
tg‰
->
	`g‘_phys_Œª¥Üt_v”siÚ
(
tgt
);

3137 ià(
tg‰
->
g‘_scsi_Œª¥Üt_v”siÚ
 !ð
NULL
)

3138 
ucmd
->
u£r_cmd
.
£ss
.
scsi_Œª¥Üt_v”siÚ
 =

3139 
tg‰
->
	`g‘_scsi_Œª¥Üt_v”siÚ
(
tgt
);

3140 
	`¡¾ýy
(
ucmd
->
u£r_cmd
.
£ss
.
š™ŸtÜ_Çme
,

3141 
tgt_dev
->
£ss
->
š™ŸtÜ_Çme
,

3142 (
ucmd
->
u£r_cmd
.
£ss
.
š™ŸtÜ_Çme
)-1);

3143 
	`¡¾ýy
(
ucmd
->
u£r_cmd
.
£ss
.
rg‘_Çme
,

3144 
tgt_dev
->
£ss
->
tgt
->
tgt_Çme
,

3145 (
ucmd
->
u£r_cmd
.
£ss
.
rg‘_Çme
)-1);

3147 
	`TRACE_MGMT_DBG
("Preparing ATTACH_SESS %p (h %d, sess_h %llx, LUN %llx, "

3149 
ucmd
, ucmd->
h
, ucmd->
u£r_cmd
.
£ss
.
£ss_h
,

3150 
ucmd
->
u£r_cmd
.
£ss
.
lun
, ucmd->u£r_cmd.£ss.
th»ads_num
,

3151 
ucmd
->
u£r_cmd
.
£ss
.
rd_Úly
, ucmd->u£r_cmd.£ss.
š™ŸtÜ_Çme
,

3152 
ucmd
->
u£r_cmd
.
£ss
.
rg‘_Çme
);

3154 
ucmd
->
¡©e
 = 
UCMD_STATE_ATTACH_SESS
;

3156 
	`ucmd_g‘
(
ucmd
);

3158 
	`dev_u£r_add_to_»ady
(
ucmd
);

3160 
rc
 = 
	`wa™_fÜ_com¶‘iÚ_timeout
(
ucmd
->
cm¶
, 
DEV_USER_ATTACH_TIMEOUT
);

3161 ià(
rc
 > 0)

3162 
»s
 = 
ucmd
->
»suÉ
;

3164 
	`PRINT_ERROR
("%s", "ATTACH_SESS commandimeout");

3165 
»s
 = -
EFAULT
;

3168 
	`sBUG_ON
(
	`œqs_di§bËd
());

3170 
	`¥š_lock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

3171 
ucmd
->
cm¶
 = 
NULL
;

3172 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

3174 
	`ucmd_put
(
ucmd
);

3176 
out
:

3177 
	`TRACE_EXIT_RES
(
»s
);

3178  
»s
;

3180 
out_nomem
:

3181 
»s
 = -
ENOMEM
;

3182 
out
;

3183 
	}
}

3185 
	$dev_u£r_d‘ach_tgt
(
sc¡_tgt_dev
 *
tgt_dev
)

3187 
sc¡_u£r_dev
 *
dev
 = 
tgt_dev
->dev->
dh_´iv
;

3188 
sc¡_u£r_cmd
 *
ucmd
;

3190 
	`TRACE_ENTRY
();

3196 
ucmd
 = 
	`dev_u£r_®loc_ucmd
(
dev
, 
GFP_KERNEL
|
__GFP_NOFAIL
);

3197 ià(
ucmd
 =ð
NULL
) {

3198 
	`PRINT_CRIT_ERROR
("Unableo‡llocate DETACH_SESS message "

3199 "(dev %s)", 
dev
->
Çme
);

3200 
out
;

3203 
	`TRACE_MGMT_DBG
("P»·ršg DETACH_SESS %°(h %d, sess_h %Îx)", 
ucmd
,

3204 
ucmd
->
h
, ucmd->
u£r_cmd
.
£ss
.
£ss_h
);

3206 
ucmd
->
u£r_cmd_·ylßd_Ën
 = 
	`off£tof
(
sc¡_u£r_g‘_cmd
, 
£ss
) +

3207 (
ucmd
->
u£r_cmd
.
£ss
);

3208 
ucmd
->
u£r_cmd
.
cmd_h
 = ucmd->
h
;

3209 
ucmd
->
u£r_cmd
.
subcode
 = 
SCST_USER_DETACH_SESS
;

3210 
ucmd
->
u£r_cmd
.
£ss
.
£ss_h
 = ()
tgt_dev
;

3212 
ucmd
->
¡©e
 = 
UCMD_STATE_DETACH_SESS
;

3214 
	`dev_u£r_add_to_»ady
(
ucmd
);

3216 
out
:

3217 
	`TRACE_EXIT
();

3219 
	}
}

3222 
	$dev_u£r_£tup_funùiÚs
(
sc¡_u£r_dev
 *
dev
)

3224 
	`TRACE_ENTRY
();

3226 
dev
->
devty³
.
·r£
 = 
dev_u£r_·r£
;

3227 
dev
->
devty³
.
dev_®loc_d©a_buf
 = 
dev_u£r_®loc_d©a_buf
;

3228 
dev
->
devty³
.
dev_dÚe
 = 
NULL
;

3230 
dev
->
devty³
.
ext_cÝy_»m­
 = 
NULL
;

3231 #iâdeà
CONFIG_SCST_PROC


3232 ià(
dev
->
ext_cÝy_»m­_suµÜ‹d
)

3233 
dev
->
devty³
.
ext_cÝy_»m­
 = 
dev_u£r_ext_cÝy_»m­
;

3236 ià(
dev
->
·r£_ty³
 !ð
SCST_USER_PARSE_CALL
) {

3237 
dev
->
devty³
.
ty³
) {

3238 
TYPE_DISK
:

3239 
dev
->
g’”ic_·r£
 = 
sc¡_sbc_g’”ic_·r£
;

3240 
dev
->
devty³
.
dev_dÚe
 = 
dev_u£r_disk_dÚe
;

3243 
TYPE_TAPE
:

3244 
dev
->
g’”ic_·r£
 = 
sc¡_³_g’”ic_·r£
;

3245 
dev
->
devty³
.
dev_dÚe
 = 
dev_u£r_³_dÚe
;

3248 
TYPE_MOD
:

3249 
dev
->
g’”ic_·r£
 = 
sc¡_modisk_g’”ic_·r£
;

3250 
dev
->
devty³
.
dev_dÚe
 = 
dev_u£r_disk_dÚe
;

3253 
TYPE_ROM
:

3254 
dev
->
g’”ic_·r£
 = 
sc¡_cdrom_g’”ic_·r£
;

3255 
dev
->
devty³
.
dev_dÚe
 = 
dev_u£r_disk_dÚe
;

3258 
TYPE_MEDIUM_CHANGER
:

3259 
dev
->
g’”ic_·r£
 = 
sc¡_chªg”_g’”ic_·r£
;

3262 
TYPE_PROCESSOR
:

3263 
dev
->
g’”ic_·r£
 = 
sc¡_´oûssÜ_g’”ic_·r£
;

3266 
TYPE_RAID
:

3267 
dev
->
g’”ic_·r£
 = 
sc¡_¿id_g’”ic_·r£
;

3271 
	`PRINT_INFO
("Unknown SCSIype %x, using PARSE_CALL "

3272 "fÜ it", 
dev
->
devty³
.
ty³
);

3273 
dev
->
·r£_ty³
 = 
SCST_USER_PARSE_CALL
;

3277 
dev
->
g’”ic_·r£
 = 
NULL
;

3278 
dev
->
devty³
.
dev_dÚe
 = 
NULL
;

3281 
	`TRACE_EXIT
();

3283 
	}
}

3285 
	$dev_u£r_check_v”siÚ
(cÚ¡ 
sc¡_u£r_dev_desc
 *
dev_desc
)

3287 
¡r
[(
DEV_USER_VERSION
) > 20 ? (DEV_USER_VERSION) : 20];

3288 
»s
 = 0, 
rc
;

3290 
rc
 = 
	`cÝy_äom_u£r
(
¡r
,

3291 (
__u£r
 *)()
dev_desc
->
liûn£_¡r
,

3292 (
¡r
));

3293 ià(
rc
 != 0) {

3294 
	`PRINT_ERROR
("%s", "Unableo get†icense string");

3295 
»s
 = -
EFAULT
;

3296 
out
;

3298 
¡r
[(str)-1] = '\0';

3300 ià((
	`¡rcmp
(
¡r
, "GPL") != 0) &&

3301 (
	`¡rcmp
(
¡r
, "GPL v2") != 0) &&

3302 (
	`¡rcmp
(
¡r
, "Dual BSD/GPL") != 0) &&

3303 (
	`¡rcmp
(
¡r
, "Dual MIT/GPL") != 0) &&

3304 (
	`¡rcmp
(
¡r
, "Dual MPL/GPL") != 0)) {

3306 
	`PRINT_ERROR
("Unsupported†icense of user device %s (%s). "

3308 
dev_desc
->
Çme
, 
¡r
);

3309 
»s
 = -
EPERM
;

3310 
out
;

3313 
rc
 = 
	`cÝy_äom_u£r
(
¡r
,

3314 (
__u£r
 *)()
dev_desc
->
v”siÚ_¡r
,

3315 (
¡r
));

3316 ià(
rc
 != 0) {

3317 
	`PRINT_ERROR
("%s", "Unableo get version string");

3318 
»s
 = -
EFAULT
;

3319 
out
;

3321 
¡r
[(str)-1] = '\0';

3323 ià(
	`¡rcmp
(
¡r
, 
DEV_USER_VERSION
) != 0) {

3325 
	`PRINT_ERROR
("Incorrect version of user device %s (%s). "

3326 "Ex³ùed: %s", 
dev_desc
->
Çme
, 
¡r
,

3327 
DEV_USER_VERSION
);

3328 
»s
 = -
EINVAL
;

3329 
out
;

3332 
out
:

3333  
»s
;

3334 
	}
}

3336 
	$dev_u£r_»gi¡”_dev
(
fže
 *file,

3337 cÚ¡ 
sc¡_u£r_dev_desc
 *
dev_desc
)

3339 
»s
, 
i
;

3340 
sc¡_u£r_dev
 *
dev
, *
d
;

3341 
block_size
;

3343 
	`TRACE_ENTRY
();

3345 
»s
 = 
	`dev_u£r_check_v”siÚ
(
dev_desc
);

3346 ià(
»s
 != 0)

3347 
out
;

3349 
dev_desc
->
ty³
) {

3350 
TYPE_DISK
:

3351 
TYPE_ROM
:

3352 
TYPE_MOD
:

3353 ià(
dev_desc
->
block_size
 == 0) {

3354 
	`PRINT_ERROR
("WrÚg block siz%d", 
dev_desc
->
block_size
);

3355 
»s
 = -
EINVAL
;

3356 
out
;

3358 
block_size
 = 
dev_desc
->block_size;

3359 ià(
	`sc¡_ÿlc_block_shiá
(
block_size
) == -1) {

3360 
»s
 = -
EINVAL
;

3361 
out
;

3365 
block_size
 = 
dev_desc
->block_size;

3369 ià(!
	`Œy_moduË_g‘
(
THIS_MODULE
)) {

3370 
	`PRINT_ERROR
("%s", "Failo get module");

3371 
»s
 = -
ETXTBSY
;

3372 
out
;

3375 
dev
 = 
	`kmem_ÿche_z®loc
(
u£r_dev_ÿch•
, 
GFP_KERNEL
);

3376 ià(
dev
 =ð
NULL
) {

3377 
»s
 = -
ENOMEM
;

3378 
out_put
;

3381 
	`INIT_LIST_HEAD
(&
dev
->
»ady_cmd_li¡
);

3382 ià(
fže
->
f_æags
 & 
O_NONBLOCK
) {

3383 
	`TRACE_DBG
("%s", "Non-blocking operations");

3384 
dev
->
blockšg
 = 0;

3386 
dev
->
blockšg
 = 1;

3387 
i
 = 0; i < ()
	`ARRAY_SIZE
(
dev
->
ucmd_hash
); i++)

3388 
	`INIT_LIST_HEAD
(&
dev
->
ucmd_hash
[
i
]);

3390 
	`sc¡_š™_th»ads
(&
dev
->
udev_cmd_th»ads
);

3392 
	`¡¾ýy
(
dev
->
Çme
, 
dev_desc
->name, (dev->name)-1);

3394 
	`sc¡_š™_mem_lim
(&
dev
->
udev_mem_lim
);

3396 
	`sú´štf
(
dev
->
devty³
.
Çme
, (dev->devtype.name), "%s",

3397 (
dev_desc
->
sgv_Çme
[0] =ð'\0'è? 
dev
->
Çme
 :

3398 
dev_desc
->
sgv_Çme
);

3399 
dev
->
poÞ
 = 
	`sgv_poÞ_ü—‹
(dev->
devty³
.
Çme
, 
sgv_no_þu¡”šg
,

3400 
dev_desc
->
sgv_sšgË_®loc_·ges
,

3401 
dev_desc
->
sgv_sh¬ed
,

3402 
dev_desc
->
sgv_purge_š‹rv®
 * 
HZ
);

3403 ià(
dev
->
poÞ
 =ð
NULL
) {

3404 
»s
 = -
ENOMEM
;

3405 
out_deš™_th»ads
;

3407 
	`sgv_poÞ_£t_®loÿtÜ
(
dev
->
poÞ
, 
dev_u£r_®loc_·ges
,

3408 
dev_u£r_ä“_sg_’Œ›s
);

3410 ià(!
dev_desc
->
sgv_di§bË_þu¡”ed_poÞ
) {

3411 
	`sú´štf
(
dev
->
devty³
.
Çme
, (dev->devtype.name),

3413 (
dev_desc
->
sgv_Çme
[0] =ð'\0'è? 
dev
->
Çme
 :

3414 
dev_desc
->
sgv_Çme
);

3415 
dev
->
poÞ_þu¡
 = 
	`sgv_poÞ_ü—‹
(dev->
devty³
.
Çme
,

3416 
sgv_ž_þu¡”šg
,

3417 
dev_desc
->
sgv_sšgË_®loc_·ges
,

3418 
dev_desc
->
sgv_sh¬ed
,

3419 
dev_desc
->
sgv_purge_š‹rv®
 * 
HZ
);

3420 ià(
dev
->
poÞ_þu¡
 =ð
NULL
) {

3421 
»s
 = -
ENOMEM
;

3422 
out_ä“0
;

3424 
	`sgv_poÞ_£t_®loÿtÜ
(
dev
->
poÞ_þu¡
, 
dev_u£r_®loc_·ges
,

3425 
dev_u£r_ä“_sg_’Œ›s
);

3427 
dev
->
poÞ_þu¡
 = dev->
poÞ
;

3428 
	`sgv_poÞ_g‘
(
dev
->
poÞ_þu¡
);

3431 
	`sú´štf
(
dev
->
devty³
.
Çme
, (dev->devtype.name), "%s",

3432 
dev
->
Çme
);

3433 
dev
->
devty³
.
ty³
 = 
dev_desc
->type;

3434 
dev
->
devty³
.
th»ads_num
 = -1;

3435 
dev
->
devty³
.
·r£_©omic
 = 1;

3436 
dev
->
devty³
.
dev_®loc_d©a_buf_©omic
 = 1;

3437 
dev
->
devty³
.
dev_dÚe_©omic
 = 1;

3438 #ifdeà
CONFIG_SCST_PROC


3439 
dev
->
devty³
.
no_´oc
 = 1;

3441 
dev
->
devty³
.
dev_©Œs
 = 
dev_u£r_dev_©Œs
;

3443 
dev
->
devty³
.
©ch
 = 
dev_u£r_©ch
;

3444 
dev
->
devty³
.
d‘ach
 = 
dev_u£r_d‘ach
;

3445 
dev
->
devty³
.
©ch_tgt
 = 
dev_u£r_©ch_tgt
;

3446 
dev
->
devty³
.
d‘ach_tgt
 = 
dev_u£r_d‘ach_tgt
;

3447 
dev
->
devty³
.
exec
 = 
dev_u£r_exec
;

3448 
dev
->
devty³
.
Ú_ä“_cmd
 = 
dev_u£r_Ú_ä“_cmd
;

3449 
dev
->
devty³
.
sk_mgmt_â_»ûived
 = 
dev_u£r_sk_mgmt_â_»ûived
;

3450 
dev
->
devty³
.
sk_mgmt_â_dÚe
 = 
dev_u£r_sk_mgmt_â_dÚe
;

3451 ià(
dev_desc
->
’abË_´_cmds_nÙifiÿtiÚs
)

3452 
dev
->
devty³
.
´_cmds_nÙifiÿtiÚs
 = 1;

3454 
	`š™_com¶‘iÚ
(&
dev
->
þ—nup_cm¶
);

3455 
dev
->
def_block_size
 = 
block_size
;

3457 
»s
 = 
	`__dev_u£r_£t_Ýt
(
dev
, &
dev_desc
->
Ýt
);

3458 ià(
»s
 != 0)

3459 
out_ä“
;

3461 
	`TRACE_MEM
("dev %p,‚am%s", 
dev
, dev->
Çme
);

3463 
	`¥š_lock
(&
dev_li¡_lock
);

3465 
	`li¡_fÜ_—ch_’Œy
(
d
, &
dev_li¡
, 
dev_li¡_’Œy
) {

3466 ià(
	`¡rcmp
(
d
->
Çme
, 
dev
->name) == 0) {

3467 
	`PRINT_ERROR
("Device %s‡lreadyƒxist",

3468 
dev
->
Çme
);

3469 
»s
 = -
EEXIST
;

3470 
	`¥š_uÆock
(&
dev_li¡_lock
);

3471 
out_ä“
;

3475 
	`li¡_add_ž
(&
dev
->
dev_li¡_’Œy
, &
dev_li¡
);

3477 
	`¥š_uÆock
(&
dev_li¡_lock
);

3479 
»s
 = 
	`sc¡_»gi¡”_vœtu®_dev_driv”
(&
dev
->
devty³
);

3480 ià(
»s
 < 0)

3481 
out_d–_ä“
;

3483 
dev
->
vœt_id
 = 
	`sc¡_»gi¡”_vœtu®_deviû
(&dev->
devty³
, dev->
Çme
);

3484 ià(
dev
->
vœt_id
 < 0) {

3485 
»s
 = 
dev
->
vœt_id
;

3486 
out_uÄeg_hªdËr
;

3489 
	`¥š_lock
(&
dev_li¡_lock
);

3490 ià(
fže
->
´iv©e_d©a
 !ð
NULL
) {

3491 
	`¥š_uÆock
(&
dev_li¡_lock
);

3492 
	`PRINT_ERROR
("%s", "Device‡lready„egistered");

3493 
»s
 = -
EINVAL
;

3494 
out_uÄeg_drv
;

3500 
fže
->
´iv©e_d©a
 = 
dev
;

3501 
	`¥š_uÆock
(&
dev_li¡_lock
);

3503 
out
:

3504 
	`TRACE_EXIT_RES
(
»s
);

3505  
»s
;

3507 
out_uÄeg_drv
:

3508 
	`sc¡_uÄegi¡”_vœtu®_deviû
(
dev
->
vœt_id
);

3510 
out_uÄeg_hªdËr
:

3511 
	`sc¡_uÄegi¡”_vœtu®_dev_driv”
(&
dev
->
devty³
);

3513 
out_d–_ä“
:

3514 
	`¥š_lock
(&
dev_li¡_lock
);

3515 
	`li¡_d–
(&
dev
->
dev_li¡_’Œy
);

3516 
	`¥š_uÆock
(&
dev_li¡_lock
);

3518 
out_ä“
:

3519 
	`sgv_poÞ_d–
(
dev
->
poÞ_þu¡
);

3521 
out_ä“0
:

3522 
	`sgv_poÞ_d–
(
dev
->
poÞ
);

3524 
out_deš™_th»ads
:

3525 
	`sc¡_deš™_th»ads
(&
dev
->
udev_cmd_th»ads
);

3527 
	`kmem_ÿche_ä“
(
u£r_dev_ÿch•
, 
dev
);

3529 
out_put
:

3530 
	`moduË_put
(
THIS_MODULE
);

3531 
out
;

3532 
	}
}

3534 
	$dev_u£r_uÄegi¡”_dev
(
fže
 *file)

3536 
	`PRINT_WARNING
("SCST_USER_UNREGISTER_DEVICE is obsolete‡nd NOOP. "

3539 
	}
}

3541 
	$dev_u£r_æush_ÿche
(
fže
 *file)

3543 
»s
;

3544 
sc¡_u£r_dev
 *
dev
;

3546 
	`TRACE_ENTRY
();

3548 
dev
 = 
fže
->
´iv©e_d©a
;

3549 
»s
 = 
	`dev_u£r_check_»g
(
dev
);

3550 ià(
	`uÆik–y
(
»s
 != 0))

3551 
out
;

3553 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
SCST_SUSPEND_TIMEOUT_USER
);

3554 ià(
»s
 != 0)

3555 
out
;

3557 
	`sgv_poÞ_æush
(
dev
->
poÞ
);

3558 
	`sgv_poÞ_æush
(
dev
->
poÞ_þu¡
);

3560 
	`sc¡_»sume_aùiv™y
();

3562 
out
:

3563 
	`TRACE_EXIT_RES
(
»s
);

3564  
»s
;

3565 
	}
}

3567 
	$dev_u£r_ÿ·c™y_chªged
(
fže
 *file)

3569 
»s
;

3570 
sc¡_u£r_dev
 *
dev
;

3572 
	`TRACE_ENTRY
();

3574 
dev
 = 
fže
->
´iv©e_d©a
;

3575 
»s
 = 
	`dev_u£r_check_»g
(
dev
);

3576 ià(
	`uÆik–y
(
»s
 != 0))

3577 
out
;

3579 
	`sc¡_ÿ·c™y_d©a_chªged
(
dev
->
sdev
);

3581 
out
:

3582 
	`TRACE_EXIT_RES
(
»s
);

3583  
»s
;

3584 
	}
}

3586 
	$dev_u£r_´—Îoc_bufãr
(
fže
 *fže, 
__u£r
 *
¬g
)

3588 
»s
 = 0, 
rc
;

3589 
sc¡_u£r_dev
 *
dev
;

3590 
sc¡_u£r_´—Îoc_bufãr
 
´e
;

3591 
®igÃd_u64
 
pbuf
;

3592 
ušt32_t
 
bufæ’
;

3593 
sc¡_u£r_cmd
 *
ucmd
;

3594 
·ges
, 
sg_út
;

3595 
sgv_poÞ
 *
poÞ
;

3596 
sÿ‰”li¡
 *
sg
;

3598 
	`TRACE_ENTRY
();

3600 
dev
 = 
fže
->
´iv©e_d©a
;

3601 
»s
 = 
	`dev_u£r_check_»g
(
dev
);

3602 ià(
	`uÆik–y
(
»s
 != 0))

3603 
out
;

3605 
rc
 = 
	`cÝy_äom_u£r
(&
´e
.
š
, 
¬g
, (pre.in));

3606 ià(
	`uÆik–y
(
rc
 != 0)) {

3607 
	`PRINT_ERROR
("FažedØcÝy %d u£r' by‹s", 
rc
);

3608 
»s
 = -
EFAULT
;

3609 
out
;

3612 
	`TRACE_MEM
("Prealloc buffer with size %dKB for dev %s",

3613 
´e
.
š
.
bufæ’
 / 1024, 
dev
->
Çme
);

3614 
	`TRACE_BUFFER
("IÅuˆ·¿m", &
´e
.
š
, (pre.in));

3616 
pbuf
 = 
´e
.
š
.pbuf;

3617 
bufæ’
 = 
´e
.
š
.bufflen;

3619 
ucmd
 = 
	`dev_u£r_®loc_ucmd
(
dev
, 
GFP_KERNEL
);

3620 ià(
ucmd
 =ð
NULL
) {

3621 
»s
 = -
ENOMEM
;

3622 
out
;

3625 
ucmd
->
buff_ÿched
 = 1;

3627 
	`TRACE_MEM
("ucmd %p,…buà%Îx", 
ucmd
, 
pbuf
);

3629 ià(
	`uÆik–y
((
pbuf
 & ~
PAGE_MASK
) != 0)) {

3630 
	`PRINT_ERROR
("Suµl›d…buà%Îx i¢'ˆ·g®igÃd", 
pbuf
);

3631 
»s
 = -
EINVAL
;

3632 
out_put
;

3635 
·ges
 = 
	`ÿlc_num_pg
(
pbuf
, 
bufæ’
);

3636 
»s
 = 
	`dev_u£r_m­_buf
(
ucmd
, 
pbuf
, 
·ges
);

3637 ià(
»s
 != 0)

3638 
out_put
;

3640 ià(
´e
.
š
.
fÜ_þu¡_poÞ
)

3641 
poÞ
 = 
dev
->
poÞ_þu¡
;

3643 
poÞ
 = 
dev
->pool;

3645 
sg
 = 
	`sgv_poÞ_®loc
(
poÞ
, 
bufæ’
, 
GFP_KERNEL
, 
SGV_POOL_ALLOC_GET_NEW
,

3646 &
sg_út
, &
ucmd
->
sgv
, &
dev
->
udev_mem_lim
, ucmd);

3647 ià(
sg
 !ð
NULL
) {

3648 
sc¡_u£r_cmd
 *
buf_ucmd
 = 
	`sgv_g‘_´iv
(
ucmd
->
sgv
);

3650 
	`TRACE_MEM
("Buf ucmd %p (sg_cnt %d,†ast seg†en %d, "

3651 "bufæ’ %d)", 
buf_ucmd
, 
sg_út
,

3652 
sg
[
sg_út
-1].
Ëngth
, 
bufæ’
);

3654 
	`EXTRACHECKS_BUG_ON
(
ucmd
 !ð
buf_ucmd
);

3656 
ucmd
->
buf_ucmd
 = buf_ucmd;

3658 
»s
 = -
ENOMEM
;

3659 
out_put
;

3662 
	`dev_u£r_ä“_sgv
(
ucmd
);

3664 
´e
.
out
.
cmd_h
 = 
ucmd
->
h
;

3665 
rc
 = 
	`cÝy_to_u£r
(
¬g
, &
´e
.
out
, (pre.out));

3666 ià(
	`uÆik–y
(
rc
 != 0)) {

3667 
	`PRINT_ERROR
("FažedØcÝyØu£¸%d by‹s", 
rc
);

3668 
»s
 = -
EFAULT
;

3669 
out_put
;

3672 
out_put
:

3673 
	`ucmd_put
(
ucmd
);

3675 
out
:

3676 
	`TRACE_EXIT_RES
(
»s
);

3677  
»s
;

3678 
	}
}

3680 
	$__dev_u£r_£t_Ýt
(
sc¡_u£r_dev
 *
dev
,

3681 cÚ¡ 
sc¡_u£r_Ýt
 *
Ýt
)

3683 
»s
 = 0;

3685 
	`TRACE_ENTRY
();

3687 
	`TRACE_DBG
("dev %s,…arse_type %x, on_free_cmd_type %x, "

3690 
dev
->
Çme
, 
Ýt
->
·r£_ty³
, o±->
Ú_ä“_cmd_ty³
,

3691 
Ýt
->
memÜy_»u£_ty³
, o±->
·¹Ÿl_Œªsãrs_ty³
,

3692 
Ýt
->
·¹Ÿl_Ën
, o±->
ext_cÝy_»m­_suµÜ‹d
);

3694 ià(
Ýt
->
·r£_ty³
 > 
SCST_USER_MAX_PARSE_OPT
 ||

3695 
Ýt
->
Ú_ä“_cmd_ty³
 > 
SCST_USER_MAX_ON_FREE_CMD_OPT
 ||

3696 
Ýt
->
memÜy_»u£_ty³
 > 
SCST_USER_MAX_MEM_REUSE_OPT
 ||

3697 
Ýt
->
·¹Ÿl_Œªsãrs_ty³
 > 
SCST_USER_MAX_PARTIAL_TRANSFERS_OPT
) {

3698 
	`PRINT_ERROR
("%s", "Invalid option");

3699 
»s
 = -
EINVAL
;

3700 
out
;

3703 ià(((
Ýt
->
t¡
 !ð
SCST_TST_0_SINGLE_TASK_SET
) &&

3704 (
Ýt
->
t¡
 !ð
SCST_TST_1_SEP_TASK_SETS
)) ||

3705 (
Ýt
->
tmf_Úly
 > 1) ||

3706 ((
Ýt
->
queue_®g
 !ð
SCST_QUEUE_ALG_0_RESTRICTED_REORDER
) &&

3707 (
Ýt
->
queue_®g
 !ð
SCST_QUEUE_ALG_1_UNRESTRICTED_REORDER
)) ||

3708 ((
Ýt
->
q”r
 =ð
SCST_QERR_2_RESERVED
) ||

3709 (
Ýt
->
q”r
 > 
SCST_QERR_3_ABORT_THIS_NEXUS_ONLY
)) ||

3710 (
Ýt
->
swp
 > 1è|| (Ýt->
s
 > 1è|| (Ýt->
has_own_Üd”_mgmt
 > 1) ||

3711 (
Ýt
->
d_£n£
 > 1è|| (Ýt->
ext_cÝy_»m­_suµÜ‹d
 > 1)) {

3712 
	`PRINT_ERROR
("Invalid SCSI option (tst %x,mf_only %x, "

3715 
Ýt
->
t¡
, o±->
tmf_Úly
, o±->
queue_®g
, o±->
q”r
,

3716 
Ýt
->
swp
, o±->
s
, o±->
d_£n£
, o±->
has_own_Üd”_mgmt
,

3717 
Ýt
->
ext_cÝy_»m­_suµÜ‹d
);

3718 
»s
 = -
EINVAL
;

3719 
out
;

3723 ià((
dev
->
t¡
 !ð
Ýt
->t¡è&& (dev->
sdev
 !ð
NULL
) &&

3724 !
	`li¡_em±y
(&
dev
->
sdev
->
dev_tgt_dev_li¡
)) {

3725 
	`PRINT_ERROR
("Onhe fly setting of TST‚ot supported. "

3727 
»s
 = -
EINVAL
;

3728 
out
;

3732 
dev
->
·r£_ty³
 = 
Ýt
->parse_type;

3733 
dev
->
Ú_ä“_cmd_ty³
 = 
Ýt
->on_free_cmd_type;

3734 
dev
->
memÜy_»u£_ty³
 = 
Ýt
->memory_reuse_type;

3735 
dev
->
·¹Ÿl_Œªsãrs_ty³
 = 
Ýt
->partial_transfers_type;

3736 
dev
->
·¹Ÿl_Ën
 = 
Ýt
->partial_len;

3738 
dev
->
t¡
 = 
Ýt
->tst;

3739 
dev
->
tmf_Úly
 = 
Ýt
->tmf_only;

3740 
dev
->
queue_®g
 = 
Ýt
->queue_alg;

3741 
dev
->
q”r
 = 
Ýt
->qerr;

3742 
dev
->
swp
 = 
Ýt
->swp;

3743 
dev
->
s
 = 
Ýt
->tas;

3744 
dev
->
d_£n£
 = 
Ýt
->d_sense;

3745 
dev
->
has_own_Üd”_mgmt
 = 
Ýt
->has_own_order_mgmt;

3746 
dev
->
ext_cÝy_»m­_suµÜ‹d
 = 
Ýt
->ext_copy_remap_supported;

3747 ià(
dev
->
sdev
 !ð
NULL
) {

3748 
dev
->
sdev
->
t¡
 = 
Ýt
->tst;

3749 
dev
->
sdev
->
tmf_Úly
 = 
Ýt
->tmf_only;

3750 
dev
->
sdev
->
queue_®g
 = 
Ýt
->queue_alg;

3751 
dev
->
sdev
->
q”r
 = 
Ýt
->qerr;

3752 
dev
->
sdev
->
swp
 = 
Ýt
->swp;

3753 
dev
->
sdev
->
s
 = 
Ýt
->tas;

3754 
dev
->
sdev
->
d_£n£
 = 
Ýt
->d_sense;

3755 
dev
->
sdev
->
has_own_Üd”_mgmt
 = 
Ýt
->has_own_order_mgmt;

3758 
	`dev_u£r_£tup_funùiÚs
(
dev
);

3760 
out
:

3761 
	`TRACE_EXIT_RES
(
»s
);

3762  
»s
;

3763 
	}
}

3765 
	$dev_u£r_£t_Ýt
(
fže
 *fže, cÚ¡ 
sc¡_u£r_Ýt
 *
Ýt
)

3767 
»s
;

3768 
sc¡_u£r_dev
 *
dev
;

3770 
	`TRACE_ENTRY
();

3772 
dev
 = 
fže
->
´iv©e_d©a
;

3773 
»s
 = 
	`dev_u£r_check_»g
(
dev
);

3774 ià(
	`uÆik–y
(
»s
 != 0))

3775 
out
;

3777 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
SCST_SUSPEND_TIMEOUT_USER
);

3778 ià(
»s
 != 0)

3779 
out
;

3781 
»s
 = 
	`__dev_u£r_£t_Ýt
(
dev
, 
Ýt
);

3783 
	`sc¡_»sume_aùiv™y
();

3785 
out
:

3786 
	`TRACE_EXIT_RES
(
»s
);

3787  
»s
;

3788 
	}
}

3790 
	$dev_u£r_g‘_Ýt
(
fže
 *fže, 
__u£r
 *
¬g
)

3792 
»s
, 
rc
;

3793 
sc¡_u£r_dev
 *
dev
;

3794 
sc¡_u£r_Ýt
 
Ýt
;

3796 
	`TRACE_ENTRY
();

3798 
dev
 = 
fže
->
´iv©e_d©a
;

3799 
»s
 = 
	`dev_u£r_check_»g
(
dev
);

3800 ià(
	`uÆik–y
(
»s
 != 0))

3801 
out
;

3803 
	`mem£t
(&
Ýt
, 0, (opt));

3804 
Ýt
.
·r£_ty³
 = 
dev
->parse_type;

3805 
Ýt
.
Ú_ä“_cmd_ty³
 = 
dev
->on_free_cmd_type;

3806 
Ýt
.
memÜy_»u£_ty³
 = 
dev
->memory_reuse_type;

3807 
Ýt
.
·¹Ÿl_Œªsãrs_ty³
 = 
dev
->partial_transfers_type;

3808 
Ýt
.
·¹Ÿl_Ën
 = 
dev
->partial_len;

3809 
Ýt
.
t¡
 = 
dev
->tst;

3810 
Ýt
.
tmf_Úly
 = 
dev
->tmf_only;

3811 
Ýt
.
queue_®g
 = 
dev
->queue_alg;

3812 
Ýt
.
q”r
 = 
dev
->qerr;

3813 
Ýt
.
s
 = 
dev
->tas;

3814 
Ýt
.
swp
 = 
dev
->swp;

3815 
Ýt
.
d_£n£
 = 
dev
->d_sense;

3816 
Ýt
.
has_own_Üd”_mgmt
 = 
dev
->has_own_order_mgmt;

3817 
Ýt
.
ext_cÝy_»m­_suµÜ‹d
 = 
dev
->ext_copy_remap_supported;

3819 
	`TRACE_DBG
("dev %s,…arse_type %x, on_free_cmd_type %x, "

3821 "·¹Ÿl_ËÀ%d,ƒxt_cÝy_»m­_suµÜ‹d %d", 
dev
->
Çme
,

3822 
Ýt
.
·r£_ty³
, o±.
Ú_ä“_cmd_ty³
, o±.
memÜy_»u£_ty³
,

3823 
Ýt
.
·¹Ÿl_Œªsãrs_ty³
, o±.
·¹Ÿl_Ën
,

3824 
Ýt
.
ext_cÝy_»m­_suµÜ‹d
);

3826 
rc
 = 
	`cÝy_to_u£r
(
¬g
, &
Ýt
, (opt));

3827 ià(
	`uÆik–y
(
rc
 != 0)) {

3828 
	`PRINT_ERROR
("FažedØcÝyØu£¸%d by‹s", 
rc
);

3829 
»s
 = -
EFAULT
;

3830 
out
;

3833 
out
:

3834 
	`TRACE_EXIT_RES
(
»s
);

3835  
»s
;

3836 
	}
}

3838 
	$dev_u¤_·r£
(
sc¡_cmd
 *
cmd
)

3840 
	`sBUG
();

3841  
SCST_CMD_STATE_DEFAULT
;

3842 
	}
}

3844 
	$dev_u£r_ex™_dev
(
sc¡_u£r_dev
 *
dev
)

3846 
	`TRACE_ENTRY
();

3848 
	`TRACE
(
TRACE_MGMT
, "R–—sšg dev %s", 
dev
->
Çme
);

3850 
	`¥š_lock
(&
dev_li¡_lock
);

3851 
	`li¡_d–
(&
dev
->
dev_li¡_’Œy
);

3852 
	`¥š_uÆock
(&
dev_li¡_lock
);

3854 
dev
->
blockšg
 = 0;

3855 
	`wake_up_®l
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_wa™Q
);

3857 
	`¥š_lock
(&
þ—nup_lock
);

3858 
	`li¡_add_ž
(&
dev
->
þ—nup_li¡_’Œy
, &
þ—nup_li¡
);

3859 
	`¥š_uÆock
(&
þ—nup_lock
);

3861 
	`wake_up
(&
þ—nup_li¡_wa™Q
);

3863 
	`sc¡_uÄegi¡”_vœtu®_deviû
(
dev
->
vœt_id
);

3864 
	`sc¡_uÄegi¡”_vœtu®_dev_driv”
(&
dev
->
devty³
);

3866 
	`sgv_poÞ_æush
(
dev
->
poÞ_þu¡
);

3867 
	`sgv_poÞ_æush
(
dev
->
poÞ
);

3869 
	`TRACE_MGMT_DBG
("UÄegi¡”šg fšished (dev %p)", 
dev
);

3871 
dev
->
þ—nup_dÚe
 = 1;

3873 
	`wake_up
(&
þ—nup_li¡_wa™Q
);

3874 
	`wake_up
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_wa™Q
);

3876 
	`wa™_fÜ_com¶‘iÚ
(&
dev
->
þ—nup_cm¶
);

3878 
	`sgv_poÞ_d–
(
dev
->
poÞ_þu¡
);

3879 
	`sgv_poÞ_d–
(
dev
->
poÞ
);

3881 
	`sc¡_deš™_th»ads
(&
dev
->
udev_cmd_th»ads
);

3883 
	`TRACE_MGMT_DBG
("R–—sšg com¶‘ed (dev %p)", 
dev
);

3885 
	`moduË_put
(
THIS_MODULE
);

3887 
	`TRACE_EXIT
();

3889 
	}
}

3891 
	$__dev_u£r_»Ëa£
(*
¬g
)

3893 
sc¡_u£r_dev
 *
dev
 = 
¬g
;

3895 
	`dev_u£r_ex™_dev
(
dev
);

3896 
	`kmem_ÿche_ä“
(
u£r_dev_ÿch•
, 
dev
);

3898 
	}
}

3900 
	$dev_u£r_»Ëa£
(
šode
 *šode, 
fže
 *file)

3902 
sc¡_u£r_dev
 *
dev
;

3903 
sk_¡ruù
 *
t
;

3905 
	`TRACE_ENTRY
();

3907 
dev
 = 
fže
->
´iv©e_d©a
;

3908 ià(
dev
 =ð
NULL
)

3909 
out
;

3910 
fže
->
´iv©e_d©a
 = 
NULL
;

3912 
	`TRACE_MGMT_DBG
("GošgØ»Ëa£ dev %s", 
dev
->
Çme
);

3914 
t
 = 
	`kth»ad_run
(
__dev_u£r_»Ëa£
, 
dev
, "scst_usr_released");

3915 ià(
	`IS_ERR
(
t
)) {

3916 
	`PRINT_CRIT_ERROR
("kthread_run() failed (%ld),„eleasing device "

3918 "™ mighˆd—dlock!", 
	`PTR_ERR
(
t
), 
dev
);

3919 
	`__dev_u£r_»Ëa£
(
dev
);

3922 
out
:

3923 
	`TRACE_EXIT
();

3925 
	}
}

3927 
	$dev_u£r_´oûss_þ—nup
(
sc¡_u£r_dev
 *
dev
)

3929 
sc¡_u£r_cmd
 *
ucmd
;

3930 
rc
 = 0, 
»s
 = 1;

3932 
	`TRACE_ENTRY
();

3934 
	`sBUG_ON
(
dev
->
blockšg
);

3935 
	`wake_up_®l
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_wa™Q
);

3938 
rc1
;

3940 
	`TRACE_DBG
("CËªupšg dev %p", 
dev
);

3942 
rc1
 = 
	`dev_u£r_unjam_dev
(
dev
);

3943 ià((
rc1
 =ð0è&& (
rc
 =ð-
EAGAIN
è&& 
dev
->
þ—nup_dÚe
)

3946 
	`¥š_lock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

3948 
rc
 = 
	`dev_u£r_g‘_Ãxt_cmd
(
dev
, &
ucmd
, 
çl£
);

3949 ià(
rc
 == 0)

3950 
	`dev_u£r_unjam_cmd
(
ucmd
, 1, 
NULL
);

3952 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

3954 ià(
rc
 =ð-
EAGAIN
) {

3955 ià(!
dev
->
þ—nup_dÚe
) {

3956 
	`TRACE_DBG
("NØmÜcommªd (dev %p)", 
dev
);

3957 
out
;

3962 #ifdeà
CONFIG_SCST_EXTRACHECKS


3964 
i
;

3966 
i
 = 0; i < ()
	`ARRAY_SIZE
(
dev
->
ucmd_hash
); i++) {

3967 
li¡_h—d
 *
h—d
 = &
dev
->
ucmd_hash
[
i
];

3968 
sc¡_u£r_cmd
 *
ucmd2
, *
tmp
;

3970 
	`li¡_fÜ_—ch_’Œy_§ã
(
ucmd2
, 
tmp
, 
h—d
, 
hash_li¡_’Œy
) {

3971 
	`PRINT_ERROR
("Lo¡ ucmd %°(¡©%x,„eà%d)", 
ucmd2
,

3972 
ucmd2
->
¡©e
, 
	`©omic_»ad
(&ucmd2->
ucmd_»f
));

3973 
	`ucmd_put
(
ucmd2
);

3979 
	`TRACE_DBG
("CËªupšg dÚ(dev %p)", 
dev
);

3980 
	`com¶‘e_®l
(&
dev
->
þ—nup_cm¶
);

3981 
»s
 = 0;

3983 
out
:

3984 
	`TRACE_EXIT_RES
(
»s
);

3985  
»s
;

3986 
	}
}

3988 #iâdeà
CONFIG_SCST_PROC


3990 
ssize_t
 
	$dev_u£r_sysfs_commªds_show
(
kobjeù
 *
kobj
,

3991 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

3993 
pos
 = 0, 
µos
, 
i
;

3994 
sc¡_deviû
 *
dev
;

3995 
sc¡_u£r_dev
 *
udev
;

3996 
æags
;

3998 
	`TRACE_ENTRY
();

4000 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

4001 
udev
 = 
dev
->
dh_´iv
;

4003 
	`¥š_lock_œq§ve
(&
udev
->
udev_cmd_th»ads
.
cmd_li¡_lock
, 
æags
);

4004 
i
 = 0; i < ()
	`ARRAY_SIZE
(
udev
->
ucmd_hash
); i++) {

4005 
li¡_h—d
 *
h—d
 = &
udev
->
ucmd_hash
[
i
];

4006 
sc¡_u£r_cmd
 *
ucmd
;

4008 
	`li¡_fÜ_—ch_’Œy
(
ucmd
, 
h—d
, 
hash_li¡_’Œy
) {

4009 
µos
 = 
pos
;

4010 
pos
 +ð
	`sú´štf
(&
buf
[pos],

4011 
SCST_SYSFS_BLOCK_SIZE
 - 
pos
,

4015 
ucmd
, ucmd->
¡©e
,

4016 
	`©omic_»ad
(&
ucmd
->
ucmd_»f
),

4017 
ucmd
->
£Á_to_u£r
, ucmd->
£’_by_u£r
,

4018 
ucmd
->
abÜ‹d
, ucmd->
jammed
, ucmd->
cmd
);

4019 ià(
pos
 >ð
SCST_SYSFS_BLOCK_SIZE
-1) {

4020 
µos
 +ð
	`sú´štf
(&
buf
[ppos],

4021 
SCST_SYSFS_BLOCK_SIZE
 - 
µos
, "...\n");

4022 
pos
 = 
µos
;

4027 
	`¥š_uÆock_œq»¡Üe
(&
udev
->
udev_cmd_th»ads
.
cmd_li¡_lock
, 
æags
);

4029 
	`TRACE_EXIT_RES
(
pos
);

4030  
pos
;

4031 
	}
}

4035 #ifdeà
CONFIG_SCST_DEBUG


4039 
	$dev_u£r_»ad_´oc
(
£q_fže
 *
£q
, 
sc¡_dev_ty³
 *
dev_ty³
)

4041 
»s
 = 0;

4042 
sc¡_u£r_dev
 *
dev
;

4043 
æags
;

4045 
	`TRACE_ENTRY
();

4047 
	`¥š_lock
(&
dev_li¡_lock
);

4049 
	`li¡_fÜ_—ch_’Œy
(
dev
, &
dev_li¡
, 
dev_li¡_’Œy
) {

4050 
i
;

4051 
	`£q_´štf
(
£q
, "Deviû % commªds:\n", 
dev
->
Çme
);

4052 
	`¥š_lock_œq§ve
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
, 
æags
);

4053 
i
 = 0; i < ()
	`ARRAY_SIZE
(
dev
->
ucmd_hash
); i++) {

4054 
li¡_h—d
 *
h—d
 = &
dev
->
ucmd_hash
[
i
];

4055 
sc¡_u£r_cmd
 *
ucmd
;

4056 
	`li¡_fÜ_—ch_’Œy
(
ucmd
, 
h—d
, 
hash_li¡_’Œy
) {

4057 
	`£q_´štf
(
£q
, "ucmd %p (state %x,„ef %d), "

4060 
ucmd
, ucmd->
¡©e
,

4061 
	`©omic_»ad
(&
ucmd
->
ucmd_»f
),

4062 
ucmd
->
£Á_to_u£r
, ucmd->
£’_by_u£r
,

4063 
ucmd
->
abÜ‹d
, ucmd->
jammed
, ucmd->
cmd
);

4066 
	`¥š_uÆock_œq»¡Üe
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
, 
æags
);

4068 
	`¥š_uÆock
(&
dev_li¡_lock
);

4070 
	`TRACE_EXIT_RES
(
»s
);

4071  
»s
;

4072 
	}
}

4076 
šlše
 
	$‹¡_þ—nup_li¡
()

4078 
»s
 = !
	`li¡_em±y
(&
þ—nup_li¡
) ||

4079 
	`uÆik–y
(
	`kth»ad_should_¡Ý
());

4080  
»s
;

4081 
	}
}

4083 
	$dev_u£r_þ—nup_th»ad
(*
¬g
)

4085 
	`TRACE_ENTRY
();

4087 
	`PRINT_INFO
("Cleanuphread started");

4089 
cu¼’t
->
æags
 |ð
PF_NOFREEZE
;

4091 
	`¥š_lock
(&
þ—nup_lock
);

4092 !
	`kth»ad_should_¡Ý
()) {

4093 
	`wa™_ev’t_locked
(
þ—nup_li¡_wa™Q
, 
	`‹¡_þ—nup_li¡
(),

4094 
lock
, 
þ—nup_lock
);

4103 
sc¡_u£r_dev
 *
dev
;

4104 
	`LIST_HEAD
(
þ_devs
);

4106 !
	`li¡_em±y
(&
þ—nup_li¡
)) {

4107 
rc
;

4109 
dev
 = 
	`li¡_fœ¡_’Œy
(&
þ—nup_li¡
,

4110 
	`ty³of
(*
dev
), 
þ—nup_li¡_’Œy
);

4111 
	`li¡_d–
(&
dev
->
þ—nup_li¡_’Œy
);

4113 
	`¥š_uÆock
(&
þ—nup_lock
);

4114 
rc
 = 
	`dev_u£r_´oûss_þ—nup
(
dev
);

4115 
	`¥š_lock
(&
þ—nup_lock
);

4117 ià(
rc
 != 0)

4118 
	`li¡_add_ž
(&
dev
->
þ—nup_li¡_’Œy
,

4119 &
þ_devs
);

4122 ià(
	`li¡_em±y
(&
þ_devs
))

4125 
	`¥š_uÆock
(&
þ—nup_lock
);

4126 
	`m¦“p
(100);

4127 
	`¥š_lock
(&
þ—nup_lock
);

4129 !
	`li¡_em±y
(&
þ_devs
)) {

4130 
dev
 = 
	`li¡_fœ¡_’Œy
(&
þ_devs
, 
	`ty³of
(*dev),

4131 
þ—nup_li¡_’Œy
);

4132 
	`li¡_move_ž
(&
dev
->
þ—nup_li¡_’Œy
,

4133 &
þ—nup_li¡
);

4137 
	`¥š_uÆock
(&
þ—nup_lock
);

4143 
	`sBUG_ON
(!
	`li¡_em±y
(&
þ—nup_li¡
));

4145 
	`PRINT_INFO
("Cleanuphread finished");

4147 
	`TRACE_EXIT
();

4149 
	}
}

4151 
__š™
 
	$š™_sc¡_u£r
()

4153 
»s
 = 0;

4154 
	smax_g‘_»¶y
 {

4156 
sc¡_u£r_g‘_cmd
 
g
;

4157 
sc¡_u£r_»¶y_cmd
 
r
;

4160 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 21)

4161 
þass_deviû
 *
þass_memb”
;

4163 
deviû
 *
dev
;

4166 
	`TRACE_ENTRY
();

4168 #iâdeà
INSIDE_KERNEL_TREE


4169 #ià
	`defšed
(
CONFIG_HIGHMEM4G
è|| defšed(
CONFIG_HIGHMEM64G
)

4170 
	`PRINT_ERROR
("%s", "HIGHMEM kernel configurations‡re‚ot supported. "

4173 
»s
 = -
EINVAL
;

4174 
out
;

4178 
u£r_dev_ÿch•
 = 
	`KMEM_CACHE
(
sc¡_u£r_dev
,

4179 
SCST_SLAB_FLAGS
|
SLAB_HWCACHE_ALIGN
);

4180 ià(
u£r_dev_ÿch•
 =ð
NULL
) {

4181 
»s
 = -
ENOMEM
;

4182 
out
;

4185 
u£r_cmd_ÿch•
 = 
	`KMEM_CACHE
(
sc¡_u£r_cmd
,

4186 
SCST_SLAB_FLAGS
|
SLAB_HWCACHE_ALIGN
);

4187 ià(
u£r_cmd_ÿch•
 =ð
NULL
) {

4188 
»s
 = -
ENOMEM
;

4189 
out_dev_ÿche
;

4192 
dev_u£r_devty³
.
moduË
 = 
THIS_MODULE
;

4194 
»s
 = 
	`sc¡_»gi¡”_vœtu®_dev_driv”
(&
dev_u£r_devty³
);

4195 ià(
»s
 < 0)

4196 
out_ÿche
;

4198 #ifdeà
CONFIG_SCST_PROC


4199 
»s
 = 
	`sc¡_dev_hªdËr_bužd_¡d_´oc
(&
dev_u£r_devty³
);

4200 ià(
»s
 != 0)

4201 
out_uÄeg
;

4204 
dev_u£r_sysfs_þass
 = 
	`þass_ü—‹
(
THIS_MODULE
, 
DEV_USER_NAME
);

4205 ià(
	`IS_ERR
(
dev_u£r_sysfs_þass
)) {

4206 
	`PRINT_ERROR
("%s", "Unable create sysfs class for SCST user "

4208 
»s
 = 
	`PTR_ERR
(
dev_u£r_sysfs_þass
);

4209 #ifdeà
CONFIG_SCST_PROC


4210 
out_´oc
;

4212 
out_uÄeg
;

4216 
dev_u£r_majÜ
 = 
	`»gi¡”_chrdev
(0, 
DEV_USER_NAME
, &
dev_u£r_fÝs
);

4217 ià(
dev_u£r_majÜ
 < 0) {

4218 
	`PRINT_ERROR
("»gi¡”_chrdev(èçžed: %d", 
»s
);

4219 
»s
 = 
dev_u£r_majÜ
;

4220 
out_þass
;

4223 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 21)

4224 
þass_memb”
 = 
	`þass_deviû_ü—‹
(
dev_u£r_sysfs_þass
, 
NULL
,

4225 
	`MKDEV
(
dev_u£r_majÜ
, 0), 
NULL
, 
DEV_USER_NAME
);

4226 ià(
	`IS_ERR
(
þass_memb”
)) {

4227 
»s
 = 
	`PTR_ERR
(
þass_memb”
);

4228 
out_chrdev
;

4231 
dev
 = 
	`deviû_ü—‹
(
dev_u£r_sysfs_þass
, 
NULL
,

4232 
	`MKDEV
(
dev_u£r_majÜ
, 0),

4233 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 27)

4234 
NULL
,

4236 
DEV_USER_NAME
);

4237 ià(
	`IS_ERR
(
dev
)) {

4238 
»s
 = 
	`PTR_ERR
(
dev
);

4239 
out_chrdev
;

4243 
þ—nup_th»ad
 = 
	`kth»ad_run
(
dev_u£r_þ—nup_th»ad
, 
NULL
,

4245 ià(
	`IS_ERR
(
þ—nup_th»ad
)) {

4246 
»s
 = 
	`PTR_ERR
(
þ—nup_th»ad
);

4247 
	`PRINT_ERROR
("kth»ad_ü—‹(èçžed: %d", 
»s
);

4248 
out_dev
;

4251 
out
:

4252 
	`TRACE_EXIT_RES
(
»s
);

4253  
»s
;

4255 
out_dev
:

4256 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 21)

4257 
	`þass_deviû_de¡roy
(
dev_u£r_sysfs_þass
, 
	`MKDEV
(
dev_u£r_majÜ
, 0));

4259 
	`deviû_de¡roy
(
dev_u£r_sysfs_þass
, 
	`MKDEV
(
dev_u£r_majÜ
, 0));

4262 
out_chrdev
:

4263 
	`uÄegi¡”_chrdev
(
dev_u£r_majÜ
, 
DEV_USER_NAME
);

4265 
out_þass
:

4266 
	`þass_de¡roy
(
dev_u£r_sysfs_þass
);

4268 #ifdeà
CONFIG_SCST_PROC


4269 
out_´oc
:

4270 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(&
dev_u£r_devty³
);

4273 
out_uÄeg
:

4274 
	`sc¡_uÄegi¡”_dev_driv”
(&
dev_u£r_devty³
);

4276 
out_ÿche
:

4277 
	`kmem_ÿche_de¡roy
(
u£r_cmd_ÿch•
);

4279 
out_dev_ÿche
:

4280 
	`kmem_ÿche_de¡roy
(
u£r_dev_ÿch•
);

4281 
out
;

4282 
	}
}

4284 
__ex™
 
	$ex™_sc¡_u£r
()

4286 
rc
;

4288 
	`TRACE_ENTRY
();

4290 
rc
 = 
	`kth»ad_¡Ý
(
þ—nup_th»ad
);

4291 ià(
rc
 < 0)

4292 
	`TRACE_MGMT_DBG
("kth»ad_¡Ý(èçžed: %d", 
rc
);

4294 
	`uÄegi¡”_chrdev
(
dev_u£r_majÜ
, 
DEV_USER_NAME
);

4295 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 21)

4296 
	`þass_deviû_de¡roy
(
dev_u£r_sysfs_þass
, 
	`MKDEV
(
dev_u£r_majÜ
, 0));

4298 
	`deviû_de¡roy
(
dev_u£r_sysfs_þass
, 
	`MKDEV
(
dev_u£r_majÜ
, 0));

4300 
	`þass_de¡roy
(
dev_u£r_sysfs_þass
);

4302 #ifdeà
CONFIG_SCST_PROC


4303 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(&
dev_u£r_devty³
);

4305 
	`sc¡_uÄegi¡”_vœtu®_dev_driv”
(&
dev_u£r_devty³
);

4307 
	`kmem_ÿche_de¡roy
(
u£r_cmd_ÿch•
);

4308 
	`kmem_ÿche_de¡roy
(
u£r_dev_ÿch•
);

4310 
	`TRACE_EXIT
();

4312 
	}
}

4314 
moduË_š™
(
š™_sc¡_u£r
);

4315 
moduË_ex™
(
ex™_sc¡_u£r
);

4317 
MODULE_AUTHOR
("Vladislav Bolkhovitin");

4318 
MODULE_LICENSE
("GPL");

4319 
MODULE_DESCRIPTION
("User space device handler for SCST");

4320 
MODULE_VERSION
(
SCST_VERSION_STRING
);

	@scst/src/dev_handlers/scst_vdisk.c

25 
	~<lšux/fže.h
>

26 
	~<lšux/fs.h
>

27 
	~<lšux/¡ršg.h
>

28 
	~<lšux/ty³s.h
>

29 
	~<lšux/uni¡d.h
>

30 
	~<lšux/¥šlock.h
>

31 
	~<lšux/š™.h
>

32 
	~<lšux/uio.h
>

33 
	~<lšux/li¡.h
>

34 
	~<lšux/ùy³.h
>

35 
	~<lšux/wr™eback.h
>

36 
	~<lšux/vm®loc.h
>

37 
	~<asm/©omic.h
>

38 
	~<lšux/kth»ad.h
>

39 
	~<lšux/sched.h
>

40 
	~<lšux/d–ay.h
>

41 
	~<lšux/Çmei.h
>

42 #iâdeà
INSIDE_KERNEL_TREE


43 
	~<lšux/v”siÚ.h
>

45 
	~<asm/div64.h
>

46 
	~<asm/uÇligÃd.h
>

47 
	~<lšux/¦ab.h
>

48 
	~<lšux/bio.h
>

49 
	~<lšux/üc32c.h
>

50 
	~<lšux/sw­.h
>

51 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 38)

52 
	~<lšux/çÎoc.h
>

55 
	#LOG_PREFIX
 "dev_vdisk"

	)

57 #ifdeà
INSIDE_KERNEL_TREE


58 
	~<sc¡/sc¡.h
>

60 
	~"sc¡.h
"

63 
	#TRACE_ORDER
 0x80000000

	)

65 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

66 
sc¡_Œaû_log
 
	gvdisk_loÿl_Œaû_tbl
[] = {

67 { 
TRACE_ORDER
, "order" },

68 { 0, 
NULL
 }

70 
	#Œaû_log_tbl
 
vdisk_loÿl_Œaû_tbl


	)

72 
	#VDISK_TRACE_TBL_HELP
 ", ord”"

	)

76 
	~"sc¡_dev_hªdËr.h
"

79 
	#SCST_FIO_VENDOR
 "SCST_FIO"

	)

80 
	#SCST_BIO_VENDOR
 "SCST_BIO"

	)

82 
	#SCST_FIO_REV
 " 310"

	)

84 
	#MAX_USN_LEN
 (20+1è

	)

85 
	#MAX_INQ_VEND_SPECIFIC_LEN
 (
INQ_BUF_SZ
 - 96)

	)

87 
	#INQ_BUF_SZ
 256

	)

88 
	#EVPD
 0x01

	)

89 
	#CMDDT
 0x02

	)

91 
	#MSENSE_BUF_SZ
 256

	)

92 
	#DBD
 0x08

	)

93 
	#WP
 0x80

	)

94 
	#DPOFUA
 0x10

	)

95 
	#WCE
 0x04

	)

97 
	#PF
 0x10

	)

98 
	#SP
 0x01

	)

99 
	#PS
 0x80

	)

101 
	#DEF_DISK_BLOCK_SHIFT
 9

	)

102 
	#DEF_CDROM_BLOCK_SHIFT
 11

	)

103 
	#DEF_SECTORS
 56

	)

104 
	#DEF_HEADS
 255

	)

105 
	#LEN_MEM
 (32 * 1024)

	)

106 
	#DEF_RD_ONLY
 0

	)

107 
	#DEF_WRITE_THROUGH
 0

	)

108 
	#DEF_NV_CACHE
 0

	)

109 
	#DEF_O_DIRECT
 0

	)

110 
	#DEF_DUMMY
 0

	)

111 
	#DEF_READ_ZERO
 0

	)

112 
	#DEF_REMOVABLE
 0

	)

113 
	#DEF_ROTATIONAL
 1

	)

114 
	#DEF_THIN_PROVISIONED
 0

	)

115 
	#DEF_EXPL_ALUA
 0

	)

117 
	#VDISK_NULLIO_SIZE
 (5LL*1024*1024*1024*1024/2)

	)

119 
	#DEF_TST
 
SCST_TST_1_SEP_TASK_SETS


	)

120 
	#DEF_TMF_ONLY
 0

	)

126 
	#DEF_QUEUE_ALG_WT
 
SCST_QUEUE_ALG_1_UNRESTRICTED_REORDER


	)

127 
	#DEF_QUEUE_ALG
 
SCST_QUEUE_ALG_1_UNRESTRICTED_REORDER


	)

129 
	#DEF_QERR
 
SCST_QERR_0_ALL_RESUME


	)

130 
	#DEF_SWP
 0

	)

131 
	#DEF_TAS
 0

	)

132 
	#DEF_DSENSE
 
SCST_D_SENSE_0_FIXED_SENSE


	)

134 
	#DEF_DPICZ
 
SCST_DPICZ_CHECK_ON_xPROT_0


	)

136 
	#DEF_DIF_FILENAME_TMPL
 (
SCST_VAR_DIR
 "/dif_gs/%s.dif")

	)

138 #ifdeà
CONFIG_SCST_PROC


139 
	#VDISK_PROC_HELP
 "h–p"

	)

142 
	ssc¡_vdisk_dev
 {

143 
ušt64_t
 
	mnblocks
;

144 
loff_t
 
	mfže_size
;

151 
¥šlock_t
 
	mæags_lock
;

157 
	mrd_Úly
:1;

158 
	mwt_æag
:1;

159 
	mnv_ÿche
:1;

160 
	mo_dœeù_æag
:1;

161 
	mz”o_cÝy
:1;

162 
	mmedŸ_chªged
:1;

163 
	m´ev’t_®low_medium_»mov®
:1;

164 
	mnuÎio
:1;

165 
	mblockio
:1;

166 
	mblk_š‹gr™y
:1;

167 
	mcdrom_em±y
:1;

168 
	mdummy
:1;

169 
	m»ad_z”o
:1;

170 
	m»movabË
:1;

171 
	mthš_´ovisiÚed
:1;

172 
	mthš_´ovisiÚed_mªu®ly_£t
:1;

173 
	mdev_thš_´ovisiÚed
:1;

174 
	mrÙ©iÚ®
:1;

175 
	mwt_æag_§ved
:1;

176 
	mt¡
:3;

177 
	mfÜm©_aùive
:1;

178 
	mdisÿrd_z”Ûs_d©a
:1;

179 
	mex¶_®ua
:1;

180 
	m»exam_³ndšg
:1;

181 
	msize_key
:1;

183 
fže
 *
	mfd
;

184 
fže
 *
	mdif_fd
;

185 
block_deviû
 *
	mbdev
;

186 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 30)

187 
bio_£t
 *
	mvdisk_bio£t
;

190 
ušt64_t
 
	mfÜm©_´og»ss_to_do
, 
	mfÜm©_´og»ss_dÚe
;

192 
	mvœt_id
;

194 
	mÇme
[64+1];

196 *
	mfž’ame
;

197 
ušt16_t
 
	mcommªd_£t_v”siÚ
;

199 
	mš™Ÿl_þu¡”_mode
:1;

202 
	mt10_v’d_id_£t
:1;

204 
	mv’d_¥ecific_id_£t
:1;

205 
	m´od_id_£t
:1;

206 
	m´od_»v_lvl_£t
:1;

207 
	mscsi_deviû_Çme_£t
:1;

208 
	mt10_dev_id_£t
:1;

209 
	mu¢_£t
:1;

210 
	mt10_v’d_id
[8 + 1];

211 
	mv’d_¥ecific_id
[32 + 1];

212 
	m´od_id
[16 + 1];

213 
	m´od_»v_lvl
[4 + 1];

214 
	mscsi_deviû_Çme
[256 + 1];

215 
	mt10_dev_id
[16+8+2];

216 
	meui64_id_Ën
;

217 
ušt8_t
 
	meui64_id
[16];

218 
	mÇa_id_Ën
;

219 
ušt8_t
 
	mÇa_id
[16];

220 
	mu¢
[
MAX_USN_LEN
];

221 
ušt8_t
 
	mšq_v’d_¥ecific
[
MAX_INQ_VEND_SPECIFIC_LEN
];

222 
	mšq_v’d_¥ecific_Ën
;

225 
ušt32_t
 
	munm­_Ýt_g¿n
, 
	munm­_®ign
, 
	munm­_max_lba_út
;

227 
sc¡_deviû
 *
	mdev
;

228 
li¡_h—d
 
	mvdev_li¡_’Œy
;

230 
sc¡_dev_ty³
 *
	mvdev_devt
;

232 
	mtgt_dev_út
;

234 *
	mdif_fž’ame
;

237 
	mblk_shiá
;

238 
sc¡_dif_mode
 
	mdif_mode
;

239 
	mdif_ty³
;

240 
__be64
 
	mdif_¡©ic_­p_g_combšed
;

243 
	svdisk_cmd_·¿ms
 {

244 
sÿ‰”li¡
 
	msm®l_sg
[4];

245 
iovec
 *
	miv
;

246 
	miv_couÁ
;

247 
iovec
 
	msm®l_iv
[4];

248 
sc¡_cmd
 *
	mcmd
;

249 
loff_t
 
	mloff
;

250 
	mfua
;

251 
boÞ
 
	mu£_z”o_cÝy
;

254 
boÞ
 
	gvdev_§ved_mode_·ges_’abËd
 = 
Œue
;

256 
	ecom¶_¡©us_e
 {

257 #ià
defšed
(
SCST_DEBUG
)

258 
	mCOMPL_STATUS_START_AT
 = 777,

260 
	mCMD_SUCCEEDED
,

261 
	mCMD_FAILED
,

262 
	mRUNNING_ASYNC
,

263 
	mINVALID_OPCODE
,

266 
	$com¶_¡©us_e
 (*
	tvdisk_Ý_â
)(
	tvdisk_cmd_·¿ms
 *
	tp
);

268 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 29)

269 
	#DEF_NUM_THREADS
 5

	)

272 
	#DEF_NUM_THREADS
 8

	)

274 
num_th»ads
 = 
DEF_NUM_THREADS
;

276 
	`moduË_·¿m_Çmed
(
num_th»ads
,‚um_th»ads, , 
S_IRUGO
);

277 
	`MODULE_PARM_DESC
(
num_th»ads
, "vdiskhreads count");

283 
¥šlock_t
 
vdev_”r_lock
;

285 
	`vdisk_©ch
(
sc¡_deviû
 *
dev
);

286 
	`vdisk_d‘ach
(
sc¡_deviû
 *
dev
);

287 
	`vdisk_©ch_tgt
(
sc¡_tgt_dev
 *
tgt_dev
);

288 
	`vdisk_d‘ach_tgt
(
sc¡_tgt_dev
 *
tgt_dev
);

289 
	`vdisk_g‘_suµÜ‹d_Ýcodes
(
sc¡_cmd
 *
cmd
,

290 cÚ¡ 
sc¡_Ýcode_desütÜ
 ***
out_suµ_Ýcodes
,

291 *
out_suµ_Ýcodes_út
);

292 
	`vcdrom_g‘_suµÜ‹d_Ýcodes
(
sc¡_cmd
 *
cmd
,

293 cÚ¡ 
sc¡_Ýcode_desütÜ
 ***
out_suµ_Ýcodes
,

294 *
out_suµ_Ýcodes_út
);

295 
	`fžeio_®loc_d©a_buf
(
sc¡_cmd
 *
cmd
);

296 
	`vdisk_·r£
(
sc¡_cmd
 *);

297 
	`vcdrom_·r£
(
sc¡_cmd
 *);

298 
	`nÚ_fžeio_·r£
(
sc¡_cmd
 *);

299 
	`fžeio_exec
(
sc¡_cmd
 *
cmd
);

300 
	`vcdrom_exec
(
sc¡_cmd
 *
cmd
);

301 
	`blockio_exec
(
sc¡_cmd
 *
cmd
);

302 
	`nuÎio_exec
(
sc¡_cmd
 *
cmd
);

303 
	`blockio_Ú_®ua_¡©e_chªge_¡¬t
(
sc¡_deviû
 *
dev
,

304 
sc¡_tg_¡©e
 
Þd_¡©e
, sc¡_tg_¡©
Ãw_¡©e
);

305 
	`blockio_Ú_®ua_¡©e_chªge_fšish
(
sc¡_deviû
 *
dev
,

306 
sc¡_tg_¡©e
 
Þd_¡©e
, sc¡_tg_¡©
Ãw_¡©e
);

307 
	`fžeio_Ú_ä“_cmd
(
sc¡_cmd
 *
cmd
);

308 
com¶_¡©us_e
 
	`nuÎio_exec_»ad
(
vdisk_cmd_·¿ms
 *
p
);

309 
com¶_¡©us_e
 
	`blockio_exec_»ad
(
vdisk_cmd_·¿ms
 *
p
);

310 
com¶_¡©us_e
 
	`fžeio_exec_»ad
(
vdisk_cmd_·¿ms
 *
p
);

311 
com¶_¡©us_e
 
	`nuÎio_exec_wr™e
(
vdisk_cmd_·¿ms
 *
p
);

312 
com¶_¡©us_e
 
	`blockio_exec_wr™e
(
vdisk_cmd_·¿ms
 *
p
);

313 
com¶_¡©us_e
 
	`fžeio_exec_wr™e
(
vdisk_cmd_·¿ms
 *
p
);

314 
com¶_¡©us_e
 
	`nuÎio_exec_v¬_Ën_cmd
(
vdisk_cmd_·¿ms
 *
p
);

315 
com¶_¡©us_e
 
	`blockio_exec_v¬_Ën_cmd
(
vdisk_cmd_·¿ms
 *
p
);

316 
com¶_¡©us_e
 
	`fžeio_exec_v¬_Ën_cmd
(
vdisk_cmd_·¿ms
 *
p
);

317 
	`blockio_exec_rw
(
vdisk_cmd_·¿ms
 *
p
, 
boÞ
 
wr™e
, boÞ 
fua
);

318 
	`vdisk_blockio_æush
(
block_deviû
 *
bdev
, 
gå_t
 
gå_mask
,

319 
boÞ
 
»pÜt_”rÜ
, 
sc¡_cmd
 *
cmd
, boÞ 
async
);

320 
com¶_¡©us_e
 
	`vdev_exec_v”ify
(
vdisk_cmd_·¿ms
 *
p
);

321 
com¶_¡©us_e
 
	`blockio_exec_wr™e_v”ify
(
vdisk_cmd_·¿ms
 *
p
);

322 
com¶_¡©us_e
 
	`fžeio_exec_wr™e_v”ify
(
vdisk_cmd_·¿ms
 *
p
);

323 
com¶_¡©us_e
 
	`nuÎio_exec_wr™e_v”ify
(
vdisk_cmd_·¿ms
 *
p
);

324 
com¶_¡©us_e
 
	`nuÎio_exec_v”ify
(
vdisk_cmd_·¿ms
 *
p
);

325 
com¶_¡©us_e
 
	`vdisk_exec_»ad_ÿ·c™y
(
vdisk_cmd_·¿ms
 *
p
);

326 
com¶_¡©us_e
 
	`vdisk_exec_»ad_ÿ·c™y16
(
vdisk_cmd_·¿ms
 *
p
);

327 
com¶_¡©us_e
 
	`vdisk_exec_g‘_lba_¡©us
(
vdisk_cmd_·¿ms
 *
p
);

328 
com¶_¡©us_e
 
	`vdisk_exec_»pÜt_gs
(
vdisk_cmd_·¿ms
 *
p
);

329 
com¶_¡©us_e
 
	`vdisk_exec_£t_gs
(
vdisk_cmd_·¿ms
 *
p
);

330 
com¶_¡©us_e
 
	`vdisk_exec_šquœy
(
vdisk_cmd_·¿ms
 *
p
);

331 
com¶_¡©us_e
 
	`vdisk_exec_»que¡_£n£
(
vdisk_cmd_·¿ms
 *
p
);

332 
com¶_¡©us_e
 
	`vdisk_exec_mode_£n£
(
vdisk_cmd_·¿ms
 *
p
);

333 
com¶_¡©us_e
 
	`vdisk_exec_mode_£Ëù
(
vdisk_cmd_·¿ms
 *
p
);

334 
com¶_¡©us_e
 
	`vdisk_exec_log
(
vdisk_cmd_·¿ms
 *
p
);

335 
com¶_¡©us_e
 
	`vdisk_exec_»ad_toc
(
vdisk_cmd_·¿ms
 *
p
);

336 
com¶_¡©us_e
 
	`vdisk_exec_´ev’t_®low_medium_»mov®
(
vdisk_cmd_·¿ms
 *
p
);

337 
com¶_¡©us_e
 
	`vdisk_exec_unm­
(
vdisk_cmd_·¿ms
 *
p
);

338 
com¶_¡©us_e
 
	`vdisk_exec_wr™e_§me
(
vdisk_cmd_·¿ms
 *
p
);

339 
	`vdisk_fsync
(
loff_t
 
loff
,

340 
loff_t
 
Ën
, 
sc¡_deviû
 *
dev
, 
gå_t
 
gå_æags
,

341 
sc¡_cmd
 *
cmd
, 
boÞ
 
async
);

342 #ifdeà
CONFIG_SCST_PROC


343 
	`vdisk_»ad_´oc
(
£q_fže
 *
£q
,

344 
sc¡_dev_ty³
 *
dev_ty³
);

345 
	`vdisk_wr™e_´oc
(*
bufãr
, **
¡¬t
, 
off_t
 
off£t
,

346 
Ëngth
, *
eof
, 
sc¡_dev_ty³
 *
dev_ty³
);

347 
	`vcdrom_»ad_´oc
(
£q_fže
 *
£q
,

348 
sc¡_dev_ty³
 *
dev_ty³
);

349 
	`vcdrom_wr™e_´oc
(*
bufãr
, **
¡¬t
, 
off_t
 
off£t
,

350 
Ëngth
, *
eof
, 
sc¡_dev_ty³
 *
dev_ty³
);

352 
ssize_t
 
	`vdisk_add_fžeio_deviû
(cÚ¡ *
deviû_Çme
, *
·¿ms
);

353 
ssize_t
 
	`vdisk_add_blockio_deviû
(cÚ¡ *
deviû_Çme
, *
·¿ms
);

354 
ssize_t
 
	`vdisk_add_nuÎio_deviû
(cÚ¡ *
deviû_Çme
, *
·¿ms
);

355 
ssize_t
 
	`vdisk_d–_deviû
(cÚ¡ *
deviû_Çme
);

356 
ssize_t
 
	`vcdrom_add_deviû
(cÚ¡ *
deviû_Çme
, *
·¿ms
);

357 
ssize_t
 
	`vcdrom_d–_deviû
(cÚ¡ *
deviû_Çme
);

359 
	`vdisk_sk_mgmt_â_dÚe
(
sc¡_mgmt_cmd
 *
mcmd
,

360 
sc¡_tgt_dev
 *
tgt_dev
);

361 
ušt64_t
 
	`vdisk_g’_dev_id_num
(cÚ¡ *
vœt_dev_Çme
);

362 #ifdeà
CONFIG_DEBUG_EXT_COPY_REMAP


363 
	`vdev_ext_cÝy_»m­
(
sc¡_cmd
 *
cmd
,

364 
sc¡_ext_cÝy_£g_desü
 *
desü
);

366 
	`vdisk_unm­_¿nge
(
sc¡_cmd
 *
cmd
,

367 
sc¡_vdisk_dev
 *
vœt_dev
, 
ušt64_t
 
¡¬t_lba
, 
ušt32_t
 
blocks
);

371 #iâdeà
CONFIG_SCST_PROC


373 
ssize_t
 
	`vdev_sysfs_size_¡Üe
(
kobjeù
 *
kobj
,

374 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

375 
ssize_t
 
	`vdev_sysfs_size_show
(
kobjeù
 *
kobj
,

376 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

377 
ssize_t
 
	`vdev_sysfs_size_mb_¡Üe
(
kobjeù
 *
kobj
,

378 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

379 
ssize_t
 
	`vdev_sysfs_size_mb_show
(
kobjeù
 *
kobj
,

380 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

381 
ssize_t
 
	`vdisk_sysfs_blocksize_show
(
kobjeù
 *
kobj
,

382 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

383 
ssize_t
 
	`vdisk_sysfs_rd_Úly_show
(
kobjeù
 *
kobj
,

384 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

385 
ssize_t
 
	`vdisk_sysfs_wt_show
(
kobjeù
 *
kobj
,

386 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

387 
ssize_t
 
	`vdisk_sysfs__show
(
kobjeù
 *
kobj
,

388 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

389 
ssize_t
 
	`vdisk_sysfs_t¡_show
(
kobjeù
 *
kobj
,

390 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

391 
ssize_t
 
	`vdisk_sysfs_rÙ©iÚ®_show
(
kobjeù
 *
kobj
,

392 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

393 
ssize_t
 
	`vdisk_sysfs_ex¶_®ua_show
(
kobjeù
 *
kobj
,

394 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

395 
ssize_t
 
	`vdisk_sysfs_ex¶_®ua_¡Üe
(
kobjeù
 *
kobj
,

396 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

397 
ssize_t
 
	`vdisk_sysfs_nv_ÿche_show
(
kobjeù
 *
kobj
,

398 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

399 
ssize_t
 
	`vdisk_sysfs_o_dœeù_show
(
kobjeù
 *
kobj
,

400 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

401 
ssize_t
 
	`vdev_sysfs_dummy_show
(
kobjeù
 *
kobj
,

402 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

403 
ssize_t
 
	`vdev_sysfs_rz_show
(
kobjeù
 *
kobj
,

404 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

405 
ssize_t
 
	`vdev_sysfs_rz_¡Üe
(
kobjeù
 *
kobj
,

406 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

407 
ssize_t
 
	`vdisk_sysfs_»movabË_show
(
kobjeù
 *
kobj
,

408 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

409 
ssize_t
 
	`vdev_sysfs_fž’ame_show
(
kobjeù
 *
kobj
,

410 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

411 
ssize_t
 
	`vdev_sysfs_þu¡”_mode_show
(
kobjeù
 *
kobj
,

412 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

413 
ssize_t
 
	`vdev_sysfs_þu¡”_mode_¡Üe
(
kobjeù
 *
kobj
,

414 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

415 
ssize_t
 
	`vdisk_sysfs_»sync_size_¡Üe
(
kobjeù
 *
kobj
,

416 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

417 
ssize_t
 
	`vdisk_sysfs_sync_¡Üe
(
kobjeù
 *
kobj
,

418 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

419 
ssize_t
 
	`vdev_sysfs_t10_v’d_id_¡Üe
(
kobjeù
 *
kobj
,

420 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

421 
ssize_t
 
	`vdev_sysfs_t10_v’d_id_show
(
kobjeù
 *
kobj
,

422 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

423 
ssize_t
 
	`vdev_sysfs_v’d_¥ecific_id_¡Üe
(
kobjeù
 *
kobj
,

424 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

425 
ssize_t
 
	`vdev_sysfs_v’d_¥ecific_id_show
(
kobjeù
 *
kobj
,

426 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

427 
ssize_t
 
	`vdev_sysfs_´od_id_¡Üe
(
kobjeù
 *
kobj
,

428 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

429 
ssize_t
 
	`vdev_sysfs_´od_id_show
(
kobjeù
 *
kobj
,

430 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

431 
ssize_t
 
	`vdev_sysfs_´od_»v_lvl_¡Üe
(
kobjeù
 *
kobj
,

432 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

433 
ssize_t
 
	`vdev_sysfs_´od_»v_lvl_show
(
kobjeù
 *
kobj
,

434 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

435 
ssize_t
 
	`vdev_sysfs_scsi_deviû_Çme_¡Üe
(
kobjeù
 *
kobj
,

436 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

437 
ssize_t
 
	`vdev_sysfs_scsi_deviû_Çme_show
(
kobjeù
 *
kobj
,

438 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

439 
ssize_t
 
	`vdev_sysfs_t10_dev_id_¡Üe
(
kobjeù
 *
kobj
,

440 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

441 
ssize_t
 
	`vdev_sysfs_t10_dev_id_show
(
kobjeù
 *
kobj
,

442 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

443 
ssize_t
 
	`vdev_sysfs_eui64_id_¡Üe
(
kobjeù
 *
kobj
,

444 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

445 
ssize_t
 
	`vdev_sysfs_eui64_id_show
(
kobjeù
 *
kobj
,

446 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

447 
ssize_t
 
	`vdev_sysfs_Ça_id_¡Üe
(
kobjeù
 *
kobj
,

448 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

449 
ssize_t
 
	`vdev_sysfs_Ça_id_show
(
kobjeù
 *
kobj
,

450 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

451 
ssize_t
 
	`vdev_sysfs_u¢_¡Üe
(
kobjeù
 *
kobj
,

452 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

453 
ssize_t
 
	`vdev_sysfs_u¢_show
(
kobjeù
 *
kobj
,

454 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

455 
ssize_t
 
	`vdev_sysfs_šq_v’d_¥ecific_¡Üe
(
kobjeù
 *
kobj
,

456 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

457 
ssize_t
 
	`vdev_sysfs_šq_v’d_¥ecific_show
(
kobjeù
 *
kobj
,

458 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

459 
ssize_t
 
	`vdev_z”o_cÝy_show
(
kobjeù
 *
kobj
,

460 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

461 
ssize_t
 
	`vdev_dif_fž’ame_show
(
kobjeù
 *
kobj
,

462 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

464 
ssize_t
 
	`vcdrom_sysfs_fž’ame_¡Üe
(
kobjeù
 *
kobj
,

465 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

467 
kobj_©Œibu‹
 
vdev_size_ro_©Œ
 =

468 
	`__ATTR
(
size
, 
S_IRUGO
, 
vdev_sysfs_size_show
, 
NULL
);

469 
kobj_©Œibu‹
 
vdev_size_rw_©Œ
 =

470 
	`__ATTR
(
size
, 
S_IWUSR
|
S_IRUGO
, 
vdev_sysfs_size_show
,

471 
vdev_sysfs_size_¡Üe
);

472 
kobj_©Œibu‹
 
vdev_size_mb_ro_©Œ
 =

473 
	`__ATTR
(
size_mb
, 
S_IRUGO
, 
vdev_sysfs_size_mb_show
, 
NULL
);

474 
kobj_©Œibu‹
 
vdev_size_mb_rw_©Œ
 =

475 
	`__ATTR
(
size_mb
, 
S_IWUSR
|
S_IRUGO
, 
vdev_sysfs_size_mb_show
,

476 
vdev_sysfs_size_mb_¡Üe
);

477 
kobj_©Œibu‹
 
vdisk_blocksize_©Œ
 =

478 
	`__ATTR
(
blocksize
, 
S_IRUGO
, 
vdisk_sysfs_blocksize_show
, 
NULL
);

479 
kobj_©Œibu‹
 
vdisk_rd_Úly_©Œ
 =

480 
	`__ATTR
(
»ad_Úly
, 
S_IRUGO
, 
vdisk_sysfs_rd_Úly_show
, 
NULL
);

481 
kobj_©Œibu‹
 
vdisk_wt_©Œ
 =

482 
	`__ATTR
(
wr™e_through
, 
S_IRUGO
, 
vdisk_sysfs_wt_show
, 
NULL
);

483 
kobj_©Œibu‹
 
vdisk__©Œ
 =

484 
	`__ATTR
(
thš_´ovisiÚed
, 
S_IRUGO
, 
vdisk_sysfs__show
, 
NULL
);

485 
kobj_©Œibu‹
 
vdisk_t¡_©Œ
 =

486 
	`__ATTR
(
t¡
, 
S_IRUGO
, 
vdisk_sysfs_t¡_show
, 
NULL
);

487 
kobj_©Œibu‹
 
vdisk_rÙ©iÚ®_©Œ
 =

488 
	`__ATTR
(
rÙ©iÚ®
, 
S_IRUGO
, 
vdisk_sysfs_rÙ©iÚ®_show
, 
NULL
);

489 
kobj_©Œibu‹
 
vdisk_ex¶_®ua_©Œ
 =

490 
	`__ATTR
(
ex¶_®ua
, 
S_IWUSR
|
S_IRUGO
, 
vdisk_sysfs_ex¶_®ua_show
,

491 
vdisk_sysfs_ex¶_®ua_¡Üe
);

492 
kobj_©Œibu‹
 
vdisk_nv_ÿche_©Œ
 =

493 
	`__ATTR
(
nv_ÿche
, 
S_IRUGO
, 
vdisk_sysfs_nv_ÿche_show
, 
NULL
);

494 
kobj_©Œibu‹
 
vdisk_o_dœeù_©Œ
 =

495 
	`__ATTR
(
o_dœeù
, 
S_IRUGO
, 
vdisk_sysfs_o_dœeù_show
, 
NULL
);

496 
kobj_©Œibu‹
 
vdev_dummy_©Œ
 =

497 
	`__ATTR
(
dummy
, 
S_IRUGO
, 
vdev_sysfs_dummy_show
, 
NULL
);

498 
kobj_©Œibu‹
 
vdev_»ad_z”o_©Œ
 =

499 
	`__ATTR
(
»ad_z”o
, 
S_IWUSR
|
S_IRUGO
, 
vdev_sysfs_rz_show
,

500 
vdev_sysfs_rz_¡Üe
);

501 
kobj_©Œibu‹
 
vdisk_»movabË_©Œ
 =

502 
	`__ATTR
(
»movabË
, 
S_IRUGO
, 
vdisk_sysfs_»movabË_show
, 
NULL
);

503 
kobj_©Œibu‹
 
vdisk_fž’ame_©Œ
 =

504 
	`__ATTR
(
fž’ame
, 
S_IRUGO
, 
vdev_sysfs_fž’ame_show
, 
NULL
);

505 
kobj_©Œibu‹
 
vdisk_þu¡”_mode_©Œ
 =

506 
	`__ATTR
(
þu¡”_mode
, 
S_IWUSR
|
S_IRUGO
, 
vdev_sysfs_þu¡”_mode_show
,

507 
vdev_sysfs_þu¡”_mode_¡Üe
);

508 
kobj_©Œibu‹
 
vdisk_»sync_size_©Œ
 =

509 
	`__ATTR
(
»sync_size
, 
S_IWUSR
, 
NULL
, 
vdisk_sysfs_»sync_size_¡Üe
);

510 
kobj_©Œibu‹
 
vdisk_sync_©Œ
 =

511 
	`__ATTR
(
sync
, 
S_IWUSR
, 
NULL
, 
vdisk_sysfs_sync_¡Üe
);

512 
kobj_©Œibu‹
 
vdev_t10_v’d_id_©Œ
 =

513 
	`__ATTR
(
t10_v’d_id
, 
S_IWUSR
|
S_IRUGO
, 
vdev_sysfs_t10_v’d_id_show
,

514 
vdev_sysfs_t10_v’d_id_¡Üe
);

515 
kobj_©Œibu‹
 
vdev_v’d_¥ecific_id_©Œ
 =

516 
	`__ATTR
(
v’d_¥ecific_id
, 
S_IWUSR
|
S_IRUGO
,

517 
vdev_sysfs_v’d_¥ecific_id_show
,

518 
vdev_sysfs_v’d_¥ecific_id_¡Üe
);

519 
kobj_©Œibu‹
 
vdev_´od_id_©Œ
 =

520 
	`__ATTR
(
´od_id
, 
S_IWUSR
|
S_IRUGO
, 
vdev_sysfs_´od_id_show
,

521 
vdev_sysfs_´od_id_¡Üe
);

522 
kobj_©Œibu‹
 
vdev_´od_»v_lvl_©Œ
 =

523 
	`__ATTR
(
´od_»v_lvl
, 
S_IWUSR
|
S_IRUGO
, 
vdev_sysfs_´od_»v_lvl_show
,

524 
vdev_sysfs_´od_»v_lvl_¡Üe
);

525 
kobj_©Œibu‹
 
vdev_scsi_deviû_Çme_©Œ
 =

526 
	`__ATTR
(
scsi_deviû_Çme
, 
S_IWUSR
|
S_IRUGO
, 
vdev_sysfs_scsi_deviû_Çme_show
,

527 
vdev_sysfs_scsi_deviû_Çme_¡Üe
);

528 
kobj_©Œibu‹
 
vdev_t10_dev_id_©Œ
 =

529 
	`__ATTR
(
t10_dev_id
, 
S_IWUSR
|
S_IRUGO
, 
vdev_sysfs_t10_dev_id_show
,

530 
vdev_sysfs_t10_dev_id_¡Üe
);

531 
kobj_©Œibu‹
 
vdev_eui64_id_©Œ
 =

532 
	`__ATTR
(
eui64_id
, 
S_IWUSR
|
S_IRUGO
, 
vdev_sysfs_eui64_id_show
,

533 
vdev_sysfs_eui64_id_¡Üe
);

534 
kobj_©Œibu‹
 
vdev_Ça_id_©Œ
 =

535 
	`__ATTR
(
Ça_id
, 
S_IWUSR
|
S_IRUGO
, 
vdev_sysfs_Ça_id_show
,

536 
vdev_sysfs_Ça_id_¡Üe
);

537 
kobj_©Œibu‹
 
vdev_u¢_©Œ
 =

538 
	`__ATTR
(
u¢
, 
S_IWUSR
|
S_IRUGO
, 
vdev_sysfs_u¢_show
, 
vdev_sysfs_u¢_¡Üe
);

539 
kobj_©Œibu‹
 
vdev_šq_v’d_¥ecific_©Œ
 =

540 
	`__ATTR
(
šq_v’d_¥ecific
, 
S_IWUSR
|
S_IRUGO
,

541 
vdev_sysfs_šq_v’d_¥ecific_show
,

542 
vdev_sysfs_šq_v’d_¥ecific_¡Üe
);

543 
kobj_©Œibu‹
 
vdev_z”o_cÝy_©Œ
 =

544 
	`__ATTR
(
z”o_cÝy
, 
S_IRUGO
, 
vdev_z”o_cÝy_show
, 
NULL
);

545 
kobj_©Œibu‹
 
vdev_dif_fž’ame_©Œ
 =

546 
	`__ATTR
(
dif_fž’ame
, 
S_IRUGO
, 
vdev_dif_fž’ame_show
, 
NULL
);

548 
kobj_©Œibu‹
 
vcdrom_fž’ame_©Œ
 =

549 
	`__ATTR
(
fž’ame
, 
S_IRUGO
|
S_IWUSR
, 
vdev_sysfs_fž’ame_show
,

550 
vcdrom_sysfs_fž’ame_¡Üe
);

552 cÚ¡ 
©Œibu‹
 *
vdisk_fžeio_©Œs
[] = {

553 &
vdev_size_ro_©Œ
.
©Œ
,

554 &
vdev_size_mb_ro_©Œ
.
©Œ
,

555 &
vdisk_blocksize_©Œ
.
©Œ
,

556 &
vdisk_rd_Úly_©Œ
.
©Œ
,

557 &
vdisk_wt_©Œ
.
©Œ
,

558 &
vdisk__©Œ
.
©Œ
,

559 &
vdisk_t¡_©Œ
.
©Œ
,

560 &
vdisk_rÙ©iÚ®_©Œ
.
©Œ
,

561 &
vdisk_ex¶_®ua_©Œ
.
©Œ
,

562 &
vdisk_nv_ÿche_©Œ
.
©Œ
,

563 &
vdisk_o_dœeù_©Œ
.
©Œ
,

564 &
vdisk_»movabË_©Œ
.
©Œ
,

565 &
vdisk_fž’ame_©Œ
.
©Œ
,

566 &
vdisk_þu¡”_mode_©Œ
.
©Œ
,

567 &
vdisk_»sync_size_©Œ
.
©Œ
,

568 &
vdisk_sync_©Œ
.
©Œ
,

569 &
vdev_t10_v’d_id_©Œ
.
©Œ
,

570 &
vdev_v’d_¥ecific_id_©Œ
.
©Œ
,

571 &
vdev_´od_id_©Œ
.
©Œ
,

572 &
vdev_´od_»v_lvl_©Œ
.
©Œ
,

573 &
vdev_scsi_deviû_Çme_©Œ
.
©Œ
,

574 &
vdev_t10_dev_id_©Œ
.
©Œ
,

575 &
vdev_Ça_id_©Œ
.
©Œ
,

576 &
vdev_eui64_id_©Œ
.
©Œ
,

577 &
vdev_u¢_©Œ
.
©Œ
,

578 &
vdev_šq_v’d_¥ecific_©Œ
.
©Œ
,

579 &
vdev_z”o_cÝy_©Œ
.
©Œ
,

580 
NULL
,

581 
	}
};

583 cÚ¡ 
©Œibu‹
 *
	gvdisk_blockio_©Œs
[] = {

584 &
vdev_size_rw_©Œ
.
©Œ
,

585 &
vdev_size_mb_rw_©Œ
.
©Œ
,

586 &
vdisk_blocksize_©Œ
.
©Œ
,

587 &
vdisk_rd_Úly_©Œ
.
©Œ
,

588 &
vdisk_wt_©Œ
.
©Œ
,

589 &
vdisk_ex¶_®ua_©Œ
.
©Œ
,

590 &
vdisk_nv_ÿche_©Œ
.
©Œ
,

591 &
vdisk_t¡_©Œ
.
©Œ
,

592 &
vdisk_»movabË_©Œ
.
©Œ
,

593 &
vdisk_rÙ©iÚ®_©Œ
.
©Œ
,

594 &
vdisk_fž’ame_©Œ
.
©Œ
,

595 &
vdisk_þu¡”_mode_©Œ
.
©Œ
,

596 &
vdisk_»sync_size_©Œ
.
©Œ
,

597 &
vdisk_sync_©Œ
.
©Œ
,

598 &
vdev_t10_v’d_id_©Œ
.
©Œ
,

599 &
vdev_v’d_¥ecific_id_©Œ
.
©Œ
,

600 &
vdev_´od_id_©Œ
.
©Œ
,

601 &
vdev_´od_»v_lvl_©Œ
.
©Œ
,

602 &
vdev_scsi_deviû_Çme_©Œ
.
©Œ
,

603 &
vdev_t10_dev_id_©Œ
.
©Œ
,

604 &
vdev_Ça_id_©Œ
.
©Œ
,

605 &
vdev_eui64_id_©Œ
.
©Œ
,

606 &
vdev_u¢_©Œ
.
©Œ
,

607 &
vdev_šq_v’d_¥ecific_©Œ
.
©Œ
,

608 &
vdisk__©Œ
.
©Œ
,

609 
NULL
,

612 cÚ¡ 
©Œibu‹
 *
	gvdisk_nuÎio_©Œs
[] = {

613 &
vdev_size_rw_©Œ
.
©Œ
,

614 &
vdev_size_mb_rw_©Œ
.
©Œ
,

615 &
vdisk_blocksize_©Œ
.
©Œ
,

616 &
vdisk_rd_Úly_©Œ
.
©Œ
,

617 &
vdisk_t¡_©Œ
.
©Œ
,

618 &
vdev_dummy_©Œ
.
©Œ
,

619 &
vdev_»ad_z”o_©Œ
.
©Œ
,

620 &
vdisk_»movabË_©Œ
.
©Œ
,

621 &
vdev_t10_v’d_id_©Œ
.
©Œ
,

622 &
vdev_v’d_¥ecific_id_©Œ
.
©Œ
,

623 &
vdev_´od_id_©Œ
.
©Œ
,

624 &
vdev_´od_»v_lvl_©Œ
.
©Œ
,

625 &
vdev_scsi_deviû_Çme_©Œ
.
©Œ
,

626 &
vdev_t10_dev_id_©Œ
.
©Œ
,

627 &
vdev_Ça_id_©Œ
.
©Œ
,

628 &
vdev_eui64_id_©Œ
.
©Œ
,

629 &
vdev_u¢_©Œ
.
©Œ
,

630 &
vdev_šq_v’d_¥ecific_©Œ
.
©Œ
,

631 &
vdisk_rÙ©iÚ®_©Œ
.
©Œ
,

632 
NULL
,

635 cÚ¡ 
©Œibu‹
 *
	gvcdrom_©Œs
[] = {

636 &
vdev_size_ro_©Œ
.
©Œ
,

637 &
vdev_size_mb_ro_©Œ
.
©Œ
,

638 &
vcdrom_fž’ame_©Œ
.
©Œ
,

639 &
vdisk_t¡_©Œ
.
©Œ
,

640 &
vdev_t10_v’d_id_©Œ
.
©Œ
,

641 &
vdev_v’d_¥ecific_id_©Œ
.
©Œ
,

642 &
vdev_´od_id_©Œ
.
©Œ
,

643 &
vdev_´od_»v_lvl_©Œ
.
©Œ
,

644 &
vdev_scsi_deviû_Çme_©Œ
.
©Œ
,

645 &
vdev_t10_dev_id_©Œ
.
©Œ
,

646 &
vdev_Ça_id_©Œ
.
©Œ
,

647 &
vdev_eui64_id_©Œ
.
©Œ
,

648 &
vdev_u¢_©Œ
.
©Œ
,

649 &
vdev_šq_v’d_¥ecific_©Œ
.
©Œ
,

650 
NULL
,

656 
DEFINE_MUTEX
(
sc¡_vdisk_mu‹x
);

663 
DEFINE_RWLOCK
(
vdisk_£rŸl_rwlock
);

666 
LIST_HEAD
(
vdev_li¡
);

668 
kmem_ÿche
 *
	gvdisk_cmd_·¿m_ÿch•
;

670 
vdisk_Ý_â
 
	gfžeio_Ýs
[256];

671 
vdisk_Ý_â
 
	gblockio_Ýs
[256];

672 
vdisk_Ý_â
 
	gnuÎio_Ýs
[256];

679 
sc¡_dev_ty³
 
	gvdisk_fže_devty³
 = {

680 .
Çme
 = "vdisk_fileio",

681 .
	gty³
 = 
TYPE_DISK
,

682 .
	gexec_sync
 = 1,

683 .
	gth»ads_num
 = -1,

684 .
	g·r£_©omic
 = 1,

685 .
	gdev_dÚe_©omic
 = 1,

686 .
	gauto_cm_assignm’t_possibË
 = 1,

687 .
	g©ch
 = 
vdisk_©ch
,

688 .
	gd‘ach
 = 
vdisk_d‘ach
,

689 .
	g©ch_tgt
 = 
vdisk_©ch_tgt
,

690 .
	gd‘ach_tgt
 = 
vdisk_d‘ach_tgt
,

691 .
	g·r£
 = 
vdisk_·r£
,

692 .
	gdev_®loc_d©a_buf
 = 
fžeio_®loc_d©a_buf
,

693 .
	gexec
 = 
fžeio_exec
,

694 .
	gÚ_ä“_cmd
 = 
fžeio_Ú_ä“_cmd
,

695 .
	gsk_mgmt_â_dÚe
 = 
vdisk_sk_mgmt_â_dÚe
,

696 #ifdeà
CONFIG_DEBUG_EXT_COPY_REMAP


697 .
	gext_cÝy_»m­
 = 
vdev_ext_cÝy_»m­
,

699 .
	gg‘_suµÜ‹d_Ýcodes
 = 
vdisk_g‘_suµÜ‹d_Ýcodes
,

700 .
	gdevt_´iv
 = (*)
fžeio_Ýs
,

701 #ifdeà
CONFIG_SCST_PROC


702 .
	g»ad_´oc
 = 
vdisk_»ad_´oc
,

703 .
	gwr™e_´oc
 = 
vdisk_wr™e_´oc
,

705 .
	gadd_deviû
 = 
vdisk_add_fžeio_deviû
,

706 .
	gd–_deviû
 = 
vdisk_d–_deviû
,

707 .
	gdev_©Œs
 = 
vdisk_fžeio_©Œs
,

708 .
	gadd_deviû_·¿m‘”s
 =

726 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

727 .
	gdeçuÉ_Œaû_æags
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
,

728 .
	gŒaû_æags
 = &
Œaû_æag
,

729 .
	gŒaû_tbl
 = 
vdisk_loÿl_Œaû_tbl
,

730 #iâdeà
CONFIG_SCST_PROC


731 .
	gŒaû_tbl_h–p
 = 
VDISK_TRACE_TBL_HELP
,

736 
kmem_ÿche
 *
	gblockio_wÜk_ÿch•
;

738 
sc¡_dev_ty³
 
	gvdisk_blk_devty³
 = {

739 .
Çme
 = "vdisk_blockio",

740 .
	gty³
 = 
TYPE_DISK
,

741 .
	gth»ads_num
 = 1,

742 .
	g·r£_©omic
 = 1,

743 .
	gdev_dÚe_©omic
 = 1,

744 #ifdeà
CONFIG_SCST_PROC


745 .
	gno_´oc
 = 1,

747 .
	gauto_cm_assignm’t_possibË
 = 1,

748 .
	g©ch
 = 
vdisk_©ch
,

749 .
	gd‘ach
 = 
vdisk_d‘ach
,

750 .
	g©ch_tgt
 = 
vdisk_©ch_tgt
,

751 .
	gd‘ach_tgt
 = 
vdisk_d‘ach_tgt
,

752 .
	g·r£
 = 
nÚ_fžeio_·r£
,

753 .
	gexec
 = 
blockio_exec
,

754 .
	gÚ_®ua_¡©e_chªge_¡¬t
 = 
blockio_Ú_®ua_¡©e_chªge_¡¬t
,

755 .
	gÚ_®ua_¡©e_chªge_fšish
 = 
blockio_Ú_®ua_¡©e_chªge_fšish
,

756 .
	gsk_mgmt_â_dÚe
 = 
vdisk_sk_mgmt_â_dÚe
,

757 .
	gg‘_suµÜ‹d_Ýcodes
 = 
vdisk_g‘_suµÜ‹d_Ýcodes
,

758 .
	gdevt_´iv
 = (*)
blockio_Ýs
,

759 #iâdeà
CONFIG_SCST_PROC


760 .
	gadd_deviû
 = 
vdisk_add_blockio_deviû
,

761 .
	gd–_deviû
 = 
vdisk_d–_deviû
,

762 .
	gdev_©Œs
 = 
vdisk_blockio_©Œs
,

763 .
	gadd_deviû_·¿m‘”s
 =

779 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

780 .
	gdeçuÉ_Œaû_æags
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
,

781 .
	gŒaû_æags
 = &
Œaû_æag
,

782 .
	gŒaû_tbl
 = 
vdisk_loÿl_Œaû_tbl
,

783 #iâdeà
CONFIG_SCST_PROC


784 .
	gŒaû_tbl_h–p
 = 
VDISK_TRACE_TBL_HELP
,

789 
sc¡_dev_ty³
 
	gvdisk_nuÎ_devty³
 = {

790 .
Çme
 = "vdisk_nullio",

791 .
	gty³
 = 
TYPE_DISK
,

792 .
	gth»ads_num
 = 0,

793 .
	g·r£_©omic
 = 1,

794 .
	gdev_dÚe_©omic
 = 1,

795 #ifdeà
CONFIG_SCST_PROC


796 .
	gno_´oc
 = 1,

798 .
	gauto_cm_assignm’t_possibË
 = 1,

799 .
	g©ch
 = 
vdisk_©ch
,

800 .
	gd‘ach
 = 
vdisk_d‘ach
,

801 .
	g©ch_tgt
 = 
vdisk_©ch_tgt
,

802 .
	gd‘ach_tgt
 = 
vdisk_d‘ach_tgt
,

803 .
	g·r£
 = 
nÚ_fžeio_·r£
,

804 .
	gexec
 = 
nuÎio_exec
,

805 .
	gsk_mgmt_â_dÚe
 = 
vdisk_sk_mgmt_â_dÚe
,

806 .
	gdevt_´iv
 = (*)
nuÎio_Ýs
,

807 .
	gg‘_suµÜ‹d_Ýcodes
 = 
vdisk_g‘_suµÜ‹d_Ýcodes
,

808 #iâdeà
CONFIG_SCST_PROC


809 .
	gadd_deviû
 = 
vdisk_add_nuÎio_deviû
,

810 .
	gd–_deviû
 = 
vdisk_d–_deviû
,

811 .
	gdev_©Œs
 = 
vdisk_nuÎio_©Œs
,

812 .
	gadd_deviû_·¿m‘”s
 =

825 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

826 .
	gdeçuÉ_Œaû_æags
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
,

827 .
	gŒaû_æags
 = &
Œaû_æag
,

828 .
	gŒaû_tbl
 = 
vdisk_loÿl_Œaû_tbl
,

829 #iâdeà
CONFIG_SCST_PROC


830 .
	gŒaû_tbl_h–p
 = 
VDISK_TRACE_TBL_HELP
,

835 
sc¡_dev_ty³
 
	gvcdrom_devty³
 = {

836 .
Çme
 = "vcdrom",

837 .
	gty³
 = 
TYPE_ROM
,

838 .
	gexec_sync
 = 1,

839 .
	gth»ads_num
 = -1,

840 .
	g·r£_©omic
 = 1,

841 .
	gdev_dÚe_©omic
 = 1,

842 .
	gauto_cm_assignm’t_possibË
 = 1,

843 .
	g©ch
 = 
vdisk_©ch
,

844 .
	gd‘ach
 = 
vdisk_d‘ach
,

845 .
	g©ch_tgt
 = 
vdisk_©ch_tgt
,

846 .
	gd‘ach_tgt
 = 
vdisk_d‘ach_tgt
,

847 .
	g·r£
 = 
vcdrom_·r£
,

848 .
	gdev_®loc_d©a_buf
 = 
fžeio_®loc_d©a_buf
,

849 .
	gexec
 = 
vcdrom_exec
,

850 .
	gÚ_ä“_cmd
 = 
fžeio_Ú_ä“_cmd
,

851 .
	gsk_mgmt_â_dÚe
 = 
vdisk_sk_mgmt_â_dÚe
,

852 .
	gg‘_suµÜ‹d_Ýcodes
 = 
vcdrom_g‘_suµÜ‹d_Ýcodes
,

853 #ifdeà
CONFIG_SCST_PROC


854 .
	g»ad_´oc
 = 
vcdrom_»ad_´oc
,

855 .
	gwr™e_´oc
 = 
vcdrom_wr™e_´oc
,

857 .
	gadd_deviû
 = 
vcdrom_add_deviû
,

858 .
	gd–_deviû
 = 
vcdrom_d–_deviû
,

859 .
	gdev_©Œs
 = 
vcdrom_©Œs
,

860 .
	gadd_deviû_·¿m‘”s
 = "tst",

862 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

863 .
	gdeçuÉ_Œaû_æags
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
,

864 .
	gŒaû_æags
 = &
Œaû_æag
,

865 .
	gŒaû_tbl
 = 
vdisk_loÿl_Œaû_tbl
,

866 #iâdeà
CONFIG_SCST_PROC


867 .
	gŒaû_tbl_h–p
 = 
VDISK_TRACE_TBL_HELP
,

872 #ifdeà
CONFIG_SCST_PROC


874 *
	gvdisk_´oc_h–p_¡ršg
 =

881 *
	gvcdrom_´oc_h–p_¡ršg
 =

885 
	gsc¡_vdisk_ID
;

887 
moduË_·¿m_Çmed
(
sc¡_vdisk_ID
, sc¡_vdisk_ID, , 
S_IRUGO
);

888 
MODULE_PARM_DESC
(
sc¡_vdisk_ID
, "SCST virtual disk subsystem ID");

892 cÚ¡ *
	$vdev_g‘_fž’ame
(cÚ¡ 
sc¡_vdisk_dev
 *
vœt_dev
)

894 ià(
vœt_dev
->
fž’ame
 !ð
NULL
)

895  
vœt_dev
->
fž’ame
;

898 
	}
}

901 
fže
 *
	$vdev_Ý’_fd
(cÚ¡ 
sc¡_vdisk_dev
 *
vœt_dev
,

902 cÚ¡ *
Çme
, 
boÞ
 
»ad_Úly
)

904 
Ý’_æags
 = 0;

905 
fže
 *
fd
;

907 
	`TRACE_ENTRY
();

909 
	`sBUG_ON
(!
Çme
);

911 ià(
»ad_Úly
)

912 
Ý’_æags
 |ð
O_RDONLY
;

914 
Ý’_æags
 |ð
O_RDWR
;

915 ià(
vœt_dev
->
o_dœeù_æag
)

916 
Ý’_æags
 |ð
O_DIRECT
;

917 ià(
vœt_dev
->
wt_æag
 && !vœt_dev->
nv_ÿche
)

918 
Ý’_æags
 |ð
O_DSYNC
;

920 
	`TRACE_DBG
("O³nšg fž%s, fÏg 0x%x", 
Çme
, 
Ý’_æags
);

921 
fd
 = 
	`fžp_Ý’
(
Çme
, 
O_LARGEFILE
 | 
Ý’_æags
, 0600);

922 ià(
	`IS_ERR
(
fd
)) {

923 ià(
	`PTR_ERR
(
fd
è=ð-
EMEDIUMTYPE
)

924 
	`TRACE
(
TRACE_MINOR
, "Unableo open %s with EMEDIUMTYPE, "

925 "DRBD…assive?", 
Çme
);

927 
	`PRINT_ERROR
("fžp_Ý’(%sèçžed: %d", 
Çme
, ()
	`PTR_ERR
(
fd
));

930 
	`TRACE_EXIT
();

931  
fd
;

932 
	}
}

934 
	$vdisk_blockio_check_æush_suµÜt
(
sc¡_vdisk_dev
 *
vœt_dev
)

936 
šode
 *inode;

937 
fže
 *
fd
;

939 
	`TRACE_ENTRY
();

941 ià(!
vœt_dev
->
blockio
 || vœt_dev->
rd_Úly
 || vœt_dev->
nv_ÿche
 || vœt_dev->
wt_æag
)

942 
out
;

944 
fd
 = 
	`fžp_Ý’
(
vœt_dev
->
fž’ame
, 
O_LARGEFILE
, 0600);

945 ià(
	`IS_ERR
(
fd
)) {

946 ià((
	`PTR_ERR
(
fd
è=ð-
EMEDIUMTYPE
è&& 
vœt_dev
->
blockio
)

947 
	`TRACE
(
TRACE_MINOR
, "Unableo open %s with EMEDIUMTYPE, "

948 "DRBD…assive?", 
vœt_dev
->
fž’ame
);

950 
	`PRINT_ERROR
("filp_open(%s) failed: %ld",

951 
vœt_dev
->
fž’ame
, 
	`PTR_ERR
(
fd
));

952 
out
;

955 
šode
 = 
	`fže_šode
(
fd
);

957 ià(!
	`S_ISBLK
(
šode
->
i_mode
)) {

958 
	`PRINT_ERROR
("% i NOT‡ block deviû", 
vœt_dev
->
fž’ame
);

959 
out_þo£
;

962 ià(
	`vdisk_blockio_æush
(
šode
->
i_bdev
, 
GFP_KERNEL
, 
çl£
, 
NULL
, false) != 0) {

963 
	`PRINT_WARNING
("Device %s doesn't support barriers, switching "

965 
vœt_dev
->
fž’ame
);

966 
vœt_dev
->
nv_ÿche
 = 1;

969 
out_þo£
:

970 
	`fžp_þo£
(
fd
, 
NULL
);

972 
out
:

973 
	`TRACE_EXIT
();

975 
	}
}

977 
	$vdisk_check__suµÜt
(
sc¡_vdisk_dev
 *
vœt_dev
)

979 
fže
 *
fd
 = 
NULL
;

980 
boÞ
 
fd_Ý’
 = 
çl£
;

982 
	`TRACE_ENTRY
();

984 
vœt_dev
->
dev_thš_´ovisiÚed
 = 0;

986 ià(
vœt_dev
->
rd_Úly
 || (vœt_dev->
fž’ame
 =ð
NULL
))

987 
check
;

989 
fd
 = 
	`fžp_Ý’
(
vœt_dev
->
fž’ame
, 
O_LARGEFILE
, 0600);

990 ià(
	`IS_ERR
(
fd
)) {

991 ià((
	`PTR_ERR
(
fd
è=ð-
EMEDIUMTYPE
è&& 
vœt_dev
->
blockio
)

992 
	`TRACE
(
TRACE_MINOR
, "Unableo open %s with EMEDIUMTYPE, "

993 "DRBD…assive?", 
vœt_dev
->
fž’ame
);

995 
	`PRINT_ERROR
("filp_open(%s) failed: %ld",

996 
vœt_dev
->
fž’ame
, 
	`PTR_ERR
(
fd
));

997 
check
;

999 
fd_Ý’
 = 
Œue
;

1001 ià(
vœt_dev
->
blockio
) {

1002 
šode
 *šodð
	`fže_šode
(
fd
);

1004 ià(!
	`S_ISBLK
(
šode
->
i_mode
)) {

1005 
	`PRINT_ERROR
("%s is NOT‡ block device",

1006 
vœt_dev
->
fž’ame
);

1007 
check
;

1009 #ià
LINUX_VERSION_CODE
 > 
	`KERNEL_VERSION
(2, 6, 32è|| (
	`defšed
(
RHEL_MAJOR
) && RHEL_MAJOR -0 >= 6)

1010 
vœt_dev
->
dev_thš_´ovisiÚed
 =

1011 
	`blk_queue_disÿrd
(
	`bdev_g‘_queue
(
šode
->
i_bdev
));

1014 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 38)

1015 
vœt_dev
->
dev_thš_´ovisiÚed
 = (
fd
->
f_Ý
->
çÎoÿ‹
 !ð
NULL
);

1017 
vœt_dev
->
dev_thš_´ovisiÚed
 = 0;

1021 
check
:

1022 ià(
vœt_dev
->
thš_´ovisiÚed_mªu®ly_£t
) {

1023 ià(
vœt_dev
->
thš_´ovisiÚed
 && !vœt_dev->
dev_thš_´ovisiÚed
) {

1024 
	`PRINT_WARNING
("Device %s doesn't supporthin "

1026 
vœt_dev
->
fž’ame
);

1027 
vœt_dev
->
thš_´ovisiÚed
 = 0;

1029 } ià(
vœt_dev
->
blockio
) {

1030 
vœt_dev
->
thš_´ovisiÚed
 = vœt_dev->
dev_thš_´ovisiÚed
;

1031 ià(
vœt_dev
->
thš_´ovisiÚed
)

1032 
	`PRINT_INFO
("Autoƒnablehin…rovisioning for device "

1033 "%s", 
vœt_dev
->
fž’ame
);

1037 ià(
vœt_dev
->
thš_´ovisiÚed
) {

1038 
block_shiá
 = 
vœt_dev
->
dev
->block_shift;

1040 ià(
vœt_dev
->
blockio
) {

1041 
»que¡_queue
 *
q
;

1043 
	`sBUG_ON
(!
fd_Ý’
);

1044 
q
 = 
	`bdev_g‘_queue
(
	`fže_šode
(
fd
)->
i_bdev
);

1045 #ià
LINUX_VERSION_CODE
 > 
	`KERNEL_VERSION
(2, 6, 32) || \

1046 (
	`defšed
(
RHEL_MAJOR
) && RHEL_MAJOR -0 >= 6)

1047 
vœt_dev
->
unm­_Ýt_g¿n
 = 
q
->
lim™s
.
disÿrd_g¿nuÏr™y
 >> 
block_shiá
;

1048 
vœt_dev
->
unm­_®ign
 = 
q
->
lim™s
.
disÿrd_®ignm’t
 >> 
block_shiá
;

1049 
vœt_dev
->
unm­_max_lba_út
 = 
q
->
lim™s
.
max_disÿrd_£ùÜs
 >> (
block_shiá
 - 9);

1050 
vœt_dev
->
disÿrd_z”Ûs_d©a
 = 
q
->
lim™s
.discard_zeroes_data;

1052 
	`sBUG
();

1055 
vœt_dev
->
unm­_Ýt_g¿n
 = 1;

1056 
vœt_dev
->
unm­_®ign
 = 0;

1058 
vœt_dev
->
unm­_max_lba_út
 = (256 * 1024 * 1024è>> 
block_shiá
;

1064 
vœt_dev
->
disÿrd_z”Ûs_d©a
 = 1;

1066 
vœt_dev
->
disÿrd_z”Ûs_d©a
 = 0;

1069 
	`TRACE_DBG
("unmap_gran %d, unmap_alignment %d, max_unmap_lba %u, "

1070 "disÿrd_z”Ûs_d©¨%d", 
vœt_dev
->
unm­_Ýt_g¿n
,

1071 
vœt_dev
->
unm­_®ign
, vœt_dev->
unm­_max_lba_út
,

1072 
vœt_dev
->
disÿrd_z”Ûs_d©a
);

1075 ià(
fd_Ý’
)

1076 
	`fžp_þo£
(
fd
, 
NULL
);

1078 
	`TRACE_EXIT
();

1080 
	}
}

1083 
	$vdisk_g‘_fže_size
(cÚ¡ *
fž’ame
, 
boÞ
 
blockio
,

1084 
loff_t
 *
fže_size
)

1086 
šode
 *inode;

1087 
»s
 = 0;

1088 
fže
 *
fd
;

1090 
	`TRACE_ENTRY
();

1092 
	`sBUG_ON
(!
fž’ame
);

1094 *
fže_size
 = 0;

1096 
fd
 = 
	`fžp_Ý’
(
fž’ame
, 
O_LARGEFILE
 | 
O_RDONLY
, 0600);

1097 ià(
	`IS_ERR
(
fd
)) {

1098 
»s
 = 
	`PTR_ERR
(
fd
);

1099 ià((
»s
 =ð-
EMEDIUMTYPE
è&& 
blockio
)

1100 
	`TRACE
(
TRACE_MINOR
, "Unableo open %s with EMEDIUMTYPE, "

1101 "DRBD…assive?", 
fž’ame
);

1103 
	`PRINT_ERROR
("fžp_Ý’(%sèçžed: %d", 
fž’ame
, 
»s
);

1104 
out
;

1107 
šode
 = 
	`fže_šode
(
fd
);

1109 ià(
blockio
 && !
	`S_ISBLK
(
šode
->
i_mode
)) {

1110 
	`PRINT_ERROR
("Fž% i NOT‡ block deviû", 
fž’ame
);

1111 
»s
 = -
EINVAL
;

1112 
out_þo£
;

1115 ià(
	`S_ISREG
(
šode
->
i_mode
)) {

1117 } ià(
	`S_ISBLK
(
šode
->
i_mode
)) {

1118 
šode
 = inode->
i_bdev
->
bd_šode
;

1120 
»s
 = -
EINVAL
;

1121 
out_þo£
;

1124 *
fže_size
 = 
šode
->
i_size
;

1126 
out_þo£
:

1127 
	`fžp_þo£
(
fd
, 
NULL
);

1129 
out
:

1130 
	`TRACE_EXIT_RES
(
»s
);

1131  
»s
;

1132 
	}
}

1135 
sc¡_vdisk_dev
 *
	$vdev_fšd
(cÚ¡ *
Çme
)

1137 
sc¡_vdisk_dev
 *
»s
, *
vv
;

1139 
	`TRACE_ENTRY
();

1141 
»s
 = 
NULL
;

1142 
	`li¡_fÜ_—ch_’Œy
(
vv
, &
vdev_li¡
, 
vdev_li¡_’Œy
) {

1143 ià(
	`¡rcmp
(
vv
->
Çme
,‚ame) == 0) {

1144 
»s
 = 
vv
;

1149 
	`TRACE_EXIT_HRES
(()
»s
);

1150  
»s
;

1151 
	}
}

1153 
	#VDEV_WT_LABEL
 "WRITE_THROUGH"

	)

1154 
	#VDEV_MODE_PAGES_BUF_SIZE
 (64*1024)

	)

1155 
	#VDEV_MODE_PAGES_DIR
 (
SCST_VAR_DIR
 "/vdev_mode_·ges")

	)

1157 
	$__vdev_§ve_mode_·ges
(cÚ¡ 
sc¡_vdisk_dev
 *
vœt_dev
,

1158 
ušt8_t
 *
buf
, 
size
)

1160 
»s
 = 0;

1162 
	`TRACE_ENTRY
();

1164 ià(
vœt_dev
->
wt_æag
 !ð
DEF_WRITE_THROUGH
) {

1165 
»s
 +ð
	`sú´štf
(&
buf
[»s], 
size
 -„es, "%s=%d\n",

1166 
VDEV_WT_LABEL
, 
vœt_dev
->
wt_æag
);

1167 ià(
»s
 >ð
size
-1)

1168 
out_ov”æow
;

1171 
out
:

1172 
	`TRACE_EXIT_RES
(
»s
);

1173  
»s
;

1175 
out_ov”æow
:

1176 
	`PRINT_ERROR
("Mod·ge bufã¸ov”æow (siz%d)", 
size
);

1177 
»s
 = -
EOVERFLOW
;

1178 
out
;

1179 
	}
}

1181 
	$vdev_§ve_mode_·ges
(cÚ¡ 
sc¡_vdisk_dev
 *
vœt_dev
)

1183 
»s
, 
rc
, 
offs
;

1184 
ušt8_t
 *
buf
;

1185 
size
;

1186 *
Çme
, *
Çme1
;

1188 
	`TRACE_ENTRY
();

1190 
size
 = 
VDEV_MODE_PAGES_BUF_SIZE
;

1192 
buf
 = 
	`vz®loc
(
size
);

1193 ià(
buf
 =ð
NULL
) {

1194 
	`PRINT_ERROR
("UÇbËØ®loømod·ge bufã¸(siz%d)", 
size
);

1195 
»s
 = -
ENOMEM
;

1196 
out
;

1199 
Çme
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%s/%s", 
VDEV_MODE_PAGES_DIR
, 
vœt_dev
->name);

1200 ià(
Çme
 =ð
NULL
) {

1201 
	`PRINT_ERROR
("UÇbËØü—‹‚am%s/%s", 
VDEV_MODE_PAGES_DIR
,

1202 
vœt_dev
->
Çme
);

1203 
»s
 = -
ENOMEM
;

1204 
out_vä“
;

1207 
Çme1
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%s/%s1", 
VDEV_MODE_PAGES_DIR
, 
vœt_dev
->
Çme
);

1208 ià(
Çme1
 =ð
NULL
) {

1209 
	`PRINT_ERROR
("UÇbËØü—‹‚am%s/%s1", 
VDEV_MODE_PAGES_DIR
,

1210 
vœt_dev
->
Çme
);

1211 
»s
 = -
ENOMEM
;

1212 
out_ä“_Çme
;

1215 
offs
 = 
	`sc¡_§ve_glob®_mode_·ges
(
vœt_dev
->
dev
, 
buf
, 
size
);

1216 ià(
offs
 < 0) {

1217 
»s
 = 
offs
;

1218 
out_ä“_Çme1
;

1221 
rc
 = 
	`__vdev_§ve_mode_·ges
(
vœt_dev
, &
buf
[
offs
], 
size
 - offs);

1222 ià(
rc
 < 0) {

1223 
»s
 = 
rc
;

1224 
out_ä“_Çme1
;

1227 
offs
 +ð
rc
;

1228 ià(
offs
 == 0) {

1229 
»s
 = 0;

1230 
	`sc¡_»move_fže
(
Çme
);

1231 
	`sc¡_»move_fže
(
Çme1
);

1232 
out_ä“_Çme1
;

1235 
»s
 = 
	`sc¡_wr™e_fže_Œª§ùiÚ®
(
Çme
, 
Çme1
,

1236 
vœt_dev
->
Çme
, 
	`¡¾’
(vœt_dev->Çme), 
buf
, 
offs
);

1238 
out_ä“_Çme1
:

1239 
	`kä“
(
Çme1
);

1241 
out_ä“_Çme
:

1242 
	`kä“
(
Çme
);

1244 
out_vä“
:

1245 
	`vä“
(
buf
);

1247 
out
:

1248 
	`TRACE_EXIT_RES
(
»s
);

1249  
»s
;

1250 
	}
}

1252 
	$vdev_»¡Üe_wt
(
sc¡_vdisk_dev
 *
vœt_dev
, 
v®
)

1254 
»s
;

1256 
	`TRACE_ENTRY
();

1258 ià(
v®
 > 1) {

1259 
	`PRINT_ERROR
("Invalid value %d for…arameter %s (device %s)",

1260 
v®
, 
VDEV_WT_LABEL
, 
vœt_dev
->
Çme
);

1261 
»s
 = -
EINVAL
;

1262 
out
;

1265 
vœt_dev
->
wt_æag
 = 
v®
;

1266 
vœt_dev
->
wt_æag_§ved
 = 
v®
;

1268 
	`PRINT_INFO
("WT_FLAG„e¡ÜedØ%d fÜ vdev %s", 
vœt_dev
->
wt_æag
,

1269 
vœt_dev
->
Çme
);

1271 
»s
 = 0;

1273 
out
:

1274 
	`TRACE_EXIT_RES
(
»s
);

1275  
»s
;

1276 
	}
}

1279 
	$__vdev_lßd_mode_·ges
(
sc¡_vdisk_dev
 *
vœt_dev
, *
·¿ms
)

1281 
»s
 = 0;

1282 *
·¿m
, *
p
, *
µ
;

1283 
v®
;

1285 
	`TRACE_ENTRY
();

1288 
·¿m
 = 
	`sc¡_g‘_Ãxt_tok’_¡r
(&
·¿ms
);

1289 ià(
·¿m
 =ð
NULL
)

1292 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
·¿m
);

1293 ià(*
p
 == '\0')

1296 
µ
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
·¿m
);

1297 ià(*
µ
 == '\0')

1298 
out_Ãed_·¿m
;

1300 ià(
	`sc¡_g‘_Ãxt_Ëxem
(&
·¿m
)[0] != '\0')

1301 
out_too_mªy
;

1303 
»s
 = 
	`k¡¹oul
(
µ
, 0, &
v®
);

1304 ià(
»s
 != 0)

1305 
out_¡¹oul_çžed
;

1307 ià(
	`¡rÿ£cmp
(
VDEV_WT_LABEL
, 
p
) == 0)

1308 
»s
 = 
	`vdev_»¡Üe_wt
(
vœt_dev
, 
v®
);

1310 
	`TRACE_DBG
("UnknowÀ·¿m‘” %s", 
p
);

1311 
»s
 = -
EINVAL
;

1313 ià(
»s
 != 0)

1317 
out
:

1318 
	`TRACE_EXIT_RES
(
»s
);

1319  
»s
;

1321 
out_¡¹oul_çžed
:

1322 
	`PRINT_ERROR
("¡¹oul(èfÜ % çžed: %d (deviû %s)", 
µ
, 
»s
,

1323 
vœt_dev
->
Çme
);

1324 
out
;

1326 
out_Ãed_·¿m
:

1327 
	`PRINT_ERROR
("P¬am‘” % v®umis£d fÜ deviû %s", 
p
, 
vœt_dev
->
Çme
);

1328 
»s
 = -
EINVAL
;

1329 
out
;

1331 
out_too_mªy
:

1332 
	`PRINT_ERROR
("ToØmªy…¬am‘”' % v®ue (deviû %s)", 
p
, 
vœt_dev
->
Çme
);

1333 
»s
 = -
EINVAL
;

1334 
out
;

1335 
	}
}

1337 
	$vdev_lßd_mode_·ges
(
sc¡_vdisk_dev
 *
vœt_dev
)

1339 
»s
;

1340 
sc¡_deviû
 *
dev
 = 
vœt_dev
->dev;

1341 
ušt8_t
 *
buf
;

1342 
size
;

1343 *
Çme
, *
Çme1
, *
·¿ms
;

1345 
	`TRACE_ENTRY
();

1347 
size
 = 
VDEV_MODE_PAGES_BUF_SIZE
;

1349 
buf
 = 
	`vz®loc
(
size
);

1350 ià(
buf
 =ð
NULL
) {

1351 
	`PRINT_ERROR
("UÇbËØ®loømod·ge bufã¸(siz%d)", 
size
);

1352 
»s
 = -
ENOMEM
;

1353 
out
;

1356 
Çme
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%s/%s", 
VDEV_MODE_PAGES_DIR
, 
vœt_dev
->name);

1357 ià(
Çme
 =ð
NULL
) {

1358 
	`PRINT_ERROR
("UÇbËØü—‹‚am%s/%s", 
VDEV_MODE_PAGES_DIR
,

1359 
vœt_dev
->
Çme
);

1360 
»s
 = -
ENOMEM
;

1361 
out_vä“
;

1364 
Çme1
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%s/%s1", 
VDEV_MODE_PAGES_DIR
, 
vœt_dev
->
Çme
);

1365 ià(
Çme1
 =ð
NULL
) {

1366 
	`PRINT_ERROR
("UÇbËØü—‹‚am%s/%s1", 
VDEV_MODE_PAGES_DIR
,

1367 
vœt_dev
->
Çme
);

1368 
»s
 = -
ENOMEM
;

1369 
out_ä“_Çme
;

1372 
size
 = 
	`sc¡_»ad_fže_Œª§ùiÚ®
(
Çme
, 
Çme1
,

1373 
vœt_dev
->
Çme
, 
	`¡¾’
(vœt_dev->Çme), 
buf
, 
size
-1);

1374 ià(
size
 <= 0) {

1375 
»s
 = 
size
;

1376 
out_ä“_Çme1
;

1379 
buf
[
size
-1] = '\0';

1381 
»s
 = 
	`sc¡_»¡Üe_glob®_mode_·ges
(
dev
, &
buf
[
	`¡¾’
(
vœt_dev
->
Çme
)+1],

1382 &
·¿ms
);

1383 ià((
»s
 !ð0è|| (
·¿ms
 =ð
NULL
))

1384 
out_ä“_Çme1
;

1386 
»s
 = 
	`__vdev_lßd_mode_·ges
(
vœt_dev
, 
·¿ms
);

1388 
out_ä“_Çme1
:

1389 
	`kä“
(
Çme1
);

1391 
out_ä“_Çme
:

1392 
	`kä“
(
Çme
);

1394 
out_vä“
:

1395 
	`vä“
(
buf
);

1397 
out
:

1398 
	`TRACE_EXIT_RES
(
»s
);

1399  
»s
;

1400 
	}
}

1402 #ià
defšed
(
CONFIG_BLK_DEV_INTEGRITY
)

1403 
	$vdisk_š™_block_š‹gr™y
(
sc¡_vdisk_dev
 *
vœt_dev
)

1405 
»s
;

1406 
sc¡_deviû
 *
dev
 = 
vœt_dev
->dev;

1407 
šode
 *inode;

1408 
fže
 *
fd
;

1409 
blk_š‹gr™y
 *
bi
;

1410 cÚ¡ *
bi_´ofže_Çme
;

1412 
	`TRACE_ENTRY
();

1414 
fd
 = 
	`vdev_Ý’_fd
(
vœt_dev
, vœt_dev->
fž’ame
, vœt_dev->
rd_Úly
);

1415 ià(
	`IS_ERR
(
fd
)) {

1416 
»s
 = -
EINVAL
;

1417 
out
;

1420 
šode
 = 
	`fže_šode
(
fd
);

1422 ià(!
	`S_ISBLK
(
šode
->
i_mode
)) {

1423 
	`PRINT_ERROR
("% i NOT‡ block deviû!", 
vœt_dev
->
fž’ame
);

1424 
»s
 = -
EINVAL
;

1425 
out_þo£
;

1428 
bi
 = 
	`bdev_g‘_š‹gr™y
(
šode
->
i_bdev
);

1429 ià(
bi
 =ð
NULL
) {

1430 
	`TRACE_DBG
("Block integrity‚ot supported");

1431 
out_no_bi
;

1434 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 4, 0)

1435 
bi_´ofže_Çme
 = 
bi
->
Çme
;

1437 
bi_´ofže_Çme
 = 
bi
->
´ofže
->
Çme
;

1439 
	`TRACE_DBG
("BI‚am%s", 
bi_´ofže_Çme
);

1441 ià(!
	`¡rcmp
(
bi_´ofže_Çme
, "T10-DIF-TYPE1-CRC")) {

1442 
dev
->
dev_dif__nÙ_suµÜ‹d
 = 1;

1443 ià(
vœt_dev
->
dif_ty³
 != 1) {

1444 
	`PRINT_ERROR
("Integrityype mismatch, %dƒxpected, "

1446 
vœt_dev
->
dif_ty³
, 
dev
->
vœt_Çme
);

1447 
»s
 = -
EINVAL
;

1448 
out_þo£
;

1450 } ià(!
	`¡rcmp
(
bi_´ofže_Çme
, "T10-DIF-TYPE1-IP")) {

1451 ià(
vœt_dev
->
dif_ty³
 != 1) {

1452 
	`PRINT_ERROR
("Integrityype mismatch, %dƒxpected, "

1454 
vœt_dev
->
dif_ty³
, 
dev
->
vœt_Çme
);

1455 
»s
 = -
EINVAL
;

1456 
out_þo£
;

1458 } ià(!
	`¡rcmp
(
bi_´ofže_Çme
, "T10-DIF-TYPE3-CRC")) {

1459 
dev
->
dev_dif__nÙ_suµÜ‹d
 = 1;

1460 ià(
vœt_dev
->
dif_ty³
 != 3) {

1461 
	`PRINT_ERROR
("Integrityype mismatch, %dƒxpected, "

1463 
vœt_dev
->
dif_ty³
, 
dev
->
vœt_Çme
);

1464 
»s
 = -
EINVAL
;

1465 
out_þo£
;

1467 } ià(!
	`¡rcmp
(
bi_´ofže_Çme
, "T10-DIF-TYPE3-IP")) {

1468 ià(
vœt_dev
->
dif_ty³
 != 3) {

1469 
	`PRINT_ERROR
("Integrityype mismatch, %dƒxpected, "

1471 
vœt_dev
->
dif_ty³
, 
dev
->
vœt_Çme
);

1472 
»s
 = -
EINVAL
;

1473 
out_þo£
;

1476 
	`PRINT_ERROR
("Unableo understand integrity‚ame %s"

1477 "(dev %s)", 
bi_´ofže_Çme
, 
dev
->
vœt_Çme
);

1478 
»s
 = -
EINVAL
;

1479 
out_þo£
;

1482 
vœt_dev
->
blk_š‹gr™y
 = 1;

1484 ià((
vœt_dev
->
dif_mode
 & 
SCST_DIF_MODE_DEV_CHECK
) &&

1485 !(
vœt_dev
->
dif_mode
 & 
SCST_DIF_MODE_DEV_STORE
)) {

1486 
	`PRINT_ERROR
("Blockio dev_check is‚ot…ossible without "

1487 "dev_¡Ü(dev %s)", 
dev
->
vœt_Çme
);

1488 
»s
 = -
EINVAL
;

1489 
out_þo£
;

1492 ià(!(
vœt_dev
->
dif_mode
 & 
SCST_DIF_MODE_DEV_CHECK
))

1493 
	`PRINT_WARNING
("Blk integrity implies dev_check (dev %s)",

1494 
dev
->
vœt_Çme
);

1496 
out_no_bi
:

1497 
»s
 = 0;

1499 
out_þo£
:

1500 
	`fžp_þo£
(
fd
, 
NULL
);

1502 
out
:

1503 
	`TRACE_EXIT_RES
(
»s
);

1504  
»s
;

1505 
	}
}

1507 
	$vdisk_š™_block_š‹gr™y
(
sc¡_vdisk_dev
 *
vœt_dev
)

1509 
	`PRINT_ERROR
("Kernel does‚ot support block device integrity");

1510  -
EINVAL
;

1511 
	}
}

1519 
	$vdisk_»examše
(
sc¡_vdisk_dev
 *
vœt_dev
)

1521 
»s
 = 0;

1523 ià(!
vœt_dev
->
nuÎio
 && !vœt_dev->
cdrom_em±y
) {

1524 
loff_t
 
fže_size
;

1526 
»s
 = 
	`vdisk_g‘_fže_size
(
vœt_dev
->
fž’ame
, vœt_dev->
blockio
,

1527 &
fže_size
);

1528 ià(
»s
 < 0) {

1529 ià((
»s
 =ð-
EMEDIUMTYPE
è&& 
vœt_dev
->
blockio
) {

1530 
	`TRACE_DBG
("R“xam…’dšg (dev %s)", 
vœt_dev
->
Çme
);

1531 
vœt_dev
->
»exam_³ndšg
 = 1;

1532 
»s
 = 0;

1534 
out
;

1536 
vœt_dev
->
fže_size
 = file_size;

1537 
	`vdisk_blockio_check_æush_suµÜt
(
vœt_dev
);

1538 
	`vdisk_check__suµÜt
(
vœt_dev
);

1539 } ià(
vœt_dev
->
cdrom_em±y
) {

1540 
vœt_dev
->
fže_size
 = 0;

1543 
vœt_dev
->
nblocks
 = vœt_dev->
fže_size
 >> vœt_dev->
blk_shiá
;

1545 
out
:

1546  
»s
;

1547 
	}
}

1549 
	$vdisk_©ch
(
sc¡_deviû
 *
dev
)

1551 
»s
 = 0;

1552 
sc¡_vdisk_dev
 *
vœt_dev
;

1554 
	`TRACE_ENTRY
();

1556 
	`TRACE_DBG
("vœt_id %d (%s)", 
dev
->
vœt_id
, dev->
vœt_Çme
);

1558 ià(
dev
->
vœt_id
 == 0) {

1559 
	`PRINT_ERROR
("%s", "Not‡ virtual device");

1560 
»s
 = -
EINVAL
;

1561 
out
;

1568 
vœt_dev
 = 
	`vdev_fšd
(
dev
->
vœt_Çme
);

1569 ià(
vœt_dev
 =ð
NULL
) {

1570 
	`PRINT_ERROR
("Deviû % nÙ found", 
dev
->
vœt_Çme
);

1571 
»s
 = -
EINVAL
;

1572 
out
;

1575 
vœt_dev
->
dev
 = dev;

1577 
dev
->
block_shiá
 = 
vœt_dev
->
blk_shiá
;

1578 
dev
->
block_size
 = 1 << dev->
block_shiá
;

1579 
dev
->
þu¡”_mode
 = 
vœt_dev
->
š™Ÿl_þu¡”_mode
;

1581 ià((
vœt_dev
->
dif_ty³
 == 0) &&

1582 ((
vœt_dev
->
dif_mode
 !ð
SCST_DIF_MODE_NONE
) ||

1583 (
vœt_dev
->
dif_fž’ame
 !ð
NULL
))) {

1584 
	`PRINT_ERROR
("Device %s cannot have DIF TYPE 0 if DIF MODE is "

1585 "nÙ NONE o¸DIF FILENAME i nÙ NULL", 
vœt_dev
->
Çme
);

1586 
»s
 = -
EINVAL
;

1587 
out
;

1590 ià(
vœt_dev
->
blockio
) {

1591 ià(!(
vœt_dev
->
dif_mode
 & 
SCST_DIF_MODE_DEV
))

1592 
Ãxt
;

1594 
»s
 = 
	`vdisk_š™_block_š‹gr™y
(
vœt_dev
);

1595 ià(
»s
 != 0)

1596 
out
;

1597 } ià(
vœt_dev
->
dif_mode
 & 
SCST_DIF_MODE_DEV_CHECK
) {

1598 
	`PRINT_ERROR
("dev_check supported only for BLOCKIO devices "

1599 "(dev %s)!", 
dev
->
vœt_Çme
);

1600 
»s
 = -
EINVAL
;

1601 
out
;

1604 
Ãxt
:

1605 ià((
vœt_dev
->
dif_mode
 & 
SCST_DIF_MODE_DEV_STORE
) &&

1606 (
vœt_dev
->
dif_fž’ame
 =ð
NULL
è&& !vœt_dev->
blk_š‹gr™y
) {

1607 
vœt_dev
->
dif_fž’ame
 = 
	`ka¥rštf
(
GFP_KERNEL
,

1608 
DEF_DIF_FILENAME_TMPL
, 
dev
->
vœt_Çme
);

1609 ià(
vœt_dev
->
dif_fž’ame
 =ð
NULL
) {

1610 
	`PRINT_ERROR
("Allocation of default dif_filename "

1611 "çžed (dev %s)", 
dev
->
vœt_Çme
);

1612 
»s
 = -
ENOMEM
;

1613 
out
;

1617 ià(
vœt_dev
->
dif_fž’ame
 !ð
NULL
) {

1619 
fže
 *
dfd
 = 
	`vdev_Ý’_fd
(
vœt_dev
, vœt_dev->
dif_fž’ame
,

1620 
vœt_dev
->
rd_Úly
);

1621 ià(
	`IS_ERR
(
dfd
)) {

1622 
»s
 = 
	`PTR_ERR
(
dfd
);

1623 
out
;

1625 
	`fžp_þo£
(
dfd
, 
NULL
);

1628 
»s
 = 
	`sc¡_£t_dif_·¿ms
(
dev
, 
vœt_dev
->
dif_mode
, vœt_dev->
dif_ty³
);

1629 ià(
»s
 != 0)

1630 
out
;

1632 ià(
vœt_dev
->
dif_ty³
 != 2)

1633 
	`sc¡_dev_£t_dif_¡©ic_­p_g_combšed
(
dev
,

1634 
vœt_dev
->
dif_¡©ic_­p_g_combšed
);

1635 ià(
vœt_dev
->
dif_¡©ic_­p_g_combšed
 !ð
SCST_DIF_NO_CHECK_APP_TAG
)

1636 
	`PRINT_WARNING
("Device %s: static‡ppag is ignored for DIF "

1637 "mod2", 
dev
->
vœt_Çme
);

1639 #iâdeà
CONFIG_SCST_PROC


1640 ià(
vœt_dev
->
dif_fž’ame
 !ð
NULL
) {

1641 
»s
 = 
	`sc¡_ü—‹_dev_©Œ
(
dev
, &
vdev_dif_fž’ame_©Œ
);

1642 ià(
»s
 != 0) {

1643 
	`PRINT_ERROR
("Can't create‡ttr %s for dev %s",

1644 
vdev_dif_fž’ame_©Œ
.
©Œ
.
Çme
,

1645 
dev
->
vœt_Çme
);

1646 
out
;

1651 ià(
vœt_dev
->
z”o_cÝy
 && vœt_dev->
o_dœeù_æag
) {

1652 
	`PRINT_ERROR
("%s: combining zero_copy with o_direct is‚ot"

1653 " suµÜ‹d", 
vœt_dev
->
fž’ame
);

1654 
»s
 = -
EINVAL
;

1655 
out
;

1658 
dev
->
dev_rd_Úly
 = 
vœt_dev
->
rd_Úly
;

1660 
»s
 = 
	`vdisk_»examše
(
vœt_dev
);

1661 ià(
»s
 < 0)

1662 
out
;

1664 ià(!
vœt_dev
->
cdrom_em±y
) {

1665 
	`PRINT_INFO
("Attached SCSIarget virtual %s %s "

1668 (
dev
->
ty³
 =ð
TYPE_DISK
) ? "disk" : "cdrom",

1669 
vœt_dev
->
Çme
, 
	`vdev_g‘_fž’ame
(virt_dev),

1670 
vœt_dev
->
fže_size
 >> 20, 
dev
->
block_size
,

1671 ()
vœt_dev
->
nblocks
,

1672 ()
vœt_dev
->
nblocks
/64/32,

1673 
vœt_dev
->
nblocks
 < 64*32

1676 
	`PRINT_INFO
("Attachedƒmpty SCSIarget virtual cdrom %s",

1677 
vœt_dev
->
Çme
);

1680 
dev
->
dh_´iv
 = 
vœt_dev
;

1682 
dev
->
t¡
 = 
vœt_dev
->tst;

1683 
dev
->
tmf_Úly
 = 
DEF_TMF_ONLY
;

1684 
dev
->
tmf_Úly_§ved
 = 
DEF_TMF_ONLY
;

1685 
dev
->
tmf_Úly_deçuÉ
 = 
DEF_TMF_ONLY
;

1686 
dev
->
d_£n£
 = 
DEF_DSENSE
;

1687 
dev
->
d_£n£_§ved
 = 
DEF_DSENSE
;

1688 
dev
->
d_£n£_deçuÉ
 = 
DEF_DSENSE
;

1689 ià(
vœt_dev
->
wt_æag
 && !vœt_dev->
nv_ÿche
)

1690 
dev
->
queue_®g
 = 
DEF_QUEUE_ALG_WT
;

1692 
dev
->
queue_®g
 = 
DEF_QUEUE_ALG
;

1693 
dev
->
queue_®g_§ved
 = dev->
queue_®g
;

1694 
dev
->
queue_®g_deçuÉ
 = dev->
queue_®g
;

1695 
dev
->
q”r
 = 
DEF_QERR
;

1696 
dev
->
q”r_§ved
 = 
DEF_QERR
;

1697 
dev
->
q”r_deçuÉ
 = 
DEF_QERR
;

1698 
dev
->
swp
 = 
DEF_SWP
;

1699 
dev
->
swp_§ved
 = 
DEF_SWP
;

1700 
dev
->
swp_deçuÉ
 = 
DEF_SWP
;

1701 
dev
->
s
 = 
DEF_TAS
;

1702 
dev
->
s_§ved
 = 
DEF_TAS
;

1703 
dev
->
s_deçuÉ
 = 
DEF_TAS
;

1704 
dev
->
dpicz
 = 
DEF_DPICZ
;

1705 
dev
->
dpicz_§ved
 = 
DEF_DPICZ
;

1706 
dev
->
dpicz_deçuÉ
 = 
DEF_DPICZ
;

1707 ià((
vœt_dev
->
dif_fž’ame
 =ð
NULL
è&& !vœt_dev->
blk_š‹gr™y
)

1708 
dev
->
©o
 = 
SCST_ATO_0_MODIFIED_BY_STORAGE
;

1710 
dev
->
©o
 = 
SCST_ATO_1_NOT_MODIFIED_BY_STORAGE
;

1712 ià(
vdev_§ved_mode_·ges_’abËd
)

1713 
	`vdev_lßd_mode_·ges
(
vœt_dev
);

1715 
»s
 = 
	`sc¡_´_£t_þu¡”_mode
(
dev
, dev->
þu¡”_mode
,

1716 
vœt_dev
->
t10_dev_id
);

1718 
out
:

1719 
	`TRACE_EXIT
();

1720  
»s
;

1721 
	}
}

1724 
	$vdisk_d‘ach
(
sc¡_deviû
 *
dev
)

1726 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

1728 
	`TRACE_ENTRY
();

1730 
	`lockd•_as£¹_h–d
(&
sc¡_mu‹x
);

1732 
	`TRACE_DBG
("vœt_id %d", 
dev
->
vœt_id
);

1734 
	`sc¡_´_£t_þu¡”_mode
(
dev
, 
çl£
, 
vœt_dev
->
t10_dev_id
);

1736 
	`PRINT_INFO
("Detached virtual device %s (\"%s\")",

1737 
vœt_dev
->
Çme
, 
	`vdev_g‘_fž’ame
(virt_dev));

1740 
dev
->
dh_´iv
 = 
NULL
;

1742 
	`TRACE_EXIT
();

1744 
	}
}

1746 
	$vdisk_Ý’_fd
(
sc¡_vdisk_dev
 *
vœt_dev
, 
boÞ
 
»ad_Úly
)

1748 
»s
;

1750 
	`sBUG_ON
(!
vœt_dev
->
fž’ame
);

1752 
vœt_dev
->
fd
 = 
	`vdev_Ý’_fd
(vœt_dev, vœt_dev->
fž’ame
, 
»ad_Úly
);

1753 ià(
	`IS_ERR
(
vœt_dev
->
fd
)) {

1754 
»s
 = 
	`PTR_ERR
(
vœt_dev
->
fd
);

1755 
vœt_dev
->
fd
 = 
NULL
;

1756 
out
;

1758 
vœt_dev
->
bdev
 = vœt_dev->
blockio
 ? 
	`fže_šode
(vœt_dev->
fd
)->
i_bdev
 :

1759 
NULL
;

1760 
»s
 = 0;

1762 ià(
vœt_dev
->
dif_fž’ame
 !ð
NULL
) {

1763 
vœt_dev
->
dif_fd
 = 
	`vdev_Ý’_fd
(virt_dev,

1764 
vœt_dev
->
dif_fž’ame
, 
»ad_Úly
);

1765 ià(
	`IS_ERR
(
vœt_dev
->
dif_fd
)) {

1766 
»s
 = 
	`PTR_ERR
(
vœt_dev
->
dif_fd
);

1767 
vœt_dev
->
dif_fd
 = 
NULL
;

1768 
out_þo£_fd
;

1772 
out
:

1773  
»s
;

1775 
out_þo£_fd
:

1776 
	`fžp_þo£
(
vœt_dev
->
fd
, 
NULL
);

1777 
vœt_dev
->
fd
 = 
NULL
;

1778 
out
;

1779 
	}
}

1781 
	$vdisk_þo£_fd
(
sc¡_vdisk_dev
 *
vœt_dev
)

1783 ià(
vœt_dev
->
fd
) {

1784 
	`fžp_þo£
(
vœt_dev
->
fd
, 
NULL
);

1785 
vœt_dev
->
fd
 = 
NULL
;

1786 
vœt_dev
->
bdev
 = 
NULL
;

1788 ià(
vœt_dev
->
dif_fd
) {

1789 
	`fžp_þo£
(
vœt_dev
->
dif_fd
, 
NULL
);

1790 
vœt_dev
->
dif_fd
 = 
NULL
;

1792 
	}
}

1795 
	$vdisk_©ch_tgt
(
sc¡_tgt_dev
 *
tgt_dev
)

1797 
sc¡_vdisk_dev
 *
vœt_dev
 = 
tgt_dev
->
dev
->
dh_´iv
;

1798 
»s
 = 0;

1800 
	`TRACE_ENTRY
();

1802 
	`lockd•_as£¹_h–d
(&
sc¡_mu‹x
);

1804 
vœt_dev
->
tgt_dev_út
++;

1806 ià(
vœt_dev
->
fd
 !ð
NULL
)

1807 
out
;

1809 ià(!
vœt_dev
->
nuÎio
 && !vœt_dev->
cdrom_em±y
) {

1810 
»s
 = 
	`vdisk_Ý’_fd
(
vœt_dev
, 
tgt_dev
->
dev
->
dev_rd_Úly
);

1811 ià(
»s
 != 0) {

1812 ià((
»s
 =ð-
EMEDIUMTYPE
è&& 
vœt_dev
->
blockio
) {

1814 
»s
 = 0;

1816 
vœt_dev
->
tgt_dev_út
--;

1817 
out
;

1821 
vœt_dev
->
fd
 = 
NULL
;

1822 
vœt_dev
->
dif_fd
 = 
NULL
;

1825 
out
:

1826 
	`TRACE_EXIT_RES
(
»s
);

1827  
»s
;

1828 
	}
}

1831 
	$vdisk_d‘ach_tgt
(
sc¡_tgt_dev
 *
tgt_dev
)

1833 
sc¡_vdisk_dev
 *
vœt_dev
 = 
tgt_dev
->
dev
->
dh_´iv
;

1835 
	`TRACE_ENTRY
();

1837 
	`lockd•_as£¹_h–d
(&
sc¡_mu‹x
);

1839 ià(--
vœt_dev
->
tgt_dev_út
 == 0)

1840 
	`vdisk_þo£_fd
(
vœt_dev
);

1842 
	`TRACE_EXIT
();

1844 
	}
}

1846 
com¶_¡©us_e
 
	$vdisk_synchrÚize_ÿche
(
vdisk_cmd_·¿ms
 *
p
)

1848 
sc¡_cmd
 *
cmd
 = 
p
->cmd;

1849 cÚ¡ 
ušt8_t
 *
cdb
 = 
cmd
->cdb;

1850 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

1851 cÚ¡ 
loff_t
 
loff
 = 
p
->loff;

1852 
št64_t
 
d©a_Ën
 = 
	`sc¡_cmd_g‘_d©a_Ën
(
cmd
);

1853 
immed
 = 
cdb
[1] & 0x2;

1854 
com¶_¡©us_e
 
»s
;

1856 
	`TRACE_ENTRY
();

1858 
	`TRACE
(
TRACE_ORDER
, "SYNCHRONIZE_CACHE: "

1860 ()
loff
,

1861 ()
d©a_Ën
, 
immed
);

1863 ià(
d©a_Ën
 == 0) {

1864 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

1866 
d©a_Ën
 = 
vœt_dev
->
fže_size
 -

1867 ((
loff_t
)
	`sc¡_cmd_g‘_lba
(
cmd
è<< 
dev
->
block_shiá
);

1870 ià(
immed
) {

1871 
	`sc¡_cmd_g‘
(
cmd
);

1872 
cmd
->
com¶‘ed
 = 1;

1873 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
,

1874 
SCST_CONTEXT_SAME
);

1875 
	`vdisk_fsync
(
loff
, 
d©a_Ën
, 
dev
, 
cmd
->
cmd_gå_mask
, 
NULL
, 
Œue
);

1877 
	`sc¡_cmd_put
(
cmd
);

1878 
»s
 = 
RUNNING_ASYNC
;

1880 
	`vdisk_fsync
(
loff
, 
d©a_Ën
, 
dev
, 
cmd
->
cmd_gå_mask
, cmd, 
Œue
);

1881 
»s
 = 
RUNNING_ASYNC
;

1884 
	`TRACE_EXIT_RES
(
»s
);

1885  
»s
;

1886 
	}
}

1888 
com¶_¡©us_e
 
	$vdisk_exec_¡¬t_¡Ý
(
vdisk_cmd_·¿ms
 *
p
)

1890 
sc¡_cmd
 *
cmd
 = 
p
->cmd;

1891 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

1892 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

1894 
	`TRACE_ENTRY
();

1896 
	`vdisk_fsync
(0, 
vœt_dev
->
fže_size
, 
dev
, 
cmd
->
cmd_gå_mask
, cmd, 
çl£
);

1898 
	`TRACE_EXIT
();

1899  
CMD_SUCCEEDED
;

1900 
	}
}

1902 
com¶_¡©us_e
 
	$vdisk_nÝ
(
vdisk_cmd_·¿ms
 *
p
)

1904  
CMD_SUCCEEDED
;

1905 
	}
}

1907 
com¶_¡©us_e
 
	$vdisk_exec_§i_16
(
vdisk_cmd_·¿ms
 *
p
)

1909 
p
->
cmd
->
cdb
[1] & 0x1f) {

1910 
SAI_READ_CAPACITY_16
:

1911 
	`vdisk_exec_»ad_ÿ·c™y16
(
p
);

1912  
CMD_SUCCEEDED
;

1913 
SAI_GET_LBA_STATUS
:

1914  
	`vdisk_exec_g‘_lba_¡©us
(
p
);

1916 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
p
->
cmd
, 1,

1917 0 | 
SCST_INVAL_FIELD_BIT_OFFS_VALID
);

1918  
CMD_SUCCEEDED
;

1919 
	}
}

1921 
com¶_¡©us_e
 
	$vdisk_exec_maš‹Çnû_š
(
vdisk_cmd_·¿ms
 *
p
)

1923 
p
->
cmd
->
cdb
[1] & 0x1f) {

1924 
MI_REPORT_TARGET_PGS
:

1925 
	`vdisk_exec_»pÜt_gs
(
p
);

1926  
CMD_SUCCEEDED
;

1928 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
p
->
cmd
, 1,

1929 0 | 
SCST_INVAL_FIELD_BIT_OFFS_VALID
);

1930  
CMD_SUCCEEDED
;

1931 
	}
}

1933 
com¶_¡©us_e
 
	$vdisk_exec_maš‹Çnû_out
(
vdisk_cmd_·¿ms
 *
p
)

1935 
p
->
cmd
->
cdb
[1] & 0x1f) {

1936 
MO_SET_TARGET_PGS
:

1937  
	`vdisk_exec_£t_gs
(
p
);

1939 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
p
->
cmd
, 1,

1940 0 | 
SCST_INVAL_FIELD_BIT_OFFS_VALID
);

1941  
CMD_SUCCEEDED
;

1942 
	}
}

1944 
com¶_¡©us_e
 
	$vdisk_exec_£nd_dŸgno¡ic
(
vdisk_cmd_·¿ms
 *
p
)

1946  
CMD_SUCCEEDED
;

1947 
	}
}

1949 
	$vdisk_fÜm©_dif
(
sc¡_cmd
 *
cmd
, 
ušt64_t
 
¡¬t_lba
,

1950 
ušt64_t
 
blocks
)

1952 
»s
 = 0;

1953 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

1954 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

1955 
loff_t
 
loff
;

1956 
mm_£gm’t_t
 
Þd_fs
;

1957 
loff_t
 
”r
 = 0;

1958 
ssize_t
 
fuÎ_Ën
;

1959 
fže
 *
fd
 = 
vœt_dev
->
dif_fd
;

1960 
iovec
 *
iv
;

1961 
max_iv_couÁ
, 
iv_couÁ
, 
i
;

1962 
·ge
 *
iv_·ge
, *
d©a_·ge
;

1963 
ušt8_t
 *
d©a_buf
;

1964 
št64_t
 
Ëá
, 
dÚe
;

1966 
	`TRACE_ENTRY
();

1968 ià(
vœt_dev
->
dif_fd
 =ð
NULL
)

1969 
out
;

1971 
	`EXTRACHECKS_BUG_ON
(!(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV_STORE
));

1973 
iv_·ge
 = 
	`®loc_·ge
(
GFP_KERNEL
);

1974 ià(
iv_·ge
 =ð
NULL
) {

1975 
	`PRINT_ERROR
("Unableo‡llocate iv…age");

1976 
	`sc¡_£t_busy
(
cmd
);

1977 
»s
 = -
ENOMEM
;

1978 
out
;

1981 
d©a_·ge
 = 
	`®loc_·ge
(
GFP_KERNEL
);

1982 ià(
d©a_·ge
 =ð
NULL
) {

1983 
	`PRINT_ERROR
("Unableo‡llocateags data…age");

1984 
	`sc¡_£t_busy
(
cmd
);

1985 
»s
 = -
ENOMEM
;

1986 
out_ä“_iv
;

1989 
d©a_buf
 = 
	`·ge_add»ss
(
d©a_·ge
);

1990 
	`mem£t
(
d©a_buf
, 0xFF, 
PAGE_SIZE
);

1992 
iv
 = 
	`·ge_add»ss
(
iv_·ge
);

1993 
max_iv_couÁ
 = 
	`mš_t
(, 
UIO_MAXIOV
, ()
PAGE_SIZE
/(*
iv
));

1995 
i
 = 0; i < 
max_iv_couÁ
; i++)

1996 
iv
[
i
].
iov_ba£
 = (
ušt8_t
 
__fÜû
 
__u£r
 *)
d©a_buf
;

1998 
Þd_fs
 = 
	`g‘_fs
();

1999 
	`£t_fs
(
	`g‘_ds
());

2001 
loff
 = 
¡¬t_lba
 << 
SCST_DIF_TAG_SHIFT
;

2002 
Ëá
 = 
blocks
 << 
SCST_DIF_TAG_SHIFT
;

2003 
dÚe
 = 0;

2004 
Ëá
 > 0) {

2005 
iv_couÁ
 = 0;

2006 
fuÎ_Ën
 = 0;

2007 
i
 = -1;

2009 
Ën
 = 
	`mš_t
(
size_t
, (size_t)
Ëá
, 
PAGE_SIZE
);

2011 
fuÎ_Ën
 +ð
Ën
;

2012 
i
++;

2013 
iv_couÁ
++;

2014 
iv
[
i
].
iov_Ën
 = 
Ën
;

2015 
Ëá
 -ð
Ën
;

2016 
dÚe
 +ð
Ën
;

2017 
	`EXTRACHECKS_BUG_ON
(
Ëá
 < 0);

2018 ià((
iv_couÁ
 =ð
max_iv_couÁ
è|| (
Ëá
 == 0))

2022 
	`TRACE_DBG
("Formatting DIF: full_len %zd, off %lld",

2023 
fuÎ_Ën
, ()
loff
);

2026 
”r
 = 
	`vfs_wr™ev
(
fd
, (
iovec
 
__fÜû
 
__u£r
 *)
iv
, 
iv_couÁ
,

2027 &
loff
);

2028 ià(
”r
 < 0) {

2029 
	`PRINT_ERROR
("Formatting DIF write()„eturned %lld from "

2030 "%zd", ()
”r
, 
fuÎ_Ën
);

2031 ià(
”r
 =ð-
EAGAIN
)

2032 
	`sc¡_£t_busy
(
cmd
);

2034 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2035 
	`SCST_LOAD_SENSE
(
sc¡_£n£_wr™e_”rÜ
));

2036 
»s
 = 
”r
;

2037 
out_£t_fs
;

2038 } ià(
”r
 < 
fuÎ_Ën
) {

2043 
Ëá
 +ð
fuÎ_Ën
 - 
”r
;

2044 
dÚe
 -ð
fuÎ_Ën
 - 
”r
;

2047 
vœt_dev
->
fÜm©_´og»ss_dÚe
 = 
dÚe
;

2050 
out_£t_fs
:

2051 
	`£t_fs
(
Þd_fs
);

2053 
	`__ä“_·ge
(
d©a_·ge
);

2055 
out_ä“_iv
:

2056 
	`__ä“_·ge
(
iv_·ge
);

2058 
out
:

2059 
	`TRACE_EXIT_RES
(
»s
);

2060  
»s
;

2061 
	}
}

2063 
com¶_¡©us_e
 
	$vdisk_exec_fÜm©_un™
(
vdisk_cmd_·¿ms
 *
p
)

2065 
»s
 = 
CMD_SUCCEEDED
;

2066 
sc¡_cmd
 *
cmd
 = 
p
->cmd;

2067 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

2068 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

2069 
ušt8_t
 *
buf
;

2070 
´Ù_ty³
 = 
dev
->
dev_dif_ty³
, 
pšfo
;

2071 
boÞ
 
immed
 = 
çl£
;

2073 
	`TRACE_ENTRY
();

2075 
pšfo
 = (
cmd
->
cdb
[1] & 0xC0) >> 6;

2076 ià(((
cmd
->
cdb
[1] & 0x10è=ð0è&& (
pšfo
 != 0)) {

2078 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 1,

2079 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 6);

2080 
out
;

2083 ià(
cmd
->
cdb
[1] & 0x10) {

2084 
Ëngth
, 
´Ù_u§ge
;

2086 
Ëngth
 = 
	`sc¡_g‘_buf_fuÎ_£n£
(
cmd
, &
buf
);

2087 
	`TRACE_DBG
("Ëngth %d", 
Ëngth
);

2088 ià(
	`uÆik–y
(
Ëngth
 <= 0))

2089 
out
;

2091 
	`TRACE_BUFF_FLAG
(
TRACE_DEBUG
, "FÜm© buf", 
buf
, 64);

2093 ià(
Ëngth
 < 4) {

2094 
	`PRINT_ERROR
("FORMAT UNIT:oo small…arameters†ist "

2095 "h—d” %d (dev %s)", 
Ëngth
, 
dev
->
vœt_Çme
);

2096 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2097 
	`SCST_LOAD_SENSE
(
sc¡_£n£_·¿m‘”_li¡_Ëngth_šv®id
));

2098 
out_put
;

2101 
´Ù_u§ge
 = 
buf
[0] & 7;

2102 
immed
 = 
buf
[1] & 2;

2104 ià((
buf
[1] & 8) != 0) {

2105 
	`PRINT_ERROR
("FORMAT UNIT: initialization…attern‚ot "

2107 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 1,

2108 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 3);

2109 
out_put
;

2112 ià(
cmd
->
cdb
[1] & 0x20) {

2113 ià(
Ëngth
 < 8) {

2114 
	`PRINT_ERROR
("FORMAT UNIT:oo small†ong "

2116 
Ëngth
, 
dev
->
vœt_Çme
);

2117 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 1,

2118 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 5);

2119 
out_put
;

2121 ià((
buf
[3] & 0xF0) != 0) {

2122 
	`PRINT_ERROR
("FORMAT UNIT: P_I_INFORMATION must "

2123 "b0 (dev %s)", 
dev
->
vœt_Çme
);

2124 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 3,

2125 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 4);

2126 
out_put
;

2128 ià((
buf
[3] & 0xF) != 0) {

2129 
	`PRINT_ERROR
("FORMAT UNIT: PROTECTION INTERVAL "

2131 
buf
[3] & 0xF, 
dev
->
vœt_Çme
);

2132 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 3,

2133 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 4);

2134 
out_put
;

2140 
	`sc¡_put_buf_fuÎ
(
cmd
, 
buf
);

2142 
pšfo
) {

2144 
´Ù_u§ge
) {

2146 
´Ù_ty³
 = 0;

2149 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 0,

2150 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 0);

2151 
out
;

2155 
´Ù_u§ge
) {

2157 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 0,

2158 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 0);

2159 
out
;

2163 
´Ù_u§ge
) {

2165 
´Ù_ty³
 = 1;

2168 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 0,

2169 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 0);

2170 
out
;

2174 
´Ù_u§ge
) {

2176 
´Ù_ty³
 = 2;

2179 
´Ù_ty³
 = 3;

2182 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 0,

2183 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 0);

2184 
out
;

2188 
	`sBUG
();

2193 
	`TRACE_DBG
("´Ù_ty³ %d,…šfØ%d, immed %d (cmd %p)", 
´Ù_ty³
,

2194 
pšfo
, 
immed
, 
cmd
);

2196 ià(
´Ù_ty³
 !ð
dev
->
dev_dif_ty³
) {

2197 
	`PRINT_ERROR
("FORMAT UNIT: DIFype %d‚ot supported (dev %s)",

2198 
´Ù_ty³
, 
dev
->
vœt_Çme
);

2199 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 1,

2200 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 6);

2201 
out
;

2204 ià(
immed
) {

2205 
	`sc¡_cmd_g‘
(
cmd
);

2206 
cmd
->
com¶‘ed
 = 1;

2207 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

2208 
»s
 = 
RUNNING_ASYNC
;

2211 
	`¥š_lock
(&
vœt_dev
->
æags_lock
);

2212 
vœt_dev
->
fÜm©_aùive
 = 1;

2213 
	`¥š_uÆock
(&
vœt_dev
->
æags_lock
);

2215 
vœt_dev
->
fÜm©_´og»ss_dÚe
 = 0;

2216 
vœt_dev
->
fÜm©_´og»ss_to_do
 = vœt_dev->
nblocks
 << 
SCST_DIF_TAG_SHIFT
;

2218 ià(
vœt_dev
->
thš_´ovisiÚed
) {

2219 
rc
 = 
	`vdisk_unm­_¿nge
(
cmd
, 
vœt_dev
, 0, vœt_dev->
nblocks
);

2221 ià(
rc
 != 0)

2222 
fšished
;

2225 ià(
pšfo
 != 0)

2226 
	`vdisk_fÜm©_dif
(
cmd
, 0, 
vœt_dev
->
nblocks
);

2228 
fšished
:

2229 
	`¥š_lock
(&
vœt_dev
->
æags_lock
);

2230 
vœt_dev
->
fÜm©_aùive
 = 0;

2231 
	`¥š_uÆock
(&
vœt_dev
->
æags_lock
);

2233 ià(
immed
)

2234 
	`sc¡_cmd_put
(
cmd
);

2236 
out
:

2237 
	`TRACE_EXIT_RES
(
»s
);

2238  
»s
;

2240 
out_put
:

2241 
	`sc¡_put_buf_fuÎ
(
cmd
, 
buf
);

2242 
out
;

2243 
	}
}

2245 
com¶_¡©us_e
 
	$vdisk_šv®id_Ýcode
(
vdisk_cmd_·¿ms
 *
p
)

2247 
	`TRACE_DBG
("Inv®id opcod%s", 
	`sc¡_g‘_Ýcode_Çme
(
p
->
cmd
));

2248  
INVALID_OPCODE
;

2249 
	}
}

2251 
	#VDEV_DEF_RDPROTECT
 0xE0

	)

2252 
	#VDEV_DEF_WRPROTECT
 0xE0

	)

2253 
	#VDEV_DEF_VRPROTECT
 0xE0

	)

2255 
	#VDEF_DEF_GROUP_NUM
 0

	)

2257 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_cwr
 = {

2258 .
od_Ýcode
 = 
COMPARE_AND_WRITE
,

2259 .
	god_suµÜt
 = 3,

2260 .
	god_cdb_size
 = 16,

2261 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2262 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_REG_TIMEOUT
/
HZ
,

2263 .
	god_cdb_u§ge_b™s
 = { 
COMPARE_AND_WRITE
, 
VDEV_DEF_WRPROTECT
 | 0x18,

2265 0, 0, 0, 0xFF, 
VDEF_DEF_GROUP_NUM
,

2266 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

2269 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_fÜm©_un™
 = {

2270 .
od_Ýcode
 = 
FORMAT_UNIT
,

2271 .
	god_suµÜt
 = 3,

2272 .
	god_cdb_size
 = 6,

2273 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2274 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_LONG_TIMEOUT
/
HZ
,

2275 .
	god_cdb_u§ge_b™s
 = { 
FORMAT_UNIT
, 0xF0, 0, 0, 0, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

2278 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_g‘_lba_¡©us
 = {

2279 .
od_Ýcode
 = 
SERVICE_ACTION_IN_16
,

2280 .
	god_£rv_aùiÚ
 = 
SAI_GET_LBA_STATUS
,

2281 .
	god_£rv_aùiÚ_v®id
 = 1,

2282 .
	god_suµÜt
 = 3,

2283 .
	god_cdb_size
 = 16,

2284 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2285 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_SMALL_TIMEOUT
/
HZ
,

2286 .
	god_cdb_u§ge_b™s
 = { 
SERVICE_ACTION_IN_16
, 
SAI_GET_LBA_STATUS
,

2289 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

2292 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_®low_medium_»mov®
 = {

2293 .
od_Ýcode
 = 
ALLOW_MEDIUM_REMOVAL
,

2294 .
	god_suµÜt
 = 3,

2295 .
	god_cdb_size
 = 6,

2296 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2297 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_SMALL_TIMEOUT
/
HZ
,

2298 .
	god_cdb_u§ge_b™s
 = { 
ALLOW_MEDIUM_REMOVAL
, 0, 0, 0, 3, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

2301 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_»ad6
 = {

2302 .
od_Ýcode
 = 
READ_6
,

2303 .
	god_suµÜt
 = 3,

2304 .
	god_cdb_size
 = 6,

2305 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2306 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_REG_TIMEOUT
/
HZ
,

2307 .
	god_cdb_u§ge_b™s
 = { 
READ_6
, 0x1F,

2308 0xFF, 0xFF, 0xFF, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

2311 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_»ad10
 = {

2312 .
od_Ýcode
 = 
READ_10
,

2313 .
	god_suµÜt
 = 3,

2314 .
	god_cdb_size
 = 10,

2315 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2316 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_REG_TIMEOUT
/
HZ
,

2317 .
	god_cdb_u§ge_b™s
 = { 
READ_10
, 
VDEV_DEF_RDPROTECT
 | 0x18,

2318 0xFF, 0xFF, 0xFF, 0xFF, 
VDEF_DEF_GROUP_NUM
,

2319 0xFF, 0xFF, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

2322 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_»ad12
 = {

2323 .
od_Ýcode
 = 
READ_12
,

2324 .
	god_suµÜt
 = 3,

2325 .
	god_cdb_size
 = 12,

2326 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2327 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_REG_TIMEOUT
/
HZ
,

2328 .
	god_cdb_u§ge_b™s
 = { 
READ_12
, 
VDEV_DEF_RDPROTECT
 | 0x18,

2330 
VDEF_DEF_GROUP_NUM
, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

2333 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_»ad16
 = {

2334 .
od_Ýcode
 = 
READ_16
,

2335 .
	god_suµÜt
 = 3,

2336 .
	god_cdb_size
 = 16,

2337 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2338 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_REG_TIMEOUT
/
HZ
,

2339 .
	god_cdb_u§ge_b™s
 = { 
READ_16
, 
VDEV_DEF_RDPROTECT
 | 0x18,

2341 0xFF, 0xFF, 0xFF, 0xFF, 
VDEF_DEF_GROUP_NUM
,

2342 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

2345 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_»ad32
 = {

2346 .
od_Ýcode
 = 
VARIABLE_LENGTH_CMD
,

2347 .
	god_£rv_aùiÚ
 = 
SUBCODE_READ_32
,

2348 .
	god_£rv_aùiÚ_v®id
 = 1,

2349 .
	god_suµÜt
 = 3,

2350 .
	god_cdb_size
 = 32,

2351 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2352 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_REG_TIMEOUT
/
HZ
,

2353 .
	god_cdb_u§ge_b™s
 = { 
VARIABLE_LENGTH_CMD
, 
SCST_OD_DEFAULT_CONTROL_BYTE
,

2354 0, 0, 0, 0, 
VDEF_DEF_GROUP_NUM
, 0x18, 0,

2355 
SUBCODE_READ_32
, 
VDEV_DEF_RDPROTECT
 | 0x18, 0,

2361 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_»ad_ÿ·c™y
 = {

2362 .
od_Ýcode
 = 
READ_CAPACITY
,

2363 .
	god_suµÜt
 = 3,

2364 .
	god_cdb_size
 = 10,

2365 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2366 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_SMALL_TIMEOUT
/
HZ
,

2367 .
	god_cdb_u§ge_b™s
 = { 
READ_CAPACITY
, 0, 0, 0, 0, 0, 0,

2368 0, 0, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

2371 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_»ad_ÿ·c™y16
 = {

2372 .
od_Ýcode
 = 
SERVICE_ACTION_IN_16
,

2373 .
	god_£rv_aùiÚ
 = 
SAI_READ_CAPACITY_16
,

2374 .
	god_£rv_aùiÚ_v®id
 = 1,

2375 .
	god_suµÜt
 = 3,

2376 .
	god_cdb_size
 = 16,

2377 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2378 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_SMALL_TIMEOUT
/
HZ
,

2379 .
	god_cdb_u§ge_b™s
 = { 
SERVICE_ACTION_IN_16
, 
SAI_READ_CAPACITY_16
,

2382 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

2385 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_¡¬t_¡Ý_un™
 = {

2386 .
od_Ýcode
 = 
START_STOP
,

2387 .
	god_suµÜt
 = 3,

2388 .
	god_cdb_size
 = 6,

2389 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2390 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_SMALL_TIMEOUT
/
HZ
,

2391 .
	god_cdb_u§ge_b™s
 = { 
START_STOP
, 1, 0, 0xF, 0xF7, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

2394 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_sync_ÿche10
 = {

2395 .
od_Ýcode
 = 
SYNCHRONIZE_CACHE
,

2396 .
	god_suµÜt
 = 3,

2397 .
	god_cdb_size
 = 10,

2398 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2399 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_REG_TIMEOUT
/
HZ
,

2400 .
	god_cdb_u§ge_b™s
 = { 
SYNCHRONIZE_CACHE
, 2,

2401 0xFF, 0xFF, 0xFF, 0xFF, 
VDEF_DEF_GROUP_NUM
,

2402 0xFF, 0xFF, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

2405 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_sync_ÿche16
 = {

2406 .
od_Ýcode
 = 
SYNCHRONIZE_CACHE_16
,

2407 .
	god_suµÜt
 = 3,

2408 .
	god_cdb_size
 = 16,

2409 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2410 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_REG_TIMEOUT
/
HZ
,

2411 .
	god_cdb_u§ge_b™s
 = { 
SYNCHRONIZE_CACHE_16
, 2,

2413 0xFF, 0xFF, 0xFF, 0xFF, 
VDEF_DEF_GROUP_NUM
,

2414 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

2417 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_unm­
 = {

2418 .
od_Ýcode
 = 
UNMAP
,

2419 .
	god_suµÜt
 = 3,

2420 .
	god_cdb_size
 = 10,

2421 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2422 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_REG_TIMEOUT
/
HZ
,

2423 .
	god_cdb_u§ge_b™s
 = { 
UNMAP
, 0, 0, 0, 0, 0, 
VDEF_DEF_GROUP_NUM
,

2424 0xFF, 0xFF, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

2427 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_v”ify10
 = {

2428 .
od_Ýcode
 = 
VERIFY
,

2429 .
	god_suµÜt
 = 3,

2430 .
	god_cdb_size
 = 10,

2431 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2432 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_REG_TIMEOUT
/
HZ
,

2433 .
	god_cdb_u§ge_b™s
 = { 
VERIFY
, 
VDEV_DEF_VRPROTECT
 | 0x16,

2434 0xFF, 0xFF, 0xFF, 0xFF, 
VDEF_DEF_GROUP_NUM
,

2435 0xFF, 0xFF, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

2438 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_v”ify12
 = {

2439 .
od_Ýcode
 = 
VERIFY_12
,

2440 .
	god_suµÜt
 = 3,

2441 .
	god_cdb_size
 = 12,

2442 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2443 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_REG_TIMEOUT
/
HZ
,

2444 .
	god_cdb_u§ge_b™s
 = { 
VERIFY_12
, 
VDEV_DEF_VRPROTECT
 | 0x16,

2446 
VDEF_DEF_GROUP_NUM
, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

2449 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_v”ify16
 = {

2450 .
od_Ýcode
 = 
VERIFY_16
,

2451 .
	god_suµÜt
 = 3,

2452 .
	god_cdb_size
 = 16,

2453 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2454 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_REG_TIMEOUT
/
HZ
,

2455 .
	god_cdb_u§ge_b™s
 = { 
VERIFY_16
, 
VDEV_DEF_VRPROTECT
 | 0x16,

2457 0xFF, 0xFF, 0xFF, 0xFF, 
VDEF_DEF_GROUP_NUM
,

2458 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

2461 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_v”ify32
 = {

2462 .
od_Ýcode
 = 
VARIABLE_LENGTH_CMD
,

2463 .
	god_£rv_aùiÚ
 = 
SUBCODE_VERIFY_32
,

2464 .
	god_£rv_aùiÚ_v®id
 = 1,

2465 .
	god_suµÜt
 = 3,

2466 .
	god_cdb_size
 = 32,

2467 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2468 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_REG_TIMEOUT
/
HZ
,

2469 .
	god_cdb_u§ge_b™s
 = { 
VARIABLE_LENGTH_CMD
, 
SCST_OD_DEFAULT_CONTROL_BYTE
,

2470 0, 0, 0, 0, 
VDEF_DEF_GROUP_NUM
, 0x18, 0,

2471 
SUBCODE_VERIFY_32
, 
VDEV_DEF_VRPROTECT
 | 0x16, 0,

2477 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_wr™e6
 = {

2478 .
od_Ýcode
 = 
WRITE_6
,

2479 .
	god_suµÜt
 = 3,

2480 .
	god_cdb_size
 = 6,

2481 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2482 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_REG_TIMEOUT
/
HZ
,

2483 .
	god_cdb_u§ge_b™s
 = { 
WRITE_6
, 0x1F,

2484 0xFF, 0xFF, 0xFF, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

2487 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_wr™e10
 = {

2488 .
od_Ýcode
 = 
WRITE_10
,

2489 .
	god_suµÜt
 = 3,

2490 .
	god_cdb_size
 = 10,

2491 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2492 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_REG_TIMEOUT
/
HZ
,

2493 .
	god_cdb_u§ge_b™s
 = { 
WRITE_10
, 
VDEV_DEF_WRPROTECT
 | 0x1A,

2494 0xFF, 0xFF, 0xFF, 0xFF, 
VDEF_DEF_GROUP_NUM
,

2495 0xFF, 0xFF, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

2498 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_wr™e12
 = {

2499 .
od_Ýcode
 = 
WRITE_12
,

2500 .
	god_suµÜt
 = 3,

2501 .
	god_cdb_size
 = 12,

2502 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2503 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_REG_TIMEOUT
/
HZ
,

2504 .
	god_cdb_u§ge_b™s
 = { 
WRITE_12
, 
VDEV_DEF_WRPROTECT
 | 0x1A,

2506 
VDEF_DEF_GROUP_NUM
, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

2509 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_wr™e16
 = {

2510 .
od_Ýcode
 = 
WRITE_16
,

2511 .
	god_suµÜt
 = 3,

2512 .
	god_cdb_size
 = 16,

2513 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2514 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_REG_TIMEOUT
/
HZ
,

2515 .
	god_cdb_u§ge_b™s
 = { 
WRITE_16
, 
VDEV_DEF_WRPROTECT
 | 0x1A,

2517 0xFF, 0xFF, 0xFF, 0xFF, 
VDEF_DEF_GROUP_NUM
,

2518 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

2521 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_wr™e32
 = {

2522 .
od_Ýcode
 = 
VARIABLE_LENGTH_CMD
,

2523 .
	god_£rv_aùiÚ
 = 
SUBCODE_WRITE_32
,

2524 .
	god_£rv_aùiÚ_v®id
 = 1,

2525 .
	god_suµÜt
 = 3,

2526 .
	god_cdb_size
 = 32,

2527 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2528 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_REG_TIMEOUT
/
HZ
,

2529 .
	god_cdb_u§ge_b™s
 = { 
VARIABLE_LENGTH_CMD
, 
SCST_OD_DEFAULT_CONTROL_BYTE
,

2530 0, 0, 0, 0, 
VDEF_DEF_GROUP_NUM
, 0x18, 0,

2531 
SUBCODE_WRITE_32
, 
VDEV_DEF_WRPROTECT
 | 0x1A, 0,

2537 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_wr™e_v”ify10
 = {

2538 .
od_Ýcode
 = 
WRITE_VERIFY
,

2539 .
	god_suµÜt
 = 3,

2540 .
	god_cdb_size
 = 10,

2541 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2542 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_REG_TIMEOUT
/
HZ
,

2543 .
	god_cdb_u§ge_b™s
 = { 
WRITE_VERIFY
, 
VDEV_DEF_WRPROTECT
 | 0x16,

2544 0xFF, 0xFF, 0xFF, 0xFF, 
VDEF_DEF_GROUP_NUM
,

2545 0xFF, 0xFF, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

2548 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_wr™e_v”ify12
 = {

2549 .
od_Ýcode
 = 
WRITE_VERIFY_12
,

2550 .
	god_suµÜt
 = 3,

2551 .
	god_cdb_size
 = 12,

2552 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2553 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_REG_TIMEOUT
/
HZ
,

2554 .
	god_cdb_u§ge_b™s
 = { 
WRITE_VERIFY_12
, 
VDEV_DEF_WRPROTECT
 | 0x16,

2556 
VDEF_DEF_GROUP_NUM
, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

2559 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_wr™e_v”ify16
 = {

2560 .
od_Ýcode
 = 
WRITE_VERIFY_16
,

2561 .
	god_suµÜt
 = 3,

2562 .
	god_cdb_size
 = 16,

2563 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2564 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_REG_TIMEOUT
/
HZ
,

2565 .
	god_cdb_u§ge_b™s
 = { 
WRITE_VERIFY_16
, 
VDEV_DEF_WRPROTECT
 | 0x16,

2567 0xFF, 0xFF, 0xFF, 0xFF, 
VDEF_DEF_GROUP_NUM
,

2568 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

2571 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_wr™e_v”ify32
 = {

2572 .
od_Ýcode
 = 
VARIABLE_LENGTH_CMD
,

2573 .
	god_£rv_aùiÚ
 = 
SUBCODE_WRITE_VERIFY_32
,

2574 .
	god_£rv_aùiÚ_v®id
 = 1,

2575 .
	god_suµÜt
 = 3,

2576 .
	god_cdb_size
 = 32,

2577 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2578 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_REG_TIMEOUT
/
HZ
,

2579 .
	god_cdb_u§ge_b™s
 = { 
VARIABLE_LENGTH_CMD
, 
SCST_OD_DEFAULT_CONTROL_BYTE
,

2580 0, 0, 0, 0, 
VDEF_DEF_GROUP_NUM
, 0x18, 0,

2581 
SUBCODE_WRITE_VERIFY_32
, 
VDEV_DEF_WRPROTECT
 | 0x16, 0,

2587 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_wr™e_§me10
 = {

2588 .
od_Ýcode
 = 
WRITE_SAME
,

2589 .
	god_suµÜt
 = 3,

2590 .
	god_cdb_size
 = 10,

2591 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2592 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_REG_TIMEOUT
/
HZ
,

2593 .
	god_cdb_u§ge_b™s
 = { 
WRITE_SAME
, 
VDEV_DEF_WRPROTECT
 | 0x8,

2594 0xFF, 0xFF, 0xFF, 0xFF, 
VDEF_DEF_GROUP_NUM
,

2595 0xFF, 0xFF, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

2598 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_wr™e_§me16
 = {

2599 .
od_Ýcode
 = 
WRITE_SAME_16
,

2600 .
	god_suµÜt
 = 3,

2601 .
	god_cdb_size
 = 16,

2602 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2603 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_REG_TIMEOUT
/
HZ
,

2604 .
	god_cdb_u§ge_b™s
 = { 
WRITE_SAME_16
, 
VDEV_DEF_WRPROTECT
 | 0x8,

2606 0xFF, 0xFF, 0xFF, 0xFF, 
VDEF_DEF_GROUP_NUM
,

2607 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

2610 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_wr™e_§me32
 = {

2611 .
od_Ýcode
 = 
VARIABLE_LENGTH_CMD
,

2612 .
	god_£rv_aùiÚ
 = 
SUBCODE_WRITE_SAME_32
,

2613 .
	god_£rv_aùiÚ_v®id
 = 1,

2614 .
	god_suµÜt
 = 3,

2615 .
	god_cdb_size
 = 32,

2616 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2617 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_REG_TIMEOUT
/
HZ
,

2618 .
	god_cdb_u§ge_b™s
 = { 
VARIABLE_LENGTH_CMD
, 
SCST_OD_DEFAULT_CONTROL_BYTE
,

2619 0, 0, 0, 0, 
VDEF_DEF_GROUP_NUM
, 0x18, 0,

2620 
SUBCODE_WRITE_SAME_32
, 
VDEV_DEF_WRPROTECT
 | 0x8, 0,

2626 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_»ad_toc
 = {

2627 .
od_Ýcode
 = 
READ_TOC
,

2628 .
	god_suµÜt
 = 3,

2629 .
	god_cdb_size
 = 10,

2630 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

2631 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_REG_TIMEOUT
/
HZ
,

2632 .
	god_cdb_u§ge_b™s
 = { 
READ_TOC
, 0, 0xF, 0, 0, 0, 0xFF,

2633 0xFF, 0xFF, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

2636 
	#SHARED_OPS
 \

2637 [
SYNCHRONIZE_CACHE
] = 
vdisk_synchrÚize_ÿche
, \

2638 [
SYNCHRONIZE_CACHE_16
] = 
vdisk_synchrÚize_ÿche
, \

2639 [
MODE_SENSE
] = 
vdisk_exec_mode_£n£
, \

2640 [
MODE_SENSE_10
] = 
vdisk_exec_mode_£n£
, \

2641 [
MODE_SELECT
] = 
vdisk_exec_mode_£Ëù
, \

2642 [
MODE_SELECT_10
] = 
vdisk_exec_mode_£Ëù
, \

2643 [
LOG_SELECT
] = 
vdisk_exec_log
, \

2644 [
LOG_SENSE
] = 
vdisk_exec_log
, \

2645 [
ALLOW_MEDIUM_REMOVAL
] = 
vdisk_exec_´ev’t_®low_medium_»mov®
, \

2646 [
READ_TOC
] = 
vdisk_exec_»ad_toc
, \

2647 [
START_STOP
] = 
vdisk_exec_¡¬t_¡Ý
, \

2648 [
RESERVE
] = 
vdisk_nÝ
, \

2649 [
RESERVE_10
] = 
vdisk_nÝ
, \

2650 [
RELEASE
] = 
vdisk_nÝ
, \

2651 [
RELEASE_10
] = 
vdisk_nÝ
, \

2652 [
TEST_UNIT_READY
] = 
vdisk_nÝ
, \

2653 [
INQUIRY
] = 
vdisk_exec_šquœy
, \

2654 [
REQUEST_SENSE
] = 
vdisk_exec_»que¡_£n£
, \

2655 [
READ_CAPACITY
] = 
vdisk_exec_»ad_ÿ·c™y
, \

2656 [
SERVICE_ACTION_IN_16
] = 
vdisk_exec_§i_16
, \

2657 [
UNMAP
] = 
vdisk_exec_unm­
, \

2658 [
WRITE_SAME
] = 
vdisk_exec_wr™e_§me
, \

2659 [
WRITE_SAME_16
] = 
vdisk_exec_wr™e_§me
, \

2660 [
MAINTENANCE_IN
] = 
vdisk_exec_maš‹Çnû_š
, \

2661 [
MAINTENANCE_OUT
] = 
vdisk_exec_maš‹Çnû_out
, \

2662 [
SEND_DIAGNOSTIC
] = 
vdisk_exec_£nd_dŸgno¡ic
, \

2663 [
FORMAT_UNIT
] = 
vdisk_exec_fÜm©_un™
,

	)

2665 
	#SHARED_OPCODE_DESCRIPTORS
 \

2666 &
sc¡_Ý_desü_sync_ÿche10
, \

2667 &
sc¡_Ý_desü_sync_ÿche16
, \

2668 &
sc¡_Ý_desü_mode_£n£6
, \

2669 &
sc¡_Ý_desü_mode_£n£10
, \

2670 &
sc¡_Ý_desü_mode_£Ëù6
, \

2671 &
sc¡_Ý_desü_mode_£Ëù10
, \

2672 &
sc¡_Ý_desü_log_£Ëù
, \

2673 &
sc¡_Ý_desü_log_£n£
, \

2674 &
sc¡_Ý_desü_¡¬t_¡Ý_un™
, \

2675 &
sc¡_Ý_desü_»ad_ÿ·c™y
, \

2676 &
sc¡_Ý_desü_£nd_dŸgno¡ic
, \

2677 &
sc¡_Ý_desü_¹pg
, \

2678 &
sc¡_Ý_desü_»ad6
, \

2679 &
sc¡_Ý_desü_»ad10
, \

2680 &
sc¡_Ý_desü_»ad12
, \

2681 &
sc¡_Ý_desü_»ad16
, \

2682 &
sc¡_Ý_desü_wr™e6
, \

2683 &
sc¡_Ý_desü_wr™e10
, \

2684 &
sc¡_Ý_desü_wr™e12
, \

2685 &
sc¡_Ý_desü_wr™e16
, \

2686 &
sc¡_Ý_desü_wr™e_v”ify10
, \

2687 &
sc¡_Ý_desü_wr™e_v”ify12
, \

2688 &
sc¡_Ý_desü_wr™e_v”ify16
, \

2689 &
sc¡_Ý_desü_v”ify10
, \

2690 &
sc¡_Ý_desü_v”ify12
, \

2691 &
sc¡_Ý_desü_v”ify16
,

	)

2693 cÚ¡ 
vdisk_Ý_â
 
	gblockio_v¬_Ën_Ýs
[] = {

2694 [
SUBCODE_READ_32
] = 
blockio_exec_»ad
,

2695 [
SUBCODE_WRITE_32
] = 
blockio_exec_wr™e
,

2696 [
SUBCODE_WRITE_VERIFY_32
] = 
blockio_exec_wr™e_v”ify
,

2697 [
SUBCODE_VERIFY_32
] = 
vdev_exec_v”ify
,

2698 [
SUBCODE_WRITE_SAME_32
] = 
vdisk_exec_wr™e_§me
,

2701 
vdisk_Ý_â
 
	gblockio_Ýs
[256] = {

2702 [
READ_6
] = 
blockio_exec_»ad
,

2703 [
READ_10
] = 
blockio_exec_»ad
,

2704 [
READ_12
] = 
blockio_exec_»ad
,

2705 [
READ_16
] = 
blockio_exec_»ad
,

2706 [
WRITE_6
] = 
blockio_exec_wr™e
,

2707 [
WRITE_10
] = 
blockio_exec_wr™e
,

2708 [
WRITE_12
] = 
blockio_exec_wr™e
,

2709 [
WRITE_16
] = 
blockio_exec_wr™e
,

2710 [
WRITE_VERIFY
] = 
blockio_exec_wr™e_v”ify
,

2711 [
WRITE_VERIFY_12
] = 
blockio_exec_wr™e_v”ify
,

2712 [
WRITE_VERIFY_16
] = 
blockio_exec_wr™e_v”ify
,

2713 [
VARIABLE_LENGTH_CMD
] = 
blockio_exec_v¬_Ën_cmd
,

2714 [
VERIFY
] = 
vdev_exec_v”ify
,

2715 [
VERIFY_12
] = 
vdev_exec_v”ify
,

2716 [
VERIFY_16
] = 
vdev_exec_v”ify
,

2717 
	gSHARED_OPS


2720 cÚ¡ 
vdisk_Ý_â
 
	gfžeio_v¬_Ën_Ýs
[] = {

2721 [
SUBCODE_READ_32
] = 
fžeio_exec_»ad
,

2722 [
SUBCODE_WRITE_32
] = 
fžeio_exec_wr™e
,

2723 [
SUBCODE_WRITE_VERIFY_32
] = 
fžeio_exec_wr™e_v”ify
,

2724 [
SUBCODE_VERIFY_32
] = 
vdev_exec_v”ify
,

2725 [
SUBCODE_WRITE_SAME_32
] = 
vdisk_exec_wr™e_§me
,

2728 
vdisk_Ý_â
 
	gfžeio_Ýs
[256] = {

2729 [
READ_6
] = 
fžeio_exec_»ad
,

2730 [
READ_10
] = 
fžeio_exec_»ad
,

2731 [
READ_12
] = 
fžeio_exec_»ad
,

2732 [
READ_16
] = 
fžeio_exec_»ad
,

2733 [
WRITE_6
] = 
fžeio_exec_wr™e
,

2734 [
WRITE_10
] = 
fžeio_exec_wr™e
,

2735 [
WRITE_12
] = 
fžeio_exec_wr™e
,

2736 [
WRITE_16
] = 
fžeio_exec_wr™e
,

2737 [
WRITE_VERIFY
] = 
fžeio_exec_wr™e_v”ify
,

2738 [
WRITE_VERIFY_12
] = 
fžeio_exec_wr™e_v”ify
,

2739 [
WRITE_VERIFY_16
] = 
fžeio_exec_wr™e_v”ify
,

2740 [
VARIABLE_LENGTH_CMD
] = 
fžeio_exec_v¬_Ën_cmd
,

2741 [
VERIFY
] = 
vdev_exec_v”ify
,

2742 [
VERIFY_12
] = 
vdev_exec_v”ify
,

2743 [
VERIFY_16
] = 
vdev_exec_v”ify
,

2744 
	gSHARED_OPS


2747 cÚ¡ 
vdisk_Ý_â
 
	gnuÎio_v¬_Ën_Ýs
[] = {

2748 [
SUBCODE_READ_32
] = 
nuÎio_exec_»ad
,

2749 [
SUBCODE_WRITE_32
] = 
nuÎio_exec_wr™e
,

2750 [
SUBCODE_WRITE_VERIFY_32
] = 
nuÎio_exec_wr™e_v”ify
,

2751 [
SUBCODE_WRITE_SAME_32
] = 
vdisk_exec_wr™e_§me
,

2754 
vdisk_Ý_â
 
	gnuÎio_Ýs
[256] = {

2755 [
READ_6
] = 
nuÎio_exec_»ad
,

2756 [
READ_10
] = 
nuÎio_exec_»ad
,

2757 [
READ_12
] = 
nuÎio_exec_»ad
,

2758 [
READ_16
] = 
nuÎio_exec_»ad
,

2759 [
WRITE_6
] = 
nuÎio_exec_wr™e
,

2760 [
WRITE_10
] = 
nuÎio_exec_wr™e
,

2761 [
WRITE_12
] = 
nuÎio_exec_wr™e
,

2762 [
WRITE_16
] = 
nuÎio_exec_wr™e
,

2763 [
WRITE_VERIFY
] = 
nuÎio_exec_wr™e_v”ify
,

2764 [
WRITE_VERIFY_12
] = 
nuÎio_exec_wr™e_v”ify
,

2765 [
WRITE_VERIFY_16
] = 
nuÎio_exec_wr™e_v”ify
,

2766 [
VARIABLE_LENGTH_CMD
] = 
nuÎio_exec_v¬_Ën_cmd
,

2767 [
VERIFY
] = 
nuÎio_exec_v”ify
,

2768 [
VERIFY_12
] = 
nuÎio_exec_v”ify
,

2769 [
VERIFY_16
] = 
nuÎio_exec_v”ify
,

2770 
	gSHARED_OPS


2773 
	#VDISK_OPCODE_DESCRIPTORS
 \

2775 &
sc¡_Ý_desü_»ad_ÿ·c™y16
, \

2776 &
sc¡_Ý_desü_wr™e_§me10
, \

2777 &
sc¡_Ý_desü_wr™e_§me16
, \

2778 &
sc¡_Ý_desü_unm­
, \

2779 &
sc¡_Ý_desü_fÜm©_un™
, \

2780 &
sc¡_Ý_desü_ex‹nded_cÝy
, \

2781 &
sc¡_Ý_desü_cwr
,

	)

2783 cÚ¡ 
sc¡_Ýcode_desütÜ
 *
	gvdisk_Ýcode_desütÜs
[] = {

2784 
SHARED_OPCODE_DESCRIPTORS


2785 
VDISK_OPCODE_DESCRIPTORS


2786 
SCST_OPCODE_DESCRIPTORS


2787 &
sc¡_Ý_desü_¡pg
,

2790 cÚ¡ 
sc¡_Ýcode_desütÜ
 *
	gvdisk_Ýcode_desütÜs_ty³2
[] = {

2791 
SHARED_OPCODE_DESCRIPTORS


2792 
VDISK_OPCODE_DESCRIPTORS


2793 &
sc¡_Ý_desü_»ad32
,

2794 &
sc¡_Ý_desü_wr™e32
,

2795 &
sc¡_Ý_desü_v”ify32
,

2796 &
sc¡_Ý_desü_wr™e_v”ify32
,

2797 &
sc¡_Ý_desü_wr™e_§me32
,

2798 
SCST_OPCODE_DESCRIPTORS


2799 &
sc¡_Ý_desü_¡pg
,

2802 cÚ¡ 
sc¡_Ýcode_desütÜ
 *
	gvcdrom_Ýcode_desütÜs
[] = {

2803 
SHARED_OPCODE_DESCRIPTORS


2804 &
sc¡_Ý_desü_®low_medium_»mov®
,

2805 &
sc¡_Ý_desü_»ad_toc
,

2806 
SCST_OPCODE_DESCRIPTORS


2809 
	$vdisk_g‘_suµÜ‹d_Ýcodes
(
sc¡_cmd
 *
cmd
,

2810 cÚ¡ 
sc¡_Ýcode_desütÜ
 ***
out_suµ_Ýcodes
,

2811 *
out_suµ_Ýcodes_út
)

2813 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

2814 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

2816 ià(
cmd
->
dev
->
dev_dif_ty³
 != 2) {

2817 *
out_suµ_Ýcodes
 = 
vdisk_Ýcode_desütÜs
;

2818 *
out_suµ_Ýcodes_út
 = 
	`ARRAY_SIZE
(
vdisk_Ýcode_desütÜs
);

2820 *
out_suµ_Ýcodes
 = 
vdisk_Ýcode_desütÜs_ty³2
;

2821 *
out_suµ_Ýcodes_út
 = 
	`ARRAY_SIZE
(
vdisk_Ýcode_desütÜs_ty³2
);

2823 ià(!
vœt_dev
->
ex¶_®ua
) {

2824 (*
out_suµ_Ýcodes_út
)--;

2825 
	`sBUG_ON
((*
out_suµ_Ýcodes
)[*
out_suµ_Ýcodes_út
]->
od_£rv_aùiÚ
 !ð
MO_SET_TARGET_PGS
);

2828 
	}
}

2830 
	$vcdrom_g‘_suµÜ‹d_Ýcodes
(
sc¡_cmd
 *
cmd
,

2831 cÚ¡ 
sc¡_Ýcode_desütÜ
 ***
out_suµ_Ýcodes
,

2832 *
out_suµ_Ýcodes_út
)

2834 *
out_suµ_Ýcodes
 = 
vcdrom_Ýcode_desütÜs
;

2835 *
out_suµ_Ýcodes_út
 = 
	`ARRAY_SIZE
(
vcdrom_Ýcode_desütÜs
);

2837 
	}
}

2839 
boÞ
 
	$vdisk_u£_z”o_cÝy
(cÚ¡ 
sc¡_cmd
 *
cmd
)

2841 
sc¡_vdisk_dev
 *
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

2843 ià(!
vœt_dev
->
z”o_cÝy
)

2844  
çl£
;

2846 
cmd
->
cdb
[0]) {

2847 
VARIABLE_LENGTH_CMD
:

2848 ià(
cmd
->
cdb
[9] !ð
SUBCODE_READ_32
)

2851 
READ_6
:

2852 
READ_10
:

2853 
READ_12
:

2854 
READ_16
:

2855  
Œue
;

2858  
çl£
;

2859 
	}
}

2865 
boÞ
 
	$vdisk_·r£_off£t
(
vdisk_cmd_·¿ms
 *
p
, 
sc¡_cmd
 *
cmd
)

2867 
ušt64_t
 
lba_¡¬t
;

2868 
št64_t
 
d©a_Ën
;

2869 
ušt8_t
 *
cdb
 = 
cmd
->cdb;

2870 
Ýcode
 = 
cdb
[0];

2871 
loff_t
 
loff
;

2872 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

2873 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

2874 
boÞ
 
»s
;

2875 
fua
 = 0;

2877 
	`TRACE_ENTRY
();

2879 ià(
	`uÆik–y
(!(
cmd
->
Ý_æags
 & 
SCST_INFO_VALID
))) {

2880 
	`TRACE
(
TRACE_MINOR
, "UnknowÀÝcod%s", 
	`sc¡_g‘_Ýcode_Çme
(
cmd
));

2881 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

2882 
»s
 = 
çl£
;

2883 
out
;

2886 
p
->
cmd
 = cmd;

2888 
cmd
->
¡©us
 = 0;

2889 
cmd
->
msg_¡©us
 = 0;

2890 
cmd
->
ho¡_¡©us
 = 
DID_OK
;

2891 
cmd
->
driv”_¡©us
 = 0;

2893 
cmd
->
queue_ty³
) {

2894 
SCST_CMD_QUEUE_ORDERED
:

2895 
	`TRACE
(
TRACE_ORDER
, "ORDERED cmd %°(Ý %s)", 
cmd
,

2896 
	`sc¡_g‘_Ýcode_Çme
(
cmd
));

2898 
SCST_CMD_QUEUE_HEAD_OF_QUEUE
:

2899 
	`TRACE
(
TRACE_ORDER
, "HQ cmd %°(Ý %s)", 
cmd
,

2900 
	`sc¡_g‘_Ýcode_Çme
(
cmd
));

2906 
lba_¡¬t
 = 
	`sc¡_cmd_g‘_lba
(
cmd
);

2907 
d©a_Ën
 = 
	`sc¡_cmd_g‘_d©a_Ën
(
cmd
);

2909 
loff
 = (
loff_t
)
lba_¡¬t
 << 
dev
->
block_shiá
;

2910 
	`TRACE_DBG
("cmd %p,†ba_¡¬ˆ%Îd,†ofà%Îd, d©a_ËÀ%Îd", 
cmd
,

2911 ()
lba_¡¬t
,

2912 ()
loff
,

2913 ()
d©a_Ën
);

2915 
	`EXTRACHECKS_BUG_ON
((
loff
 < 0è|| 
	`uÆik–y
(
d©a_Ën
 < 0));

2917 ià(
	`uÆik–y
((
loff
 + 
d©a_Ën
è> 
vœt_dev
->
fže_size
) &&

2918 (!(
cmd
->
Ý_æags
 & 
SCST_LBA_NOT_VALID
))) {

2919 ià(
vœt_dev
->
cdrom_em±y
) {

2920 
	`TRACE_DBG
("%s", "CDROMƒmpty");

2921 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_no_medium
));

2923 
	`PRINT_INFO
("Access beyondheƒnd of device %s "

2924 "(%Îd oà%Îd, d©¨ËÀ%Îd)", 
vœt_dev
->
Çme
,

2925 ()
loff
,

2926 ()
vœt_dev
->
fže_size
,

2927 ()
d©a_Ën
);

2928 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(

2929 
sc¡_£n£_block_out_¿nge_”rÜ
));

2931 
»s
 = 
çl£
;

2932 
out
;

2935 
Ýcode
) {

2936 
VARIABLE_LENGTH_CMD
:

2937 ià(
cmd
->
cdb
[9] =ð
SUBCODE_WRITE_32
) {

2938 
fua
 = (
cdb
[10] & 0x8);

2939 ià(
fua
)

2940 
	`TRACE
(
TRACE_ORDER
, "FUA:†off=%lld, data_len=%lld",

2941 ()
loff
,

2942 ()
d©a_Ën
);

2945 
WRITE_10
:

2946 
WRITE_12
:

2947 
WRITE_16
:

2948 
fua
 = (
cdb
[1] & 0x8);

2949 ià(
fua
) {

2950 
	`TRACE
(
TRACE_ORDER
, "FUA:†off=%lld, "

2951 "d©a_Ën=%Îd", ()
loff
,

2952 ()
d©a_Ën
);

2957 
p
->
loff
 =†off;

2958 
p
->
fua
 = fua;

2959 
p
->
u£_z”o_cÝy
 = 
	`vdisk_u£_z”o_cÝy
(
cmd
);

2961 
»s
 = 
Œue
;

2963 
out
:

2964 
	`TRACE_EXIT_RES
(
»s
);

2965  
»s
;

2966 
	}
}

2968 
	$fžeio_®loc_ªd_·r£
(
sc¡_cmd
 *
cmd
)

2970 
vdisk_cmd_·¿ms
 *
p
;

2971 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

2973 
	`TRACE_ENTRY
();

2975 
p
 = 
	`kmem_ÿche_z®loc
(
vdisk_cmd_·¿m_ÿch•
, 
cmd
->
cmd_gå_mask
);

2976 ià(!
p
) {

2977 
	`sc¡_£t_busy
(
cmd
);

2978 
out_”r
;

2981 ià(
	`uÆik–y
(!
	`vdisk_·r£_off£t
(
p
, 
cmd
)))

2982 
out_”r_ä“_cmd_·¿ms
;

2984 
cmd
->
dh_´iv
 = 
p
;

2986 
out
:

2987 
	`TRACE_EXIT_RES
(
»s
);

2988  
»s
;

2990 
out_”r_ä“_cmd_·¿ms
:

2991 
	`kmem_ÿche_ä“
(
vdisk_cmd_·¿m_ÿch•
, 
p
);

2993 
out_”r
:

2994 
»s
 = 
	`sc¡_g‘_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

2995 
out
;

2996 
	}
}

2998 
	$vdisk_·r£
(
sc¡_cmd
 *
cmd
)

3000 
»s
, 
rc
;

3002 
rc
 = 
	`sc¡_sbc_g’”ic_·r£
(
cmd
);

3003 ià(
rc
 != 0) {

3004 
»s
 = 
	`sc¡_g‘_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

3005 
out
;

3008 
»s
 = 
	`fžeio_®loc_ªd_·r£
(
cmd
);

3009 
out
:

3010  
»s
;

3011 
	}
}

3013 
	$vcdrom_·r£
(
sc¡_cmd
 *
cmd
)

3015 
»s
, 
rc
;

3017 
rc
 = 
	`sc¡_cdrom_g’”ic_·r£
(
cmd
);

3018 ià(
rc
 != 0) {

3019 
»s
 = 
	`sc¡_g‘_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

3020 
out
;

3023 
»s
 = 
	`fžeio_®loc_ªd_·r£
(
cmd
);

3024 
out
:

3025  
»s
;

3026 
	}
}

3029 
	$nÚ_fžeio_·r£
(
sc¡_cmd
 *
cmd
)

3031 
»s
 = 
SCST_CMD_STATE_DEFAULT
, 
rc
;

3033 
rc
 = 
	`sc¡_sbc_g’”ic_·r£
(
cmd
);

3034 ià(
rc
 != 0) {

3035 
»s
 = 
	`sc¡_g‘_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

3036 
out
;

3038 
out
:

3039  
»s
;

3040 
	}
}

3042 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 30)

3046 
	$fšish_»ad
(
sÿ‰”li¡
 *
sg
, 
sg_út
)

3048 
·ge
 *page;

3049 
i
;

3051 
	`TRACE_ENTRY
();

3053 
i
 = 0; i < 
sg_út
; ++i) {

3054 
·ge
 = 
	`sg_·ge
(&
sg
[
i
]);

3055 
	`EXTRACHECKS_BUG_ON
(!
·ge
);

3056 
	`·ge_ÿche_»Ëa£
(
·ge
);

3059 
	`TRACE_EXIT
();

3061 
	}
}

3079 
	$´•¬e_»ad_·ge
(
fže
 *
fžp
, 
Ën
,

3080 
loff_t
 
off£t
,†off_ˆ
Ï¡
, 
·ge
 **
·g•Œ
)

3082 
add»ss_¥aû
 *
m­pšg
 = 
fžp
->
f_m­pšg
;

3083 
šode
 *šodð
m­pšg
->
ho¡
;

3084 
fže_¿_¡©e
 *
¿
 = &
fžp
->
f_¿
;

3085 
·ge
 *page;

3086 
šdex
, 
Ï¡_šdex
;

3087 
’d_šdex
, 
Ä
;

3088 
loff_t
 
isize
;

3089 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3, 15, 0)

3090 
»ad_desütÜ_t
 
desc
 = { .
couÁ
 = 
Ën
 };

3092 
”rÜ
;

3094 
	`TRACE_ENTRY
();

3096 
	`WARN
((
off£t
 & ~
PAGE_CACHE_MASK
è+ 
Ën
 > 
PAGE_CACHE_SIZE
,

3097 "off£ˆð%Îd + %Îd,†’ = %d\n", 
off£t
 & 
PAGE_CACHE_MASK
,

3098 
off£t
 & ~
PAGE_CACHE_MASK
, 
Ën
);

3099 
	`sBUG_ON
(!
m­pšg
->
a_Ýs
);

3101 
šdex
 = 
off£t
 >> 
PAGE_CACHE_SHIFT
;

3102 
Ï¡_šdex
 = (
Ï¡
 + 
PAGE_CACHE_SIZE
 - 1è>> 
PAGE_CACHE_SHIFT
;

3104 
fšd_·ge
:

3105 
·ge
 = 
	`fšd_g‘_·ge
(
m­pšg
, 
šdex
);

3106 ià(!
·ge
) {

3107 
	`·ge_ÿche_sync_»adah—d
(
m­pšg
, 
¿
, 
fžp
, 
šdex
,

3108 
Ï¡_šdex
 - 
šdex
);

3109 
·ge
 = 
	`fšd_g‘_·ge
(
m­pšg
, 
šdex
);

3110 ià(
	`uÆik–y
(!
·ge
)) {

3114 
·ge
 = 
	`·ge_ÿche_®loc_cÞd
(
m­pšg
);

3115 ià(!
·ge
) {

3116 
”rÜ
 = -
ENOMEM
;

3117 
”r
;

3119 
”rÜ
 = 
	`add_to_·ge_ÿche_Ìu
(
·ge
, 
m­pšg
, 
šdex
,

3120 
GFP_KERNEL
);

3121 ià(
”rÜ
) {

3122 
	`·ge_ÿche_»Ëa£
(
·ge
);

3123 ià(
”rÜ
 =ð-
EEXIST
)

3124 
fšd_·ge
;

3126 
”r
;

3128 
»ad·ge
;

3132 ià(
	`PageR—dah—d
(
·ge
))

3133 
	`·ge_ÿche_async_»adah—d
(
m­pšg
, 
¿
, 
fžp
, 
·ge
,

3134 
šdex
, 
Ï¡_šdex
 - index);

3135 ià(!
	`PageU±od©e
(
·ge
)) {

3136 ià(
šode
->
i_blkb™s
 =ð
PAGE_CACHE_SHIFT
 ||

3137 !
m­pšg
->
a_Ýs
->
is_·¹ŸÎy_u±od©e
)

3138 
·ge_nÙ_up_to_d©e
;

3139 ià(!
	`Œylock_·ge
(
·ge
))

3140 
·ge_nÙ_up_to_d©e
;

3142 ià(!
·ge
->
m­pšg
)

3143 
·ge_nÙ_up_to_d©e_locked
;

3144 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(3, 15, 0)

3145 ià(!
m­pšg
->
a_Ýs
->
	`is_·¹ŸÎy_u±od©e
(
·ge
,

3146 
off£t
 & ~
PAGE_CACHE_MASK
, 
Ën
))

3148 ià(!
m­pšg
->
a_Ýs
->
	`is_·¹ŸÎy_u±od©e
(
·ge
, &
desc
,

3149 
off£t
 & ~
PAGE_CACHE_MASK
))

3151 
·ge_nÙ_up_to_d©e_locked
;

3152 
	`uÆock_·ge
(
·ge
);

3154 
·ge_ok
:

3164 
isize
 = 
	`i_size_»ad
(
šode
);

3165 
’d_šdex
 = (
isize
 - 1è>> 
PAGE_CACHE_SHIFT
;

3166 ià(
	`uÆik–y
(
isize
 =ð0 || 
šdex
 > 
’d_šdex
)) {

3167 
	`·ge_ÿche_»Ëa£
(
·ge
);

3168 
eof
;

3172 ià(
šdex
 < 
’d_šdex
) {

3173 
Ä
 = 
PAGE_CACHE_SIZE
 - (
off£t
 & ~
PAGE_CACHE_MASK
);

3175 
Ä
 = ((
isize
 - 1è& ~
PAGE_CACHE_MASK
) + 1 -

3176 (
off£t
 & ~
PAGE_CACHE_MASK
);

3177 ià(
Ä
 <= 0) {

3178 
	`·ge_ÿche_»Ëa£
(
·ge
);

3179 
eof
;

3188 ià(
	`m­pšg_wr™ably_m­³d
(
m­pšg
))

3189 
	`æush_dÿche_·ge
(
·ge
);

3191 
	`m¬k_·ge_acûs£d
(
·ge
);

3194 *
·g•Œ
 = 
·ge
;

3195 
	`TRACE_EXIT_RES
(
Ä
);

3196  
Ä
;

3197 
eof
:

3198 
	`TRACE_EXIT
();

3200 
”r
:

3201 
	`TRACE_EXIT_RES
(
”rÜ
);

3202  
”rÜ
;

3204 
·ge_nÙ_up_to_d©e
:

3206 
”rÜ
 = 
	`lock_·ge_kžÏbË
(
·ge
);

3207 ià(
	`uÆik–y
(
”rÜ
 != 0)) {

3208 
	`·ge_ÿche_»Ëa£
(
·ge
);

3209 
”r
;

3212 
·ge_nÙ_up_to_d©e_locked
:

3214 ià(!
·ge
->
m­pšg
) {

3215 
	`uÆock_·ge
(
·ge
);

3216 
	`·ge_ÿche_»Ëa£
(
·ge
);

3217 
fšd_·ge
;

3221 ià(
	`PageU±od©e
(
·ge
)) {

3222 
	`uÆock_·ge
(
·ge
);

3223 
·ge_ok
;

3226 
»ad·ge
:

3232 
	`CË¬PageE¼Ü
(
·ge
);

3234 
”rÜ
 = 
m­pšg
->
a_Ýs
->
	`»ad·ge
(
fžp
, 
·ge
);

3235 ià(
	`uÆik–y
(
”rÜ
)) {

3236 ià(
”rÜ
 =ð
AOP_TRUNCATED_PAGE
) {

3237 
	`·ge_ÿche_»Ëa£
(
·ge
);

3238 
fšd_·ge
;

3240 
	`WARN
(
”rÜ
 >= 0, "error = %d\n",ƒrror);

3241 
	`·ge_ÿche_»Ëa£
(
·ge
);

3242 
”r
;

3245 ià(!
	`PageU±od©e
(
·ge
)) {

3246 
”rÜ
 = 
	`lock_·ge_kžÏbË
(
·ge
);

3247 ià(
	`uÆik–y
(
”rÜ
 != 0)) {

3248 
	`·ge_ÿche_»Ëa£
(
·ge
);

3249 
”r
;

3251 ià(!
	`PageU±od©e
(
·ge
)) {

3252 ià(
·ge
->
m­pšg
 =ð
NULL
) {

3256 
	`uÆock_·ge
(
·ge
);

3257 
	`·ge_ÿche_»Ëa£
(
·ge
);

3258 
fšd_·ge
;

3260 
	`uÆock_·ge
(
·ge
);

3261 
	`·ge_ÿche_»Ëa£
(
·ge
);

3262 
”rÜ
 = -
EIO
;

3263 
”r
;

3265 
	`uÆock_·ge
(
·ge
);

3268 
·ge_ok
;

3269 
	}
}

3278 
	$´•¬e_»ad
(
fže
 *
fžp
, 
sÿ‰”li¡
 *
sg
, 
sg_út
,

3279 
pgoff_t
 
off£t
)

3281 
·ge
 *·gð
NULL
;

3282 
i
, 
»s
;

3283 
loff_t
 
off
, 
Ï¡
 = ((
off£t
 + 
sg_út
 - 1è<< 
PAGE_SHIFT
) +

3284 
sg
[
sg_út
 - 1].
off£t
 + sg[sg_úˆ- 1].
Ëngth
;

3286 
	`TRACE_ENTRY
();

3288 
i
 = 0; i < 
sg_út
; ++i) {

3289 
off
 = (
off£t
 + 
i
è<< 
PAGE_SHIFT
 | 
sg
[i].offset;

3290 
»s
 = 
	`´•¬e_»ad_·ge
(
fžp
, 
sg
[
i
].
Ëngth
, 
off
, 
Ï¡
, &
·ge
);

3291 ià(
»s
 <= 0)

3292 
”r
;

3293 ià(
»s
 < 
sg
[
i
].
Ëngth
) {

3294 
	`·ge_ÿche_»Ëa£
(
·ge
);

3295 
”r
;

3297 
	`sg_assign_·ge
(&
sg
[
i
], 
·ge
);

3300 
	`fže_acûs£d
(
fžp
);

3302 
out
:

3303 
	`TRACE_EXIT_RES
(
i
);

3304  
i
;

3306 
”r
:

3307 
	`fšish_»ad
(
sg
, 
i
);

3308 
i
 = -
EIO
;

3309 
out
;

3310 
	}
}

3321 
sÿ‰”li¡
 *
	$®loc_sg
(
size_t
 
size
, 
off
, 
gå_t
 
gå_mask
,

3322 
sÿ‰”li¡
 *
sm®l_sg
,

3323 
sm®l_sg_size
, *
p_sg_út
)

3325 
sÿ‰”li¡
 *
sg
;

3326 
i
, 
sg_út
, 
»maššg_sz
, 
sg_sz
, 
sg_off
;

3328 
	`TRACE_ENTRY
();

3330 
sg_út
 = 
	`PAGE_ALIGN
(
size
 + 
off
è>> 
PAGE_SHIFT
;

3331 
sg
 = 
sg_út
 <ð
sm®l_sg_size
 ? 
sm®l_sg
 :

3332 
	`km®loc_¬¿y
(
sg_út
, (*
sg
), 
gå_mask
);

3333 ià(!
sg
)

3334 
out
;

3336 
	`sg_š™_bË
(
sg
, 
sg_út
);

3337 
»maššg_sz
 = 
size
;

3338 
sg_off
 = 
off
;

3339 
i
 = 0; i < 
sg_út
; ++i) {

3340 
sg_sz
 = 
	`mš_t
(, 
PAGE_SIZE
 - 
sg_off
, 
»maššg_sz
);

3341 
	`sg_£t_·ge
(&
sg
[
i
], 
NULL
, 
sg_sz
, 
sg_off
);

3342 
»maššg_sz
 -ð
sg_sz
;

3343 
sg_off
 = 0;

3345 *
p_sg_út
 = 
sg_út
;

3347 
out
:

3348 
	`TRACE_EXIT
();

3349  
sg
;

3350 
	}
}

3352 
	$fžeio_®loc_d©a_buf
(
sc¡_cmd
 *
cmd
)

3354 
vdisk_cmd_·¿ms
 *
p
;

3355 
sc¡_vdisk_dev
 *
vœt_dev
;

3356 
sg_út
, 
Ä
;

3357 cÚ¡ 
gå_t
 
gå_mask
 = 
GFP_KERNEL
;

3358 
sÿ‰”li¡
 *
sg
;

3360 
	`TRACE_ENTRY
();

3362 
p
 = 
cmd
->
dh_´iv
;

3363 
	`EXTRACHECKS_BUG_ON
(!
p
);

3364 
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

3370 ià(
cmd
->
tgt_i_d©a_buf_®loûd
 ||

3371 (
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_READ
) == 0 ||

3372 (
vœt_dev
->
fd
 && !vœt_dev->fd->
f_m­pšg
->
a_Ýs
->
»ad·ge
)) {

3373 
p
->
u£_z”o_cÝy
 = 
çl£
;

3375 ià(!
p
->
u£_z”o_cÝy
)

3376 
out
;

3378 
	`EXTRACHECKS_BUG_ON
(!(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_READ
));

3380 
	`sc¡_cmd_£t_dh_d©a_buff_®loûd
(
cmd
);

3382 
cmd
->
sg
 = 
	`®loc_sg
(cmd->
bufæ’
, 
p
->
loff
 & ~
PAGE_MASK
, 
gå_mask
,

3383 
p
->
sm®l_sg
, 
	`ARRAY_SIZE
Õ->sm®l_sg), &
cmd
->
sg_út
);

3384 ià(!
cmd
->
sg
) {

3385 
	`PRINT_ERROR
("sg‡llocation failed (bufflen = %d, off = %lld)\n",

3386 
cmd
->
bufæ’
, 
p
->
loff
 & ~
PAGE_MASK
);

3387 
’omem
;

3389 
sg_út
 = 
	`sc¡_cmd_g‘_sg_út
(
cmd
);

3390 
sg
 = 
cmd
->sg;

3391 
Ä
 = 
	`´•¬e_»ad
(
vœt_dev
->
fd
, 
sg
, 
sg_út
, 
p
->
loff
 >> 
PAGE_SHIFT
);

3392 ià(
Ä
 < 0) {

3393 
	`PRINT_ERROR
("´•¬e_»ad(èçžed: %d", 
Ä
);

3394 
out_ä“_sg
;

3396 
out
:

3397 
	`TRACE_EXIT
();

3398  
SCST_CMD_STATE_DEFAULT
;

3400 
out_ä“_sg
:

3401 
	`kä“
(
cmd
->
sg
);

3402 
cmd
->
sg
 = 
NULL
;

3403 
cmd
->
sg_út
 = 0;

3405 
’omem
:

3406 
	`sc¡_£t_busy
(
cmd
);

3407 
	`TRACE_EXIT_RES
(-
ENOMEM
);

3408  
	`sc¡_g‘_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

3409 
	}
}

3411 
	$fžeio_®loc_d©a_buf
(
sc¡_cmd
 *
cmd
)

3413 
vdisk_cmd_·¿ms
 *
p
;

3415 
	`TRACE_ENTRY
();

3417 
p
 = 
cmd
->
dh_´iv
;

3418 
	`EXTRACHECKS_BUG_ON
(!
p
);

3419 
p
->
u£_z”o_cÝy
 = 
çl£
;

3421 
	`TRACE_EXIT
();

3422  
SCST_CMD_STATE_DEFAULT
;

3423 
	}
}

3425 
	$fšish_»ad
(
sÿ‰”li¡
 *
sg
, 
sg_út
)

3427 
	}
}

3430 
	$vdev_do_job
(
sc¡_cmd
 *
cmd
, cÚ¡ 
vdisk_Ý_â
 *
Ýs
)

3432 
»s
;

3433 
ušt8_t
 *
cdb
 = 
cmd
->cdb;

3434 
Ýcode
 = 
cdb
[0];

3435 
vdisk_cmd_·¿ms
 *
p
 = 
cmd
->
dh_´iv
;

3436 
sc¡_vdisk_dev
 *
vœt_dev
;

3437 
vdisk_Ý_â
 
Ý
 = 
Ýs
[
Ýcode
];

3438 
com¶_¡©us_e
 
s
;

3440 
	`TRACE_ENTRY
();

3442 
	`EXTRACHECKS_BUG_ON
(!
p
);

3444 
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

3446 
	`EXTRACHECKS_BUG_ON
(
p
->
cmd
 != cmd);

3447 
	`EXTRACHECKS_BUG_ON
(
Ýs
 !ð
blockio_Ýs
 && op !ð
fžeio_Ýs
 && op !ð
nuÎio_Ýs
);

3454 ià(
	`uÆik–y
(
vœt_dev
->
fÜm©_aùive
)) {

3455 
cmd
->
cdb
[0]) {

3456 
INQUIRY
:

3457 
REPORT_LUNS
:

3458 
REQUEST_SENSE
:

3461 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_fÜm©_š_´og»ss
));

3462 
out_com¶
;

3466 
s
 = 
	`Ý
(
p
);

3467 ià(
s
 =ð
CMD_SUCCEEDED
)

3469 ià(
s
 =ð
RUNNING_ASYNC
)

3470 
out_thr
;

3471 ià(
s
 =ð
CMD_FAILED
)

3472 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

3473 ià(
s
 =ð
INVALID_OPCODE
)

3474 
out_šv®id_Ýcode
;

3476 
	`WARN_ON
(
Œue
);

3478 
out_com¶
:

3479 
cmd
->
com¶‘ed
 = 1;

3480 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

3482 
out_thr
:

3483 
»s
 = 
SCST_EXEC_COMPLETED
;

3485 
	`TRACE_EXIT_RES
(
»s
);

3486  
»s
;

3488 
out_šv®id_Ýcode
:

3489 
	`TRACE_DBG
("Inv®id opcod%s", 
	`sc¡_g‘_Ýcode_Çme
(
cmd
));

3490 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

3491 
out_com¶
;

3492 
	}
}

3494 
	$fžeio_exec
(
sc¡_cmd
 *
cmd
)

3496 
sc¡_vdisk_dev
 *
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

3497 cÚ¡ 
vdisk_Ý_â
 *
Ýs
 = 
vœt_dev
->
vdev_devt
->
devt_´iv
;

3499 
	`EXTRACHECKS_BUG_ON
(!
Ýs
);

3500  
	`vdev_do_job
(
cmd
, 
Ýs
);

3501 
	}
}

3503 
	$fžeio_Ú_ä“_cmd
(
sc¡_cmd
 *
cmd
)

3505 
vdisk_cmd_·¿ms
 *
p
 = 
cmd
->
dh_´iv
;

3506 
sc¡_vdisk_dev
 *
vœt_dev
;

3508 
	`TRACE_ENTRY
();

3510 ià(!
p
)

3511 
out
;

3513 
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

3515 ià(
p
->
u£_z”o_cÝy
) {

3516 ià((
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_READ
) &&

3517 
vœt_dev
->
z”o_cÝy
)

3518 
	`fšish_»ad
(
cmd
->
sg
, cmd->
sg_út
);

3519 ià(
cmd
->
sg
 !ð
p
->
sm®l_sg
)

3520 
	`kä“
(
cmd
->
sg
);

3521 
cmd
->
sg_út
 = 0;

3522 
cmd
->
sg
 = 
NULL
;

3523 
cmd
->
bufæ’
 = 0;

3524 
cmd
->
d©a_Ën
 = 0;

3527 ià(
p
->
iv
 !ðp->
sm®l_iv
)

3528 
	`kä“
(
p
->
iv
);

3530 
	`kmem_ÿche_ä“
(
vdisk_cmd_·¿m_ÿch•
, 
p
);

3532 
out
:

3533 
	`TRACE_EXIT
();

3535 
	}
}

3542 
boÞ
 
	$vdisk_no_fd_®lowed_commªds
(cÚ¡ 
sc¡_cmd
 *
cmd
)

3544 
boÞ
 
»s
;

3546 
	`TRACE_ENTRY
();

3548 
cmd
->
cdb
[0]) {

3549 
TEST_UNIT_READY
:

3550 
GET_EVENT_STATUS_NOTIFICATION
:

3551 
INQUIRY
:

3552 
MODE_SENSE
:

3553 
MODE_SENSE_10
:

3554 
READ_CAPACITY
:

3555 
REPORT_LUNS
:

3556 
REQUEST_SENSE
:

3557 
RELEASE
:

3558 
RELEASE_10
:

3559 
RESERVE
:

3560 
RESERVE_10
:

3561 
READ_BUFFER
:

3562 
WRITE_BUFFER
:

3563 
MODE_SELECT
:

3564 
MODE_SELECT_10
:

3565 
LOG_SELECT
:

3566 
LOG_SENSE
:

3567 
RECEIVE_DIAGNOSTIC
:

3568 
SEND_DIAGNOSTIC
:

3569 
PERSISTENT_RESERVE_IN
:

3570 
PERSISTENT_RESERVE_OUT
:

3571 
»s
 = 
Œue
;

3572 
out
;

3573 
SERVICE_ACTION_IN_16
:

3574 
cmd
->
cdb
[1] & 0x1f) {

3575 
SAI_READ_CAPACITY_16
:

3576 
»s
 = 
Œue
;

3577 
out
;

3580 
MAINTENANCE_IN
:

3581 
cmd
->
cdb
[1] & 0x1f) {

3582 
MI_REPORT_TARGET_PGS
:

3583 
»s
 = 
Œue
;

3584 
out
;

3587 
MAINTENANCE_OUT
:

3588 
cmd
->
cdb
[1] & 0x1f) {

3589 
MO_SET_TARGET_PGS
:

3590 
»s
 = 
Œue
;

3591 
out
;

3596 
»s
 = 
çl£
;

3598 
out
:

3599 
	`TRACE_EXIT_RES
(
»s
);

3600  
»s
;

3601 
	}
}

3603 
	$blockio_exec
(
sc¡_cmd
 *
cmd
)

3605 
sc¡_vdisk_dev
 *
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

3606 cÚ¡ 
vdisk_Ý_â
 *
Ýs
 = 
vœt_dev
->
vdev_devt
->
devt_´iv
;

3607 
vdisk_cmd_·¿ms
 
p
;

3608 
»s
;

3610 
	`EXTRACHECKS_BUG_ON
(!
Ýs
);

3612 
	`mem£t
(&
p
, 0, (p));

3613 ià(
	`uÆik–y
(!
	`vdisk_·r£_off£t
(&
p
, 
cmd
)))

3614 
”r
;

3616 ià(
	`uÆik–y
(
vœt_dev
->
fd
 =ð
NULL
)) {

3617 ià(!
	`vdisk_no_fd_®lowed_commªds
(
cmd
)) {

3619 
	`PRINT_WARNING
("Closed FD onƒxec. Secondary DRBD or‚ot "

3621 "(cmd %p, o°%s, dev %s)", 
cmd
, cmd->
Ý_Çme
,

3622 
cmd
->
dev
->
vœt_Çme
);

3623 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_no_medium
));

3624 
”r
;

3628 
cmd
->
dh_´iv
 = &
p
;

3629 
»s
 = 
	`vdev_do_job
(
cmd
, 
Ýs
);

3630 
cmd
->
dh_´iv
 = 
NULL
;

3632 
out
:

3633  
»s
;

3635 
”r
:

3636 
»s
 = 
SCST_EXEC_COMPLETED
;

3637 
cmd
->
com¶‘ed
 = 1;

3638 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

3639 
out
;

3640 
	}
}

3642 
	$nuÎio_exec
(
sc¡_cmd
 *
cmd
)

3644 
sc¡_vdisk_dev
 *
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

3645 cÚ¡ 
vdisk_Ý_â
 *
Ýs
 = 
vœt_dev
->
vdev_devt
->
devt_´iv
;

3646 
vdisk_cmd_·¿ms
 
p
;

3647 
»s
;

3649 
	`EXTRACHECKS_BUG_ON
(!
Ýs
);

3651 
	`mem£t
(&
p
, 0, (p));

3652 ià(
	`uÆik–y
(!
	`vdisk_·r£_off£t
(&
p
, 
cmd
)))

3653 
”r
;

3655 
cmd
->
dh_´iv
 = &
p
;

3656 
»s
 = 
	`vdev_do_job
(
cmd
, 
Ýs
);

3657 
cmd
->
dh_´iv
 = 
NULL
;

3659 
out
:

3660  
»s
;

3662 
”r
:

3663 
»s
 = 
SCST_EXEC_COMPLETED
;

3664 
cmd
->
com¶‘ed
 = 1;

3665 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

3666 
out
;

3667 
	}
}

3669 
	$vcdrom_exec
(
sc¡_cmd
 *
cmd
)

3671 
»s
 = 
SCST_EXEC_COMPLETED
;

3672 
Ýcode
 = 
cmd
->
cdb
[0];

3673 
sc¡_vdisk_dev
 *
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

3675 
	`TRACE_ENTRY
();

3677 
cmd
->
¡©us
 = 0;

3678 
cmd
->
msg_¡©us
 = 0;

3679 
cmd
->
ho¡_¡©us
 = 
DID_OK
;

3680 
cmd
->
driv”_¡©us
 = 0;

3682 ià(
vœt_dev
->
cdrom_em±y
 && (
Ýcode
 !ð
INQUIRY
)) {

3683 
	`TRACE_DBG
("%s", "CDROMƒmpty");

3684 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_no_medium
));

3685 
out_dÚe
;

3688 ià(
vœt_dev
->
medŸ_chªged
 && ((
cmd
->
Ý_æags
 & 
SCST_SKIP_UA
) == 0)) {

3689 
	`¥š_lock
(&
vœt_dev
->
æags_lock
);

3690 ià(
vœt_dev
->
medŸ_chªged
) {

3691 
vœt_dev
->
medŸ_chªged
 = 0;

3692 
	`TRACE_DBG
("%s", "Reporting media changed");

3693 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

3694 
	`SCST_LOAD_SENSE
(
sc¡_£n£_medium_chªged_UA
));

3695 
	`¥š_uÆock
(&
vœt_dev
->
æags_lock
);

3696 
out_dÚe
;

3698 
	`¥š_uÆock
(&
vœt_dev
->
æags_lock
);

3701 
»s
 = 
	`vdev_do_job
(
cmd
, 
vœt_dev
->
blockio
 ? 
blockio_Ýs
 : 
fžeio_Ýs
);

3703 
out
:

3704 
	`TRACE_EXIT_RES
(
»s
);

3705  
»s
;

3707 
out_dÚe
:

3708 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

3709 
out
;

3710 
	}
}

3712 
ušt64_t
 
	$vdisk_g’_dev_id_num
(cÚ¡ *
vœt_dev_Çme
)

3714 
ušt32_t
 
dev_id_num
;

3716 
dev_id_num
 = 
	`üc32c
(0, 
vœt_dev_Çme
, 
	`¡¾’
(virt_dev_name)+1);

3718 #ifdeà
CONFIG_SCST_PROC


3719  ((
ušt64_t
)
sc¡_vdisk_ID
 << 32è| 
dev_id_num
;

3721  ((
ušt64_t
)
	`sc¡_g‘_£tup_id
(è<< 32è| 
dev_id_num
;

3723 
	}
}

3725 
	$vdisk_unm­_fže_¿nge
(
sc¡_cmd
 *
cmd
,

3726 
sc¡_vdisk_dev
 *
vœt_dev
, 
loff_t
 
off
,†off_ˆ
Ën
,

3727 
fže
 *
fd
)

3729 
»s
;

3731 
	`TRACE_ENTRY
();

3733 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 38)

3734 
	`TRACE_DBG
("Fallocating„ange %lld,†en %lld",

3735 ()
off
, ()
Ën
);

3737 
»s
 = 
fd
->
f_Ý
->
	`çÎoÿ‹
(fd,

3738 
FALLOC_FL_PUNCH_HOLE
 | 
FALLOC_FL_KEEP_SIZE
, 
off
, 
Ën
);

3739 ià(
	`uÆik–y
(
»s
 != 0)) {

3740 
	`PRINT_ERROR
("fallocate() for %lld,†en %lld "

3741 "çžed: %d", ()
off
,

3742 ()
Ën
, 
»s
);

3743 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

3744 
	`SCST_LOAD_SENSE
(
sc¡_£n£_wr™e_”rÜ
));

3745 
»s
 = -
EIO
;

3748 
»s
 = 0;

3751 
	`TRACE_EXIT_RES
(
»s
);

3752  
»s
;

3753 
	}
}

3755 
	$vdisk_unm­_¿nge
(
sc¡_cmd
 *
cmd
,

3756 
sc¡_vdisk_dev
 *
vœt_dev
, 
ušt64_t
 
¡¬t_lba
, 
ušt32_t
 
blocks
)

3758 #ià
LINUX_VERSION_CODE
 > 
	`KERNEL_VERSION
(2, 6, 27)

3759 
»s
, 
”r
;

3761 
»s
;

3763 
fže
 *
fd
 = 
vœt_dev
->fd;

3765 
	`TRACE_ENTRY
();

3767 ià(
blocks
 == 0)

3768 
sucûss
;

3770 ià((
¡¬t_lba
 > 
vœt_dev
->
nblocks
) ||

3771 ((
¡¬t_lba
 + 
blocks
è> 
vœt_dev
->
nblocks
)) {

3772 
	`PRINT_ERROR
("Device %s:‡ttempto write beyond max "

3773 "size", 
vœt_dev
->
Çme
);

3774 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

3775 
	`SCST_LOAD_SENSE
(
sc¡_£n£_block_out_¿nge_”rÜ
));

3776 
»s
 = -
EINVAL
;

3777 
out
;

3780 
	`TRACE_DBG
("Unmapping†ba %lld (blocks %lld)",

3781 ()
¡¬t_lba
, ()
blocks
);

3783 ià(
vœt_dev
->
blockio
) {

3784 #ià
LINUX_VERSION_CODE
 > 
	`KERNEL_VERSION
(2, 6, 27)

3785 
£ùÜ_t
 
¡¬t_£ùÜ
 = 
¡¬t_lba
 << (
cmd
->
dev
->
block_shiá
 - 9);

3786 
£ùÜ_t
 
Ä_£ùs
 = 
blocks
 << (
cmd
->
dev
->
block_shiá
 - 9);

3787 
šode
 *šodð
	`fže_šode
(
fd
);

3788 
gå_t
 
gå
 = 
cmd
->
cmd_gå_mask
;

3790 #ià
LINUX_VERSION_CODE
 <ð
	`KERNEL_VERSION
(2, 6, 31)

3791 
”r
 = 
	`blkdev_issue_disÿrd
(
šode
->
i_bdev
, 
¡¬t_£ùÜ
, 
Ä_£ùs
, 
gå
);

3792 #–ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 35) \

3793 && !(
LINUX_VERSION_CODE
 =ð
	`KERNEL_VERSION
(2, 6, 34) \

3794 && 
	`defšed
(
CONFIG_SUSE_KERNEL
))

3795 
”r
 = 
	`blkdev_issue_disÿrd
(
šode
->
i_bdev
, 
¡¬t_£ùÜ
, 
Ä_£ùs
,

3796 
gå
, 
DISCARD_FL_WAIT
);

3797 #–ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 37)

3798 
”r
 = 
	`blkdev_issue_disÿrd
(
šode
->
i_bdev
, 
¡¬t_£ùÜ
, 
Ä_£ùs
,

3799 
gå
, 
BLKDEV_IFL_WAIT
);

3801 
”r
 = 
	`blkdev_issue_disÿrd
(
šode
->
i_bdev
, 
¡¬t_£ùÜ
, 
Ä_£ùs
, 
gå
, 0);

3803 ià(
	`uÆik–y
(
”r
 != 0)) {

3804 
	`PRINT_ERROR
("blkdev_issue_discard() for "

3806 ()
¡¬t_lba
, 
blocks
, 
”r
);

3807 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

3808 
	`SCST_LOAD_SENSE
(
sc¡_£n£_wr™e_”rÜ
));

3809 
»s
 = -
EIO
;

3810 
out
;

3813 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

3814 
»s
 = -
EIO
;

3815 
out
;

3818 
loff_t
 
off
 = 
¡¬t_lba
 << 
cmd
->
dev
->
block_shiá
;

3819 
loff_t
 
Ën
 = (
u64
)
blocks
 << 
cmd
->
dev
->
block_shiá
;

3821 
»s
 = 
	`vdisk_unm­_fže_¿nge
(
cmd
, 
vœt_dev
, 
off
, 
Ën
, 
fd
);

3822 ià(
	`uÆik–y
(
»s
 != 0))

3823 
out
;

3826 ià(
vœt_dev
->
dif_fd
 !ð
NULL
) {

3827 
»s
 = 
	`vdisk_fÜm©_dif
(
cmd
, 
¡¬t_lba
, 
blocks
);

3828 ià(
	`uÆik–y
(
»s
 != 0))

3829 
out
;

3832 
sucûss
:

3833 
»s
 = 0;

3835 
out
:

3836 
	`TRACE_EXIT_RES
(
»s
);

3837  
»s
;

3838 
	}
}

3840 
	$vdisk_exec_wr™e_§me_unm­
(
vdisk_cmd_·¿ms
 *
p
)

3842 
rc
;

3843 
sc¡_cmd
 *
cmd
 = 
p
->cmd;

3844 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

3845 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

3847 
	`TRACE_ENTRY
();

3849 ià(
	`uÆik–y
(!
vœt_dev
->
thš_´ovisiÚed
)) {

3850 
	`TRACE_DBG
("%s", "Device‚othin…rovisioned");

3851 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

3852 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

3853 
out
;

3856 ià(
	`uÆik–y
((
ušt64_t
)
cmd
->
d©a_Ën
 > cmd->
dev
->
max_wr™e_§me_Ën
)) {

3857 
	`PRINT_WARNING
("Invalid WRITE SAME data†en %lld (max‡llowed "

3858 "%Îd)", ()
cmd
->
d©a_Ën
,

3859 ()
cmd
->
dev
->
max_wr™e_§me_Ën
);

3860 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, cmd->
Ën_off
, 0);

3861 
out
;

3864 
rc
 = 
	`vdisk_unm­_¿nge
(
cmd
, 
vœt_dev
, cmd->
lba
,

3865 
cmd
->
d©a_Ën
 >> 
dev
->
block_shiá
);

3866 ià(
rc
 != 0)

3867 
out
;

3869 
out
:

3870 
	`TRACE_EXIT
();

3872 
	}
}

3878 
	$sc¡_cÝy_ªd_fžl_b
(*
d¡
, cÚ¡ *
¤c
, 
Ën
,

3879 
ušt8_t
 
fžl_by‹
)

3881 
ýy_Ën
 = 
	`mš_t
(, 
	`¡¾’
(
¤c
), 
Ën
);

3883 
	`memýy
(
d¡
, 
¤c
, 
ýy_Ën
);

3884 
	`mem£t
(
d¡
 + 
ýy_Ën
, 
fžl_by‹
, 
Ën
 - cpy_len);

3885 
	}
}

3891 
	$sc¡_cÝy_ªd_fžl
(*
d¡
, cÚ¡ *
¤c
, 
Ën
)

3893 
	`sc¡_cÝy_ªd_fžl_b
(
d¡
, 
¤c
, 
Ën
, ' ');

3894 
	}
}

3896 
com¶_¡©us_e
 
	$vdisk_exec_wr™e_§me
(
vdisk_cmd_·¿ms
 *
p
)

3898 
sc¡_cmd
 *
cmd
 = 
p
->cmd;

3899 
com¶_¡©us_e
 
»s
 = 
CMD_SUCCEEDED
;

3900 
ušt8_t
 
ù¾_offs
 = (
cmd
->
cdb_Ën
 < 32) ? 1 : 10;

3902 
	`TRACE_ENTRY
();

3904 ià(
	`uÆik–y
(
cmd
->
cdb
[
ù¾_offs
] & 0x10)) {

3905 
	`TRACE_DBG
("%s", "ANCHOR‚ot supported");

3906 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 
ù¾_offs
,

3907 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 4);

3908 
out
;

3911 ià(
	`uÆik–y
(
cmd
->
d©a_Ën
 <= 0)) {

3912 
	`PRINT_ERROR
("WRITE SAME:„efused data_len = %#llx",

3913 
cmd
->
d©a_Ën
);

3914 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, cmd->
Ën_off
, 0);

3915 
out
;

3918 ià(
cmd
->
cdb
[
ù¾_offs
] & 0x8)

3919 
	`vdisk_exec_wr™e_§me_unm­
(
p
);

3921 
	`sc¡_wr™e_§me
(
cmd
, 
NULL
);

3922 
»s
 = 
RUNNING_ASYNC
;

3925 
out
:

3926 
	`TRACE_EXIT_RES
(
»s
);

3927  
»s
;

3928 
	}
}

3930 
com¶_¡©us_e
 
	$vdisk_exec_unm­
(
vdisk_cmd_·¿ms
 *
p
)

3932 
sc¡_cmd
 *
cmd
 = 
p
->cmd;

3933 
sc¡_vdisk_dev
 *
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

3934 
sc¡_d©a_desütÜ
 *
pd
 = 
cmd
->
cmd_d©a_desütÜs
;

3935 
i
, 
út
 = 
cmd
->
cmd_d©a_desütÜs_út
;

3936 
ušt32_t
 
blocks_to_unm­
;

3938 
	`TRACE_ENTRY
();

3940 ià(
	`uÆik–y
(!
vœt_dev
->
thš_´ovisiÚed
)) {

3941 
	`TRACE_DBG
("%s", "Device‚othin…rovisioned");

3942 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

3943 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

3944 
out
;

3947 ià(
	`uÆik–y
(
cmd
->
cdb
[1] & 1)) {

3948 
	`TRACE_DBG
("%s", "ANCHOR‚ot supported");

3949 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 1,

3950 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 0);

3951 
out
;

3954 ià(
pd
 =ð
NULL
)

3955 
out
;

3958 
blocks_to_unm­
 = 0;

3959 
i
 = 0; i < 
út
; i++) {

3960 
blocks_to_unm­
 +ð
pd
[
i
].
sdd_blocks
;

3961 ià(
blocks_to_unm­
 > 
vœt_dev
->
unm­_max_lba_út
) {

3962 
	`PRINT_WARNING
("Too many UNMAP LBAs %u (max‡llowed %u, "

3963 "dev %s)", 
blocks_to_unm­
,

3964 
vœt_dev
->
unm­_max_lba_út
,

3965 
vœt_dev
->
dev
->
vœt_Çme
);

3966 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 0, 0);

3967 
out
;

3971 
i
 = 0; i < 
út
; i++) {

3972 
rc
;

3974 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
))) {

3975 
	`TRACE_MGMT_DBG
("ABORTED s‘,‡bÜtšg cmd %p", 
cmd
);

3976 
out
;

3979 
rc
 = 
	`vdisk_unm­_¿nge
(
cmd
, 
vœt_dev
, 
pd
[
i
].
sdd_lba
,

3980 
pd
[
i
].
sdd_blocks
);

3981 ià(
rc
 != 0)

3982 
out
;

3985 
out
:

3986 
	`TRACE_EXIT
();

3987  
CMD_SUCCEEDED
;

3988 
	}
}

3991 
	$vdisk_sup_vpd
(
ušt8_t
 *
buf
, 
sc¡_cmd
 *
cmd
,

3992 
sc¡_vdisk_dev
 *
vœt_dev
)

3994 *
·ge_li¡
 = &
buf
[4], *
p
 =…age_list;

3996 *
p
++ = 0x0;

3997 *
p
++ = 0x80;

3998 *
p
++ = 0x83;

3999 *
p
++ = 0x86;

4000 ià(
cmd
->
dev
->
ty³
 =ð
TYPE_DISK
) {

4001 *
p
++ = 0xB0;

4002 *
p
++ = 0xB1;

4003 ià(
vœt_dev
->
thš_´ovisiÚed
)

4004 *
p
++ = 0xB2;

4006 
buf
[3] = 
p
 - 
·ge_li¡
;

4008  
buf
[3] + 4;

4009 
	}
}

4012 
	$vdisk_u¢_vpd
(
ušt8_t
 *
buf
, 
sc¡_cmd
 *
cmd
,

4013 
sc¡_vdisk_dev
 *
vœt_dev
)

4015 
buf
[1] = 0x80;

4016 ià(
cmd
->
tg‰
->
g‘_£rŸl
) {

4017 
buf
[3] = 
cmd
->
tg‰
->
	`g‘_£rŸl
(cmd->
tgt_dev
, &buf[4],

4018 
INQ_BUF_SZ
 - 4);

4020 
u¢_Ën
;

4022 
	`»ad_lock
(&
vdisk_£rŸl_rwlock
);

4023 
u¢_Ën
 = 
	`¡¾’
(
vœt_dev
->
u¢
);

4024 
buf
[3] = 
u¢_Ën
;

4025 
	`¡ºýy
(&
buf
[4], 
vœt_dev
->
u¢
, 
u¢_Ën
);

4026 
	`»ad_uÆock
(&
vdisk_£rŸl_rwlock
);

4028  
buf
[3] + 4;

4029 
	}
}

4032 
	$vdisk_dev_id_vpd
(
ušt8_t
 *
buf
, 
sc¡_cmd
 *
cmd
,

4033 
sc¡_vdisk_dev
 *
vœt_dev
)

4035 
i
, 
eui64_Ën
 = 0, 
Ça_Ën
 = 0, 
»¥_Ën
, 
num
 = 4;

4036 
ušt16_t
 
tg_id
;

4037 
u8
 *
eui64_id
 = 
NULL
, *
Ça_id
 = NULL;

4039 
buf
[1] = 0x83;

4041 
	`»ad_lock
(&
vdisk_£rŸl_rwlock
);

4042 
i
 = 
	`¡¾’
(
vœt_dev
->
scsi_deviû_Çme
);

4043 ià(
i
 > 0) {

4045 
buf
[
num
 + 0] = 0x3;

4046 
buf
[
num
 + 1] = 0x20 | 0x8;

4047 
i
 += 4 - i % 4;

4048 
	`sc¡_cÝy_ªd_fžl_b
(&
buf
[
num
 + 4], 
vœt_dev
->
scsi_deviû_Çme
,

4049 
i
, '\0');

4051 
buf
[
num
 + 3] = 
i
;

4052 
num
 +ð
buf
[num + 3];

4054 
num
 += 4;

4056 
	`»ad_uÆock
(&
vdisk_£rŸl_rwlock
);

4059 
buf
[
num
 + 0] = 0x2;

4060 
buf
[
num
 + 1] = 0x1;

4061 
	`»ad_lock
(&
vdisk_£rŸl_rwlock
);

4062 
	`sc¡_cÝy_ªd_fžl
(&
buf
[
num
 + 4], 
vœt_dev
->
t10_v’d_id
, 8);

4063 
i
 = 
	`¡¾’
(
vœt_dev
->
v’d_¥ecific_id
);

4064 
	`memýy
(&
buf
[
num
 + 12], 
vœt_dev
->
v’d_¥ecific_id
, 
i
);

4065 
	`»ad_uÆock
(&
vdisk_£rŸl_rwlock
);

4067 
buf
[
num
 + 3] = 8 + 
i
;

4068 
num
 +ð
buf
[num + 3];

4070 
num
 += 4;

4075 
buf
[
num
 + 0] = 0x01;

4077 
buf
[
num
 + 1] = 0x10 | 0x04;

4079 
	`put_uÇligÃd_be16
(
cmd
->
tgt
->
»l_tgt_id
, &
buf
[
num
 + 4 + 2]);

4081 
buf
[
num
 + 3] = 4;

4082 
num
 +ð
buf
[num + 3];

4084 
num
 += 4;

4086 
tg_id
 = 
	`sc¡_lookup_tg_id
(
cmd
->
dev
, cmd->
tgt
);

4087 ià(
tg_id
) {

4091 
buf
[
num
 + 0] = 0x01;

4093 
buf
[
num
 + 1] = 0x10 | 0x05;

4095 
	`put_uÇligÃd_be16
(
tg_id
, &
buf
[
num
 + 4 + 2]);

4097 
buf
[
num
 + 3] = 4;

4098 
num
 +ð4 + 
buf
[num + 3];

4101 
	`»ad_lock
(&
vdisk_£rŸl_rwlock
);

4103 ià(
vœt_dev
->
eui64_id_Ën
 =ð0 && vœt_dev->
Ça_id_Ën
 == 0) {

4110 
eui64_Ën
 = 8;

4111 
eui64_id
 = 
vœt_dev
->
t10_dev_id
;

4113 ià(
vœt_dev
->
eui64_id_Ën
) {

4114 
eui64_Ën
 = 
vœt_dev
->
eui64_id_Ën
;

4115 
eui64_id
 = 
vœt_dev
->eui64_id;

4117 ià(
vœt_dev
->
Ça_id_Ën
) {

4118 
Ça_Ën
 = 
vœt_dev
->
Ça_id_Ën
;

4119 
Ça_id
 = 
vœt_dev
->naa_id;

4122 ià(
eui64_Ën
) {

4123 
buf
[
num
 + 0] = 0x01;

4124 
buf
[
num
 + 1] = 0x02;

4125 
buf
[
num
 + 2] = 0x00;

4126 
buf
[
num
 + 3] = 
eui64_Ën
;

4127 
	`memýy
(&
buf
[
num
 + 4], 
eui64_id
, 
eui64_Ën
);

4128 
num
 +ð4 + 
eui64_Ën
;

4130 ià(
Ça_Ën
) {

4131 
buf
[
num
 + 0] = 0x01;

4132 
buf
[
num
 + 1] = 0x03;

4133 
buf
[
num
 + 2] = 0x00;

4134 
buf
[
num
 + 3] = 
Ça_Ën
;

4135 
	`memýy
(&
buf
[
num
 + 4], 
Ça_id
, 
Ça_Ën
);

4136 
num
 +ð4 + 
Ça_Ën
;

4139 
	`»ad_uÆock
(&
vdisk_£rŸl_rwlock
);

4141 
»¥_Ën
 = 
num
 - 4;

4143 
	`put_uÇligÃd_be16
(
»¥_Ën
, &
buf
[2]);

4144 
»¥_Ën
 += 4;

4146  
»¥_Ën
;

4147 
	}
}

4150 
	$vdisk_ext_šq
(
ušt8_t
 *
buf
, 
sc¡_cmd
 *
cmd
,

4151 
sc¡_vdisk_dev
 *
vœt_dev
)

4153 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

4155 
buf
[1] = 0x86;

4156 
buf
[3] = 0x3C;

4157 ià(
dev
->
dev_dif_mode
 !ð
SCST_DIF_MODE_NONE
) {

4158 
dev
->
dev_dif_ty³
) {

4160 
buf
[4] = 0;

4163 
buf
[4] = 0x10;

4166 
buf
[4] = 0x20;

4169 
	`sBUG_ON
(1);

4172 
buf
[4] |= 4;

4173 ià(
dev
->
dif_­p_chk
)

4174 
buf
[4] |= 2;

4175 ià(
dev
->
dif_»f_chk
)

4176 
buf
[4] |= 1;

4178 
buf
[5] = 7;

4179 
buf
[6] = (
vœt_dev
->
wt_æag
 || vœt_dev->
nv_ÿche
) ? 0 : 1;

4180 
buf
[7] = 1;

4181  
buf
[3] + 4;

4182 
	}
}

4185 
	$vdisk_block_lim™s
(
ušt8_t
 *
buf
, 
sc¡_cmd
 *
cmd
,

4186 
sc¡_vdisk_dev
 *
vœt_dev
)

4188 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

4189 
max_Œªsãr
;

4191 
buf
[1] = 0xB0;

4192 
buf
[3] = 0x3C;

4193 
buf
[4] = 1;

4194 
buf
[5] = 0xFF;

4196 
	`put_uÇligÃd_be16
(
	`max_t
(, 
PAGE_SIZE
 / 
dev
->
block_size
, 1), &
buf
[6]);

4199 
max_Œªsãr
 = 
	`mš_t
(, 
cmd
->
tgt_dev
->
max_sg_út
 << 
PAGE_SHIFT
,

4200 8*1024*1024è/ 
dev
->
block_size
;

4201 
	`put_uÇligÃd_be32
(
max_Œªsãr
, &
buf
[8]);

4210 
	`put_uÇligÃd_be32
(
	`mš_t
(, 
max_Œªsãr
, 512*1024 / 
dev
->
block_size
),

4211 &
buf
[12]);

4213 ià(
vœt_dev
->
thš_´ovisiÚed
) {

4215 
	`put_uÇligÃd_be32
(0xFFFFFFFF, &
buf
[24]);

4220 
	`put_uÇligÃd_be32
(
vœt_dev
->
unm­_max_lba_út
, &
buf
[20]);

4221 
	`put_uÇligÃd_be32
(
vœt_dev
->
unm­_Ýt_g¿n
, &
buf
[28]);

4222 ià(
vœt_dev
->
unm­_®ign
 != 0) {

4223 
	`put_uÇligÃd_be32
(
vœt_dev
->
unm­_®ign
, &
buf
[32]);

4224 
buf
[32] |= 0x80;

4229 
	`put_uÇligÃd_be64
(
dev
->
max_wr™e_§me_Ën
 >> dev->
block_shiá
,

4230 &
buf
[36]);

4232  
buf
[3] + 4;

4233 
	}
}

4236 
	$vdisk_bdev_ch¬
(
ušt8_t
 *
buf
, 
sc¡_cmd
 *
cmd
,

4237 
sc¡_vdisk_dev
 *
vœt_dev
)

4239 
buf
[1] = 0xB1;

4240 
buf
[3] = 0x3C;

4241 ià(
vœt_dev
->
rÙ©iÚ®
) {

4243 
	`put_uÇligÃd_be16
(0x3A98, &
buf
[4]);

4245 
	`put_uÇligÃd_be16
(1, &
buf
[4]);

4246  
buf
[3] + 4;

4247 
	}
}

4250 
	$vdisk__vpd
(
ušt8_t
 *
buf
, 
sc¡_cmd
 *
cmd
,

4251 
sc¡_vdisk_dev
 *
vœt_dev
)

4253 
buf
[1] = 0xB2;

4254 
buf
[3] = 4;

4255 
buf
[5] = 0xE0;

4256 ià(
vœt_dev
->
disÿrd_z”Ûs_d©a
)

4257 
buf
[5] |= 0x4;

4258 
buf
[6] = 2;

4259  
buf
[3] + 4;

4260 
	}
}

4263 
	$vdisk_šq
(
ušt8_t
 *
buf
, 
sc¡_cmd
 *
cmd
,

4264 
sc¡_vdisk_dev
 *
vœt_dev
)

4266 
num
;

4268 ià(
vœt_dev
->
»movabË
)

4269 
buf
[1] = 0x80;

4270 
buf
[2] = 6;

4271 
buf
[3] = 0x02;

4272 ià(
cmd
->
tg‰
->
çke_aÿ
)

4273 
buf
[3] |= 0x20;

4274 
buf
[4] = 31;

4275 ià(
cmd
->
dev
->
dev_dif_mode
 !ð
SCST_DIF_MODE_NONE
)

4276 
buf
[5] |= 1;

4277 ià(
	`sc¡_®ua_cÚfigu»d
(
cmd
->
dev
)) {

4278 
buf
[5] |ð
SCST_INQ_TPGS_MODE_IMPLICIT
;

4279 ià(
vœt_dev
->
ex¶_®ua
)

4280 
buf
[5] |ð
SCST_INQ_TPGS_MODE_EXPLICIT
;

4282 
buf
[5] |= 8;

4283 
buf
[6] = 0x10;

4284 
buf
[7] = 2;

4286 
	`»ad_lock
(&
vdisk_£rŸl_rwlock
);

4292 
	`sc¡_cÝy_ªd_fžl
(&
buf
[8], 
vœt_dev
->
t10_v’d_id
, 8);

4298 
	`sc¡_cÝy_ªd_fžl
(&
buf
[16], 
vœt_dev
->
´od_id
, 16);

4304 
	`sc¡_cÝy_ªd_fžl
(&
buf
[32], 
vœt_dev
->
´od_»v_lvl
, 4);

4307 ià(
vœt_dev
->
šq_v’d_¥ecific_Ën
 <= 20)

4308 
	`memýy
(&
buf
[36], 
vœt_dev
->
šq_v’d_¥ecific
,

4309 
vœt_dev
->
šq_v’d_¥ecific_Ën
);

4313 
buf
[4] += 58 - 36;

4314 
num
 = 0;

4317 
buf
[58 + 
num
] = 0x0;

4318 
buf
[58 + 
num
 + 1] = 0x8B;

4319 
num
 += 2;

4322 ià(
cmd
->
tg‰
->
g‘_phys_Œª¥Üt_v”siÚ
 !ð
NULL
) {

4323 
ušt16_t
 
v
 = 
cmd
->
tg‰
->
	`g‘_phys_Œª¥Üt_v”siÚ
(cmd->
tgt
);

4325 ià(
v
 != 0) {

4326 
	`put_uÇligÃd_be16
(
v
, &
buf
[58 + 
num
]);

4327 
num
 += 2;

4332 ià(
cmd
->
tg‰
->
g‘_scsi_Œª¥Üt_v”siÚ
 !ð
NULL
) {

4333 
	`put_uÇligÃd_be16
(

4334 
cmd
->
tg‰
->
	`g‘_scsi_Œª¥Üt_v”siÚ
(cmd->
tgt
),

4335 &
buf
[58 + 
num
]);

4336 
num
 += 2;

4340 
buf
[58 + 
num
] = 0x4;

4341 
buf
[58 + 
num
 + 1] = 0x63;

4342 
num
 += 2;

4345 ià(
vœt_dev
->
commªd_£t_v”siÚ
 != 0) {

4346 
	`put_uÇligÃd_be16
(
vœt_dev
->
commªd_£t_v”siÚ
,

4347 &
buf
[58 + 
num
]);

4348 
num
 += 2;

4352 ià(
vœt_dev
->
šq_v’d_¥ecific_Ën
 > 20) {

4353 
	`memýy
(&
buf
[96], 
vœt_dev
->
šq_v’d_¥ecific
,

4354 
vœt_dev
->
šq_v’d_¥ecific_Ën
);

4355 
num
 = 96 - 58 + 
vœt_dev
->
šq_v’d_¥ecific_Ën
;

4358 
	`»ad_uÆock
(&
vdisk_£rŸl_rwlock
);

4360 
buf
[4] +ð
num
;

4361  
buf
[4] + 5;

4362 
	}
}

4364 
com¶_¡©us_e
 
	$vdisk_exec_šquœy
(
vdisk_cmd_·¿ms
 *
p
)

4366 
sc¡_cmd
 *
cmd
 = 
p
->cmd;

4367 
št32_t
 
Ëngth
, 
»¥_Ën
;

4368 
ušt8_t
 *
add»ss
;

4369 
ušt8_t
 *
buf
;

4370 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

4371 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

4373 
	`TRACE_ENTRY
();

4375 
buf
 = 
	`kz®loc
(
INQ_BUF_SZ
, 
cmd
->
cmd_gå_mask
);

4376 ià(
buf
 =ð
NULL
) {

4377 
	`sc¡_£t_busy
(
cmd
);

4378 
out
;

4381 
Ëngth
 = 
	`sc¡_g‘_buf_fuÎ_£n£
(
cmd
, &
add»ss
);

4382 
	`TRACE_DBG
("Ëngth %d", 
Ëngth
);

4383 ià(
	`uÆik–y
(
Ëngth
 <= 0))

4384 
out_ä“
;

4386 ià(
cmd
->
cdb
[1] & 
CMDDT
) {

4387 
	`TRACE_DBG
("%s", "INQUIRY: CMDDT is unsupported");

4388 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 1,

4389 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 1);

4390 
out_put
;

4393 
buf
[0] = 
vœt_dev
->
dummy
 ? 
SCSI_INQ_PQ_NOT_CON
 << 5 | 0x1f :

4394 
SCSI_INQ_PQ_CON
 << 5 | 
dev
->
ty³
;

4396 ià(
cmd
->
cdb
[1] & 
EVPD
) {

4397 ià(
cmd
->
cdb
[2] == 0) {

4398 
»¥_Ën
 = 
	`vdisk_sup_vpd
(
buf
, 
cmd
, 
vœt_dev
);

4399 } ià(
cmd
->
cdb
[2] == 0x80) {

4400 
»¥_Ën
 = 
	`vdisk_u¢_vpd
(
buf
, 
cmd
, 
vœt_dev
);

4401 } ià(
cmd
->
cdb
[2] == 0x83) {

4402 
»¥_Ën
 = 
	`vdisk_dev_id_vpd
(
buf
, 
cmd
, 
vœt_dev
);

4403 } ià(
cmd
->
cdb
[2] == 0x86) {

4404 
»¥_Ën
 = 
	`vdisk_ext_šq
(
buf
, 
cmd
, 
vœt_dev
);

4405 } ià(
cmd
->
cdb
[2] =ð0xB0 && 
dev
->
ty³
 =ð
TYPE_DISK
) {

4406 
»¥_Ën
 = 
	`vdisk_block_lim™s
(
buf
, 
cmd
, 
vœt_dev
);

4407 } ià(
cmd
->
cdb
[2] =ð0xB1 && 
dev
->
ty³
 =ð
TYPE_DISK
) {

4408 
»¥_Ën
 = 
	`vdisk_bdev_ch¬
(
buf
, 
cmd
, 
vœt_dev
);

4409 } ià(
cmd
->
cdb
[2] =ð0xB2 && 
dev
->
ty³
 =ð
TYPE_DISK
 &&

4410 
vœt_dev
->
thš_´ovisiÚed
) {

4411 
»¥_Ën
 = 
	`vdisk__vpd
(
buf
, 
cmd
, 
vœt_dev
);

4413 
	`TRACE_DBG
("INQUIRY: UnsuµÜ‹d EVPD…ag%x", 
cmd
->
cdb
[2]);

4414 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 2, 0);

4415 
out_put
;

4418 ià(
cmd
->
cdb
[2] != 0) {

4419 
	`TRACE_DBG
("INQUIRY: UnsuµÜ‹d…ag%x", 
cmd
->
cdb
[2]);

4420 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 2, 0);

4421 
out_put
;

4423 
»¥_Ën
 = 
	`vdisk_šq
(
buf
, 
cmd
, 
vœt_dev
);

4426 
	`sBUG_ON
(
»¥_Ën
 > 
INQ_BUF_SZ
);

4428 ià(
Ëngth
 > 
»¥_Ën
)

4429 
Ëngth
 = 
»¥_Ën
;

4430 
	`memýy
(
add»ss
, 
buf
, 
Ëngth
);

4432 
out_put
:

4433 
	`sc¡_put_buf_fuÎ
(
cmd
, 
add»ss
);

4434 ià(
Ëngth
 < 
cmd
->
»¥_d©a_Ën
)

4435 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
Ëngth
);

4437 
out_ä“
:

4438 
	`kä“
(
buf
);

4440 
out
:

4441 
	`TRACE_EXIT
();

4442  
CMD_SUCCEEDED
;

4443 
	}
}

4445 
com¶_¡©us_e
 
	$vdisk_exec_»que¡_£n£
(
vdisk_cmd_·¿ms
 *
p
)

4447 
sc¡_cmd
 *
cmd
 = 
p
->cmd;

4448 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

4449 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

4450 
št32_t
 
Ëngth
, 
¦
;

4451 
ušt8_t
 *
add»ss
;

4452 
ušt8_t
 
b
[
SCST_STANDARD_SENSE_LEN
];

4454 
	`TRACE_ENTRY
();

4461 ià(
vœt_dev
->
fÜm©_aùive
) {

4462 
ušt64_t
 
d
, 
div
;

4463 
ušt16_t
 
v
;

4465 
div
 = 
vœt_dev
->
fÜm©_´og»ss_to_do
 >> 16;

4466 
d
 = 
vœt_dev
->
fÜm©_´og»ss_dÚe
;

4467 
	`do_div
(
d
, 
div
);

4468 
v
 = 
d
;

4470 
	`TRACE_DBG
("FÜm©…rog»s %d", 
v
);

4472 
¦
 = 
	`sc¡_£t_£n£
(
b
, (b), 
dev
->
d_£n£
,

4473 
	`SCST_LOAD_SENSE
(
sc¡_£n£_fÜm©_š_´og»ss
));

4475 
	`BUILD_BUG_ON
(
SCST_STANDARD_SENSE_LEN
 < 18);

4476 ià(
dev
->
d_£n£
) {

4477 
ušt8_t
 *
p
 = &
b
[7];

4478 
o
 = 8;

4479 *
p
 += 8;

4480 
b
[
o
] = 2;

4481 
b
[
o
+1] = 6;

4482 
b
[
o
+4] = 0x80;

4483 
	`put_uÇligÃd_be16
(
v
, &
b
[
o
+5]);

4485 
b
[15] = 0x80;

4486 
	`put_uÇligÃd_be16
(
v
, &
b
[16]);

4488 
	`TRACE_BUFF_FLAG
(
TRACE_DEBUG
, "FÜm© s’£", 
b
, (b));

4490 
¦
 = 
	`sc¡_£t_£n£
(
b
, (b), 
cmd
->
dev
->
d_£n£
,

4491 
	`SCST_LOAD_SENSE
(
sc¡_£n£_no_£n£
));

4493 
Ëngth
 = 
	`sc¡_g‘_buf_fuÎ_£n£
(
cmd
, &
add»ss
);

4494 
	`TRACE_DBG
("Ëngth %d", 
Ëngth
);

4495 ià(
Ëngth
 <= 0)

4496 
out
;

4498 
Ëngth
 = 
	`mš
(
¦
,†ength);

4499 
	`memýy
(
add»ss
, 
b
, 
Ëngth
);

4500 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
Ëngth
);

4502 
	`sc¡_put_buf_fuÎ
(
cmd
, 
add»ss
);

4504 
out
:

4505 
	`TRACE_EXIT
();

4506  
CMD_SUCCEEDED
;

4507 
	}
}

4509 
	$vdisk_”r_»cov_pg
(*
p
, 
pcÚŒÞ
,

4510 
sc¡_vdisk_dev
 *
vœt_dev
)

4512 cÚ¡ 
”r_»cov_pg
[] = {0x1, 0xa, 0xc0, 1, 0, 0, 0, 0,

4515 
	`memýy
(
p
, 
”r_»cov_pg
, (err_recov_pg));

4516 ià(
pcÚŒÞ
 == 1)

4517 
	`mem£t
(
p
 + 2, 0, (
”r_»cov_pg
) - 2);

4518  (
”r_»cov_pg
);

4519 
	}
}

4521 
	$vdisk_discÚÃù_pg
(*
p
, 
pcÚŒÞ
,

4522 
sc¡_vdisk_dev
 *
vœt_dev
)

4524 cÚ¡ 
discÚÃù_pg
[] = {0x2, 0xe, 128, 128, 0, 10, 0, 0,

4527 
	`memýy
(
p
, 
discÚÃù_pg
, (disconnect_pg));

4528 ià(
pcÚŒÞ
 == 1)

4529 
	`mem£t
(
p
 + 2, 0, (
discÚÃù_pg
) - 2);

4530  (
discÚÃù_pg
);

4531 
	}
}

4533 
	$vdisk_rigid_geo_pg
(*
p
, 
pcÚŒÞ
,

4534 
sc¡_vdisk_dev
 *
vœt_dev
)

4536 
geo_m_pg
[] = {0x04, 0x16, 0, 0, 0, 
DEF_HEADS
, 0, 0,

4539 
št32_t
 
ncyl
, 
n
, 
»m
;

4540 
ušt64_t
 
divid’d
;

4542 
	`memýy
(
p
, 
geo_m_pg
, (geo_m_pg));

4547 
divid’d
 = 
vœt_dev
->
nblocks
;

4548 
»m
 = 
	`do_div
(
divid’d
, 
DEF_HEADS
 * 
DEF_SECTORS
);

4549 
ncyl
 = 
divid’d
;

4550 ià(
»m
 != 0)

4551 
ncyl
++;

4552 
	`memýy
(&
n
, 
p
 + 2, (
u32
));

4553 
n
 =‚ | ((
__fÜû
 
u32
)
	`ýu_to_be32
(
ncyl
) >> 8);

4554 
	`memýy
(
p
 + 2, &
n
, (
u32
));

4555 ià(
pcÚŒÞ
 == 1)

4556 
	`mem£t
(
p
 + 2, 0, (
geo_m_pg
) - 2);

4557  (
geo_m_pg
);

4558 
	}
}

4560 
	$vdisk_fÜm©_pg
(*
p
, 
pcÚŒÞ
,

4561 
sc¡_vdisk_dev
 *
vœt_dev
)

4563 cÚ¡ 
fÜm©_pg
[] = {0x3, 0x16, 0, 0, 0, 0, 0, 0,

4567 
	`memýy
(
p
, 
fÜm©_pg
, (format_pg));

4568 
	`put_uÇligÃd_be16
(
DEF_SECTORS
, &
p
[10]);

4569 
	`put_uÇligÃd_be16
(
vœt_dev
->
dev
->
block_size
, &
p
[12]);

4570 ià(
pcÚŒÞ
 == 1)

4571 
	`mem£t
(
p
 + 2, 0, (
fÜm©_pg
) - 2);

4572  (
fÜm©_pg
);

4573 
	}
}

4575 
	$vdisk_ÿchšg_pg
(*
p
, 
pcÚŒÞ
,

4576 
sc¡_vdisk_dev
 *
vœt_dev
)

4579 cÚ¡ 
ÿchšg_pg
[] = {

4585 
	`memýy
(
p
, 
ÿchšg_pg
, (caching_pg));

4587 ià(!
vœt_dev
->
nv_ÿche
 && 
vdev_§ved_mode_·ges_’abËd
)

4588 
p
[0] |= 0x80;

4590 
pcÚŒÞ
) {

4592 
p
[2] |ð(
vœt_dev
->
wt_æag
 || vœt_dev->
nv_ÿche
è? 0 : 
WCE
;

4595 
	`mem£t
(
p
 + 2, 0, (
ÿchšg_pg
) - 2);

4596 ià(!
vœt_dev
->
nv_ÿche
)

4597 
p
[2] |ð
WCE
;

4600 
p
[2] |ð(
DEF_WRITE_THROUGH
 || 
vœt_dev
->
nv_ÿche
è? 0 : 
WCE
;

4603 
p
[2] |ð(
vœt_dev
->
wt_æag_§ved
 || vœt_dev->
nv_ÿche
è? 0 : 
WCE
;

4606 
	`sBUG
();

4610  (
ÿchšg_pg
);

4611 
	}
}

4613 
	$vdisk_ù¾_m_pg
(*
p
, 
pcÚŒÞ
,

4614 
sc¡_vdisk_dev
 *
vœt_dev
)

4616 
ù¾_m_pg
[] = {0xa, 0xa, 0, 0, 0, 0, 0, 0,

4619 ià(
vdev_§ved_mode_·ges_’abËd
)

4620 
ù¾_m_pg
[0] |= 0x80;

4622 
	`memýy
(
p
, 
ù¾_m_pg
, (ctrl_m_pg));

4623 
pcÚŒÞ
) {

4625 
p
[2] |ð
vœt_dev
->
dev
->
t¡
 << 5;

4626 
p
[2] |ð
vœt_dev
->
dev
->
d_£n£
 << 2;

4627 
p
[2] |ð
vœt_dev
->
dev
->
dpicz
 << 3;

4628 
p
[2] |ð
vœt_dev
->
dev
->
tmf_Úly
 << 4;

4629 
p
[3] |ð
vœt_dev
->
dev
->
queue_®g
 << 4;

4630 
p
[3] |ð
vœt_dev
->
dev
->
q”r
 << 1;

4631 
p
[4] |ð
vœt_dev
->
dev
->
swp
 << 3;

4632 
p
[5] |ð
vœt_dev
->
dev
->
s
 << 6;

4633 
p
[5] |ð
vœt_dev
->
dev
->
©o
 << 7;

4636 
	`mem£t
(
p
 + 2, 0, (
ù¾_m_pg
) - 2);

4642 
p
[2] |= 7 << 5;

4644 ià(!
vœt_dev
->
dev
->
þu¡”_mode
) {

4645 
p
[2] |= 1 << 2;

4646 
p
[2] |= 1 << 3;

4647 
p
[2] |= 1 << 4;

4648 
p
[3] |= 0xF << 4;

4649 
p
[3] |= 3 << 1;

4650 
p
[4] |= 1 << 3;

4651 
p
[5] |= 1 << 6;

4652 
p
[5] |= 0 << 7;

4656 
p
[2] |ð
vœt_dev
->
t¡
 << 5;

4657 
p
[2] |ð
vœt_dev
->
dev
->
d_£n£_deçuÉ
 << 2;

4658 
p
[2] |ð
vœt_dev
->
dev
->
dpicz_deçuÉ
 << 3;

4659 
p
[2] |ð
vœt_dev
->
dev
->
tmf_Úly_deçuÉ
 << 4;

4660 
p
[3] |ð
vœt_dev
->
dev
->
queue_®g_deçuÉ
 << 4;

4661 
p
[3] |ð
vœt_dev
->
dev
->
q”r_deçuÉ
 << 1;

4662 
p
[4] |ð
vœt_dev
->
dev
->
swp_deçuÉ
 << 3;

4663 
p
[5] |ð
vœt_dev
->
dev
->
s_deçuÉ
 << 6;

4664 
p
[5] |ð
vœt_dev
->
dev
->
©o
 << 7;

4667 
p
[2] |ð
vœt_dev
->
dev
->
t¡
 << 5;

4668 
p
[2] |ð
vœt_dev
->
dev
->
d_£n£_§ved
 << 2;

4669 
p
[2] |ð
vœt_dev
->
dev
->
dpicz_§ved
 << 3;

4670 
p
[2] |ð
vœt_dev
->
dev
->
tmf_Úly_deçuÉ
 << 4;

4671 
p
[3] |ð
vœt_dev
->
dev
->
queue_®g_§ved
 << 4;

4672 
p
[3] |ð
vœt_dev
->
dev
->
q”r_§ved
 << 1;

4673 
p
[4] |ð
vœt_dev
->
dev
->
swp_§ved
 << 3;

4674 
p
[5] |ð
vœt_dev
->
dev
->
s_§ved
 << 6;

4675 
p
[5] |ð
vœt_dev
->
dev
->
©o
 << 7;

4678 
	`sBUG
();

4680  (
ù¾_m_pg
);

4681 
	}
}

4683 
	$vdisk_›c_m_pg
(*
p
, 
pcÚŒÞ
,

4684 
sc¡_vdisk_dev
 *
vœt_dev
)

4686 cÚ¡ 
›c_m_pg
[] = {0x1c, 0xa, 0x08, 0, 0, 0, 0, 0,

4688 
	`memýy
(
p
, 
›c_m_pg
, (iec_m_pg));

4689 ià(
pcÚŒÞ
 == 1)

4690 
	`mem£t
(
p
 + 2, 0, (
›c_m_pg
) - 2);

4691  (
›c_m_pg
);

4692 
	}
}

4694 
com¶_¡©us_e
 
	$vdisk_exec_mode_£n£
(
vdisk_cmd_·¿ms
 *
p
)

4696 
sc¡_cmd
 *
cmd
 = 
p
->cmd;

4697 
št32_t
 
Ëngth
;

4698 
ušt8_t
 *
add»ss
;

4699 
ušt8_t
 *
buf
;

4700 
sc¡_vdisk_dev
 *
vœt_dev
;

4701 
ušt32_t
 
blocksize
;

4702 
ušt64_t
 
nblocks
;

4703 
dbd
, 
ty³
;

4704 
pcÚŒÞ
, 
pcode
, 
subpcode
;

4705 
dev_¥ec
;

4706 
m£n£_6
, 
off£t
 = 0, 
Ën
;

4707 *
bp
;

4709 
	`TRACE_ENTRY
();

4711 
buf
 = 
	`kz®loc
(
MSENSE_BUF_SZ
, 
cmd
->
cmd_gå_mask
);

4712 ià(
buf
 =ð
NULL
) {

4713 
	`sc¡_£t_busy
(
cmd
);

4714 
out
;

4717 
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

4718 
blocksize
 = 
cmd
->
dev
->
block_size
;

4719 
nblocks
 = 
vœt_dev
->nblocks;

4721 
ty³
 = 
cmd
->
dev
->type;

4722 
dbd
 = 
cmd
->
cdb
[1] & 
DBD
;

4723 
pcÚŒÞ
 = (
cmd
->
cdb
[2] & 0xc0) >> 6;

4724 
pcode
 = 
cmd
->
cdb
[2] & 0x3f;

4725 
subpcode
 = 
cmd
->
cdb
[3];

4726 
m£n£_6
 = (
cmd
->
cdb
[0] =ð
MODE_SENSE
);

4727 
dev_¥ec
 = 
cmd
->
tgt_dev
->
tgt_dev_rd_Úly
 ? 
WP
 : 0;

4729 ià(
ty³
 !ð
TYPE_ROM
)

4730 
dev_¥ec
 |ð
DPOFUA
;

4732 
Ëngth
 = 
	`sc¡_g‘_buf_fuÎ_£n£
(
cmd
, &
add»ss
);

4733 ià(
	`uÆik–y
(
Ëngth
 <= 0))

4734 
out_ä“
;

4736 ià(!
vdev_§ved_mode_·ges_’abËd
 && (
pcÚŒÞ
 == 0x3)) {

4737 
	`TRACE_DBG
("%s", "MODE SENSE: Saving values‚ot supported");

4738 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

4739 
	`SCST_LOAD_SENSE
(
sc¡_£n£_§všg_·¿ms_unsup
));

4740 
out_put
;

4743 ià(
m£n£_6
) {

4744 
buf
[1] = 
ty³
;

4745 
buf
[2] = 
dev_¥ec
;

4746 
off£t
 = 4;

4748 
buf
[2] = 
ty³
;

4749 
buf
[3] = 
dev_¥ec
;

4750 
off£t
 = 8;

4753 ià(
subpcode
 != 0) {

4755 
	`TRACE_DBG
("%s", "MODE SENSE: Only subpage 0 is supported");

4756 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 3, 0);

4757 
out_put
;

4760 ià(!
dbd
) {

4762 
buf
[
off£t
 - 1] = 0x08;

4763 
	`put_uÇligÃd_be32
(
nblocks
 >> 32 ? 0xffffffffU :‚blocks,

4764 &
buf
[
off£t
]);

4765 
buf
[
off£t
 + 4] = 0;

4766 
	`put_uÇligÃd_be24
(
blocksize
, &
buf
[
off£t
 + 5]);

4768 
off£t
 += 8;

4771 
bp
 = 
buf
 + 
off£t
;

4773 
pcode
) {

4775 
Ën
 = 
	`vdisk_”r_»cov_pg
(
bp
, 
pcÚŒÞ
, 
vœt_dev
);

4778 ià(
ty³
 =ð
TYPE_ROM
)

4779 
out_nÙ_sup
;

4780 
Ën
 = 
	`vdisk_discÚÃù_pg
(
bp
, 
pcÚŒÞ
, 
vœt_dev
);

4783 ià(
ty³
 =ð
TYPE_ROM
)

4784 
out_nÙ_sup
;

4785 
Ën
 = 
	`vdisk_fÜm©_pg
(
bp
, 
pcÚŒÞ
, 
vœt_dev
);

4788 ià(
ty³
 =ð
TYPE_ROM
)

4789 
out_nÙ_sup
;

4790 
Ën
 = 
	`vdisk_rigid_geo_pg
(
bp
, 
pcÚŒÞ
, 
vœt_dev
);

4793 ià(
ty³
 =ð
TYPE_ROM
)

4794 
out_nÙ_sup
;

4795 
Ën
 = 
	`vdisk_ÿchšg_pg
(
bp
, 
pcÚŒÞ
, 
vœt_dev
);

4798 
Ën
 = 
	`vdisk_ù¾_m_pg
(
bp
, 
pcÚŒÞ
, 
vœt_dev
);

4801 
Ën
 = 
	`vdisk_›c_m_pg
(
bp
, 
pcÚŒÞ
, 
vœt_dev
);

4804 ià(
ty³
 =ð
TYPE_ROM
) {

4805 
Ën
 = 
	`vdisk_”r_»cov_pg
(
bp
, 
pcÚŒÞ
, 
vœt_dev
);

4806 
Ën
 +ð
	`vdisk_ù¾_m_pg
(
bp
 +†’, 
pcÚŒÞ
, 
vœt_dev
);

4807 
Ën
 +ð
	`vdisk_›c_m_pg
(
bp
 +†’, 
pcÚŒÞ
, 
vœt_dev
);

4809 
Ën
 = 
	`vdisk_”r_»cov_pg
(
bp
, 
pcÚŒÞ
, 
vœt_dev
);

4810 
Ën
 +ð
	`vdisk_discÚÃù_pg
(
bp
 +†’, 
pcÚŒÞ
, 
vœt_dev
);

4811 
Ën
 +ð
	`vdisk_fÜm©_pg
(
bp
 +†’, 
pcÚŒÞ
, 
vœt_dev
);

4812 
Ën
 +ð
	`vdisk_ÿchšg_pg
(
bp
 +†’, 
pcÚŒÞ
, 
vœt_dev
);

4813 
Ën
 +ð
	`vdisk_ù¾_m_pg
(
bp
 +†’, 
pcÚŒÞ
, 
vœt_dev
);

4814 
Ën
 +ð
	`vdisk_›c_m_pg
(
bp
 +†’, 
pcÚŒÞ
, 
vœt_dev
);

4815 
Ën
 +ð
	`vdisk_rigid_geo_pg
(
bp
 +†’, 
pcÚŒÞ
, 
vœt_dev
);

4819 
out_nÙ_sup
;

4822 
off£t
 +ð
Ën
;

4824 ià(
m£n£_6
)

4825 
buf
[0] = 
off£t
 - 1;

4827 
	`put_uÇligÃd_be16
(
off£t
 - 2, &
buf
[0]);

4829 ià(
off£t
 > 
Ëngth
)

4830 
off£t
 = 
Ëngth
;

4831 
	`memýy
(
add»ss
, 
buf
, 
off£t
);

4833 
out_put
:

4834 
	`sc¡_put_buf_fuÎ
(
cmd
, 
add»ss
);

4835 ià(
off£t
 < 
cmd
->
»¥_d©a_Ën
)

4836 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
off£t
);

4838 
out_ä“
:

4839 
	`kä“
(
buf
);

4841 
out
:

4842 
	`TRACE_EXIT
();

4843  
CMD_SUCCEEDED
;

4845 
out_nÙ_sup
:

4846 
	`TRACE
(
TRACE_MINOR
, "MODE SENSE: UnsuµÜ‹d…ag%x", 
pcode
);

4847 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 2, 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 0);

4848 
out_put
;

4849 
	}
}

4851 
	$vdisk_£t_wt
(
sc¡_vdisk_dev
 *
vœt_dev
, 
wt
, 
boÞ
 
»ad_Úly
)

4853 
»s
 = 0;

4854 
fže
 *
fd
, *
dif_fd
 = 
NULL
;

4855 
boÞ
 
Þd_wt
 = 
vœt_dev
->
wt_æag
;

4857 
	`TRACE_ENTRY
();

4859 ià((
vœt_dev
->
wt_æag
 =ð
wt
è|| vœt_dev->
nuÎio
 || vœt_dev->
nv_ÿche
)

4860 
out
;

4862 
	`¥š_lock
(&
vœt_dev
->
æags_lock
);

4863 
vœt_dev
->
wt_æag
 = 
wt
;

4864 
	`¥š_uÆock
(&
vœt_dev
->
æags_lock
);

4866 ià(
vœt_dev
->
fd
 =ð
NULL
)

4867 
out
;

4874 
fd
 = 
	`vdev_Ý’_fd
(
vœt_dev
, vœt_dev->
fž’ame
, 
»ad_Úly
);

4875 ià(
	`IS_ERR
(
fd
)) {

4876 
»s
 = 
	`PTR_ERR
(
fd
);

4877 
out_”r
;

4880 ià(
vœt_dev
->
dif_fž’ame
 !ð
NULL
) {

4881 
dif_fd
 = 
	`vdev_Ý’_fd
(
vœt_dev
, vœt_dev->
dif_fž’ame
, 
»ad_Úly
);

4882 ià(
	`IS_ERR
(
dif_fd
)) {

4883 
»s
 = 
	`PTR_ERR
(
dif_fd
);

4884 
out_”r_þo£_fd
;

4888 
	`fžp_þo£
(
vœt_dev
->
fd
, 
NULL
);

4889 ià(
vœt_dev
->
dif_fd
)

4890 
	`fžp_þo£
(
vœt_dev
->
dif_fd
, 
NULL
);

4892 
vœt_dev
->
fd
 = fd;

4893 
vœt_dev
->
dif_fd
 = dif_fd;

4895 
out
:

4896 
	`TRACE_EXIT_RES
(
»s
);

4897  
»s
;

4899 
out_”r_þo£_fd
:

4900 
	`fžp_þo£
(
fd
, 
NULL
);

4902 
out_”r
:

4903 
	`¥š_lock
(&
vœt_dev
->
æags_lock
);

4904 
vœt_dev
->
wt_æag
 = 
Þd_wt
;

4905 
	`¥š_uÆock
(&
vœt_dev
->
æags_lock
);

4906 
out
;

4907 
	}
}

4909 
	$vdisk_ù¾_m_pg_£Ëù
(*
p
,

4910 
sc¡_vdisk_dev
 *
vœt_dev
, 
sc¡_cmd
 *
cmd
, 
boÞ
 
§ve
,

4911 
·¿m_off£t
)

4913 
sc¡_deviû
 *
dev
 = 
vœt_dev
->dev;

4914 
Þd_swp
 = 
dev
->
swp
, 
Þd_s
 = dev->
s
, 
Þd_d£n£
 = dev->
d_£n£
;

4915 
Þd_queue_®g
 = 
dev
->
queue_®g
, 
Þd_dpicz
 = dev->
dpicz
;

4916 
rc
, 
Þd_tmf_Úly
 = 
dev
->
tmf_Úly
, 
Þd_q”r
 = dev->
q”r
;

4917 
queue_®g
, 
swp
, 
s
, 
tmf_Úly
, 
q”r
, 
d_£n£
, 
dpicz
;

4919 
	`TRACE_ENTRY
();

4921 ià(
§ve
 && !
vdev_§ved_mode_·ges_’abËd
) {

4922 
	`TRACE
(
TRACE_MINOR
|
TRACE_SCSI
, "MODE SELECT: saved control…age "

4924 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 2,

4925 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 1);

4926 
out
;

4935 
dev
->
t¡
 = (
p
[2] >> 5) & 7;

4938 ià(
dev
->
t¡
 !ð((
p
[2] >> 5) & 7)) {

4939 
	`TRACE
(
TRACE_MINOR
|
TRACE_SCSI
, "%s", "MODE SELECT: Changing of "

4941 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 
·¿m_off£t
 + 2,

4942 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 5);

4943 
out
;

4947 
queue_®g
 = 
p
[3] >> 4;

4948 ià((
queue_®g
 !ð
SCST_QUEUE_ALG_0_RESTRICTED_REORDER
) &&

4949 (
queue_®g
 !ð
SCST_QUEUE_ALG_1_UNRESTRICTED_REORDER
)) {

4950 
	`PRINT_WARNING
("Attempto set invalid Control mode…age QUEUE "

4952 
queue_®g
, 
cmd
->
£ss
->
š™ŸtÜ_Çme
, 
dev
->
vœt_Çme
);

4953 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 
·¿m_off£t
 + 3,

4954 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 4);

4955 
out
;

4958 
swp
 = (
p
[4] & 0x8) >> 3;

4959 ià(
swp
 > 1) {

4960 
	`PRINT_WARNING
("Attempto set invalid Control mode…age SWP "

4961 "v®u%d (š™ŸtÜ %s, dev %s)", 
swp
,

4962 
cmd
->
£ss
->
š™ŸtÜ_Çme
, 
dev
->
vœt_Çme
);

4963 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 
·¿m_off£t
 + 4,

4964 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 3);

4965 
out
;

4968 
s
 = (
p
[5] & 0x40) >> 6;

4969 ià(
s
 > 1) {

4970 
	`PRINT_WARNING
("Attempto set invalid Control mode…age TAS "

4971 "v®u%d (š™ŸtÜ %s, dev %s)", 
s
,

4972 
cmd
->
£ss
->
š™ŸtÜ_Çme
, 
dev
->
vœt_Çme
);

4973 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 
·¿m_off£t
 + 5,

4974 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 6);

4975 
out
;

4978 
tmf_Úly
 = (
p
[2] & 0x10) >> 4;

4979 ià(
tmf_Úly
 > 1) {

4980 
	`PRINT_WARNING
("Attempto set invalid Control mode…age "

4981 "TMF_ONLY v®u%d (š™ŸtÜ %s, dev %s)", 
tmf_Úly
,

4982 
cmd
->
£ss
->
š™ŸtÜ_Çme
, 
dev
->
vœt_Çme
);

4983 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 
·¿m_off£t
 + 2,

4984 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 4);

4985 
out
;

4988 
dpicz
 = (
p
[2] & 0x8) >> 3;

4989 ià(
dpicz
 > 1) {

4990 
	`PRINT_WARNING
("Attempto set invalid Control mode…age "

4991 "dpicz v®u%d (š™ŸtÜ %s, dev %s)", 
dpicz
,

4992 
cmd
->
£ss
->
š™ŸtÜ_Çme
, 
dev
->
vœt_Çme
);

4993 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 
·¿m_off£t
 + 2,

4994 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 3);

4995 
out
;

4998 
q”r
 = (
p
[3] & 0x6) >> 1;

4999 ià((
q”r
 =ð
SCST_QERR_2_RESERVED
) ||

5000 (
q”r
 > 
SCST_QERR_3_ABORT_THIS_NEXUS_ONLY
)) {

5001 
	`PRINT_WARNING
("Attempto set invalid Control mode…age QErr "

5002 "v®u%d (š™ŸtÜ %s, dev %s)", 
q”r
,

5003 
cmd
->
£ss
->
š™ŸtÜ_Çme
, 
dev
->
vœt_Çme
);

5004 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 
·¿m_off£t
 + 3,

5005 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 1);

5006 
out
;

5009 
d_£n£
 = (
p
[2] & 0x4) >> 2;

5010 ià(
d_£n£
 > 1) {

5011 
	`PRINT_WARNING
("Attempto set invalid Control mode…age D_SENSE "

5012 "v®u%d (š™ŸtÜ %s, dev %s)", 
d_£n£
,

5013 
cmd
->
£ss
->
š™ŸtÜ_Çme
, 
dev
->
vœt_Çme
);

5014 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 
·¿m_off£t
 + 2,

5015 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 2);

5016 
out
;

5019 
dev
->
queue_®g
 = queue_alg;

5020 
dev
->
swp
 = swp;

5021 
dev
->
s
 =as;

5022 
dev
->
tmf_Úly
 =mf_only;

5023 
dev
->
dpicz
 = dpicz;

5024 
dev
->
q”r
 = qerr;

5025 
dev
->
d_£n£
 = d_sense;

5027 ià((
dev
->
swp
 =ð
Þd_swp
è&& (dev->
s
 =ð
Þd_s
) &&

5028 (
dev
->
d_£n£
 =ð
Þd_d£n£
è&& (dev->
queue_®g
 =ð
Þd_queue_®g
) &&

5029 (
dev
->
q”r
 =ð
Þd_q”r
è&& (dev->
tmf_Úly
 =ð
Þd_tmf_Úly
) &&

5030 (
dev
->
dpicz
 =ð
Þd_dpicz
))

5031 
out
;

5033 ià(!
§ve
)

5034 
out_ok
;

5036 
rc
 = 
	`vdev_§ve_mode_·ges
(
vœt_dev
);

5037 ià(
rc
 != 0) {

5038 
dev
->
swp
 = 
Þd_swp
;

5039 
dev
->
s
 = 
Þd_s
;

5040 
dev
->
d_£n£
 = 
Þd_d£n£
;

5041 
dev
->
queue_®g
 = 
Þd_queue_®g
;

5042 
dev
->
tmf_Úly
 = 
Þd_tmf_Úly
;

5043 
dev
->
q”r
 = 
Þd_q”r
;

5044 
dev
->
dpicz
 = 
Þd_dpicz
;

5046 
	`sc¡_£t_busy
(
cmd
);

5047 
out
;

5050 
dev
->
swp_§ved
 = dev->
swp
;

5051 
dev
->
s_§ved
 = dev->
s
;

5052 
dev
->
d_£n£_§ved
 = dev->
d_£n£
;

5053 
dev
->
queue_®g_§ved
 = dev->
queue_®g
;

5054 
dev
->
tmf_Úly_§ved
 = dev->
tmf_Úly
;

5055 
dev
->
q”r_§ved
 = dev->
q”r
;

5056 
dev
->
dpicz_§ved
 = dev->
dpicz
;

5058 
out_ok
:

5059 
	`PRINT_INFO
("Device %s:‚ew control mode…age…arameters: SWP %x "

5062 "DPICZ %d (wa %d)", 
vœt_dev
->
Çme
, 
dev
->
swp
, 
Þd_swp
,

5063 
dev
->
s
, 
Þd_s
, dev->
tmf_Úly
, 
Þd_tmf_Úly
, dev->
q”r
,

5064 
Þd_q”r
, 
dev
->
d_£n£
, 
Þd_d£n£
, dev->
queue_®g
,

5065 
Þd_queue_®g
, 
dev
->
dpicz
, 
Þd_dpicz
);

5067 
out
:

5068 
	`TRACE_EXIT
();

5070 
	}
}

5072 
	$vdisk_ÿchšg_m_pg_£Ëù
(*
p
,

5073 
sc¡_vdisk_dev
 *
vœt_dev
, 
sc¡_cmd
 *
cmd
, 
boÞ
 
§ve
,

5074 
boÞ
 
»ad_Úly
)

5076 
Þd_wt
 = 
vœt_dev
->
wt_æag
, 
Ãw_wt
, 
rc
;

5078 
	`TRACE_ENTRY
();

5080 ià(
§ve
 && (!
vdev_§ved_mode_·ges_’abËd
 || 
vœt_dev
->
nv_ÿche
)) {

5081 
	`TRACE
(
TRACE_MINOR
|
TRACE_SCSI
, "MODE SELECT: saved cache…age "

5083 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 1,

5084 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 0);

5085 
out
;

5088 
Ãw_wt
 = (
p
[2] & 
WCE
) ? 0 : 1;

5090 ià(
Ãw_wt
 =ð
Þd_wt
)

5091 
out
;

5093 ià(
	`vdisk_£t_wt
(
vœt_dev
, 
Ãw_wt
, 
»ad_Úly
) != 0) {

5094 
	`sc¡_£t_busy
(
cmd
);

5095 
out
;

5098 ià(!
§ve
)

5099 
out_ok
;

5101 
rc
 = 
	`vdev_§ve_mode_·ges
(
vœt_dev
);

5102 ià(
rc
 != 0) {

5103 
	`vdisk_£t_wt
(
vœt_dev
, 
Þd_wt
, 
»ad_Úly
);

5105 
	`sc¡_£t_busy
(
cmd
);

5106 
out
;

5109 
vœt_dev
->
wt_æag_§ved
 = vœt_dev->
wt_æag
;

5111 
out_ok
:

5112 
	`PRINT_INFO
("Deviû %s:‚ew wt_æag: %x (wa %x)", 
vœt_dev
->
Çme
,

5113 
vœt_dev
->
wt_æag
, 
Þd_wt
);

5115 
out
:

5116 
	`TRACE_EXIT
();

5118 
	}
}

5120 
com¶_¡©us_e
 
	$vdisk_exec_mode_£Ëù
(
vdisk_cmd_·¿ms
 *
p
)

5122 
sc¡_cmd
 *
cmd
 = 
p
->cmd;

5123 
št32_t
 
Ëngth
;

5124 
ušt8_t
 *
add»ss
;

5125 
sc¡_vdisk_dev
 *
vœt_dev
;

5126 
m£Ëù_6
, 
off£t
, 
bdl
, 
ty³
;

5128 
	`TRACE_ENTRY
();

5130 
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

5131 ià(
cmd
->
dev
->
þu¡”_mode
) {

5132 
	`PRINT_ERROR
("MODE SELECT:‚ot supported in cluster mode\n");

5133 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

5134 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

5135 
out
;

5138 
m£Ëù_6
 = (
cmd
->
cdb
[0] =ð
MODE_SELECT
);

5139 
ty³
 = 
cmd
->
dev
->type;

5141 
Ëngth
 = 
	`sc¡_g‘_buf_fuÎ_£n£
(
cmd
, &
add»ss
);

5142 ià(
	`uÆik–y
(
Ëngth
 <= 0))

5143 
out
;

5145 ià(!(
cmd
->
cdb
[1] & 
PF
)) {

5146 
	`TRACE
(
TRACE_MINOR
|
TRACE_SCSI
, "MODE SELECT: Unsupported "

5147 "PF b™ z”Ø(cdb[1]=%x)", 
cmd
->
cdb
[1]);

5148 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 1, 0);

5149 
out_put
;

5152 ià(
m£Ëù_6
) {

5153 
bdl
 = 
add»ss
[3];

5154 
off£t
 = 4;

5156 
bdl
 = 
	`g‘_uÇligÃd_be16
(&
add»ss
[6]);

5157 
off£t
 = 8;

5160 ià(
bdl
 == 8)

5161 
off£t
 += 8;

5162 ià(
bdl
 != 0) {

5163 
	`PRINT_ERROR
("%s", "MODE SELECT: Wrong…arameters†ist†ength");

5164 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 
off£t
-1, 0);

5165 
out_put
;

5168 
Ëngth
 > 
off£t
 + 2) {

5169 ià(
add»ss
[
off£t
] & 
PS
) {

5170 
	`PRINT_ERROR
("%s", "MODE SELECT: Illegal PS bit");

5171 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 
off£t
,

5172 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 7);

5173 
out_put
;

5175 ià(((
add»ss
[
off£t
] & 0x3fè=ð0x8è&& (
ty³
 !ð
TYPE_ROM
)) {

5177 ià(
add»ss
[
off£t
 + 1] != 18) {

5178 
	`PRINT_ERROR
("%s", "MODE SELECT: Invalid "

5180 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 
off£t
+1, 0);

5181 
out_put
;

5183 
	`vdisk_ÿchšg_m_pg_£Ëù
(&
add»ss
[
off£t
], 
vœt_dev
,

5184 
cmd
, cmd->
cdb
[1] & 
SP
, cmd->
tgt_dev
->
tgt_dev_rd_Úly
);

5186 } ià((
add»ss
[
off£t
] & 0x3f) == 0xA) {

5188 ià(
add»ss
[
off£t
 + 1] != 0xA) {

5189 
	`PRINT_ERROR
("%s", "MODE SELECT: Invalid "

5191 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 
off£t
+1, 0);

5192 
out_put
;

5194 
	`vdisk_ù¾_m_pg_£Ëù
(&
add»ss
[
off£t
], 
vœt_dev
, 
cmd
,

5195 
cmd
->
cdb
[1] & 
SP
, 
off£t
);

5197 
	`TRACE
(
TRACE_MINOR
, "MODE SELECT: Invalid„equest %x",

5198 
add»ss
[
off£t
] & 0x3f);

5199 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 
off£t
,

5200 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 0);

5201 
out_put
;

5203 
off£t
 +ð
add»ss
[offset + 1];

5206 
out_put
:

5207 
	`sc¡_put_buf_fuÎ
(
cmd
, 
add»ss
);

5209 
out
:

5210 
	`TRACE_EXIT
();

5211  
CMD_SUCCEEDED
;

5212 
	}
}

5214 
com¶_¡©us_e
 
	$vdisk_exec_log
(
vdisk_cmd_·¿ms
 *
p
)

5216 
sc¡_cmd
 *
cmd
 = 
p
->cmd;

5218 
	`TRACE_ENTRY
();

5221 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 2, 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 0);

5223 
	`TRACE_EXIT
();

5224  
CMD_SUCCEEDED
;

5225 
	}
}

5227 
com¶_¡©us_e
 
	$vdisk_exec_»ad_ÿ·c™y
(
vdisk_cmd_·¿ms
 *
p
)

5229 
sc¡_cmd
 *
cmd
 = 
p
->cmd;

5230 
št32_t
 
Ëngth
;

5231 
ušt8_t
 *
add»ss
;

5232 
sc¡_vdisk_dev
 *
vœt_dev
;

5233 
ušt32_t
 
blocksize
;

5234 
ušt64_t
 
nblocks
;

5235 
ušt8_t
 
bufãr
[8];

5237 
	`TRACE_ENTRY
();

5239 
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

5240 
blocksize
 = 
cmd
->
dev
->
block_size
;

5241 
nblocks
 = 
vœt_dev
->nblocks;

5243 ià((
cmd
->
cdb
[8] & 1) == 0) {

5244 
ušt32_t
 
lba
 = 
	`g‘_uÇligÃd_be32
(&
cmd
->
cdb
[2]);

5246 ià(
lba
 != 0) {

5247 
	`TRACE_DBG
("PMI z”Øªd LBA‚Ù z”Ø(cmd %p)", 
cmd
);

5248 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 2, 0);

5249 
out
;

5253 
	`mem£t
(
bufãr
, 0, (buffer));

5262 
	`put_uÇligÃd_be32
(
nblocks
 >> 32 || 
vœt_dev
->
thš_´ovisiÚed
 ?

5263 0xffffffffU : 
nblocks
 - 1, &
bufãr
[0]);

5265 
	`put_uÇligÃd_be32
((
nblocks
 >> 32è? 0xffffffffU :‚block - 1, &
bufãr
[0]);

5268 
	`put_uÇligÃd_be32
(
blocksize
, &
bufãr
[4]);

5270 
Ëngth
 = 
	`sc¡_g‘_buf_fuÎ_£n£
(
cmd
, &
add»ss
);

5271 ià(
	`uÆik–y
(
Ëngth
 <= 0))

5272 
out
;

5274 
Ëngth
 = 
	`mš_t
(,†’gth, (
bufãr
));

5276 
	`memýy
(
add»ss
, 
bufãr
, 
Ëngth
);

5278 
	`sc¡_put_buf_fuÎ
(
cmd
, 
add»ss
);

5280 ià(
Ëngth
 < 
cmd
->
»¥_d©a_Ën
)

5281 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
Ëngth
);

5283 
out
:

5284 
	`TRACE_EXIT
();

5285  
CMD_SUCCEEDED
;

5286 
	}
}

5288 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 31)

5293 
šlše
 
	$queue_physiÿl_block_size
(
»que¡_queue
 *
q
)

5296 
	}
}

5299 
com¶_¡©us_e
 
	$vdisk_exec_»ad_ÿ·c™y16
(
vdisk_cmd_·¿ms
 *
p
)

5301 
sc¡_cmd
 *
cmd
 = 
p
->cmd;

5302 
št32_t
 
Ëngth
;

5303 
ušt8_t
 *
add»ss
;

5304 
sc¡_vdisk_dev
 *
vœt_dev
;

5305 
block_deviû
 *
bdev
;

5306 
»que¡_queue
 *
q
;

5307 
ušt32_t
 
blocksize
, 
physiÿl_blocksize
;

5308 
ušt64_t
 
nblocks
;

5309 
ušt8_t
 
bufãr
[32];

5311 
	`TRACE_ENTRY
();

5313 
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

5314 
bdev
 = 
vœt_dev
->bdev;

5315 
q
 = 
bdev
 ? 
	`bdev_g‘_queue
(bdevè: 
NULL
;

5316 
blocksize
 = 
cmd
->
dev
->
block_size
;

5317 
nblocks
 = 
vœt_dev
->nblocks - 1;

5319 ià((
cmd
->
cdb
[14] & 1) == 0) {

5320 
ušt32_t
 
lba
 = 
	`g‘_uÇligÃd_be32
(&
cmd
->
cdb
[2]);

5322 ià(
lba
 != 0) {

5323 
	`TRACE_DBG
("PMI z”Øªd LBA‚Ù z”Ø(cmd %p)", 
cmd
);

5324 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 2, 0);

5325 
out
;

5329 
	`mem£t
(
bufãr
, 0, (buffer));

5331 
	`put_uÇligÃd_be64
(
nblocks
, &
bufãr
[0]);

5332 
	`put_uÇligÃd_be32
(
blocksize
, &
bufãr
[8]);

5334 ià(
cmd
->
dev
->
dev_dif_mode
 !ð
SCST_DIF_MODE_NONE
) {

5335 
cmd
->
dev
->
dev_dif_ty³
) {

5337 
bufãr
[12] = 1;

5340 
bufãr
[12] = 3;

5343 
bufãr
[12] = 5;

5346 
	`sBUG_ON
(1);

5352 
physiÿl_blocksize
 = 
q
 ? 
	`queue_physiÿl_block_size
(q) : 4096;

5353 
bufãr
[13] = 
	`max
(
	`žog2
(
physiÿl_blocksize
è- ilog2(
blocksize
), 0);

5355 ià(
vœt_dev
->
thš_´ovisiÚed
) {

5356 
bufãr
[14] |= 0x80;

5357 ià(
vœt_dev
->
disÿrd_z”Ûs_d©a
)

5358 
bufãr
[14] |= 0x40;

5361 
Ëngth
 = 
	`sc¡_g‘_buf_fuÎ_£n£
(
cmd
, &
add»ss
);

5362 ià(
	`uÆik–y
(
Ëngth
 <= 0))

5363 
out
;

5365 
Ëngth
 = 
	`mš_t
(,†’gth, (
bufãr
));

5367 
	`memýy
(
add»ss
, 
bufãr
, 
Ëngth
);

5369 
	`sc¡_put_buf_fuÎ
(
cmd
, 
add»ss
);

5371 ià(
Ëngth
 < 
cmd
->
»¥_d©a_Ën
)

5372 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
Ëngth
);

5374 
out
:

5375 
	`TRACE_EXIT
();

5376  
CMD_SUCCEEDED
;

5377 
	}
}

5379 
com¶_¡©us_e
 
	$vdisk_exec_g‘_lba_¡©us
(
vdisk_cmd_·¿ms
 *
p
)

5382 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
p
->
cmd
, 1,

5383 0 | 
SCST_INVAL_FIELD_BIT_OFFS_VALID
);

5384  
CMD_SUCCEEDED
;

5385 
	}
}

5388 
com¶_¡©us_e
 
	$vdisk_exec_»pÜt_gs
(
vdisk_cmd_·¿ms
 *
p
)

5390 
sc¡_cmd
 *
cmd
 = 
p
->cmd;

5391 
sc¡_deviû
 *
dev
;

5392 
ušt8_t
 *
add»ss
;

5393 *
buf
;

5394 
št32_t
 
buf_Ën
;

5395 
ušt32_t
 
d©a_Ëngth
, 
Ëngth
;

5396 
ušt8_t
 
d©a_fÜm©
;

5397 
»s
;

5399 
	`TRACE_ENTRY
();

5401 
buf_Ën
 = 
	`sc¡_g‘_buf_fuÎ_£n£
(
cmd
, &
add»ss
);

5402 ià(
buf_Ën
 <= 0)

5403 
out
;

5405 
dev
 = 
cmd
->dev;

5406 
d©a_fÜm©
 = 
cmd
->
cdb
[1] >> 5;

5408 
»s
 = 
	`sc¡_tg_g‘_group_šfo
(&
buf
, &
d©a_Ëngth
, 
dev
, 
d©a_fÜm©
);

5409 ià(
»s
 =ð-
ENOMEM
) {

5410 
	`sc¡_£t_busy
(
cmd
);

5411 
out_put
;

5412 } ià(
»s
 < 0) {

5413 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

5414 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

5415 
out_put
;

5418 
Ëngth
 = 
	`mš_t
(
ušt32_t
, 
d©a_Ëngth
, 
buf_Ën
);

5419 
	`memýy
(
add»ss
, 
buf
, 
Ëngth
);

5420 
	`kä“
(
buf
);

5421 ià(
Ëngth
 < 
cmd
->
»¥_d©a_Ën
)

5422 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
Ëngth
);

5424 
out_put
:

5425 
	`sc¡_put_buf_fuÎ
(
cmd
, 
add»ss
);

5427 
out
:

5428 
	`TRACE_EXIT
();

5429  
CMD_SUCCEEDED
;

5430 
	}
}

5433 
com¶_¡©us_e
 
	$vdisk_exec_£t_gs
(
vdisk_cmd_·¿ms
 *
p
)

5435 
sc¡_cmd
 *
cmd
 = 
p
->cmd;

5436 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

5437 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

5438 
»s
 = 
CMD_SUCCEEDED
, 
rc
;

5440 
	`TRACE_ENTRY
();

5442 ià(!
vœt_dev
->
ex¶_®ua
) {

5443 
	`PRINT_ERROR
("SET TARGET PORT GROUPS:‚otƒxplicit ALUA mode "

5444 "(dev %s)", 
dev
->
vœt_Çme
);

5446 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 1,

5447 0 | 
SCST_INVAL_FIELD_BIT_OFFS_VALID
);

5448 
out
;

5451 
rc
 = 
	`sc¡_tg_£t_group_šfo
(
cmd
);

5452 ià(
rc
 == 0)

5453 
»s
 = 
RUNNING_ASYNC
;

5455 
	`sc¡_¡pg_d–_unblock_Ãxt
(
cmd
);

5457 
out
:

5458 
	`TRACE_EXIT_RES
(
»s
);

5459  
»s
;

5460 
	}
}

5462 
com¶_¡©us_e
 
	$vdisk_exec_»ad_toc
(
vdisk_cmd_·¿ms
 *
p
)

5464 
sc¡_cmd
 *
cmd
 = 
p
->cmd;

5465 
št32_t
 
Ëngth
, 
off
 = 0;

5466 
ušt8_t
 *
add»ss
;

5467 
sc¡_vdisk_dev
 *
vœt_dev
;

5468 
ušt32_t
 
nblocks
;

5469 
ušt8_t
 
bufãr
[4+8+8] = { 0x00, 0x0a, 0x01, 0x01, 0x00, 0x14,

5472 
	`TRACE_ENTRY
();

5474 ià(
cmd
->
dev
->
ty³
 !ð
TYPE_ROM
) {

5475 
	`PRINT_ERROR
("%s", "READ TOC for‚on-CDROM device");

5476 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

5477 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

5478 
out
;

5481 ià(
cmd
->
cdb
[2] & 0x0e ) {

5482 
	`PRINT_ERROR
("%s", "READ TOC: invalid„equested data format");

5483 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 2,

5484 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 5);

5485 
out
;

5488 ià((
cmd
->
cdb
[6] != 0 && (cmd->cdb[2] & 0x01)) ||

5489 (
cmd
->
cdb
[6] > 1 && cmd->cdb[6] != 0xAA)) {

5490 
	`PRINT_ERROR
("READ TOC: invalid„equestedrack‚umber %x",

5491 
cmd
->
cdb
[6]);

5492 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 6, 0);

5493 
out
;

5496 
Ëngth
 = 
	`sc¡_g‘_buf_fuÎ_£n£
(
cmd
, &
add»ss
);

5497 ià(
	`uÆik–y
(
Ëngth
 <= 0))

5498 
out
;

5500 
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

5502 
nblocks
 = (
ušt32_t
)
vœt_dev
->nblocks;

5505 
	`mem£t
(
bufãr
, 0, (buffer));

5506 
bufãr
[2] = 0x01;

5507 
bufãr
[3] = 0x01;

5508 
off
 = 4;

5509 ià(
cmd
->
cdb
[6] <= 1) {

5515 
bufãr
[
off
+1] = 0x14;

5517 
bufãr
[
off
+2] = 0x01;

5518 
off
 += 8;

5520 ià(!(
cmd
->
cdb
[2] & 0x01)) {

5522 
bufãr
[
off
+1] = 0x14;

5524 
bufãr
[
off
+2] = 0xAA;

5526 
	`put_uÇligÃd_be32
(
nblocks
, &
bufãr
[
off
 + 4]);

5527 
off
 += 8;

5530 
bufãr
[1] = 
off
 - 2;

5532 ià(
off
 > 
Ëngth
)

5533 
off
 = 
Ëngth
;

5534 
	`memýy
(
add»ss
, 
bufãr
, 
off
);

5536 
	`sc¡_put_buf_fuÎ
(
cmd
, 
add»ss
);

5538 ià(
off
 < 
cmd
->
»¥_d©a_Ën
)

5539 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
off
);

5541 
out
:

5542 
	`TRACE_EXIT
();

5543  
CMD_SUCCEEDED
;

5544 
	}
}

5546 
com¶_¡©us_e
 
	$vdisk_exec_´ev’t_®low_medium_»mov®
(
vdisk_cmd_·¿ms
 *
p
)

5548 
sc¡_cmd
 *
cmd
 = 
p
->cmd;

5549 
sc¡_vdisk_dev
 *
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

5551 
	`TRACE_DBG
("PERSIST/PREVENT 0x%02x", 
cmd
->
cdb
[4]);

5553 
	`¥š_lock
(&
vœt_dev
->
æags_lock
);

5554 
vœt_dev
->
´ev’t_®low_medium_»mov®
 = 
cmd
->
cdb
[4] & 0x01 ? 1 : 0;

5555 
	`¥š_uÆock
(&
vœt_dev
->
æags_lock
);

5557  
CMD_SUCCEEDED
;

5558 
	}
}

5560 
	$__vdisk_fsync_fžeio
(
loff_t
 
loff
,

5561 
loff_t
 
Ën
, 
sc¡_deviû
 *
dev
, 
sc¡_cmd
 *
cmd
,

5562 
fže
 *file)

5564 
»s
;

5566 
	`TRACE_ENTRY
();

5575 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 32)

5576 
»s
 = 
	`sync_·ge_¿nge
(
	`fže_šode
(
fže
), fže->
f_m­pšg
, 
loff
, 
Ën
);

5579 
»s
 = 
	`g’”ic_wr™e_sync
(
fže
, 
loff
, 
Ën
);

5581 
»s
 = 
	`fžem­_wr™e_ªd_wa™_¿nge
(
fže
->
f_m­pšg
, 
loff
, 
Ën
);

5584 ià(
	`uÆik–y
(
»s
 != 0)) {

5585 
	`PRINT_ERROR
("synø¿ngçžed (%d)", 
»s
);

5586 ià(
cmd
 !ð
NULL
) {

5587 ià(
»s
 =ð-
ENOMEM
)

5588 
	`sc¡_£t_busy
(
cmd
);

5590 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

5591 
	`SCST_LOAD_SENSE
(
sc¡_£n£_wr™e_”rÜ
));

5595 
	`TRACE_EXIT_RES
(
»s
);

5596  
»s
;

5597 
	}
}

5599 
	$vdisk_fsync_blockio
(
loff_t
 
loff
,

5600 
loff_t
 
Ën
, 
sc¡_deviû
 *
dev
, 
gå_t
 
gå_æags
,

5601 
sc¡_cmd
 *
cmd
, 
boÞ
 
async
)

5603 
»s
;

5604 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

5606 
	`TRACE_ENTRY
();

5613 
	`EXTRACHECKS_BUG_ON
(!
vœt_dev
->
blockio
);

5616 ià(
vœt_dev
->
dif_fd
 !ð
NULL
) {

5617 
loff
 = (lofà>> 
dev
->
block_shiá
è<< 
SCST_DIF_TAG_SHIFT
;

5618 
Ën
 = (ËÀ>> 
dev
->
block_shiá
è<< 
SCST_DIF_TAG_SHIFT
;

5619 
»s
 = 
	`__vdisk_fsync_fžeio
(
loff
, 
Ën
, 
dev
, 
cmd
,

5620 
vœt_dev
->
dif_fd
);

5621 ià(
	`uÆik–y
(
»s
 != 0))

5622 
out
;

5625 
»s
 = 
	`vdisk_blockio_æush
(
vœt_dev
->
bdev
, 
gå_æags
, 
Œue
,

5626 
cmd
, 
async
);

5628 
out
:

5629 
	`TRACE_EXIT_RES
(
»s
);

5630  
»s
;

5631 
	}
}

5633 
	$vdisk_fsync_fžeio
(
loff_t
 
loff
,

5634 
loff_t
 
Ën
, 
sc¡_deviû
 *
dev
, 
sc¡_cmd
 *
cmd
, 
boÞ
 
async
)

5636 
»s
;

5637 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

5639 
	`TRACE_ENTRY
();

5646 
»s
 = 
	`__vdisk_fsync_fžeio
(
loff
, 
Ën
, 
dev
, 
cmd
, 
vœt_dev
->
fd
);

5647 ià(
	`uÆik–y
(
»s
 != 0))

5648 
dÚe
;

5650 ià(
vœt_dev
->
dif_fd
 !ð
NULL
) {

5651 
loff
 = (lofà>> 
dev
->
block_shiá
è<< 
SCST_DIF_TAG_SHIFT
;

5652 
Ën
 = (ËÀ>> 
dev
->
block_shiá
è<< 
SCST_DIF_TAG_SHIFT
;

5653 
»s
 = 
	`__vdisk_fsync_fžeio
(
loff
, 
Ën
, 
dev
, 
cmd
,

5654 
vœt_dev
->
dif_fd
);

5657 
dÚe
:

5658 ià(
async
) {

5659 ià(
cmd
 !ð
NULL
) {

5660 
cmd
->
com¶‘ed
 = 1;

5661 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
,

5662 
	`sc¡_e¡im©e_cÚ‹xt
());

5666 
	`TRACE_EXIT_RES
(
»s
);

5667  
»s
;

5668 
	}
}

5670 
	$vdisk_fsync
(
loff_t
 
loff
,

5671 
loff_t
 
Ën
, 
sc¡_deviû
 *
dev
, 
gå_t
 
gå_æags
,

5672 
sc¡_cmd
 *
cmd
, 
boÞ
 
async
)

5674 
»s
 = 0;

5675 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

5677 
	`TRACE_ENTRY
();

5685 ià(
vœt_dev
->
nv_ÿche
 || vœt_dev->
wt_æag
 ||

5686 
vœt_dev
->
o_dœeù_æag
 || vœt_dev->
nuÎio
) {

5687 ià(
async
) {

5688 
cmd
->
com¶‘ed
 = 1;

5689 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
,

5690 
	`sc¡_e¡im©e_cÚ‹xt
());

5692 
out
;

5695 ià(
vœt_dev
->
nuÎio
)

5697 ià(
vœt_dev
->
blockio
)

5698 
»s
 = 
	`vdisk_fsync_blockio
(
loff
, 
Ën
, 
dev
, 
gå_æags
, 
cmd
, 
async
);

5700 
»s
 = 
	`vdisk_fsync_fžeio
(
loff
, 
Ën
, 
dev
, 
cmd
, 
async
);

5702 
out
:

5703 
	`TRACE_EXIT_RES
(
»s
);

5704  
»s
;

5705 
	}
}

5707 
iovec
 *
	$vdisk_®loc_iv
(
sc¡_cmd
 *
cmd
,

5708 
vdisk_cmd_·¿ms
 *
p
)

5710 
iv_couÁ
;

5712 
iv_couÁ
 = 
	`mš_t
(, 
	`sc¡_g‘_buf_couÁ
(
cmd
), 
UIO_MAXIOV
);

5713 ià(
iv_couÁ
 > 
p
->iv_count) {

5714 ià(
p
->
iv
 !ðp->
sm®l_iv
)

5715 
	`kä“
(
p
->
iv
);

5716 
p
->
iv_couÁ
 = 0;

5718 
p
->
iv
 = (
iv_couÁ
 <ð
	`ARRAY_SIZE
Õ->
sm®l_iv
)) ?…->small_iv :

5719 
	`km®loc_¬¿y
(
iv_couÁ
, (*
p
->
iv
),

5720 
cmd
->
cmd_gå_mask
);

5721 ià(
p
->
iv
 =ð
NULL
) {

5722 
	`PRINT_ERROR
("UÇbËØ®loÿ‹ iv (%d)", 
iv_couÁ
);

5723 
out
;

5725 
p
->
iv_couÁ
 = iv_count;

5728 
out
:

5729  
p
->
iv
;

5730 
	}
}

5732 
com¶_¡©us_e
 
	$nuÎio_exec_»ad
(
vdisk_cmd_·¿ms
 *
p
)

5734 
sc¡_cmd
 *
cmd
 = 
p
->cmd;

5735 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

5736 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

5738 
	`TRACE_ENTRY
();

5740 ià(
vœt_dev
->
»ad_z”o
) {

5741 
sÿ‰”li¡
 *
sge
;

5742 
·ge
 *page;

5743 
i
;

5744 *
p
;

5746 
	`fÜ_—ch_sg
(
cmd
->
sg
, 
sge
, cmd->
sg_út
, 
i
) {

5747 
·ge
 = 
	`sg_·ge
(
sge
);

5748 
p
 = 
	`km­
(
·ge
);

5749 ià(
sge
->
off£t
 =ð0 && sge->
Ëngth
 =ð
PAGE_SIZE
)

5750 
	`þ—r_·ge
(
p
);

5752 
	`mem£t
(
p
 + 
sge
->
off£t
, 0, sge->
Ëngth
);

5753 
	`kunm­
(
·ge
);

5757 
	`sc¡_dif_´oûss_»ad
(
p
->
cmd
);

5759 
	`TRACE_EXIT
();

5760  
CMD_SUCCEEDED
;

5761 
	}
}

5763 
	$vdev_»ad_dif_gs
(
vdisk_cmd_·¿ms
 *
p
)

5765 
»s
 = 0;

5766 
sc¡_cmd
 *
cmd
 = 
p
->cmd;

5767 
loff_t
 
loff
;

5768 
mm_£gm’t_t
 
Þd_fs
;

5769 
loff_t
 
”r
 = 0;

5770 
ssize_t
 
Ëngth
, 
fuÎ_Ën
;

5771 
ušt8_t
 *
add»ss
;

5772 
sc¡_vdisk_dev
 *
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

5773 
fže
 *
fd
 = 
vœt_dev
->
dif_fd
;

5774 
iovec
 *
iv
;

5775 
iv_couÁ
, 
max_iv_couÁ
, 
i
;

5776 
boÞ
 
fšished
 = 
çl£
;

5777 
gs_num
, 
l
;

5778 
sÿ‰”li¡
 *
gs_sg
;

5779 
boÞ
 
ä“_iv
 = 
çl£
;

5781 
	`TRACE_ENTRY
();

5787 
	`EXTRACHECKS_BUG_ON
(
vœt_dev
->
nuÎio
);

5790 ià(
p
->
u£_z”o_cÝy
)

5791 
out
;

5794 
	`EXTRACHECKS_BUG_ON
(!(
cmd
->
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV_STORE
) ||

5795 (
	`sc¡_g‘_dif_aùiÚ
(
	`sc¡_g‘_dev_dif_aùiÚs
(
cmd
->
cmd_dif_aùiÚs
)è=ð
SCST_DIF_ACTION_NONE
));

5797 
gs_num
 = (
cmd
->
bufæ’
 >> cmd->
dev
->
block_shiá
);

5798 ià(
	`uÆik–y
(
gs_num
 == 0))

5799 
out
;

5801 
iv
 = 
p
->iv;

5802 ià(
iv
 =ð
NULL
) {

5803 
iv
 = 
	`vdisk_®loc_iv
(
cmd
, 
p
);

5804 ià(
iv
 =ð
NULL
) {

5805 
æags
;

5808 
	`¥š_lock_œq§ve
(&
vdev_”r_lock
, 
æags
);

5809 
	`sc¡_£t_busy
(
cmd
);

5810 
	`¥š_uÆock_œq»¡Üe
(&
vdev_”r_lock
, 
æags
);

5811 
»s
 = -
ENOMEM
;

5812 
out
;

5814 
ä“_iv
 = 
Œue
;

5816 
max_iv_couÁ
 = 
p
->
iv_couÁ
;

5818 
Þd_fs
 = 
	`g‘_fs
();

5819 
	`£t_fs
(
	`g‘_ds
());

5821 
gs_sg
 = 
NULL
;

5822 
loff
 = (
p
->lofà>> 
cmd
->
dev
->
block_shiá
è<< 
SCST_DIF_TAG_SHIFT
;

5824 
iv_couÁ
 = 0;

5825 
fuÎ_Ën
 = 0;

5826 
i
 = -1;

5827 
add»ss
 = 
	`sc¡_g‘_dif_buf
(
cmd
, &
gs_sg
, &
l
);

5828 
Ëngth
 = 
l
;

5829 
	`EXTRACHECKS_BUG_ON
(
Ëngth
 <= 0);

5831 
fuÎ_Ën
 +ð
Ëngth
;

5832 
i
++;

5833 
iv_couÁ
++;

5834 
iv
[
i
].
iov_ba£
 = (
ušt8_t
 
__fÜû
 
__u£r
 *)
add»ss
;

5835 
iv
[
i
].
iov_Ën
 = 
Ëngth
;

5836 
gs_num
 -ð
Ëngth
 >> 
SCST_DIF_TAG_SHIFT
;

5837 
	`EXTRACHECKS_BUG_ON
(
gs_num
 < 0);

5838 ià((
iv_couÁ
 =ð
max_iv_couÁ
è|| (
gs_num
 == 0))

5840 
add»ss
 = 
	`sc¡_g‘_dif_buf
(
cmd
, &
gs_sg
, &
l
);

5841 
Ëngth
 = 
l
;

5842 
	`EXTRACHECKS_BUG_ON
(
Ëngth
 <= 0);

5844 ià(
gs_num
 == 0)

5845 
fšished
 = 
Œue
;

5847 
	`TRACE_DBG
("Reading DIF iv_count %d, full_len %zd,†off %lld",

5848 
iv_couÁ
, 
fuÎ_Ën
, ()
loff
);

5851 
”r
 = 
	`vfs_»adv
(
fd
, (
iovec
 
__fÜû
 
__u£r
 *)
iv
, 
iv_couÁ
,

5852 &
loff
);

5853 ià((
”r
 < 0è|| (”¸< 
fuÎ_Ën
)) {

5854 
æags
;

5856 
	`PRINT_ERROR
("DIF„eadv()„eturned %lld from %zd "

5857 "(off %Îd, dev %s)", ()
”r
,

5858 
fuÎ_Ën
, ()
loff
, 
cmd
->
dev
->
vœt_Çme
);

5860 
	`¥š_lock_œq§ve
(&
vdev_”r_lock
, 
æags
);

5861 ià(
”r
 =ð-
EAGAIN
)

5862 
	`sc¡_£t_busy
(
cmd
);

5864 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

5865 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»ad_”rÜ
));

5867 
	`¥š_uÆock_œq»¡Üe
(&
vdev_”r_lock
, 
æags
);

5868 
»s
 = 
”r
;

5869 
out_£t_fs
;

5872 
i
 = 0; i < 
iv_couÁ
; i++)

5873 
	`sc¡_put_dif_buf
(
cmd
, (
__fÜû
 *)(
iv
[
i
].
iov_ba£
));

5875 ià(
fšished
)

5879 
	`£t_fs
(
Þd_fs
);

5881 
out_ä“_iv
:

5882 ià(
ä“_iv
 && (
iv
 !ð
p
->
sm®l_iv
))

5883 
	`kä“
(
p
->
iv
);

5885 
out
:

5886 
	`TRACE_EXIT_RES
(
»s
);

5887  
»s
;

5889 
out_£t_fs
:

5890 
	`£t_fs
(
Þd_fs
);

5891 
i
 = 0; i < 
iv_couÁ
; i++)

5892 
	`sc¡_put_dif_buf
(
cmd
, (
__fÜû
 *)(
iv
[
i
].
iov_ba£
));

5893 
out_ä“_iv
;

5894 
	}
}

5896 
	$vdev_wr™e_dif_gs
(
vdisk_cmd_·¿ms
 *
p
)

5898 
»s
 = 0;

5899 
sc¡_cmd
 *
cmd
 = 
p
->cmd;

5900 
loff_t
 
loff
;

5901 
mm_£gm’t_t
 
Þd_fs
;

5902 
loff_t
 
”r
 = 0;

5903 
ssize_t
 
Ëngth
, 
fuÎ_Ën
;

5904 
ušt8_t
 *
add»ss
;

5905 
sc¡_vdisk_dev
 *
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

5906 
fže
 *
fd
 = 
vœt_dev
->
dif_fd
;

5907 
iovec
 *
iv
, *
eiv
;

5908 
iv_couÁ
, 
eiv_couÁ
, 
max_iv_couÁ
, 
i
;

5909 
boÞ
 
fšished
 = 
çl£
;

5910 
gs_num
, 
l
;

5911 
sÿ‰”li¡
 *
gs_sg
;

5912 
boÞ
 
ä“_iv
 = 
çl£
;

5914 
	`TRACE_ENTRY
();

5920 
	`EXTRACHECKS_BUG_ON
(
vœt_dev
->
nuÎio
);

5923 ià(
p
->
u£_z”o_cÝy
)

5924 
out
;

5927 
	`EXTRACHECKS_BUG_ON
(!(
cmd
->
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV_STORE
) ||

5928 (
	`sc¡_g‘_dif_aùiÚ
(
	`sc¡_g‘_dev_dif_aùiÚs
(
cmd
->
cmd_dif_aùiÚs
)è=ð
SCST_DIF_ACTION_NONE
));

5930 
gs_num
 = (
cmd
->
bufæ’
 >> cmd->
dev
->
block_shiá
);

5931 ià(
	`uÆik–y
(
gs_num
 == 0))

5932 
out
;

5934 
iv
 = 
p
->iv;

5935 ià(
iv
 =ð
NULL
) {

5936 
iv
 = 
	`vdisk_®loc_iv
(
cmd
, 
p
);

5937 ià(
iv
 =ð
NULL
) {

5938 
æags
;

5941 
	`¥š_lock_œq§ve
(&
vdev_”r_lock
, 
æags
);

5942 
	`sc¡_£t_busy
(
cmd
);

5943 
	`¥š_uÆock_œq»¡Üe
(&
vdev_”r_lock
, 
æags
);

5944 
»s
 = -
ENOMEM
;

5945 
out
;

5947 
ä“_iv
 = 
Œue
;

5949 
max_iv_couÁ
 = 
p
->
iv_couÁ
;

5951 
Þd_fs
 = 
	`g‘_fs
();

5952 
	`£t_fs
(
	`g‘_ds
());

5954 
gs_sg
 = 
NULL
;

5955 
loff
 = (
p
->lofà>> 
cmd
->
dev
->
block_shiá
è<< 
SCST_DIF_TAG_SHIFT
;

5957 
iv_couÁ
 = 0;

5958 
fuÎ_Ën
 = 0;

5959 
i
 = -1;

5960 
add»ss
 = 
	`sc¡_g‘_dif_buf
(
cmd
, &
gs_sg
, &
l
);

5961 
Ëngth
 = 
l
;

5962 
	`EXTRACHECKS_BUG_ON
(
Ëngth
 <= 0);

5964 
fuÎ_Ën
 +ð
Ëngth
;

5965 
i
++;

5966 
iv_couÁ
++;

5967 
iv
[
i
].
iov_ba£
 = (
ušt8_t
 
__fÜû
 
__u£r
 *)
add»ss
;

5968 
iv
[
i
].
iov_Ën
 = 
Ëngth
;

5969 
gs_num
 -ð
Ëngth
 >> 
SCST_DIF_TAG_SHIFT
;

5970 
	`EXTRACHECKS_BUG_ON
(
gs_num
 < 0);

5971 ià((
iv_couÁ
 =ð
max_iv_couÁ
è|| (
gs_num
 == 0))

5973 
add»ss
 = 
	`sc¡_g‘_dif_buf
(
cmd
, &
gs_sg
, &
l
);

5974 
Ëngth
 = 
l
;

5975 
	`EXTRACHECKS_BUG_ON
(
Ëngth
 <= 0);

5977 ià(
gs_num
 == 0)

5978 
fšished
 = 
Œue
;

5980 
eiv
 = 
iv
;

5981 
eiv_couÁ
 = 
iv_couÁ
;

5982 
»¡¬t
:

5983 
	`TRACE_DBG
("Wr™šg DIF:ƒiv_couÁ %d, fuÎ_ËÀ%zd", 
eiv_couÁ
, 
fuÎ_Ën
);

5986 
”r
 = 
	`vfs_wr™ev
(
fd
, (
iovec
 
__fÜû
 
__u£r
 *)
eiv
, 
eiv_couÁ
,

5987 &
loff
);

5988 ià(
”r
 < 0) {

5989 
æags
;

5991 
	`PRINT_ERROR
("DIF write()„eturned %lld from %zd",

5992 ()
”r
, 
fuÎ_Ën
);

5994 
	`¥š_lock_œq§ve
(&
vdev_”r_lock
, 
æags
);

5995 ià(
”r
 =ð-
EAGAIN
)

5996 
	`sc¡_£t_busy
(
cmd
);

5998 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

5999 
	`SCST_LOAD_SENSE
(
sc¡_£n£_wr™e_”rÜ
));

6001 
	`¥š_uÆock_œq»¡Üe
(&
vdev_”r_lock
, 
æags
);

6002 
»s
 = 
”r
;

6003 
out_£t_fs
;

6004 } ià(
”r
 < 
fuÎ_Ën
) {

6009 
e
 = 
eiv_couÁ
;

6011 
	`TRACE_MGMT_DBG
("DIF write()„eturned %d from %zd "

6012 "(iv_couÁ=%d)", ()
”r
, 
fuÎ_Ën
,

6013 
eiv_couÁ
);

6014 ià(
”r
 == 0) {

6015 
	`PRINT_INFO
("Suspicious: DIF write()„eturned 0 from "

6016 "%zd (iv_couÁ=%d)", 
fuÎ_Ën
, 
eiv_couÁ
);

6018 
fuÎ_Ën
 -ð
”r
;

6019 
i
 = 0; i < 
e
; i++) {

6020 ià(()
eiv
->
iov_Ën
 < 
”r
) {

6021 
”r
 -ð
eiv
->
iov_Ën
;

6022 
eiv
++;

6023 
eiv_couÁ
--;

6025 
eiv
->
iov_ba£
 =

6026 (
ušt8_t
 
__fÜû
 
__u£r
 *)
eiv
->
iov_ba£
 + 
”r
;

6027 
eiv
->
iov_Ën
 -ð
”r
;

6031 
»¡¬t
;

6034 
i
 = 0; i < 
iv_couÁ
; i++)

6035 
	`sc¡_put_dif_buf
(
cmd
, (
__fÜû
 *)(
iv
[
i
].
iov_ba£
));

6037 ià(
fšished
)

6041 
	`£t_fs
(
Þd_fs
);

6043 
out_ä“_iv
:

6044 ià(
ä“_iv
 && (
iv
 !ð
p
->
sm®l_iv
))

6045 
	`kä“
(
iv
);

6047 
out
:

6048 
	`TRACE_EXIT_RES
(
»s
);

6049  
»s
;

6051 
out_£t_fs
:

6052 
	`£t_fs
(
Þd_fs
);

6053 
i
 = 0; i < 
iv_couÁ
; i++)

6054 
	`sc¡_put_dif_buf
(
cmd
, (
__fÜû
 *)(
iv
[
i
].
iov_ba£
));

6055 
out_ä“_iv
;

6056 
	}
}

6058 
com¶_¡©us_e
 
	$blockio_exec_»ad
(
vdisk_cmd_·¿ms
 *
p
)

6060 
	`blockio_exec_rw
(
p
, 
çl£
, false);

6061  
RUNNING_ASYNC
;

6062 
	}
}

6064 
com¶_¡©us_e
 
	$fžeio_exec_»ad
(
vdisk_cmd_·¿ms
 *
p
)

6066 
sc¡_cmd
 *
cmd
 = 
p
->cmd;

6067 
loff_t
 
loff
 = 
p
->loff;

6068 
mm_£gm’t_t
 
Þd_fs
;

6069 
loff_t
 
”r
 = 0;

6070 
ssize_t
 
Ëngth
, 
fuÎ_Ën
;

6071 
ušt8_t
 
__u£r
 *
add»ss
;

6072 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

6073 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

6074 
fže
 *
fd
 = 
vœt_dev
->fd;

6075 
iovec
 *
iv
;

6076 
iv_couÁ
, 
i
, 
max_iv_couÁ
;

6077 
boÞ
 
fšished
 = 
çl£
;

6079 
	`TRACE_ENTRY
();

6081 
	`EXTRACHECKS_BUG_ON
(
vœt_dev
->
nuÎio
);

6083 ià(
p
->
u£_z”o_cÝy
)

6084 
out_dif
;

6086 
iv
 = 
	`vdisk_®loc_iv
(
cmd
, 
p
);

6087 ià(
iv
 =ð
NULL
)

6088 
out_nomem
;

6090 
max_iv_couÁ
 = 
p
->
iv_couÁ
;

6092 
Ëngth
 = 
	`sc¡_g‘_buf_fœ¡
(
cmd
, (
ušt8_t
 
__fÜû
 **)&
add»ss
);

6093 ià(
	`uÆik–y
(
Ëngth
 < 0)) {

6094 
	`PRINT_ERROR
("sc¡_g‘_buf_fœ¡(èçžed: %zd", 
Ëngth
);

6095 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

6096 
	`SCST_LOAD_SENSE
(
sc¡_£n£_š‹º®_çžu»
));

6097 
out
;

6100 
Þd_fs
 = 
	`g‘_fs
();

6101 
	`£t_fs
(
	`g‘_ds
());

6104 
iv_couÁ
 = 0;

6105 
fuÎ_Ën
 = 0;

6106 
i
 = -1;

6107 
Ëngth
 > 0) {

6108 
fuÎ_Ën
 +ð
Ëngth
;

6109 
i
++;

6110 
iv_couÁ
++;

6111 
iv
[
i
].
iov_ba£
 = 
add»ss
;

6112 
iv
[
i
].
iov_Ën
 = 
Ëngth
;

6113 ià(
iv_couÁ
 =ð
max_iv_couÁ
)

6115 
Ëngth
 = 
	`sc¡_g‘_buf_Ãxt
(
cmd
,

6116 (
ušt8_t
 
__fÜû
 **)&
add»ss
);

6118 ià(
Ëngth
 == 0) {

6119 
fšished
 = 
Œue
;

6120 ià(
	`uÆik–y
(
iv_couÁ
 == 0))

6122 } ià(
	`uÆik–y
(
Ëngth
 < 0)) {

6123 
	`PRINT_ERROR
("sc¡_g‘_buf_Ãxt(èçžed: %zd", 
Ëngth
);

6124 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

6125 
	`SCST_LOAD_SENSE
(
sc¡_£n£_š‹º®_çžu»
));

6126 
out_£t_fs
;

6129 
	`TRACE_DBG
("R—dšg iv_couÁ %d, fuÎ_ËÀ%zd", 
iv_couÁ
, 
fuÎ_Ën
);

6132 
”r
 = 
	`vfs_»adv
(
fd
, (
iovec
 
__fÜû
 
__u£r
 *)
iv
, 
iv_couÁ
,

6133 &
loff
);

6134 ià((
”r
 < 0è|| (”¸< 
fuÎ_Ën
)) {

6135 
	`PRINT_ERROR
("readv()„eturned %lld from %zd",

6136 ()
”r
,

6137 
fuÎ_Ën
);

6138 ià(
”r
 =ð-
EAGAIN
)

6139 
	`sc¡_£t_busy
(
cmd
);

6141 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

6142 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»ad_”rÜ
));

6144 
out_£t_fs
;

6147 
i
 = 0; i < 
iv_couÁ
; i++)

6148 
	`sc¡_put_buf
(
cmd
, (
__fÜû
 *)(
iv
[
i
].
iov_ba£
));

6150 ià(
fšished
)

6153 
Ëngth
 = 
	`sc¡_g‘_buf_Ãxt
(
cmd
, (
ušt8_t
 
__fÜû
 **)&
add»ss
);

6156 
	`£t_fs
(
Þd_fs
);

6158 ià((
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV_STORE
) &&

6159 (
	`sc¡_g‘_dif_aùiÚ
(
	`sc¡_g‘_dev_dif_aùiÚs
(
cmd
->
cmd_dif_aùiÚs
)è!ð
SCST_DIF_ACTION_NONE
)) {

6160 
”r
 = 
	`vdev_»ad_dif_gs
(
p
);

6161 ià(
”r
 != 0)

6162 
out
;

6165 
out_dif
:

6166 
	`sc¡_dif_´oûss_»ad
(
cmd
);

6168 
out
:

6169 
	`TRACE_EXIT
();

6170  
CMD_SUCCEEDED
;

6172 
out_£t_fs
:

6173 
	`£t_fs
(
Þd_fs
);

6174 
i
 = 0; i < 
iv_couÁ
; i++)

6175 
	`sc¡_put_buf
(
cmd
, (
__fÜû
 *)(
iv
[
i
].
iov_ba£
));

6176 
out
;

6178 
out_nomem
:

6179 
	`sc¡_£t_busy
(
cmd
);

6180 
”r
 = 0;

6181 
out
;

6182 
	}
}

6184 
com¶_¡©us_e
 
	$nuÎio_exec_wr™e
(
vdisk_cmd_·¿ms
 *
p
)

6186 
	`sc¡_dif_´oûss_wr™e
(
p
->
cmd
);

6187  
CMD_SUCCEEDED
;

6188 
	}
}

6190 
com¶_¡©us_e
 
	$blockio_exec_wr™e
(
vdisk_cmd_·¿ms
 *
p
)

6192 
sc¡_cmd
 *
cmd
 = 
p
->cmd;

6193 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

6194 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

6195 
»s
, 
rc
;

6197 
	`TRACE_ENTRY
();

6199 
rc
 = 
	`sc¡_dif_´oûss_wr™e
(
cmd
);

6200 ià(
	`uÆik–y
(
rc
 != 0)) {

6201 
»s
 = 
CMD_SUCCEEDED
;

6202 
out
;

6205 
	`blockio_exec_rw
(
p
, 
Œue
,…->
fua
 || 
vœt_dev
->
wt_æag
);

6206 
»s
 = 
RUNNING_ASYNC
;

6208 
out
:

6209 
	`TRACE_EXIT_RES
(
»s
);

6210  
»s
;

6211 
	}
}

6213 
com¶_¡©us_e
 
	$blockio_exec_v¬_Ën_cmd
(
vdisk_cmd_·¿ms
 *
p
)

6215 
sc¡_cmd
 *
cmd
 = 
p
->cmd;

6216 
»s
;

6218 
	`TRACE_ENTRY
();

6220 
»s
 = 
blockio_v¬_Ën_Ýs
[
cmd
->
cdb
[9]](
p
);

6222 
	`TRACE_EXIT_RES
(
»s
);

6223  
»s
;

6224 
	}
}

6226 
com¶_¡©us_e
 
	$nuÎio_exec_v¬_Ën_cmd
(
vdisk_cmd_·¿ms
 *
p
)

6228 
sc¡_cmd
 *
cmd
 = 
p
->cmd;

6229 
»s
;

6231 
	`TRACE_ENTRY
();

6233 
»s
 = 
nuÎio_v¬_Ën_Ýs
[
cmd
->
cdb
[9]](
p
);

6235 
	`TRACE_EXIT_RES
(
»s
);

6236  
»s
;

6237 
	}
}

6239 
com¶_¡©us_e
 
	$fžeio_exec_v¬_Ën_cmd
(
vdisk_cmd_·¿ms
 *
p
)

6241 
sc¡_cmd
 *
cmd
 = 
p
->cmd;

6242 
»s
;

6244 
	`TRACE_ENTRY
();

6246 
»s
 = 
fžeio_v¬_Ën_Ýs
[
cmd
->
cdb
[9]](
p
);

6248 
	`TRACE_EXIT_RES
(
»s
);

6249  
»s
;

6250 
	}
}

6252 
com¶_¡©us_e
 
	$fžeio_exec_wr™e
(
vdisk_cmd_·¿ms
 *
p
)

6254 
sc¡_cmd
 *
cmd
 = 
p
->cmd;

6255 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

6256 
loff_t
 
loff
 = 
p
->loff;

6257 
mm_£gm’t_t
 
Þd_fs
;

6258 
loff_t
 
”r
 = 0;

6259 
ssize_t
 
Ëngth
, 
fuÎ_Ën
;

6260 
ušt8_t
 *
add»ss
;

6261 
sc¡_vdisk_dev
 *
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

6262 
fže
 *
fd
 = 
vœt_dev
->fd;

6263 
iovec
 *
iv
, *
eiv
;

6264 
rc
, 
i
, 
iv_couÁ
, 
eiv_couÁ
, 
max_iv_couÁ
;

6265 
boÞ
 
fšished
 = 
çl£
;

6267 
	`TRACE_ENTRY
();

6269 
	`EXTRACHECKS_BUG_ON
(
vœt_dev
->
nuÎio
);

6271 
rc
 = 
	`sc¡_dif_´oûss_wr™e
(
cmd
);

6272 ià(
	`uÆik–y
(
rc
 != 0))

6273 
out
;

6275 ià(
p
->
u£_z”o_cÝy
)

6276 
out_sync
;

6278 
iv
 = 
	`vdisk_®loc_iv
(
cmd
, 
p
);

6279 ià(
iv
 =ð
NULL
)

6280 
out_nomem
;

6282 
max_iv_couÁ
 = 
p
->
iv_couÁ
;

6284 
Ëngth
 = 
	`sc¡_g‘_buf_fœ¡
(
cmd
, &
add»ss
);

6285 ià(
	`uÆik–y
(
Ëngth
 < 0)) {

6286 
	`PRINT_ERROR
("sc¡_g‘_buf_fœ¡(èçžed: %zd", 
Ëngth
);

6287 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

6288 
	`SCST_LOAD_SENSE
(
sc¡_£n£_š‹º®_çžu»
));

6289 
out
;

6292 
Þd_fs
 = 
	`g‘_fs
();

6293 
	`£t_fs
(
	`g‘_ds
());

6296 
iv_couÁ
 = 0;

6297 
fuÎ_Ën
 = 0;

6298 
i
 = -1;

6299 
Ëngth
 > 0) {

6300 
fuÎ_Ën
 +ð
Ëngth
;

6301 
i
++;

6302 
iv_couÁ
++;

6303 
iv
[
i
].
iov_ba£
 = (
ušt8_t
 
__fÜû
 
__u£r
 *)
add»ss
;

6304 
iv
[
i
].
iov_Ën
 = 
Ëngth
;

6305 ià(
iv_couÁ
 =ð
max_iv_couÁ
)

6307 
Ëngth
 = 
	`sc¡_g‘_buf_Ãxt
(
cmd
, &
add»ss
);

6309 ià(
Ëngth
 == 0) {

6310 
fšished
 = 
Œue
;

6311 ià(
	`uÆik–y
(
iv_couÁ
 == 0))

6313 } ià(
	`uÆik–y
(
Ëngth
 < 0)) {

6314 
	`PRINT_ERROR
("sc¡_g‘_buf_Ãxt(èçžed: %zd", 
Ëngth
);

6315 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

6316 
	`SCST_LOAD_SENSE
(
sc¡_£n£_š‹º®_çžu»
));

6317 
out_£t_fs
;

6320 
eiv
 = 
iv
;

6321 
eiv_couÁ
 = 
iv_couÁ
;

6322 
»¡¬t
:

6323 
	`TRACE_DBG
("Wr™šg:ƒiv_couÁ %d, fuÎ_ËÀ%zd", 
eiv_couÁ
, 
fuÎ_Ën
);

6326 
”r
 = 
	`vfs_wr™ev
(
fd
, (
iovec
 
__fÜû
 
__u£r
 *)
eiv
, 
eiv_couÁ
,

6327 &
loff
);

6328 ià(
”r
 < 0) {

6329 
	`PRINT_ERROR
("write()„eturned %lld from %zd",

6330 ()
”r
,

6331 
fuÎ_Ën
);

6332 ià(
”r
 =ð-
EAGAIN
)

6333 
	`sc¡_£t_busy
(
cmd
);

6335 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

6336 
	`SCST_LOAD_SENSE
(
sc¡_£n£_wr™e_”rÜ
));

6338 
out_£t_fs
;

6339 } ià(
”r
 < 
fuÎ_Ën
) {

6344 
e
 = 
eiv_couÁ
;

6346 
	`TRACE_MGMT_DBG
("write()„eturned %d from %zd "

6347 "(iv_couÁ=%d)", ()
”r
, 
fuÎ_Ën
,

6348 
eiv_couÁ
);

6349 ià(
”r
 == 0) {

6350 
	`PRINT_INFO
("Suspicious: write()„eturned 0 from "

6351 "%zd (iv_couÁ=%d)", 
fuÎ_Ën
, 
eiv_couÁ
);

6353 
fuÎ_Ën
 -ð
”r
;

6354 
i
 = 0; i < 
e
; i++) {

6355 ià(()
eiv
->
iov_Ën
 < 
”r
) {

6356 
”r
 -ð
eiv
->
iov_Ën
;

6357 
eiv
++;

6358 
eiv_couÁ
--;

6360 
eiv
->
iov_ba£
 +ð
”r
;

6361 
eiv
->
iov_Ën
 -ð
”r
;

6365 
»¡¬t
;

6368 
i
 = 0; i < 
iv_couÁ
; i++)

6369 
	`sc¡_put_buf
(
cmd
, (
__fÜû
 *)(
iv
[
i
].
iov_ba£
));

6371 ià(
fšished
)

6374 
Ëngth
 = 
	`sc¡_g‘_buf_Ãxt
(
cmd
, &
add»ss
);

6377 
	`£t_fs
(
Þd_fs
);

6379 ià((
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV_STORE
) &&

6380 (
	`sc¡_g‘_dif_aùiÚ
(
	`sc¡_g‘_dev_dif_aùiÚs
(
cmd
->
cmd_dif_aùiÚs
)è!ð
SCST_DIF_ACTION_NONE
)) {

6381 
”r
 = 
	`vdev_wr™e_dif_gs
(
p
);

6382 ià(
”r
 != 0)

6383 
out
;

6386 
out_sync
:

6388 ià(
p
->
fua
)

6389 
	`vdisk_fsync
(
loff
, 
	`sc¡_cmd_g‘_d©a_Ën
(
cmd
), cmd->
dev
,

6390 
cmd
->
cmd_gå_mask
, cmd, 
çl£
);

6391 
out
:

6392 
	`TRACE_EXIT
();

6393  
CMD_SUCCEEDED
;

6395 
out_£t_fs
:

6396 
	`£t_fs
(
Þd_fs
);

6397 
i
 = 0; i < 
iv_couÁ
; i++)

6398 
	`sc¡_put_buf
(
cmd
, (
__fÜû
 *)(
iv
[
i
].
iov_ba£
));

6399 
out_sync
;

6401 
out_nomem
:

6402 
	`sc¡_£t_busy
(
cmd
);

6403 
”r
 = 0;

6404 
out
;

6405 
	}
}

6407 
	ssc¡_blockio_wÜk
 {

6408 
©omic_t
 
	mbios_šæight
;

6409 
sc¡_cmd
 *
	mcmd
;

6410 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 30)) && (LINUX_VERSION_CODE <= KERNEL_VERSION(3, 6, 0))

6412 
bio_£t
 *
	mbio£t
;

6416 
šlše
 
	$blockio_check_fšish
(
sc¡_blockio_wÜk
 *
blockio_wÜk
)

6419 ià(
	`©omic_dec_ªd_‹¡
(&
blockio_wÜk
->
bios_šæight
)) {

6420 
sc¡_cmd
 *
cmd
 = 
blockio_wÜk
->cmd;

6422 ià((
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_READ
) &&

6423 
	`lik–y
(
cmd
->
¡©us
 =ð
SAM_STAT_GOOD
)) {

6428 
cmd
->
deã¼ed_dif_»ad_check
 = 1;

6431 
blockio_wÜk
->
cmd
->
com¶‘ed
 = 1;

6432 
blockio_wÜk
->
cmd
->
	`sc¡_cmd_dÚe
(cmd,

6433 
SCST_CMD_STATE_DEFAULT
, 
	`sc¡_e¡im©e_cÚ‹xt
());

6435 
	`kmem_ÿche_ä“
(
blockio_wÜk_ÿch•
, 
blockio_wÜk
);

6438 
	}
}

6440 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 30)) && (LINUX_VERSION_CODE <= KERNEL_VERSION(3, 6, 0))

6441 
	$blockio_bio_de¡ruùÜ
(
bio
 *bio)

6443 
sc¡_blockio_wÜk
 *
blockio_wÜk
 = 
bio
->
bi_´iv©e
;

6444 
	`bio_ä“
(
bio
, 
blockio_wÜk
->
bio£t
);

6445 
	`blockio_check_fšish
(
blockio_wÜk
);

6446 
	}
}

6449 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 24)

6450 
	$blockio_’dio
(
bio
 *bio, 
by‹s_dÚe
, 
”rÜ
)

6452 #–ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 3, 0)

6453 
	$blockio_’dio
(
bio
 *bio, 
”rÜ
)

6456 
	$blockio_’dio
(
bio
 *bio)

6458 
”rÜ
 = 
bio
->
bi_”rÜ
;

6460 
sc¡_blockio_wÜk
 *
blockio_wÜk
 = 
bio
->
bi_´iv©e
;

6462 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 24)

6463 ià(
bio
->
bi_size
)

6467 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 3, 0)

6468 ià(
	`uÆik–y
(!
	`bio_æagged
(
bio
, 
BIO_UPTODATE
))) {

6469 ià(
”rÜ
 == 0) {

6470 
	`PRINT_ERROR
("Not upo date bio withƒrror 0 for "

6471 "cmd %p,„‘uºšg -EIO", 
blockio_wÜk
->
cmd
);

6472 
”rÜ
 = -
EIO
;

6477 ià(
	`uÆik–y
(
”rÜ
 != 0)) {

6478 
æags
;

6480 
	`PRINT_ERROR
("BLOCKIO for cmd %p finished withƒrror %d",

6481 
blockio_wÜk
->
cmd
, 
”rÜ
);

6487 
	`¥š_lock_œq§ve
(&
vdev_”r_lock
, 
æags
);

6489 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 36)

6490 ià(
bio
->
bi_rw
 & (1 << 
BIO_RW
))

6492 ià(
bio
->
bi_rw
 & 
REQ_WRITE
)

6494 
	`sc¡_£t_cmd_”rÜ
(
blockio_wÜk
->
cmd
,

6495 
	`SCST_LOAD_SENSE
(
sc¡_£n£_wr™e_”rÜ
));

6497 
	`sc¡_£t_cmd_”rÜ
(
blockio_wÜk
->
cmd
,

6498 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»ad_”rÜ
));

6500 
	`¥š_uÆock_œq»¡Üe
(&
vdev_”r_lock
, 
æags
);

6503 #ià(
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 30)) || (LINUX_VERSION_CODE > KERNEL_VERSION(3, 6, 0))

6504 
	`blockio_check_fšish
(
blockio_wÜk
);

6507 
	`bio_put
(
bio
);

6508 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 24)

6513 
	}
}

6515 
	$vdisk_bio_£t_çžç¡
(
bio
 *bio)

6517 #ià
LINUX_VERSION_CODE
 <ð
	`KERNEL_VERSION
(2, 6, 27)

6518 
bio
->
bi_rw
 |ð(1 << 
BIO_RW_FAILFAST
);

6519 #–ià
LINUX_VERSION_CODE
 <ð
	`KERNEL_VERSION
(2, 6, 35)

6520 
bio
->
bi_rw
 |ð(1 << 
BIO_RW_FAILFAST_DEV
) |

6521 (1 << 
BIO_RW_FAILFAST_TRANSPORT
) |

6522 (1 << 
BIO_RW_FAILFAST_DRIVER
);

6524 
bio
->
bi_rw
 |ð
REQ_FAILFAST_DEV
 |

6525 
REQ_FAILFAST_TRANSPORT
 |

6526 
REQ_FAILFAST_DRIVER
;

6528 
	}
}

6530 
	$vdisk_bio_£t_hoq
(
bio
 *bio)

6532 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 36) || \

6533 (
	`defšed
(
RHEL_MAJOR
) && \

6534 (
RHEL_MAJOR
 -0 > 6 || RHEL_MAJOR -0 =ð6 && 
RHEL_MINOR
 -0 > 0))

6535 
bio
->
bi_rw
 |ð
REQ_SYNC
;

6536 #–ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 29)

6537 
bio
->
bi_rw
 |ð1 << 
BIO_RW_SYNCIO
;

6539 
bio
->
bi_rw
 |ð1 << 
BIO_RW_SYNC
;

6541 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 36) || \

6542 (
	`defšed
(
RHEL_MAJOR
) && \

6543 (
RHEL_MAJOR
 -0 > 6 || RHEL_MAJOR -0 =ð6 && 
RHEL_MINOR
 -0 > 0))

6544 
bio
->
bi_rw
 |ð
REQ_META
;

6545 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(3, 1, 0)

6550 
bio
->
bi_rw
 |ð
REQ_PRIO
;

6552 #–ià!
	`defšed
(
RHEL_MAJOR
) || RHEL_MAJOR -0 >= 6

6557 
bio
->
bi_rw
 |ð
BIO_RW_META
;

6559 
	}
}

6561 #ià
defšed
(
CONFIG_BLK_DEV_INTEGRITY
)

6562 
	$vdisk_blk_add_dif
(
bio
 *bio, 
gå_t
 
gå_mask
,

6563 cÚ¡ 
sc¡_deviû
 *
dev
, 
sÿ‰”li¡
 **
pdsg
,

6564 *
pdsg_offs
, *
pdsg_Ën
, 
boÞ
 
Ï¡
)

6566 
block_shiá
 = 
dev
->block_shift;

6567 
sÿ‰”li¡
 *
Üig_dsg
 = *
pdsg
;

6568 
sÿ‰”li¡
 *
sg
;

6569 
sg_offs
 = *
pdsg_offs
, 
sg_Ën
 = *
pdsg_Ën
;

6570 
·ges
, 
Ëá
, 
Ën
, 
gs_Ën
, 
rc
;

6571 
bio_š‹gr™y_·ylßd
 *
b
;

6573 
	`TRACE_ENTRY
();

6575 
gs_Ën
 = ((
	`bio_£ùÜs
(
bio
è<< 9è>> 
block_shiá
è<< 
SCST_DIF_TAG_SHIFT
;

6577 
	`TRACE_DBG
("bio %p,ags_len %d,…dsg %p,…dsg_offs %d,…dsg_len %d, "

6578 "Ï¡ %d", 
bio
, 
gs_Ën
, *
pdsg
, *
pdsg_offs
, *
pdsg_Ën
, 
Ï¡
);

6580 
·ges
 = 0;

6581 
Ëá
 = 
gs_Ën
;

6582 
sg
 = 
Üig_dsg
;

6583 
Ën
 = 
sg
->
Ëngth
;

6585 
·ges
++;

6586 
Ëá
 -ð
Ën
;

6587 ià(
Ëá
 <= 0) {

6588 ià(!
Ï¡
) {

6589 
Ëá
 = -left;

6590 
sg
 = 
	`__sg_Ãxt_šlše
(sg);

6591 *
pdsg
 = 
sg
;

6592 *
pdsg_offs
 = 
sg
->
off£t
 + 
Ëá
;

6593 *
pdsg_Ën
 = 
sg
->
Ëngth
 - 
Ëá
;

6594 
	`TRACE_DBG
("left %d,…dsg %p,…dsg_offs %d,…dsg_len %d",

6595 
Ëá
, *
pdsg
, *
pdsg_offs
, *
pdsg_Ën
);

6599 
sg
 = 
	`__sg_Ãxt_šlše
(sg);

6600 
Ën
 = 
sg
->
Ëngth
;

6603 
b
 = 
	`bio_š‹gr™y_®loc
(
bio
, 
gå_mask
, 
·ges
);

6604 ià(
	`uÆik–y
(
b
 =ð
NULL
)) {

6605 
	`PRINT_WARNING
("Allocation of %d…ages for DIFags "

6606 "çžed! (dev %s)", 
·ges
, 
dev
->
vœt_Çme
);

6607 
out
;

6610 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(3, 14, 0)

6611 
b
->
b_™”
.
bi_size
 = 
gs_Ën
;

6612 
b
->
b_™”
.
bi_£ùÜ
 = 
bio
->
bi_™”
.bi_sector;

6614 
b
->
b_size
 = 
gs_Ën
;

6615 
b
->
b_£ùÜ
 = 
bio
->
bi_£ùÜ
;

6618 
Ëá
 = 
gs_Ën
;

6619 
sg
 = 
Üig_dsg
;

6621 
	`TRACE_DBG
("page %p (buf %p), sg_len %d, sg_offs %d",

6622 
	`sg_·ge
(
sg
), 
	`·ge_add»ss
(sg_page(sg)),

6623 
sg_Ën
, 
sg_offs
);

6625 
rc
 = 
	`bio_š‹gr™y_add_·ge
(
bio
, 
	`sg_·ge
(
sg
), 
sg_Ën
, 
sg_offs
);

6626 ià(
rc
 !ð
sg_Ën
) {

6627 
	`PRINT_WARNING
("Can‚ot‡dd DIFags…age! "

6628 "(dev %s)", 
dev
->
vœt_Çme
);

6630 
out
;

6633 ià(
Ëá
 < 
sg_Ën
) {

6634 
	`TRACE_DBG
("left %d, sg_len %d, sg_offs %d",

6635 
Ëá
, 
sg_Ën
, 
sg_offs
);

6639 
Ëá
 -ð
sg_Ën
;

6640 
	`EXTRACHECKS_BUG_ON
(
Ëá
 < 0);

6642 
	`TRACE_DBG
("Ëá %d", 
Ëá
);

6644 ià(
Ëá
 == 0)

6647 
sg
 = 
	`__sg_Ãxt_šlše
(sg);

6648 
sg_Ën
 = 
sg
->
Ëngth
;

6649 
sg_offs
 = 
sg
->
off£t
;

6652 
out
:

6653 
	`TRACE_EXIT
();

6655 
	}
}

6657 
	$vdisk_blk_add_dif
(
bio
 *bio, 
gå_t
 
gå_mask
,

6658 cÚ¡ 
sc¡_deviû
 *
dev
, 
sÿ‰”li¡
 **
pdsg
,

6659 *
pdsg_offs
, *
pdsg_Ën
, 
boÞ
 
Ï¡
)

6661 
	`BUG
();

6662 
	}
}

6665 
	$blockio_exec_rw
(
vdisk_cmd_·¿ms
 *
p
, 
boÞ
 
wr™e
, boÞ 
fua
)

6667 
sc¡_cmd
 *
cmd
 = 
p
->cmd;

6668 
u64
 
lba_¡¬t
 = 
	`sc¡_cmd_g‘_lba
(
cmd
);

6669 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

6670 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

6671 
block_shiá
 = 
dev
->block_shift;

6672 
block_deviû
 *
bdev
 = 
vœt_dev
->bdev;

6673 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 30)

6674 
bio_£t
 *
bs
 = 
vœt_dev
->
vdisk_bio£t
;

6676 
»que¡_queue
 *
q
 = 
	`bdev_g‘_queue
(
bdev
);

6677 
Ëngth
, 
max_Ä_vecs
 = 0, 
off£t
;

6678 
·ge
 *page;

6679 
bio
 *biØð
NULL
, *
hbio
 = NULL, *
tbio
 = NULL;

6680 
Ãed_Ãw_bio
;

6681 
sc¡_blockio_wÜk
 *
blockio_wÜk
;

6682 
bios
 = 0;

6683 
gå_t
 
gå_mask
 = 
cmd
->
cmd_gå_mask
;

6684 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 39)

6685 
blk_¶ug
 
¶ug
;

6687 
sÿ‰”li¡
 *
dsg
;

6688 
dsg_offs
, 
dsg_Ën
;

6689 
boÞ
 
dif
 = 
vœt_dev
->
blk_š‹gr™y
 &&

6690 (
	`sc¡_g‘_dif_aùiÚ
(
	`sc¡_g‘_dev_dif_aùiÚs
(
cmd
->
cmd_dif_aùiÚs
)è!ð
SCST_DIF_ACTION_NONE
);

6692 
	`TRACE_ENTRY
();

6694 
	`WARN_ON
(
vœt_dev
->
nuÎio
);

6696 ià(
dif
) {

6697 
dsg
 = 
cmd
->
dif_sg
;

6698 
dsg_offs
 = 
dsg
->
off£t
;

6699 
dsg_Ën
 = 
dsg
->
Ëngth
;

6703 
blockio_wÜk
 = 
	`kmem_ÿche_®loc
(
blockio_wÜk_ÿch•
, 
gå_mask
);

6704 ià(
blockio_wÜk
 =ð
NULL
) {

6705 
	`sc¡_£t_busy
(
cmd
);

6706 
fšish_cmd
;

6711 
”r_šj_úŒ
;

6713 ià(++
”r_šj_úŒ
 % 256 == 0) {

6714 
	`PRINT_INFO
("blockio_exec_rw()ƒrror injection");

6715 
	`sc¡_£t_busy
(
cmd
);

6716 
ä“_bio
;

6721 
blockio_wÜk
->
cmd
 = cmd;

6722 #ià(
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 30)) && (LINUX_VERSION_CODE <= KERNEL_VERSION(3, 6, 0))

6723 
blockio_wÜk
->
bio£t
 = 
bs
;

6726 ià(
q
)

6727 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(4, 3, 0)

6728 
max_Ä_vecs
 = 
BIO_MAX_PAGES
;

6730 
max_Ä_vecs
 = 
	`mš
(
	`bio_g‘_Ä_vecs
(
bdev
), 
BIO_MAX_PAGES
);

6733 
max_Ä_vecs
 = 1;

6735 
Ãed_Ãw_bio
 = 1;

6737 
Ëngth
 = 
	`sc¡_g‘_sg_·ge_fœ¡
(
cmd
, &
·ge
, &
off£t
);

6742 ià(
	`WARN_ONCE
((
Ëngth
 & 511è!ð0 || (
off£t
 & 511) != 0,

6744 
Ëngth
, 
off£t
)) {

6745 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

6746 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

6747 
ä“_bio
;

6750 
Ëngth
 > 0) {

6751 
Ën
, 
by‹s
, 
off
, 
thi¦’
;

6752 
·ge
 *
pg
;

6753 
u64
 
lba_¡¬t0
;

6755 
pg
 = 
·ge
;

6756 
Ën
 = 
Ëngth
;

6757 
off
 = 
off£t
;

6758 
thi¦’
 = 0;

6759 
lba_¡¬t0
 = 
lba_¡¬t
;

6761 
Ën
 > 0) {

6762 
rc
;

6764 ià(
Ãed_Ãw_bio
) {

6765 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 30)

6766 
bio
 = 
	`bio_®loc_bio£t
(
gå_mask
, 
max_Ä_vecs
, 
bs
);

6768 
bio
 = 
	`bio_®loc
(
gå_mask
, 
max_Ä_vecs
);

6771 ià(!
bio
) {

6772 
	`PRINT_ERROR
("Failedo create bio "

6774 
cmd
->
g‘_sg_buf_’Œy_num
, cmd);

6775 
	`sc¡_£t_busy
(
cmd
);

6776 
ä“_bio
;

6779 
bios
++;

6780 
Ãed_Ãw_bio
 = 0;

6781 
bio
->
bi_’d_io
 = 
blockio_’dio
;

6782 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(3, 14, 0)

6783 
bio
->
bi_™”
.
bi_£ùÜ
 = 
lba_¡¬t0
 << (
block_shiá
 - 9);

6785 
bio
->
bi_£ùÜ
 = 
lba_¡¬t0
 << (
block_shiá
 - 9);

6787 
bio
->
bi_bdev
 = 
bdev
;

6788 
bio
->
bi_´iv©e
 = 
blockio_wÜk
;

6789 #ià(
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 30)) && (LINUX_VERSION_CODE <= KERNEL_VERSION(3, 6, 0))

6790 
bio
->
bi_de¡ruùÜ
 = 
blockio_bio_de¡ruùÜ
;

6796 
	`vdisk_bio_£t_çžç¡
(
bio
);

6799 
bio
->
bi_rw
 |ð
REQ_SYNC
;

6801 ià(
fua
)

6802 
bio
->
bi_rw
 |ð
REQ_FUA
;

6804 ià(
cmd
->
queue_ty³
 =ð
SCST_CMD_QUEUE_HEAD_OF_QUEUE
)

6805 
	`vdisk_bio_£t_hoq
(
bio
);

6807 ià(!
hbio
)

6808 
hbio
 = 
tbio
 = 
bio
;

6810 
tbio
 =bio->
bi_Ãxt
 = 
bio
;

6813 
by‹s
 = 
	`mš_t
(, 
Ën
, 
PAGE_SIZE
 - 
off
);

6815 
rc
 = 
	`bio_add_·ge
(
bio
, 
pg
, 
by‹s
, 
off
);

6816 ià(
rc
 < 
by‹s
) {

6817 
	`WARN_ON
(
rc
 != 0);

6818 ià(
dif
)

6819 
	`vdisk_blk_add_dif
(
bio
, 
gå_mask
, 
dev
, &
dsg
,

6820 &
dsg_offs
, &
dsg_Ën
, 
çl£
);

6821 
Ãed_Ãw_bio
 = 1;

6822 
lba_¡¬t0
 +ð
thi¦’
 >> 
block_shiá
;

6823 
thi¦’
 = 0;

6827 
pg
++;

6828 
thi¦’
 +ð
by‹s
;

6829 
Ën
 -ð
by‹s
;

6830 
off
 = 0;

6833 
lba_¡¬t
 +ð
Ëngth
 >> 
block_shiá
;

6835 
	`sc¡_put_sg_·ge
(
cmd
, 
·ge
, 
off£t
);

6836 
Ëngth
 = 
	`sc¡_g‘_sg_·ge_Ãxt
(
cmd
, &
·ge
, &
off£t
);

6839 ià(
dif
)

6840 
	`vdisk_blk_add_dif
(
bio
, 
gå_mask
, 
dev
, &
dsg
, &
dsg_offs
,

6841 &
dsg_Ën
, 
Œue
);

6844 
	`©omic_£t
(&
blockio_wÜk
->
bios_šæight
, 
bios
+1);

6846 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 39)

6847 
	`blk_¡¬t_¶ug
(&
¶ug
);

6850 
hbio
) {

6851 
bio
 = 
hbio
;

6852 
hbio
 = hbio->
bi_Ãxt
;

6853 
bio
->
bi_Ãxt
 = 
NULL
;

6855 
	`subm™_bio
((
wr™e
 !ð0), 
bio
);

6858 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 39)

6859 
	`blk_fšish_¶ug
(&
¶ug
);

6861 ià(
q
 && q->
uÅlug_â
)

6862 
q
->
	`uÅlug_â
(q);

6865 ià((
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV_STORE
) &&

6866 (
vœt_dev
->
dif_fd
 !ð
NULL
) &&

6867 (
	`sc¡_g‘_dif_aùiÚ
(
	`sc¡_g‘_dev_dif_aùiÚs
(
cmd
->
cmd_dif_aùiÚs
)è!ð
SCST_DIF_ACTION_NONE
)) {

6868 ià(
wr™e
)

6869 
	`vdev_wr™e_dif_gs
(
p
);

6871 
	`vdev_»ad_dif_gs
(
p
);

6874 
	`blockio_check_fšish
(
blockio_wÜk
);

6876 
out
:

6877 
	`TRACE_EXIT
();

6880 
ä“_bio
:

6881 
hbio
) {

6882 
bio
 = 
hbio
;

6883 
hbio
 = hbio->
bi_Ãxt
;

6884 
	`bio_put
(
bio
);

6886 
	`kmem_ÿche_ä“
(
blockio_wÜk_ÿch•
, 
blockio_wÜk
);

6888 
fšish_cmd
:

6889 
cmd
->
com¶‘ed
 = 1;

6890 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

6891 
out
;

6892 
	}
}

6894 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 37)

6895 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 3, 0)

6896 
	$vdev_æush_’d_io
(
bio
 *bio, 
”rÜ
)

6899 
	$vdev_æush_’d_io
(
bio
 *bio)

6901 
”rÜ
 = 
bio
->
bi_”rÜ
;

6903 
sc¡_cmd
 *
cmd
 = 
bio
->
bi_´iv©e
;

6905 
	`TRACE_ENTRY
();

6907 ià(
	`uÆik–y
(
”rÜ
 != 0)) {

6908 
	`PRINT_ERROR
("FLUSH bio failed: %d (cmd %p)",

6909 
”rÜ
, 
cmd
);

6910 ià(
cmd
 !ð
NULL
)

6911 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_wr™e_”rÜ
));

6914 ià(
cmd
 =ð
NULL
)

6915 
out_put
;

6917 
cmd
->
com¶‘ed
 = 1;

6918 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
	`sc¡_e¡im©e_cÚ‹xt
());

6920 
out_put
:

6921 
	`bio_put
(
bio
);

6923 
	`TRACE_EXIT
();

6925 
	}
}

6928 
	$vdisk_blockio_æush
(
block_deviû
 *
bdev
, 
gå_t
 
gå_mask
,

6929 
boÞ
 
»pÜt_”rÜ
, 
sc¡_cmd
 *
cmd
, boÞ 
async
)

6931 
»s
 = 0;

6933 
	`TRACE_ENTRY
();

6935 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 37)

6936 ià(
async
) {

6937 
bio
 *biØð
	`bio_®loc
(
gå_mask
, 0);

6939 ià(
bio
 =ð
NULL
) {

6940 
»s
 = -
ENOMEM
;

6941 
out_»p
;

6943 
bio
->
bi_’d_io
 = 
vdev_æush_’d_io
;

6944 
bio
->
bi_´iv©e
 = 
cmd
;

6945 
bio
->
bi_bdev
 = 
bdev
;

6946 
	`subm™_bio
(
WRITE_FLUSH
, 
bio
);

6947 
out
;

6952 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 35) \

6953 && !(
	`defšed
(
CONFIG_SUSE_KERNEL
) \

6954 && 
LINUX_VERSION_CODE
 =ð
	`KERNEL_VERSION
(2, 6, 34))

6955 
»s
 = 
	`blkdev_issue_æush
(
bdev
, 
NULL
);

6956 #–ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 37)

6957 
»s
 = 
	`blkdev_issue_æush
(
bdev
, 
gå_mask
, 
NULL
, 
BLKDEV_IFL_WAIT
);

6959 
»s
 = 
	`blkdev_issue_æush
(
bdev
, 
gå_mask
, 
NULL
);

6963 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 37)

6964 
out_»p
:

6966 ià((
»s
 !ð0è&& 
»pÜt_”rÜ
)

6967 
	`PRINT_ERROR
("%s() failed: %d",

6968 
async
 ? "bio_®loc" : "blkdev_issue_æush", 
»s
);

6970 ià(
async
 && (
cmd
 !ð
NULL
)) {

6971 
cmd
->
com¶‘ed
 = 1;

6972 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
,

6973 
	`sc¡_e¡im©e_cÚ‹xt
());

6976 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 37)

6977 
out
:

6979 
	`TRACE_EXIT_RES
(
»s
);

6980  
»s
;

6981 
	}
}

6983 
	sbio_´iv_sync
 {

6984 
com¶‘iÚ
 
	mc
;

6985 
	m”rÜ
;

6986 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 30)) && (LINUX_VERSION_CODE <= KERNEL_VERSION(3, 6, 0))

6987 
bio_£t
 *
	mbs
;

6988 
com¶‘iÚ
 
	mc1
;

6992 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 30)) && (LINUX_VERSION_CODE <= KERNEL_VERSION(3, 6, 0))

6993 
	$blockio_bio_de¡ruùÜ_sync
(
bio
 *bio)

6995 
bio_´iv_sync
 *
s
 = 
bio
->
bi_´iv©e
;

6996 
	`bio_ä“
(
bio
, 
s
->
bs
);

6997 
	`com¶‘e
(&
s
->
c1
);

6998 
	}
}

7001 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 24)

7002 
	$blockio_’d_sync_io
(
bio
 *bio, 
by‹s_dÚe
,

7003 
”rÜ
)

7005 #–ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 3, 0)

7006 
	$blockio_’d_sync_io
(
bio
 *bio, 
”rÜ
)

7009 
	$blockio_’d_sync_io
(
bio
 *bio)

7011 
”rÜ
 = 
bio
->
bi_”rÜ
;

7013 
bio_´iv_sync
 *
s
 = 
bio
->
bi_´iv©e
;

7015 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 24)

7016 ià(
bio
->
bi_size
)

7020 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 3, 0)

7021 ià(!
	`bio_æagged
(
bio
, 
BIO_UPTODATE
è&& 
”rÜ
 == 0) {

7022 
	`PRINT_ERROR
("Not upo date bio withƒrror 0;„eturning -EIO");

7023 
”rÜ
 = -
EIO
;

7027 
s
->
”rÜ
 =ƒrror;

7028 
	`com¶‘e
(&
s
->
c
);

7030 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 24)

7035 
	}
}

7048 
ssize_t
 
	$blockio_rw_sync
(
sc¡_vdisk_dev
 *
vœt_dev
, *
buf
,

7049 
size_t
 
Ën
, 
loff_t
 *
loff
, 
rw
)

7051 
bio_´iv_sync
 
s
 = {

7052 
	`COMPLETION_INITIALIZER_ONSTACK
(
s
.
c
), 0,

7053 #ià(
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 30)) && (LINUX_VERSION_CODE <= KERNEL_VERSION(3, 6, 0))

7054 
vœt_dev
->
vdisk_bio£t
,

7055 
	`COMPLETION_INITIALIZER_ONSTACK
(
s
.
c1
)

7058 
block_deviû
 *
bdev
 = 
vœt_dev
->bdev;

7059 cÚ¡ 
boÞ
 
is_vm®loc
 = 
	`is_vm®loc_addr
(
buf
);

7060 
bio
 *bio;

7061 *
p
;

7062 
·ge
 *
q
;

7063 
max_Ä_vecs
, 
rc
;

7064 
by‹s
, 
off
;

7065 
ssize_t
 
»t
 = -
ENOMEM
;

7066 #ià(
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 30)) && (LINUX_VERSION_CODE <= KERNEL_VERSION(3, 6, 0))

7067 
boÞ
 
subm™‹d
 = 
çl£
;

7070 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(4, 3, 0)

7071 
max_Ä_vecs
 = 
BIO_MAX_PAGES
;

7073 
max_Ä_vecs
 = 
	`mš
(
	`bio_g‘_Ä_vecs
(
bdev
), 
BIO_MAX_PAGES
);

7076 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 30)

7077 
bio
 = 
	`bio_®loc_bio£t
(
GFP_KERNEL
, 
max_Ä_vecs
, 
vœt_dev
->
vdisk_bio£t
);

7079 
bio
 = 
	`bio_®loc
(
GFP_KERNEL
, 
max_Ä_vecs
);

7082 ià(!
bio
)

7083 
out
;

7085 
bio
->
bi_rw
 = 
rw
;

7086 
bio
->
bi_bdev
 = 
bdev
;

7087 
bio
->
bi_’d_io
 = 
blockio_’d_sync_io
;

7088 
bio
->
bi_´iv©e
 = &
s
;

7089 #ià(
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 30)) && (LINUX_VERSION_CODE <= KERNEL_VERSION(3, 6, 0))

7090 
bio
->
bi_de¡ruùÜ
 = 
blockio_bio_de¡ruùÜ_sync
;

7092 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3, 14, 0)

7093 
bio
->
bi_£ùÜ
 = *
loff
 >> 9;

7095 
bio
->
bi_™”
.
bi_£ùÜ
 = *
loff
 >> 9;

7097 
p
 = 
buf
;… < buà+ 
Ën
;… +ð
by‹s
) {

7098 
off
 = 
	`off£t_š_·ge
(
p
);

7099 
by‹s
 = 
	`mš_t
(
size_t
, 
PAGE_SIZE
 - 
off
, 
buf
 + 
Ën
 - 
p
);

7100 
q
 = 
is_vm®loc
 ? 
	`vm®loc_to_·ge
(
p
è: 
	`vœt_to_·ge
(p);

7101 
rc
 = 
	`bio_add_·ge
(
bio
, 
q
, 
by‹s
, 
off
);

7102 ià(
rc
 < 
by‹s
) {

7103 ià(
rc
 <ð0 && 
p
 =ð
buf
) {

7104 
ä“
;

7106 ià(
rc
 > 0)

7107 
p
 +ð
rc
;

7112 
	`subm™_bio
(
rw
, 
bio
);

7113 #ià(
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 30)) && (LINUX_VERSION_CODE <= KERNEL_VERSION(3, 6, 0))

7114 
subm™‹d
 = 
Œue
;

7116 
	`wa™_fÜ_com¶‘iÚ
(&
s
.
c
);

7117 
»t
 = ()
s
.
”rÜ
;

7118 ià(
	`lik–y
(
»t
 == 0)) {

7119 
»t
 = 
p
 - 
buf
;

7120 *
loff
 +ð
»t
;

7123 
ä“
:

7124 
	`bio_put
(
bio
);

7125 #ià(
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 30)) && (LINUX_VERSION_CODE <= KERNEL_VERSION(3, 6, 0))

7126 ià(
subm™‹d
)

7127 
	`wa™_fÜ_com¶‘iÚ
(&
s
.
c1
);

7130 
out
:

7131  
»t
;

7132 
	}
}

7135 
ssize_t
 
	$fžeio_»ad_sync
(
fže
 *
fd
, *
buf
, 
size_t
 
Ën
,

7136 
loff_t
 *
loff
)

7138 
mm_£gm’t_t
 
Þd_fs
;

7139 
ssize_t
 
»t
;

7141 
Þd_fs
 = 
	`g‘_fs
();

7142 
	`£t_fs
(
	`g‘_ds
());

7143 
»t
 = 
	`vfs_»ad
(
fd
, (
__fÜû
 
__u£r
 *)
buf
, 
Ën
, 
loff
);

7144 
	`£t_fs
(
Þd_fs
);

7146  
»t
;

7147 
	}
}

7150 
ssize_t
 
	$vdev_»ad_sync
(
sc¡_vdisk_dev
 *
vœt_dev
, *
buf
,

7151 
size_t
 
Ën
, 
loff_t
 *
loff
)

7153 
ssize_t
 
»ad
, 
»s
;

7155 ià(
vœt_dev
->
nuÎio
) {

7156  
Ën
;

7157 } ià(
vœt_dev
->
blockio
) {

7158 
»ad
 = 0;„—d < 
Ën
;„—d +ð
»s
) {

7159 
»s
 = 
	`blockio_rw_sync
(
vœt_dev
, 
buf
 + 
»ad
, 
Ën
 -„ead,

7160 
loff
, 
READ_SYNC
);

7161 ià(
»s
 < 0)

7162  
»s
;

7164  
»ad
;

7166  
	`fžeio_»ad_sync
(
vœt_dev
->
fd
, 
buf
, 
Ën
, 
loff
);

7168 
	}
}

7170 
com¶_¡©us_e
 
	$vdev_exec_v”ify
(
vdisk_cmd_·¿ms
 *
p
)

7172 
sc¡_cmd
 *
cmd
 = 
p
->cmd;

7173 
loff_t
 
loff
 = 
p
->loff;

7174 
loff_t
 
”r
;

7175 
ssize_t
 
Ëngth
, 
Ën_mem
 = 0;

7176 
ušt8_t
 *
add»ss_§v
, *
add»ss
 = 
NULL
;

7177 
com·»
;

7178 
sc¡_vdisk_dev
 *
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

7179 
ušt8_t
 *
mem_v”ify
 = 
NULL
;

7180 
št64_t
 
d©a_Ën
 = 
	`sc¡_cmd_g‘_d©a_Ën
(
cmd
);

7181 
sc¡_dif_aùiÚs
 
checks
 = 
	`sc¡_g‘_dif_checks
(
cmd
->
cmd_dif_aùiÚs
);

7183 
	`TRACE_ENTRY
();

7185 ià(
	`vdisk_fsync
(
loff
, 
d©a_Ën
, 
cmd
->
dev
,

7186 
cmd
->
cmd_gå_mask
, cmd, 
çl£
) != 0)

7187 
out
;

7197 
com·»
 = 
	`sc¡_cmd_g‘_d©a_dœeùiÚ
(
cmd
è=ð
SCST_DATA_WRITE
;

7198 
	`TRACE_DBG
("VERIFY with compare %d‡t offset %lld‡nd†en %lld\n",

7199 
com·»
, 
loff
, ()
d©a_Ën
);

7201 
mem_v”ify
 = 
	`vm®loc
(
LEN_MEM
);

7202 ià(
mem_v”ify
 =ð
NULL
) {

7203 
	`PRINT_ERROR
("Unableo‡llocate memory %d for verify",

7204 
LEN_MEM
);

7205 
	`sc¡_£t_busy
(
cmd
);

7206 
out
;

7209 ià(
com·»
) {

7210 
Ëngth
 = 
	`sc¡_g‘_buf_fœ¡
(
cmd
, &
add»ss
);

7211 
add»ss_§v
 = 
add»ss
;

7213 
Ëngth
 = 
d©a_Ën
;

7215 
Ëngth
 > 0) {

7216 
Ën_mem
 = (
Ëngth
 > 
LEN_MEM
) ? LEN_MEM :†ength;

7217 
	`TRACE_DBG
("V”ify:†’gth %zd -†’_mem %zd", 
Ëngth
, 
Ën_mem
);

7219 
”r
 = 
	`vdev_»ad_sync
(
vœt_dev
, 
mem_v”ify
, 
Ën_mem
, &
loff
);

7220 ià((
”r
 < 0è|| (”¸< 
Ën_mem
)) {

7221 
	`PRINT_ERROR
("verify()„eturned %lld from %zd",

7222 ()
”r
, 
Ën_mem
);

7223 ià(
”r
 =ð-
EAGAIN
)

7224 
	`sc¡_£t_busy
(
cmd
);

7226 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

7227 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»ad_”rÜ
));

7229 ià(
com·»
)

7230 
	`sc¡_put_buf
(
cmd
, 
add»ss_§v
);

7231 
out_ä“
;

7234 ià(
com·»
 && 
	`memcmp
(
add»ss
, 
mem_v”ify
, 
Ën_mem
) != 0) {

7235 
	`TRACE_DBG
("V”ify:ƒ¼Ü memcm°Ëngth %zd", 
Ëngth
);

7236 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

7237 
	`SCST_LOAD_SENSE
(
sc¡_£n£_miscom·»_”rÜ
));

7238 
	`sc¡_put_buf
(
cmd
, 
add»ss_§v
);

7239 
out_ä“
;

7242 ià(
checks
 != 0) {

7246 
Ëngth
 -ð
Ën_mem
;

7247 ià(
com·»
)

7248 
add»ss
 +ð
Ën_mem
;

7249 ià(
com·»
 && 
Ëngth
 <= 0) {

7250 
	`sc¡_put_buf
(
cmd
, 
add»ss_§v
);

7251 
Ëngth
 = 
	`sc¡_g‘_buf_Ãxt
(
cmd
, &
add»ss
);

7252 
add»ss_§v
 = 
add»ss
;

7256 ià(
Ëngth
 < 0) {

7257 
	`PRINT_ERROR
("sc¡_g‘_buf_(èçžed: %zd", 
Ëngth
);

7258 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

7259 
	`SCST_LOAD_SENSE
(
sc¡_£n£_š‹º®_çžu»
));

7262 
out_ä“
:

7263 ià(
mem_v”ify
)

7264 
	`vä“
(
mem_v”ify
);

7266 
out
:

7267 
	`TRACE_EXIT
();

7268  
CMD_SUCCEEDED
;

7269 
	}
}

7271 
com¶_¡©us_e
 
	$blockio_exec_wr™e_v”ify
(
vdisk_cmd_·¿ms
 *
p
)

7274 
	`PRINT_WARNING
("vdisk_blockio: WRITE VERIFY is‚ot yet implemented");

7275  
	`blockio_exec_wr™e
(
p
);

7276 
	}
}

7278 
com¶_¡©us_e
 
	$fžeio_exec_wr™e_v”ify
(
vdisk_cmd_·¿ms
 *
p
)

7280 
	`fžeio_exec_wr™e
(
p
);

7282 ià(
	`scsi_¡©us_is_good
(
p
->
cmd
->
¡©us
))

7283 
	`vdev_exec_v”ify
(
p
);

7284  
CMD_SUCCEEDED
;

7285 
	}
}

7287 
com¶_¡©us_e
 
	$nuÎio_exec_wr™e_v”ify
(
vdisk_cmd_·¿ms
 *
p
)

7289 
	`sc¡_dif_´oûss_wr™e
(
p
->
cmd
);

7290  
CMD_SUCCEEDED
;

7291 
	}
}

7293 
com¶_¡©us_e
 
	$nuÎio_exec_v”ify
(
vdisk_cmd_·¿ms
 *
p
)

7295  
CMD_SUCCEEDED
;

7296 
	}
}

7298 
	$blockio_Ú_®ua_¡©e_chªge_¡¬t
(
sc¡_deviû
 *
dev
,

7299 
sc¡_tg_¡©e
 
Þd_¡©e
, sc¡_tg_¡©
Ãw_¡©e
)

7301 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

7303 
	`TRACE_ENTRY
();

7310 
	`TRACE_MGMT_DBG
("ALUA state change from %so %s started, closing FD (dev %s)",

7311 
	`sc¡_®ua_¡©e_Çme
(
Þd_¡©e
), sc¡_®ua_¡©e_Çme(
Ãw_¡©e
),

7312 
dev
->
vœt_Çme
);

7315 
	`vdisk_þo£_fd
(
vœt_dev
);

7317 
	`TRACE_EXIT
();

7319 
	}
}

7321 
	$blockio_Ú_®ua_¡©e_chªge_fšish
(
sc¡_deviû
 *
dev
,

7322 
sc¡_tg_¡©e
 
Þd_¡©e
, sc¡_tg_¡©
Ãw_¡©e
)

7324 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

7326 
	`TRACE_ENTRY
();

7333 ià((
Ãw_¡©e
 =ð
SCST_TG_STATE_OPTIMIZED
) ||

7334 (
Ãw_¡©e
 =ð
SCST_TG_STATE_NONOPTIMIZED
)) {

7336 
rc
;

7338 
	`TRACE_MGMT_DBG
("ALUA state change from %so %s finished (dev %s), "

7339 "»Ý’nšg FD", 
	`sc¡_®ua_¡©e_Çme
(
Þd_¡©e
),

7340 
	`sc¡_®ua_¡©e_Çme
(
Ãw_¡©e
), 
dev
->
vœt_Çme
);

7342 
rc
 = 
	`vdisk_Ý’_fd
(
vœt_dev
, 
dev
->
dev_rd_Úly
);

7343 ià(
rc
 == 0) {

7344 ià(
vœt_dev
->
»exam_³ndšg
) {

7345 
rc
 = 
	`vdisk_»examše
(
vœt_dev
);

7346 
	`WARN_ON
(
rc
 != 0);

7347 
vœt_dev
->
»exam_³ndšg
 = 0;

7350 
	`PRINT_ERROR
("Unableo open fd on ALUA state change "

7351 "tØ% (dev %s)", 
dev
->
vœt_Çme
,

7352 
	`sc¡_®ua_¡©e_Çme
(
Ãw_¡©e
));

7355 
	`TRACE_DBG
("ALUA state change from %so %s finished (dev %s)",

7356 
	`sc¡_®ua_¡©e_Çme
(
Þd_¡©e
), sc¡_®ua_¡©e_Çme(
Ãw_¡©e
),

7357 
dev
->
vœt_Çme
);

7359 
	`TRACE_EXIT
();

7361 
	}
}

7363 
	$vdisk_sk_mgmt_â_dÚe
(
sc¡_mgmt_cmd
 *
mcmd
,

7364 
sc¡_tgt_dev
 *
tgt_dev
)

7366 
	`TRACE_ENTRY
();

7368 ià((
mcmd
->
â
 =ð
SCST_LUN_RESET
è|| (mcmd->â =ð
SCST_TARGET_RESET
)) {

7370 
sc¡_deviû
 *
dev
 = 
tgt_dev
->dev;

7371 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

7372 
rc
;

7374 
dev
->
tmf_Úly
 = dev->
tmf_Úly_§ved
;

7375 
dev
->
d_£n£
 = dev->
d_£n£_§ved
;

7376 
dev
->
dpicz
 = dev->
dpicz_§ved
;

7377 
dev
->
swp
 = dev->
swp_§ved
;

7378 
dev
->
s
 = dev->
s_§ved
;

7379 
dev
->
queue_®g
 = dev->
queue_®g_§ved
;

7380 
dev
->
q”r
 = dev->
q”r_§ved
;

7382 
dev
->
t¡
 = 
vœt_dev
->tst;

7384 
rc
 = 
	`vdisk_£t_wt
(
vœt_dev
, 
DEF_WRITE_THROUGH
,

7385 
tgt_dev
->
tgt_dev_rd_Úly
);

7386 ià(
rc
 != 0) {

7387 
	`PRINT_CRIT_ERROR
("Unableo„eset caching modeo %d",

7388 
DEF_WRITE_THROUGH
);

7391 
	`¥š_lock
(&
vœt_dev
->
æags_lock
);

7392 
vœt_dev
->
´ev’t_®low_medium_»mov®
 = 0;

7393 
	`¥š_uÆock
(&
vœt_dev
->
æags_lock
);

7394 } ià(
mcmd
->
â
 =ð
SCST_PR_ABORT_ALL
) {

7395 
sc¡_deviû
 *
dev
 = 
tgt_dev
->dev;

7396 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

7398 
	`¥š_lock
(&
vœt_dev
->
æags_lock
);

7399 
vœt_dev
->
´ev’t_®low_medium_»mov®
 = 0;

7400 
	`¥š_uÆock
(&
vœt_dev
->
æags_lock
);

7403 
	`TRACE_EXIT
();

7405 
	}
}

7407 #ifdeà
CONFIG_DEBUG_EXT_COPY_REMAP


7408 
	$vdev_ext_cÝy_»m­
(
sc¡_cmd
 *
cmd
,

7409 
sc¡_ext_cÝy_£g_desü
 *
£g
)

7411 
sc¡_ext_cÝy_d©a_desü
 *
d
;

7412 
shiá
;

7413 
	`DEFINE_SPINLOCK
(
lock
);

7414 
s
;

7416 
	`TRACE_ENTRY
();

7418 ià(
£g
->
d©a_desü
.
d©a_Ën
 <= 4096) {

7420 
out_dÚe
;

7423 
d
 = 
	`kz®loc
((*d)*2, 
GFP_KERNEL
);

7424 ià(
d
 =ð
NULL
)

7425 
out_busy
;

7427 
	`¥š_lock
(&
lock
);

7429 
shiá
 += 4096;

7431 ià(
shiá
 >ð
£g
->
d©a_desü
.
d©a_Ën
) {

7432 
shiá
 = 0;

7433 
s
 = 0;

7435 
s
 = 
shiá
;

7437 
	`TRACE_DBG
("cmd %p, seg %p, d©a_ËÀ%d, shiá %d, s %d", 
cmd
, 
£g
,

7438 
£g
->
d©a_desü
.
d©a_Ën
, 
shiá
, 
s
);

7440 
	`¥š_uÆock
(&
lock
);

7442 ià(
s
 == 0)

7443 
out_ä“_dÚe
;

7445 
d
[0].
d©a_Ën
 = 
s
;

7446 
d
[0].
¤c_lba
 = 
£g
->
d©a_desü
.src_lba;

7447 
d
[0].
d¡_lba
 = 
£g
->
d©a_desü
.dst_lba;

7449 
d
[1].
d©a_Ën
 = 
£g
->
d©a_desü
.d©a_ËÀ- 
s
;

7450 
d
[1].
¤c_lba
 = 
£g
->
d©a_desü
.¤c_lb¨+ (
s
 >> seg->
¤c_tgt_dev
->
dev
->
block_shiá
);

7451 
d
[1].
d¡_lba
 = 
£g
->
d©a_desü
.d¡_lb¨+ (
s
 >> seg->
d¡_tgt_dev
->
dev
->
block_shiá
);

7453 
	`sc¡_ext_cÝy_»m­_dÚe
(
cmd
, 
d
, 2);

7455 
out
:

7456 
	`TRACE_EXIT
();

7459 
out_busy
:

7460 
	`sc¡_£t_busy
(
cmd
);

7462 
out_ä“_dÚe
:

7463 
	`kä“
(
d
);

7465 
out_dÚe
:

7467 
	`sc¡_ext_cÝy_»m­_dÚe
(
cmd
, &
£g
->
d©a_desü
, 1);

7469 
	`sc¡_ext_cÝy_»m­_dÚe
(
cmd
, 
NULL
, 0);

7471 
out
;

7472 
	}
}

7475 
	$vdisk_»pÜt_»gi¡”šg
(cÚ¡ 
sc¡_vdisk_dev
 *
vœt_dev
)

7477 ’um { 
buf_size
 = 256 };

7478 *
buf
 = 
	`km®loc
(
buf_size
, 
GFP_KERNEL
);

7479 
i
, 
j
;

7481 ià(!
buf
) {

7482 
	`PRINT_ERROR
("%s: ouˆoàmemÜy", 
__func__
);

7486 
i
 = 
	`¢´štf
(
buf
, 
buf_size
, "Registering virtual %s device %s ",

7487 
vœt_dev
->
vdev_devt
->
Çme
, virt_dev->name);

7488 
j
 = 
i
;

7490 ià(
vœt_dev
->
wt_æag
)

7491 
i
 +ð
	`¢´štf
(&
buf
[i], 
buf_size
 - i, "(WRITE_THROUGH");

7493 ià(
vœt_dev
->
nv_ÿche
)

7494 
i
 +ð
	`¢´štf
(&
buf
[i], 
buf_size
 - i, "%sNV_CACHE",

7495 (
j
 =ð
i
) ? "(" : ", ");

7497 ià(
vœt_dev
->
rd_Úly
)

7498 
i
 +ð
	`¢´štf
(&
buf
[i], 
buf_size
 - i, "%sREAD_ONLY",

7499 (
j
 =ð
i
) ? "(" : ", ");

7501 ià(
vœt_dev
->
o_dœeù_æag
)

7502 
i
 +ð
	`¢´štf
(&
buf
[i], 
buf_size
 - i, "%sO_DIRECT",

7503 (
j
 =ð
i
) ? "(" : ", ");

7505 ià(
vœt_dev
->
nuÎio
)

7506 
i
 +ð
	`¢´štf
(&
buf
[i], 
buf_size
 - i, "%sNULLIO",

7507 (
j
 =ð
i
) ? "(" : ", ");

7509 ià(
vœt_dev
->
blockio
)

7510 
i
 +ð
	`¢´štf
(&
buf
[i], 
buf_size
 - i, "%sBLOCKIO",

7511 (
j
 =ð
i
) ? "(" : ", ");

7513 ià(
vœt_dev
->
»movabË
)

7514 
i
 +ð
	`¢´štf
(&
buf
[i], 
buf_size
 - i, "%sREMOVABLE",

7515 (
j
 =ð
i
) ? "(" : ", ");

7517 ià(
vœt_dev
->
t¡
 !ð
DEF_TST
)

7518 
i
 +ð
	`¢´štf
(&
buf
[i], 
buf_size
 - i, "%sTST %d",

7519 (
j
 =ð
i
è? "(" : ", ", 
vœt_dev
->
t¡
);

7521 ià(
vœt_dev
->
rÙ©iÚ®
)

7522 
i
 +ð
	`¢´štf
(&
buf
[i], 
buf_size
 - i, "%sROTATIONAL",

7523 (
j
 =ð
i
) ? "(" : ", ");

7525 ià(
vœt_dev
->
thš_´ovisiÚed
)

7526 
i
 +ð
	`¢´štf
(&
buf
[i], 
buf_size
 - i, "%sTHIN_PROVISIONED",

7527 (
j
 =ð
i
) ? "(" : ", ");

7529 ià(
vœt_dev
->
dif_mode
 !ð
SCST_DIF_MODE_NONE
) {

7530 
i
 +ð
	`¢´štf
(&
buf
[i], 
buf_size
 - i, "%sDIF MODE %x, "

7531 "DIF TYPE %d", (
j
 =ð
i
) ? "(" : ", ",

7532 
vœt_dev
->
dif_mode
, vœt_dev->
dif_ty³
);

7533 ià(
vœt_dev
->
dif_fž’ame
 !ð
NULL
)

7534 
i
 +ð
	`¢´štf
(&
buf
[i], 
buf_size
 - i, ", DIF FILENAME %s",

7535 
vœt_dev
->
dif_fž’ame
);

7536 ià(
vœt_dev
->
dif_¡©ic_­p_g_combšed
 !ð
SCST_DIF_NO_CHECK_APP_TAG
)

7537 
i
 +ð
	`¢´štf
(&
buf
[i], 
buf_size
 - i, ", DIF STATIC APP TAG %llx",

7538 ()
	`be64_to_ýu
(
vœt_dev
->
dif_¡©ic_­p_g_combšed
));

7541 ià(
vœt_dev
->
z”o_cÝy
)

7542 
i
 +ð
	`¢´štf
(&
buf
[i], 
buf_size
 - i, "%sZERO_COPY",

7543 (
j
 =ð
i
) ? "(" : ", ");

7545 ià(
vœt_dev
->
dummy
)

7546 
i
 +ð
	`¢´štf
(&
buf
[i], 
buf_size
 - i, "%sDUMMY",

7547 (
j
 =ð
i
) ? "(" : ", ");

7549 
	`PRINT_INFO
("%s%s", 
buf
, 
j
 =ð
i
 ? "" : ")");

7551 
	`kä“
(
buf
);

7554 
	}
}

7556 
	$vdisk_»sync_size
(
sc¡_vdisk_dev
 *
vœt_dev
)

7558 
loff_t
 
fže_size
;

7559 
»s
 = 0;

7561 
	`sBUG_ON
(
vœt_dev
->
nuÎio
);

7562 
	`sBUG_ON
(!
vœt_dev
->
fž’ame
);

7564 ià(
vœt_dev
->
fd
 =ð
NULL
) {

7565 
»s
 = -
EMEDIUMTYPE
;

7566 
out
;

7569 
»s
 = 
	`vdisk_g‘_fže_size
(
vœt_dev
->
fž’ame
,

7570 
vœt_dev
->
blockio
, &
fže_size
);

7571 ià(
»s
 != 0)

7572 
out
;

7574 ià(
fže_size
 =ð
vœt_dev
->file_size) {

7575 
	`PRINT_INFO
("Size of virtual disk %s„emainedhe same",

7576 
vœt_dev
->
Çme
);

7577 
out
;

7580 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
SCST_SUSPEND_TIMEOUT_USER
);

7581 ià(
»s
 != 0)

7582 
out
;

7584 
vœt_dev
->
fže_size
 = file_size;

7585 
vœt_dev
->
nblocks
 = vœt_dev->
fže_size
 >> vœt_dev->
dev
->
block_shiá
;

7587 
vœt_dev
->
size_key
 = 0;

7589 
	`PRINT_INFO
("New size of SCSIarget virtual disk %s "

7591 
vœt_dev
->
Çme
, vœt_dev->
fže_size
 >> 20,

7592 
vœt_dev
->
dev
->
block_size
,

7593 ()
vœt_dev
->
nblocks
,

7594 ()
vœt_dev
->
nblocks
/64/32,

7595 
vœt_dev
->
nblocks
 < 64*32 ? " !WARNING! cyln†ess "

7598 
	`sc¡_ÿ·c™y_d©a_chªged
(
vœt_dev
->
dev
);

7600 
	`sc¡_»sume_aùiv™y
();

7601 
out
:

7602  
»s
;

7603 
	}
}

7605 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 30)

7606 
	$vdisk_ü—‹_bio£t
(
sc¡_vdisk_dev
 *
vœt_dev
)

7608 
»s
;

7610 
	`EXTRACHECKS_BUG_ON
(
vœt_dev
->
vdisk_bio£t
 || !vœt_dev->
blockio
);

7613 
vœt_dev
->
vdisk_bio£t
 = 
	`bio£t_ü—‹
(2, 0);

7614 ià(
vœt_dev
->
vdisk_bio£t
 =ð
NULL
) {

7615 
	`PRINT_ERROR
("FažedØü—‹ bio£ˆ(dev %s)", 
vœt_dev
->
Çme
);

7616 
»s
 = -
ENOMEM
;

7617 
out
;

7620 ià(
vœt_dev
->
dif_mode
 & 
SCST_DIF_MODE_DEV
) {

7621 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 31)

7623 
»s
 = 
	`bio£t_š‹gr™y_ü—‹
(
vœt_dev
->
vdisk_bio£t
, 2);

7625 
»s
 = -
ENOTSUPP
;

7627 ià(
»s
 != 0) {

7628 
	`PRINT_ERROR
("Failedo create integrity bioset "

7629 "(dev %s)", 
vœt_dev
->
Çme
);

7630 
out_ä“
;

7634 
»s
 = 0;

7636 
out
:

7637  
»s
;

7639 
out_ä“
:

7640 
	`bio£t_ä“
(
vœt_dev
->
vdisk_bio£t
);

7641 
vœt_dev
->
vdisk_bio£t
 = 
NULL
;

7642 
out
;

7643 
	}
}

7645 
	$vdisk_ä“_bio£t
(
sc¡_vdisk_dev
 *
vœt_dev
)

7647 ià(
vœt_dev
->
vdisk_bio£t
 !ð
NULL
)

7648 
	`bio£t_ä“
(
vœt_dev
->
vdisk_bio£t
);

7649 
	}
}

7653 
	$vdev_ü—‹
(
sc¡_dev_ty³
 *
devt
,

7654 cÚ¡ *
Çme
, 
sc¡_vdisk_dev
 **
»s_vœt_dev
)

7656 
»s
;

7657 
sc¡_vdisk_dev
 *
vœt_dev
, *
vv
;

7658 
ušt64_t
 
dev_id_num
;

7660 
»s
 = -
EEXIST
;

7661 ià(
	`vdev_fšd
(
Çme
))

7662 
out
;

7665 
vœt_dev
 = 
	`kz®loc
((*vœt_dev), 
GFP_KERNEL
);

7666 ià(
vœt_dev
 =ð
NULL
) {

7667 
	`PRINT_ERROR
("Allocation of virtual device %s failed",

7668 
devt
->
Çme
);

7669 
»s
 = -
ENOMEM
;

7670 
out
;

7673 
	`¥š_lock_š™
(&
vœt_dev
->
æags_lock
);

7675 
vœt_dev
->
vdev_devt
 = 
devt
;

7677 
vœt_dev
->
rd_Úly
 = 
DEF_RD_ONLY
;

7678 
vœt_dev
->
dummy
 = 
DEF_DUMMY
;

7679 
vœt_dev
->
»ad_z”o
 = 
DEF_READ_ZERO
;

7680 
vœt_dev
->
»movabË
 = 
DEF_REMOVABLE
;

7681 
vœt_dev
->
rÙ©iÚ®
 = 
DEF_ROTATIONAL
;

7682 
vœt_dev
->
thš_´ovisiÚed
 = 
DEF_THIN_PROVISIONED
;

7683 
vœt_dev
->
t¡
 = 
DEF_TST
;

7684 
vœt_dev
->
ex¶_®ua
 = 
DEF_EXPL_ALUA
;

7686 
vœt_dev
->
blk_shiá
 = 
DEF_DISK_BLOCK_SHIFT
;

7688 ià(
	`¡¾’
(
Çme
è>ð(
vœt_dev
->name)) {

7689 
	`PRINT_ERROR
("Nam% i toØlÚg (max‡Îowed %zd)", 
Çme
,

7690 (
vœt_dev
->
Çme
)-1);

7691 
»s
 = -
EINVAL
;

7692 
out_ä“
;

7694 
	`¡rýy
(
vœt_dev
->
Çme
,‚ame);

7696 
dev_id_num
 = 
	`vdisk_g’_dev_id_num
(
vœt_dev
->
Çme
);

7698 
	`¢´štf
(
vœt_dev
->
t10_dev_id
, (virt_dev->t10_dev_id),

7699 "%Îx-%s", 
dev_id_num
, 
vœt_dev
->
Çme
);

7700 
	`TRACE_DBG
("t10_dev_id %s", 
vœt_dev
->
t10_dev_id
);

7702 
	`¥rštf
(
vœt_dev
->
t10_v’d_id
, "%.*s",

7703 ()(
vœt_dev
->
t10_v’d_id
è- 1, 
SCST_FIO_VENDOR
);

7705 
	`¥rštf
(
vœt_dev
->
v’d_¥ecific_id
, "%.*s",

7706 ()((
vœt_dev
->
v’d_¥ecific_id
) - 1),

7707 
vœt_dev
->
t10_dev_id
);

7709 
	`¥rštf
(
vœt_dev
->
´od_id
, "%.*s", ()((virt_dev->prod_id) - 1),

7710 
vœt_dev
->
Çme
);

7712 
	`¥rštf
(
vœt_dev
->
´od_»v_lvl
, "%.*s",

7713 ()((
vœt_dev
->
´od_»v_lvl
è- 1), 
SCST_FIO_REV
);

7715 
	`¥rštf
(
vœt_dev
->
scsi_deviû_Çme
, "%.*s",

7716 ()((
vœt_dev
->
scsi_deviû_Çme
) - 1), "");

7718 
vœt_dev
->
eui64_id_Ën
 = 0;

7719 
vœt_dev
->
Ça_id_Ën
 = 0;

7721 
	`sú´štf
(
vœt_dev
->
u¢
, (vœt_dev->u¢), "%Îx", 
dev_id_num
);

7722 
	`TRACE_DBG
("u¢ %s", 
vœt_dev
->
u¢
);

7724 
	`li¡_fÜ_—ch_’Œy
(
vv
, &
vdev_li¡
, 
vdev_li¡_’Œy
) {

7725 ià(
	`¡rcmp
(
vœt_dev
->
u¢
, 
vv
->usn) == 0) {

7726 
	`PRINT_ERROR
("New usn %s conflicts with one of dev %s",

7727 
vœt_dev
->
u¢
, 
vv
->
Çme
);

7728 
»s
 = -
EEXIST
;

7729 
out_ä“
;

7733 *
»s_vœt_dev
 = 
vœt_dev
;

7734 
»s
 = 0;

7736 
out
:

7737  
»s
;

7739 
out_ä“
:

7740 
	`kä“
(
vœt_dev
);

7741 
out
;

7742 
	}
}

7744 
	$vdev_de¡roy
(
sc¡_vdisk_dev
 *
vœt_dev
)

7746 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 30)

7747 
	`vdisk_ä“_bio£t
(
vœt_dev
);

7749 
	`kä“
(
vœt_dev
->
fž’ame
);

7750 
	`kä“
(
vœt_dev
->
dif_fž’ame
);

7751 
	`kä“
(
vœt_dev
);

7753 
	}
}

7755 #iâdeà
CONFIG_SCST_PROC


7757 
	$vdev_·r£_add_dev_·¿ms
(
sc¡_vdisk_dev
 *
vœt_dev
,

7758 *
·¿ms
, cÚ¡ *cÚ¡ 
®lowed_·¿ms
[])

7760 
»s
 = 0;

7761 
v®
;

7762 *
·¿m
, *
p
, *
µ
;

7764 
	`TRACE_ENTRY
();

7767 
·¿m
 = 
	`sc¡_g‘_Ãxt_tok’_¡r
(&
·¿ms
);

7768 ià(
·¿m
 =ð
NULL
)

7771 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
·¿m
);

7772 ià(*
p
 == '\0') {

7773 
	`PRINT_ERROR
("Syntaxƒrror‡t %s (device %s)",

7774 
·¿m
, 
vœt_dev
->
Çme
);

7775 
»s
 = -
EINVAL
;

7776 
out
;

7779 ià(
®lowed_·¿ms
 !ð
NULL
) {

7780 cÚ¡ *cÚ¡ *
a
 = 
®lowed_·¿ms
;

7781 
boÞ
 
®lowed
 = 
çl£
;

7783 *
a
 !ð
NULL
) {

7784 ià(!
	`¡rÿ£cmp
(*
a
, 
p
)) {

7785 
®lowed
 = 
Œue
;

7788 
a
++;

7791 ià(!
®lowed
) {

7792 
	`PRINT_ERROR
("UnknowÀ·¿m‘” % (deviû %s)", 
p
,

7793 
vœt_dev
->
Çme
);

7794 
»s
 = -
EINVAL
;

7795 
out
;

7799 
µ
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
·¿m
);

7800 ià(*
µ
 == '\0') {

7801 
	`PRINT_ERROR
("Parameter %s value missed for device %s",

7802 
p
, 
vœt_dev
->
Çme
);

7803 
»s
 = -
EINVAL
;

7804 
out
;

7807 ià(
	`sc¡_g‘_Ãxt_Ëxem
(&
·¿m
)[0] != '\0') {

7808 
	`PRINT_ERROR
("Too many…arameter's %s values (device %s)",

7809 
p
, 
vœt_dev
->
Çme
);

7810 
»s
 = -
EINVAL
;

7811 
out
;

7814 ià(!
	`¡rÿ£cmp
("fž’ame", 
p
)) {

7815 ià(
vœt_dev
->
fž’ame
) {

7816 
	`PRINT_ERROR
("%s specified morehan once"

7817 " (deviû %s)", 
p
, 
vœt_dev
->
Çme
);

7818 
»s
 = -
EINVAL
;

7819 
out
;

7821 ià(*
µ
 != '/') {

7822 
	`PRINT_ERROR
("Filename %s must be global "

7823 "(deviû %s)", 
µ
, 
vœt_dev
->
Çme
);

7824 
»s
 = -
EINVAL
;

7825 
out
;

7828 
vœt_dev
->
fž’ame
 = 
	`k¡rdup
(
µ
, 
GFP_KERNEL
);

7829 ià(
vœt_dev
->
fž’ame
 =ð
NULL
) {

7830 
	`PRINT_ERROR
("Unableo duplicate file‚ame %s "

7831 "(deviû %s)", 
µ
, 
vœt_dev
->
Çme
);

7832 
»s
 = -
ENOMEM
;

7833 
out
;

7838 ià(!
	`¡rÿ£cmp
("dif_fž’ame", 
p
)) {

7839 ià(*
µ
 != '/') {

7840 
	`PRINT_ERROR
("DIF filename %s must be global "

7841 "(deviû %s)", 
µ
, 
vœt_dev
->
Çme
);

7842 
»s
 = -
EINVAL
;

7843 
out
;

7846 
vœt_dev
->
dif_fž’ame
 = 
	`k¡rdup
(
µ
, 
GFP_KERNEL
);

7847 ià(
vœt_dev
->
dif_fž’ame
 =ð
NULL
) {

7848 
	`PRINT_ERROR
("Unableo duplicate DIF filename %s "

7849 "(deviû %s)", 
µ
, 
vœt_dev
->
Çme
);

7850 
»s
 = -
ENOMEM
;

7851 
out
;

7856 ià(!
	`¡rÿ£cmp
("dif_mode", 
p
)) {

7857 *
d
 = 
µ
;

7860 *
dd
;

7862 ; (*
d
 !ð'\0'è&& 
	`is¥aû
(*d); d++)

7864 ià(*
d
 == '\0')

7867 
dd
 = 
	`¡rchr
(
d
, '|');

7868 ià(
dd
 !ð
NULL
)

7869 *
dd
 = '\0';

7870 ià(!
	`¡rÿ£cmp
(
SCST_DIF_MODE_TGT_STR
, 
d
))

7871 
vœt_dev
->
dif_mode
 |ð
SCST_DIF_MODE_TGT
;

7872 ià(!
	`¡rÿ£cmp
(
SCST_DIF_MODE_SCST_STR
, 
d
))

7873 
vœt_dev
->
dif_mode
 |ð
SCST_DIF_MODE_SCST
;

7874 ià(!
	`¡rÿ£cmp
(
SCST_DIF_MODE_DEV_CHECK_STR
, 
d
)) {

7875 
vœt_dev
->
dif_mode
 |ð
SCST_DIF_MODE_DEV_CHECK
;

7876 } ià(!
	`¡rÿ£cmp
(
SCST_DIF_MODE_DEV_STORE_STR
, 
d
))

7877 
vœt_dev
->
dif_mode
 |ð
SCST_DIF_MODE_DEV_STORE
;

7879 
	`PRINT_ERROR
("E¼Ü…¬sšg DIF mod%s", 
µ
);

7880 
»s
 = -
EINVAL
;

7881 
out
;

7883 ià(
dd
 =ð
NULL
)

7886 *
dd
 = '|';

7887 
d
 = 
dd
+1;

7889 
	`TRACE_DBG
("DIF DEV mod%x", 
vœt_dev
->
dif_mode
);

7893 
»s
 = 
	`k¡¹ouÎ
(
µ
, 0, &
v®
);

7894 ià(
»s
 != 0) {

7895 
	`PRINT_ERROR
("strtoull() for %s failed: %d (device %s)",

7896 
µ
, 
»s
, 
vœt_dev
->
Çme
);

7897 
out
;

7900 ià(!
	`¡rÿ£cmp
("wr™e_through", 
p
)) {

7901 
vœt_dev
->
wt_æag
 = 
v®
;

7902 
	`TRACE_DBG
("WRITE THROUGH %d", 
vœt_dev
->
wt_æag
);

7903 } ià(!
	`¡rÿ£cmp
("nv_ÿche", 
p
)) {

7904 
vœt_dev
->
nv_ÿche
 = 
v®
;

7905 
	`TRACE_DBG
("NON-VOLATILE CACHE %d", 
vœt_dev
->
nv_ÿche
);

7906 } ià(!
	`¡rÿ£cmp
("o_dœeù", 
p
)) {

7908 
vœt_dev
->
o_dœeù_æag
 = 
v®
;

7909 
	`TRACE_DBG
("O_DIRECT %d", 
vœt_dev
->
o_dœeù_æag
);

7911 
	`PRINT_INFO
("O_DIRECT flag doesn't currently"

7913 "š O_DIRECT modš¡—d (deviû %s)", 
vœt_dev
->
Çme
);

7915 } ià(!
	`¡rÿ£cmp
("»ad_Úly", 
p
)) {

7916 
vœt_dev
->
rd_Úly
 = 
v®
;

7917 
	`TRACE_DBG
("READ ONLY %d", 
vœt_dev
->
rd_Úly
);

7918 } ià(!
	`¡rÿ£cmp
("dummy", 
p
)) {

7919 ià(
v®
 > 1) {

7920 
»s
 = -
EINVAL
;

7921 
out
;

7923 
vœt_dev
->
dummy
 = 
v®
;

7924 
	`TRACE_DBG
("DUMMY %d", 
vœt_dev
->
dummy
);

7925 } ià(!
	`¡rÿ£cmp
("»movabË", 
p
)) {

7926 
vœt_dev
->
»movabË
 = 
v®
;

7927 
	`TRACE_DBG
("REMOVABLE %d", 
vœt_dev
->
»movabË
);

7928 } ià(!
	`¡rÿ£cmp
("rÙ©iÚ®", 
p
)) {

7929 
vœt_dev
->
rÙ©iÚ®
 = 
v®
;

7930 
	`TRACE_DBG
("ROTATIONAL %d", 
vœt_dev
->
rÙ©iÚ®
);

7931 } ià(!
	`¡rÿ£cmp
("t¡", 
p
)) {

7932 ià((
v®
 !ð
SCST_TST_0_SINGLE_TASK_SET
) &&

7933 (
v®
 !ð
SCST_TST_1_SEP_TASK_SETS
)) {

7934 
	`PRINT_ERROR
("Inv®id TST v®u%Îd", 
v®
);

7935 
»s
 = -
EINVAL
;

7936 
out
;

7938 
vœt_dev
->
t¡
 = 
v®
;

7939 
	`TRACE_DBG
("TST %d", 
vœt_dev
->
t¡
);

7940 } ià(!
	`¡rÿ£cmp
("thš_´ovisiÚed", 
p
)) {

7941 
vœt_dev
->
thš_´ovisiÚed
 = 
v®
;

7942 
vœt_dev
->
thš_´ovisiÚed_mªu®ly_£t
 = 1;

7943 
	`TRACE_DBG
("THIN PROVISIONED %d",

7944 
vœt_dev
->
thš_´ovisiÚed
);

7945 } ià(!
	`¡rÿ£cmp
("z”o_cÝy", 
p
)) {

7946 
vœt_dev
->
z”o_cÝy
 = !!
v®
;

7947 } ià(!
	`¡rÿ£cmp
("size", 
p
)) {

7948 
vœt_dev
->
fže_size
 = 
v®
;

7949 } ià(!
	`¡rÿ£cmp
("size_mb", 
p
)) {

7950 
vœt_dev
->
fže_size
 = 
v®
 * 1024 * 1024;

7951 } ià(!
	`¡rÿ£cmp
("þu¡”_mode", 
p
)) {

7952 
vœt_dev
->
š™Ÿl_þu¡”_mode
 = 
v®
;

7953 
	`TRACE_DBG
("CLUSTER_MODE %d",

7954 
vœt_dev
->
š™Ÿl_þu¡”_mode
);

7955 } ià(!
	`¡rÿ£cmp
("blocksize", 
p
)) {

7956 
vœt_dev
->
blk_shiá
 = 
	`sc¡_ÿlc_block_shiá
(
v®
);

7957 ià(
vœt_dev
->
blk_shiá
 < 9) {

7958 
»s
 = -
EINVAL
;

7959 
out
;

7961 
	`TRACE_DBG
("block size %lld, block shift %d",

7962 
v®
, 
vœt_dev
->
blk_shiá
);

7963 } ià(!
	`¡rÿ£cmp
("dif_ty³", 
p
)) {

7964 
vœt_dev
->
dif_ty³
 = 
v®
;

7965 
	`TRACE_DBG
("DIFy³ %d", 
vœt_dev
->
dif_ty³
);

7966 } ià(!
	`¡rÿ£cmp
("dif_¡©ic_­p_g", 
p
)) {

7967 
vœt_dev
->
dif_¡©ic_­p_g_combšed
 = 
	`ýu_to_be64
(
v®
);

7968 
	`TRACE_DBG
("DIF static‡ppag %llx",

7969 ()
	`be64_to_ýu
(
vœt_dev
->
dif_¡©ic_­p_g_combšed
));

7971 
	`PRINT_ERROR
("UnknowÀ·¿m‘” % (deviû %s)", 
p
,

7972 
vœt_dev
->
Çme
);

7973 
»s
 = -
EINVAL
;

7974 
out
;

7978 ià((
vœt_dev
->
fže_size
 & ((1 << vœt_dev->
blk_shiá
) - 1)) != 0) {

7979 
	`PRINT_ERROR
("Device size %lld is‚ot‡ multiple ofhe block"

7980 " siz%d", 
vœt_dev
->
fže_size
,

7981 1 << 
vœt_dev
->
blk_shiá
);

7982 
»s
 = -
EINVAL
;

7984 
out
:

7985 
	`TRACE_EXIT_RES
(
»s
);

7986  
»s
;

7987 
	}
}

7990 
	$vdev_fžeio_add_deviû
(cÚ¡ *
deviû_Çme
, *
·¿ms
)

7992 
»s
 = 0;

7993 
sc¡_vdisk_dev
 *
vœt_dev
;

7995 
	`TRACE_ENTRY
();

7997 
»s
 = 
	`vdev_ü—‹
(&
vdisk_fže_devty³
, 
deviû_Çme
, &
vœt_dev
);

7998 ià(
»s
 != 0)

7999 
out
;

8001 
vœt_dev
->
commªd_£t_v”siÚ
 = 0x04C0;

8003 
vœt_dev
->
wt_æag
 = 
DEF_WRITE_THROUGH
;

8004 
vœt_dev
->
nv_ÿche
 = 
DEF_NV_CACHE
;

8005 
vœt_dev
->
o_dœeù_æag
 = 
DEF_O_DIRECT
;

8007 
»s
 = 
	`vdev_·r£_add_dev_·¿ms
(
vœt_dev
, 
·¿ms
, 
NULL
);

8008 ià(
»s
 != 0)

8009 
out_de¡roy
;

8011 ià(
vœt_dev
->
rd_Úly
 && (vœt_dev->
wt_æag
 || vœt_dev->
nv_ÿche
)) {

8012 
	`PRINT_ERROR
("Write options on„ead only device %s",

8013 
vœt_dev
->
Çme
);

8014 
»s
 = -
EINVAL
;

8015 
out_de¡roy
;

8018 ià(
vœt_dev
->
fž’ame
 =ð
NULL
) {

8019 
	`PRINT_ERROR
("FžÇm»quœed (deviû %s)", 
vœt_dev
->
Çme
);

8020 
»s
 = -
EINVAL
;

8021 
out_de¡roy
;

8024 
	`li¡_add_ž
(&
vœt_dev
->
vdev_li¡_’Œy
, &
vdev_li¡
);

8026 
	`vdisk_»pÜt_»gi¡”šg
(
vœt_dev
);

8028 
vœt_dev
->
vœt_id
 = 
	`sc¡_»gi¡”_vœtu®_deviû
(vœt_dev->
vdev_devt
,

8029 
vœt_dev
->
Çme
);

8030 ià(
vœt_dev
->
vœt_id
 < 0) {

8031 
»s
 = 
vœt_dev
->
vœt_id
;

8032 
out_d–
;

8035 
	`TRACE_DBG
("Regi¡”ed vœt_dev % w™h id %d", 
vœt_dev
->
Çme
,

8036 
vœt_dev
->
vœt_id
);

8038 
out
:

8039 
	`TRACE_EXIT_RES
(
»s
);

8040  
»s
;

8042 
out_d–
:

8043 
	`li¡_d–
(&
vœt_dev
->
vdev_li¡_’Œy
);

8045 
out_de¡roy
:

8046 
	`vdev_de¡roy
(
vœt_dev
);

8047 
out
;

8048 
	}
}

8051 
	$vdev_blockio_add_deviû
(cÚ¡ *
deviû_Çme
, *
·¿ms
)

8053 
»s
 = 0;

8054 cÚ¡ *cÚ¡ 
®lowed_·¿ms
[] = { "filename", "read_only", "write_through",

8059 "dif_fž’ame", 
NULL
 };

8060 
sc¡_vdisk_dev
 *
vœt_dev
;

8062 
	`TRACE_ENTRY
();

8064 
»s
 = 
	`vdev_ü—‹
(&
vdisk_blk_devty³
, 
deviû_Çme
, &
vœt_dev
);

8065 ià(
»s
 != 0)

8066 
out
;

8068 
vœt_dev
->
commªd_£t_v”siÚ
 = 0x04C0;

8070 
vœt_dev
->
blockio
 = 1;

8071 
vœt_dev
->
wt_æag
 = 
DEF_WRITE_THROUGH
;

8072 
	`¥rštf
(
vœt_dev
->
t10_v’d_id
, "%.*s",

8073 ()(
vœt_dev
->
t10_v’d_id
è- 1, 
SCST_BIO_VENDOR
);

8075 
»s
 = 
	`vdev_·r£_add_dev_·¿ms
(
vœt_dev
, 
·¿ms
, 
®lowed_·¿ms
);

8076 ià(
»s
 != 0)

8077 
out_de¡roy
;

8079 ià(
vœt_dev
->
fž’ame
 =ð
NULL
) {

8080 
	`PRINT_ERROR
("FžÇm»quœed (deviû %s)", 
vœt_dev
->
Çme
);

8081 
»s
 = -
EINVAL
;

8082 
out_de¡roy
;

8085 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 30)

8086 
»s
 = 
	`vdisk_ü—‹_bio£t
(
vœt_dev
);

8087 ià(
»s
 != 0)

8088 
out_de¡roy
;

8091 
	`li¡_add_ž
(&
vœt_dev
->
vdev_li¡_’Œy
, &
vdev_li¡
);

8093 
	`vdisk_»pÜt_»gi¡”šg
(
vœt_dev
);

8095 
vœt_dev
->
vœt_id
 = 
	`sc¡_»gi¡”_vœtu®_deviû
(vœt_dev->
vdev_devt
,

8096 
vœt_dev
->
Çme
);

8097 ià(
vœt_dev
->
vœt_id
 < 0) {

8098 
»s
 = 
vœt_dev
->
vœt_id
;

8099 
out_d–
;

8102 
	`TRACE_DBG
("Regi¡”ed vœt_dev % w™h id %d", 
vœt_dev
->
Çme
,

8103 
vœt_dev
->
vœt_id
);

8105 
out
:

8106 
	`TRACE_EXIT_RES
(
»s
);

8107  
»s
;

8109 
out_d–
:

8110 
	`li¡_d–
(&
vœt_dev
->
vdev_li¡_’Œy
);

8112 
out_de¡roy
:

8113 
	`vdev_de¡roy
(
vœt_dev
);

8114 
out
;

8115 
	}
}

8118 
	$vdev_nuÎio_add_deviû
(cÚ¡ *
deviû_Çme
, *
·¿ms
)

8120 
»s
 = 0;

8121 cÚ¡ *cÚ¡ 
®lowed_·¿ms
[] = {

8124 "size", "size_mb", "t¡", 
NULL


8126 
sc¡_vdisk_dev
 *
vœt_dev
;

8128 
	`TRACE_ENTRY
();

8130 
»s
 = 
	`vdev_ü—‹
(&
vdisk_nuÎ_devty³
, 
deviû_Çme
, &
vœt_dev
);

8131 ià(
»s
 != 0)

8132 
out
;

8134 
vœt_dev
->
commªd_£t_v”siÚ
 = 0x04C0;

8136 
vœt_dev
->
nuÎio
 = 1;

8137 
vœt_dev
->
fže_size
 = 
VDISK_NULLIO_SIZE
;

8139 
»s
 = 
	`vdev_·r£_add_dev_·¿ms
(
vœt_dev
, 
·¿ms
, 
®lowed_·¿ms
);

8140 ià(
»s
 != 0)

8141 
out_de¡roy
;

8143 
	`li¡_add_ž
(&
vœt_dev
->
vdev_li¡_’Œy
, &
vdev_li¡
);

8145 
	`vdisk_»pÜt_»gi¡”šg
(
vœt_dev
);

8147 
vœt_dev
->
vœt_id
 = 
	`sc¡_»gi¡”_vœtu®_deviû
(vœt_dev->
vdev_devt
,

8148 
vœt_dev
->
Çme
);

8149 ià(
vœt_dev
->
vœt_id
 < 0) {

8150 
»s
 = 
vœt_dev
->
vœt_id
;

8151 
out_d–
;

8154 
	`TRACE_DBG
("Regi¡”ed vœt_dev % w™h id %d", 
vœt_dev
->
Çme
,

8155 
vœt_dev
->
vœt_id
);

8157 
out
:

8158 
	`TRACE_EXIT_RES
(
»s
);

8159  
»s
;

8161 
out_d–
:

8162 
	`li¡_d–
(&
vœt_dev
->
vdev_li¡_’Œy
);

8164 
out_de¡roy
:

8165 
	`vdev_de¡roy
(
vœt_dev
);

8166 
out
;

8167 
	}
}

8169 
ssize_t
 
	$vdisk_add_fžeio_deviû
(cÚ¡ *
deviû_Çme
, *
·¿ms
)

8171 
»s
;

8173 
	`TRACE_ENTRY
();

8175 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_vdisk_mu‹x
);

8176 ià(
»s
 != 0)

8177 
out
;

8179 
»s
 = 
	`vdev_fžeio_add_deviû
(
deviû_Çme
, 
·¿ms
);

8181 
	`mu‹x_uÆock
(&
sc¡_vdisk_mu‹x
);

8183 
out
:

8184 
	`TRACE_EXIT_RES
(
»s
);

8185  
»s
;

8186 
	}
}

8188 
ssize_t
 
	$vdisk_add_blockio_deviû
(cÚ¡ *
deviû_Çme
, *
·¿ms
)

8190 
»s
;

8192 
	`TRACE_ENTRY
();

8194 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_vdisk_mu‹x
);

8195 ià(
»s
 != 0)

8196 
out
;

8198 
»s
 = 
	`vdev_blockio_add_deviû
(
deviû_Çme
, 
·¿ms
);

8200 
	`mu‹x_uÆock
(&
sc¡_vdisk_mu‹x
);

8202 
out
:

8203 
	`TRACE_EXIT_RES
(
»s
);

8204  
»s
;

8206 
	}
}

8208 
ssize_t
 
	$vdisk_add_nuÎio_deviû
(cÚ¡ *
deviû_Çme
, *
·¿ms
)

8210 
»s
;

8212 
	`TRACE_ENTRY
();

8214 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_vdisk_mu‹x
);

8215 ià(
»s
)

8216 
out
;

8218 
»s
 = 
	`vdev_nuÎio_add_deviû
(
deviû_Çme
, 
·¿ms
);

8220 
	`mu‹x_uÆock
(&
sc¡_vdisk_mu‹x
);

8222 
out
:

8223 
	`TRACE_EXIT_RES
(
»s
);

8224  
»s
;

8226 
	}
}

8231 
	$vdev_d–_deviû
(
sc¡_vdisk_dev
 *
vœt_dev
)

8233 
	`TRACE_ENTRY
();

8235 
	`sc¡_uÄegi¡”_vœtu®_deviû
(
vœt_dev
->
vœt_id
);

8237 
	`li¡_d–
(&
vœt_dev
->
vdev_li¡_’Œy
);

8239 
	`PRINT_INFO
("Vœtu® deviû % uÄegi¡”ed", 
vœt_dev
->
Çme
);

8240 
	`TRACE_DBG
("vœt_id %d uÄegi¡”ed", 
vœt_dev
->
vœt_id
);

8242 
	`vdev_de¡roy
(
vœt_dev
);

8245 
	}
}

8247 #iâdeà
CONFIG_SCST_PROC


8249 
ssize_t
 
	$vdisk_d–_deviû
(cÚ¡ *
deviû_Çme
)

8251 
»s
 = 0;

8252 
sc¡_vdisk_dev
 *
vœt_dev
;

8254 
	`TRACE_ENTRY
();

8256 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_vdisk_mu‹x
);

8257 ià(
»s
 != 0)

8258 
out
;

8260 
vœt_dev
 = 
	`vdev_fšd
(
deviû_Çme
);

8261 ià(
vœt_dev
 =ð
NULL
) {

8262 
	`PRINT_ERROR
("Deviû % nÙ found", 
deviû_Çme
);

8263 
»s
 = -
EINVAL
;

8264 
out_uÆock
;

8267 
	`vdev_d–_deviû
(
vœt_dev
);

8269 
out_uÆock
:

8270 
	`mu‹x_uÆock
(&
sc¡_vdisk_mu‹x
);

8272 
out
:

8273 
	`TRACE_EXIT_RES
(
»s
);

8274  
»s
;

8275 
	}
}

8278 
ssize_t
 
	$__vcdrom_add_deviû
(cÚ¡ *
deviû_Çme
, *
·¿ms
)

8280 
»s
 = 0;

8281 cÚ¡ *cÚ¡ 
®lowed_·¿ms
[] = { "t¡", 
NULL
 };

8282 
sc¡_vdisk_dev
 *
vœt_dev
;

8284 
	`TRACE_ENTRY
();

8286 
»s
 = 
	`vdev_ü—‹
(&
vcdrom_devty³
, 
deviû_Çme
, &
vœt_dev
);

8287 ià(
»s
 != 0)

8288 
out
;

8295 
vœt_dev
->
commªd_£t_v”siÚ
 = 0x02A0;

8298 
vœt_dev
->
rd_Úly
 = 1;

8299 
vœt_dev
->
»movabË
 = 1;

8300 
vœt_dev
->
cdrom_em±y
 = 1;

8302 
vœt_dev
->
blk_shiá
 = 
DEF_CDROM_BLOCK_SHIFT
;

8304 
»s
 = 
	`vdev_·r£_add_dev_·¿ms
(
vœt_dev
, 
·¿ms
, 
®lowed_·¿ms
);

8305 ià(
»s
 != 0)

8306 
out_de¡roy
;

8308 
	`li¡_add_ž
(&
vœt_dev
->
vdev_li¡_’Œy
, &
vdev_li¡
);

8310 
	`vdisk_»pÜt_»gi¡”šg
(
vœt_dev
);

8312 
vœt_dev
->
vœt_id
 = 
	`sc¡_»gi¡”_vœtu®_deviû
(vœt_dev->
vdev_devt
,

8313 
vœt_dev
->
Çme
);

8314 ià(
vœt_dev
->
vœt_id
 < 0) {

8315 
»s
 = 
vœt_dev
->
vœt_id
;

8316 
out_d–
;

8319 
	`TRACE_DBG
("Regi¡”ed vœt_dev % w™h id %d", 
vœt_dev
->
Çme
,

8320 
vœt_dev
->
vœt_id
);

8322 
out
:

8323 
	`TRACE_EXIT_RES
(
»s
);

8324  
»s
;

8326 
out_d–
:

8327 
	`li¡_d–
(&
vœt_dev
->
vdev_li¡_’Œy
);

8329 
out_de¡roy
:

8330 
	`vdev_de¡roy
(
vœt_dev
);

8331 
out
;

8332 
	}
}

8334 
ssize_t
 
	$vcdrom_add_deviû
(cÚ¡ *
deviû_Çme
, *
·¿ms
)

8336 
»s
;

8338 
	`TRACE_ENTRY
();

8340 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_vdisk_mu‹x
);

8341 ià(
»s
 != 0)

8342 
out
;

8344 
»s
 = 
	`__vcdrom_add_deviû
(
deviû_Çme
, 
·¿ms
);

8346 
	`mu‹x_uÆock
(&
sc¡_vdisk_mu‹x
);

8348 
out
:

8349 
	`TRACE_EXIT_RES
(
»s
);

8350  
»s
;

8352 
	}
}

8354 
ssize_t
 
	$vcdrom_d–_deviû
(cÚ¡ *
deviû_Çme
)

8356 
»s
 = 0;

8357 
sc¡_vdisk_dev
 *
vœt_dev
;

8359 
	`TRACE_ENTRY
();

8361 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_vdisk_mu‹x
);

8362 ià(
»s
 != 0)

8363 
out
;

8365 
vœt_dev
 = 
	`vdev_fšd
(
deviû_Çme
);

8366 ià(
vœt_dev
 =ð
NULL
) {

8367 
	`PRINT_ERROR
("Deviû % nÙ found", 
deviû_Çme
);

8368 
»s
 = -
EINVAL
;

8369 
out_uÆock
;

8372 
	`vdev_d–_deviû
(
vœt_dev
);

8374 
out_uÆock
:

8375 
	`mu‹x_uÆock
(&
sc¡_vdisk_mu‹x
);

8377 
out
:

8378 
	`TRACE_EXIT_RES
(
»s
);

8379  
»s
;

8380 
	}
}

8384 
	$vcdrom_chªge
(
sc¡_vdisk_dev
 *
vœt_dev
,

8385 *
bufãr
)

8387 
loff_t
 
”r
;

8388 *
Þd_â
, *
p
, *
µ
;

8389 
boÞ
 
Þd_em±y
;

8390 
fže
 *
Þd_fd
;

8391 cÚ¡ *
fž’ame
 = 
NULL
;

8392 
Ëngth
 = 
	`¡¾’
(
bufãr
);

8393 
»s
 = 0;

8395 
	`TRACE_ENTRY
();

8397 
p
 = 
bufãr
;

8399 
	`is¥aû
(*
p
) && *p != '\0')

8400 
p
++;

8401 
fž’ame
 = 
p
;

8402 
p
 = &
bufãr
[
Ëngth
-1];

8403 
µ
 = &
bufãr
[
Ëngth
];

8404 
	`is¥aû
(*
p
) && (*p != '\0')) {

8405 
µ
 = 
p
;

8406 
p
--;

8408 *
µ
 = '\0';

8410 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
SCST_SUSPEND_TIMEOUT_USER
);

8411 ià(
»s
 != 0)

8412 
out
;

8415 
	`mu‹x_lock
(&
sc¡_mu‹x
);

8417 
Þd_em±y
 = 
vœt_dev
->
cdrom_em±y
;

8418 
Þd_fd
 = 
vœt_dev
->
fd
;

8420 ià(*
fž’ame
 == '\0') {

8421 
vœt_dev
->
cdrom_em±y
 = 1;

8422 
	`TRACE_DBG
("%s", "No media");

8423 } ià(*
fž’ame
 != '/') {

8424 
	`PRINT_ERROR
("Fž·th \"%s\" i nÙ‡bsÞu‹", 
fž’ame
);

8425 
»s
 = -
EINVAL
;

8426 
out_e_uÆock
;

8428 
vœt_dev
->
cdrom_em±y
 = 0;

8430 
Þd_â
 = 
vœt_dev
->
fž’ame
;

8432 ià(!
vœt_dev
->
cdrom_em±y
) {

8433 *
â
 = 
	`k¡rdup
(
fž’ame
, 
GFP_KERNEL
);

8435 ià(
â
 =ð
NULL
) {

8436 
	`PRINT_ERROR
("%s", "Allocation of filename failed");

8437 
»s
 = -
ENOMEM
;

8438 
out_e_uÆock
;

8441 
vœt_dev
->
fž’ame
 = 
â
;

8443 
»s
 = 
	`vdisk_g‘_fže_size
(
vœt_dev
->
fž’ame
,

8444 
vœt_dev
->
blockio
, &
”r
);

8445 ià(
»s
 != 0)

8446 
out_ä“_â
;

8447 ià(
vœt_dev
->
fd
 =ð
NULL
) {

8448 
»s
 = 
	`vdisk_Ý’_fd
(
vœt_dev
, 
Œue
);

8449 ià(
»s
 != 0)

8450 
out_ä“_â
;

8451 
	`sBUG_ON
(!
vœt_dev
->
fd
);

8454 
”r
 = 0;

8455 
vœt_dev
->
fž’ame
 = 
NULL
;

8456 
vœt_dev
->
fd
 = 
NULL
;

8459 ià(
vœt_dev
->
´ev’t_®low_medium_»mov®
) {

8460 
	`PRINT_ERROR
("Prevent medium„emoval for "

8461 "vœtu® deviû w™h‚am%s", 
vœt_dev
->
Çme
);

8462 
»s
 = -
EBUSY
;

8463 
out_ä“_â
;

8466 
vœt_dev
->
fže_size
 = 
”r
;

8467 
vœt_dev
->
nblocks
 = vœt_dev->
fže_size
 >> vœt_dev->
dev
->
block_shiá
;

8468 ià(!
vœt_dev
->
cdrom_em±y
)

8469 
vœt_dev
->
medŸ_chªged
 = 1;

8471 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

8473 ià(!
vœt_dev
->
cdrom_em±y
) {

8474 
	`PRINT_INFO
("Changed SCSIarget virtual cdrom %s "

8476 " cyÊ=%Îd%s)", 
vœt_dev
->
Çme
,

8477 
	`vdev_g‘_fž’ame
(
vœt_dev
),

8478 
vœt_dev
->
fže_size
 >> 20, vœt_dev->
dev
->
block_size
,

8479 ()
vœt_dev
->
nblocks
,

8480 ()
vœt_dev
->
nblocks
/64/32,

8481 
vœt_dev
->
nblocks
 < 64*32 ? " !WARNING! cyln†ess "

8484 
	`PRINT_INFO
("Removed media from SCSIarget virtual cdrom %s",

8485 
vœt_dev
->
Çme
);

8488 ià(
Þd_fd
)

8489 
	`fžp_þo£
(
Þd_fd
, 
NULL
);

8490 
	`kä“
(
Þd_â
);

8492 
out_»sume
:

8493 
	`sc¡_»sume_aùiv™y
();

8495 
out
:

8496 
	`TRACE_EXIT_RES
(
»s
);

8497  
»s
;

8499 
out_ä“_â
:

8500 
vœt_dev
->
fd
 = 
Þd_fd
;

8501 
	`kä“
(
vœt_dev
->
fž’ame
);

8502 
vœt_dev
->
fž’ame
 = 
Þd_â
;

8504 
out_e_uÆock
:

8505 
vœt_dev
->
cdrom_em±y
 = 
Þd_em±y
;

8507 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

8508 
out_»sume
;

8509 
	}
}

8511 #iâdeà
CONFIG_SCST_PROC


8513 
ssize_t
 
	$vdisk_sysfs_sync_¡Üe
(
kobjeù
 *
kobj
,

8514 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

8516 
sc¡_deviû
 *
dev
 =

8517 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

8518 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

8519 
»s
;

8521 ià(
vœt_dev
->
nuÎio
)

8522 
»s
 = 0;

8523 ià(
vœt_dev
->
blockio
)

8524 
»s
 = 
	`vdisk_blockio_æush
(
vœt_dev
->
bdev
, 
GFP_KERNEL
, 
çl£
,

8525 
NULL
, 
çl£
);

8527 
»s
 = 
	`__vdisk_fsync_fžeio
(0, 
	`i_size_»ad
(
	`fže_šode
(
vœt_dev
->
fd
)),

8528 
dev
, 
NULL
, 
vœt_dev
->
fd
);

8530  
»s
 ? : 
couÁ
;

8531 
	}
}

8533 
	$vcdrom_sysfs_´oûss_fž’ame_¡Üe
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

8535 
»s
;

8536 
sc¡_deviû
 *
dev
 = 
wÜk
->dev;

8537 
sc¡_vdisk_dev
 *
vœt_dev
;

8539 
	`TRACE_ENTRY
();

8542 
vœt_dev
 = 
dev
->
dh_´iv
;

8544 
»s
 = 
	`vcdrom_chªge
(
vœt_dev
, 
wÜk
->
buf
);

8546 
	`kobjeù_put
(&
dev
->
dev_kobj
);

8548 
	`TRACE_EXIT_RES
(
»s
);

8549  
»s
;

8550 
	}
}

8552 
ssize_t
 
	$vcdrom_sysfs_fž’ame_¡Üe
(
kobjeù
 *
kobj
,

8553 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

8555 
»s
;

8556 *
i_buf
;

8557 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

8558 
sc¡_deviû
 *
dev
;

8560 
	`TRACE_ENTRY
();

8562 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

8564 
i_buf
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%.*s", ()
couÁ
, 
buf
);

8565 ià(
i_buf
 =ð
NULL
) {

8566 
	`PRINT_ERROR
("Unableo‡lloc intermediate buffer with size %zd",

8567 
couÁ
+1);

8568 
»s
 = -
ENOMEM
;

8569 
out
;

8572 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
vcdrom_sysfs_´oûss_fž’ame_¡Üe
,

8573 
çl£
, &
wÜk
);

8574 ià(
»s
 != 0)

8575 
out_ä“
;

8577 
wÜk
->
buf
 = 
i_buf
;

8578 
wÜk
->
dev
 = dev;

8580 
	`SCST_SET_DEP_MAP
(
wÜk
, &
sc¡_dev_d•_m­
);

8581 
	`kobjeù_g‘
(&
dev
->
dev_kobj
);

8583 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

8584 ià(
»s
 == 0)

8585 
»s
 = 
couÁ
;

8587 
out
:

8588 
	`TRACE_EXIT_RES
(
»s
);

8589  
»s
;

8591 
out_ä“
:

8592 
	`kä“
(
i_buf
);

8593 
out
;

8594 
	}
}

8596 
	$vdev_size_´oûss_¡Üe
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

8598 
sc¡_deviû
 *
dev
 = 
wÜk
->dev;

8599 
sc¡_vdisk_dev
 *
vœt_dev
;

8600 
Ãw_size
;

8601 
size_shiá
, 
»s
 = -
EINVAL
;

8602 
boÞ
 
queue_ua
;

8604 ià(
	`ssÿnf
(
wÜk
->
buf
, "%d %Îd", &
size_shiá
, &
Ãw_size
) != 2 ||

8605 
Ãw_size
 > (
ULLONG_MAX
 >> 
size_shiá
))

8606 
put
;

8608 
Ãw_size
 <<ð
size_shiá
;

8610 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
SCST_SUSPEND_TIMEOUT_USER
);

8611 ià(
»s
)

8612 
put
;

8615 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

8616 ià(
»s
)

8617 
»sume
;

8619 
vœt_dev
 = 
dev
->
dh_´iv
;

8621 
queue_ua
 = (
vœt_dev
->
fd
 !ð
NULL
);

8623 ià((
Ãw_size
 & ((1 << 
vœt_dev
->
blk_shiá
) - 1)) == 0) {

8624 
vœt_dev
->
fže_size
 = 
Ãw_size
;

8625 
vœt_dev
->
nblocks
 = vœt_dev->
fže_size
 >> 
dev
->
block_shiá
;

8626 
vœt_dev
->
size_key
 = 1;

8628 
»s
 = -
EINVAL
;

8631 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

8633 ià((
»s
 =ð0è|| 
queue_ua
)

8634 
	`sc¡_ÿ·c™y_d©a_chªged
(
dev
);

8636 
»sume
:

8637 
	`sc¡_»sume_aùiv™y
();

8639 
put
:

8640 
	`kobjeù_put
(&
dev
->
dev_kobj
);

8641  
»s
;

8642 
	}
}

8644 
ssize_t
 
	$vdev_size_¡Üe
(
kobjeù
 *
kobj
,

8645 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
,

8646 
size_t
 
couÁ
, 
size_shiá
)

8648 
sc¡_deviû
 *
dev
 = 
	`cÚš”_of
(
kobj
, scst_device,

8649 
dev_kobj
);

8650 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

8651 *
Ãw_size
;

8652 
»s
 = -
ENOMEM
;

8654 
Ãw_size
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%d %.*s", 
size_shiá
, ()
couÁ
,

8655 
buf
);

8656 ià(!
Ãw_size
)

8657 
out
;

8659 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
vdev_size_´oûss_¡Üe
, 
çl£
, &
wÜk
);

8660 ià(
»s
)

8661 
out_ä“
;

8663 
wÜk
->
buf
 = 
Ãw_size
;

8664 
wÜk
->
dev
 = dev;

8666 
	`SCST_SET_DEP_MAP
(
wÜk
, &
sc¡_dev_d•_m­
);

8667 
	`kobjeù_g‘
(&
dev
->
dev_kobj
);

8669 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

8670 ià(
»s
 == 0)

8671 
»s
 = 
couÁ
;

8673 
out
:

8674  
»s
;

8676 
out_ä“
:

8677 
	`kä“
(
buf
);

8678 
out
;

8679 
	}
}

8681 
ssize_t
 
	$vdev_sysfs_size_¡Üe
(
kobjeù
 *
kobj
,

8682 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

8684  
	`vdev_size_¡Üe
(
kobj
, 
©Œ
, 
buf
, 
couÁ
, 0);

8685 
	}
}

8687 
ssize_t
 
	$vdev_size_show
(
kobjeù
 *
kobj
, 
kobj_©Œibu‹
 *
©Œ
,

8688 *
buf
, 
size_shiá
)

8690 
sc¡_deviû
 *
dev
;

8691 
sc¡_vdisk_dev
 *
vœt_dev
;

8692 
size
;

8693 
boÞ
 
key
;

8695 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

8696 
vœt_dev
 = 
dev
->
dh_´iv
;

8697 
size
 = 
	`ACCESS_ONCE
(
vœt_dev
->
fže_size
);

8699 ià(
vœt_dev
->
nuÎio
 && 
size
 =ð
VDISK_NULLIO_SIZE
)

8700 
key
 = 
çl£
;

8702 
key
 = 
vœt_dev
->
size_key
;

8704  
	`¥rštf
(
buf
, "%Îu\n%s", 
size
 >> 
size_shiá
,

8705 
key
 ? 
SCST_SYSFS_KEY_MARK
 "\n" : "");

8706 
	}
}

8708 
ssize_t
 
	$vdev_sysfs_size_show
(
kobjeù
 *
kobj
,

8709 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

8711  
	`vdev_size_show
(
kobj
, 
©Œ
, 
buf
, 0);

8712 
	}
}

8714 
ssize_t
 
	$vdev_sysfs_size_mb_¡Üe
(
kobjeù
 *
kobj
,

8715 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

8717  
	`vdev_size_¡Üe
(
kobj
, 
©Œ
, 
buf
, 
couÁ
, 20);

8718 
	}
}

8720 
ssize_t
 
	$vdev_sysfs_size_mb_show
(
kobjeù
 *
kobj
,

8721 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

8723  
	`vdev_size_show
(
kobj
, 
©Œ
, 
buf
, 20);

8724 
	}
}

8726 
ssize_t
 
	$vdisk_sysfs_blocksize_show
(
kobjeù
 *
kobj
,

8727 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

8729 
pos
 = 0;

8730 
sc¡_deviû
 *
dev
;

8732 
	`TRACE_ENTRY
();

8734 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

8736 
pos
 = 
	`¥rštf
(
buf
, "%d\n%s", 
dev
->
block_size
,

8737 (
dev
->
block_size
 =ð(1 << 
DEF_DISK_BLOCK_SHIFT
)) ? "" :

8738 
SCST_SYSFS_KEY_MARK
 "\n");

8740 
	`TRACE_EXIT_RES
(
pos
);

8741  
pos
;

8742 
	}
}

8744 
ssize_t
 
	$vdisk_sysfs_rd_Úly_show
(
kobjeù
 *
kobj
,

8745 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

8747 
pos
 = 0;

8748 
sc¡_deviû
 *
dev
;

8749 
sc¡_vdisk_dev
 *
vœt_dev
;

8751 
	`TRACE_ENTRY
();

8753 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

8754 
vœt_dev
 = 
dev
->
dh_´iv
;

8756 
pos
 = 
	`¥rštf
(
buf
, "%d\n%s", 
vœt_dev
->
rd_Úly
 ? 1 : 0,

8757 (
vœt_dev
->
rd_Úly
 =ð
DEF_RD_ONLY
) ? "" :

8758 
SCST_SYSFS_KEY_MARK
 "\n");

8760 
	`TRACE_EXIT_RES
(
pos
);

8761  
pos
;

8762 
	}
}

8764 
ssize_t
 
	$vdisk_sysfs_wt_show
(
kobjeù
 *
kobj
,

8765 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

8767 
pos
 = 0;

8768 
sc¡_deviû
 *
dev
;

8769 
sc¡_vdisk_dev
 *
vœt_dev
;

8771 
	`TRACE_ENTRY
();

8773 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

8774 
vœt_dev
 = 
dev
->
dh_´iv
;

8776 
pos
 = 
	`¥rštf
(
buf
, "%d\n%s", 
vœt_dev
->
wt_æag
 ? 1 : 0,

8777 (
vœt_dev
->
wt_æag
 =ð
DEF_WRITE_THROUGH
) ? "" :

8778 
SCST_SYSFS_KEY_MARK
 "\n");

8780 
	`TRACE_EXIT_RES
(
pos
);

8781  
pos
;

8782 
	}
}

8784 
ssize_t
 
	$vdisk_sysfs__show
(
kobjeù
 *
kobj
,

8785 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

8787 
pos
 = 0;

8788 
sc¡_deviû
 *
dev
;

8789 
sc¡_vdisk_dev
 *
vœt_dev
;

8791 
	`TRACE_ENTRY
();

8793 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

8794 
vœt_dev
 = 
dev
->
dh_´iv
;

8796 
pos
 = 
	`¥rštf
(
buf
, "%d\n%s", 
vœt_dev
->
thš_´ovisiÚed
 ? 1 : 0,

8797 
vœt_dev
->
thš_´ovisiÚed_mªu®ly_£t
 &&

8798 (
vœt_dev
->
thš_´ovisiÚed
 !=

8799 
vœt_dev
->
dev_thš_´ovisiÚed
) ?

8800 
SCST_SYSFS_KEY_MARK
 "\n" : "");

8802 
	`TRACE_EXIT_RES
(
pos
);

8803  
pos
;

8804 
	}
}

8806 
ssize_t
 
	$vdisk_sysfs_ex¶_®ua_show
(
kobjeù
 *
kobj
,

8807 
kobj_©Œibu‹
 *
©Œ
,

8808 *
buf
)

8810 
sc¡_deviû
 *
dev
;

8811 
sc¡_vdisk_dev
 *
vœt_dev
;

8812 
pos
;

8814 
	`TRACE_ENTRY
();

8816 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

8817 
vœt_dev
 = 
dev
->
dh_´iv
;

8818 
pos
 = 
	`¥rštf
(
buf
, "%d\n%s", 
vœt_dev
->
ex¶_®ua
,

8819 
vœt_dev
->
ex¶_®ua
 !ð
DEF_EXPL_ALUA
 ?

8820 
SCST_SYSFS_KEY_MARK
 "\n" : "");

8822 
	`TRACE_EXIT_RES
(
pos
);

8823  
pos
;

8824 
	}
}

8826 
ssize_t
 
	$vdisk_sysfs_ex¶_®ua_¡Üe
(
kobjeù
 *
kobj
,

8827 
kobj_©Œibu‹
 *
©Œ
,

8828 cÚ¡ *
buf
, 
size_t
 
couÁ
)

8830 
sc¡_deviû
 *
dev
;

8831 
sc¡_vdisk_dev
 *
vœt_dev
;

8832 
ch
[16];

8833 
ex¶_®ua
;

8834 
»s
;

8836 
	`TRACE_ENTRY
();

8838 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

8839 
vœt_dev
 = 
dev
->
dh_´iv
;

8840 
	`¥rštf
(
ch
, "%.*s", 
	`mš_t
(, (chè- 1, 
couÁ
), 
buf
);

8841 
»s
 = 
	`k¡¹oul
(
ch
, 0, &
ex¶_®ua
);

8842 ià(
»s
 < 0)

8843 
out
;

8845 
	`¥š_lock
(&
vœt_dev
->
æags_lock
);

8846 
vœt_dev
->
ex¶_®ua
 = !!expl_alua;

8847 
	`¥š_uÆock
(&
vœt_dev
->
æags_lock
);

8849 
»s
 = 
couÁ
;

8851 
out
:

8852 
	`TRACE_EXIT_RES
(
»s
);

8853  
»s
;

8854 
	}
}

8856 
ssize_t
 
	$vdisk_sysfs_nv_ÿche_show
(
kobjeù
 *
kobj
,

8857 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

8859 
pos
 = 0;

8860 
sc¡_deviû
 *
dev
;

8861 
sc¡_vdisk_dev
 *
vœt_dev
;

8863 
	`TRACE_ENTRY
();

8865 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

8866 
vœt_dev
 = 
dev
->
dh_´iv
;

8868 
pos
 = 
	`¥rštf
(
buf
, "%d\n%s", 
vœt_dev
->
nv_ÿche
 ? 1 : 0,

8869 (
vœt_dev
->
nv_ÿche
 =ð
DEF_NV_CACHE
) ? "" :

8870 
SCST_SYSFS_KEY_MARK
 "\n");

8872 
	`TRACE_EXIT_RES
(
pos
);

8873  
pos
;

8874 
	}
}

8876 
ssize_t
 
	$vdisk_sysfs_o_dœeù_show
(
kobjeù
 *
kobj
,

8877 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

8879 
pos
 = 0;

8880 
sc¡_deviû
 *
dev
;

8881 
sc¡_vdisk_dev
 *
vœt_dev
;

8883 
	`TRACE_ENTRY
();

8885 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

8886 
vœt_dev
 = 
dev
->
dh_´iv
;

8888 
pos
 = 
	`¥rštf
(
buf
, "%d\n%s", 
vœt_dev
->
o_dœeù_æag
 ? 1 : 0,

8889 (
vœt_dev
->
o_dœeù_æag
 =ð
DEF_O_DIRECT
) ? "" :

8890 
SCST_SYSFS_KEY_MARK
 "\n");

8892 
	`TRACE_EXIT_RES
(
pos
);

8893  
pos
;

8894 
	}
}

8896 
ssize_t
 
	$vdev_sysfs_dummy_show
(
kobjeù
 *
kobj
,

8897 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

8899 
sc¡_deviû
 *
dev
 = 
	`cÚš”_of
(
kobj
, scst_device,

8900 
dev_kobj
);

8901 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

8903  
	`¥rštf
(
buf
, "%d\n%s", 
vœt_dev
->
dummy
,

8904 
vœt_dev
->
dummy
 !ð
DEF_DUMMY
 ? 
SCST_SYSFS_KEY_MARK
 "\n" : "");

8905 
	}
}

8907 
ssize_t
 
	$vdev_sysfs_rz_show
(
kobjeù
 *
kobj
,

8908 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

8910 
sc¡_deviû
 *
dev
 = 
	`cÚš”_of
(
kobj
, scst_device,

8911 
dev_kobj
);

8912 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

8913 
boÞ
 
»ad_z”o
 = 
vœt_dev
->read_zero;

8915  
	`¥rštf
(
buf
, "%d\n%s", 
»ad_z”o
,„—d_z”Ø!ð
DEF_READ_ZERO
 ?

8916 
SCST_SYSFS_KEY_MARK
 "\n" : "");

8917 
	}
}

8919 
ssize_t
 
	$vdev_sysfs_rz_¡Üe
(
kobjeù
 *
kobj
,

8920 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
,

8921 
size_t
 
couÁ
)

8923 
sc¡_deviû
 *
dev
 = 
	`cÚš”_of
(
kobj
, scst_device,

8924 
dev_kobj
);

8925 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

8926 
»ad_z”o
;

8927 
»s
;

8928 
ch
[16];

8930 
	`¥rštf
(
ch
, "%.*s", 
	`mš_t
(, (chè- 1, 
couÁ
), 
buf
);

8931 
»s
 = 
	`k¡¹Þ
(
ch
, 0, &
»ad_z”o
);

8932 ià(
»s
)

8933 
out
;

8934 
»s
 = -
EINVAL
;

8935 ià(
»ad_z”o
 != 0 &&„ead_zero != 1)

8936 
out
;

8938 
	`¥š_lock
(&
vœt_dev
->
æags_lock
);

8939 
vœt_dev
->
»ad_z”o
 =„ead_zero;

8940 
	`¥š_uÆock
(&
vœt_dev
->
æags_lock
);

8942 
»s
 = 
couÁ
;

8944 
out
:

8945  
»s
;

8946 
	}
}

8948 
ssize_t
 
	$vdisk_sysfs_»movabË_show
(
kobjeù
 *
kobj
,

8949 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

8951 
pos
 = 0;

8952 
sc¡_deviû
 *
dev
;

8953 
sc¡_vdisk_dev
 *
vœt_dev
;

8955 
	`TRACE_ENTRY
();

8957 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

8958 
vœt_dev
 = 
dev
->
dh_´iv
;

8960 
pos
 = 
	`¥rštf
(
buf
, "%d\n", 
vœt_dev
->
»movabË
 ? 1 : 0);

8962 ià((
vœt_dev
->
dev
->
ty³
 !ð
TYPE_ROM
) &&

8963 (
vœt_dev
->
»movabË
 !ð
DEF_REMOVABLE
))

8964 
pos
 +ð
	`¥rštf
(&
buf
[pos], "%s\n", 
SCST_SYSFS_KEY_MARK
);

8966 
	`TRACE_EXIT_RES
(
pos
);

8967  
pos
;

8968 
	}
}

8970 
ssize_t
 
	$vdisk_sysfs_t¡_show
(
kobjeù
 *
kobj
,

8971 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

8973 
pos
 = 0;

8974 
sc¡_deviû
 *
dev
;

8975 
sc¡_vdisk_dev
 *
vœt_dev
;

8977 
	`TRACE_ENTRY
();

8979 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

8980 
vœt_dev
 = 
dev
->
dh_´iv
;

8982 
pos
 = 
	`¥rštf
(
buf
, "%d\n", 
vœt_dev
->
t¡
);

8984 ià(
vœt_dev
->
t¡
 !ð
DEF_TST
)

8985 
pos
 +ð
	`¥rštf
(&
buf
[pos], "%s\n", 
SCST_SYSFS_KEY_MARK
);

8987 
	`TRACE_EXIT_RES
(
pos
);

8988  
pos
;

8989 
	}
}

8991 
ssize_t
 
	$vdisk_sysfs_rÙ©iÚ®_show
(
kobjeù
 *
kobj
,

8992 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

8994 
pos
 = 0;

8995 
sc¡_deviû
 *
dev
;

8996 
sc¡_vdisk_dev
 *
vœt_dev
;

8998 
	`TRACE_ENTRY
();

9000 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

9001 
vœt_dev
 = 
dev
->
dh_´iv
;

9003 
pos
 = 
	`¥rštf
(
buf
, "%d\n", 
vœt_dev
->
rÙ©iÚ®
 ? 1 : 0);

9005 ià(
vœt_dev
->
rÙ©iÚ®
 !ð
DEF_ROTATIONAL
)

9006 
pos
 +ð
	`¥rštf
(&
buf
[pos], "%s\n", 
SCST_SYSFS_KEY_MARK
);

9008 
	`TRACE_EXIT_RES
(
pos
);

9009  
pos
;

9010 
	}
}

9012 
	$vdev_sysfs_´oûss_g‘_fž’ame
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

9014 
»s
 = 0;

9015 
sc¡_deviû
 *
dev
;

9016 
sc¡_vdisk_dev
 *
vœt_dev
;

9018 
	`TRACE_ENTRY
();

9020 
dev
 = 
wÜk
->dev;

9028 !
	`mu‹x_Œylock
(&
sc¡_vdisk_mu‹x
)) {

9029 ià(
dev
->
dev_uÄegi¡”šg
) {

9030 
	`TRACE_MGMT_DBG
("Skipping being unregistered dev %s",

9031 
dev
->
vœt_Çme
);

9032 
»s
 = -
ENOENT
;

9033 
out_put
;

9035 ià(
	`sigÇl_³ndšg
(
cu¼’t
)) {

9036 
»s
 = -
EINTR
;

9037 
out_put
;

9039 
	`m¦“p
(100);

9051 
	`b¬r›r
();

9054 
vœt_dev
 = 
dev
->
dh_´iv
;

9056 ià(
vœt_dev
 =ð
NULL
)

9057 
out_uÆock
;

9059 ià(
vœt_dev
->
fž’ame
 !ð
NULL
)

9060 
wÜk
->
»s_buf
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%s\n%s\n",

9061 
	`vdev_g‘_fž’ame
(
vœt_dev
), 
SCST_SYSFS_KEY_MARK
);

9063 
wÜk
->
»s_buf
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%s\n",

9064 
	`vdev_g‘_fž’ame
(
vœt_dev
));

9066 
out_uÆock
:

9067 
	`mu‹x_uÆock
(&
sc¡_vdisk_mu‹x
);

9069 
out_put
:

9070 
	`kobjeù_put
(&
dev
->
dev_kobj
);

9072 
	`TRACE_EXIT_RES
(
»s
);

9073  
»s
;

9074 
	}
}

9076 
ssize_t
 
	$vdev_sysfs_fž’ame_show
(
kobjeù
 *
kobj
,

9077 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

9079 
»s
 = 0;

9080 
sc¡_deviû
 *
dev
;

9081 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

9083 
	`TRACE_ENTRY
();

9085 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

9087 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
vdev_sysfs_´oûss_g‘_fž’ame
,

9088 
Œue
, &
wÜk
);

9089 ià(
»s
 != 0)

9090 
out
;

9092 
wÜk
->
dev
 = dev;

9094 
	`SCST_SET_DEP_MAP
(
wÜk
, &
sc¡_dev_d•_m­
);

9095 
	`kobjeù_g‘
(&
dev
->
dev_kobj
);

9097 
	`sc¡_sysfs_wÜk_g‘
(
wÜk
);

9099 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

9100 ià(
»s
 != 0)

9101 
out_put
;

9103 
»s
 = 
	`¢´štf
(
buf
, 
SCST_SYSFS_BLOCK_SIZE
, "%s\n", 
wÜk
->
»s_buf
);

9105 
out_put
:

9106 
	`sc¡_sysfs_wÜk_put
(
wÜk
);

9108 
out
:

9109 
	`TRACE_EXIT_RES
(
»s
);

9110  
»s
;

9111 
	}
}

9113 
ssize_t
 
	$vdev_sysfs_þu¡”_mode_show
(
kobjeù
 *
kobj
,

9114 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

9116 
sc¡_deviû
 *
dev
 = 
	`cÚš”_of
(
kobj
, scst_device,

9117 
dev_kobj
);

9119  
	`¥rštf
(
buf
, "%d\n%s", 
dev
->
þu¡”_mode
,

9120 
dev
->
þu¡”_mode
 ?

9121 
SCST_SYSFS_KEY_MARK
 "\n" : "");

9122 
	}
}

9124 
	$vdev_sysfs_´oûss_þu¡”_mode_¡Üe
(

9125 
sc¡_sysfs_wÜk_™em
 *
wÜk
)

9127 
sc¡_deviû
 *
dev
 = 
wÜk
->dev;

9128 
sc¡_vdisk_dev
 *
vœt_dev
;

9129 
þm
;

9130 
»s
;

9132 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
SCST_SUSPEND_TIMEOUT_USER
);

9133 ià(
»s
)

9134 
out
;

9136 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

9137 ià(
»s
)

9138 
»sume
;

9145 
vœt_dev
 = 
dev
->
dh_´iv
;

9146 
»s
 = 
	`k¡¹Þ
(
wÜk
->
buf
, 0, &
þm
);

9147 ià(
»s
)

9148 
uÆock
;

9149 
»s
 = -
EINVAL
;

9150 ià(
þm
 < 0 || clm > 1)

9151 
uÆock
;

9152 ià(
þm
 !ð
dev
->
þu¡”_mode
) {

9153 
»s
 = 
	`sc¡_´_£t_þu¡”_mode
(
dev
, 
þm
, 
vœt_dev
->
t10_dev_id
);

9154 ià(
»s
)

9155 
uÆock
;

9156 
dev
->
þu¡”_mode
 = 
þm
;

9158 
»s
 = 0;

9161 
uÆock
:

9162 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

9164 
»sume
:

9165 
	`sc¡_»sume_aùiv™y
();

9167 
out
:

9168 
	`kobjeù_put
(&
dev
->
dev_kobj
);

9170  
»s
;

9171 
	}
}

9173 
ssize_t
 
	$vdev_sysfs_þu¡”_mode_¡Üe
(
kobjeù
 *
kobj
,

9174 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

9176 
sc¡_deviû
 *
dev
 = 
	`cÚš”_of
(
kobj
, scst_device,

9177 
dev_kobj
);

9178 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

9179 *
¬g
;

9180 
»s
;

9182 
	`TRACE_ENTRY
();

9184 
»s
 = -
ENOMEM
;

9185 
¬g
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%.*s", ()
couÁ
, 
buf
);

9186 ià(!
¬g
)

9187 
out
;

9189 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
vdev_sysfs_´oûss_þu¡”_mode_¡Üe
,

9190 
çl£
, &
wÜk
);

9191 ià(
»s
)

9192 
out
;

9193 
wÜk
->
dev
 = dev;

9194 
	`sw­
(
wÜk
->
buf
, 
¬g
);

9195 
	`kobjeù_g‘
(&
dev
->
dev_kobj
);

9196 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

9197 ià(
»s
)

9198 
out
;

9199 
»s
 = 
couÁ
;

9201 
out
:

9202 
	`kä“
(
¬g
);

9203 
	`TRACE_EXIT_RES
(
»s
);

9204  
»s
;

9205 
	}
}

9207 
	$vdisk_sysfs_´oûss_»sync_size_¡Üe
(

9208 
sc¡_sysfs_wÜk_™em
 *
wÜk
)

9210 
»s
;

9211 
sc¡_deviû
 *
dev
 = 
wÜk
->dev;

9212 
sc¡_vdisk_dev
 *
vœt_dev
;

9214 
	`TRACE_ENTRY
();

9217 
vœt_dev
 = 
dev
->
dh_´iv
;

9219 
»s
 = 
	`vdisk_»sync_size
(
vœt_dev
);

9221 
	`kobjeù_put
(&
dev
->
dev_kobj
);

9223 
	`TRACE_EXIT_RES
(
»s
);

9224  
»s
;

9225 
	}
}

9227 
ssize_t
 
	$vdisk_sysfs_»sync_size_¡Üe
(
kobjeù
 *
kobj
,

9228 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

9230 
»s
;

9231 
sc¡_deviû
 *
dev
;

9232 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

9234 
	`TRACE_ENTRY
();

9236 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

9238 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
vdisk_sysfs_´oûss_»sync_size_¡Üe
,

9239 
çl£
, &
wÜk
);

9240 ià(
»s
 != 0)

9241 
out
;

9243 
wÜk
->
dev
 = dev;

9245 
	`SCST_SET_DEP_MAP
(
wÜk
, &
sc¡_dev_d•_m­
);

9246 
	`kobjeù_g‘
(&
dev
->
dev_kobj
);

9248 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

9249 ià(
»s
 == 0)

9250 
»s
 = 
couÁ
;

9252 
out
:

9253 
	`TRACE_EXIT_RES
(
»s
);

9254  
»s
;

9255 
	}
}

9257 
ssize_t
 
	$vdev_sysfs_t10_v’d_id_¡Üe
(
kobjeù
 *
kobj
,

9258 
kobj_©Œibu‹
 *
©Œ
,

9259 cÚ¡ *
buf
, 
size_t
 
couÁ
)

9261 
sc¡_deviû
 *
dev
;

9262 
sc¡_vdisk_dev
 *
vœt_dev
;

9263 *
p
;

9264 
»s
, 
Ën
;

9266 
	`TRACE_ENTRY
();

9268 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

9269 
vœt_dev
 = 
dev
->
dh_´iv
;

9270 
p
 = 
	`memchr
(
buf
, '\n', 
couÁ
);

9271 
Ën
 = 
p
 ?… - 
buf
 : 
couÁ
;

9273 ià(
Ën
 >ð(
vœt_dev
->
t10_v’d_id
)) {

9274 
	`PRINT_ERROR
("T10 vendor id isoo†ong (max %zd characters)",

9275 (
vœt_dev
->
t10_v’d_id
));

9276 
»s
 = -
EINVAL
;

9277 
out
;

9280 
	`wr™e_lock
(&
vdisk_£rŸl_rwlock
);

9281 
	`¥rštf
(
vœt_dev
->
t10_v’d_id
, "%.*s", 
Ën
, 
buf
);

9282 
vœt_dev
->
t10_v’d_id_£t
 = 1;

9283 
	`wr™e_uÆock
(&
vdisk_£rŸl_rwlock
);

9285 
»s
 = 
couÁ
;

9287 
out
:

9288 
	`TRACE_EXIT_RES
(
»s
);

9289  
»s
;

9290 
	}
}

9292 
ssize_t
 
	$vdev_sysfs_t10_v’d_id_show
(
kobjeù
 *
kobj
,

9293 
kobj_©Œibu‹
 *
©Œ
,

9294 *
buf
)

9296 
pos
;

9297 
sc¡_deviû
 *
dev
;

9298 
sc¡_vdisk_dev
 *
vœt_dev
;

9300 
	`TRACE_ENTRY
();

9302 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

9303 
vœt_dev
 = 
dev
->
dh_´iv
;

9305 
	`»ad_lock
(&
vdisk_£rŸl_rwlock
);

9306 
pos
 = 
	`¥rštf
(
buf
, "%s\n%s", 
vœt_dev
->
t10_v’d_id
,

9307 
vœt_dev
->
t10_v’d_id_£t
 ? 
SCST_SYSFS_KEY_MARK
 "\n" :

9309 
	`»ad_uÆock
(&
vdisk_£rŸl_rwlock
);

9311 
	`TRACE_EXIT_RES
(
pos
);

9312  
pos
;

9313 
	}
}

9315 
ssize_t
 
	$vdev_sysfs_v’d_¥ecific_id_¡Üe
(
kobjeù
 *
kobj
,

9316 
kobj_©Œibu‹
 *
©Œ
,

9317 cÚ¡ *
buf
, 
size_t
 
couÁ
)

9319 
sc¡_deviû
 *
dev
;

9320 
sc¡_vdisk_dev
 *
vœt_dev
;

9321 *
p
;

9322 
»s
, 
Ën
;

9324 
	`TRACE_ENTRY
();

9326 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

9327 
vœt_dev
 = 
dev
->
dh_´iv
;

9328 
p
 = 
	`memchr
(
buf
, '\n', 
couÁ
);

9329 
Ën
 = 
p
 ?… - 
buf
 : 
couÁ
;

9331 ià(
Ën
 >ð(
vœt_dev
->
v’d_¥ecific_id
)) {

9332 
	`PRINT_ERROR
("Vendor specific id isoo†ong (max %zd"

9334 (
vœt_dev
->
v’d_¥ecific_id
) - 1);

9335 
»s
 = -
EINVAL
;

9336 
out
;

9339 
	`wr™e_lock
(&
vdisk_£rŸl_rwlock
);

9340 
	`¥rštf
(
vœt_dev
->
v’d_¥ecific_id
, "%.*s", 
Ën
, 
buf
);

9341 
vœt_dev
->
v’d_¥ecific_id_£t
 = 1;

9342 
	`wr™e_uÆock
(&
vdisk_£rŸl_rwlock
);

9344 
»s
 = 
couÁ
;

9346 
out
:

9347 
	`TRACE_EXIT_RES
(
»s
);

9348  
»s
;

9349 
	}
}

9351 
ssize_t
 
	$vdev_sysfs_v’d_¥ecific_id_show
(
kobjeù
 *
kobj
,

9352 
kobj_©Œibu‹
 *
©Œ
,

9353 *
buf
)

9355 
pos
;

9356 
sc¡_deviû
 *
dev
;

9357 
sc¡_vdisk_dev
 *
vœt_dev
;

9359 
	`TRACE_ENTRY
();

9361 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

9362 
vœt_dev
 = 
dev
->
dh_´iv
;

9364 
	`»ad_lock
(&
vdisk_£rŸl_rwlock
);

9365 
pos
 = 
	`¥rštf
(
buf
, "%s\n%s", 
vœt_dev
->
v’d_¥ecific_id
,

9366 
vœt_dev
->
v’d_¥ecific_id_£t
 ?

9367 
SCST_SYSFS_KEY_MARK
 "\n" : "");

9368 
	`»ad_uÆock
(&
vdisk_£rŸl_rwlock
);

9370 
	`TRACE_EXIT_RES
(
pos
);

9371  
pos
;

9372 
	}
}

9374 
ssize_t
 
	$vdev_sysfs_´od_id_¡Üe
(
kobjeù
 *
kobj
,

9375 
kobj_©Œibu‹
 *
©Œ
,

9376 cÚ¡ *
buf
, 
size_t
 
couÁ
)

9378 
sc¡_deviû
 *
dev
;

9379 
sc¡_vdisk_dev
 *
vœt_dev
;

9380 *
p
;

9381 
»s
, 
Ën
;

9383 
	`TRACE_ENTRY
();

9385 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

9386 
vœt_dev
 = 
dev
->
dh_´iv
;

9387 
p
 = 
	`memchr
(
buf
, '\n', 
couÁ
);

9388 
Ën
 = 
p
 ?… - 
buf
 : 
couÁ
;

9390 ià(
Ën
 >ð(
vœt_dev
->
´od_id
)) {

9391 
	`PRINT_ERROR
("Product id isoo†ong (max %zd characters)",

9392 (
vœt_dev
->
´od_id
));

9393 
»s
 = -
EINVAL
;

9394 
out
;

9397 
	`wr™e_lock
(&
vdisk_£rŸl_rwlock
);

9398 
	`¥rštf
(
vœt_dev
->
´od_id
, "%.*s", 
Ën
, 
buf
);

9399 
vœt_dev
->
´od_id_£t
 = 1;

9400 
	`wr™e_uÆock
(&
vdisk_£rŸl_rwlock
);

9402 
»s
 = 
couÁ
;

9404 
out
:

9405 
	`TRACE_EXIT_RES
(
»s
);

9406  
»s
;

9407 
	}
}

9409 
ssize_t
 
	$vdev_sysfs_´od_id_show
(
kobjeù
 *
kobj
,

9410 
kobj_©Œibu‹
 *
©Œ
,

9411 *
buf
)

9413 
pos
;

9414 
sc¡_deviû
 *
dev
;

9415 
sc¡_vdisk_dev
 *
vœt_dev
;

9417 
	`TRACE_ENTRY
();

9419 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

9420 
vœt_dev
 = 
dev
->
dh_´iv
;

9422 
	`»ad_lock
(&
vdisk_£rŸl_rwlock
);

9423 
pos
 = 
	`¥rštf
(
buf
, "%s\n%s", 
vœt_dev
->
´od_id
,

9424 
vœt_dev
->
´od_id_£t
 ? 
SCST_SYSFS_KEY_MARK
 "\n" : "");

9425 
	`»ad_uÆock
(&
vdisk_£rŸl_rwlock
);

9427 
	`TRACE_EXIT_RES
(
pos
);

9428  
pos
;

9429 
	}
}

9431 
ssize_t
 
	$vdev_sysfs_´od_»v_lvl_¡Üe
(
kobjeù
 *
kobj
,

9432 
kobj_©Œibu‹
 *
©Œ
,

9433 cÚ¡ *
buf
, 
size_t
 
couÁ
)

9435 
sc¡_deviû
 *
dev
;

9436 
sc¡_vdisk_dev
 *
vœt_dev
;

9437 *
p
;

9438 
»s
, 
Ën
;

9440 
	`TRACE_ENTRY
();

9442 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

9443 
vœt_dev
 = 
dev
->
dh_´iv
;

9444 
p
 = 
	`memchr
(
buf
, '\n', 
couÁ
);

9445 
Ën
 = 
p
 ?… - 
buf
 : 
couÁ
;

9447 ià(
Ën
 >ð(
vœt_dev
->
´od_»v_lvl
)) {

9448 
	`PRINT_ERROR
("Product„evision†evel isoo†ong (max %zd"

9450 (
vœt_dev
->
´od_»v_lvl
));

9451 
»s
 = -
EINVAL
;

9452 
out
;

9455 
	`wr™e_lock
(&
vdisk_£rŸl_rwlock
);

9456 
	`¥rštf
(
vœt_dev
->
´od_»v_lvl
, "%.*s", 
Ën
, 
buf
);

9457 
vœt_dev
->
´od_»v_lvl_£t
 = 1;

9458 
	`wr™e_uÆock
(&
vdisk_£rŸl_rwlock
);

9460 
»s
 = 
couÁ
;

9462 
out
:

9463 
	`TRACE_EXIT_RES
(
»s
);

9464  
»s
;

9465 
	}
}

9467 
ssize_t
 
	$vdev_sysfs_´od_»v_lvl_show
(
kobjeù
 *
kobj
,

9468 
kobj_©Œibu‹
 *
©Œ
,

9469 *
buf
)

9471 
pos
;

9472 
sc¡_deviû
 *
dev
;

9473 
sc¡_vdisk_dev
 *
vœt_dev
;

9475 
	`TRACE_ENTRY
();

9477 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

9478 
vœt_dev
 = 
dev
->
dh_´iv
;

9480 
	`»ad_lock
(&
vdisk_£rŸl_rwlock
);

9481 
pos
 = 
	`¥rštf
(
buf
, "%s\n%s", 
vœt_dev
->
´od_»v_lvl
,

9482 
vœt_dev
->
´od_»v_lvl_£t
 ? 
SCST_SYSFS_KEY_MARK
 "\n" :

9484 
	`»ad_uÆock
(&
vdisk_£rŸl_rwlock
);

9486 
	`TRACE_EXIT_RES
(
pos
);

9487  
pos
;

9488 
	}
}

9490 
ssize_t
 
	$vdev_sysfs_scsi_deviû_Çme_¡Üe
(
kobjeù
 *
kobj
,

9491 
kobj_©Œibu‹
 *
©Œ
,

9492 cÚ¡ *
buf
, 
size_t
 
couÁ
)

9494 
sc¡_deviû
 *
dev
;

9495 
sc¡_vdisk_dev
 *
vœt_dev
;

9496 *
p
;

9497 
»s
, 
Ën
;

9499 
	`TRACE_ENTRY
();

9501 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

9502 
vœt_dev
 = 
dev
->
dh_´iv
;

9503 
p
 = 
	`memchr
(
buf
, '\n', 
couÁ
);

9504 
Ën
 = 
p
 ?… - 
buf
 : 
couÁ
;

9506 ià(
Ën
 >ð(
vœt_dev
->
scsi_deviû_Çme
)) {

9507 
	`PRINT_ERROR
("SCSI device‚amel isoo†ong (max %zd characters)",

9508 (
vœt_dev
->
scsi_deviû_Çme
));

9509 
»s
 = -
EINVAL
;

9510 
out
;

9513 
	`wr™e_lock
(&
vdisk_£rŸl_rwlock
);

9514 
	`¥rštf
(
vœt_dev
->
scsi_deviû_Çme
, "%.*s", 
Ën
, 
buf
);

9515 ià(
	`¡¾’
(
vœt_dev
->
scsi_deviû_Çme
) > 0)

9516 
vœt_dev
->
scsi_deviû_Çme_£t
 = 1;

9518 
vœt_dev
->
scsi_deviû_Çme_£t
 = 0;

9519 
	`wr™e_uÆock
(&
vdisk_£rŸl_rwlock
);

9521 
»s
 = 
couÁ
;

9523 
out
:

9524 
	`TRACE_EXIT_RES
(
»s
);

9525  
»s
;

9526 
	}
}

9528 
ssize_t
 
	$vdev_sysfs_scsi_deviû_Çme_show
(
kobjeù
 *
kobj
,

9529 
kobj_©Œibu‹
 *
©Œ
,

9530 *
buf
)

9532 
pos
;

9533 
sc¡_deviû
 *
dev
;

9534 
sc¡_vdisk_dev
 *
vœt_dev
;

9536 
	`TRACE_ENTRY
();

9538 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

9539 
vœt_dev
 = 
dev
->
dh_´iv
;

9541 
	`»ad_lock
(&
vdisk_£rŸl_rwlock
);

9542 
pos
 = 
	`¥rštf
(
buf
, "%s\n%s", 
vœt_dev
->
scsi_deviû_Çme
,

9543 
vœt_dev
->
scsi_deviû_Çme_£t
 ? 
SCST_SYSFS_KEY_MARK
 "\n" : "");

9544 
	`»ad_uÆock
(&
vdisk_£rŸl_rwlock
);

9546 
	`TRACE_EXIT_RES
(
pos
);

9547  
pos
;

9548 
	}
}

9550 
ssize_t
 
	$vdev_sysfs_t10_dev_id_¡Üe
(
kobjeù
 *
kobj
,

9551 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

9553 
»s
, 
i
;

9554 
sc¡_deviû
 *
dev
;

9555 
sc¡_vdisk_dev
 *
vœt_dev
;

9557 
	`TRACE_ENTRY
();

9559 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

9560 
vœt_dev
 = 
dev
->
dh_´iv
;

9562 
»s
 = -
EPERM
;

9563 ià(
dev
->
þu¡”_mode
)

9564 
out
;

9566 
	`wr™e_lock
(&
vdisk_£rŸl_rwlock
);

9568 ià((
couÁ
 > (
vœt_dev
->
t10_dev_id
)) ||

9569 ((
couÁ
 =ð(
vœt_dev
->
t10_dev_id
)) &&

9570 (
buf
[
couÁ
-1] != '\n'))) {

9571 
	`PRINT_ERROR
("T10 device id isoo†ong (max %zd "

9572 "ch¬aù”s)", (
vœt_dev
->
t10_dev_id
)-1);

9573 
»s
 = -
EINVAL
;

9574 
out_uÆock
;

9577 
	`mem£t
(
vœt_dev
->
t10_dev_id
, 0, (virt_dev->t10_dev_id));

9578 
	`memýy
(
vœt_dev
->
t10_dev_id
, 
buf
, 
couÁ
);

9580 
i
 = 0;

9581 
i
 < (
vœt_dev
->
t10_dev_id
)) {

9582 ià(
vœt_dev
->
t10_dev_id
[
i
] == '\n') {

9583 
vœt_dev
->
t10_dev_id
[
i
] = '\0';

9586 
i
++;

9589 
vœt_dev
->
t10_dev_id_£t
 = 1;

9591 
»s
 = 
couÁ
;

9593 
	`PRINT_INFO
("T10 deviû id fÜ deviû % chªgedØ%s", 
vœt_dev
->
Çme
,

9594 
vœt_dev
->
t10_dev_id
);

9596 
out_uÆock
:

9597 
	`wr™e_uÆock
(&
vdisk_£rŸl_rwlock
);

9599 
out
:

9600 
	`TRACE_EXIT_RES
(
»s
);

9601  
»s
;

9602 
	}
}

9604 
ssize_t
 
	$vdev_sysfs_t10_dev_id_show
(
kobjeù
 *
kobj
,

9605 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

9607 
pos
 = 0;

9608 
sc¡_deviû
 *
dev
;

9609 
sc¡_vdisk_dev
 *
vœt_dev
;

9611 
	`TRACE_ENTRY
();

9613 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

9614 
vœt_dev
 = 
dev
->
dh_´iv
;

9616 
	`»ad_lock
(&
vdisk_£rŸl_rwlock
);

9617 
pos
 = 
	`¥rštf
(
buf
, "%s\n%s", 
vœt_dev
->
t10_dev_id
,

9618 
vœt_dev
->
t10_dev_id_£t
 ? 
SCST_SYSFS_KEY_MARK
 "\n" : "");

9619 
	`»ad_uÆock
(&
vdisk_£rŸl_rwlock
);

9621 
	`TRACE_EXIT_RES
(
pos
);

9622  
pos
;

9623 
	}
}

9625 
ssize_t
 
	$vdev_sysfs_eui64_id_¡Üe
(
kobjeù
 *
kobj
,

9626 
kobj_©Œibu‹
 *
©Œ
,

9627 cÚ¡ *
buf
, 
size_t
 
couÁ
)

9629 
»s
 = 
couÁ
;

9630 
sc¡_deviû
 *
dev
;

9631 
sc¡_vdisk_dev
 *
vœt_dev
;

9633 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

9634 
vœt_dev
 = 
dev
->
dh_´iv
;

9636 
couÁ
 > 0 && 
	`is¥aû
((
ušt8_t
)
buf
[0])) {

9637 
buf
++;

9638 
couÁ
--;

9640 
couÁ
 > 0 && 
	`is¥aû
((
ušt8_t
)
buf
[count - 1]))

9641 
couÁ
--;

9642 ià(
couÁ
 >ð2 && 
buf
[0] == '0' && buf[1] == 'x') {

9643 
buf
 += 2;

9644 
couÁ
 -= 2;

9647 
couÁ
) {

9654 
»s
 = -
EINVAL
;

9655 
out
;

9658 
	`wr™e_lock
(&
vdisk_£rŸl_rwlock
);

9659 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(3, 2, 0) || \

9660 
	`defšed
(
CONFIG_SUSE_KERNEL
) && \

9661 
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(3, 0, 76)

9662 ià(
	`hex2bš
(
vœt_dev
->
eui64_id
, 
buf
, 
couÁ
 / 2) == 0)

9663 
vœt_dev
->
eui64_id_Ën
 = 
couÁ
 / 2;

9665 
»s
 = -
EINVAL
;

9667 
	`mem£t
(
vœt_dev
->
eui64_id
, 0, (virt_dev->eui64_id));

9668 
	`hex2bš
(
vœt_dev
->
eui64_id
, 
buf
, 
couÁ
 / 2);

9669 
vœt_dev
->
eui64_id_Ën
 = 
couÁ
 / 2;

9671 
	`wr™e_uÆock
(&
vdisk_£rŸl_rwlock
);

9673 
out
:

9674  
»s
;

9675 
	}
}

9677 
ssize_t
 
	$vdev_sysfs_eui64_id_show
(
kobjeù
 *
kobj
,

9678 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

9680 
i
, 
pos
 = 0;

9681 
sc¡_deviû
 *
dev
;

9682 
sc¡_vdisk_dev
 *
vœt_dev
;

9684 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

9685 
vœt_dev
 = 
dev
->
dh_´iv
;

9687 
	`»ad_lock
(&
vdisk_£rŸl_rwlock
);

9688 ià(
vœt_dev
->
eui64_id_Ën
)

9689 
pos
 +ð
	`¥rštf
(
buf
 +…os, "0x");

9690 
i
 = 0; i < 
vœt_dev
->
eui64_id_Ën
; i++)

9691 
pos
 +ð
	`¥rštf
(
buf
 +…os, "%02x", 
vœt_dev
->
eui64_id
[
i
]);

9692 
pos
 +ð
	`¥rštf
(
buf
 +…os, "\n%s", 
vœt_dev
->
eui64_id_Ën
 ?

9693 
SCST_SYSFS_KEY_MARK
 "\n" : "");

9694 
	`»ad_uÆock
(&
vdisk_£rŸl_rwlock
);

9696  
pos
;

9697 
	}
}

9699 
ssize_t
 
	$vdev_sysfs_Ça_id_¡Üe
(
kobjeù
 *
kobj
,

9700 
kobj_©Œibu‹
 *
©Œ
,

9701 cÚ¡ *
buf
, 
size_t
 
couÁ
)

9703 
»s
 = -
EINVAL
, 
c
 = 
couÁ
;

9704 
sc¡_deviû
 *
dev
;

9705 
sc¡_vdisk_dev
 *
vœt_dev
;

9707 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

9708 
vœt_dev
 = 
dev
->
dh_´iv
;

9710 
c
 > 0 && 
	`is¥aû
((
ušt8_t
)
buf
[0])) {

9711 
buf
++;

9712 
c
--;

9714 
c
 > 0 && 
	`is¥aû
((
ušt8_t
)
buf
[c - 1]))

9715 
c
--;

9716 ià(
c
 >ð2 && 
buf
[0] == '0' && buf[1] == 'x') {

9717 
buf
 += 2;

9718 
c
 -= 2;

9721 
c
) {

9724 ià(
	`¡rchr
("235", 
buf
[0]))

9727 
out
;

9729 ià(
	`¡rchr
("6", 
buf
[0]))

9732 
out
;

9734 
out
;

9737 
»s
 = 
couÁ
;

9739 
	`wr™e_lock
(&
vdisk_£rŸl_rwlock
);

9740 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(3, 2, 0) || \

9741 
	`defšed
(
CONFIG_SUSE_KERNEL
) && \

9742 
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(3, 0, 76)

9743 ià(
	`hex2bš
(
vœt_dev
->
Ça_id
, 
buf
, 
c
 / 2) == 0)

9744 
vœt_dev
->
Ça_id_Ën
 = 
c
 / 2;

9746 
»s
 = -
EINVAL
;

9748 
	`mem£t
(
vœt_dev
->
Ça_id
, 0, (virt_dev->naa_id));

9749 
	`hex2bš
(
vœt_dev
->
Ça_id
, 
buf
, 
c
 / 2);

9750 
vœt_dev
->
Ça_id_Ën
 = 
c
 / 2;

9752 
	`wr™e_uÆock
(&
vdisk_£rŸl_rwlock
);

9754 
out
:

9755  
»s
;

9756 
	}
}

9758 
ssize_t
 
	$vdev_sysfs_Ça_id_show
(
kobjeù
 *
kobj
,

9759 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

9761 
i
, 
pos
 = 0;

9762 
sc¡_deviû
 *
dev
;

9763 
sc¡_vdisk_dev
 *
vœt_dev
;

9765 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

9766 
vœt_dev
 = 
dev
->
dh_´iv
;

9768 
	`»ad_lock
(&
vdisk_£rŸl_rwlock
);

9769 ià(
vœt_dev
->
Ça_id_Ën
)

9770 
pos
 +ð
	`¥rštf
(
buf
 +…os, "0x");

9771 
i
 = 0; i < 
vœt_dev
->
Ça_id_Ën
; i++)

9772 
pos
 +ð
	`¥rštf
(
buf
 +…os, "%02x", 
vœt_dev
->
Ça_id
[
i
]);

9773 
pos
 +ð
	`¥rštf
(
buf
 +…os, "\n%s", 
vœt_dev
->
Ça_id_Ën
 ?

9774 
SCST_SYSFS_KEY_MARK
 "\n" : "");

9775 
	`»ad_uÆock
(&
vdisk_£rŸl_rwlock
);

9777  
pos
;

9778 
	}
}

9780 
ssize_t
 
	$vdev_sysfs_u¢_¡Üe
(
kobjeù
 *
kobj
,

9781 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

9783 
»s
, 
i
;

9784 
sc¡_deviû
 *
dev
;

9785 
sc¡_vdisk_dev
 *
vœt_dev
;

9787 
	`TRACE_ENTRY
();

9789 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

9790 
vœt_dev
 = 
dev
->
dh_´iv
;

9792 
	`wr™e_lock
(&
vdisk_£rŸl_rwlock
);

9794 ià((
couÁ
 > (
vœt_dev
->
u¢
)) ||

9795 ((
couÁ
 =ð(
vœt_dev
->
u¢
)) &&

9796 (
buf
[
couÁ
-1] != '\n'))) {

9797 
	`PRINT_ERROR
("USN isoo†ong (max %zd "

9798 "ch¬aù”s)", (
vœt_dev
->
u¢
)-1);

9799 
»s
 = -
EINVAL
;

9800 
out_uÆock
;

9803 
	`mem£t
(
vœt_dev
->
u¢
, 0, (virt_dev->usn));

9804 
	`memýy
(
vœt_dev
->
u¢
, 
buf
, 
couÁ
);

9806 
i
 = 0;

9807 
i
 < (
vœt_dev
->
u¢
)) {

9808 ià(
vœt_dev
->
u¢
[
i
] == '\n') {

9809 
vœt_dev
->
u¢
[
i
] = '\0';

9812 
i
++;

9815 
vœt_dev
->
u¢_£t
 = 1;

9817 
»s
 = 
couÁ
;

9819 
	`PRINT_INFO
("USN fÜ deviû % chªgedØ%s", 
vœt_dev
->
Çme
,

9820 
vœt_dev
->
u¢
);

9822 
out_uÆock
:

9823 
	`wr™e_uÆock
(&
vdisk_£rŸl_rwlock
);

9825 
	`TRACE_EXIT_RES
(
»s
);

9826  
»s
;

9827 
	}
}

9829 
ssize_t
 
	$vdev_sysfs_u¢_show
(
kobjeù
 *
kobj
,

9830 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

9832 
pos
 = 0;

9833 
sc¡_deviû
 *
dev
;

9834 
sc¡_vdisk_dev
 *
vœt_dev
;

9836 
	`TRACE_ENTRY
();

9838 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

9839 
vœt_dev
 = 
dev
->
dh_´iv
;

9841 
	`»ad_lock
(&
vdisk_£rŸl_rwlock
);

9842 
pos
 = 
	`¥rštf
(
buf
, "%s\n%s", 
vœt_dev
->
u¢
,

9843 
vœt_dev
->
u¢_£t
 ? 
SCST_SYSFS_KEY_MARK
 "\n" : "");

9844 
	`»ad_uÆock
(&
vdisk_£rŸl_rwlock
);

9846 
	`TRACE_EXIT_RES
(
pos
);

9847  
pos
;

9848 
	}
}

9850 
ssize_t
 
	$vdev_sysfs_šq_v’d_¥ecific_¡Üe
(
kobjeù
 *
kobj
,

9851 
kobj_©Œibu‹
 *
©Œ
,

9852 cÚ¡ *
buf
, 
size_t
 
couÁ
)

9854 
sc¡_deviû
 *
dev
;

9855 
sc¡_vdisk_dev
 *
vœt_dev
;

9856 *
p
;

9857 
»s
 = -
EINVAL
, 
Ën
;

9859 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

9860 
vœt_dev
 = 
dev
->
dh_´iv
;

9861 
p
 = 
	`memchr
(
buf
, '\n', 
couÁ
);

9862 
Ën
 = 
p
 ?… - 
buf
 : 
couÁ
;

9863 ià(
Ën
 > 
MAX_INQ_VEND_SPECIFIC_LEN
)

9864 
out
;

9866 
	`wr™e_lock
(&
vdisk_£rŸl_rwlock
);

9867 
	`memýy
(
vœt_dev
->
šq_v’d_¥ecific
, 
buf
, 
Ën
);

9868 
vœt_dev
->
šq_v’d_¥ecific_Ën
 = 
Ën
;

9869 
	`wr™e_uÆock
(&
vdisk_£rŸl_rwlock
);

9871 
»s
 = 
couÁ
;

9873 
out
:

9874  
»s
;

9875 
	}
}

9877 
ssize_t
 
	$vdev_sysfs_šq_v’d_¥ecific_show
(
kobjeù
 *
kobj
,

9878 
kobj_©Œibu‹
 *
©Œ
,

9879 *
buf
)

9881 
pos
;

9882 
sc¡_deviû
 *
dev
;

9883 
sc¡_vdisk_dev
 *
vœt_dev
;

9885 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

9886 
vœt_dev
 = 
dev
->
dh_´iv
;

9888 
	`»ad_lock
(&
vdisk_£rŸl_rwlock
);

9889 
pos
 = 
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%.*s\n%s",

9890 
vœt_dev
->
šq_v’d_¥ecific_Ën
,

9891 
vœt_dev
->
šq_v’d_¥ecific
,

9892 
vœt_dev
->
šq_v’d_¥ecific_Ën
 ?

9893 
SCST_SYSFS_KEY_MARK
 "\n" : "");

9894 
	`»ad_uÆock
(&
vdisk_£rŸl_rwlock
);

9896  
pos
;

9897 
	}
}

9899 
ssize_t
 
	$vdev_z”o_cÝy_show
(
kobjeù
 *
kobj
,

9900 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

9902 
pos
 = 0;

9903 
sc¡_deviû
 *
dev
;

9904 
sc¡_vdisk_dev
 *
vœt_dev
;

9906 
	`TRACE_ENTRY
();

9908 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

9909 
vœt_dev
 = 
dev
->
dh_´iv
;

9911 
pos
 = 
	`¥rštf
(
buf
, "%d\n%s", 
vœt_dev
->
z”o_cÝy
,

9912 
vœt_dev
->
z”o_cÝy
 ? 
SCST_SYSFS_KEY_MARK
 "\n" : "");

9914 
	`TRACE_EXIT_RES
(
pos
);

9915  
pos
;

9916 
	}
}

9918 
ssize_t
 
	$vdev_dif_fž’ame_show
(
kobjeù
 *
kobj
,

9919 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

9921 
pos
 = 0;

9922 
sc¡_deviû
 *
dev
;

9923 
sc¡_vdisk_dev
 *
vœt_dev
;

9925 
	`TRACE_ENTRY
();

9927 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

9928 
vœt_dev
 = 
dev
->
dh_´iv
;

9930 
pos
 = 
	`¥rštf
(
buf
, "%s\n%s", 
vœt_dev
->
dif_fž’ame
,

9931 (
vœt_dev
->
dif_fž’ame
 !ð
NULL
è? 
SCST_SYSFS_KEY_MARK
 "\n" : "");

9933 
	`TRACE_EXIT_RES
(
pos
);

9934  
pos
;

9935 
	}
}

9946 
	$vdisk_»ad_´oc
(
£q_fže
 *
£q
, 
sc¡_dev_ty³
 *
dev_ty³
)

9948 
»s
 = 0;

9949 
sc¡_vdisk_dev
 *
vœt_dev
;

9951 
	`TRACE_ENTRY
();

9953 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_vdisk_mu‹x
);

9954 ià(
»s
 != 0)

9955 
out
;

9957 
	`£q_´štf
(
£q
, "%-17s %-11s %-11s %-15s %-45s %-16s\n",

9961 
	`li¡_fÜ_—ch_’Œy
(
vœt_dev
, &
vdev_li¡
, 
vdev_li¡_’Œy
) {

9962 
c
;

9964 
	`sBUG_ON
(!
vœt_dev
->
dev
);

9966 ià(
vœt_dev
->
dev
->
ty³
 !ð
TYPE_DISK
)

9968 
	`£q_´štf
(
£q
, "%-17 %-11d %-12d", 
vœt_dev
->
Çme
,

9969 (
ušt32_t
)(
vœt_dev
->
fže_size
 >> 20),

9970 1 << 
vœt_dev
->
blk_shiá
);

9971 
c
 = 0;

9972 ià(
vœt_dev
->
wt_æag
) {

9973 
	`£q_´štf
(
£q
, "WT ");

9974 
c
 += 3;

9976 ià(
vœt_dev
->
nv_ÿche
) {

9977 
	`£q_´štf
(
£q
, "NV ");

9978 
c
 += 3;

9980 ià(
vœt_dev
->
dev
->
dev_rd_Úly
) {

9981 
	`£q_´štf
(
£q
, "RO ");

9982 
c
 += 3;

9984 ià(
vœt_dev
->
o_dœeù_æag
) {

9985 
	`£q_´štf
(
£q
, "DR ");

9986 
c
 += 3;

9988 ià(
vœt_dev
->
nuÎio
) {

9989 
	`£q_´štf
(
£q
, "NIO ");

9990 
c
 += 4;

9992 ià(
vœt_dev
->
blockio
) {

9993 
	`£q_´štf
(
£q
, "BIO ");

9994 
c
 += 4;

9996 ià(
vœt_dev
->
»movabË
) {

9997 
	`£q_´štf
(
£q
, "RM ");

9998 
c
 += 3;

10000 
c
 < 16) {

10001 
	`£q_´štf
(
£q
, " ");

10002 
c
++;

10004 
	`»ad_lock
(&
vdisk_£rŸl_rwlock
);

10005 
	`£q_´štf
(
£q
, "%-45 %-16s\n", 
	`vdev_g‘_fž’ame
(
vœt_dev
),

10006 
vœt_dev
->
t10_dev_id
);

10007 
	`»ad_uÆock
(&
vdisk_£rŸl_rwlock
);

10009 
	`mu‹x_uÆock
(&
sc¡_vdisk_mu‹x
);

10010 
out
:

10011 
	`TRACE_EXIT_RES
(
»s
);

10012  
»s
;

10013 
	}
}

10018 
	$vdisk_wr™e_´oc
(*
bufãr
, **
¡¬t
, 
off_t
 
off£t
,

10019 
Ëngth
, *
eof
, 
sc¡_dev_ty³
 *
dev_ty³
)

10021 
»s
 = 0, 
aùiÚ
;

10022 *
p
, *
Çme
, *
fž’ame
, *
i_buf
, *
t10_dev_id
;

10023 
sc¡_vdisk_dev
 *
vœt_dev
;

10024 
block_shiá
 = 
DEF_DISK_BLOCK_SHIFT
;

10025 
ušt32_t
 
block_size
 = 1 << 
block_shiá
;

10026 
size_t
 
¦’
;

10028 
	`TRACE_ENTRY
();

10030 ià((
Ëngth
 =ð0è|| (
bufãr
 =ð
NULL
) || (buffer[0] == '\0'))

10031 
out
;

10033 
i_buf
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%.*s", ()
Ëngth
, 
bufãr
);

10034 ià(
i_buf
 =ð
NULL
) {

10035 
	`PRINT_ERROR
("Unableo‡lloc intermediate buffer with size %d",

10036 
Ëngth
+1);

10037 
»s
 = -
ENOMEM
;

10038 
out
;

10041 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_vdisk_mu‹x
);

10042 ià(
»s
 != 0)

10043 
out_ä“
;

10045 
p
 = 
i_buf
;

10046 ià(
p
[
	`¡¾’
(p) - 1] == '\n')

10047 
p
[
	`¡¾’
(p) - 1] = '\0';

10048 ià(!
	`¡ºcmp
("þo£ ", 
p
, 6)) {

10049 
p
 += 6;

10050 
aùiÚ
 = 0;

10051 } ià(!
	`¡ºcmp
("Ý’ ", 
p
, 5)) {

10052 
p
 += 5;

10053 
aùiÚ
 = 1;

10054 } ià(!
	`¡ºcmp
("»sync_siz", 
p
, 12)) {

10055 
p
 += 12;

10056 
aùiÚ
 = 2;

10057 } ià(!
	`¡ºcmp
("£t_t10_dev_id ", 
p
, 15)) {

10058 
p
 += 15;

10059 
aùiÚ
 = 3;

10061 
	`PRINT_ERROR
("UnknowÀaùiÚ \"%s\"", 
p
);

10062 
»s
 = -
EINVAL
;

10063 
out_up
;

10066 
	`is¥aû
(*
p
) && *p != '\0')

10067 
p
++;

10068 
Çme
 = 
p
;

10069 !
	`is¥aû
(*
p
) && *p != '\0')

10070 
p
++;

10071 *
p
++ = '\0';

10072 ià(*
Çme
 == '\0') {

10073 
	`PRINT_ERROR
("%s", "Name„equired");

10074 
»s
 = -
EINVAL
;

10075 
out_up
;

10076 } ià(
	`¡¾’
(
Çme
è>ð(
vœt_dev
->name)) {

10077 
	`PRINT_ERROR
("Name isoo†ong (max %zd "

10078 "ch¬aù”s)", (
vœt_dev
->
Çme
)-1);

10079 
»s
 = -
EINVAL
;

10080 
out_up
;

10083 ià(
aùiÚ
 == 1) {

10085 
	`is¥aû
(*
p
) && *p != '\0')

10086 
p
++;

10087 
fž’ame
 = 
p
;

10088 !
	`is¥aû
(*
p
) && *p != '\0')

10089 
p
++;

10090 *
p
++ = '\0';

10091 ià(*
fž’ame
 == '\0') {

10092 
	`PRINT_ERROR
("%s", "File‚ame„equired");

10093 
»s
 = -
EINVAL
;

10094 
out_up
;

10097 
»s
 = 
	`vdev_ü—‹
(
dev_ty³
, 
Çme
, &
vœt_dev
);

10098 ià(
»s
 != 0)

10099 
out_up
;

10101 
vœt_dev
->
wt_æag
 = 
DEF_WRITE_THROUGH
;

10102 
vœt_dev
->
nv_ÿche
 = 
DEF_NV_CACHE
;

10103 
vœt_dev
->
o_dœeù_æag
 = 
DEF_O_DIRECT
;

10105 
	`is¥aû
(*
p
) && *p != '\0')

10106 
p
++;

10108 ià(
	`isdig™
(*
p
)) {

10109 *
µ
;

10110 
block_size
 = 
	`sim¶e_¡¹oul
(
p
, &
µ
, 0);

10111 
p
 = 
µ
;

10112 ià((*
p
 !ð'\0'è&& !
	`is¥aû
(*p)) {

10113 
	`PRINT_ERROR
("P¬£ƒ¼Ü: \"%s\"", 
p
);

10114 
»s
 = -
EINVAL
;

10115 
out_ä“_vdev
;

10117 
	`is¥aû
(*
p
) && *p != '\0')

10118 
p
++;

10120 
block_shiá
 = 
	`sc¡_ÿlc_block_shiá
(
block_size
);

10121 ià(
block_shiá
 < 9) {

10122 
»s
 = -
EINVAL
;

10123 
out_ä“_vdev
;

10126 
vœt_dev
->
blk_shiá
 = 
block_shiá
;

10128 *
p
 != '\0') {

10129 ià(!
	`¡ºcmp
("WRITE_THROUGH", 
p
, 13)) {

10130 
p
 += 13;

10131 
vœt_dev
->
wt_æag
 = 1;

10132 
	`TRACE_DBG
("%s", "WRITE_THROUGH");

10133 } ià(!
	`¡ºcmp
("NV_CACHE", 
p
, 8)) {

10134 
p
 += 8;

10135 
vœt_dev
->
nv_ÿche
 = 1;

10136 
	`TRACE_DBG
("%s", "NON-VOLATILE CACHE");

10137 } ià(!
	`¡ºcmp
("READ_ONLY", 
p
, 9)) {

10138 
p
 += 9;

10139 
vœt_dev
->
rd_Úly
 = 1;

10140 
	`TRACE_DBG
("%s", "READ_ONLY");

10141 } ià(!
	`¡ºcmp
("O_DIRECT", 
p
, 8)) {

10142 
p
 += 8;

10145 
vœt_dev
->
o_dœeù_æag
 = 1;

10146 
	`TRACE_DBG
("%s", "O_DIRECT");

10148 
	`PRINT_INFO
("%s flag doesn't currently"

10152 } ià(!
	`¡ºcmp
("NULLIO", 
p
, 6)) {

10153 
p
 += 6;

10154 
vœt_dev
->
nuÎio
 = 1;

10156 
vœt_dev
->
vdev_devt
 = &
vdisk_nuÎ_devty³
;

10157 
	`TRACE_DBG
("%s", "NULLIO");

10158 } ià(!
	`¡ºcmp
("BLOCKIO", 
p
, 7)) {

10159 
p
 += 7;

10160 
vœt_dev
->
blockio
 = 1;

10161 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 30)

10162 
»s
 = 
	`vdisk_ü—‹_bio£t
(
vœt_dev
);

10163 ià(
»s
 != 0)

10164 
out_ä“_vdev
;

10167 
vœt_dev
->
vdev_devt
 = &
vdisk_blk_devty³
;

10168 
	`¥rštf
(
vœt_dev
->
t10_v’d_id
, "%.*s",

10169 ()(
vœt_dev
->
t10_v’d_id
) - 1,

10170 
SCST_BIO_VENDOR
);

10171 
	`TRACE_DBG
("%s", "BLOCKIO");

10172 } ià(!
	`¡ºcmp
("REMOVABLE", 
p
, 9)) {

10173 
p
 += 9;

10174 
vœt_dev
->
»movabË
 = 1;

10175 
	`TRACE_DBG
("%s", "REMOVABLE");

10177 
	`PRINT_ERROR
("UnknowÀæag \"%s\"", 
p
);

10178 
»s
 = -
EINVAL
;

10179 
out_ä“_vdev
;

10181 
	`is¥aû
(*
p
) && *p != '\0')

10182 
p
++;

10185 ià(!
vœt_dev
->
nuÎio
 && (*
fž’ame
 != '/')) {

10186 
	`PRINT_ERROR
("File…ath \"%s\" is‚ot "

10187 "absÞu‹", 
fž’ame
);

10188 
»s
 = -
EINVAL
;

10189 
out_up
;

10192 
vœt_dev
->
fž’ame
 = 
	`k¡rdup
(fž’ame, 
GFP_KERNEL
);

10193 ià(
vœt_dev
->
fž’ame
 =ð
NULL
) {

10194 
	`PRINT_ERROR
("%s", "Allocation of filename failed");

10195 
»s
 = -
ENOMEM
;

10196 
out_ä“_vdev
;

10199 
	`li¡_add_ž
(&
vœt_dev
->
vdev_li¡_’Œy
,

10200 &
vdev_li¡
);

10202 
	`vdisk_»pÜt_»gi¡”šg
(
vœt_dev
);

10203 
vœt_dev
->
vœt_id
 = 
	`sc¡_»gi¡”_vœtu®_deviû
(

10204 
vœt_dev
->
vdev_devt
, vœt_dev->
Çme
);

10205 ià(
vœt_dev
->
vœt_id
 < 0) {

10206 
»s
 = 
vœt_dev
->
vœt_id
;

10207 
out_ä“_v·th
;

10209 
	`TRACE_DBG
("Added virt_dev (name %s, file‚ame %s, "

10211 "vdev_li¡", 
vœt_dev
->
Çme
,

10212 
	`vdev_g‘_fž’ame
(
vœt_dev
), vœt_dev->
vœt_id
,

10213 1 << 
vœt_dev
->
blk_shiá
);

10214 } ià(
aùiÚ
 == 0) {

10215 
vœt_dev
 = 
	`vdev_fšd
(
Çme
);

10216 ià(
vœt_dev
 =ð
NULL
) {

10217 
	`PRINT_ERROR
("Deviû % nÙ found", 
Çme
);

10218 
»s
 = -
EINVAL
;

10219 
out_up
;

10221 
	`vdev_d–_deviû
(
vœt_dev
);

10222 } ià(
aùiÚ
 == 2) {

10223 
vœt_dev
 = 
	`vdev_fšd
(
Çme
);

10224 ià(
vœt_dev
 =ð
NULL
) {

10225 
	`PRINT_ERROR
("Deviû % nÙ found", 
Çme
);

10226 
»s
 = -
EINVAL
;

10227 
out_up
;

10230 
»s
 = 
	`vdisk_»sync_size
(
vœt_dev
);

10231 ià(
»s
 != 0)

10232 
out_up
;

10233 } ià(
aùiÚ
 == 3) {

10234 
vœt_dev
 = 
	`vdev_fšd
(
Çme
);

10235 ià(
vœt_dev
 =ð
NULL
) {

10236 
	`PRINT_ERROR
("Deviû % nÙ found", 
Çme
);

10237 
»s
 = -
EINVAL
;

10238 
out_up
;

10241 
	`is¥aû
(*
p
) && *p != '\0')

10242 
p
++;

10243 
t10_dev_id
 = 
p
;

10244 *
p
 != '\0')

10245 
p
++;

10246 *
p
++ = '\0';

10247 ià(*
t10_dev_id
 == '\0') {

10248 
	`PRINT_ERROR
("%s", "T10 device id„equired");

10249 
»s
 = -
EINVAL
;

10250 
out_up
;

10253 
	`wr™e_lock
(&
vdisk_£rŸl_rwlock
);

10255 
¦’
 = (
	`¡¾’
(
t10_dev_id
è<ð((
vœt_dev
->t10_dev_id)-1) ?

10256 
	`¡¾’
(
t10_dev_id
) :

10257 ((
vœt_dev
->
t10_dev_id
)-1));

10259 
	`mem£t
(
vœt_dev
->
t10_dev_id
, 0, (virt_dev->t10_dev_id));

10260 
	`memýy
(
vœt_dev
->
t10_dev_id
,10_dev_id, 
¦’
);

10262 
	`PRINT_INFO
("T10 device id for device %s changedo %s",

10263 
vœt_dev
->
Çme
, vœt_dev->
t10_dev_id
);

10265 
	`wr™e_uÆock
(&
vdisk_£rŸl_rwlock
);

10267 
»s
 = 
Ëngth
;

10269 
out_up
:

10270 
	`mu‹x_uÆock
(&
sc¡_vdisk_mu‹x
);

10272 
out_ä“
:

10273 
	`kä“
(
i_buf
);

10275 
out
:

10276 
	`TRACE_EXIT_RES
(
»s
);

10277  
»s
;

10279 
out_ä“_v·th
:

10280 
	`li¡_d–
(&
vœt_dev
->
vdev_li¡_’Œy
);

10281 
	`kä“
(
vœt_dev
->
fž’ame
);

10282 
vœt_dev
->
fž’ame
 = 
NULL
;

10284 
out_ä“_vdev
:

10285 
	`vdev_de¡roy
(
vœt_dev
);

10286 
out_up
;

10287 
	}
}

10292 
	$vcdrom_»ad_´oc
(
£q_fže
 *
£q
,

10293 
sc¡_dev_ty³
 *
dev_ty³
)

10295 
»s
 = 0;

10296 
sc¡_vdisk_dev
 *
vœt_dev
;

10298 
	`TRACE_ENTRY
();

10300 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_vdisk_mu‹x
);

10301 ià(
»s
 != 0)

10302 
out
;

10304 
	`£q_´štf
(
£q
, "%-17s %-9s %s\n", "Name", "Size(MB)", "File‚ame");

10306 
	`li¡_fÜ_—ch_’Œy
(
vœt_dev
, &
vdev_li¡
, 
vdev_li¡_’Œy
) {

10307 ià(
vœt_dev
->
dev
->
ty³
 !ð
TYPE_ROM
)

10309 
	`£q_´štf
(
£q
, "%-17 %-9d %s\n", 
vœt_dev
->
Çme
,

10310 (
ušt32_t
)(
vœt_dev
->
fže_size
 >> 20),

10311 
	`vdev_g‘_fž’ame
(
vœt_dev
));

10314 
	`mu‹x_uÆock
(&
sc¡_vdisk_mu‹x
);

10316 
out
:

10317 
	`TRACE_EXIT_RES
(
»s
);

10318  
»s
;

10319 
	}
}

10322 
	$vcdrom_Ý’
(*
p
, *
Çme
)

10324 
sc¡_vdisk_dev
 *
vœt_dev
;

10325 *
fž’ame
;

10326 
»s
 = 0;

10327 
cdrom_em±y
;

10329 
	`is¥aû
(*
p
) && *p != '\0')

10330 
p
++;

10331 
fž’ame
 = 
p
;

10332 !
	`is¥aû
(*
p
) && *p != '\0')

10333 
p
++;

10334 *
p
++ = '\0';

10335 ià(*
fž’ame
 == '\0') {

10336 
cdrom_em±y
 = 1;

10337 
	`TRACE_DBG
("%s", "No media");

10338 } ià(*
fž’ame
 != '/') {

10339 
	`PRINT_ERROR
("Fž·th \"%s\" i nÙ‡bsÞu‹", 
fž’ame
);

10340 
»s
 = -
EINVAL
;

10341 
out
;

10343 
cdrom_em±y
 = 0;

10345 
»s
 = 
	`vdev_ü—‹
(&
vcdrom_devty³
, 
Çme
, &
vœt_dev
);

10346 ià(
»s
 != 0)

10347 
out
;

10349 
vœt_dev
->
cdrom_em±y
 = cdrom_empty;

10350 
vœt_dev
->
rd_Úly
 = 1;

10351 
vœt_dev
->
»movabË
 = 1;

10353 ià(!
vœt_dev
->
cdrom_em±y
) {

10354 
vœt_dev
->
fž’ame
 = 
	`k¡rdup
(fž’ame, 
GFP_KERNEL
);

10355 ià(
vœt_dev
->
fž’ame
 =ð
NULL
) {

10356 
	`PRINT_ERROR
("%s", "Allocation of filename failed");

10357 
»s
 = -
ENOMEM
;

10358 
out_ä“_vdev
;

10362 
	`li¡_add_ž
(&
vœt_dev
->
vdev_li¡_’Œy
, &
vdev_li¡
);

10364 
	`PRINT_INFO
("Regi¡”šg vœtu® CDROM %s", 
Çme
);

10366 
vœt_dev
->
vœt_id
 =

10367 
	`sc¡_»gi¡”_vœtu®_deviû
(&
vcdrom_devty³
,

10368 
vœt_dev
->
Çme
);

10369 ià(
vœt_dev
->
vœt_id
 < 0) {

10370 
»s
 = 
vœt_dev
->
vœt_id
;

10371 
out_ä“_v·th
;

10373 
	`TRACE_DBG
("Added virt_dev (name %s filename %s id %d) "

10374 "tØvdev_li¡", 
vœt_dev
->
Çme
,

10375 
	`vdev_g‘_fž’ame
(
vœt_dev
), vœt_dev->
vœt_id
);

10377 
out
:

10378  
»s
;

10380 
out_ä“_v·th
:

10381 
	`li¡_d–
(&
vœt_dev
->
vdev_li¡_’Œy
);

10382 
	`kä“
(
vœt_dev
->
fž’ame
);

10383 
vœt_dev
->
fž’ame
 = 
NULL
;

10385 
out_ä“_vdev
:

10386 
	`vdev_de¡roy
(
vœt_dev
);

10387 
out
;

10388 
	}
}

10391 
	$vcdrom_þo£
(*
Çme
)

10393 
sc¡_vdisk_dev
 *
vœt_dev
;

10394 
»s
 = 0;

10396 
vœt_dev
 = 
	`vdev_fšd
(
Çme
);

10397 ià(
vœt_dev
 =ð
NULL
) {

10398 
	`PRINT_ERROR
("Virtual device with‚ame "

10399 "% nÙ found", 
Çme
);

10400 
»s
 = -
EINVAL
;

10401 
out
;

10404 
	`vdev_d–_deviû
(
vœt_dev
);

10406 
out
:

10407  
»s
;

10408 
	}
}

10411 
	$vcdrom_´oc_chªge
(*
p
, cÚ¡ *
Çme
)

10413 
sc¡_vdisk_dev
 *
vœt_dev
;

10414 
»s
;

10416 
vœt_dev
 = 
	`vdev_fšd
(
Çme
);

10417 ià(
vœt_dev
 =ð
NULL
) {

10418 
	`PRINT_ERROR
("Virtual cdrom with‚ame "

10419 "% nÙ found", 
Çme
);

10420 
»s
 = -
EINVAL
;

10421 
out
;

10424 
»s
 = 
	`vcdrom_chªge
(
vœt_dev
, 
p
);

10426 
out
:

10427  
»s
;

10428 
	}
}

10433 
	$vcdrom_wr™e_´oc
(*
bufãr
, **
¡¬t
, 
off_t
 
off£t
,

10434 
Ëngth
, *
eof
, 
sc¡_dev_ty³
 *
dev_ty³
)

10436 
»s
 = 0, 
aùiÚ
;

10437 *
p
, *
Çme
, *
i_buf
;

10438 
sc¡_vdisk_dev
 *
vœt_dev
;

10440 
	`TRACE_ENTRY
();

10442 ià((
Ëngth
 =ð0è|| (
bufãr
 =ð
NULL
) || (buffer[0] == '\0'))

10443 
out
;

10445 
i_buf
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%.*s", ()
Ëngth
, 
bufãr
);

10446 ià(
i_buf
 =ð
NULL
) {

10447 
	`PRINT_ERROR
("Unableo‡lloc intermediate buffer with size %d",

10448 
Ëngth
+1);

10449 
»s
 = -
ENOMEM
;

10450 
out
;

10453 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_vdisk_mu‹x
);

10454 ià(
»s
 != 0)

10455 
out_ä“
;

10457 
p
 = 
i_buf
;

10458 ià(
p
[
	`¡¾’
(p) - 1] == '\n')

10459 
p
[
	`¡¾’
(p) - 1] = '\0';

10460 ià(!
	`¡ºcmp
("þo£ ", 
p
, 6)) {

10461 
p
 += 6;

10462 
aùiÚ
 = 0;

10463 } ià(!
	`¡ºcmp
("chªg", 
p
, 7)) {

10464 
p
 += 7;

10465 
aùiÚ
 = 1;

10466 } ià(!
	`¡ºcmp
("Ý’ ", 
p
, 5)) {

10467 
p
 += 5;

10468 
aùiÚ
 = 2;

10470 
	`PRINT_ERROR
("UnknowÀaùiÚ \"%s\"", 
p
);

10471 
»s
 = -
EINVAL
;

10472 
out_up
;

10475 
	`is¥aû
(*
p
) && *p != '\0')

10476 
p
++;

10477 
Çme
 = 
p
;

10478 !
	`is¥aû
(*
p
) && *p != '\0')

10479 
p
++;

10480 *
p
++ = '\0';

10481 ià(*
Çme
 == '\0') {

10482 
	`PRINT_ERROR
("%s", "Name„equired");

10483 
»s
 = -
EINVAL
;

10484 
out_up
;

10485 } ià(
	`¡¾’
(
Çme
è>ð(
vœt_dev
->name)) {

10486 
	`PRINT_ERROR
("Name isoo†ong (max %zd "

10487 "ch¬aù”s)", (
vœt_dev
->
Çme
)-1);

10488 
»s
 = -
EINVAL
;

10489 
out_up
;

10492 ià(
aùiÚ
 == 2) {

10494 
»s
 = 
	`vcdrom_Ý’
(
p
, 
Çme
);

10495 ià(
»s
 != 0)

10496 
out_up
;

10497 } ià(
aùiÚ
 == 1) {

10499 
»s
 = 
	`vcdrom_´oc_chªge
(
p
, 
Çme
);

10500 ià(
»s
 != 0)

10501 
out_up
;

10504 
»s
 = 
	`vcdrom_þo£
(
Çme
);

10505 ià(
»s
 != 0)

10506 
out_up
;

10508 
»s
 = 
Ëngth
;

10510 
out_up
:

10511 
	`mu‹x_uÆock
(&
sc¡_vdisk_mu‹x
);

10513 
out_ä“
:

10514 
	`kä“
(
i_buf
);

10516 
out
:

10517 
	`TRACE_EXIT_RES
(
»s
);

10518  
»s
;

10519 
	}
}

10521 
	$vdisk_h–p_šfo_show
(
£q_fže
 *
£q
, *
v
)

10523 *
s
 = (*)
£q
->
´iv©e
;

10525 
	`TRACE_ENTRY
();

10527 
	`£q_´štf
(
£q
, "%s", 
s
);

10529 
	`TRACE_EXIT
();

10531 
	}
}

10533 
sc¡_´oc_d©a
 
	gvdisk_h–p_´oc_d©a
 = {

10534 
SCST_DEF_RW_SEQ_OP
(
NULL
)

10535 .
show
 = 
vdisk_h–p_šfo_show
,

10538 
	$vdisk_´oc_h–p_bužd
(
sc¡_dev_ty³
 *
dev_ty³
)

10540 
»s
 = 0;

10541 
´oc_dœ_’Œy
 *
p
, *
roÙ
;

10543 
	`TRACE_ENTRY
();

10545 
roÙ
 = 
	`sc¡_´oc_g‘_dev_ty³_roÙ
(
dev_ty³
);

10546 
vdisk_h–p_´oc_d©a
.
d©a
 = (
dev_ty³
->
ty³
 =ð
TYPE_DISK
) ?

10547 
vdisk_´oc_h–p_¡ršg
 :

10548 
vcdrom_´oc_h–p_¡ršg
;

10549 
p
 = 
	`sc¡_ü—‹_´oc_’Œy
(
roÙ
, 
VDISK_PROC_HELP
,

10550 &
vdisk_h–p_´oc_d©a
);

10551 ià(
p
 =ð
NULL
) {

10552 
	`PRINT_ERROR
("Notƒnough memoryo„egister dev "

10553 "hªdË¸% ’Œy % š /´oc", "vdisk", 
VDISK_PROC_HELP
);

10554 
»s
 = -
ENOMEM
;

10557 
	`TRACE_EXIT_RES
(
»s
);

10558  
»s
;

10559 
	}
}

10561 
	$vdisk_´oc_h–p_de¡roy
(
sc¡_dev_ty³
 *
dev_ty³
)

10563 
´oc_dœ_’Œy
 *
roÙ
;

10565 
	`TRACE_ENTRY
();

10567 
roÙ
 = 
	`sc¡_´oc_g‘_dev_ty³_roÙ
(
dev_ty³
);

10568 ià(
roÙ
)

10569 
	`»move_´oc_’Œy
(
VDISK_PROC_HELP
, 
roÙ
);

10571 
	`TRACE_EXIT
();

10572 
	}
}

10576 
__š™
 
	$š™_sc¡_vdisk
(
sc¡_dev_ty³
 *
devty³
)

10578 
»s
 = 0;

10580 
	`TRACE_ENTRY
();

10582 
devty³
->
moduË
 = 
THIS_MODULE
;

10584 
»s
 = 
	`sc¡_»gi¡”_vœtu®_dev_driv”
(
devty³
);

10585 ià(
»s
 < 0)

10586 
out
;

10588 #ifdeà
CONFIG_SCST_PROC


10589 ià(!
devty³
->
no_´oc
) {

10590 
»s
 = 
	`sc¡_dev_hªdËr_bužd_¡d_´oc
(
devty³
);

10591 ià(
»s
 < 0)

10592 
out_uÄeg
;

10594 
»s
 = 
	`vdisk_´oc_h–p_bužd
(
devty³
);

10595 ià(
»s
 < 0)

10596 
out_de¡roy_´oc
;

10600 
out
:

10601 
	`TRACE_EXIT_RES
(
»s
);

10602  
»s
;

10604 #ifdeà
CONFIG_SCST_PROC


10605 
out_de¡roy_´oc
:

10606 ià(!
devty³
->
no_´oc
)

10607 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(
devty³
);

10609 
out_uÄeg
:

10610 
	`sc¡_uÄegi¡”_vœtu®_dev_driv”
(
devty³
);

10611 
out
;

10613 
	}
}

10615 
	$ex™_sc¡_vdisk
(
sc¡_dev_ty³
 *
devty³
)

10617 
	`TRACE_ENTRY
();

10619 
	`mu‹x_lock
(&
sc¡_vdisk_mu‹x
);

10621 
sc¡_vdisk_dev
 *
vœt_dev
;

10623 ià(
	`li¡_em±y
(&
vdev_li¡
))

10626 
vœt_dev
 = 
	`li¡_fœ¡_’Œy
(&
vdev_li¡
, 
	`ty³of
(*virt_dev),

10627 
vdev_li¡_’Œy
);

10629 
	`vdev_d–_deviû
(
vœt_dev
);

10631 
	`mu‹x_uÆock
(&
sc¡_vdisk_mu‹x
);

10633 #ifdeà
CONFIG_SCST_PROC


10634 ià(!
devty³
->
no_´oc
) {

10635 
	`vdisk_´oc_h–p_de¡roy
(
devty³
);

10636 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(
devty³
);

10640 
	`sc¡_uÄegi¡”_vœtu®_dev_driv”
(
devty³
);

10642 
	`TRACE_EXIT
();

10644 
	}
}

10646 
	$š™_Ýs
(
vdisk_Ý_â
 *
Ýs
, 
couÁ
)

10648 
i
;

10650 
i
 = 0; i < 
couÁ
; i++)

10651 ià(
Ýs
[
i
] =ð
NULL
)

10652 
Ýs
[
i
] = 
vdisk_šv®id_Ýcode
;

10654 
	}
}

10656 
__š™
 
	$vdev_check_mode_·ges_·th
()

10658 
»s
;

10659 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 39)

10660 
Çmeid©a
 
nd
;

10662 
·th
…ath;

10664 
mm_£gm’t_t
 
Þd_fs
 = 
	`g‘_fs
();

10666 
	`TRACE_ENTRY
();

10668 
	`£t_fs
(
KERNEL_DS
);

10670 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 39)

10671 
»s
 = 
	`·th_lookup
(
VDEV_MODE_PAGES_DIR
, 0, &
nd
);

10672 ià(
»s
 == 0)

10673 
	`sc¡_·th_put
(&
nd
);

10675 
»s
 = 
	`k”n_·th
(
VDEV_MODE_PAGES_DIR
, 0, &
·th
);

10676 ià(
»s
 == 0)

10677 
	`·th_put
(&
·th
);

10679 ià(
»s
 != 0) {

10680 
	`PRINT_WARNING
("Unableo find %s (err %d), saved mode…ages "

10682 "Ü„eš¡®ÈSCST", 
VDEV_MODE_PAGES_DIR
, 
»s
);

10683 
vdev_§ved_mode_·ges_’abËd
 = 
çl£
;

10684 
out_£tfs
;

10687 
out_£tfs
:

10688 
	`£t_fs
(
Þd_fs
);

10690 
»s
 = 0;

10692 
	`TRACE_EXIT_RES
(
»s
);

10693  
»s
;

10694 
	}
}

10696 
__š™
 
	$š™_sc¡_vdisk_driv”
()

10698 
»s
;

10700 
	`¥š_lock_š™
(&
vdev_”r_lock
);

10702 
	`š™_Ýs
(
fžeio_Ýs
, 
	`ARRAY_SIZE
(fileio_ops));

10703 
	`š™_Ýs
(
blockio_Ýs
, 
	`ARRAY_SIZE
(blockio_ops));

10704 
	`š™_Ýs
(
nuÎio_Ýs
, 
	`ARRAY_SIZE
(nullio_ops));

10706 
»s
 = 
	`vdev_check_mode_·ges_·th
();

10707 ià(
»s
 != 0)

10708 
out
;

10710 
vdisk_cmd_·¿m_ÿch•
 = 
	`KMEM_CACHE
(
vdisk_cmd_·¿ms
,

10711 
SCST_SLAB_FLAGS
|
SLAB_HWCACHE_ALIGN
);

10712 ià(
vdisk_cmd_·¿m_ÿch•
 =ð
NULL
) {

10713 
»s
 = -
ENOMEM
;

10714 
out
;

10717 
blockio_wÜk_ÿch•
 = 
	`KMEM_CACHE
(
sc¡_blockio_wÜk
,

10718 
SCST_SLAB_FLAGS
|
SLAB_HWCACHE_ALIGN
);

10719 ià(
blockio_wÜk_ÿch•
 =ð
NULL
) {

10720 
»s
 = -
ENOMEM
;

10721 
out_ä“_vdisk_ÿche
;

10724 ià(
num_th»ads
 < 1) {

10725 
	`PRINT_ERROR
("num_threads can‚ot be†esshan 1, use "

10726 "deçuÉ %d", 
DEF_NUM_THREADS
);

10727 
num_th»ads
 = 
DEF_NUM_THREADS
;

10730 
vdisk_fže_devty³
.
th»ads_num
 = 
num_th»ads
;

10731 
vcdrom_devty³
.
th»ads_num
 = 
num_th»ads
;

10733 
»s
 = 
	`š™_sc¡_vdisk
(&
vdisk_fže_devty³
);

10734 ià(
»s
 != 0)

10735 
out_ä“_¦ab
;

10737 
»s
 = 
	`š™_sc¡_vdisk
(&
vdisk_blk_devty³
);

10738 ià(
»s
 != 0)

10739 
out_ä“_vdisk
;

10741 
»s
 = 
	`š™_sc¡_vdisk
(&
vdisk_nuÎ_devty³
);

10742 ià(
»s
 != 0)

10743 
out_ä“_blk
;

10745 
»s
 = 
	`š™_sc¡_vdisk
(&
vcdrom_devty³
);

10746 ià(
»s
 != 0)

10747 
out_ä“_nuÎ
;

10749 
out
:

10750  
»s
;

10752 
out_ä“_nuÎ
:

10753 
	`ex™_sc¡_vdisk
(&
vdisk_nuÎ_devty³
);

10755 
out_ä“_blk
:

10756 
	`ex™_sc¡_vdisk
(&
vdisk_blk_devty³
);

10758 
out_ä“_vdisk
:

10759 
	`ex™_sc¡_vdisk
(&
vdisk_fže_devty³
);

10761 
out_ä“_¦ab
:

10762 
	`kmem_ÿche_de¡roy
(
blockio_wÜk_ÿch•
);

10764 
out_ä“_vdisk_ÿche
:

10765 
	`kmem_ÿche_de¡roy
(
vdisk_cmd_·¿m_ÿch•
);

10766 
out
;

10767 
	}
}

10769 
__ex™
 
	$ex™_sc¡_vdisk_driv”
()

10771 
	`ex™_sc¡_vdisk
(&
vdisk_nuÎ_devty³
);

10772 
	`ex™_sc¡_vdisk
(&
vdisk_blk_devty³
);

10773 
	`ex™_sc¡_vdisk
(&
vdisk_fže_devty³
);

10774 
	`ex™_sc¡_vdisk
(&
vcdrom_devty³
);

10776 
	`kmem_ÿche_de¡roy
(
blockio_wÜk_ÿch•
);

10777 
	`kmem_ÿche_de¡roy
(
vdisk_cmd_·¿m_ÿch•
);

10778 
	}
}

10780 
moduË_š™
(
š™_sc¡_vdisk_driv”
);

10781 
moduË_ex™
(
ex™_sc¡_vdisk_driv”
);

10783 
MODULE_AUTHOR
("Vladislav Bolkhovitin & Leonid Stoljar");

10784 
MODULE_LICENSE
("GPL");

10785 
MODULE_DESCRIPTION
("SCSI disk (type 0)‡nd CDROM (type 5) dev handler for "

10787 
MODULE_VERSION
(
SCST_VERSION_STRING
);

	@scst/src/scst_copy_mgr.c

6 
	~<lšux/k”Ãl.h
>

7 
	~<lšux/”ºo.h
>

8 
	~<lšux/ty³s.h
>

9 
	~<lšux/š™.h
>

10 
	~<lšux/¦ab.h
>

11 
	~<asm/uÇligÃd.h
>

12 
	~<lšux/d–ay.h
>

14 #ifdeà
INSIDE_KERNEL_TREE


15 
	~<sc¡/sc¡.h
>

17 
	~"sc¡.h
"

19 
	~"sc¡_´iv.h
"

20 
	~"sc¡_´es.h
"

22 #ifdeà
CONFIG_SCST_PROC


23 #w¬nšg 
In
 
the
 
PROCFS
 
bužd
 
EXTENDED
 
COPY
 
nÙ
 
suµÜ‹d


26 
	#SCST_CM_NAME
 "cÝy_mªag”"

	)

27 
	#SCST_CM_TGT_NAME
 (
SCST_CM_NAME
 "_tgt")

	)

28 
	#SCST_CM_SESS_NAME
 (
SCST_CM_NAME
 "_£ss")

	)

30 
	#SCST_CM_TID_SIZE
 24

	)

31 
	#SCST_CM_TID_ID
 "COPY_MGR"

	)

33 
	#SCST_CM_RETRIES_WAIT
 
HZ


	)

34 
	#SCST_CM_MAX_RETRIES_TIME
 (30*
HZ
)

	)

35 
	#SCST_CM_ID_KEEP_TIME
 (5*
HZ
)

	)

37 
	#SCST_CM_MAX_EACH_IO_SIZE
 (512*1024)

	)

40 
	#SCST_CM_MAX_TGT_DESCR_CNT
 5

	)

42 
	#SCST_CM_MAX_SEG_DESCR_CNT
 \

43 (((
PAGE_SIZE
 * 2è- (
sc¡_cm_ec_cmd_´iv
)) / \

44 (
sc¡_ext_cÝy_£g_desü
))

	)

47 
	#SCST_MAX_SEG_DESC_LEN
 0xFFFF

	)

49 
sc¡_tgt
 *
	gsc¡_cm_tgt
;

50 
sc¡_£ssiÚ
 *
	gsc¡_cm_£ss
;

53 
	gsc¡_cm_Ãxt_lun
;

55 
DEFINE_MUTEX
(
sc¡_cm_mu‹x
);

58 
LIST_HEAD
(
sc¡_cm_desig_li¡
);

60 
	ssc¡_cm_desig
 {

61 
li¡_h—d
 
	mcm_desig_li¡_’Œy
;

63 
sc¡_tgt_dev
 *
	mdesig_tgt_dev
;

65 
	mdesig_Ën
;

66 
ušt8_t
 
	mdesig
[];

70 
¥šlock_t
 
	gsc¡_cm_lock
;

73 
	ssc¡_cm_li¡_id
 {

74 
li¡_h—d
 
	m£ss_cm_li¡_id_’Œy
;

76 
	mcm_lid
;

78 
	#SCST_CM_LIST_ID_STATE_ACTIVE
 0

	)

79 
	#SCST_CM_LIST_ID_STATE_DONE
 1

	)

80 
	#SCST_CM_LIST_ID_STATE_PENDING_FREE
 2

	)

81 
	mcm_li¡_id_¡©e
;

83 
	mcm_dÚe
:1;

84 
	mcm_ÿn_be_immed_ä“
:1;

86 
	mcm_£gs_´oûs£d
;

87 
št64_t
 
	mcm_wr™‹n_size
;

89 
	mcm_time_to_ä“
;

91 
	mcm_¡©us
;

92 
	mcm_£n£_Ën
;

93 
ušt8_t
 
	mcm_£n£
[
SCST_SENSE_BUFFERSIZE
];

96 
	ssc¡_cm_š‹º®_cmd_´iv
 {

98 
sc¡_i_fšish_â_t
 
	mcm_fšish_â
;

101 
sc¡_cmd
 *
	mcm_cmd
;

104 
sc¡_cmd
 *
	mcm_Üig_cmd
;

106 
li¡_h—d
 
	mcm_š‹º®_cmd_li¡_’Œy
;

109 
	ssc¡_cm_dev_’Œy
 {

110 
li¡_h—d
 
	mcm_sÜ‹d_devs_li¡_’Œy
;

111 
sc¡_cmd
 *
	mcm_fcmd
;

118 
	ssc¡_cm_ec_cmd_´iv
 {

119 
sc¡_cm_li¡_id
 *
	mcm_li¡_id
;

125 
li¡_h—d
 
	mcm_sÜ‹d_devs_li¡
;

131 
li¡_h—d
 
	mcm_š‹º®_cmd_li¡
;

133 
	#SCST_CM_ERROR_NONE
 0

	)

134 
	#SCST_CM_ERROR_READ
 1

	)

135 
	#SCST_CM_ERROR_WRITE
 2

	)

136 
	mcm_”rÜ
;

138 
mu‹x
 
	mcm_mu‹x
;

140 
	mcm_cur_š_æight
;

145 
sc¡_tgt_dev
 *
	mcm_»ad_tgt_dev
;

146 
št64_t
 
	mcm_¡¬t_»ad_lba
;

147 
št64_t
 
	mcm_cur_»ad_lba
;

148 
	mcm_Ëá_to_»ad
;

149 
	mcm_max_—ch_»ad
;

154 
sc¡_tgt_dev
 *
	mcm_wr™e_tgt_dev
;

155 
št64_t
 
	mcm_¡¬t_wr™e_lba
;

156 
št64_t
 
	mcm_wr™‹n
;

161 cÚ¡ 
sc¡_ext_cÝy_d©a_desü
 *
	mcm_d©a_desüs
;

162 
	mcm_d©a_desüs_út
;

163 
	mcm_cur_d©a_desü
;

165 
	mcm_cur_£g_desü
;

171 
sc¡_ext_cÝy_£g_desü
 
	mcm_£g_desüs
[];

174 
	#SCST_ALLOW_NOT_CONN_COPY_DEF
 0

	)

176 
boÞ
 
	gsc¡_cm_®low_nÙ_cÚÃùed_cÝy
 = 
SCST_ALLOW_NOT_CONN_COPY_DEF
;

178 
	#SCST_CM_STATUS_CMD_SUCCEEDED
 0

	)

179 
	#SCST_CM_STATUS_RETRY
 1

	)

180 
	#SCST_CM_STATUS_CMD_FAILED
 -1

	)

182 (*
	tsc¡_cm_»Œy_â_t
)(
	tsc¡_cmd
 *
	tcmd
);

184 
	ssc¡_cm_»Œy
 {

185 
sc¡_cmd
 *
cm_»Œy_cmd
;

186 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 20)

187 
wÜk_¡ruù
 
cm_»Œy_wÜk
;

189 
d–ayed_wÜk
 
cm_»Œy_wÜk
;

191 
sc¡_cm_»Œy_â_t
 
cm_»Œy_â
;

194 
	$sc¡_cm_»Œy_wÜk_â
(
wÜk_¡ruù
 *
wÜk
)

196 
sc¡_cm_»Œy
 *
»Œy
 = 
	`cÚš”_of
(
wÜk
, scst_cm_retry,

197 
cm_»Œy_wÜk
.
wÜk
);

199 
	`TRACE_ENTRY
();

201 
	`TRACE_DBG
("R‘ryšg cmd %p", 
»Œy
->
cm_»Œy_cmd
);

203 
»Œy
->
	`cm_»Œy_â
Ô‘ry->
cm_»Œy_cmd
);

205 
	`__sc¡_cmd_put
(
»Œy
->
cm_»Œy_cmd
);

207 
	`kä“
(
»Œy
);

209 
	`TRACE_EXIT
();

211 
	}
}

217 
	$sc¡_cm_”r_check_»Œy
(
sc¡_cmd
 *
cmd
,

218 
¡¬t_time
, 
sc¡_cm_»Œy_â_t
 
»Œy_â
)

220 
»s
 = 
SCST_CM_STATUS_CMD_SUCCEEDED
;

221 
cur_time
, 
max_»Œy_time
, 
Ãxt_»Œy_time
;

222 
sc¡_cm_»Œy
 *
»Œy
;

223 
boÞ
 
imm_»Œy
 = 
çl£
;

225 
	`TRACE_ENTRY
();

229 
	`TRACE_DBG
("cmd %p, stu %d,‡bÜ‹d %d", 
cmd
, cmd->
¡©us
,

230 
	`sc¡_cmd_abÜ‹d
(
cmd
));

232 ià(
	`lik–y
((
cmd
->
¡©us
 =ð0è&& !
	`sc¡_cmd_abÜ‹d
(cmd)))

233 
out
;

235 
cur_time
 = 
jiff›s
;

236 
max_»Œy_time
 = 
¡¬t_time
 + 
SCST_CM_MAX_RETRIES_TIME
;

238 
	`mu‹x_lock
(&
sc¡_cm_mu‹x
);

240 ià(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
)) {

241 ià(
	`‹¡_b™
(
SCST_CMD_ABORTED_OTHER
, &
cmd
->
cmd_æags
)) {

242 
	`TRACE_MGMT_DBG
("Cmd %p‡borted by other initiator, "

243 "»Œy…ossibË", 
cmd
);

244 
Œy_»Œy
;

246 
	`TRACE_MGMT_DBG
("Cmd %°abÜ‹d,‚Ø»Œy ", 
cmd
);

247 
out_”r_uÆock
;

251 ià((
cmd
->
¡©us
 =ð
SAM_STAT_BUSY
) ||

252 (
cmd
->
¡©us
 =ð
SAM_STAT_TASK_SET_FULL
) ||

253 (
cmd
->
¡©us
 =ð
SAM_STAT_RESERVATION_CONFLICT
) ||

254 (
cmd
->
¡©us
 =ð
SAM_STAT_ACA_ACTIVE
)) {

255 
	`TRACE_DBG
("Cmd %p finished with status %d,„etry…ossible",

256 
cmd
, cmd->
¡©us
);

257 
Œy_»Œy
;

260 ià((
cmd
->
¡©us
 =ð
SAM_STAT_CHECK_CONDITION
) &&

261 
	`sc¡_£n£_v®id
(
cmd
->
£n£
) &&

262 
	`sc¡_ª®yze_£n£
(
cmd
->
£n£
, cmd->
£n£_v®id_Ën
,

263 
SCST_SENSE_KEY_VALID
, 
UNIT_ATTENTION
, 0, 0)) {

264 
	`TRACE_DBG
("Cmd %p finished with UA, immediate„etry "

265 "possibË", 
cmd
);

266 
imm_»Œy
 = 
Œue
;

267 
Œy_»Œy
;

270 
out_”r_uÆock
:

271 
	`mu‹x_uÆock
(&
sc¡_cm_mu‹x
);

273 
out_çžed
:

274 
»s
 = 
SCST_CM_STATUS_CMD_FAILED
;

276 
out
:

277 
	`TRACE_EXIT_RES
(
»s
);

278  
»s
;

280 
Œy_»Œy
:

281 ià(
	`time_aá”_eq
(
cur_time
, 
max_»Œy_time
))

282 
out_”r_uÆock
;

284 
Ãxt_»Œy_time
 = 
cur_time
 + 
SCST_CM_RETRIES_WAIT
;

286 
	`TRACE_DBG
("Retrying cmd %p (imm_retry %d,‚ext_retry_time %ld, "

288 "tØ¦“p", 
cmd
, 
imm_»Œy
, 
Ãxt_»Œy_time
, 
cur_time
,

289 
¡¬t_time
, 
max_»Œy_time
);

291 
	`mu‹x_uÆock
(&
sc¡_cm_mu‹x
);

293 ià(
»Œy_â
 =ð
NULL
)

294 
out_»Œy_dÚe
;

298 
»Œy
 = 
	`kz®loc
((*»Œy), 
GFP_KERNEL
);

299 ià(
»Œy
 =ð
NULL
) {

300 
	`PRINT_ERROR
("Unableo‡llocate„etry struct");

301 
	`sc¡_£t_busy
(
cmd
);

302 
out_çžed
;

304 
»Œy
->
cm_»Œy_cmd
 = 
cmd
;

305 
	`__sc¡_cmd_g‘
(
cmd
);

306 
	`INIT_DELAYED_WORK
(&
»Œy
->
cm_»Œy_wÜk
, 
sc¡_cm_»Œy_wÜk_â
);

307 
»Œy
->
cm_»Œy_â
 = 
»Œy_â
;

309 ià(
imm_»Œy
) {

311 
	`TRACE_DBG
("ImmedŸ‹„‘ry (cmd %p)", 
cmd
);

312 
	`scheduË_wÜk
(&
»Œy
->
cm_»Œy_wÜk
.
wÜk
);

314 
	`TRACE_DBG
("Schedulšg cmd %°»Œy", 
cmd
);

315 
	`scheduË_d–ayed_wÜk
(&
»Œy
->
cm_»Œy_wÜk
,

316 
Ãxt_»Œy_time
 - 
cur_time
);

319 
out_»Œy_dÚe
:

320 
»s
 = 
SCST_CM_STATUS_RETRY
;

321 
out
;

322 
	}
}

324 
boÞ
 
	$sc¡_cm_is_ec_cmd_dÚe
(
sc¡_cmd
 *
ec_cmd
)

326 
boÞ
 
»s
;

328 
	`TRACE_ENTRY
();

330 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
ec_cmd
->
cmd_æags
))) {

331 
	`TRACE_MGMT_DBG
("EC cmd %°abÜ‹d", 
ec_cmd
);

332 
»s
 = 
Œue
;

333 } ià(
	`uÆik–y
(
ec_cmd
->
com¶‘ed
)) {

334 
	`TRACE_MGMT_DBG
("EC cmd %p‡lready completed with status (%d)",

335 
ec_cmd
,ƒc_cmd->
¡©us
);

336 
»s
 = 
Œue
;

338 
»s
 = 
çl£
;

340 
	`TRACE_EXIT_RES
(
»s
);

341  
»s
;

342 
	}
}

351 
	$sc¡_cm_£tup_this_d©a_desü
(
sc¡_cmd
 *
ec_cmd
)

353 
»s
;

354 
sc¡_cm_ec_cmd_´iv
 *
´iv
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

355 
sc¡_ext_cÝy_£g_desü
 *
sd
;

356 cÚ¡ 
sc¡_ext_cÝy_d©a_desü
 *
dd
;

358 
	`TRACE_ENTRY
();

360 
	`TRACE_DBG
("ec_cmd %p, cm_cur_d©a_desü %d", 
ec_cmd
,

361 
´iv
->
cm_cur_d©a_desü
);

363 
	`EXTRACHECKS_BUG_ON
(
´iv
->
cm_cur_d©a_desü
 >…riv->
cm_d©a_desüs_út
);

365 ià(
´iv
->
cm_cur_d©a_desü
 =ð´iv->
cm_d©a_desüs_út
) {

366 
	`TRACE_DBG
("NØmÜd©¨desütÜ fÜƒc_cmd %p", 
ec_cmd
);

367 
»s
 = -
ENOENT
;

368 
out
;

371 
sd
 = &
´iv
->
cm_£g_desüs
[´iv->
cm_cur_£g_desü
];

372 
dd
 = &
´iv
->
cm_d©a_desüs
[´iv->
cm_cur_d©a_desü
];

374 
	`EXTRACHECKS_BUG_ON
(
dd
->
d©a_Ën
 == 0);

376 
´iv
->
cm_»ad_tgt_dev
 = 
sd
->
¤c_tgt_dev
;

377 
´iv
->
cm_¡¬t_»ad_lba
 = 
dd
->
¤c_lba
;

378 
´iv
->
cm_cur_»ad_lba
 = 
dd
->
¤c_lba
;

379 
´iv
->
cm_Ëá_to_»ad
 = 
dd
->
d©a_Ën
 >> 
sd
->
¤c_tgt_dev
->
dev
->
block_shiá
;

380 
´iv
->
cm_max_—ch_»ad
 = 
SCST_CM_MAX_EACH_IO_SIZE
 >> 
sd
->
¤c_tgt_dev
->
dev
->
block_shiá
;

382 
´iv
->
cm_wr™e_tgt_dev
 = 
sd
->
d¡_tgt_dev
;

383 
´iv
->
cm_¡¬t_wr™e_lba
 = 
dd
->
d¡_lba
;

385 
	`TRACE_DBG
("ËÀ%d, src_lb¨%Îd, d¡_lb¨%Îd", 
dd
->
d©a_Ën
,

386 ()
dd
->
¤c_lba
, ()dd->
d¡_lba
);

388 ià(
	`uÆik–y
((
dd
->
d©a_Ën
 & (
sd
->
¤c_tgt_dev
->
dev
->
block_size
-1)) != 0) ||

389 
	`uÆik–y
((
dd
->
d©a_Ën
 & (
sd
->
d¡_tgt_dev
->
dev
->
block_size
-1)) != 0)) {

390 
	`PRINT_ERROR
("Data†en %d is‚otƒven for block size (src block "

391 "siz%d, d¡ block siz%d)", 
dd
->
d©a_Ën
,

392 
sd
->
¤c_tgt_dev
->
dev
->
block_size
,

393 
sd
->
d¡_tgt_dev
->
dev
->
block_size
);

394 
	`sc¡_£t_cmd_”rÜ
(
ec_cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

395 
»s
 = -
EINVAL
;

396 
out
;

399 
»s
 = 0;

401 
out
:

402 
	`TRACE_EXIT_RES
(
»s
);

403  
»s
;

404 
	}
}

413 
	$sc¡_cm_£tup_Ãxt_d©a_desü
(
sc¡_cmd
 *
ec_cmd
)

415 
»s
;

416 
sc¡_cm_ec_cmd_´iv
 *
´iv
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

418 
	`TRACE_ENTRY
();

420 
	`TRACE_DBG
("ec_cmd %p", 
ec_cmd
);

422 
´iv
->
cm_cur_d©a_desü
++;

424 
»s
 = 
	`sc¡_cm_£tup_this_d©a_desü
(
ec_cmd
);

426 
	`TRACE_EXIT_RES
(
»s
);

427  
»s
;

428 
	}
}

437 
	$sc¡_cm_£tup_fœ¡_d©a_desü
(
sc¡_cmd
 *
ec_cmd
)

439 
»s
;

440 
sc¡_cm_ec_cmd_´iv
 *
´iv
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

442 
	`TRACE_ENTRY
();

444 
	`TRACE_DBG
("ec_cmd %p", 
ec_cmd
);

446 
´iv
->
cm_cur_d©a_desü
 = 0;

448 
»s
 = 
	`sc¡_cm_£tup_this_d©a_desü
(
ec_cmd
);

450 
	`TRACE_EXIT_RES
(
»s
);

451  
»s
;

452 
	}
}

454 
	$sc¡_cm_de¡roy_d©a_desüs
(
sc¡_cmd
 *
ec_cmd
)

456 
sc¡_cm_ec_cmd_´iv
 *
´iv
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

458 
	`TRACE_ENTRY
();

460 
	`TRACE_DBG
("ec_cmd %p, d©a_desü %p, d©a_desüs_úˆ%d ", 
ec_cmd
,

461 
´iv
->
cm_d©a_desüs
,…riv->
cm_d©a_desüs_út
);

463 ià(
´iv
->
cm_d©a_desüs
 !ð&´iv->
cm_£g_desüs
[´iv->
cm_cur_£g_desü
].
d©a_desü
) {

464 
	`TRACE_DBG_FLAG
(
TRACE_DEBUG
|
TRACE_MEMORY
, "Freeing "

465 "d©a_desü %p", 
´iv
->
cm_d©a_desüs
);

466 
	`kä“
(
´iv
->
cm_d©a_desüs
);

469 
´iv
->
cm_d©a_desüs
 = 
NULL
;

470 
´iv
->
cm_d©a_desüs_út
 = 0;

472 
	`TRACE_EXIT
();

474 
	}
}

483 
	$sc¡_cm_£tup_d©a_desüs
(
sc¡_cmd
 *
ec_cmd
,

484 cÚ¡ 
sc¡_ext_cÝy_d©a_desü
 *
dds
, 
dds_út
)

486 
»s
;

487 
sc¡_cm_ec_cmd_´iv
 *
´iv
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

489 
	`TRACE_ENTRY
();

491 
	`TRACE_DBG
("ec_cmd %p, dd %p, dds_úˆ%d", 
ec_cmd
, 
dds
, 
dds_út
);

493 
	`EXTRACHECKS_BUG_ON
(
dds_út
 == 0);

495 
´iv
->
cm_d©a_desüs
 = 
dds
;

496 
´iv
->
cm_d©a_desüs_út
 = 
dds_út
;

498 
»s
 = 
	`sc¡_cm_£tup_fœ¡_d©a_desü
(
ec_cmd
);

499 ià(
	`uÆik–y
(
»s
 != 0))

500 
out_de¡r
;

502 
out
:

503 
	`TRACE_EXIT_RES
(
»s
);

504  
»s
;

506 
out_de¡r
:

507 
	`sc¡_cm_de¡roy_d©a_desüs
(
ec_cmd
);

508 
out
;

509 
	}
}

518 
	$sc¡_cm_£tup_£g_desü
(
sc¡_cmd
 *
ec_cmd
)

520 
»s
;

521 
sc¡_cm_ec_cmd_´iv
 *
´iv
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

522 
sc¡_ext_cÝy_£g_desü
 *
sd
;

524 
	`TRACE_ENTRY
();

526 
	`TRACE_DBG
("ec_cmd %p, cm_cur_£g_desü %d", 
ec_cmd
,

527 
´iv
->
cm_cur_£g_desü
);

529 
	`EXTRACHECKS_BUG_ON
(
´iv
->
cm_cur_£g_desü
 > 
ec_cmd
->
cmd_d©a_desütÜs_út
);

532 ià(
´iv
->
cm_cur_£g_desü
 =ð
ec_cmd
->
cmd_d©a_desütÜs_út
)

533 
out_’ÛÁ
;

535 
sd
 = &
´iv
->
cm_£g_desüs
[´iv->
cm_cur_£g_desü
];

536 
	`EXTRACHECKS_BUG_ON
(
sd
->
ty³
 !ð
SCST_EXT_COPY_SEG_DATA
);

537 ià(
sd
->
d©a_desü
.
d©a_Ën
 != 0)

540 
´iv
->
cm_cur_£g_desü
++;

541 
	`TRACE_DBG
("ec_cmd %p, cm_cur_£g_desü %d", 
ec_cmd
,

542 
´iv
->
cm_cur_£g_desü
);

545 ià(
´iv
->
cm_li¡_id
 !ð
NULL
) {

547 
´iv
->
cm_li¡_id
->
cm_£gs_´oûs£d
 =…riv->
cm_cur_£g_desü
 + 1;

550 
»s
 = 0;

552 
out
:

553 
	`TRACE_EXIT_RES
(
»s
);

554  
»s
;

556 
out_’ÛÁ
:

557 
	`TRACE_DBG
("ec_cmd %°fšished", 
ec_cmd
);

558 
»s
 = -
ENOENT
;

559 
out
;

560 
	}
}

563 
	$sc¡_cm_advªû_£g_desü
(
sc¡_cmd
 *
ec_cmd
)

565 
sc¡_cm_ec_cmd_´iv
 *
´iv
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

567 
	`TRACE_ENTRY
();

569 
	`TRACE_DBG
("ec_cmd %p", 
ec_cmd
);

571 
	`EXTRACHECKS_BUG_ON
(
´iv
->
cm_cur_š_æight
 != 0);

573 
	`sc¡_cm_de¡roy_d©a_desüs
(
ec_cmd
);

575 
´iv
->
cm_cur_£g_desü
++;

577 
	`TRACE_EXIT
();

579 
	}
}

581 
	$sc¡_cm_´•¬e_fš®_£n£
(
sc¡_cmd
 *
ec_cmd
)

583 
sc¡_cm_ec_cmd_´iv
 *
´iv
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

584 
ušt8_t
 *
f£n£
 = 
NULL
;

585 
d_£n£
 = 
	`sc¡_g‘_cmd_dev_d_£n£
(
ec_cmd
);

586 
boÞ
 
cÝy_£n£
 = 
çl£
;

587 
£n£_to_cÝy
 = 
ec_cmd
->
£n£_v®id_Ën
;

588 
£n£_Ën
 = 
ec_cmd
->
£n£_v®id_Ën
;

590 
	`TRACE_ENTRY
();

592 ià(
	`lik–y
(
´iv
->
cm_”rÜ
 =ð
SCST_CM_ERROR_NONE
))

593 
out
;

595 
	`TRACE_DBG
("ec_cmd %p, cm_”rÜ %d, s’£_to_cÝy %d", 
ec_cmd
,

596 
´iv
->
cm_”rÜ
, 
£n£_to_cÝy
);

598 ià(
£n£_to_cÝy
 > (
SCST_SENSE_BUFFERSIZE
 - 18)) {

599 
	`PRINT_WARNING
("Too small sense buffer, %d bytes will be "

601 
£n£_to_cÝy
 - (
SCST_SENSE_BUFFERSIZE
-18), 
ec_cmd
);

602 
£n£_to_cÝy
 = 
SCST_SENSE_BUFFERSIZE
 - 18;

605 ià((
´iv
->
cm_”rÜ
 =ð
SCST_CM_ERROR_WRITE
) &&

606 (
ec_cmd
->
¡©us
 !ð
SAM_STAT_CHECK_CONDITION
)) {

607 
rc
;

608 
sc¡_ext_cÝy_£g_desü
 *
sd
 = &
´iv
->
cm_£g_desüs
[´iv->
cm_cur_£g_desü
];

612 
rc
 = 
	`sc¡_®loc_£n£
(
ec_cmd
, 0);

613 ià(
rc
 != 0)

614 
out
;

616 
	`TRACE_DBG
("d_sense %d, cm_cur_seg_descr %d, cur_data_descr %d, "

617 "tgt_desü_off %d", 
d_£n£
, 
´iv
->
cm_cur_£g_desü
,

618 
´iv
->
cm_cur_d©a_desü
, 
sd
->
tgt_desü_offs
);

620 ià(
d_£n£
) {

622 
ec_cmd
->
£n£
[0] = 0x72;

623 
ec_cmd
->
£n£
[1] = 
COPY_ABORTED
;

624 
ec_cmd
->
£n£
[2] = 0xD;

625 
ec_cmd
->
£n£
[3] = 1;

626 
ec_cmd
->
£n£
[7] = 20;

628 
ec_cmd
->
£n£
[8] = 1;

629 
ec_cmd
->
£n£
[9] = 0xA;

630 
	`put_uÇligÃd_be16
(
´iv
->
cm_cur_£g_desü
, &
ec_cmd
->
£n£
[14]);

632 
ec_cmd
->
£n£
[20] = 2;

633 
ec_cmd
->
£n£
[21] = 6;

634 
ec_cmd
->
£n£
[24] = 0x80;

635 
	`put_uÇligÃd_be16
(
sd
->
tgt_desü_offs
, &
ec_cmd
->
£n£
[25]);

637 
ec_cmd
->
£n£_v®id_Ën
 = 16;

640 
ec_cmd
->
£n£
[0] = 0x70;

641 
ec_cmd
->
£n£
[2] = 
COPY_ABORTED
;

642 
ec_cmd
->
£n£
[7] = 0x0a;

643 
ec_cmd
->
£n£
[12] = 0xD;

644 
ec_cmd
->
£n£
[13] = 1;

646 
	`put_uÇligÃd_be16
(
´iv
->
cm_cur_£g_desü
, &
ec_cmd
->
£n£
[10]);

648 
ec_cmd
->
£n£
[15] = 0x80;

649 
	`put_uÇligÃd_be16
(
sd
->
tgt_desü_offs
, &
ec_cmd
->
£n£
[16]);

651 
ec_cmd
->
£n£_v®id_Ën
 = 18;

654 
ec_cmd
->
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

655 
out
;

658 
f£n£
 = 
	`mempoÞ_®loc
(
sc¡_£n£_mempoÞ
, 
GFP_KERNEL
);

659 ià(
f£n£
 =ð
NULL
) {

660 
	`PRINT_ERROR
("Allocation ofhe intermediate Extended Copy "

662 "šcÜ»ù (ec_cmd %p)", 
ec_cmd
);

663 
out
;

665 
	`mem£t
(
f£n£
, 0, 
SCST_SENSE_BUFFERSIZE
);

667 ià(
d_£n£
) {

669 
f£n£
[0] = 0x72;

670 
f£n£
[1] = 
COPY_ABORTED
;

671 
f£n£
[7] = 12;

673 
f£n£
[8] = 1;

674 
f£n£
[9] = 0xA;

675 
	`put_uÇligÃd_be16
(
´iv
->
cm_cur_£g_desü
, &
f£n£
[14]);

677 
£n£_Ën
 = 20;

680 
f£n£
[0] = 0x70;

681 
f£n£
[2] = 
COPY_ABORTED
;

682 
f£n£
[7] = 0x0a;

684 
	`put_uÇligÃd_be16
(
´iv
->
cm_cur_£g_desü
, &
f£n£
[10]);

686 ià(
´iv
->
cm_”rÜ
 =ð
SCST_CM_ERROR_READ
) {

687 
f£n£
[8] = 18;

688 
cÝy_£n£
 = 
	`sc¡_£n£_v®id
(
ec_cmd
->
£n£
);

689 } ià(
´iv
->
cm_”rÜ
 =ð
SCST_CM_ERROR_WRITE
) {

690 
f£n£
[9] = 18;

691 
cÝy_£n£
 = 
	`sc¡_£n£_v®id
(
ec_cmd
->
£n£
);

693 
	`sBUG
();

695 ià(
cÝy_£n£
) {

696 
	`TRACE_DBG
("CÝyšg %db oàÞd s’£", 
£n£_to_cÝy
);

697 
f£n£
[7] +ð1 + 
£n£_to_cÝy
;

698 
f£n£
[17] = 
ec_cmd
->
¡©us
;

699 
	`memýy
(&
f£n£
[18], 
ec_cmd
->
£n£
, 
£n£_to_cÝy
);

702 
£n£_Ën
 = 
f£n£
[7] + 8;

703 
	`TRACE_DBG
("New s’£†’ %d", 
£n£_Ën
);

706 
ec_cmd
->
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

707 ià(
ec_cmd
->
£n£
 !ð
NULL
) {

708 
	`memýy
(
ec_cmd
->
£n£
, 
f£n£
, 
£n£_Ën
);

709 
ec_cmd
->
£n£_v®id_Ën
 = 
£n£_Ën
;

711 
	`sc¡_®loc_£t_£n£
(
ec_cmd
, 0, 
f£n£
, 
£n£_Ën
);

713 
	`mempoÞ_ä“
(
f£n£
, 
sc¡_£n£_mempoÞ
);

715 
out
:

716 
	`TRACE_EXIT
();

718 
	}
}

720 
	$sc¡_cm_¡Üe_li¡_id_d‘ažs
(
sc¡_cmd
 *
ec_cmd
)

722 
sc¡_cm_ec_cmd_´iv
 *
´iv
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

723 
sc¡_cm_li¡_id
 *
l
 = 
´iv
->
cm_li¡_id
;

725 
	`TRACE_ENTRY
();

727 ià(
l
 !ð
NULL
) {

728 
	`TRACE_DBG
("List id %p done (status %d, sense valid %d, sense "

729 "ËÀ%d)", 
l
, 
ec_cmd
->
¡©us
, 
	`sc¡_£n£_v®id
Óc_cmd->
£n£
),

730 
ec_cmd
->
£n£_v®id_Ën
);

731 
	`¥š_lock_œq
(&
sc¡_cm_lock
);

732 
l
->
cm_li¡_id_¡©e
 = 
SCST_CM_LIST_ID_STATE_DONE
;

733 ià(
ec_cmd
->
¡©us
 != 0) {

734 
l
->
cm_¡©us
 = 
ec_cmd
->
¡©us
;

735 ià(
	`sc¡_£n£_v®id
(
ec_cmd
->
£n£
)) {

736 
Ën
 = 
ec_cmd
->
£n£_v®id_Ën
;

738 ià(
Ën
 > (
l
->
cm_£n£
)) {

739 
	`PRINT_WARNING
("EC command's sense is "

741 "%d,runÿtšg", 
Ën
,

742 ()(
l
->
cm_£n£
));

743 
Ën
 = (
l
->
cm_£n£
);

745 
l
->
cm_£n£_Ën
 = 
ec_cmd
->
£n£_v®id_Ën
;

746 
	`memýy
(
l
->
cm_£n£
, 
ec_cmd
->
£n£
, 
Ën
);

749 
	`¥š_uÆock_œq
(&
sc¡_cm_lock
);

752 
	`TRACE_EXIT
();

754 
	}
}

756 
	$sc¡_cm_ec_cmd_dÚe
(
sc¡_cmd
 *
ec_cmd
)

758 #ifdeà
CONFIG_SCST_EXTRACHECKS


759 
sc¡_cm_ec_cmd_´iv
 *
´iv
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

762 
	`TRACE_ENTRY
();

764 
	`TRACE_DBG
("ec_cmd %°fšished w™h stu %d", 
ec_cmd
,ƒc_cmd->
¡©us
);

766 
	`EXTRACHECKS_BUG_ON
(
´iv
->
cm_cur_š_æight
 != 0);

767 
	`EXTRACHECKS_BUG_ON
(
´iv
->
cm_d©a_desüs
 !ð
NULL
);

769 
	`sc¡_cm_´•¬e_fš®_£n£
(
ec_cmd
);

770 
	`sc¡_cm_¡Üe_li¡_id_d‘ažs
(
ec_cmd
);

772 
ec_cmd
->
com¶‘ed
 = 1;

773 
ec_cmd
->
	`sc¡_cmd_dÚe
Óc_cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_THREAD
);

775 
	`TRACE_EXIT
();

777 
	}
}

779 
	$sc¡_cm_ec_sched_Ãxt_£g
(
sc¡_cmd
 *
ec_cmd
)

781 
	`TRACE_ENTRY
();

785 
	`sc¡_cm_advªû_£g_desü
(
ec_cmd
);

791 
	`sc¡_cm_ext_cÝy_exec
(
ec_cmd
);

793 
	`TRACE_EXIT
();

795 
	}
}

797 
	$sc¡_cm_š_æight_cmd_fšished
(
sc¡_cmd
 *
ec_cmd
)

799 
sc¡_cm_ec_cmd_´iv
 *
´iv
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

800 
f
;

802 
	`TRACE_ENTRY
();

804 
	`mu‹x_lock
(&
´iv
->
cm_mu‹x
);

806 
´iv
->
cm_cur_š_æight
--;

807 
f
 = 
´iv
->
cm_cur_š_æight
;

809 
	`mu‹x_uÆock
(&
´iv
->
cm_mu‹x
);

811 
	`TRACE_DBG
("ec_cmd %p,…riv->cm_cur_š_æighˆ%d", 
ec_cmd
, 
f
);

813 ià(
f
 > 0)

814 
out
;

816 ià(
´iv
->
cm_li¡_id
 !ð
NULL
)

817 
´iv
->
cm_li¡_id
->
cm_wr™‹n_size
 +ð´iv->
cm_wr™‹n
;

819 
	`sc¡_cm_ec_sched_Ãxt_£g
(
ec_cmd
);

821 
out
:

822 
	`TRACE_EXIT
();

824 
	}
}

826 
	$sc¡_cm_add_to_š‹º®_cmd_li¡
(
sc¡_cmd
 *
cmd
,

827 
sc¡_cmd
 *
ec_cmd
, sc¡_cmd *
Üig_cmd
,

828 
sc¡_i_fšish_â_t
 
fšish_â
)

830 
»s
;

831 
sc¡_cm_ec_cmd_´iv
 *
´iv
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

832 
sc¡_cm_š‹º®_cmd_´iv
 *
p
;

834 
	`TRACE_ENTRY
();

836 
	`EXTRACHECKS_BUG_ON
(
ec_cmd
 =ð
cmd
);

838 
p
 = 
	`kz®loc
((*p), 
GFP_KERNEL
);

839 ià(
p
 =ð
NULL
) {

840 
	`PRINT_ERROR
("Unableo‡lloc scst_cm_internal_cmd_priv "

841 "(siz%d)", ()(*
p
));

842 
out_’omem
;

845 
p
->
cm_fšish_â
 = 
fšish_â
;

846 
p
->
cm_Üig_cmd
 = 
Üig_cmd
;

847 
p
->
cm_cmd
 = 
cmd
;

849 
	`TRACE_DBG
("Adding internal cmd %p (priv %p,ƒc_cmd %p, orig_cmd %p)",

850 
cmd
, 
p
, 
ec_cmd
, 
Üig_cmd
);

851 
	`¥š_lock_œq
(&
sc¡_cm_lock
);

852 
	`li¡_add_ž
(&
p
->
cm_š‹º®_cmd_li¡_’Œy
, &
´iv
->
cm_š‹º®_cmd_li¡
);

853 
	`¥š_uÆock_œq
(&
sc¡_cm_lock
);

855 
cmd
->
tgt_i_´iv
 = 
p
;

857 
»s
 = 0;

859 
out
:

860 
	`TRACE_EXIT_RES
(
»s
);

861  
»s
;

863 
out_’omem
:

864 
	`sc¡_£t_busy
(
ec_cmd
);

865 
»s
 = -
ENOMEM
;

866 
out
;

867 
	}
}

869 
	$sc¡_cm_d–_ä“_äom_š‹º®_cmd_li¡
(
sc¡_cmd
 *
cmd
,

870 
boÞ
 
unblock_dev
)

872 
sc¡_cm_š‹º®_cmd_´iv
 *
p
 = 
cmd
->
tgt_i_´iv
;

874 
	`TRACE_ENTRY
();

876 
	`TRACE_DBG
("Deleting/freeing internal cmd %p (op %s,…riv %p, "

877 "Üig_cmd %p)", 
cmd
, 
	`sc¡_g‘_Ýcode_Çme
(cmd), 
p
,

878 
p
->
cm_Üig_cmd
);

880 
	`¥š_lock_œq
(&
sc¡_cm_lock
);

881 
	`li¡_d–
(&
p
->
cm_š‹º®_cmd_li¡_’Œy
);

882 
	`¥š_uÆock_œq
(&
sc¡_cm_lock
);

884 ià(
unblock_dev
) {

885 
	`TRACE_DBG
("dev %°(š‹º® cmd %p)", 
cmd
->
dev
, cmd);

886 
	`sc¡_check_unblock_dev
(
cmd
);

889 
cmd
->
tgt_i_´iv
 = 
NULL
;

891 
	`kä“
(
p
);

893 
	`TRACE_EXIT
();

895 
	}
}

897 
sc¡_cm_»ad_cmd_fšished
(
sc¡_cmd
 *
rcmd
);

900 
	$__sc¡_cm_push_sšgË_»ad
(
sc¡_cmd
 *
ec_cmd
,

901 
št64_t
 
lba
, 
blocks
)

903 
»s
;

904 
sc¡_cm_ec_cmd_´iv
 *
´iv
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

905 
ušt8_t
 
»ad_cdb
[32];

906 
sc¡_deviû
 *
rdev
 = 
´iv
->
cm_»ad_tgt_dev
->
dev
;

907 
block_shiá
 = 
rdev
->block_shift;

908 
Ën
 = 
blocks
 << 
block_shiá
;

909 
sc¡_cmd
 *
rcmd
;

910 
cdb_Ën
;

911 
boÞ
 
check_dif
 = (
rdev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV
);

913 
	`TRACE_ENTRY
();

915 ià(
	`uÆik–y
(
	`sc¡_cm_is_ec_cmd_dÚe
(
ec_cmd
))) {

916 
	`TRACE_MGMT_DBG
("EC cmd %p done:‡borting further„ead "

917 "commªds", 
ec_cmd
);

918 
´iv
->
cm_Ëá_to_»ad
 = 0;

919 
»s
 = -
EPIPE
;

920 
out
;

923 
	`mem£t
(
»ad_cdb
, 0, (read_cdb));

924 ià(
rdev
->
dev_dif_ty³
 !ð2 || !
check_dif
) {

925 
»ad_cdb
[0] = 
READ_16
;

926 ià(
check_dif
)

927 
»ad_cdb
[1] |= 0x20;

928 
	`put_uÇligÃd_be64
(
lba
, &
»ad_cdb
[2]);

929 
	`put_uÇligÃd_be32
(
blocks
, &
»ad_cdb
[10]);

930 
cdb_Ën
 = 16;

932 
»ad_cdb
[0] = 
VARIABLE_LENGTH_CMD
;

933 
	`put_uÇligÃd_be16
(
SUBCODE_READ_32
, &
»ad_cdb
[8]);

934 
»ad_cdb
[7] = 0x18;

935 
cdb_Ën
 = 32;

936 
»ad_cdb
[10] = 0x20;

937 
	`put_uÇligÃd_be64
(
lba
, &
»ad_cdb
[12]);

938 
	`put_uÇligÃd_be32
(
blocks
, &
»ad_cdb
[28]);

939 
	`put_uÇligÃd_be32
(
lba
 & 0xFFFF, &
»ad_cdb
[20]);

943 
rcmd
 = 
	`__sc¡_ü—‹_´•¬e_š‹º®_cmd
(
»ad_cdb
,

944 
cdb_Ën
, 
SCST_CMD_QUEUE_SIMPLE
,

945 
´iv
->
cm_»ad_tgt_dev
, 
GFP_KERNEL
, 
çl£
);

946 ià(
rcmd
 =ð
NULL
) {

947 
»s
 = -
ENOMEM
;

948 
out_busy
;

951 
rcmd
->
š‹º®_check_loÿl_ev’ts
 = 1;

953 
rcmd
->
ex³ùed_d©a_dœeùiÚ
 = 
SCST_DATA_READ
;

954 
rcmd
->
ex³ùed_Œªsãr_Ën_fuÎ
 = 
Ën
;

955 ià(
check_dif
 != 0)

956 
rcmd
->
ex³ùed_Œªsãr_Ën_fuÎ
 +ð
Ën
 >> (
block_shiá
 - 
SCST_DIF_TAG_SHIFT
);

957 
rcmd
->
ex³ùed_v®ues_£t
 = 1;

959 
»s
 = 
	`sc¡_cm_add_to_š‹º®_cmd_li¡
(
rcmd
, 
ec_cmd
,ƒc_cmd,

960 
sc¡_cm_»ad_cmd_fšished
);

961 ià(
»s
 != 0)

962 
out_ä“_rcmd
;

964 
	`TRACE_DBG
("Addingƒc_cmd's (%p) READ„cmd %p (lba %lld, blocks %d, "

965 "check_dià%dètØaùivcmd†i¡", 
ec_cmd
, 
rcmd
,

966 ()
rcmd
->
lba
, 
blocks
, 
check_dif
);

967 
	`¥š_lock_œq
(&
rcmd
->
cmd_th»ads
->
cmd_li¡_lock
);

968 
	`li¡_add_ž
(&
rcmd
->
cmd_li¡_’Œy
, &rcmd->
cmd_th»ads
->
aùive_cmd_li¡
);

969 
	`¥š_uÆock_œq
(&
rcmd
->
cmd_th»ads
->
cmd_li¡_lock
);

971 
»s
 = 0;

973 
out
:

974 
	`TRACE_EXIT_RES
(
»s
);

975  
»s
;

977 
out_busy
:

978 
	`sc¡_£t_busy
(
ec_cmd
);

979 
out
;

981 
out_ä“_rcmd
:

982 
	`__sc¡_cmd_put
(
rcmd
);

983 
out
;

984 
	}
}

986 
	$sc¡_cm_»ad_»Œy_â
(
sc¡_cmd
 *
rcmd
)

988 
sc¡_cm_š‹º®_cmd_´iv
 *
p
 = 
rcmd
->
tgt_i_´iv
;

989 
sc¡_cmd
 *
ec_cmd
 = 
p
->
cm_Üig_cmd
;

990 
sc¡_cm_ec_cmd_´iv
 *
´iv
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

991 
rc
;

993 
	`TRACE_ENTRY
();

995 
	`mu‹x_lock
(&
´iv
->
cm_mu‹x
);

997 
rc
 = 
	`__sc¡_cm_push_sšgË_»ad
(
ec_cmd
, 
rcmd
->
lba
,

998 
rcmd
->
d©a_Ën
 >> 
´iv
->
cm_»ad_tgt_dev
->
dev
->
block_shiá
);

1001 
	`sc¡_cm_d–_ä“_äom_š‹º®_cmd_li¡
(
rcmd
, 
çl£
);

1003 
	`mu‹x_uÆock
(&
´iv
->
cm_mu‹x
);

1005 ià(
rc
 == 0)

1006 
	`wake_up
(&
´iv
->
cm_»ad_tgt_dev
->
aùive_cmd_th»ads
->
cmd_li¡_wa™Q
);

1008 
	`sc¡_cm_š_æight_cmd_fšished
(
ec_cmd
);

1010 
	`TRACE_EXIT
();

1012 
	}
}

1014 
sc¡_cm_push_sšgË_wr™e
(
sc¡_cmd
 *
ec_cmd
,

1015 
št64_t
 
lba
, 
blocks
, 
sc¡_cmd
 *
rcmd
);

1017 
	$sc¡_cm_wr™e_»Œy_â
(
sc¡_cmd
 *
wcmd
)

1019 
sc¡_cm_š‹º®_cmd_´iv
 *
p
 = 
wcmd
->
tgt_i_´iv
;

1020 
sc¡_cmd
 *
rcmd
 = 
p
->
cm_Üig_cmd
;

1021 
sc¡_cm_š‹º®_cmd_´iv
 *
½
 = 
rcmd
->
tgt_i_´iv
;

1022 
sc¡_cmd
 *
ec_cmd
 = 
½
->
cm_Üig_cmd
;

1023 
sc¡_cm_ec_cmd_´iv
 *
´iv
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

1024 
rc
;

1026 
	`TRACE_ENTRY
();

1028 
	`mu‹x_lock
(&
´iv
->
cm_mu‹x
);

1030 
rc
 = 
	`sc¡_cm_push_sšgË_wr™e
(
ec_cmd
, 
wcmd
->
lba
,

1031 
wcmd
->
d©a_Ën
 >> 
´iv
->
cm_wr™e_tgt_dev
->
dev
->
block_shiá
,

1032 
rcmd
);

1035 
	`sc¡_cm_d–_ä“_äom_š‹º®_cmd_li¡
(
wcmd
, 
çl£
);

1037 
	`mu‹x_uÆock
(&
´iv
->
cm_mu‹x
);

1039 
	`__sc¡_cmd_put
(
rcmd
);

1041 ià(
rc
 != 0)

1042 
	`sc¡_cm_š_æight_cmd_fšished
(
ec_cmd
);

1044 
	`TRACE_EXIT
();

1046 
	}
}

1048 
sc¡_cm_push_sšgË_»ad
(
sc¡_cmd
 *
ec_cmd
, 
blocks
,

1049 
boÞ
 
šc_cur_š_æight
);

1051 
	$sc¡_cm_wr™e_cmd_fšished
(
sc¡_cmd
 *
wcmd
)

1053 
sc¡_cm_š‹º®_cmd_´iv
 *
p
 = 
wcmd
->
tgt_i_´iv
;

1054 
sc¡_cmd
 *
rcmd
 = 
p
->
cm_Üig_cmd
;

1055 
sc¡_cm_š‹º®_cmd_´iv
 *
½
 = 
rcmd
->
tgt_i_´iv
;

1056 
sc¡_cmd
 *
ec_cmd
 = 
½
->
cm_Üig_cmd
;

1057 
sc¡_cm_ec_cmd_´iv
 *
´iv
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

1058 
rc
, 
blocks
;

1060 
	`TRACE_ENTRY
();

1062 
	`TRACE_DBG
("Write cmd %p finished (ec_cmd %p,„cmd %p, cm_cur_in_flight %d)",

1063 
wcmd
, 
rcmd
, 
ec_cmd
, 
´iv
->
cm_cur_š_æight
);

1065 
	`EXTRACHECKS_BUG_ON
(
wcmd
->
cdb
[0] !ð
WRITE_16
);

1067 ià(
	`uÆik–y
(
	`sc¡_cm_is_ec_cmd_dÚe
(
ec_cmd
)))

1068 
out_fšished
;

1070 
rc
 = 
	`sc¡_cm_”r_check_»Œy
(
wcmd
, 
ec_cmd
->
¡¬t_time
, 
sc¡_cm_wr™e_»Œy_â
);

1071 ià(
	`lik–y
(
rc
 =ð
SCST_CM_STATUS_CMD_SUCCEEDED
))

1072 
cÚt
;

1073 ià(
rc
 =ð
SCST_CM_STATUS_RETRY
)

1074 
out
;

1076 
	`TRACE_DBG
("Write cmd %p (ec_cmd %p) finished‚ot successfully",

1077 
wcmd
, 
ec_cmd
);

1078 ià(
wcmd
->
¡©us
 =ð
SAM_STAT_CHECK_CONDITION
)

1079 
rc
 = 
	`sc¡_£t_cmd_”rÜ_£n£
(
ec_cmd
, 
wcmd
->
£n£
,

1080 
wcmd
->
£n£_v®id_Ën
);

1082 
	`sBUG_ON
(
wcmd
->
£n£
 !ð
NULL
);

1083 
rc
 = 
	`sc¡_£t_cmd_”rÜ_¡©us
(
ec_cmd
, 
wcmd
->
¡©us
);

1085 ià(
rc
 != 0) {

1090 
	`WARN_ON
(
	`sc¡_is_ua_£n£
(
wcmd
->
£n£
, wcmd->
£n£_v®id_Ën
));

1091 
	`sBUG_ON
(
´iv
->
cm_”rÜ
 =ð
SCST_CM_ERROR_NONE
);

1093 
´iv
->
cm_”rÜ
 = 
SCST_CM_ERROR_WRITE
;

1094 
out_fšished
;

1097 
cÚt
:

1098 
´iv
->
cm_wr™‹n
 +ð
wcmd
->
d©a_Ën
;

1099 
	`TRACE_DBG
("ec_cmd %p, cm_wr™‹À%Îd (d©a_ËÀ%Îd)", 
ec_cmd
,

1100 ()
´iv
->
cm_wr™‹n
, ()
wcmd
->
d©a_Ën
);

1102 
wcmd
->
sg
 = 
NULL
;

1103 
wcmd
->
sg_út
 = 0;

1105 
	`mu‹x_lock
(&
´iv
->
cm_mu‹x
);

1107 ià(
´iv
->
cm_Ëá_to_»ad
 == 0) {

1108 ià(
´iv
->
cm_cur_d©a_desü
 >ð´iv->
cm_d©a_desüs_út
)

1109 
out_uÆock_fšished
;

1111 
rc
 = 
	`sc¡_cm_£tup_Ãxt_d©a_desü
(
ec_cmd
);

1112 ià(
rc
 != 0)

1113 
out_uÆock_fšished
;

1116 
	`EXTRACHECKS_BUG_ON
(
´iv
->
cm_Ëá_to_»ad
 == 0);

1118 
blocks
 = 
	`mš_t
(, 
´iv
->
cm_Ëá_to_»ad
,…riv->
cm_max_—ch_»ad
);

1120 
rc
 = 
	`sc¡_cm_push_sšgË_»ad
(
ec_cmd
, 
blocks
, 
çl£
);

1121 ià(
rc
 != 0)

1122 
out_uÆock_fšished
;

1124 
	`sc¡_cm_d–_ä“_äom_š‹º®_cmd_li¡
(
wcmd
, 
çl£
);

1125 
	`sc¡_cm_d–_ä“_äom_š‹º®_cmd_li¡
(
rcmd
, 
çl£
);

1127 
	`mu‹x_uÆock
(&
´iv
->
cm_mu‹x
);

1129 
	`wake_up
(&
rcmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

1131 
out_put
:

1132 
	`__sc¡_cmd_put
(
rcmd
);

1134 
out
:

1135 
	`TRACE_EXIT
();

1138 
out_uÆock_fšished
:

1139 
	`mu‹x_uÆock
(&
´iv
->
cm_mu‹x
);

1141 
out_fšished
:

1142 
	`sc¡_cm_d–_ä“_äom_š‹º®_cmd_li¡
(
wcmd
, 
çl£
);

1143 
	`sc¡_cm_d–_ä“_äom_š‹º®_cmd_li¡
(
rcmd
, 
çl£
);

1145 
	`sc¡_cm_š_æight_cmd_fšished
(
ec_cmd
);

1146 
out_put
;

1147 
	}
}

1149 
	$sc¡_cm_push_sšgË_wr™e
(
sc¡_cmd
 *
ec_cmd
,

1150 
št64_t
 
lba
, 
blocks
, 
sc¡_cmd
 *
rcmd
)

1152 
»s
;

1153 
sc¡_cm_ec_cmd_´iv
 *
´iv
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

1154 
ušt8_t
 
wr™e16_cdb
[16];

1155 
sc¡_cmd
 *
wcmd
;

1156 
Ën
;

1158 
	`TRACE_ENTRY
();

1160 
Ën
 = 
blocks
 << 
´iv
->
cm_wr™e_tgt_dev
->
dev
->
block_shiá
;

1167 
	`mem£t
(
wr™e16_cdb
, 0, (write16_cdb));

1168 
wr™e16_cdb
[0] = 
WRITE_16
;

1169 
	`put_uÇligÃd_be64
(
lba
, &
wr™e16_cdb
[2]);

1170 
	`put_uÇligÃd_be32
(
blocks
, &
wr™e16_cdb
[10]);

1172 
wcmd
 = 
	`__sc¡_ü—‹_´•¬e_š‹º®_cmd
(
wr™e16_cdb
,

1173 (
wr™e16_cdb
), 
SCST_CMD_QUEUE_SIMPLE
,

1174 
´iv
->
cm_wr™e_tgt_dev
, 
GFP_KERNEL
, 
çl£
);

1175 ià(
wcmd
 =ð
NULL
) {

1176 
»s
 = -
ENOMEM
;

1177 
out_busy
;

1180 
wcmd
->
š‹º®_check_loÿl_ev’ts
 = 1;

1182 
wcmd
->
ex³ùed_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
;

1183 
wcmd
->
ex³ùed_Œªsãr_Ën_fuÎ
 = 
Ën
;

1184 
wcmd
->
ex³ùed_v®ues_£t
 = 1;

1186 
»s
 = 
	`sc¡_cm_add_to_š‹º®_cmd_li¡
(
wcmd
, 
ec_cmd
, 
rcmd
,

1187 
sc¡_cm_wr™e_cmd_fšished
);

1188 ià(
»s
 != 0)

1189 
out_ä“_wcmd
;

1191 
	`__sc¡_cmd_g‘
(
rcmd
);

1193 
wcmd
->
tgt_i_sg
 = 
rcmd
->
sg
;

1194 
wcmd
->
tgt_i_sg_út
 = 
rcmd
->
sg_út
;

1195 
wcmd
->
tgt_i_d©a_buf_®loûd
 = 1;

1197 
	`TRACE_DBG
("Adding EC (%p) WRITE(16) cmd %p (lba %lld, blocks %d)o "

1198 "aùivcmd†i¡", 
ec_cmd
, 
wcmd
, ()wcmd->
lba
, 
blocks
);

1199 
	`¥š_lock_œq
(&
wcmd
->
cmd_th»ads
->
cmd_li¡_lock
);

1200 
	`li¡_add_ž
(&
wcmd
->
cmd_li¡_’Œy
, &wcmd->
cmd_th»ads
->
aùive_cmd_li¡
);

1201 
	`wake_up
(&
wcmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

1202 
	`¥š_uÆock_œq
(&
wcmd
->
cmd_th»ads
->
cmd_li¡_lock
);

1204 
»s
 = 0;

1206 
out
:

1207 
	`TRACE_EXIT_RES
(
»s
);

1208  
»s
;

1210 
out_busy
:

1211 
	`sc¡_£t_busy
(
ec_cmd
);

1212 
out
;

1214 
out_ä“_wcmd
:

1215 
	`__sc¡_cmd_put
(
wcmd
);

1216 
out
;

1217 
	}
}

1219 
	$sc¡_cm_»ad_cmd_fšished
(
sc¡_cmd
 *
rcmd
)

1221 
sc¡_cm_š‹º®_cmd_´iv
 *
p
 = 
rcmd
->
tgt_i_´iv
;

1222 
sc¡_cmd
 *
ec_cmd
 = 
p
->
cm_Üig_cmd
;

1223 
sc¡_cm_ec_cmd_´iv
 *
´iv
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

1224 
št64_t
 
lba
;

1225 
rc
, 
Ën
, 
blocks
;

1227 
	`TRACE_ENTRY
();

1229 
	`TRACE_DBG
("READ cmd %°fšished (ec_cmd %p,… %p)", 
rcmd
, 
ec_cmd
, 
p
);

1231 ià(
	`uÆik–y
(
	`sc¡_cm_is_ec_cmd_dÚe
(
ec_cmd
)))

1232 
out_fšished
;

1234 
rc
 = 
	`sc¡_cm_”r_check_»Œy
(
rcmd
, 
ec_cmd
->
¡¬t_time
, 
sc¡_cm_»ad_»Œy_â
);

1235 ià(
	`lik–y
(
rc
 =ð
SCST_CM_STATUS_CMD_SUCCEEDED
))

1236 
cÚt
;

1237 ià(
rc
 =ð
SCST_CM_STATUS_RETRY
)

1238 
out
;

1240 
	`TRACE_DBG
("Read cmd %p (ec_cmd %p) finished‚ot successfully",

1241 
rcmd
, 
ec_cmd
);

1242 ià(
rcmd
->
¡©us
 =ð
SAM_STAT_CHECK_CONDITION
)

1243 
rc
 = 
	`sc¡_£t_cmd_”rÜ_£n£
(
ec_cmd
, 
rcmd
->
£n£
,

1244 
rcmd
->
£n£_v®id_Ën
);

1246 
	`sBUG_ON
(
rcmd
->
£n£
 !ð
NULL
);

1247 
rc
 = 
	`sc¡_£t_cmd_”rÜ_¡©us
(
ec_cmd
, 
rcmd
->
¡©us
);

1249 ià(
rc
 != 0) {

1254 
	`WARN_ON
(
	`sc¡_is_ua_£n£
(
rcmd
->
£n£
,„cmd->
£n£_v®id_Ën
));

1255 
	`sBUG_ON
(
´iv
->
cm_”rÜ
 =ð
SCST_CM_ERROR_NONE
);

1257 
´iv
->
cm_”rÜ
 = 
SCST_CM_ERROR_READ
;

1258 
out_fšished
;

1261 
cÚt
:

1262 
lba
 = 
rcmd
->lb¨- 
´iv
->
cm_¡¬t_»ad_lba
;

1263 
lba
 <<ð
´iv
->
cm_»ad_tgt_dev
->
dev
->
block_shiá
;

1264 
lba
 >>ð
´iv
->
cm_wr™e_tgt_dev
->
dev
->
block_shiá
;

1265 
lba
 +ð
´iv
->
cm_¡¬t_wr™e_lba
;

1267 
Ën
 = 
rcmd
->
d©a_Ën
;

1268 
blocks
 = 
Ën
 >> 
´iv
->
cm_wr™e_tgt_dev
->
dev
->
block_shiá
;

1270 
	`TRACE_DBG
("rcmd->lba %lld, start_read_lba %lld,„ead shift %d, write "

1272 ()
rcmd
->
lba
, ()
´iv
->
cm_¡¬t_»ad_lba
,

1273 
´iv
->
cm_»ad_tgt_dev
->
dev
->
block_shiá
,

1274 
´iv
->
cm_wr™e_tgt_dev
->
dev
->
block_shiá
,

1275 ()
´iv
->
cm_¡¬t_wr™e_lba
, 
lba
, 
Ën
, 
blocks
);

1277 
rc
 = 
	`sc¡_cm_push_sšgË_wr™e
(
ec_cmd
, 
lba
, 
blocks
, 
rcmd
);

1278 ià(
rc
 != 0)

1279 
out_fšished
;

1281 
out
:

1282 
	`TRACE_EXIT
();

1285 
out_fšished
:

1286 
	`sc¡_cm_d–_ä“_äom_š‹º®_cmd_li¡
(
rcmd
, 
çl£
);

1288 
	`sc¡_cm_š_æight_cmd_fšished
(
ec_cmd
);

1289 
out
;

1290 
	}
}

1293 
	$sc¡_cm_push_sšgË_»ad
(
sc¡_cmd
 *
ec_cmd
, 
blocks
,

1294 
boÞ
 
šc_cur_š_æight
)

1296 
»s
;

1297 
sc¡_cm_ec_cmd_´iv
 *
´iv
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

1299 
	`TRACE_ENTRY
();

1301 
	`TRACE_DBG
("ec_cmd %p, cm_cur_read_lba %lld, cm_left_to_read %d, "

1302 "block %d", 
ec_cmd
, ()
´iv
->
cm_cur_»ad_lba
,

1303 
´iv
->
cm_Ëá_to_»ad
, 
blocks
);

1305 
»s
 = 
	`__sc¡_cm_push_sšgË_»ad
(
ec_cmd
, 
´iv
->
cm_cur_»ad_lba
, 
blocks
);

1306 ià(
»s
 != 0)

1307 
out
;

1309 
´iv
->
cm_cur_»ad_lba
 +ð
blocks
;

1310 
´iv
->
cm_Ëá_to_»ad
 -ð
blocks
;

1312 ià(
šc_cur_š_æight
) {

1313 
´iv
->
cm_cur_š_æight
++;

1314 
	`TRACE_DBG
("ec_cmd %p,‚ew cm_cur_š_æighˆ%d", 
ec_cmd
,

1315 
´iv
->
cm_cur_š_æight
);

1318 
out
:

1319 
	`TRACE_EXIT_RES
(
»s
);

1320  
»s
;

1321 
	}
}

1327 
	$sc¡_cm_g’_»ads
(
sc¡_cmd
 *
ec_cmd
)

1329 
sc¡_cm_ec_cmd_´iv
 *
´iv
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

1330 
út
 = 0;

1332 
	`TRACE_ENTRY
();

1334 
	`mu‹x_lock
(&
´iv
->
cm_mu‹x
);

1337 
rc
;

1339 (
´iv
->
cm_Ëá_to_»ad
 > 0) &&

1340 (
´iv
->
cm_cur_š_æight
 < 
SCST_MAX_IN_FLIGHT_INTERNAL_COMMANDS
)) {

1341 
blocks
;

1343 
blocks
 = 
	`mš_t
(, 
´iv
->
cm_Ëá_to_»ad
,…riv->
cm_max_—ch_»ad
);

1345 
rc
 = 
	`sc¡_cm_push_sšgË_»ad
(
ec_cmd
, 
blocks
, 
Œue
);

1346 ià(
rc
 != 0)

1347 
out_”r
;

1349 
út
++;

1352 ià(
´iv
->
cm_cur_š_æight
 =ð
SCST_MAX_IN_FLIGHT_INTERNAL_COMMANDS
)

1355 
rc
 = 
	`sc¡_cm_£tup_Ãxt_d©a_desü
(
ec_cmd
);

1356 ià(
rc
 != 0)

1357 
out_”r
;

1360 
	`EXTRACHECKS_BUG_ON
(
út
 == 0);

1362 
out_wake
:

1363 ià(
út
 != 0)

1364 
	`wake_up
(&
´iv
->
cm_»ad_tgt_dev
->
aùive_cmd_th»ads
->
cmd_li¡_wa™Q
);

1366 
	`mu‹x_uÆock
(&
´iv
->
cm_mu‹x
);

1368 
out
:

1369 
	`TRACE_EXIT
();

1372 
out_”r
:

1373 ià(
´iv
->
cm_cur_š_æight
 != 0)

1374 
out_wake
;

1376 
	`mu‹x_uÆock
(&
´iv
->
cm_mu‹x
);

1377 
	`sc¡_cm_ec_cmd_dÚe
(
ec_cmd
);

1379 
out
;

1380 
	}
}

1383 
	$sc¡_cm_´oûss_d©a_desüs
(
sc¡_cmd
 *
ec_cmd
,

1384 cÚ¡ 
sc¡_ext_cÝy_d©a_desü
 *
dds
, 
dds_út
)

1386 
rc
;

1388 
	`TRACE_ENTRY
();

1390 
rc
 = 
	`sc¡_cm_£tup_d©a_desüs
(
ec_cmd
, 
dds
, 
dds_út
);

1391 ià(
rc
 != 0)

1392 
out_dÚe
;

1394 
	`sc¡_cm_g’_»ads
(
ec_cmd
);

1398 
out
:

1399 
	`TRACE_EXIT
();

1402 
out_dÚe
:

1403 
	`sc¡_cm_ec_cmd_dÚe
(
ec_cmd
);

1404 
out
;

1405 
	}
}

1411 
	$sc¡_ext_cÝy_g‘_cur_£g_d©a_Ën
(
sc¡_cmd
 *
ec_cmd
)

1413 
»s
;

1414 
sc¡_cm_ec_cmd_´iv
 *
´iv
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

1416 
	`TRACE_ENTRY
();

1418 
»s
 = 
´iv
->
cm_£g_desüs
[´iv->
cm_cur_£g_desü
].
d©a_desü
.
d©a_Ën
;

1420 
	`TRACE_EXIT_RES
(
»s
);

1421  
»s
;

1422 
	}
}

1423 
EXPORT_SYMBOL_GPL
(
sc¡_ext_cÝy_g‘_cur_£g_d©a_Ën
);

1442 
	$sc¡_ext_cÝy_»m­_dÚe
(
sc¡_cmd
 *
ec_cmd
,

1443 
sc¡_ext_cÝy_d©a_desü
 *
dds
, 
dds_út
)

1445 
	`TRACE_ENTRY
();

1447 
	`sc¡_£t_exec_time
(
ec_cmd
);

1449 ià(
dds
 =ð
NULL
)

1450 
	`sc¡_cm_ec_sched_Ãxt_£g
(
ec_cmd
);

1452 
	`sc¡_cm_´oûss_d©a_desüs
(
ec_cmd
, 
dds
, 
dds_út
);

1456 
	`TRACE_EXIT
();

1458 
	}
}

1459 
EXPORT_SYMBOL_GPL
(
sc¡_ext_cÝy_»m­_dÚe
);

1461 
sc¡_cm_Œy_to_»m­
(
sc¡_cmd
 *
ec_cmd
);

1463 
	$sc¡_cm_»m­_»Œy_â
(
sc¡_cmd
 *
cmd
)

1465 
sc¡_cmd
 *
ec_cmd
 = 
cmd
->
tgt_i_´iv
;

1466 
rc
;

1468 
	`TRACE_ENTRY
();

1470 
rc
 = 
	`sc¡_cm_Œy_to_»m­
(
ec_cmd
);

1471 
	`sBUG_ON
(
rc
 != 0);

1473 
	`TRACE_EXIT
();

1475 
	}
}

1482 
	$sc¡_cm_Œy_to_»m­
(
sc¡_cmd
 *
ec_cmd
)

1484 
»s
, 
rc
;

1485 
sc¡_cm_ec_cmd_´iv
 *
´iv
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

1486 
sc¡_ext_cÝy_£g_desü
 *
sd
 = &
´iv
->
cm_£g_desüs
[´iv->
cm_cur_£g_desü
];

1487 
sc¡_ext_cÝy_d©a_desü
 *
dd
 = &
sd
->
d©a_desü
;

1488 
sc¡_dev_ty³
 *
hªdËr
 = 
ec_cmd
->
dev
->handler;

1489 
ušt8_t
 
cdb
[16];

1490 
sc¡_cmd
 *
cmd
;

1492 
	`TRACE_ENTRY
();

1494 ià(
hªdËr
->
ext_cÝy_»m­
 =ð
NULL
) {

1495 
»s
 = 1;

1496 
out
;

1499 
»s
 = 0;

1503 
	`TRACE_DBG
("Checking„eservations on„ead dev %s (ec_cmd %p)",

1504 
sd
->
¤c_tgt_dev
->
dev
->
vœt_Çme
, 
ec_cmd
);

1506 
	`mem£t
(
cdb
, 0, (cdb));

1507 
cdb
[0] = 
READ_16
;

1508 
	`put_uÇligÃd_be64
(
dd
->
¤c_lba
, &
cdb
[2]);

1509 
	`put_uÇligÃd_be32
(
dd
->
d©a_Ën
 >> 
sd
->
¤c_tgt_dev
->
dev
->
block_shiá
, &
cdb
[10]);

1511 
cmd
 = 
	`__sc¡_ü—‹_´•¬e_š‹º®_cmd
(
cdb
,

1512 (
cdb
), 
SCST_CMD_QUEUE_SIMPLE
,

1513 
sd
->
¤c_tgt_dev
, 
GFP_KERNEL
, 
Œue
);

1514 ià(
cmd
 =ð
NULL
)

1515 
out_busy
;

1517 
cmd
->
š‹º®_check_loÿl_ev’ts
 = 1;

1518 
cmd
->
tgt_i_´iv
 = 
ec_cmd
;

1520 
rc
 = 
	`__sc¡_check_loÿl_ev’ts
(
cmd
, 
çl£
);

1521 ià(
	`uÆik–y
(
rc
 != 0))

1522 
out_check_»Œy
;

1524 
	`__sc¡_cmd_put
(
cmd
);

1526 
	`TRACE_DBG
("Checking„eservations on write dev %s (ec_cmd %p)",

1527 
sd
->
d¡_tgt_dev
->
dev
->
vœt_Çme
, 
ec_cmd
);

1529 
	`mem£t
(
cdb
, 0, (cdb));

1530 
cdb
[0] = 
WRITE_16
;

1531 
	`put_uÇligÃd_be64
(
dd
->
d¡_lba
, &
cdb
[2]);

1532 
	`put_uÇligÃd_be32
(
dd
->
d©a_Ën
 >> 
sd
->
d¡_tgt_dev
->
dev
->
block_shiá
, &
cdb
[10]);

1534 
cmd
 = 
	`__sc¡_ü—‹_´•¬e_š‹º®_cmd
(
cdb
,

1535 (
cdb
), 
SCST_CMD_QUEUE_SIMPLE
,

1536 
sd
->
d¡_tgt_dev
, 
GFP_KERNEL
, 
Œue
);

1537 ià(
cmd
 =ð
NULL
)

1538 
out_busy
;

1540 
cmd
->
š‹º®_check_loÿl_ev’ts
 = 1;

1541 
cmd
->
tgt_i_´iv
 = 
ec_cmd
;

1543 
rc
 = 
	`__sc¡_check_loÿl_ev’ts
(
cmd
, 
çl£
);

1544 ià(
	`uÆik–y
(
rc
 != 0))

1545 
out_check_»Œy
;

1547 
	`__sc¡_cmd_put
(
cmd
);

1549 
	`TRACE_DBG
("Callingƒxt_copy_remap() for dev %s (ec_cmd %p)",

1550 
sd
->
d¡_tgt_dev
->
dev
->
vœt_Çme
, 
ec_cmd
);

1552 
	`sc¡_£t_exec_¡¬t
(
ec_cmd
);

1553 
hªdËr
->
	`ext_cÝy_»m­
(
ec_cmd
, 
sd
);

1555 
out
:

1556 
	`TRACE_EXIT_RES
(
»s
);

1557  
»s
;

1559 
out_check_»Œy
:

1560 
rc
 = 
	`sc¡_cm_”r_check_»Œy
(
cmd
, 
ec_cmd
->
¡¬t_time
, 
sc¡_cm_»m­_»Œy_â
);

1561 
	`sBUG_ON
(
rc
 =ð
SCST_CM_STATUS_CMD_SUCCEEDED
);

1562 ià(
rc
 =ð
SCST_CM_STATUS_CMD_FAILED
) {

1563 
	`TRACE_DBG
("Remap check cmd %p (ec_cmd %p, op %s) failed",

1564 
cmd
, 
ec_cmd
, 
	`sc¡_g‘_Ýcode_Çme
(cmd));

1565 ià(
cmd
->
¡©us
 =ð
SAM_STAT_CHECK_CONDITION
)

1566 
rc
 = 
	`sc¡_£t_cmd_”rÜ_£n£
(
ec_cmd
, 
cmd
->
£n£
,

1567 
cmd
->
£n£_v®id_Ën
);

1569 
	`sBUG_ON
(
cmd
->
£n£
 !ð
NULL
);

1570 
rc
 = 
	`sc¡_£t_cmd_”rÜ_¡©us
(
ec_cmd
, 
cmd
->
¡©us
);

1572 ià(
rc
 != 0) {

1577 
	`WARN_ON
(
	`sc¡_is_ua_£n£
(
cmd
->
£n£
, cmd->
£n£_v®id_Ën
));

1579 ià(
cmd
->
cdb
[0] =ð
READ_16
)

1580 
´iv
->
cm_”rÜ
 = 
SCST_CM_ERROR_READ
;

1582 
	`EXTRACHECKS_BUG_ON
(
cmd
->
cdb
[0] !ð
WRITE_16
);

1583 
´iv
->
cm_”rÜ
 = 
SCST_CM_ERROR_WRITE
;

1586 
	`__sc¡_cmd_put
(
cmd
);

1587 
out_dÚe
;

1589 
	`__sc¡_cmd_put
(
cmd
);

1590 
out
;

1592 
out_busy
:

1593 
»s
 = -
ENOMEM
;

1594 
	`sc¡_£t_busy
(
ec_cmd
);

1596 
out_dÚe
:

1597 
	`sc¡_cm_ec_cmd_dÚe
(
ec_cmd
);

1598 
out
;

1599 
	}
}

1601 
	$sc¡_cm_´oûss_cur_£g_desü
(
sc¡_cmd
 *
ec_cmd
)

1603 
rc
;

1604 
sc¡_cm_ec_cmd_´iv
 *
´iv
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

1606 
	`TRACE_ENTRY
();

1608 
rc
 = 
	`sc¡_cm_Œy_to_»m­
(
ec_cmd
);

1609 ià(
rc
 == 0)

1610 
out
;

1614 
	`sc¡_ext_cÝy_»m­_dÚe
(
ec_cmd
,

1615 &
´iv
->
cm_£g_desüs
[´iv->
cm_cur_£g_desü
].
d©a_desü
, 1);

1617 
out
:

1618 
	`TRACE_EXIT
();

1620 
	}
}

1622 
	$sc¡_cm_ext_cÝy_exec
(
sc¡_cmd
 *
ec_cmd
)

1624 
»s
 = 
SCST_EXEC_COMPLETED
, 
rc
;

1625 
sc¡_cm_ec_cmd_´iv
 *
´iv
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

1627 
	`TRACE_ENTRY
();

1629 ià(
	`uÆik–y
(
´iv
 =ð
NULL
))

1630 
out_loÿl_dÚe
;

1632 ià(
	`uÆik–y
(
	`sc¡_cm_is_ec_cmd_dÚe
(
ec_cmd
))) {

1633 
	`TRACE_DBG
("ec_cmd %°dÚe", 
ec_cmd
);

1634 
out_dÚe
;

1637 
rc
 = 
	`sc¡_cm_£tup_£g_desü
(
ec_cmd
);

1638 ià(
rc
 != 0)

1639 
out_”r_dÚe
;

1641 
	`sc¡_cm_´oûss_cur_£g_desü
(
ec_cmd
);

1643 
out
:

1644 
	`TRACE_EXIT
();

1645  
»s
;

1647 
out_loÿl_dÚe
:

1648 
ec_cmd
->
com¶‘ed
 = 1;

1649 
ec_cmd
->
	`sc¡_cmd_dÚe
Óc_cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_THREAD
);

1650 
out
;

1652 
out_”r_dÚe
:

1653 
	`sBUG_ON
((
rc
 !ð-
ENOENT
è&& !
ec_cmd
->
com¶‘ed
);

1655 
out_dÚe
:

1656 
	`sc¡_cm_ec_cmd_dÚe
(
ec_cmd
);

1657 
out
;

1658 
	}
}

1660 
boÞ
 
	$sc¡_cm_ec_cmd_ov”Ïp
(
sc¡_cmd
 *
ec_cmd
, sc¡_cmd *
cmd
)

1662 
boÞ
 
»s
 = 
çl£
;

1663 
i
;

1664 
sc¡_cm_ec_cmd_´iv
 *
´iv
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

1666 
	`TRACE_ENTRY
();

1668 
	`TRACE_DBG
("ec_cmd %p, cmd %p", 
ec_cmd
, 
cmd
);

1670 
	`EXTRACHECKS_BUG_ON
(
ec_cmd
->
cdb
[0] !ð
EXTENDED_COPY
);

1672 ià((
cmd
->
Ý_æags
 & 
SCST_LBA_NOT_VALID
) != 0)

1673 
out
;

1675 
i
 = 0; i < 
ec_cmd
->
cmd_d©a_desütÜs_út
; i++) {

1676 
sc¡_ext_cÝy_£g_desü
 *
sd
 = &
´iv
->
cm_£g_desüs
[
i
];

1678 
	`TRACE_DBG
("ty³ %d, d¡_dev %p, dev %p", 
sd
->
ty³
,

1679 
sd
->
d¡_tgt_dev
->
dev
, 
cmd
->dev);

1681 ià(
sd
->
ty³
 !ð
SCST_EXT_COPY_SEG_DATA
)

1683 ià(
sd
->
d¡_tgt_dev
->
dev
 !ð
cmd
->dev)

1686 
»s
 = 
	`sc¡_lba1_šside_lba2
(
sd
->
d©a_desü
.
d¡_lba
, 
cmd
->
lba
,

1687 
cmd
->
d©a_Ën
 >> cmd->
dev
->
block_shiá
);

1688 ià(
»s
)

1689 
out
;

1690 
»s
 = 
	`sc¡_lba1_šside_lba2
(
cmd
->
lba
, 
sd
->
d©a_desü
.
d¡_lba
,

1691 
sd
->
d©a_desü
.
d©a_Ën
 >> sd->
d¡_tgt_dev
->
dev
->
block_shiá
);

1692 ià(
»s
)

1693 
out
;

1696 
out
:

1697 
	`TRACE_EXIT_RES
(
»s
);

1698  
»s
;

1699 
	}
}

1704 
boÞ
 
	$sc¡_cm_check_block_®l_devs
(
sc¡_cmd
 *
cmd
)

1706 
boÞ
 
»s
 = 
çl£
;

1707 
sc¡_cmd
 *
ec_cmd
;

1708 
sc¡_cm_ec_cmd_´iv
 *
d
;

1709 
sc¡_cm_dev_’Œy
 *
e
;

1711 
	`TRACE_ENTRY
();

1747 ià(
cmd
->
š‹º®
) {

1748 
sc¡_cm_š‹º®_cmd_´iv
 *
p
 = 
cmd
->
tgt_i_´iv
;

1752 
ec_cmd
 = 
p
->
cm_Üig_cmd
;

1754 
	`TRACE_BLOCK
("Rewaking blocked EC cmd %p (fcmd %p)",

1755 
ec_cmd
, 
cmd
);

1757 
	`sc¡_check_unblock_dev
(
cmd
);

1759 
	`¥š_lock_œq
(&
ec_cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

1760 
	`li¡_add_ž
(&
ec_cmd
->
cmd_li¡_’Œy
,

1761 &
ec_cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

1762 
	`wake_up
(&
ec_cmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

1763 
	`¥š_uÆock_œq
(&
ec_cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

1765 
»s
 = 
Œue
;

1766 
out
;

1771 
ec_cmd
 = 
cmd
;

1776 
	`TRACE_DBG
("Check unblockšgƒc_cmd %p", 
ec_cmd
);

1777 
	`sc¡_check_unblock_dev
(
ec_cmd
);

1779 
d
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

1780 ià(
d
 =ð
NULL
) {

1781 
	`¥š_lock_bh
(&
ec_cmd
->
dev
->
dev_lock
);

1782 
»s
 = 
	`sc¡_do_check_blocked_dev
(
ec_cmd
);

1783 
	`¥š_uÆock_bh
(&
ec_cmd
->
dev
->
dev_lock
);

1784 
out
;

1787 
	`loÿl_bh_di§bË
();

1789 #ià!
	`defšed
(
__CHECKER__
)

1790 
	`li¡_fÜ_—ch_’Œy
(
e
, &
d
->
cm_sÜ‹d_devs_li¡
, 
cm_sÜ‹d_devs_li¡_’Œy
) {

1791 
	`¥š_lock
(&
e
->
cm_fcmd
->
dev
->
dev_lock
);

1795 
	`li¡_fÜ_—ch_’Œy
(
e
, &
d
->
cm_sÜ‹d_devs_li¡
, 
cm_sÜ‹d_devs_li¡_’Œy
) {

1796 
	`TRACE_DBG
("dev %°(fcmd %p)", 
e
->
cm_fcmd
->
dev
,ƒ->cm_fcmd);

1797 
»s
 = 
	`sc¡_do_check_blocked_dev
(
e
->
cm_fcmd
);

1798 ià(
	`uÆik–y
(
»s
)) {

1799 
	`TRACE_BLOCK
("fcmd %p (ec_cmd %p) blocked, undo "

1800 "check blockšg deviûs", 
e
->
cm_fcmd
, 
ec_cmd
);

1805 ià(
	`uÆik–y
(
»s
)) {

1806 
sc¡_cmd
 *
blocked_cmd
 = 
e
->
cm_fcmd
;

1808 
	`li¡_fÜ_—ch_’Œy
(
e
, &
d
->
cm_sÜ‹d_devs_li¡
,

1809 
cm_sÜ‹d_devs_li¡_’Œy
) {

1810 ià(
e
->
cm_fcmd
 =ð
blocked_cmd
)

1812 
	`__sc¡_check_unblock_dev
(
e
->
cm_fcmd
);

1813 
e
->
cm_fcmd
->
¡©e
 = 
SCST_CMD_STATE_EXEC_CHECK_BLOCKING
;

1817 #ià!
	`defšed
(
__CHECKER__
)

1818 
	`li¡_fÜ_—ch_’Œy_»v”£
(
e
, &
d
->
cm_sÜ‹d_devs_li¡
,

1819 
cm_sÜ‹d_devs_li¡_’Œy
) {

1820 
	`¥š_uÆock
(&
e
->
cm_fcmd
->
dev
->
dev_lock
);

1824 
	`loÿl_bh_’abË
();

1826 
out
:

1827 
	`TRACE_EXIT_RES
(
»s
);

1828  
»s
;

1829 
	}
}

1831 
	$sc¡_cm_abÜt_ec_cmd
(
sc¡_cmd
 *
ec_cmd
)

1833 
sc¡_cm_ec_cmd_´iv
 *
p
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

1834 
sc¡_cm_š‹º®_cmd_´iv
 *

;

1835 
æags
;

1837 
	`TRACE_ENTRY
();

1839 
	`EXTRACHECKS_BUG_ON
(
ec_cmd
->
cdb
[0] !ð
EXTENDED_COPY
);

1841 
	`¥š_lock_œq§ve
(&
sc¡_cm_lock
, 
æags
);

1843 ià(
p
 =ð
NULL
)

1844 
out_uÆock
;

1846 
	`TRACE_MGMT_DBG
("Aborting fantom‡nd internal commands ofƒc_cmd %p",

1847 
ec_cmd
);

1849 
	`li¡_fÜ_—ch_’Œy
(

, &
p
->
cm_š‹º®_cmd_li¡
,

1850 
cm_š‹º®_cmd_li¡_’Œy
) {

1851 
sc¡_cmd
 *
c
 = 

->
cm_cmd
;

1853 
	`TRACE_MGMT_DBG
("AbÜtšg (f)cmd %p", 
c
);

1854 
	`£t_b™
(
SCST_CMD_ABORTED
, &
c
->
cmd_æags
);

1857 
out_uÆock
:

1858 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_cm_lock
, 
æags
);

1860 
	`TRACE_EXIT
();

1862 
	}
}

1864 
	$sc¡_cm_d–_ä“_li¡_id
(
sc¡_cm_li¡_id
 *
l
, 
boÞ
 
locked
)

1866 
æags
 = 0;

1868 
	`TRACE_ENTRY
();

1870 
	`TRACE_DBG
("F»ešg†i¡ id %p", 
l
);

1872 #ià!
	`defšed
(
__CHECKER__
)

1873 ià(!
locked
)

1874 
	`¥š_lock_œq§ve
(&
sc¡_cm_lock
, 
æags
);

1877 #ifdeà
CONFIG_SMP


1878 
	`EXTRACHECKS_BUG_ON
(!
	`¥š_is_locked
(&
sc¡_cm_lock
));

1881 
	`li¡_d–
(&
l
->
£ss_cm_li¡_id_’Œy
);

1883 #ià!
	`defšed
(
__CHECKER__
)

1884 ià(!
locked
)

1885 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_cm_lock
, 
æags
);

1888 
	`kä“
(
l
);

1890 
	`TRACE_EXIT
();

1892 
	}
}

1894 
	$sc¡_cm_sched_d–_li¡_id
(
sc¡_cmd
 *
ec_cmd
)

1896 
sc¡_£ssiÚ
 *
£ss
 = 
ec_cmd
->sess;

1897 
sc¡_cm_ec_cmd_´iv
 *
´iv
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

1898 
sc¡_cm_li¡_id
 *
l
 = 
´iv
->
cm_li¡_id
;

1899 
æags
;

1901 
	`TRACE_ENTRY
();

1903 
	`¥š_lock_œq§ve
(&
sc¡_cm_lock
, 
æags
);

1905 ià(
l
->
cm_li¡_id_¡©e
 !ð
SCST_CM_LIST_ID_STATE_DONE
) {

1910 
l
->
cm_ÿn_be_immed_ä“
 = 1;

1913 
l
->
cm_dÚe
 = 1;

1920 
	`smp_rmb
();

1921 ià(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
ec_cmd
->
cmd_æags
) ||

1922 
l
->
cm_ÿn_be_immed_ä“
) {

1923 
	`TRACE_DBG
("Li¡ id %°ÿÀbimmed f»ed", 
l
);

1924 
	`sc¡_cm_d–_ä“_li¡_id
(
l
, 
Œue
);

1925 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_cm_lock
, 
æags
);

1926 
out
;

1929 
l
->
cm_li¡_id_¡©e
 = 
SCST_CM_LIST_ID_STATE_PENDING_FREE
;

1930 
l
->
cm_time_to_ä“
 = 
jiff›s
 + 
SCST_CM_ID_KEEP_TIME
;

1932 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_cm_lock
, 
æags
);

1934 
	`TRACE_DBG
("ScheduË…’dšg f»li¡ id %p", 
l
);

1936 
	`scheduË_d–ayed_wÜk
(&
£ss
->
£ss_cm_li¡_id_þ—nup_wÜk
,

1937 
SCST_CM_ID_KEEP_TIME
);

1939 
out
:

1940 
	`TRACE_EXIT
();

1942 
	}
}

1944 
sc¡_cm_li¡_id
 *
	$sc¡_cm_add_li¡_id
(
sc¡_cmd
 *
cmd
,

1945 
li¡_id
)

1947 
sc¡_cm_li¡_id
 *
»s
;

1948 
sc¡_£ssiÚ
 *
£ss
 = 
cmd
->sess;

1949 
sc¡_cm_li¡_id
 *
l
;

1951 
	`TRACE_ENTRY
();

1953 
»s
 = 
	`kz®loc
((*»s), 
GFP_KERNEL
);

1954 ià(
»s
 =ð
NULL
) {

1955 
	`TRACE
(
TRACE_OUT_OF_MEM
, "Unableo‡llocate†ist_id");

1956 
	`sc¡_£t_busy
(
cmd
);

1957 
out
;

1960 
»s
->
cm_lid
 = 
li¡_id
;

1961 
»s
->
cm_li¡_id_¡©e
 = 
SCST_CM_LIST_ID_STATE_ACTIVE
;

1963 
	`¥š_lock_œq
(&
sc¡_cm_lock
);

1965 
	`li¡_fÜ_—ch_’Œy
(
l
, &
£ss
->
£ss_cm_li¡_id_li¡
, 
£ss_cm_li¡_id_’Œy
) {

1966 ià(
l
->
cm_lid
 =ð
li¡_id
) {

1967 ià(
l
->
cm_li¡_id_¡©e
 =ð
SCST_CM_LIST_ID_STATE_PENDING_FREE
) {

1968 
	`sc¡_cm_d–_ä“_li¡_id
(
l
, 
Œue
);

1971 
	`TRACE_DBG
("Li¡ id %d‡Ì—dyƒxi¡s", 
li¡_id
);

1972 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1973 
	`SCST_LOAD_SENSE
(
sc¡_£n£_Ý”©iÚ_š_´og»ss
));

1974 
out_uÆock_ä“
;

1979 
	`TRACE_DBG
("Addšg†i¡ id %°(id %d)", 
»s
, 
li¡_id
);

1980 
	`li¡_add_ž
(&
»s
->
£ss_cm_li¡_id_’Œy
, &
£ss
->
£ss_cm_li¡_id_li¡
);

1982 
	`¥š_uÆock_œq
(&
sc¡_cm_lock
);

1984 
out
:

1985 
	`TRACE_EXIT
();

1986  
»s
;

1988 
out_uÆock_ä“
:

1989 
	`¥š_uÆock_œq
(&
sc¡_cm_lock
);

1990 
	`kä“
(
»s
);

1991 
»s
 = 
NULL
;

1992 
out
;

1993 
	}
}

1995 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 20)

1996 
	$£ss_cm_li¡_id_þ—nup_wÜk_â
(*
p
)

1998 
sc¡_£ssiÚ
 *
£ss
 = 
p
;

2000 
	$£ss_cm_li¡_id_þ—nup_wÜk_â
(
wÜk_¡ruù
 *
wÜk
)

2002 
sc¡_£ssiÚ
 *
£ss
 = 
	`cÚš”_of
(
wÜk
,

2003 
sc¡_£ssiÚ
, 
£ss_cm_li¡_id_þ—nup_wÜk
.
wÜk
);

2005 
sc¡_cm_li¡_id
 *
l
, *
t
;

2006 
cur_time
 = 
jiff›s
;

2007 
æags
;

2009 
	`TRACE_ENTRY
();

2016 
	`¥š_lock_œq§ve
(&
sc¡_cm_lock
, 
æags
);

2017 
	`li¡_fÜ_—ch_’Œy_§ã
(
l
, 
t
, &
£ss
->
£ss_cm_li¡_id_li¡
, 
£ss_cm_li¡_id_’Œy
) {

2018 ià(
l
->
cm_li¡_id_¡©e
 !ð
SCST_CM_LIST_ID_STATE_PENDING_FREE
)

2020 ià(
	`time_aá”_eq
(
cur_time
, 
l
->
cm_time_to_ä“
))

2021 
	`sc¡_cm_d–_ä“_li¡_id
(
l
, 
Œue
);

2023 
	`TRACE_DBG
("Reschedule…ending free†ist ids cleanup");

2024 
	`scheduË_d–ayed_wÜk
(&
£ss
->
£ss_cm_li¡_id_þ—nup_wÜk
,

2025 
l
->
cm_time_to_ä“
 - 
cur_time
);

2028 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_cm_lock
, 
æags
);

2030 
	`TRACE_EXIT
();

2032 
	}
}

2034 
	$sc¡_cm_ä“_³ndšg_li¡_ids
(
sc¡_£ssiÚ
 *
£ss
)

2036 
sc¡_cm_li¡_id
 *
l
, *
t
;

2038 
	`TRACE_ENTRY
();

2040 
	`ÿnûl_d–ayed_wÜk_sync
(&
£ss
->
£ss_cm_li¡_id_þ—nup_wÜk
);

2042 
	`¥š_lock_œq
(&
sc¡_cm_lock
);

2043 
	`li¡_fÜ_—ch_’Œy_§ã
(
l
, 
t
, &
£ss
->
£ss_cm_li¡_id_li¡
, 
£ss_cm_li¡_id_’Œy
) {

2044 
	`TRACE_DBG
("Li¡ id %p, s‹ %d", 
l
,†->
cm_li¡_id_¡©e
);

2045 ià(
l
->
cm_li¡_id_¡©e
 =ð
SCST_CM_LIST_ID_STATE_PENDING_FREE
)

2046 
	`sc¡_cm_d–_ä“_li¡_id
(
l
, 
Œue
);

2048 
	`¥š_uÆock_œq
(&
sc¡_cm_lock
);

2050 
	`TRACE_EXIT
();

2052 
	}
}

2054 
	$sc¡_cm_cÝy_¡©us
(
sc¡_cmd
 *
cmd
)

2056 
ssize_t
 
Ëngth
 = 0;

2057 
ušt8_t
 *
buf
, 
tbuf
[12];

2058 
li¡_id
;

2059 
sc¡_cm_li¡_id
 *
l
;

2060 
sc¡_£ssiÚ
 *
£ss
 = 
cmd
->sess;

2061 
boÞ
 
found
 = 
çl£
;

2063 
	`TRACE_ENTRY
();

2065 
li¡_id
 = 
cmd
->
cdb
[2];

2067 
	`¥š_lock_œq
(&
sc¡_cm_lock
);

2068 
	`li¡_fÜ_—ch_’Œy
(
l
, &
£ss
->
£ss_cm_li¡_id_li¡
, 
£ss_cm_li¡_id_’Œy
) {

2069 ià(
l
->
cm_lid
 =ð
li¡_id
) {

2070 
	`TRACE_DBG
("li¡ id %°found (id %d)", 
l
, 
li¡_id
);

2071 
found
 = 
Œue
;

2075 ià(
found
) {

2076 
l
->
cm_ÿn_be_immed_ä“
 = 1;

2078 
	`mem£t
(
tbuf
, 0, (tbuf));

2079 
	`put_uÇligÃd_be32
(8, &
tbuf
[0]);

2080 ià(
l
->
cm_li¡_id_¡©e
 =ð
SCST_CM_LIST_ID_STATE_ACTIVE
)

2081 
tbuf
[4] = 0;

2082 ià(
l
->
cm_¡©us
 == 0)

2083 
tbuf
[4] = 1;

2085 
tbuf
[4] = 2;

2086 
	`put_uÇligÃd_be16
(
l
->
cm_£gs_´oûs£d
, &
tbuf
[5]);

2087 
tbuf
[7] = 1;

2088 
	`put_uÇligÃd_be32
(
l
->
cm_wr™‹n_size
 >> 10, &
tbuf
[8]);

2090 ià(
l
->
cm_dÚe
)

2091 
	`sc¡_cm_d–_ä“_li¡_id
(
l
, 
Œue
);

2094 
l
 = 
NULL
;

2096 
	`¥š_uÆock_œq
(&
sc¡_cm_lock
);

2098 ià(!
found
)

2099 
out_li¡_id_nÙ_found
;

2101 
Ëngth
 = 
	`sc¡_g‘_buf_fuÎ_£n£
(
cmd
, &
buf
);

2102 ià(
	`uÆik–y
(
Ëngth
 <= 0))

2103 
out
;

2105 
Ëngth
 = 
	`mš_t
(, ()(
tbuf
),†ength);

2107 
	`memýy
(
buf
, 
tbuf
, 
Ëngth
);

2108 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
Ëngth
);

2110 
	`sc¡_put_buf_fuÎ
(
cmd
, 
buf
);

2112 
out
:

2113 
	`TRACE_EXIT
();

2116 
out_li¡_id_nÙ_found
:

2117 
	`TRACE_DBG
("li¡_id %d‚Ù found", 
li¡_id
);

2118 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 2, 0);

2119 
out
;

2120 
	}
}

2122 
	$sc¡_cm_çžed_£g_d‘ažs
(
sc¡_cmd
 *
cmd
)

2124 
ssize_t
 
Ëngth
 = 0;

2125 
ušt8_t
 *
buf
, *
tbuf
;

2126 
li¡_id
, 
size
;

2127 
sc¡_cm_li¡_id
 *
l
;

2128 
sc¡_£ssiÚ
 *
£ss
 = 
cmd
->sess;

2129 
boÞ
 
found
 = 
çl£
;

2131 
	`TRACE_ENTRY
();

2133 
li¡_id
 = 
cmd
->
cdb
[2];

2135 
size
 = 60 + 
SCST_SENSE_BUFFERSIZE
;

2137 
tbuf
 = 
	`kz®loc
(
size
, 
GFP_KERNEL
);

2138 ià(
tbuf
 =ð
NULL
) {

2139 
	`TRACE
(
TRACE_OUT_OF_MEM
, "Unableo‡llocate FAILED SEGMENTS "

2140 "DETAILS bufã¸(siz%d)", 
size
);

2141 
out_busy
;

2144 
	`¥š_lock_œq
(&
sc¡_cm_lock
);

2145 
	`li¡_fÜ_—ch_’Œy
(
l
, &
£ss
->
£ss_cm_li¡_id_li¡
, 
£ss_cm_li¡_id_’Œy
) {

2146 ià(
l
->
cm_lid
 =ð
li¡_id
) {

2147 
	`TRACE_DBG
("li¡ id %°found (id %d)", 
l
, 
li¡_id
);

2148 
found
 = 
Œue
;

2152 ià(
found
) {

2153 ià(
l
->
cm_li¡_id_¡©e
 =ð
SCST_CM_LIST_ID_STATE_ACTIVE
) {

2154 
found
 = 
çl£
;

2155 
sk
;

2158 ià((
cmd
->
bufæ’
 == 0) ||

2159 ((
l
->
cm_¡©us
 =ð0è&& (
cmd
->
bufæ’
 >= 60)) ||

2160 ((
l
->
cm_¡©us
 !ð0è&& (
cmd
->
bufæ’
 >ð60 + 
SCST_SENSE_BUFFERSIZE
)))

2161 
l
->
cm_ÿn_be_immed_ä“
 = 1;

2163 ià(
l
->
cm_¡©us
 == 0)

2164 
size
 = 60;

2166 
size
 = 60 + 
l
->
cm_£n£_Ën
;

2168 
	`TRACE_DBG
("È%p, stu %d, s’£_ËÀ%d, siz%d", 
l
,

2169 
l
->
cm_¡©us
,†->
cm_£n£_Ën
, 
size
);

2171 
	`put_uÇligÃd_be32
(
size
-3, &
tbuf
[0]);

2172 
tbuf
[56] = 
l
->
cm_¡©us
;

2173 
	`EXTRACHECKS_BUG_ON
(
l
->
cm_£n£_Ën
 > 
SCST_SENSE_BUFFERSIZE
);

2174 
	`BUILD_BUG_ON
((
l
->
cm_£n£
è!ð
SCST_SENSE_BUFFERSIZE
);

2175 
	`put_uÇligÃd_be16
(
l
->
cm_£n£_Ën
, &
tbuf
[58]);

2176 ià(
l
->
cm_£n£_Ën
 > 0)

2177 
	`memýy
(&
tbuf
[60], 
l
->
cm_£n£
,†->
cm_£n£_Ën
);

2179 ià(
l
->
cm_ÿn_be_immed_ä“
 &&†->
cm_dÚe
)

2180 
	`sc¡_cm_d–_ä“_li¡_id
(
l
, 
Œue
);

2183 
sk
:

2184 
l
 = 
NULL
;

2186 
	`¥š_uÆock_œq
(&
sc¡_cm_lock
);

2188 ià(!
found
)

2189 
out_li¡_id_nÙ_found
;

2191 
Ëngth
 = 
	`sc¡_g‘_buf_fuÎ_£n£
(
cmd
, &
buf
);

2192 ià(
	`uÆik–y
(
Ëngth
 <= 0))

2193 
out_ä“
;

2195 
Ëngth
 = 
	`mš_t
(, 
size
,†ength);

2197 
	`memýy
(
buf
, 
tbuf
, 
Ëngth
);

2198 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
Ëngth
);

2200 
	`sc¡_put_buf_fuÎ
(
cmd
, 
buf
);

2202 
out_ä“
:

2203 
	`kä“
(
tbuf
);

2205 
	`TRACE_EXIT
();

2208 
out_li¡_id_nÙ_found
:

2209 
	`TRACE_DBG
("li¡_id %d‚Ù found", 
li¡_id
);

2210 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 2, 0);

2211 
out_ä“
;

2213 
out_busy
:

2214 
	`sc¡_£t_busy
(
cmd
);

2215 
out_ä“
;

2216 
	}
}

2218 
	$sc¡_cm_Ý”_·¿m‘”s
(
sc¡_cmd
 *
cmd
)

2220 
ssize_t
 
Ëngth
 = 0;

2221 
ušt8_t
 *
buf
, 
tbuf
[44+2] ;

2223 
	`TRACE_ENTRY
();

2225 
	`mem£t
(
tbuf
, 0, (tbuf));

2228 
	`put_uÇligÃd_be32
((
tbuf
) - 4, &tbuf[0]);

2231 
tbuf
[4] = 1;

2234 
	`put_uÇligÃd_be16
(
SCST_CM_MAX_TGT_DESCR_CNT
, &
tbuf
[8]);

2237 
	`put_uÇligÃd_be16
(
SCST_CM_MAX_SEG_DESCR_CNT
, &
tbuf
[10]);

2240 
	`put_uÇligÃd_be32
(
SCST_MAX_SEG_DESC_LEN
, &
tbuf
[12]);

2243 
	`put_uÇligÃd_be32
(256*1024*1024, &
tbuf
[16]);

2248 
	`put_uÇligÃd_be16
(0xFFFF, &
tbuf
[34]);

2251 
tbuf
[36] = 0xFF;

2254 
tbuf
[37] = 16;

2257 
tbuf
[43] = 2;

2260 
tbuf
[44] = 2;

2261 
tbuf
[45] = 0xE4;

2263 
Ëngth
 = 
	`sc¡_g‘_buf_fuÎ_£n£
(
cmd
, &
buf
);

2264 ià(
	`uÆik–y
(
Ëngth
 <= 0))

2265 
out
;

2267 
Ëngth
 = 
	`mš_t
(, ()(
tbuf
),†ength);

2269 
	`memýy
(
buf
, 
tbuf
, 
Ëngth
);

2270 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
Ëngth
);

2272 
	`sc¡_put_buf_fuÎ
(
cmd
, 
buf
);

2274 
out
:

2275 
	`TRACE_EXIT
();

2277 
	}
}

2279 
	$sc¡_cm_rcv_cÝy_»s_exec
(
sc¡_cmd
 *
cmd
)

2281 
»s
 = 
SCST_EXEC_COMPLETED
, 
aùiÚ
;

2283 
	`TRACE_ENTRY
();

2285 
aùiÚ
 = 
cmd
->
cdb
[1] & 0x1F;

2287 
aùiÚ
) {

2289 
	`sc¡_cm_cÝy_¡©us
(
cmd
);

2292 
	`sc¡_cm_Ý”_·¿m‘”s
(
cmd
);

2295 
	`sc¡_cm_çžed_£g_d‘ažs
(
cmd
);

2298 
	`TRACE
(
TRACE_MINOR
, "%s:‡ùiÚ %d‚Ù suµÜ‹d", 
cmd
->
Ý_Çme
,

2299 
aùiÚ
);

2300 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 1,

2301 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 0);

2305 
cmd
->
com¶‘ed
 = 1;

2306 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_THREAD
);

2308 
	`TRACE_EXIT_RES
(
»s
);

2309  
»s
;

2310 
	}
}

2312 
	ssc¡_cm_š™_šq_´iv
 {

2314 
sc¡_i_fšish_â_t
 
	mcm_š™_šq_fšish_â
;

2316 
sc¡_deviû
 *
	mdev
;

2319 
sc¡_cm_£nd_š™_šquœy
(
sc¡_deviû
 *
dev
,

2320 
uÅacked_lun
, 
sc¡_cm_š™_šq_´iv
 *
´iv
);

2322 
	$sc¡_cm_šq_»Œy_â
(
sc¡_cmd
 *
cmd
)

2324 
sc¡_cm_š™_šq_´iv
 *
´iv
 = 
cmd
->
tgt_i_´iv
;

2326 
	`TRACE_ENTRY
();

2330 
	`sc¡_cm_£nd_š™_šquœy
(
´iv
->
dev
, 
cmd
->
lun
,…riv);

2332 
	`TRACE_EXIT
();

2334 
	}
}

2336 
	$sc¡_cm_š™_šq_fšish
(
sc¡_cmd
 *
cmd
)

2338 
Ëngth
, 
·ge_Ën
, 
off
, 
rc
;

2339 
ušt8_t
 *
buf
;

2340 
sc¡_cm_š™_šq_´iv
 *
´iv
 = 
cmd
->
tgt_i_´iv
;

2341 
sc¡_deviû
 *
dev
 = 
´iv
->dev;

2343 
	`TRACE_ENTRY
();

2347 
rc
 = 
	`sc¡_cm_”r_check_»Œy
(
cmd
, cmd->
¡¬t_time
, 
sc¡_cm_šq_»Œy_â
);

2348 ià(
rc
 =ð
SCST_CM_STATUS_RETRY
)

2349 
out
;

2351 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

2352 
	`sc¡_unblock_dev
(
dev
);

2353 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

2355 
	`kä“
(
´iv
);

2356 
´iv
 = 
NULL
;

2357 
cmd
->
tgt_i_´iv
 = 
NULL
;

2359 ià(
rc
 !ð
SCST_CM_STATUS_CMD_SUCCEEDED
) {

2360 
	`PRINT_CRIT_ERROR
("Unableo…erform initial INQUIRY for device "

2362 
dev
->
vœt_Çme
);

2363 
out
;

2366 
Ëngth
 = 
	`sc¡_g‘_buf_fuÎ
(
cmd
, &
buf
);

2367 
	`TRACE_DBG
("Ëngth %d", 
Ëngth
);

2368 ià(
	`uÆik–y
(
Ëngth
 <= 0)) {

2369 ià(
Ëngth
 < 0)

2370 
	`PRINT_ERROR
("sc¡_g‘_buf_fuÎ(èçžed: %d", 
Ëngth
);

2371 
out
;

2374 
	`TRACE_BUFF_FLAG
(
TRACE_DEBUG
, "buf", 
buf
, 
Ëngth
);

2376 ià(
buf
[0] != 0) {

2377 
	`TRACE
(
TRACE_MINOR
, "NÙ suµÜ‹d devy³ %x, ignÜšg", 
buf
[0]);

2378 
out_put
;

2381 ià(
buf
[1] != 0x83) {

2382 
	`PRINT_WARNING
("IncÜ»ù…agcod%x, ignÜšg", 
buf
[1]);

2383 
out_put
;

2386 
·ge_Ën
 = 
	`g‘_uÇligÃd_be16
(&
buf
[2]);

2387 ià(
·ge_Ën
+3 > 
cmd
->
»¥_d©a_Ën
) {

2388 
	`PRINT_WARNING
("Page†en (%d) doesn't match„esp†en (%d), ignoring",

2389 
·ge_Ën
+3, 
cmd
->
»¥_d©a_Ën
);

2390 
out_put
;

2393 
off
 = 4;

2394 
off
 < 
·ge_Ën
) {

2395 
des_Ën
, 
des_®loc_Ën
;

2396 
sc¡_cm_desig
 *
des
;

2398 ià(
off
 + 3 >ð
·ge_Ën
) {

2399 
	`PRINT_WARNING
("Too small…age†en %d, (off %d), ignoring",

2400 
·ge_Ën
, 
off
);

2401 
out_put
;

2404 
des_Ën
 = 
buf
[
off
 + 3];

2405 ià((
off
 + 
des_Ën
è> 
·ge_Ën
) {

2406 
	`PRINT_WARNING
("Too small buf†en %d (off %d, des_len %d), "

2407 "ignÜšg", 
·ge_Ën
, 
off
, 
des_Ën
);

2408 
out_put
;

2411 
des_Ën
 += 4;

2413 ià(((
buf
[
off
] & 0xF0) != 0) || ((buf[off+1] & 0xF0) != 0)) {

2414 
	`TRACE_DBG
("Unsupported designator (%x, %x), "

2415 "ignÜšg", 
buf
[
off
] & 0xF0, buf[off+1] & 0xF0);

2416 
Ãxt
;

2419 
des_®loc_Ën
 = (*
des
è+ 
des_Ën
;

2420 
des
 = 
	`kz®loc
(
des_®loc_Ën
, 
GFP_KERNEL
);

2421 ià(
des
 =ð
NULL
) {

2422 
	`PRINT_CRIT_ERROR
("Unableo‡llocate designator (len %d, "

2423 "ty³ %x), ignÜšg it", 
des_®loc_Ën
,

2424 
buf
[
off
+1] & 0xF);

2425 
out_put
;

2428 
des
->
desig_tgt_dev
 = 
cmd
->
tgt_dev
;

2430 
des
->
desig_Ën
 = 
des_Ën
;

2431 
	`memýy
(
des
->
desig
, &
buf
[
off
], 
des_Ën
);

2433 
	`TRACE_DBG
("de %p,†’ %d", 
des
, des->
desig_Ën
);

2434 
	`TRACE_BUFF_FLAG
(
TRACE_DEBUG
, "des", 
des
->
desig
, des->
desig_Ën
);

2436 
	`mu‹x_lock
(&
sc¡_cm_mu‹x
);

2437 
	`li¡_add_ž
(&
des
->
cm_desig_li¡_’Œy
, &
sc¡_cm_desig_li¡
);

2438 
	`mu‹x_uÆock
(&
sc¡_cm_mu‹x
);

2439 
Ãxt
:

2440 
off
 +ð
des_Ën
;

2441 
	`TRACE_DBG
("ofà%d", 
off
);

2444 
out_put
:

2445 
	`sc¡_put_buf_fuÎ
(
cmd
, 
buf
);

2447 
out
:

2448 
	`TRACE_EXIT
();

2450 
	}
}

2452 
	$sc¡_cm_£nd_š™_šquœy
(
sc¡_deviû
 *
dev
,

2453 
uÅacked_lun
, 
sc¡_cm_š™_šq_´iv
 *
´iv
)

2455 
»s
;

2456 cÚ¡ 
ušt8_t
 
šq_cdb
[6] = { 
INQUIRY
, 1, 0x83, 0x10, 0, 0 };

2457 
__be64
 
lun
;

2458 
sc¡_cmd
 *
cmd
;

2460 
	`TRACE_ENTRY
();

2462 ià(
´iv
 =ð
NULL
) {

2463 
´iv
 = 
	`kz®loc
((*´iv), 
GFP_KERNEL
);

2464 ià(
´iv
 =ð
NULL
) {

2465 
	`PRINT_ERROR
("Unableo‡lloc…riv");

2466 
»s
 = -
ENOMEM
;

2467 
out
;

2469 
´iv
->
cm_š™_šq_fšish_â
 = 
sc¡_cm_š™_šq_fšish
;

2470 
´iv
->
dev
 = dev;

2473 
lun
 = 
	`sc¡_·ck_lun
(
uÅacked_lun
, 
sc¡_cm_£ss
->
acg
->
addr_m‘hod
);

2475 
cmd
 = 
	`sc¡_rx_cmd
(
sc¡_cm_£ss
, (cÚ¡ 
ušt8_t
 *)&
lun
,

2476 (
lun
), 
šq_cdb
, (šq_cdb), 
çl£
);

2477 ià(
cmd
 =ð
NULL
) {

2478 
»s
 = -
ENOMEM
;

2479 
out_ä“
;

2482 
	`sc¡_cmd_£t_ex³ùed
(
cmd
, 
SCST_DATA_READ
, 4096);

2483 
	`sc¡_cmd_£t_queue_ty³
(
cmd
, 
SCST_CMD_QUEUE_HEAD_OF_QUEUE
);

2484 
	`sc¡_cmd_£t_tgt_´iv
(
cmd
, 
´iv
);

2486 
cmd
->
by·ss_blockšg
 = 1;

2488 
	`sc¡_cmd_š™_dÚe
(
cmd
, 
SCST_CONTEXT_THREAD
);

2490 
»s
 = 0;

2492 
out
:

2493 
	`TRACE_EXIT_RES
(
»s
);

2494  
»s
;

2496 
out_ä“
:

2497 
	`kä“
(
´iv
);

2498 
out
;

2499 
	}
}

2502 
boÞ
 
	$sc¡_cm_is_lun_ä“
(
lun
)

2504 
boÞ
 
»s
 = 
Œue
;

2505 
li¡_h—d
 *
h—d
 = &
sc¡_cm_£ss
->
£ss_tgt_dev_li¡
[
	`SESS_TGT_DEV_LIST_HASH_FN
(
lun
)];

2506 
sc¡_tgt_dev
 *
tgt_dev
;

2508 
	`TRACE_ENTRY
();

2510 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
, 
£ss_tgt_dev_li¡_’Œy
) {

2511 ià(
tgt_dev
->
lun
 ==†un) {

2512 
»s
 = 
çl£
;

2517 
	`TRACE_EXIT_RES
(
»s
);

2518  
»s
;

2519 
	}
}

2522 
	$sc¡_cm_dev_»gi¡”
(
sc¡_deviû
 *
dev
, 
ušt64_t
 
lun
)

2524 
»s
, 
i
;

2525 
sc¡_acg_dev
 *
acg_dev
;

2526 
boÞ
 
add_lun
;

2528 
	`TRACE_ENTRY
();

2530 
	`TRACE_DBG
("dev %s, LUN %ld", 
dev
->
vœt_Çme
, ()
lun
);

2532 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

2533 
sc¡_tgt_dev
 *
tgt_dev
;

2534 
li¡_h—d
 *
h—d
 = &
sc¡_cm_£ss
->
£ss_tgt_dev_li¡
[
i
];

2536 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
, 
£ss_tgt_dev_li¡_’Œy
) {

2537 ià(
tgt_dev
->
dev
 == dev) {

2538 
	`PRINT_ERROR
("Copy Manager‡lready„egistered "

2539 "deviû %s", 
dev
->
vœt_Çme
);

2540 
»s
 = -
EEXIST
;

2541 
out
;

2546 ià(
lun
 =ð
SCST_MAX_LUN
) {

2547 
add_lun
 = 
Œue
;

2549 
lun
 = 
sc¡_cm_Ãxt_lun
++;

2550 ià(
lun
 =ð
SCST_MAX_LUN
)

2552 ià(
	`sc¡_cm_is_lun_ä“
(
lun
))

2556 
add_lun
 = 
çl£
;

2558 ià(
add_lun
) {

2559 
»s
 = 
	`sc¡_acg_add_lun
(
sc¡_cm_tgt
->
deçuÉ_acg
,

2560 
sc¡_cm_tgt
->
tgt_luns_kobj
, 
dev
, 
lun
, 
SCST_ADD_LUN_CM
,

2561 &
acg_dev
);

2562 ià(
»s
 != 0)

2563 
out_”r
;

2566 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

2567 
	`sc¡_block_dev
(
dev
);

2568 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

2570 
»s
 = 
	`sc¡_cm_£nd_š™_šquœy
(
dev
, 
lun
, 
NULL
);

2571 ià(
»s
 != 0)

2572 
out_unblock
;

2574 
out
:

2575 
	`TRACE_EXIT_RES
(
»s
);

2576  
»s
;

2578 
out_unblock
:

2579 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

2580 
	`sc¡_unblock_dev
(
dev
);

2581 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

2582 
	`sc¡_acg_d–_lun
(
sc¡_cm_tgt
->
deçuÉ_acg
, 
lun
, 
çl£
);

2584 
out_”r
:

2585 
sc¡_cm_Ãxt_lun
--;

2586 
out
;

2587 
	}
}

2590 
	$sc¡_cm_dev_uÄegi¡”
(
sc¡_deviû
 *
dev
, 
boÞ
 
d–_lun
)

2592 
i
;

2593 
sc¡_cm_desig
 *
des
, *
t
;

2595 
	`TRACE_ENTRY
();

2597 
	`TRACE_DBG
("dev %s, d–_luÀ%d", 
dev
->
vœt_Çme
, 
d–_lun
);

2599 
	`li¡_fÜ_—ch_’Œy_§ã
(
des
, 
t
, &
sc¡_cm_desig_li¡
, 
cm_desig_li¡_’Œy
) {

2600 ià(
des
->
desig_tgt_dev
->
dev
 == dev) {

2601 
	`TRACE_DBG
("D–‘šg de %p", 
des
);

2602 
	`li¡_d–
(&
des
->
cm_desig_li¡_’Œy
);

2603 
	`kä“
(
des
);

2607 ià(!
d–_lun
)

2608 
out
;

2610 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

2611 
sc¡_tgt_dev
 *
tgt_dev
;

2612 
li¡_h—d
 *
h—d
 = &
sc¡_cm_£ss
->
£ss_tgt_dev_li¡
[
i
];

2614 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
, 
£ss_tgt_dev_li¡_’Œy
) {

2615 ià(
tgt_dev
->
dev
 == dev) {

2616 
	`sc¡_acg_d–_lun
(
sc¡_cm_tgt
->
deçuÉ_acg
,

2617 
tgt_dev
->
lun
, 
çl£
);

2623 
out
:

2624 
	`TRACE_EXIT
();

2626 
	}
}

2629 
	$sc¡_cm_Ú_dev_»gi¡”
(
sc¡_deviû
 *
dev
)

2631 
»s
 = 0;

2633 
	`TRACE_ENTRY
();

2635 ià(!
dev
->
hªdËr
->
auto_cm_assignm’t_possibË
)

2636 
out
;

2638 
»s
 = 
	`sc¡_cm_dev_»gi¡”
(
dev
, 
SCST_MAX_LUN
);

2640 
out
:

2641 
	`TRACE_EXIT_RES
(
»s
);

2642  
»s
;

2643 
	}
}

2646 
	$sc¡_cm_Ú_dev_uÄegi¡”
(
sc¡_deviû
 *
dev
)

2648 
	`TRACE_ENTRY
();

2650 
	`sc¡_cm_dev_uÄegi¡”
(
dev
, 
Œue
);

2652 
	`TRACE_EXIT
();

2654 
	}
}

2657 
	$sc¡_cm_Ú_add_acg
(
sc¡_acg
 *
acg
)

2659 
»s
 = 0;

2661 
	`TRACE_ENTRY
();

2663 ià(
sc¡_cm_tgt
 =ð
NULL
)

2664 
out
;

2666 ià(
acg
->
tgt
 !ð
sc¡_cm_tgt
)

2667 
out
;

2669 ià(
acg
 !ð
sc¡_cm_tgt
->
deçuÉ_acg
) {

2670 
	`PRINT_ERROR
("Copy Manager does‚ot support security groups");

2671 
»s
 = -
EINVAL
;

2672 
out
;

2675 
out
:

2676 
	`TRACE_EXIT_RES
(
»s
);

2677  
»s
;

2678 
	}
}

2681 
	$sc¡_cm_Ú_d–_acg
(
sc¡_acg
 *
acg
)

2684 
	}
}

2687 
	$sc¡_cm_Ú_add_lun
(
sc¡_acg_dev
 *
acg_dev
, 
ušt64_t
 
lun
,

2688 *
æags
)

2690 
»s
 = 0;

2692 
	`TRACE_ENTRY
();

2694 ià(
acg_dev
->
acg
 !ð
sc¡_cm_tgt
->
deçuÉ_acg
)

2695 
out
;

2697 ià(
acg_dev
->
acg_dev_rd_Úly
 ||‡cg_dev->
dev
->
dev_rd_Úly
) {

2698 
	`PRINT_ERROR
("Copy Manager does‚ot support„ead only devices");

2699 
»s
 = -
EINVAL
;

2700 
out
;

2703 *
æags
 &ð~
SCST_ADD_LUN_GEN_UA
;

2705 
»s
 = 
	`sc¡_cm_dev_»gi¡”
(
acg_dev
->
dev
, 
lun
);

2707 
out
:

2708 
	`TRACE_EXIT_RES
(
»s
);

2709  
»s
;

2710 
	}
}

2713 
boÞ
 
	$sc¡_cm_Ú_d–_lun
(
sc¡_acg_dev
 *
acg_dev
, 
boÞ
 
g’_»pÜt_luns_chªged
)

2715 
boÞ
 
»s
 = 
g’_»pÜt_luns_chªged
;

2717 
	`TRACE_ENTRY
();

2719 ià(
acg_dev
->
acg
 !ð
sc¡_cm_tgt
->
deçuÉ_acg
)

2720 
out
;

2722 
	`sc¡_cm_dev_uÄegi¡”
(
acg_dev
->
dev
, 
çl£
);

2724 
»s
 = 
çl£
;

2726 
out
:

2727 
	`TRACE_EXIT_RES
(
»s
);

2728  
»s
;

2729 
	}
}

2732 
boÞ
 
	$sc¡_cm_check_acûss_acg
(cÚ¡ *
š™ŸtÜ_Çme
,

2733 cÚ¡ 
sc¡_deviû
 *
dev
, cÚ¡ 
sc¡_acg
 *
acg
,

2734 
boÞ
 
deçuÉ_acg
)

2736 
boÞ
 
»s
 = 
Œue
;

2737 
sc¡_acg_dev
 *
acg_dev
;

2739 
	`TRACE_ENTRY
();

2741 
	`li¡_fÜ_—ch_’Œy
(
acg_dev
, &
acg
->
acg_dev_li¡
, 
acg_dev_li¡_’Œy
) {

2742 ià(
acg_dev
->
dev
 == dev) {

2743 
sc¡_aú
 *
aú
;

2745 ià(
deçuÉ_acg
)

2746 
found
;

2747 
	`li¡_fÜ_—ch_’Œy
(
aú
, &
acg
->
aú_li¡
, 
aú_li¡_’Œy
) {

2748 ià(
	`¡rcmp
(
aú
->
Çme
, 
š™ŸtÜ_Çme
) == 0)

2749 
found
;

2754 
»s
 = 
çl£
;

2756 
found
:

2757 
	`TRACE_EXIT_RES
(
»s
);

2758  
»s
;

2759 
	}
}

2761 
boÞ
 
	$sc¡_cm_check_acûss
(cÚ¡ *
š™ŸtÜ_Çme
,

2762 cÚ¡ 
sc¡_deviû
 *
dev
, 
boÞ
 *
»ad_Úly
)

2764 
boÞ
 
»s
 = 
Œue
;

2765 
sc¡_tgt_‹m¶©e
 *
tg‰
;

2767 
	`TRACE_ENTRY
();

2769 ià(
sc¡_cm_®low_nÙ_cÚÃùed_cÝy
)

2770 
out_rd_Úly
;

2779 
	`mu‹x_lock
(&
sc¡_mu‹x2
);

2781 
	`li¡_fÜ_—ch_’Œy
(
tg‰
, &
sc¡_‹m¶©e_li¡
, 
sc¡_‹m¶©e_li¡_’Œy
) {

2782 
sc¡_tgt
 *
tgt
;

2784 
	`li¡_fÜ_—ch_’Œy
(
tgt
, &
tg‰
->
tgt_li¡
, 
tgt_li¡_’Œy
) {

2785 
sc¡_acg
 *
acg
;

2787 ià(
tgt
 =ð
sc¡_cm_tgt
)

2790 
	`TRACE_DBG
("Checkšggˆ%s", 
tgt
->
tgt_Çme
);

2792 ià(
	`sc¡_cm_check_acûss_acg
(
š™ŸtÜ_Çme
, 
dev
, 
tgt
->
deçuÉ_acg
, 
Œue
))

2793 
out_uÆock_rd_Úly
;

2795 
	`li¡_fÜ_—ch_’Œy
(
acg
, &
tgt
->
tgt_acg_li¡
, 
acg_li¡_’Œy
) {

2796 ià(
	`sc¡_cm_check_acûss_acg
(
š™ŸtÜ_Çme
, 
dev
, 
acg
, 
çl£
))

2797 
out_uÆock_rd_Úly
;

2802 
»s
 = 
çl£
;

2803 
	`PRINT_WARNING
("Initiator %s‚ot‡llowedo use device %s in EXTENDED "

2804 "COPY commªd", 
š™ŸtÜ_Çme
, 
dev
->
vœt_Çme
);

2806 
out_uÆock_rd_Úly
:

2807 
	`mu‹x_uÆock
(&
sc¡_mu‹x2
);

2809 
out_rd_Úly
:

2810 *
»ad_Úly
 = 
dev
->
dev_rd_Úly
 || dev->
swp
;

2812 
	`TRACE_EXIT_RES
(
»s
);

2813  
»s
;

2814 
	}
}

2816 
	ssc¡_cm_tgt_desü
 {

2817 
sc¡_tgt_dev
 *
	mtgt_dev
;

2818 
	m»ad_Úly
:1;

2819 
	m·¿m_offs
;

2822 
	$sc¡_cm_·r£_id_tgt_desü
(
sc¡_cmd
 *
cmd
, cÚ¡ 
ušt8_t
 *
£g
,

2823 
offs
, 
sc¡_cm_tgt_desü
 *
tgt_desü
)

2825 
»s
 = 32;

2826 
sc¡_cm_desig
 *
des
;

2827 
block
;

2828 
boÞ
 
»ad_Úly
 = 
çl£
;

2830 
	`TRACE_ENTRY
();

2832 
	`TRACE_BUFF_FLAG
(
TRACE_DEBUG
, "£g", 
£g
, 32);

2834 
	`EXTRACHECKS_BUG_ON
(
£g
[0] != 0xE4);

2836 ià((
£g
[1] & 0xC0) != 0) {

2837 
	`PRINT_WARNING
("LU ID %x‚Ù suµÜ‹d", 
£g
[1] & 0xC0);

2838 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 
offs
+1,

2839 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 6);

2840 
out_”r
;

2843 ià((
£g
[1] & 0x20) != 0) {

2844 
	`TRACE_DBG
("NULLgt descriptor");

2845 
tgt_desü
->
tgt_dev
 = 
NULL
;

2846 
out
;

2849 ià((
£g
[1] & 0xF) != 0) {

2850 
	`PRINT_WARNING
("PERIPHERAL DEVICE TYPE %d‚ot supported",

2851 
£g
[1] & 0xF);

2852 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 
offs
+1,

2853 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 0);

2854 
out_”r
;

2857 
block
 = 
	`g‘_uÇligÃd_be24
(&
£g
[29]);

2859 
	`mu‹x_lock
(&
sc¡_cm_mu‹x
);

2863 
	`li¡_fÜ_—ch_’Œy
(
des
, &
sc¡_cm_desig_li¡
, 
cm_desig_li¡_’Œy
) {

2864 
	`TRACE_DBG
("de %°Ñgt_dev %p,†uÀ%Îd)", 
des
, des->
desig_tgt_dev
,

2865 ()
des
->
desig_tgt_dev
->
lun
);

2866 ià(
£g
[4] !ð
des
->
desig
[0])

2868 ià(
£g
[5] !ð
des
->
desig
[1])

2870 ià(
£g
[7] > 
des
->
desig
[3])

2872 ià(
	`memcmp
(&
des
->
desig
[4], &
£g
[8], 
	`mš_t
(, seg[7], des->desig[3])) == 0) {

2873 
	`TRACE_DBG
("Tgt_dev %p (lun %lld) found",

2874 
des
->
desig_tgt_dev
,

2875 ()
des
->
desig_tgt_dev
->
lun
);

2877 
	`mu‹x_uÆock
(&
sc¡_cm_mu‹x
);

2879 ià(
block
 !ð
des
->
desig_tgt_dev
->
dev
->
block_size
) {

2880 
	`PRINT_WARNING
("Block siz%d dÛ¢'ˆm©ch %d", 
block
,

2881 
des
->
desig_tgt_dev
->
dev
->
block_size
);

2882 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 
offs
+29, 0);

2883 
out_”r
;

2886 ià(!
	`sc¡_cm_check_acûss
(
cmd
->
£ss
->
š™ŸtÜ_Çme
,

2887 
des
->
desig_tgt_dev
->
dev
, &
»ad_Úly
))

2888 
out_nÙ_found
;

2890 
tgt_desü
->
tgt_dev
 = 
des
->
desig_tgt_dev
;

2891 
tgt_desü
->
»ad_Úly
 =„ead_only;

2892 
	`TRACE_DBG
("Found des %p (tgt_dev %p,„ead_only %d)",

2893 
des
, 
tgt_desü
->
tgt_dev
,gt_desü->
»ad_Úly
);

2894 
out
;

2898 
	`mu‹x_uÆock
(&
sc¡_cm_mu‹x
);

2900 
	`TRACE
(
TRACE_MINOR
|
TRACE_SCSI
, "Target descriptor designator‚ot found "

2901 "(š™ŸtÜ %s, off %d)", 
cmd
->
£ss
->
š™ŸtÜ_Çme
, 
offs
);

2902 
	`TRACE_BUFF_FLAG
(
TRACE_MINOR
|
TRACE_SCSI
, "DesigÇtÜ", 
£g
, 32);

2904 
out_nÙ_found
:

2905 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 
offs
, 0);

2907 
out_”r
:

2908 
»s
 = -1;

2910 
out
:

2911 
	`TRACE_EXIT_RES
(
»s
);

2912  
»s
;

2913 
	}
}

2915 
	$sc¡_cm_£t_£g_”r_£n£
(
sc¡_cmd
 *
cmd
, 
asc
, 
ascq
,

2916 
£g_num
, 
offs
)

2918 
»s
, 
d_£n£
 = 
	`sc¡_g‘_cmd_dev_d_£n£
(
cmd
);

2920 
	`TRACE_ENTRY
();

2922 
	`TRACE_DBG
("cmd %p, seg %d, off %d (d_£n£ %d)", 
cmd
, 
£g_num
, 
offs
,

2923 
d_£n£
);

2925 
»s
 = 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_CHECK_CONDITION
);

2926 ià(
»s
 != 0)

2927 
out
;

2929 
»s
 = 
	`sc¡_®loc_£n£
(
cmd
, 1);

2930 ià(
»s
 != 0) {

2931 
	`PRINT_ERROR
("Lost COPY ABORTED sense data");

2932 
out
;

2935 
	`sBUG_ON
(
cmd
->
£n£_buæ’
 < 18);

2936 
	`BUILD_BUG_ON
(
SCST_SENSE_BUFFERSIZE
 < 18);

2938 ià(
d_£n£
) {

2940 
cmd
->
£n£
[0] = 0x72;

2941 
cmd
->
£n£
[1] = 
COPY_ABORTED
;

2942 
cmd
->
£n£
[2] = 
asc
;

2943 
cmd
->
£n£
[3] = 
ascq
;

2944 
cmd
->
£n£
[7] = 20;

2946 
cmd
->
£n£
[8] = 1;

2947 
cmd
->
£n£
[9] = 0x0A;

2948 
	`put_uÇligÃd_be16
(
£g_num
, &
cmd
->
£n£
[14]);

2950 
cmd
->
£n£
[20] = 2;

2951 
cmd
->
£n£
[21] = 6;

2952 
cmd
->
£n£
[24] = 0xA0;

2953 
	`put_uÇligÃd_be16
(
offs
, &
cmd
->
£n£
[25]);

2955 
cmd
->
£n£_v®id_Ën
 = 28;

2958 
cmd
->
£n£
[0] = 0x70;

2959 
cmd
->
£n£
[2] = 
COPY_ABORTED
;

2960 
cmd
->
£n£
[7] = 0x0a;

2961 
cmd
->
£n£
[12] = 
asc
;

2962 
cmd
->
£n£
[13] = 
ascq
;

2964 
	`put_uÇligÃd_be16
(
£g_num
, &
cmd
->
£n£
[10]);

2966 
cmd
->
£n£
[15] = 0xA0;

2967 
	`put_uÇligÃd_be16
(
offs
, &
cmd
->
£n£
[16]);

2969 
cmd
->
£n£_v®id_Ën
 = 18;

2972 
	`TRACE_BUFFER
("S’£ s‘", 
cmd
->
£n£
, cmd->
£n£_v®id_Ën
);

2974 
out
:

2975 
	`TRACE_EXIT_RES
(
»s
);

2976  
»s
;

2977 
	}
}

2979 
	$sc¡_cm_çÁom_cmd_fšished
(
sc¡_cmd
 *
cmd
)

2981 
	`TRACE_ENTRY
();

2983 
	`TRACE_DBG
("Fªtom cmd %p", 
cmd
);

2985 
	`EXTRACHECKS_BUG_ON
(!
cmd
->
š‹º®
);

2989 
	`TRACE_EXIT
();

2991 
	}
}

2993 
	$sc¡_cm_add_to_desü_li¡
(
sc¡_cmd
 *
ec_cmd
,

2994 
sc¡_tgt_dev
 *
tgt_dev
)

2996 
»s
;

2997 
sc¡_cm_ec_cmd_´iv
 *
´iv
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

2998 
sc¡_cm_dev_’Œy
 *
e
, *
t
;

2999 
sc¡_cmd
 *
fcmd
;

3000 
boÞ
 
added
;

3002 
	`TRACE_ENTRY
();

3005 
	`li¡_fÜ_—ch_’Œy
(
e
, &
´iv
->
cm_sÜ‹d_devs_li¡
, 
cm_sÜ‹d_devs_li¡_’Œy
) {

3006 ià(
e
->
cm_fcmd
->
dev
 =ð
tgt_dev
->dev) {

3007 
	`TRACE_DBG
("Dev %p is‡lready in cm_sorted_devs_list",

3008 
tgt_dev
->
dev
);

3009 
out_sucûss
;

3013 
e
 = 
	`kz®loc
((*e), 
GFP_KERNEL
);

3014 ià(
e
 =ð
NULL
) {

3015 
	`PRINT_ERROR
("Unableo‡llocate scst_cm_dev_entry (size %d)",

3016 ()(*
e
));

3017 
out_’omem
;

3020 ià(
ec_cmd
->
dev
 =ð
tgt_dev
->dev) {

3021 
fcmd
 = 
ec_cmd
;

3022 
sk_fcmd_ü—‹
;

3025 
fcmd
 = 
	`__sc¡_ü—‹_´•¬e_š‹º®_cmd
(
ec_cmd
->
cdb
,

3026 
ec_cmd
->
cdb_Ën
, 
SCST_CMD_QUEUE_SIMPLE
, 
tgt_dev
,

3027 
GFP_KERNEL
, 
Œue
);

3028 ià(
fcmd
 =ð
NULL
) {

3029 
out_’omem_ä“_e
;

3032 
fcmd
->
ex³ùed_d©a_dœeùiÚ
 = 
ec_cmd
->expected_data_direction;

3033 
fcmd
->
ex³ùed_Œªsãr_Ën_fuÎ
 = 
ec_cmd
->expected_transfer_len_full;

3034 
fcmd
->
ex³ùed_v®ues_£t
 = 1;

3036 
fcmd
->
cmd_d©a_desütÜs
 = 
ec_cmd
->cmd_data_descriptors;

3037 
fcmd
->
cmd_d©a_desütÜs_út
 = 
ec_cmd
->cmd_data_descriptors_cnt;

3039 
fcmd
->
¡©e
 = 
SCST_CMD_STATE_EXEC_CHECK_BLOCKING
;

3041 
»s
 = 
	`sc¡_cm_add_to_š‹º®_cmd_li¡
(
fcmd
, 
ec_cmd
,ƒc_cmd,

3042 
sc¡_cm_çÁom_cmd_fšished
);

3043 ià(
»s
 != 0)

3044 
out_ä“_cmd
;

3046 
sk_fcmd_ü—‹
:

3047 
	`TRACE_DBG
("ec_cmd %p,ƒ %p, fcmd %p,gt_dev %°(dev %p)", 
ec_cmd
, 
e
, 
fcmd
,

3048 
tgt_dev
,gt_dev->
dev
);

3050 
e
->
cm_fcmd
 = 
fcmd
;

3052 
added
 = 
çl£
;

3053 
	`li¡_fÜ_—ch_’Œy_»v”£
(
t
, &
´iv
->
cm_sÜ‹d_devs_li¡
, 
cm_sÜ‹d_devs_li¡_’Œy
) {

3054 
	`EXTRACHECKS_BUG_ON
(
t
->
cm_fcmd
->
dev
 =ð
tgt_dev
->dev);

3055 ià((()
e
->
cm_fcmd
->
dev
è> (()
t
->cm_fcmd->dev)) {

3056 
	`__li¡_add
(&
e
->
cm_sÜ‹d_devs_li¡_’Œy
,

3057 &
t
->
cm_sÜ‹d_devs_li¡_’Œy
,

3058 
t
->
cm_sÜ‹d_devs_li¡_’Œy
.
Ãxt
);

3059 
added
 = 
Œue
;

3063 ià(!
added
)

3064 
	`li¡_add
(&
e
->
cm_sÜ‹d_devs_li¡_’Œy
,

3065 &
´iv
->
cm_sÜ‹d_devs_li¡
);

3067 #ià
	`defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_EXTRACHECKS
)

3069 
sc¡_cm_dev_’Œy
 *

 = 
NULL
;

3071 
	`li¡_fÜ_—ch_’Œy
(
t
, &
´iv
->
cm_sÜ‹d_devs_li¡
, 
cm_sÜ‹d_devs_li¡_’Œy
) {

3072 
	`TRACE_DBG
("ˆ%p, cm dev %p", 
t
,->
cm_fcmd
->
dev
);

3073 ià(

 !ð
NULL
) {

3074 ià((()
t
->
cm_fcmd
->
dev
è<ð(()

->cm_fcmd->dev)) {

3075 
	`li¡_fÜ_—ch_’Œy
(
t
, &
´iv
->
cm_sÜ‹d_devs_li¡
, 
cm_sÜ‹d_devs_li¡_’Œy
) {

3076 
	`´štk
(
KERN_EMERG
 "%s: %p, cm dev %p\n", 
__func__
,

3077 
t
,->
cm_fcmd
->
dev
);

3079 
	`sBUG
();

3082 

 = 
t
;

3084 

 = 
t
;

3089 
out_sucûss
:

3090 
»s
 = 0;

3092 
out
:

3093 
	`TRACE_EXIT_RES
(
»s
);

3094  
»s
;

3096 
out_ä“_cmd
:

3097 
	`__sc¡_cmd_put
(
fcmd
);

3099 
out_’omem_ä“_e
:

3100 
	`kä“
(
e
);

3102 
out_’omem
:

3103 
	`sc¡_£t_busy
(
ec_cmd
);

3104 
»s
 = -
ENOMEM
;

3105 
out
;

3106 
	}
}

3108 
	$sc¡_cm_·r£_b2b_£g_desü
(
sc¡_cmd
 *
ec_cmd
,

3109 cÚ¡ 
ušt8_t
 *
£g
, cÚ¡ 
sc¡_cm_tgt_desü
 *
tgt_desüs
,

3110 
tgt_desüs_út
, 
£g_num
)

3112 
sc¡_cm_ec_cmd_´iv
 *
´iv
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

3113 
sc¡_ext_cÝy_£g_desü
 *
d
 = &
´iv
->
cm_£g_desüs
[
£g_num
];

3114 
»s
 = 28, 
rc
, 
Ën
, 
¤c_des_idx
, 
tgt_des_idx
, 
blocks
, 
dc
;

3115 cÚ¡ 
sc¡_cm_tgt_desü
 *
¤c_des
, *
tgt_des
;

3117 
	`TRACE_ENTRY
();

3119 
	`TRACE_BUFF_FLAG
(
TRACE_DEBUG
, "£g", 
£g
, 28);

3121 
	`EXTRACHECKS_BUG_ON
(
£g
[0] != 2);

3123 
Ën
 = 
	`g‘_uÇligÃd_be16
(&
£g
[2]);

3124 ià(
Ën
 != 0x18) {

3125 
	`PRINT_WARNING
("IncÜ»ù B2B segm’ˆdesütÜ†’ %d", 
Ën
);

3126 
	`sc¡_cm_£t_£g_”r_£n£
(
ec_cmd
, 0, 0, 
£g_num
, 2);

3127 
out_”r
;

3130 
¤c_des_idx
 = 
	`g‘_uÇligÃd_be16
(&
£g
[4]);

3131 ià(
¤c_des_idx
 >ð
tgt_desüs_út
) {

3132 
	`PRINT_WARNING
("Inv®id srødesütÜ index %d", 
¤c_des_idx
);

3133 
	`sc¡_cm_£t_£g_”r_£n£
(
ec_cmd
, 0, 0, 
£g_num
, 4);

3134 
out_”r
;

3137 
¤c_des
 = &
tgt_desüs
[
¤c_des_idx
];

3138 ià(
¤c_des
->
tgt_dev
 =ð
NULL
) {

3139 
	`PRINT_WARNING
("Segment with NULL srcgt device");

3141 
	`sc¡_cm_£t_£g_”r_£n£
(
ec_cmd
, 0xD, 2, 
£g_num
, 4);

3142 
out_”r
;

3145 
tgt_des_idx
 = 
	`g‘_uÇligÃd_be16
(&
£g
[6]);

3146 ià(
tgt_des_idx
 >ð
tgt_desüs_út
) {

3147 
	`PRINT_WARNING
("Inv®idgˆdesütÜ index %d", 
tgt_des_idx
);

3148 
	`sc¡_cm_£t_£g_”r_£n£
(
ec_cmd
, 0, 0, 
£g_num
, 6);

3149 
out_”r
;

3152 
tgt_des
 = &
tgt_desüs
[
tgt_des_idx
];

3153 ià(
tgt_des
->
tgt_dev
 =ð
NULL
) {

3154 
	`PRINT_WARNING
("Segment with NULLgt device");

3156 
	`sc¡_cm_£t_£g_”r_£n£
(
ec_cmd
, 0xD, 2, 
£g_num
, 6);

3157 
out_”r
;

3159 ià(
tgt_des
->
»ad_Úly
) {

3160 
	`PRINT_WARNING
("Target descriptor„eferso„ead-only device");

3161 
	`sc¡_cm_£t_£g_”r_£n£
(
ec_cmd
, 0, 0, 
£g_num
, 6);

3162 
out_”r
;

3165 
dc
 = (
£g
[1] >> 1) & 1;

3166 
blocks
 = 
	`g‘_uÇligÃd_be16
(&
£g
[10]);

3167 ià(
dc
)

3168 
Ën
 = 
blocks
 << 
tgt_des
->
tgt_dev
->
dev
->
block_shiá
;

3170 
Ën
 = 
blocks
 << 
¤c_des
->
tgt_dev
->
dev
->
block_shiá
;

3172 ià(
	`uÆik–y
((
Ën
 & (
¤c_des
->
tgt_dev
->
dev
->
block_size
-1)) != 0) ||

3173 
	`uÆik–y
((
Ën
 & (
tgt_des
->
tgt_dev
->
dev
->
block_size
-1)) != 0)) {

3174 
	`PRINT_WARNING
("Data†en %d is‚otƒven for block size (src block "

3175 "siz%d, d¡ block siz%d)", 
Ën
,

3176 
¤c_des
->
tgt_dev
->
dev
->
block_size
,

3177 
tgt_des
->
tgt_dev
->
dev
->
block_size
);

3178 
	`sc¡_cm_£t_£g_”r_£n£
(
ec_cmd
, 0, 0, 
£g_num
, 10);

3179 
out_”r
;

3182 
d
->
ty³
 = 
SCST_EXT_COPY_SEG_DATA
;

3183 
d
->
d©a_desü
.
d©a_Ën
 = 
Ën
;

3184 
d
->
¤c_tgt_dev
 = 
¤c_des
->
tgt_dev
;

3185 
d
->
d©a_desü
.
¤c_lba
 = 
	`g‘_uÇligÃd_be64
(&
£g
[12]);

3186 
d
->
d¡_tgt_dev
 = 
tgt_des
->
tgt_dev
;

3187 
d
->
d©a_desü
.
d¡_lba
 = 
	`g‘_uÇligÃd_be64
(&
£g
[20]);

3188 
d
->
tgt_desü_offs
 = 
tgt_des
->
·¿m_offs
;

3190 
	`TRACE
(
TRACE_DEBUG
|
TRACE_SCSI
, "ec_cmd %p, src dev %s, dst dev %s, "

3191 "ËÀ%d, src_lb¨%Îd, d¡_lb¨%Îd", 
ec_cmd
,

3192 
d
->
¤c_tgt_dev
->
dev
->
vœt_Çme
, d->
d¡_tgt_dev
->dev->virt_name,

3193 
Ën
, ()
d
->
d©a_desü
.
¤c_lba
,

3194 ()
d
->
d©a_desü
.
d¡_lba
);

3196 
	`TRACE_DBG
("srcgt_dev %p, dstgt_dev %p,gt_descr_offs %d",

3197 
d
->
¤c_tgt_dev
, d->
d¡_tgt_dev
, d->
tgt_desü_offs
);

3199 
rc
 = 
	`sc¡_cm_add_to_desü_li¡
(
ec_cmd
, 
¤c_des
->
tgt_dev
);

3200 ià(
rc
 != 0) {

3201 
»s
 = 
rc
;

3202 
out
;

3205 
rc
 = 
	`sc¡_cm_add_to_desü_li¡
(
ec_cmd
, 
tgt_des
->
tgt_dev
);

3206 ià(
rc
 != 0) {

3207 
»s
 = 
rc
;

3208 
out
;

3211 
out
:

3212 
	`TRACE_EXIT_RES
(
»s
);

3213  
»s
;

3215 
out_”r
:

3216 
»s
 = -1;

3217 
out
;

3218 
	}
}

3220 
	$sc¡_cm_ä“_ec_´iv
(
sc¡_cmd
 *
ec_cmd
, 
boÞ
 
unblock_dev
)

3222 
sc¡_cm_ec_cmd_´iv
 *
p
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

3223 
sc¡_cm_dev_’Œy
 *
e
, *
t
;

3224 
sc¡_cm_š‹º®_cmd_´iv
 *

, *
™
;

3225 
æags
;

3227 
	`TRACE_ENTRY
();

3229 
	`li¡_fÜ_—ch_’Œy_§ã
(
e
, 
t
, &
p
->
cm_sÜ‹d_devs_li¡
,

3230 
cm_sÜ‹d_devs_li¡_’Œy
) {

3231 
	`TRACE_DBG
("D–‘šgƒ %p", 
e
);

3232 
	`li¡_d–
(&
e
->
cm_sÜ‹d_devs_li¡_’Œy
);

3233 
	`kä“
(
e
);

3236 
	`li¡_fÜ_—ch_’Œy_§ã
(

, 
™
, &
p
->
cm_š‹º®_cmd_li¡
,

3237 
cm_š‹º®_cmd_li¡_’Œy
) {

3238 
sc¡_cmd
 *
c
 = 

->
cm_cmd
;

3240 
	`sc¡_cm_d–_ä“_äom_š‹º®_cmd_li¡
(
c
, 
unblock_dev
);

3241 
	`__sc¡_cmd_put
(
c
);

3245 
	`¥š_lock_œq§ve
(&
sc¡_cm_lock
, 
æags
);

3246 
ec_cmd
->
cmd_d©a_desütÜs
 = 
NULL
;

3247 
ec_cmd
->
cmd_d©a_desütÜs_út
 = 0;

3248 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_cm_lock
, 
æags
);

3250 
	`kä“
(
p
);

3252 
	`TRACE_EXIT
();

3254 
	}
}

3256 
	$sc¡_cm_·r£_desütÜs
(
sc¡_cmd
 *
ec_cmd
)

3258 
»s
 = 0, 
rc
;

3259 
sc¡_cm_li¡_id
 *
¶i¡_id
 = 
NULL
;

3260 
ssize_t
 
Ëngth
 = 0;

3261 
ušt8_t
 *
buf
;

3262 
li¡_id
, 
li¡_id_u§ge
, 
Ën
, 
tgt_Ën
, 
£g_Ën
;

3263 
sc¡_cm_ec_cmd_´iv
 *
p
;

3264 
tgt_út
, 
£g_út
, 
i
, 
offs
, 
t
;

3265 
sc¡_cm_tgt_desü
 *
tgt_desüs
;

3267 
	`TRACE_ENTRY
();

3269 
	`EXTRACHECKS_BUG_ON
(
ec_cmd
->
cmd_d©a_desütÜs
 !ð
NULL
);

3271 
Ëngth
 = 
	`sc¡_g‘_buf_fuÎ_£n£
(
ec_cmd
, &
buf
);

3272 ià(
	`uÆik–y
(
Ëngth
 <= 0)) {

3273 ià(
Ëngth
 == 0)

3274 
out_put
;

3276 
out_abn
;

3279 ià(
Ëngth
 < 16) {

3280 
	`PRINT_WARNING
("ToØsm®ÈEXTENDED COPY d©¨ËÀ%d", ()
Ëngth
);

3281 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
ec_cmd
, 10, 0);

3282 
out_abn_put
;

3285 
li¡_id
 = 
buf
[0];

3286 
li¡_id_u§ge
 = (
buf
[1] & 0x18) >> 3;

3288 
	`TRACE_BUFF_FLAG
(
TRACE_DEBUG
, "buf", 
buf
, 
Ëngth
);

3290 
	`TRACE_DBG
("li¡_id %d,†i¡_id_u§g%d", 
li¡_id
, 
li¡_id_u§ge
);

3292 
li¡_id_u§ge
) {

3295 
¶i¡_id
 = 
	`sc¡_cm_add_li¡_id
(
ec_cmd
, 
li¡_id
);

3296 ià(
¶i¡_id
 =ð
NULL
)

3297 
out_abn_put
;

3300 ià(
li¡_id
 != 0) {

3301 
	`PRINT_WARNING
("Invalid†ist ID %d with†ist ID usage %d",

3302 
li¡_id
, 
li¡_id_u§ge
);

3303 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
ec_cmd
, 0, 0);

3304 
out_abn_put
;

3308 
	`PRINT_WARNING
("Inv®id†i¡ ID u§g%d,„ejeùšg", 
li¡_id_u§ge
);

3309 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
ec_cmd
, 1,

3310 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 3);

3311 
out_abn_put
;

3314 
Ën
 = 
	`g‘_uÇligÃd_be32
(&
buf
[12]);

3315 ià(
Ën
 != 0) {

3316 
	`PRINT_WARNING
("IÆšd©¨nÙ suµÜ‹d (ËÀ%d)", 
Ën
);

3317 
	`sc¡_£t_cmd_”rÜ
(
ec_cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šlše_d©a_Ëngth_exûeded
));

3318 
out_d–_abn_put
;

3321 
tgt_Ën
 = 
	`g‘_uÇligÃd_be16
(&
buf
[2]);

3322 
£g_Ën
 = 
	`g‘_uÇligÃd_be32
(&
buf
[8]);

3324 ià(
tgt_Ën
 == 0) {

3325 ià(
£g_Ën
 == 0)

3326 
out_d–_put
;

3328 
	`PRINT_WARNING
("Zeroarget descriptors with‚on-zero "

3329 "£gm’t ËÀ(%d)", 
£g_Ën
);

3330 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
ec_cmd
, 2, 0);

3331 
out_d–_abn_put
;

3335 ià((
tgt_Ën
 + 
£g_Ën
 + 16è> 
Ëngth
) {

3336 
	`PRINT_WARNING
("Parametersruncation");

3337 
	`sc¡_£t_cmd_”rÜ
(
ec_cmd
,

3338 
	`SCST_LOAD_SENSE
(
sc¡_£n£_·¿m‘”_li¡_Ëngth_šv®id
));

3339 
out_d–_abn_put
;

3342 ià((
tgt_Ën
 + 
£g_Ën
 + 16è!ð
Ëngth
) {

3343 
	`PRINT_WARNING
("Unexpected inline data");

3344 
	`sc¡_£t_cmd_”rÜ
(
ec_cmd
,

3345 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šlše_d©a_Ëngth_exûeded
));

3346 
out_d–_abn_put
;

3349 ià((
tgt_Ën
 % 32) != 0) {

3350 
	`PRINT_WARNING
("Inv®idgˆËÀ%d", 
tgt_Ën
);

3351 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
ec_cmd
, 2, 0);

3352 
out_d–_abn_put
;

3355 
tgt_út
 = 
tgt_Ën
/32;

3356 ià(
tgt_út
 > 
SCST_CM_MAX_TGT_DESCR_CNT
) {

3357 
	`PRINT_WARNING
("ToØmªy¬g‘ desütÜ %d", 
tgt_út
);

3358 
	`sc¡_£t_cmd_”rÜ
(
ec_cmd
,

3359 
	`SCST_LOAD_SENSE
(
sc¡_£n£_too_mªy_rg‘_desütÜs
));

3360 
out_d–_abn_put
;

3363 
	`TRACE_DBG
("tgt_úˆ%d", 
tgt_út
);

3365 
tgt_desüs
 = 
	`kÿÎoc
(
tgt_út
, (*tgt_desüs), 
GFP_KERNEL
);

3366 ià(
tgt_desüs
 =ð
NULL
) {

3367 
	`TRACE
(
TRACE_OUT_OF_MEM
, "Unableo‡llocategt_descrs "

3368 "(couÁ %d, siz%zd)", 
tgt_út
,

3369 (*
tgt_desüs
è* 
tgt_út
);

3370 
	`sc¡_£t_busy
(
ec_cmd
);

3371 
out_d–_abn_put
;

3374 
offs
 = 16;

3375 
i
 = 0; i < 
tgt_út
; i++) {

3376 
	`TRACE_DBG
("off %d", 
offs
);

3377 
buf
[
offs
]) {

3379 
rc
 = 
	`sc¡_cm_·r£_id_tgt_desü
(
ec_cmd
, &
buf
[
offs
], offs,

3380 &
tgt_desüs
[
i
]);

3381 ià(
rc
 <= 0)

3382 
out_ä“_tgt_desü
;

3385 
	`PRINT_WARNING
("NÙ suµÜ‹d¬g‘ desütÜ %x", 
buf
[
offs
]);

3386 
	`sc¡_£t_cmd_”rÜ
(
ec_cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_unsuµÜ‹d_tgt_desü_ty³
));

3387 
out_ä“_tgt_desü
;

3389 
tgt_desüs
[
i
].
·¿m_offs
 = 
offs
;

3390 
offs
 +ð
rc
;

3393 
	`WARN_ON
(
offs
 !ð
tgt_Ën
 + 16);

3395 
t
 = 
offs
;

3396 
£g_út
 = 0;

3397 
offs
 < 
Ëngth
) {

3398 ià(
£g_út
 =ð
SCST_CM_MAX_SEG_DESCR_CNT
) {

3399 
	`PRINT_WARNING
("Too many segment descriptors");

3400 
	`sc¡_£t_cmd_”rÜ
(
ec_cmd
,

3401 
	`SCST_LOAD_SENSE
(

3402 
sc¡_£n£_too_mªy_£gm’t_desütÜs
));

3403 
out_ä“_tgt_desü
;

3405 
buf
[
offs
]) {

3407 
offs
 += 28;

3410 
	`PRINT_WARNING
("NÙ suµÜ‹d segm’ˆdesütÜ %x", 
buf
[
offs
]);

3411 
	`sc¡_£t_cmd_”rÜ
(
ec_cmd
,

3412 
	`SCST_LOAD_SENSE
(
sc¡_£n£_unsuµÜ‹d_£g_desü_ty³
));

3413 
out_ä“_tgt_desü
;

3415 
£g_út
++;

3417 
offs
 = 
t
;

3419 
	`TRACE_DBG
("£g_úˆ%d", 
£g_út
);

3421 
p
 = 
	`kz®loc
((*pè+ 
£g_út
 * (
sc¡_ext_cÝy_£g_desü
), 
GFP_KERNEL
);

3422 ià(
p
 =ð
NULL
) {

3423 
	`TRACE
(
TRACE_OUT_OF_MEM
, "Unableo‡llocate Extended Copy "

3424 "desütÜ (£g_úˆ%d)", 
£g_út
);

3425 
	`sc¡_£t_busy
(
ec_cmd
);

3426 
out_ä“_tgt_desü
;

3429 
p
->
cm_li¡_id
 = 
¶i¡_id
;

3430 
¶i¡_id
 = 
NULL
;

3431 
	`INIT_LIST_HEAD
(&
p
->
cm_sÜ‹d_devs_li¡
);

3432 
	`INIT_LIST_HEAD
(&
p
->
cm_š‹º®_cmd_li¡
);

3433 
p
->
cm_”rÜ
 = 
SCST_CM_ERROR_NONE
;

3434 
	`mu‹x_š™
(&
p
->
cm_mu‹x
);

3436 
ec_cmd
->
cmd_d©a_desütÜs
 = 
p
;

3437 
ec_cmd
->
cmd_d©a_desütÜs_út
 = 
£g_út
;

3439 
»s
 = 
	`sc¡_cm_add_to_desü_li¡
(
ec_cmd
,ƒc_cmd->
tgt_dev
);

3440 ià(
»s
 != 0)

3441 
out_ä“_p
;

3443 
i
 = 0; i < 
£g_út
; i++) {

3444 
	`TRACE_DBG
("off %d", 
offs
);

3445 
buf
[
offs
]) {

3447 
rc
 = 
	`sc¡_cm_·r£_b2b_£g_desü
(
ec_cmd
, &
buf
[
offs
],

3448 
tgt_desüs
, 
tgt_út
, 
i
);

3449 ià(
rc
 <= 0) {

3450 ià(
rc
 =ð-
ENOMEM
)

3451 
out_ä“_p
;

3458 
	`sc¡_cm_¡Üe_li¡_id_d‘ažs
(
ec_cmd
);

3459 
out_ä“_tgt_desü
;

3462 
	`EXTRACHECKS_BUG_ON
(
rc
 != 28);

3465 
	`sBUG
();

3467 
offs
 +ð
rc
;

3470 
	`kä“
(
tgt_desüs
);

3472 
out_d–_put
:

3473 ià(
¶i¡_id
 !ð
NULL
)

3474 
	`sc¡_cm_d–_ä“_li¡_id
(
¶i¡_id
, 
çl£
);

3476 
out_put
:

3477 
	`sc¡_put_buf_fuÎ
(
ec_cmd
, 
buf
);

3479 
out
:

3480 
	`TRACE_EXIT_RES
(
»s
);

3481  
»s
;

3483 
out_ä“_p
:

3484 
	`sc¡_cm_ä“_ec_´iv
(
ec_cmd
, 
çl£
);

3486 
out_ä“_tgt_desü
:

3487 
	`kä“
(
tgt_desüs
);

3489 
out_d–_abn_put
:

3490 ià(
¶i¡_id
 !ð
NULL
)

3491 
	`sc¡_cm_d–_ä“_li¡_id
(
¶i¡_id
, 
çl£
);

3493 
out_abn_put
:

3494 
	`sc¡_put_buf_fuÎ
(
ec_cmd
, 
buf
);

3496 
out_abn
:

3497 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
ec_cmd
);

3498 
»s
 = -1;

3499 
out
;

3500 
	}
}

3502 
	$sc¡_cm_ä“_desütÜs
(
sc¡_cmd
 *
ec_cmd
)

3504 
sc¡_cm_ec_cmd_´iv
 *
´iv
 = 
ec_cmd
->
cmd_d©a_desütÜs
;

3506 
	`TRACE_ENTRY
();

3508 
	`TRACE_DBG
("cmd %°(š‹º® %d)", 
ec_cmd
,ƒc_cmd->
š‹º®
);

3510 ià(
´iv
 =ð
NULL
) {

3512 
out
;

3515 ià(
ec_cmd
->
š‹º®
)

3516 
out
;

3518 ià(
´iv
->
cm_li¡_id
 !ð
NULL
)

3519 
	`sc¡_cm_sched_d–_li¡_id
(
ec_cmd
);

3521 
	`sc¡_cm_ä“_ec_´iv
(
ec_cmd
, 
Œue
);

3523 
out
:

3524 
	`TRACE_EXIT
();

3526 
	}
}

3528 #iâdeà
CONFIG_SCST_PROC


3530 
ssize_t
 
	$sc¡_cm_®low_nÙ_cÚn_cÝy_show
(
kobjeù
 *
kobj
,

3531 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

3533 
ssize_t
 
»s
;

3535 
	`TRACE_ENTRY
();

3537 
»s
 = 
	`¥rštf
(
buf
, "%d\n%s", 
sc¡_cm_®low_nÙ_cÚÃùed_cÝy
,

3538 (
sc¡_cm_®low_nÙ_cÚÃùed_cÝy
 =ð
SCST_ALLOW_NOT_CONN_COPY_DEF
) ?

3539 "" : 
SCST_SYSFS_KEY_MARK
 "\n");

3541 
	`TRACE_EXIT_RES
(
»s
);

3542  
»s
;

3543 
	}
}

3545 
ssize_t
 
	$sc¡_cm_®low_nÙ_cÚn_cÝy_¡Üe
(
kobjeù
 *
kobj
,

3546 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
bufãr
, 
size_t
 
size
)

3548 
ssize_t
 
»s
;

3549 
v®
;

3551 
	`TRACE_ENTRY
();

3553 
»s
 = 
	`k¡¹oul
(
bufãr
, 0, &
v®
);

3554 ià(
»s
 != 0) {

3555 
	`PRINT_ERROR
("¡¹oul(èfÜ % çžed: %zd", 
bufãr
, 
»s
);

3556 
out
;

3559 
sc¡_cm_®low_nÙ_cÚÃùed_cÝy
 = 
v®
;

3561 
»s
 = 
size
;

3563 
out
:

3564 
	`TRACE_EXIT_RES
(
»s
);

3565  
»s
;

3566 
	}
}

3568 
kobj_©Œibu‹
 
	gsc¡_cm_®low_nÙ_cÚn_cÝy_©Œ
 =

3569 
__ATTR
(
®low_nÙ_cÚÃùed_cÝy
, 
S_IRUGO
|
S_IWUSR
,

3570 
sc¡_cm_®low_nÙ_cÚn_cÝy_show
,

3571 
sc¡_cm_®low_nÙ_cÚn_cÝy_¡Üe
);

3573 cÚ¡ 
©Œibu‹
 *
	gsc¡_cm_tg‰_©Œs
[] = {

3574 &
sc¡_cm_®low_nÙ_cÚn_cÝy_©Œ
.
©Œ
,

3575 
NULL
,

3580 
	$sc¡_cm_g‘_š™ŸtÜ_pÜt_Œª¥Üt_id
(
sc¡_tgt
 *
tgt
,

3581 
sc¡_£ssiÚ
 *
sc¡_£ss
, 
ušt8_t
 **
Œª¥Üt_id
)

3583 
»s
 = 0;

3584 
ušt8_t
 *
tid
 = 
NULL
;

3586 
	`TRACE_ENTRY
();

3588 
	`BUILD_BUG_ON
(((
SCST_CM_TID_ID
)+3è> 
SCST_CM_TID_SIZE
);

3589 
	`BUILD_BUG_ON
(
TID_COMMON_SIZE
 !ð
SCST_CM_TID_SIZE
);

3591 ià(
sc¡_£ss
 =ð
NULL
) {

3592 
»s
 = 
SCST_TRANSPORTID_PROTOCOLID_COPY_MGR
;

3593 
out
;

3596 
tid
 = 
	`kz®loc
(
SCST_CM_TID_SIZE
, 
GFP_KERNEL
);

3597 ià(
tid
 =ð
NULL
) {

3598 
	`PRINT_ERROR
("Allocation of TransportID (size %d) failed",

3599 
SCST_CM_TID_SIZE
);

3600 
»s
 = -
ENOMEM
;

3601 
out
;

3604 
tid
[0] = 
SCST_TRANSPORTID_PROTOCOLID_COPY_MGR
;

3605 
	`memýy
(&
tid
[2], 
SCST_CM_TID_ID
, (SCST_CM_TID_ID));

3607 *
Œª¥Üt_id
 = 
tid
;

3609 
out
:

3610 
	`TRACE_EXIT_RES
(
»s
);

3611  
»s
;

3612 
	}
}

3614 
	$sc¡_cm_»Ëa£
(
sc¡_tgt
 *
tgt
)

3616 
	`TRACE_ENTRY
();

3617 
	`TRACE_EXIT
();

3619 
	}
}

3621 
	$sc¡_cm_xm™_»¥Ú£
(
sc¡_cmd
 *
cmd
)

3623 
»s
 = 
SCST_TGT_RES_SUCCESS
;

3624 
sc¡_i_fšish_â_t
 
f
 = (*è*((**)
cmd
->
tgt_i_´iv
);

3626 
	`TRACE_ENTRY
();

3633 
	`f
(
cmd
);

3634 
	`sc¡_tgt_cmd_dÚe
(
cmd
, 
SCST_CONTEXT_SAME
);

3636 
	`TRACE_EXIT_RES
(
»s
);

3637  
»s
;

3638 
	}
}

3640 
	$sc¡_cm_sk_mgmt_â_dÚe
(
sc¡_mgmt_cmd
 *
sc¡_mcmd
)

3644 
	}
}

3646 
	$sc¡_cm_»pÜt_«n
(
sc¡_«n
 *
«n
)

3650 
	}
}

3652 
sc¡_tgt_‹m¶©e
 
	gsc¡_cm_tg‰
 = {

3653 .
Çme
 = 
SCST_CM_NAME
,

3654 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 20)

3655 .
	gsg_bËsize
 = 
SG_MAX_SINGLE_ALLOC
,

3657 .
	gsg_bËsize
 = 0xffff,

3659 #iâdeà
CONFIG_SCST_PROC


3660 .
	g’abËd_©Œ_nÙ_Ãeded
 = 1,

3662 .
	gdif_suµÜ‹d
 = 1,

3663 .
	ghw_dif_ty³1_suµÜ‹d
 = 1,

3664 .
	ghw_dif_ty³2_suµÜ‹d
 = 1,

3665 .
	ghw_dif_ty³3_suµÜ‹d
 = 1,

3666 .
	g»Ëa£
 = 
sc¡_cm_»Ëa£
,

3667 .
	gxm™_»¥Ú£
 = 
sc¡_cm_xm™_»¥Ú£
,

3668 .
	gsk_mgmt_â_dÚe
 = 
sc¡_cm_sk_mgmt_â_dÚe
,

3669 .
	g»pÜt_«n
 = 
sc¡_cm_»pÜt_«n
,

3670 .
	gg‘_š™ŸtÜ_pÜt_Œª¥Üt_id
 = 
sc¡_cm_g‘_š™ŸtÜ_pÜt_Œª¥Üt_id
,

3671 #iâdeà
CONFIG_SCST_PROC


3672 .
	gtg‰_©Œs
 = 
sc¡_cm_tg‰_©Œs
,

3676 
__š™
 
	$sc¡_cm_š™
()

3678 
»s
 = 0;

3680 
	`TRACE_ENTRY
();

3682 
	`¥š_lock_š™
(&
sc¡_cm_lock
);

3684 
»s
 = 
	`sc¡_»gi¡”_rg‘_‹m¶©e
(&
sc¡_cm_tg‰
);

3685 ià(
»s
 != 0) {

3686 
	`PRINT_ERROR
("UÇbËØ»gi¡” cÝy mªag”em¶©e: %d", 
»s
);

3687 
out
;

3690 
sc¡_cm_tgt
 = 
	`sc¡_»gi¡”_rg‘
(&
sc¡_cm_tg‰
, 
SCST_CM_TGT_NAME
);

3691 ià(
sc¡_cm_tgt
 =ð
NULL
) {

3692 
	`PRINT_ERROR
("%s", "scst_register_target() failed");

3693 
»s
 = -
EFAULT
;

3694 
out_uÄeg_tg‰
;

3697 
sc¡_cm_£ss
 = 
	`sc¡_»gi¡”_£ssiÚ
(
sc¡_cm_tgt
, 
çl£
,

3698 
SCST_CM_SESS_NAME
, 
NULL
, NULL, NULL);

3699 ià(
sc¡_cm_£ss
 =ð
NULL
) {

3700 
	`PRINT_ERROR
("%s", "scst_register_session() failed");

3701 
»s
 = -
EFAULT
;

3702 
out_uÄeg_tgt
;

3705 
out
:

3706 
	`TRACE_EXIT_RES
(
»s
);

3707  
»s
;

3709 
out_uÄeg_tgt
:

3710 
	`sc¡_uÄegi¡”_rg‘
(
sc¡_cm_tgt
);

3712 
out_uÄeg_tg‰
:

3713 
	`sc¡_uÄegi¡”_rg‘_‹m¶©e
(&
sc¡_cm_tg‰
);

3714 
out
;

3715 
	}
}

3717 
__ex™
 
	$sc¡_cm_ex™
()

3719 
	`TRACE_ENTRY
();

3721 
	`sc¡_uÄegi¡”_£ssiÚ
(
sc¡_cm_£ss
, 
Œue
, 
NULL
);

3722 
	`sc¡_uÄegi¡”_rg‘
(
sc¡_cm_tgt
);

3723 
	`sc¡_uÄegi¡”_rg‘_‹m¶©e
(&
sc¡_cm_tg‰
);

3725 
	`TRACE_EXIT
();

3727 
	}
}

	@scst/src/scst_debug.c

22 
	~<lšux/v”siÚ.h
>

24 #iâdeà
INSIDE_KERNEL_TREE


25 
	~<lšux/v”siÚ.h
>

27 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(3, 2, 0)

28 
	~<lšux/expÜt.h
>

31 #ifdeà
INSIDE_KERNEL_TREE


32 
	~<sc¡/sc¡.h
>

33 
	~<sc¡/sc¡_debug.h
>

35 
	~"sc¡.h
"

36 
	~"sc¡_debug.h
"

39 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

41 
	#TRACE_BUF_SIZE
 512

	)

43 
	gŒaû_buf
[
TRACE_BUF_SIZE
];

44 
DEFINE_SPINLOCK
(
Œaû_buf_lock
);

46 
šlše
 
	$g‘_cu¼’t_tid
()

49 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 24)

50  
cu¼’t
->
pid
;

52 ià(
	`š_š‹¼u±
()) {

57  
cu¼’t
->
pid
;

59  
	`sk_pid_vÄ
(
cu¼’t
);

61 
	}
}

68 
	$debug_´št_w™h_´efix
(
Œaû_æag
, cÚ¡ *
£v”™y
,

69 cÚ¡ *
´efix
, cÚ¡ *
func
, 
lše
, cÚ¡ *
fmt
, ...)

71 
i
;

72 
æags
;

73 
pid
 = 
	`g‘_cu¼’t_tid
();

74 
va_li¡
 
¬gs
;

76 
	`¥š_lock_œq§ve
(&
Œaû_buf_lock
, 
æags
);

78 
	`¡¾ýy
(
Œaû_buf
, 
£v”™y
, 
TRACE_BUF_SIZE
);

79 
i
 = 
	`¡¾’
(
Œaû_buf
);

81 ià(
Œaû_æag
 & 
TRACE_PID
)

82 
i
 +ð
	`¢´štf
(&
Œaû_buf
[i], 
TRACE_BUF_SIZE
 - i, "[%d]: ", 
pid
);

83 ià(
´efix
 !ð
NULL
)

84 
i
 +ð
	`¢´štf
(&
Œaû_buf
[i], 
TRACE_BUF_SIZE
 - i, "%s: ",

85 
´efix
);

86 ià(
Œaû_æag
 & 
TRACE_FUNCTION
)

87 
i
 +ð
	`¢´štf
(&
Œaû_buf
[i], 
TRACE_BUF_SIZE
 - i, "%s:", 
func
);

88 ià(
Œaû_æag
 & 
TRACE_LINE
)

89 
i
 +ð
	`¢´štf
(&
Œaû_buf
[i], 
TRACE_BUF_SIZE
 - i, "%i:", 
lše
);

91 
i
 +ð
	`¢´štf
(&
Œaû_buf
[i], 
TRACE_BUF_SIZE
 - i, "%s\n", 
fmt
);

93 
	`va_¡¬t
(
¬gs
, 
fmt
);

94 
	`v´štk
(
Œaû_buf
, 
¬gs
);

95 
	`va_’d
(
¬gs
);

97 
	`¥š_uÆock_œq»¡Üe
(&
Œaû_buf_lock
, 
æags
);

99  
i
;

100 
	}
}

101 
EXPORT_SYMBOL
(
debug_´št_w™h_´efix
);

108 
	$debug_´št_bufãr
(cÚ¡ *
d©a
, 
Ën
)

110 
z
, 
z1
, 
i
;

111 cÚ¡ *
buf
 = (cÚ¡ *è
d©a
;

112 
æags
;

114 ià(
buf
 =ð
NULL
)

117 
	`¥š_lock_œq§ve
(&
Œaû_buf_lock
, 
æags
);

119 
	`PRINT
(
KERN_INFO
, " (h)___0__1__2__3__4__5__6__7__8__9__A__B__C__D__E__F");

120 
z
 = 0, 
z1
 = 0, 
i
 = 0; z < 
Ën
; z++) {

121 ià(
z
 % 16 == 0) {

122 ià(
z
 != 0) {

123 
i
 +ð
	`¢´štf
(&
Œaû_buf
[i], 
TRACE_BUF_SIZE
 - i,

125 ; (
z1
 < 
z
è&& (
i
 < 
TRACE_BUF_SIZE
 - 1);

126 
z1
++) {

127 ià((
buf
[
z1
] >= 0x20) &&

128 (
buf
[
z1
] < 0x80))

129 
Œaû_buf
[
i
++] = 
buf
[
z1
];

131 
Œaû_buf
[
i
++] = '.';

133 
Œaû_buf
[
i
] = '\0';

134 
	`PRINT
(
KERN_INFO
, "%s", 
Œaû_buf
);

135 
i
 = 0;

137 
i
 +ð
	`¢´štf
(&
Œaû_buf
[i], 
TRACE_BUF_SIZE
 - i,

138 "%4x: ", 
z
);

140 
i
 +ð
	`¢´štf
(&
Œaû_buf
[i], 
TRACE_BUF_SIZE
 - i, "%02x ",

141 
buf
[
z
]);

144 
i
 +ð
	`¢´štf
(&
Œaû_buf
[i], 
TRACE_BUF_SIZE
 - i, " ");

145 ; (
z1
 < 
z
è&& (
i
 < 
TRACE_BUF_SIZE
 - 1); z1++) {

146 ià((
buf
[
z1
] > 0x20) && (buf[z1] < 0x80))

147 
Œaû_buf
[
i
++] = 
buf
[
z1
];

149 
Œaû_buf
[
i
++] = '.';

151 
Œaû_buf
[
i
] = '\0';

153 
	`PRINT
(
KERN_INFO
, "%s", 
Œaû_buf
);

155 
	`¥š_uÆock_œq»¡Üe
(&
Œaû_buf_lock
, 
æags
);

157 
	}
}

158 
EXPORT_SYMBOL
(
debug_´št_bufãr
);

171 cÚ¡ *
	$debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(cÚ¡ 
ušt8_t
 *
Œª¥Üt_id
)

178 
	#SIZEOF_NAME_BUF
 256

	)

179 
Çme_bufs
[
NR_CPUS
][
SIZEOF_NAME_BUF
];

180 *
Çme_buf
;

181 
æags
;

183 
	`sBUG_ON
(
Œª¥Üt_id
 =ð
NULL
);

185 
	`¥š_lock_œq§ve
(&
Œaû_buf_lock
, 
æags
);

187 
Çme_buf
 = 
Çme_bufs
[
	`smp_´oûssÜ_id
()];

193 
	`mem£t
(
Çme_buf
, 0, 
SIZEOF_NAME_BUF
);

194 
	`smp_mb
();

196 
Œª¥Üt_id
[0] & 0x0f) {

197 
SCSI_TRANSPORTID_PROTOCOLID_ISCSI
:

198 
	`sú´štf
(
Çme_buf
, 
SIZEOF_NAME_BUF
, "%s",

199 &
Œª¥Üt_id
[4]);

201 
SCSI_TRANSPORTID_PROTOCOLID_FCP2
:

202 
	`sú´štf
(
Çme_buf
, 
SIZEOF_NAME_BUF
,

204 
Œª¥Üt_id
[8],ransport_id[9],

205 
Œª¥Üt_id
[10],ransport_id[11],

206 
Œª¥Üt_id
[12],ransport_id[13],

207 
Œª¥Üt_id
[14],ransport_id[15]);

209 
SCSI_TRANSPORTID_PROTOCOLID_SPI5
:

210 
	`sú´štf
(
Çme_buf
, 
SIZEOF_NAME_BUF
,

211 "%x:%x", 
	`be16_to_ýu
((
__fÜû
 
__be16
)
Œª¥Üt_id
[2]),

212 
	`be16_to_ýu
((
__fÜû
 
__be16
)
Œª¥Üt_id
[6]));

214 
SCSI_TRANSPORTID_PROTOCOLID_SRP
:

215 
	`sú´štf
(
Çme_buf
, 
SIZEOF_NAME_BUF
,

218 
Œª¥Üt_id
[8],ransport_id[9],

219 
Œª¥Üt_id
[10],ransport_id[11],

220 
Œª¥Üt_id
[12],ransport_id[13],

221 
Œª¥Üt_id
[14],ransport_id[15],

222 
Œª¥Üt_id
[16],ransport_id[17],

223 
Œª¥Üt_id
[18],ransport_id[19],

224 
Œª¥Üt_id
[20],ransport_id[21],

225 
Œª¥Üt_id
[22],ransport_id[23]);

227 
SCSI_TRANSPORTID_PROTOCOLID_SAS
:

228 
	`sú´štf
(
Çme_buf
, 
SIZEOF_NAME_BUF
,

230 
Œª¥Üt_id
[4],ransport_id[5],

231 
Œª¥Üt_id
[6],ransport_id[7],

232 
Œª¥Üt_id
[8],ransport_id[9],

233 
Œª¥Üt_id
[10],ransport_id[11]);

235 
SCST_TRANSPORTID_PROTOCOLID_COPY_MGR
:

236 
	`sú´štf
(
Çme_buf
, 
SIZEOF_NAME_BUF
,

237 "%s", &
Œª¥Üt_id
[2]);

240 
	`sú´štf
(
Çme_buf
, 
SIZEOF_NAME_BUF
,

241 "(NÙ knowÀ´ÙocÞ ID %x)", 
Œª¥Üt_id
[0] & 0x0f);

245 
	`¥š_uÆock_œq»¡Üe
(&
Œaû_buf_lock
, 
æags
);

247  
Çme_buf
;

248 #undeà
SIZEOF_NAME_BUF


249 
	}
}

	@scst/src/scst_dlm.c

18 
	~<lšux/ty³s.h
>

19 
	~<lšux/dlm.h
>

20 
	~<lšux/kmod.h
>

21 
	~<lšux/vm®loc.h
>

22 #ifdeà
INSIDE_KERNEL_TREE


23 
	~<sc¡/sc¡.h
>

24 
	~<sc¡/sc¡_cÚ¡.h
>

26 
	~"sc¡.h
"

27 
	~"sc¡_cÚ¡.h
"

29 
	~"sc¡_´iv.h
"

30 
	~"sc¡_´es.h
"

31 
	~"sc¡_dlm.h
"

33 #ià(
defšed
(
CONFIG_DLM
è|| defšed(
CONFIG_DLM_MODULE
)) && \

34 !
	$defšed
(
CONFIG_SCST_NO_DLM
)

36 
	`sc¡_´_dlm_þ—nup
(
sc¡_deviû
 *
dev
);

37 
	`sc¡_dlm_´e_ba¡
(*
ba¡¬g
, 
mode
);

38 
	`sc¡_dlm_po¡_ba¡
(*
ba¡¬g
, 
mode
);

39 
	`sc¡_dlm_po¡_a¡
(*
a¡¬g
);

41 
šlše
 
	$compže_time_size_checks
()

43 
	`BUILD_BUG_ON
((
´_lvb
è> 
PR_DLM_LVB_LEN
);

44 
	`BUILD_BUG_ON
((
´_lvb
) != 20);

45 
	`BUILD_BUG_ON
((
´_»g_lvb
è> 
PR_DLM_LVB_LEN
);

46 
	`BUILD_BUG_ON
((
´_»g_lvb
) != 240);

47 
	}
}

49 
	$sc¡_dlm_a¡
(*
a¡¬g
)

51 
sc¡_lksb
 *sc¡_lksb = 
a¡¬g
;

53 
	`com¶‘e
(&
sc¡_lksb
->
com¶
);

54 
	}
}

59 
	$sc¡_dlm_ÿnûl
(
dlm_lock¥aû_t
 *
ls
, 
sc¡_lksb
 *
lksb
,

60 
æags
, cÚ¡ *
Çme
)

62 
»s
;

64 
»s
 = 
	`dlm_uÆock
(
ls
, 
lksb
->lksb.
sb_lkid
,

65 
DLM_LKF_CANCEL
 | (
æags
 & 
DLM_LKF_VALBLK
),

66 &
lksb
->lksb,†ksb);

67 ià(
»s
 < 0)

68 
out
;

69 
»s
 = 
	`wa™_fÜ_com¶‘iÚ_timeout
(&
lksb
->
com¶
, 10 * 
HZ
);

71 
out
:

72  
»s
;

73 
	}
}

84 
sc¡_dlm_lock_wa™
(
dlm_lock¥aû_t
 *
ls
, 
mode
,

85 
sc¡_lksb
 *
lksb
, 
æags
,

86 cÚ¡ *
Çme
, (*
ba¡
)(*, ))

88 
»s
;

90 
	`š™_com¶‘iÚ
(&
lksb
->
com¶
);

91 
»s
 = 
	`dlm_lock
(
ls
, 
mode
, &
lksb
->lksb, 
æags
,

92 (*)
Çme
,‚am? 
	`¡¾’
(name) : 0, 0,

93 
sc¡_dlm_a¡
, 
lksb
, 
ba¡
);

94 ià(
»s
 < 0)

95 
out
;

96 
»s
 = 
	`wa™_fÜ_com¶‘iÚ_timeout
(&
lksb
->
com¶
, 60 * 
HZ
);

97 ià(
»s
 > 0)

98 
»s
 = 
lksb
->lksb.
sb_¡©us
;

99 ià(
»s
 == 0)

100 
»s
 = -
ETIMEDOUT
;

101 ià(
»s
 < 0) {

102 
»s2
 = 
	`sc¡_dlm_ÿnûl
(
ls
, 
lksb
, 
æags
, 
Çme
);

104 
	`WARN
(
»s2
 < 0, "canceling†ock %s / %08x failed: %d\n",

105 
Çme
 ? : "?", 
lksb
->lksb.
sb_lkid
, 
»s2
);

108 
out
:

109  
»s
;

110 
	}
}

115 
	$sc¡_dlm_uÆock_wa™
(
dlm_lock¥aû_t
 *
ls
, 
sc¡_lksb
 *
lksb
)

117 
»s
;

119 
	`sBUG_ON
(!
ls
);

121 
	`š™_com¶‘iÚ
(&
lksb
->
com¶
);

122 
»s
 = 
	`dlm_uÆock
(
ls
, 
lksb
->lksb.
sb_lkid
, 0, &lksb->lksb,†ksb);

123 ià(
»s
 < 0)

124 
out
;

125 
»s
 = 
	`wa™_fÜ_com¶‘iÚ_timeout
(&
lksb
->
com¶
, 60 * 
HZ
);

126 ià(
»s
 > 0) {

127 
»s
 = 
lksb
->lksb.
sb_¡©us
;

128 ià(
»s
 =ð-
DLM_EUNLOCK
 ||„e =ð-
DLM_ECANCEL
)

129 
»s
 = 0;

130 } ià(
»s
 == 0) {

131 
»s
 = -
ETIMEDOUT
;

134 
out
:

135  
»s
;

136 
	}
}

139 
ušt32_t
 
	$sc¡_´_num_»gs
(
sc¡_deviû
 *
dev
)

141 
sc¡_dev_»gi¡¿Á
 *
»g
;

142 
ušt32_t
 
num_»gs
 = 0;

144 
	`lockd•_as£¹_´_»ad_lock_h–d
(
dev
);

146 
	`li¡_fÜ_—ch_’Œy
(
»g
, &
dev
->
dev_»gi¡¿Ás_li¡
,

147 
dev_»gi¡¿Ás_li¡_’Œy
)

148 
num_»gs
++;

150  
num_»gs
;

151 
	}
}

154 
	$sc¡_dlm_´_š™_»g
(
sc¡_deviû
 *
dev
,

155 
sc¡_dev_»gi¡¿Á
 *
»g
)

157 
»g
->
lksb
.lksb.
sb_lvb±r
 = (*ìeg->
lvb
;

158 
»g
->
lksb
.lksb.
sb_lkid
 = 0;

159 
»g
->
dlm_idx
 = -1;

160 
	}
}

162 
	$sc¡_dlm_´_rm_»g_ls
(
dlm_lock¥aû_t
 *
ls
,

163 
sc¡_dev_»gi¡¿Á
 *
»g
)

165 
»s
;

167 ià(!
»g
->
lksb
.lksb.
sb_lkid
)

169 
»s
 = 
	`sc¡_dlm_uÆock_wa™
(
ls
, &
»g
->
lksb
);

170 
	`WARN
(
»s
 < 0, "scst_dlm_unlock_wait(%08x) failed (%d)",

171 
»g
->
lksb
.lksb.
sb_lkid
, 
»s
);

172 
»g
->
lksb
.lksb.
sb_lkid
 = 0;

173 
»g
->
dlm_idx
 = -1;

174 
	}
}

177 
	$sc¡_dlm_´_rm_»g
(
sc¡_deviû
 *
dev
,

178 
sc¡_dev_»gi¡¿Á
 *
»g
)

180 
	`lockd•_as£¹_´_wr™e_lock_h–d
(
dev
);

181 
	`sc¡_dlm_´_rm_»g_ls
(
dev
->
´_dlm
->
ls
, 
»g
);

182 
	}
}

185 
boÞ
 
	$sc¡_cÝy_»s_äom_dlm
(
sc¡_deviû
 *
dev
, 
´_lvb
 *
lvb
)

187 
sc¡_´_dlm_d©a
 *cÚ¡ 
´_dlm
 = 
dev
->pr_dlm;

188 
sc¡_£ssiÚ
 *
drÝ³d_»s
 = 
NULL
;

189 
boÞ
 
modif›d_lvb
 = 
çl£
;

191 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

192 
´_dlm
->
»£rved_by_nodeid
 = 
	`be32_to_ýu
(
lvb
->reserved_by_nodeid);

193 ià(
dev
->
»£rved_by
 &&

194 
´_dlm
->
»£rved_by_nodeid
 !ð´_dlm->
loÿl_nodeid
) {

195 
	`PRINT_WARNING
("%s: dropping SPC-2„eservation for %s (dueo"

197 "„e£rv©iÚ", 
dev
->
vœt_Çme
,

198 
dev
->
»£rved_by
->
š™ŸtÜ_Çme
,

199 
´_dlm
->
»£rved_by_nodeid
);

200 
	`sw­
(
dev
->
»£rved_by
, 
drÝ³d_»s
);

202 ià(!
dev
->
»£rved_by
 &&

203 
´_dlm
->
»£rved_by_nodeid
 =ð´_dlm->
loÿl_nodeid
) {

204 
	`PRINT_WARNING
("%s: dropping SPC-2„eservation (dueo„estart"

207 
dev
->
vœt_Çme
, 
´_dlm
->
»£rved_by_nodeid
);

208 
´_dlm
->
»£rved_by_nodeid
 = 0;

209 
lvb
->
»£rved_by_nodeid
 = 0;

210 
modif›d_lvb
 = 
Œue
;

212 ià(
dev
->
»£rved_by
)

213 
	`EXTRACHECKS_BUG_ON
(
´_dlm
->
»£rved_by_nodeid
 !=

214 
´_dlm
->
loÿl_nodeid
);

216 
	`EXTRACHECKS_BUG_ON
(
´_dlm
->
»£rved_by_nodeid
 ==

217 
´_dlm
->
loÿl_nodeid
);

218 ià(
drÝ³d_»s
)

219 
	`sc¡_£ss_g‘
(
drÝ³d_»s
);

220 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

222 ià(
drÝ³d_»s
) {

227 
	`sc¡_£ss_put
(
drÝ³d_»s
);

230  
modif›d_lvb
;

231 
	}
}

240 
	$sc¡_cÝy_äom_dlm
(
sc¡_deviû
 *
dev
, 
dlm_lock¥aû_t
 *
ls
,

241 
boÞ
 *
modif›d_lvb
)

243 
sc¡_´_dlm_d©a
 *cÚ¡ 
´_dlm
 = 
dev
->pr_dlm;

244 
´_lvb
 *
lvb
 = (*)
´_dlm
->lvb;

245 
sc¡_lksb
 *
»g_lksb
 = 
NULL
;

246 
sc¡_dev_»gi¡¿Á
 *
»g
, *
tmp_»g
;

247 
i
, 
»s
 = -
ENOMEM
;

248 
ušt32_t
 
Ä_»gi¡¿Ás
;

249 *
»g_lvb_cÚ‹Á
 = 
NULL
;

251 
	`lockd•_as£¹_h–d
(&
´_dlm
->
ls_mu‹x
);

253 
Ä_»gi¡¿Ás
 = 
	`be32_to_ýu
(
lvb
->nr_registrants);

254 ià(
Ä_»gi¡¿Ás
) {

255 
»g_lksb
 = 
	`vz®loc
(((*»g_lksbè+ 
PR_DLM_LVB_LEN
) *

256 
Ä_»gi¡¿Ás
);

257 ià(!
»g_lksb
) {

258 
	`PRINT_ERROR
("%s: failedo‡llocate %d * %zd bytes of"

259 " memÜy", 
__func__
, 
Ä_»gi¡¿Ás
,

260 (*
»g_lksb
è+ 
PR_DLM_LVB_LEN
);

261 
out
;

263 
»g_lvb_cÚ‹Á
 = (*)
»g_lksb
 +

264 
Ä_»gi¡¿Ás
 * (*
»g_lksb
);

267 
i
 = 0; i < 
Ä_»gi¡¿Ás
; i++) {

268 
»g_Çme
[32];

269 
´_»g_lvb
 *
»g_lvb
;

271 
	`¢´štf
(
»g_Çme
, Ôeg_Çme), 
PR_REG_LOCK
, 
i
);

272 
»g_lvb
 = 
»g_lvb_cÚ‹Á
 + 
i
 * 
PR_DLM_LVB_LEN
;

273 
»g_lksb
[
i
].
lksb
.
sb_lvb±r
 = (*)
»g_lvb
;

274 
»s
 = 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_PW
, &
»g_lksb
[
i
],

275 
DLM_LKF_VALBLK
, 
»g_Çme
, 
NULL
);

276 ià(
»s
 < 0) {

277 
»s
 = -
EFAULT
;

278 
	`PRINT_ERROR
("lockšg %s.% çžed", 
dev
->
vœt_Çme
,

279 
»g_Çme
);

280 
ÿnûl
;

281 } ià(
»g_lksb
[
i
].
lksb
.
sb_æags
 & 
DLM_SBF_VALNOTVALID
) {

282 
»s
 = -
EINVAL
;

283 
	`PRINT_WARNING
("%s.%s has‡n invalid†ock value block",

284 
dev
->
vœt_Çme
, 
»g_Çme
);

285 
ÿnûl
;

286 } ià(
»g_lvb
->
v”siÚ
 != 1) {

287 
»s
 = -
EPROTONOSUPPORT
;

288 
	`PRINT_ERROR
("%s.%s.version = %d instead of 1",

289 
dev
->
vœt_Çme
, 
»g_Çme
,

290 
»g_lvb
->
v”siÚ
);

291 
ÿnûl
;

295 *
modif›d_lvb
 = 
	`sc¡_cÝy_»s_äom_dlm
(
dev
, 
lvb
);

297 
	`sc¡_´_wr™e_lock
(
dev
);

299 
dev
->
´_­l
 = 
lvb
->pr_aptpl;

300 
dev
->
´_g’”©iÚ
 = 
	`be32_to_ýu
(
lvb
->pr_generation);

301 
dev
->
´_is_£t
 = 
lvb
->pr_is_set;

302 
dev
->
´_ty³
 = 
lvb
->pr_type;

303 
dev
->
´_scÝe
 = 
lvb
->pr_scope;

304 
dev
->
´_hÞd”
 = 
NULL
;

306 
	`li¡_fÜ_—ch_’Œy
(
»g
, &
dev
->
dev_»gi¡¿Ás_li¡
,

307 
dev_»gi¡¿Ás_li¡_’Œy
)

308 
	`sc¡_dlm_´_rm_»g_ls
(
ls
, 
»g
);

310 
i
 = 0; i < 
Ä_»gi¡¿Ás
; i++) {

311 
´_»g_lvb
 *
»g_lvb
;

312 
ušt16_t
 
»l_tgt_id
;

314 
»g_lvb
 = (
´_»g_lvb
 *)
»g_lksb
[
i
].
lksb
.
sb_lvb±r
;

315 
»l_tgt_id
 = 
	`be16_to_ýu
(
»g_lvb
->rel_tgt_id);

317 
	`PRINT_INFO
("T¿n¥ÜˆID iÀ%s." 
PR_REG_LOCK
 " (len %d):",

318 
dev
->
vœt_Çme
, 
i
, 
	`sc¡_tid_size
(
»g_lvb
->
tid
));

319 
	`´št_hex_dump
(
KERN_DEBUG
, "", 
DUMP_PREFIX_OFFSET
, 16, 1,

320 
»g_lvb
->
tid
, 
	`sc¡_tid_size
(reg_lvb->tid), 1);

322 
»g
 = 
	`sc¡_´_fšd_»g
(
dev
, 
»g_lvb
->
tid
, 
»l_tgt_id
);

323 ià(
»g
 &&„eg->
key
 !ð
»g_lvb
->key) {

324 
	`sc¡_´_»move_»gi¡¿Á
(
dev
, 
»g
);

325 
»g
 = 
NULL
;

327 ià(!
»g
)

328 
»g
 = 
	`sc¡_´_add_»gi¡¿Á
(
dev
, 
»g_lvb
->
tid
,

329 
»l_tgt_id
, 
»g_lvb
->
key
,

330 
çl£
);

331 ià(
»g
) {

332 
	`sc¡_dlm_´_rm_»g_ls
(
ls
, 
»g
);

333 
»g
->
lksb
.lksb.
sb_lkid
 = 
»g_lksb
[
i
].lksb.sb_lkid;

334 
»g
->
dlm_idx
 = 
i
;

335 
	`memýy
(
»g
->
lvb
, 
»g_lvb_cÚ‹Á
, (reg->lvb));

336 ià(
»g_lvb
->
is_hÞd”
) {

337 ià(
dev
->
´_is_£t
)

338 
	`sc¡_´_þ—r_hÞd”
(
dev
);

339 
	`sc¡_´_£t_hÞd”
(
dev
, 
»g
, 
lvb
->
´_scÝe
,

340 
lvb
->
´_ty³
);

343 
	`PRINT_ERROR
("´_add_»gi¡¿Á %s." 
PR_REG_LOCK


344 " fažed\n", 
dev
->
vœt_Çme
, 
i
);

345 
	`sc¡_dlm_uÆock_wa™
(
ls
, &
»g_lksb
[
i
]);

348 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_CR
, &
»g
->
lksb
,

349 
DLM_LKF_CONVERT
 | 
DLM_LKF_VALBLK
, 
NULL
,

350 
NULL
);

354 
	`li¡_fÜ_—ch_’Œy_§ã
(
»g
, 
tmp_»g
, &
dev
->
dev_»gi¡¿Ás_li¡
,

355 
dev_»gi¡¿Ás_li¡_’Œy
)

356 ià(
»g
->
lksb
.lksb.
sb_lkid
 == 0)

357 
	`sc¡_´_»move_»gi¡¿Á
(
dev
, 
»g
);

359 
	`sc¡_´_wr™e_uÆock
(
dev
);

361 
»s
 = 0;

363 
out
:

364 
	`vä“
(
»g_lksb
);

365  
»s
;

367 
ÿnûl
:

368 
i
 = 0; i < 
Ä_»gi¡¿Ás
; i++)

369 ià(
»g_lksb
[
i
].
lksb
.
sb_lkid
)

370 
	`sc¡_dlm_uÆock_wa™
(
ls
, &
»g_lksb
[
i
]);

372 
out
;

373 
	}
}

375 
sc¡_dev_»gi¡¿Á
*

376 
	$sc¡_g‘_»g_by_dlm_idx
(
sc¡_deviû
 *
dev
, 
i
)

378 
sc¡_dev_»gi¡¿Á
 *
»g
;

380 
	`lockd•_as£¹_´_»ad_lock_h–d
(
dev
);

382 
	`li¡_fÜ_—ch_’Œy
(
»g
, &
dev
->
dev_»gi¡¿Ás_li¡
,

383 
dev_»gi¡¿Ás_li¡_’Œy
)

384 ià(
»g
->
dlm_idx
 =ð
i
)

385  
»g
;

387  
NULL
;

388 
	}
}

390 
	$sc¡_g‘_avažabË_dlm_idx
(
sc¡_deviû
 *
dev
)

392 
i
 = 0;

394 
	`lockd•_as£¹_´_»ad_lock_h–d
(
dev
);

396 
	`sc¡_g‘_»g_by_dlm_idx
(
dev
, 
i
))

397 
i
++;

399  
i
;

400 
	}
}

403 
	$sc¡_cÝy_»s_to_dlm
(
sc¡_deviû
 *
dev
, 
´_lvb
 *
lvb
)

405 
sc¡_´_dlm_d©a
 *cÚ¡ 
´_dlm
 = 
dev
->pr_dlm;

407 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

408 
lvb
->
»£rved_by_nodeid
 = 
	`ýu_to_be32
(
´_dlm
->reserved_by_nodeid);

409 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

410 
	}
}

416 
	$sc¡_cÝy_to_dlm
(
sc¡_deviû
 *
dev
, 
dlm_lock¥aû_t
 *
ls
)

418 
sc¡_´_dlm_d©a
 *cÚ¡ 
´_dlm
 = 
dev
->pr_dlm;

419 
´_lvb
 *
lvb
 = (*)
´_dlm
->lvb;

420 
´_»g_lvb
 *
»g_lvb
;

421 
sc¡_dev_»gi¡¿Á
 *
»g
;

422 
i
, 
tid_size
;

423 
»g_Çme
[32];

424 
ušt32_t
 
Ä_»gi¡¿Ás
;

426 
	`lockd•_as£¹_h–d
(&
´_dlm
->
ls_mu‹x
);

428 
	`sc¡_cÝy_»s_to_dlm
(
dev
, 
lvb
);

430 
	`sc¡_´_wr™e_lock
(
dev
);

432 
Ä_»gi¡¿Ás
 = 
	`sc¡_´_num_»gs
(
dev
);

433 
lvb
->
v”siÚ
 = 1;

434 
lvb
->
´_is_£t
 = 
dev
->pr_is_set;

435 
lvb
->
´_ty³
 = 
dev
->pr_type;

436 
lvb
->
´_scÝe
 = 
dev
->pr_scope;

437 
lvb
->
´_­l
 = 
dev
->pr_aptpl;

438 
lvb
->
Ä_»gi¡¿Ás
 = 
	`ýu_to_be32
(nr_registrants);

439 
lvb
->
´_g’”©iÚ
 = 
	`ýu_to_be32
(
dev
->pr_generation);

441 
	`li¡_fÜ_—ch_’Œy
(
»g
, &
dev
->
dev_»gi¡¿Ás_li¡
,

442 
dev_»gi¡¿Ás_li¡_’Œy
) {

443 ià(
»g
->
dlm_idx
 >ð
Ä_»gi¡¿Ás
)

444 
	`sc¡_dlm_´_rm_»g_ls
(
ls
, 
»g
);

445 ià(
»g
->
dlm_idx
 < 0) {

446 
i
 = 
	`sc¡_g‘_avažabË_dlm_idx
(
dev
);

447 
	`¢´štf
(
»g_Çme
, Ôeg_Çme), 
PR_REG_LOCK
, 
i
);

448 ià(
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_NL
,

449 &
»g
->
lksb
, 0, 
»g_Çme
, 
NULL
)

451 
»g
->
dlm_idx
 = 
i
;

455 
	`li¡_fÜ_—ch_’Œy
(
»g
, &
dev
->
dev_»gi¡¿Ás_li¡
,

456 
dev_»gi¡¿Ás_li¡_’Œy
) {

457 ià(
	`WARN_ON
(!
»g
->
lksb
.lksb.
sb_lkid
))

459 
	`¢´štf
(
»g_Çme
, Ôeg_Çme), 
PR_REG_LOCK
, 
»g
->
dlm_idx
);

460 ià(
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_PW
, &
»g
->
lksb
,

461 
DLM_LKF_VALBLK
 | 
DLM_LKF_CONVERT
,

462 
»g_Çme
, 
NULL
) >= 0) {

463 
»g_lvb
 = (*)
»g
->
lksb
.lksb.
sb_lvb±r
;

464 
	`mem£t
(
»g
->
lvb
, 0, (reg->lvb));

465 
»g_lvb
->
key
 = 
»g
->key;

466 
»g_lvb
->
»l_tgt_id
 = 
	`ýu_to_be16
(
»g
->rel_tgt_id);

467 
»g_lvb
->
v”siÚ
 = 1;

468 
»g_lvb
->
is_hÞd”
 = 
dev
->
´_hÞd”
 =ð
»g
;

469 
tid_size
 = 
	`sc¡_tid_size
(
»g
->
Œª¥Üt_id
);

471 
	`PRINT_INFO
("CÝyšg¿n¥ÜˆID iÁØ%s." 
PR_REG_LOCK


472 " (ËÀ%d)", 
dev
->
vœt_Çme
, 
»g
->
dlm_idx
,

473 
tid_size
);

474 
	`´št_hex_dump
(
KERN_DEBUG
, "", 
DUMP_PREFIX_OFFSET
, 16,

475 1, 
»g
->
Œª¥Üt_id
, 
tid_size
, 1);

477 ià(
	`WARN
(
tid_size
 > (
»g_lvb
->
tid
),

478 "tid_siz%d > %zd\n", 
tid_size
,

479 (
»g_lvb
->
tid
)))

480 
tid_size
 = (
»g_lvb
->
tid
);

481 
	`memýy
(
»g_lvb
->
tid
, 
»g
->
Œª¥Üt_id
, 
tid_size
);

482 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_CR
, &
»g
->
lksb
,

483 
DLM_LKF_CONVERT
 | 
DLM_LKF_VALBLK
,

484 
»g_Çme
, 
NULL
);

486 
	`PRINT_ERROR
("FažedØlock %s.%s", 
dev
->
vœt_Çme
,

487 
»g_Çme
);

491 
	`sc¡_´_wr™e_uÆock
(
dev
);

492 
	}
}

498 
	$sc¡_»ad_fže
(cÚ¡ *
·th
, *
buf
, 
buf_Ën
)

500 
fže
 *
f
;

501 
loff_t
 
pos
;

502 
»t
;

504 
f
 = 
	`fžp_Ý’
(
·th
, 0, 0400);

505 ià(
	`IS_ERR
(
f
)) {

506 
»t
 = 
	`PTR_ERR
(
f
);

507 
out
;

509 
pos
 = 0;

510 
»t
 = 
	`vfs_»ad
(
f
, (
__fÜû
 
__u£r
 *)
buf
, 
buf_Ën
, &
pos
);

511 ià(
»t
 >= 0)

512 
buf
[
	`mš
(
»t
, 
buf_Ën
 - 1)] = '\0';

513 
	`fžp_þo£
(
f
, 
NULL
);

514 
out
:

515  
»t
;

516 
	}
}

518 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(3, 11, 0)

519 
	ssc¡_dlm_»addœ_cÚ‹xt
 {

520 
dœ_cÚ‹xt
 
	mùx
;

521 *
	m’Œ›s
;

526 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 19, 0)

527 
	$sc¡_dlm_fžldœ
(*
¬g
, cÚ¡ *
Çme_¬g
, 
Çme_Ën
,

528 
loff_t
 
cu¼_pos
, 
u64
 
šode
, 
dty³
)

530 
	$sc¡_dlm_fžldœ
(
dœ_cÚ‹xt
 *
¬g
, cÚ¡ *
Çme_¬g
,

531 
Çme_Ën
, 
loff_t
 
cu¼_pos
, 
u64
 
šode
,

532 
dty³
)

535 *
p
, *
q
, 
Çme
[64];

536 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3, 11, 0)

537 **
’Œ›s
 = 
¬g
;

539 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3, 19, 0)

540 
sc¡_dlm_»addœ_cÚ‹xt
 *
ùx
 =

541 
	`cÚš”_of
((
dœ_cÚ‹xt
 *)
¬g
, 
	`ty³of
(*
ùx
), ctx);

543 
sc¡_dlm_»addœ_cÚ‹xt
 *
ùx
 =

544 
	`cÚš”_of
(
¬g
, 
	`ty³of
(*
ùx
), ctx);

546 **
’Œ›s
 = &
ùx
->entries;

548 
i
;

550 
	`¢´štf
(
Çme
, Òame), "%.*s", 
Çme_Ën
, 
Çme_¬g
);

551 ià(
	`¡rcmp
(
Çme
, "."è=ð0 || sŒcmpÒame, ".."è=ð0 || !*
’Œ›s
)

552 
out
;

553 
p
 = *
’Œ›s
; *p;… +ð
	`¡¾’
(p) + 1)

555 
i
 = 
p
 - *
’Œ›s
;

556 
q
 = *
’Œ›s
;

557 *
’Œ›s
 = 
	`k»®loc
(
q
, 
i
 + 
	`¡¾’
(
Çme
è+ 2, 
GFP_KERNEL
);

558 ià(!*
’Œ›s
) {

559 
	`kä“
(
q
);

560 
out
;

562 
	`¡rýy
(*
’Œ›s
 + 
i
, 
Çme
);

563 
i
 +ð
	`¡¾’
(
Çme
);

564 (*
’Œ›s
)[
i
 + 1] = '\0';

566 
out
:

567  *
’Œ›s
 ? 0 : -
ENOMEM
;

568 
	}
}

573 
	$sc¡_dlm_upd©e_nodeids
(
sc¡_´_dlm_d©a
 *
´_dlm
)

575 cÚ¡ 
comms_dœ
[] = "/sys/kernel/config/dlm/cluster/comms";

576 
fže
 *
comms
;

577 *
p
, *
’Œ›s
 = 
	`kz®loc
(1, 
GFP_KERNEL
);

578 
nodeid
;

579 
ušt32_t
 *
Ãw
;

580 
i
, 
»t
, 
num_nodes
;

581 
·th
[256], 
buf
[64];

583 
	`lockd•_as£¹_h–d
(&
´_dlm
->
ls_mu‹x
);

585 
num_nodes
 = 0;

587 
comms
 = 
	`fžp_Ý’
(
comms_dœ
, 0, 0400);

588 ià(
	`IS_ERR
(
comms
)) {

589 
»t
 = 
	`PTR_ERR
(
comms
);

590 
out
;

592 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3, 11, 0)

593 
»t
 = 
	`vfs_»addœ
(
comms
, 
sc¡_dlm_fžldœ
, &
’Œ›s
);

596 
sc¡_dlm_»addœ_cÚ‹xt
 
ùx
 = {

597 .
ùx
 = {

598 .
aùÜ
 = 
sc¡_dlm_fžldœ
,

600 .
’Œ›s
 =ƒntries,

602 
»t
 = 
	`™”©e_dœ
(
comms
, &
ùx
.ctx);

603 
’Œ›s
 = 
ùx
.entries;

606 
	`fžp_þo£
(
comms
, 
NULL
);

607 
»t
 = -
ENOMEM
;

608 ià(!
’Œ›s
)

609 
out
;

610 
p
 = 
’Œ›s
; *p;… +ð
	`¡¾’
(p) + 1)

611 
num_nodes
++;

612 
Ãw
 = 
	`k»®loc
(
´_dlm
->
nodeid
, (*´_dlm->nodeidè* 
num_nodes
,

613 
GFP_KERNEL
);

614 ià(!
Ãw
)

615 
out
;

616 
´_dlm
->
nodeid
 = 
Ãw
;

617 
´_dlm
->
·¹icªts
 = 
num_nodes
;

618 
i
 = 0, 
p
 = 
’Œ›s
; *p; i++,… +ð
	`¡¾’
(p) + 1) {

619 
»t
 = 
	`k¡¹oul
(
p
, 0, &
nodeid
);

620 ià(
	`WARN_ON_ONCE
(
»t
 < 0))

622 
	`¢´štf
(
·th
, Õ©h), "%s/%s/loÿl", 
comms_dœ
, 
p
);

623 ià(
	`sc¡_»ad_fže
(
·th
, 
buf
, (buf)) >= 0 &&

624 
	`¡rcmp
(
buf
, "1\n") == 0)

625 
´_dlm
->
loÿl_nodeid
 = 
nodeid
;

626 
´_dlm
->
nodeid
[
i
] =‚odeid;

628 
»t
 = 0;

630 
out
:

631 
	`kä“
(
’Œ›s
);

632  
»t
;

633 
	}
}

639 
	$sc¡_´_toggË_lock
(
sc¡_´_dlm_d©a
 *
´_dlm
,

640 
dlm_lock¥aû_t
 *
ls
, cÚ¡ *
fmt
)

642 
sc¡_lksb
 
lksb
;

643 
i
, 
»s
;

644 
lock_Çme
[32];

646 
	`mem£t
(&
lksb
, 0, (lksb));

647 
i
 = 0; i < 
´_dlm
->
·¹icªts
; i++) {

648 ià(
´_dlm
->
nodeid
[
i
] =ð´_dlm->
loÿl_nodeid
)

650 
	`¢´štf
(
lock_Çme
, Öock_Çme), 
fmt
, 
´_dlm
->
nodeid
[
i
]);

651 
lksb
.lksb.
sb_lkid
 = 0;

652 
»s
 = 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_PR
, &
lksb
, 0,

653 
lock_Çme
, 
NULL
);

654 ià(
»s
 < 0)

655 
	`PRINT_WARNING
("Locking %s.%s failed (%d)",

656 
´_dlm
->
dev
->
vœt_Çme
, 
lock_Çme
, 
»s
);

657 ià(!
lksb
.lksb.
sb_lkid
)

659 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_NL
, &
lksb
,

660 
DLM_LKF_CONVERT
, 
lock_Çme
, 
NULL
);

661 
	`sc¡_dlm_uÆock_wa™
(
ls
, &
lksb
);

663 
	}
}

666 
	$sc¡_dlm_»move_lock
(
dlm_lock¥aû_t
 *
ls
, 
sc¡_lksb
 *
lksb
,

667 cÚ¡ *
Çme
)

669 ià(!
lksb
->lksb.
sb_lkid
)

671 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_NL
, 
lksb
, 
DLM_LKF_CONVERT
, 
Çme
,

672 
NULL
);

673 
	`sc¡_dlm_uÆock_wa™
(
ls
, 
lksb
);

674 
lksb
->lksb.
sb_lkid
 = 0;

675 
	}
}

677 
	$sc¡_dlm_»move_locks
(
sc¡_´_dlm_d©a
 *
´_dlm
,

678 
dlm_lock¥aû_t
 *
ls
)

680 
sc¡_deviû
 *
dev
 = 
´_dlm
->dev;

681 
sc¡_dev_»gi¡¿Á
 *
»g
;

683 
	`lockd•_as£¹_h–d
(&
´_dlm
->
ls_mu‹x
);

685 
	`sc¡_´_wr™e_lock
(
dev
);

686 
	`li¡_fÜ_—ch_’Œy
(
»g
, &
dev
->
dev_»gi¡¿Ás_li¡
,

687 
dev_»gi¡¿Ás_li¡_’Œy
)

688 
	`sc¡_dlm_´_rm_»g_ls
(
ls
, 
»g
);

689 
	`sc¡_´_wr™e_uÆock
(
dev
);

691 
	`sc¡_dlm_»move_lock
(
ls
, &
´_dlm
->
´e_još_lksb
, 
NULL
);

692 
	`sc¡_dlm_»move_lock
(
ls
, &
´_dlm
->
po¡_još_lksb
, 
NULL
);

693 
	`sc¡_dlm_»move_lock
(
ls
, &
´_dlm
->
´e_upd_lksb
, 
NULL
);

694 
	`sc¡_dlm_»move_lock
(
ls
, &
´_dlm
->
po¡_upd_lksb
, 
NULL
);

695 
	`sc¡_dlm_»move_lock
(
ls
, &
´_dlm
->
d©a_lksb
, 
PR_DATA_LOCK
);

696 
	}
}

703 
	$sc¡_Œigg”_»»ad_lvb
(
sc¡_´_dlm_d©a
 *cÚ¡ 
´_dlm
,

704 
dlm_lock¥aû_t
 *
ls
)

706 
	`sc¡_´_toggË_lock
(
´_dlm
, 
ls
, 
PR_POST_UPDATE_LOCK
);

707 
	`sc¡_´_toggË_lock
(
´_dlm
, 
ls
, 
PR_PRE_UPDATE_LOCK
);

708 
	`sc¡_´_toggË_lock
(
´_dlm
, 
ls
, 
PR_POST_UPDATE_LOCK
);

709 
	}
}

715 
	$sc¡_Œigg”_lvb_upd©e
(
sc¡_´_dlm_d©a
 *cÚ¡ 
´_dlm
,

716 
dlm_lock¥aû_t
 *
ls
)

718 
	`PRINT_INFO
("%s:‡boutorigger‡n LVB update",

719 
´_dlm
->
dev
->
vœt_Çme
);

720 
	`sc¡_´_toggË_lock
(
´_dlm
, 
ls
, 
PR_POST_JOIN_LOCK
);

721 
	`sc¡_´_toggË_lock
(
´_dlm
, 
ls
, 
PR_PRE_JOIN_LOCK
);

722 
	`sc¡_´_toggË_lock
(
´_dlm
, 
ls
, 
PR_POST_JOIN_LOCK
);

723 
	`PRINT_INFO
("%s: finishedriggering‡n LVB update",

724 
´_dlm
->
dev
->
vœt_Çme
);

725 
	}
}

727 
	$dump_lock¥aû
(cÚ¡ *
þ_dev_id
)

729 *
¬gv0
 = 
	`k¡rdup
("/bš/bash", 
GFP_KERNEL
);

730 *
¬gv1
 = 
	`k¡rdup
("-c", 
GFP_KERNEL
);

731 *
¬gv2
 = 
	`ka¥rštf
(
GFP_KERNEL
,

736 
SCST_DLM_LOCKSPACE_PFX
, 
þ_dev_id
);

737 *
¬gv
[] = { 
¬gv0
, 
¬gv1
, 
¬gv2
, 
NULL
 };

738 *
’vp
[] = {

739 
	`k¡rdup
("PATH=/u¤/bš:/bš:/u¤/sbš:/sbš", 
GFP_KERNEL
),

740 
NULL


744 ià(!
¬gv
[0] || !¬gv[1] || !¬gv[2] || !
’vp
[0]) {

745 
	`PRINT_ERROR
("%s: ouˆoàmemÜy", 
__func__
);

746 
out
;

749 
	`PRINT_INFO
("Invokšg %s", 
¬gv2
);

751 
	`ÿÎ_u£rmodeh–³r
(
¬gv0
, 
¬gv
, 
’vp
, 
UMH_WAIT_PROC
);

753 
out
:

754 
	`kä“
(
’vp
[0]);

755 
	`kä“
(
¬gv
[2]);

756 
	`kä“
(
¬gv
[1]);

757 
	`kä“
(
¬gv
[0]);

758 
	}
}

760 
	$»Ëa£_lock¥aû
(
dlm_lock¥aû_t
 *
ls
, cÚ¡ *
þ_dev_id
)

762 
»s
;

764 
»s
 = 
	`dlm_»Ëa£_lock¥aû
(
ls
, 1);

765 ià(
»s
) {

766 
	`PRINT_ERROR
("releasing†ockspace for %s failed: %d",

767 
þ_dev_id
, 
»s
);

768 
	`dump_lock¥aû
(
þ_dev_id
);

770 ià(
»s
 =ð-
EBUSY
) {

776 
»s
 = 
	`dlm_»Ëa£_lock¥aû
(
ls
, 2);

777 ià(
»s
)

778 
	`PRINT_ERROR
("forcibly„eleasing†ockspace for %s"

779 " fažed: %d", 
þ_dev_id
, 
»s
);

781 ià(
»s
 == 0)

782 
	`PRINT_INFO
("»Ëa£d†ock¥aû fÜ %s", 
þ_dev_id
);

783 
	}
}

786 
dlm_lock¥aû_t
 *
	$g‘_lock¥aû
(
sc¡_deviû
 *
dev
)

788 
sc¡_´_dlm_d©a
 *cÚ¡ 
´_dlm
 = 
dev
->pr_dlm;

789 
dlm_lock¥aû_t
 *
ls
;

790 
sc¡_lksb
 
´_lksb
;

791 
´_lvb
 *
lvb
 = (*)
´_dlm
->lvb;

792 
l¥_Çme
[32], 
lock_Çme
[32];

793 
»s
;

794 
boÞ
 
modif›d_lvb
 = 
çl£
;

796 ià(
´_dlm
->
ls
 || !´_dlm->
þ_dev_id
 || 
	`š_š‹¼u±
() ||

797 
	`time_is_aá”_jiff›s
(
´_dlm
->
Ï‹¡_lsü_©‹m±
 + 1 * 
HZ
))

798 
out
;

800 
	`mu‹x_lock
(&
´_dlm
->
ls_ü_mu‹x
);

801 ià(
´_dlm
->
ls
)

802 
out_uÆock_ls_ü
;

804 
´_dlm
->
Ï‹¡_lsü_©‹m±
 = 
jiff›s
;

806 
	`mu‹x_lock
(&
´_dlm
->
ls_mu‹x
);

808 
»s
 = 
	`sc¡_dlm_upd©e_nodeids
(
´_dlm
);

809 ià(
»s
 < 0) {

810 
	`PRINT_ERROR
("scst_dlm_update_nodeids(%s) failed: %d",

811 
dev
->
vœt_Çme
, 
»s
);

812 
out_uÆock_ls
;

814 ià(
´_dlm
->
·¹icªts
 == 0)

815 
out_uÆock_ls
;

817 
	`¢´štf
(
l¥_Çme
, Ö¥_Çme), "%s%s", 
SCST_DLM_LOCKSPACE_PFX
,

818 
´_dlm
->
þ_dev_id
);

819 
»s
 = 
	`sc¡_dlm_Ãw_lock¥aû
(
l¥_Çme
, 
	`¡¾’
Ö¥_Çme), &
ls
,

820 
DLM_LSFL_NEWEXCL
 | 
DLM_LSFL_FS
,

821 
PR_DLM_LVB_LEN
);

822 ià(
»s
) {

823 
	`PRINT_ERROR
("C»©šg DLM†ock¥aû % çžed: %d", 
l¥_Çme
,

824 
»s
);

825 
out_uÆock_ls
;

828 
	`PRINT_INFO
("C»©ed DLM†ock¥aû % fÜ %s", 
l¥_Çme
, 
dev
->
vœt_Çme
);

830 
	`mem£t
(&
´_lksb
, 0, (pr_lksb));

831 
»s
 = 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_EX
, &
´_lksb
, 0, 
PR_LOCK
,

832 
NULL
);

833 ià(
»s
 < 0)

834 
uÆock_dlm_´
;

836 
	`¢´štf
(
lock_Çme
, Öock_Çme), 
PR_POST_JOIN_LOCK
,

837 
´_dlm
->
loÿl_nodeid
);

838 
´_dlm
->
po¡_još_lksb
.pr_dlm =…r_dlm;

839 
»s
 = 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_NL
,

840 &
´_dlm
->
po¡_još_lksb
, 0, 
lock_Çme
,

841 
sc¡_dlm_po¡_ba¡
);

842 ià(
»s
 < 0)

843 
»Ëa£_lock¥aû
;

845 
	`¢´štf
(
lock_Çme
, Öock_Çme), 
PR_PRE_JOIN_LOCK
,

846 
´_dlm
->
loÿl_nodeid
);

847 
´_dlm
->
´e_još_lksb
.pr_dlm =…r_dlm;

848 
»s
 = 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_EX
,

849 &
´_dlm
->
´e_još_lksb
, 0, 
lock_Çme
,

850 
sc¡_dlm_´e_ba¡
);

851 ià(
»s
 < 0)

852 
»Ëa£_lock¥aû
;

854 
»s
 = 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_PW
, &
´_dlm
->
d©a_lksb
,

855 
DLM_LKF_VALBLK
, 
PR_DATA_LOCK
, 
NULL
);

856 ià(
»s
 < 0)

857 
»Ëa£_lock¥aû
;

859 ià(
´_dlm
->
d©a_lksb
.
lksb
.
sb_¡©us
 & 
DLM_SBF_VALNOTVALID
) {

860 
	`PRINT_ERROR
("%s.% lock v®ublock‚Ù v®id", 
dev
->
vœt_Çme
,

861 
PR_DATA_LOCK
);

862 
	`mem£t
(
´_dlm
->
lvb
, 0, (pr_dlm->lvb));

865 
	`¢´štf
(
lock_Çme
, Öock_Çme), 
PR_POST_UPDATE_LOCK
,

866 
´_dlm
->
loÿl_nodeid
);

867 
´_dlm
->
po¡_upd_lksb
.pr_dlm =…r_dlm;

868 
»s
 = 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_NL
,

869 &
´_dlm
->
po¡_upd_lksb
, 0, 
lock_Çme
,

870 
sc¡_dlm_po¡_ba¡
);

871 ià(
»s
 < 0)

872 
»Ëa£_lock¥aû
;

874 
	`¢´štf
(
lock_Çme
, Öock_Çme), 
PR_PRE_UPDATE_LOCK
,

875 
´_dlm
->
loÿl_nodeid
);

876 
´_dlm
->
´e_upd_lksb
.pr_dlm =…r_dlm;

877 
»s
 = 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_EX
, &
´_dlm
->
´e_upd_lksb
,

878 0, 
lock_Çme
, 
sc¡_dlm_´e_ba¡
);

879 ià(
»s
 < 0)

880 
»Ëa£_lock¥aû
;

882 
lvb
->
v”siÚ
) {

884 
	`sc¡_cÝy_to_dlm
(
dev
, 
ls
);

887 
»s
 = 
	`sc¡_cÝy_äom_dlm
(
dev
, 
ls
, &
modif›d_lvb
);

890 
	`PRINT_ERROR
("%s: WrÚg PR LVB v”siÚ %d", 
dev
->
vœt_Çme
,

891 
lvb
->
v”siÚ
);

892 
»Ëa£_lock¥aû
;

895 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_CR
, &
´_dlm
->
d©a_lksb
,

896 
DLM_LKF_CONVERT
 | 
DLM_LKF_VALBLK
, 
PR_DATA_LOCK
,

897 
NULL
);

899 ià(
»s
 =ð-
EINVAL
)

900 
	`sc¡_Œigg”_lvb_upd©e
(
´_dlm
, 
ls
);

901 ià(
modif›d_lvb
)

902 
	`sc¡_Œigg”_»»ad_lvb
(
´_dlm
, 
ls
);

904 
	`sc¡_dlm_uÆock_wa™
(
ls
, &
´_lksb
);

912 
´_dlm
->
ls
 =†s;

914 
out_uÆock_ls
:

915 
	`mu‹x_uÆock
(&
´_dlm
->
ls_mu‹x
);

917 
out_uÆock_ls_ü
:

918 
	`mu‹x_uÆock
(&
´_dlm
->
ls_ü_mu‹x
);

920 
out
:

921  
´_dlm
->
ls
;

923 
»Ëa£_lock¥aû
:

924 
	`sc¡_dlm_»move_locks
(
´_dlm
, 
ls
);

925 
uÆock_dlm_´
:

926 
	`sc¡_dlm_»move_lock
(
ls
, &
´_lksb
, 
PR_LOCK
);

927 
	`mu‹x_uÆock
(&
´_dlm
->
ls_mu‹x
);

929 
	`ÿnûl_wÜk_sync
(&
´_dlm
->
cÝy_äom_dlm_wÜk
);

930 
	`ÿnûl_wÜk_sync
(&
´_dlm
->
cÝy_to_dlm_wÜk
);

931 
	`ÿnûl_wÜk_sync
(&
´_dlm
->
lvb_upd_wÜk
);

932 
	`ÿnûl_wÜk_sync
(&
´_dlm
->
»»ad_lvb_wÜk
);

934 
	`»Ëa£_lock¥aû
(
ls
, 
´_dlm
->
þ_dev_id
);

935 
out_uÆock_ls_ü
;

936 
	}
}

938 
boÞ
 
	$sc¡_dlm_´_is_£t
(
sc¡_deviû
 *
dev
)

940 
	`g‘_lock¥aû
(
dev
);

941  
dev
->
´_is_£t
;

942 
	}
}

944 
	$sc¡_dlm_´_wr™e_lock
(
sc¡_deviû
 *
dev
,

945 
sc¡_lksb
 *
´_lksb
)

947 
sc¡_´_dlm_d©a
 *cÚ¡ 
´_dlm
 = 
dev
->pr_dlm;

948 
dlm_lock¥aû_t
 *
ls
;

950 
	`mem£t
(
´_lksb
, 0, (*pr_lksb));

952 
ls
 = 
	`g‘_lock¥aû
(
dev
);

953 ià(!
ls
)

954 
out
;

956 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_EX
, 
´_lksb
, 0, 
PR_LOCK
, 
NULL
);

957 ià(
´_lksb
->
lksb
.
sb_lkid
) {

958 
	`sc¡_´_toggË_lock
(
´_dlm
, 
ls
, 
PR_POST_UPDATE_LOCK
);

959 
	`sc¡_´_toggË_lock
(
´_dlm
, 
ls
, 
PR_PRE_UPDATE_LOCK
);

960 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_PW
,

961 &
´_dlm
->
d©a_lksb
,

962 
DLM_LKF_CONVERT
 | 
DLM_LKF_VALBLK
,

963 
PR_DATA_LOCK
, 
NULL
);

966 
out
:

972 
	`sc¡_´_wr™e_lock
(
dev
);

973 
	}
}

975 
	$sc¡_dlm_´_wr™e_uÆock
(
sc¡_deviû
 *
dev
,

976 
sc¡_lksb
 *
´_lksb
)

978 
sc¡_´_dlm_d©a
 *cÚ¡ 
´_dlm
 = 
dev
->pr_dlm;

979 
dlm_lock¥aû_t
 *
ls
 = 
´_dlm
->ls;

981 
	`sc¡_´_wr™e_uÆock
(
dev
);

983 ià(!
´_lksb
->
lksb
.
sb_lkid
)

986 
	`sc¡_cÝy_to_dlm
(
dev
, 
ls
);

987 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_CR
, &
´_dlm
->
d©a_lksb
,

988 
DLM_LKF_CONVERT
 | 
DLM_LKF_VALBLK
, 
PR_DATA_LOCK
,

989 
NULL
);

990 
	`sc¡_´_toggË_lock
(
´_dlm
, 
ls
, 
PR_POST_UPDATE_LOCK
);

991 
	`sc¡_dlm_uÆock_wa™
(
ls
, 
´_lksb
);

992 
	}
}

994 
boÞ
 
	$sc¡_dlm_»£rved
(
sc¡_deviû
 *
dev
)

996 
	`EXTRACHECKS_BUG_ON
(
	`š_œq
(è|| 
	`œqs_di§bËd
());

998 
	`g‘_lock¥aû
(
dev
);

999  
dev
->
»£rved_by
 || dev->
´_dlm
->
»£rved_by_nodeid
;

1000 
	}
}

1002 
	$sc¡_dlm_»s_lock
(
sc¡_deviû
 *
dev
,

1003 
sc¡_lksb
 *
´_lksb
)

1004 
	`__acquœes
(&
dev
->
dev_lock
)

1006 
sc¡_´_dlm_d©a
 *cÚ¡ 
´_dlm
 = 
dev
->pr_dlm;

1007 
dlm_lock¥aû_t
 *
ls
;

1009 
	`EXTRACHECKS_BUG_ON
(
	`š_œq
(è|| 
	`œqs_di§bËd
());

1010 
	`mem£t
(
´_lksb
, 0, (*pr_lksb));

1011 
ls
 = 
	`g‘_lock¥aû
(
dev
);

1012 ià(!
ls
)

1013 
out
;

1015 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_EX
, 
´_lksb
, 0, 
PR_LOCK
, 
NULL
);

1016 ià(
´_lksb
->
lksb
.
sb_lkid
) {

1017 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_PW
, &
´_dlm
->
d©a_lksb
,

1018 
DLM_LKF_CONVERT
 | 
DLM_LKF_VALBLK
,

1019 
PR_DATA_LOCK
, 
NULL
);

1022 
out
:

1023 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

1024 
	}
}

1026 
	$sc¡_dlm_»s_uÆock
(
sc¡_deviû
 *
dev
,

1027 
sc¡_lksb
 *
´_lksb
)

1028 
	`__»Ëa£s
(&
dev
->
dev_lock
)

1030 
sc¡_´_dlm_d©a
 *cÚ¡ 
´_dlm
 = 
dev
->pr_dlm;

1031 
dlm_lock¥aû_t
 *
ls
 = 
´_dlm
->ls;

1032 
´_lvb
 *
lvb
 = (*)
´_dlm
->lvb;

1033 
boÞ
 
upd©e_lvb
;

1035 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

1037 ià(!
´_lksb
->
lksb
.
sb_lkid
)

1040 
upd©e_lvb
 = (
	`be32_to_ýu
(
lvb
->
»£rved_by_nodeid
) !=

1041 
´_dlm
->
»£rved_by_nodeid
);

1043 ià(
upd©e_lvb
)

1044 
	`sc¡_cÝy_to_dlm
(
dev
, 
ls
);

1045 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_CR
, &
´_dlm
->
d©a_lksb
,

1046 
DLM_LKF_CONVERT
 | 
DLM_LKF_VALBLK
, 
PR_DATA_LOCK
,

1047 
NULL
);

1048 ià(
upd©e_lvb
) {

1049 
	`sc¡_´_toggË_lock
(
´_dlm
, 
ls
, 
PR_PRE_UPDATE_LOCK
);

1050 
	`sc¡_´_toggË_lock
(
´_dlm
, 
ls
, 
PR_POST_UPDATE_LOCK
);

1052 
	`sc¡_dlm_uÆock_wa™
(
ls
, 
´_lksb
);

1053 
	}
}

1055 
boÞ
 
	$sc¡_dlm_is_rsv_hÞd”
(
sc¡_deviû
 *
dev
,

1056 
sc¡_£ssiÚ
 *
£ss
)

1058  
dev
->
»£rved_by
 =ð
£ss
;

1059 
	}
}

1061 
boÞ
 
	$sc¡_dlm_is_nÙ_rsv_hÞd”
(
sc¡_deviû
 *
dev
,

1062 
sc¡_£ssiÚ
 *
£ss
)

1064  
dev
->
´_dlm
->
»£rved_by_nodeid
 && dev->
»£rved_by
 !ð
£ss
;

1065 
	}
}

1067 
	$sc¡_dlm_»£rve
(
sc¡_deviû
 *
dev
, 
sc¡_£ssiÚ
 *
£ss
)

1069 
dev
->
»£rved_by
 = 
£ss
;

1070 
dev
->
´_dlm
->
»£rved_by_nodeid
 = 
£ss
 ? dev->´_dlm->
loÿl_nodeid
 : 0;

1071 
	}
}

1073 
	$sc¡_dlm_´e_ba¡
(*
ba¡¬g
, 
mode
)

1075 
sc¡_lksb
 *
´e_lksb
 = 
ba¡¬g
;

1076 
sc¡_´_dlm_d©a
 *
´_dlm
 = 
´e_lksb
->pr_dlm;

1077 cÚ¡ 
boÞ
 
još
 = 
´e_lksb
 =ð&
´_dlm
->
´e_još_lksb
;

1080 ià(
još
)

1081 
	`queue_wÜk
(
´_dlm
->
to_wq
, &´_dlm->
´e_još_wÜk
);

1083 
	`queue_wÜk
(
´_dlm
->
äom_wq
, &´_dlm->
´e_upd_wÜk
);

1084 
	}
}

1086 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 20)

1087 
	$sc¡_´e_još_wÜk
(*
p
)

1089 
sc¡_´_dlm_d©a
 *
´_dlm
 = 
p
;

1091 
	$sc¡_´e_još_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1093 
sc¡_´_dlm_d©a
 *
´_dlm
 = 
	`cÚš”_of
(
wÜk
,

1094 
sc¡_´_dlm_d©a
, 
´e_još_wÜk
);

1096 
dlm_lock¥aû_t
 *
ls
;

1098 
	`mu‹x_lock
(&
´_dlm
->
ls_mu‹x
);

1099 
ls
 = 
´_dlm
->ls;

1100 ià(
ls
) {

1101 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_EX
, &
´_dlm
->
po¡_još_lksb
,

1102 
DLM_LKF_CONVERT
, 
NULL
, 
sc¡_dlm_po¡_ba¡
);

1103 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_NL
, &
´_dlm
->
´e_još_lksb
,

1104 
DLM_LKF_CONVERT
, 
NULL
, 
sc¡_dlm_´e_ba¡
);

1106 
	`mu‹x_uÆock
(&
´_dlm
->
ls_mu‹x
);

1107 
	}
}

1109 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 20)

1110 
	$sc¡_´e_upd_wÜk
(*
p
)

1112 
sc¡_´_dlm_d©a
 *
´_dlm
 = 
p
;

1114 
	$sc¡_´e_upd_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1116 
sc¡_´_dlm_d©a
 *
´_dlm
 = 
	`cÚš”_of
(
wÜk
,

1117 
sc¡_´_dlm_d©a
, 
´e_upd_wÜk
);

1119 
dlm_lock¥aû_t
 *
ls
;

1121 
	`mu‹x_lock
(&
´_dlm
->
ls_mu‹x
);

1122 
ls
 = 
´_dlm
->ls;

1123 ià(
ls
) {

1124 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_EX
, &
´_dlm
->
po¡_upd_lksb
,

1125 
DLM_LKF_CONVERT
, 
NULL
, 
sc¡_dlm_po¡_ba¡
);

1126 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_NL
, &
´_dlm
->
´e_upd_lksb
,

1127 
DLM_LKF_CONVERT
, 
NULL
, 
sc¡_dlm_´e_ba¡
);

1129 
	`mu‹x_uÆock
(&
´_dlm
->
ls_mu‹x
);

1130 
	}
}

1132 
	$sc¡_dlm_po¡_ba¡
(*
ba¡¬g
, 
mode
)

1134 
sc¡_lksb
 *
po¡_lksb
 = 
ba¡¬g
;

1135 
sc¡_´_dlm_d©a
 *
´_dlm
 = 
po¡_lksb
->pr_dlm;

1136 cÚ¡ 
boÞ
 
još
 = 
po¡_lksb
 =ð&
´_dlm
->
po¡_još_lksb
;

1139 ià(
još
)

1140 
	`queue_wÜk
(
´_dlm
->
to_wq
, &´_dlm->
cÝy_to_dlm_wÜk
);

1142 
	`queue_wÜk
(
´_dlm
->
äom_wq
, &´_dlm->
cÝy_äom_dlm_wÜk
);

1143 
	}
}

1149 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 20)

1150 
	$sc¡_cÝy_to_dlm_wÜk
(*
p
)

1152 
sc¡_´_dlm_d©a
 *
´_dlm
 = 
p
;

1154 
	$sc¡_cÝy_to_dlm_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1156 
sc¡_´_dlm_d©a
 *
´_dlm
 = 
	`cÚš”_of
(
wÜk
,

1157 
sc¡_´_dlm_d©a
, 
cÝy_to_dlm_wÜk
);

1159 
sc¡_deviû
 *
dev
 = 
´_dlm
->dev;

1160 
dlm_lock¥aû_t
 *
ls
;

1161 
»s
;

1163 
	`PRINT_INFO
("Copying PR stateohe DLM");

1165 
	`mu‹x_lock
(&
´_dlm
->
ls_mu‹x
);

1166 
ls
 = 
´_dlm
->ls;

1167 ià(!
ls
)

1168 
uÆock_ls
;

1169 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_EX
, &
´_dlm
->
´e_još_lksb
,

1170 
DLM_LKF_CONVERT
, 
NULL
, 
sc¡_dlm_´e_ba¡
);

1171 
»s
 = 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_PW
, &
´_dlm
->
d©a_lksb
,

1172 
DLM_LKF_CONVERT
 | 
DLM_LKF_VALBLK
, 
PR_DATA_LOCK
,

1173 
NULL
);

1174 ià(
»s
 < 0) {

1175 
	`PRINT_WARNING
("dlm_lock(%s.%sè»tuºed %d", 
dev
->
vœt_Çme
,

1176 
PR_DATA_LOCK
, 
»s
);

1177 
uÆock_´
;

1184 ià(
´_dlm
->
d©a_lksb
.
lksb
.
sb_æags
 & 
DLM_SBF_VALNOTVALID
)

1185 
	`PRINT_INFO
("%s.% LVB‚Ù v®id\n", 
dev
->
vœt_Çme
,

1186 
PR_DATA_LOCK
);

1188 
	`sc¡_cÝy_to_dlm
(
dev
, 
ls
);

1189 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_CR
, &
´_dlm
->
d©a_lksb
,

1190 
DLM_LKF_CONVERT
 | 
DLM_LKF_VALBLK
, 
PR_DATA_LOCK
,

1191 
NULL
);

1193 
uÆock_´
:

1194 
	`dlm_lock
(
ls
, 
DLM_LOCK_NL
, &
´_dlm
->
po¡_još_lksb
.
lksb
,

1195 
DLM_LKF_CONVERT
, 
NULL
, 0, 0, 
sc¡_dlm_po¡_a¡
,

1196 &
´_dlm
->
po¡_još_lksb
, 
sc¡_dlm_po¡_ba¡
);

1198 
	`PRINT_INFO
("Finished copying PR stateohe DLM");

1200 
	`sc¡_dlm_upd©e_nodeids
(
´_dlm
);

1202 
	`sc¡_´_toggË_lock
(
´_dlm
, 
ls
, 
PR_POST_UPDATE_LOCK
);

1203 
	`sc¡_´_toggË_lock
(
´_dlm
, 
ls
, 
PR_PRE_UPDATE_LOCK
);

1204 
	`sc¡_´_toggË_lock
(
´_dlm
, 
ls
, 
PR_POST_UPDATE_LOCK
);

1206 
uÆock_ls
:

1207 
	`mu‹x_uÆock
(&
´_dlm
->
ls_mu‹x
);

1209 
	`PRINT_INFO
("Finished‚otifying other‚odes‡bouthe‚ew PR state");

1210 
	}
}

1222 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 20)

1223 
	$sc¡_cÝy_äom_dlm_wÜk
(*
p
)

1225 
sc¡_´_dlm_d©a
 *
´_dlm
 = 
p
;

1227 
	$sc¡_cÝy_äom_dlm_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1229 
sc¡_´_dlm_d©a
 *
´_dlm
 = 
	`cÚš”_of
(
wÜk
,

1230 
sc¡_´_dlm_d©a
, 
cÝy_äom_dlm_wÜk
);

1232 
sc¡_deviû
 *
dev
 = 
´_dlm
->dev;

1233 
dlm_lock¥aû_t
 *
ls
;

1234 
»s
 = -
ENOENT
;

1235 
boÞ
 
modif›d_lvb
 = 
çl£
;

1237 
	`mu‹x_lock
(&
´_dlm
->
ls_mu‹x
);

1238 
ls
 = 
´_dlm
->ls;

1239 ià(!
ls
)

1240 
uÆock_ls
;

1241 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_EX
, &
´_dlm
->
´e_upd_lksb
,

1242 
DLM_LKF_CONVERT
, 
NULL
, 
sc¡_dlm_´e_ba¡
);

1243 
»s
 = 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_PW
, &
´_dlm
->
d©a_lksb
,

1244 
DLM_LKF_CONVERT
 | 
DLM_LKF_VALBLK
, 
PR_DATA_LOCK
,

1245 
NULL
);

1246 ià(
»s
 < 0) {

1247 
	`PRINT_WARNING
("dlm_lock(%s.%sè»tuºed %d", 
dev
->
vœt_Çme
,

1248 
PR_DATA_LOCK
, 
»s
);

1249 
uÆock_´
;

1251 ià(
´_dlm
->
d©a_lksb
.
lksb
.
sb_æags
 & 
DLM_SBF_VALNOTVALID
) {

1252 
	`PRINT_WARNING
("%s.%s has‡n invalid†ock value block",

1253 
dev
->
vœt_Çme
, 
PR_DATA_LOCK
);

1254 
»s
 = -
EINVAL
;

1255 
uÆock_´
;

1257 
»s
 = 
	`sc¡_cÝy_äom_dlm
(
dev
, 
ls
, &
modif›d_lvb
);

1258 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_CR
, &
´_dlm
->
d©a_lksb
,

1259 
DLM_LKF_CONVERT
 | 
DLM_LKF_VALBLK
, 
PR_DATA_LOCK
,

1260 
NULL
);

1262 
uÆock_´
:

1263 
	`dlm_lock
(
ls
, 
DLM_LOCK_NL
, &
´_dlm
->
po¡_upd_lksb
.
lksb
,

1264 
DLM_LKF_CONVERT
, 
NULL
, 0, 0, 
sc¡_dlm_po¡_a¡
,

1265 &
´_dlm
->
po¡_upd_lksb
, 
sc¡_dlm_po¡_ba¡
);

1267 
	`sc¡_dlm_upd©e_nodeids
(
´_dlm
);

1269 
uÆock_ls
:

1270 
	`mu‹x_uÆock
(&
´_dlm
->
ls_mu‹x
);

1272 ià(
»s
 =ð-
EINVAL
)

1273 
	`queue_wÜk
(
´_dlm
->
upd_wq
, &´_dlm->
lvb_upd_wÜk
);

1274 ià(
modif›d_lvb
)

1275 
	`queue_wÜk
(
´_dlm
->
upd_wq
, &´_dlm->
»»ad_lvb_wÜk
);

1276 
	}
}

1278 
	$sc¡_dlm_po¡_a¡
(*
a¡¬g
)

1280 
	}
}

1283 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 20)

1284 
	$sc¡_»»ad_lvb_wÜk
(*
p
)

1286 
sc¡_´_dlm_d©a
 *
´_dlm
 = 
p
;

1288 
	$sc¡_»»ad_lvb_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1290 
sc¡_´_dlm_d©a
 *
´_dlm
 = 
	`cÚš”_of
(
wÜk
,

1291 
sc¡_´_dlm_d©a
, 
»»ad_lvb_wÜk
);

1293 
dlm_lock¥aû_t
 *
ls
;

1294 
sc¡_lksb
 
´_lksb
;

1295 
»s
;

1297 
	`mu‹x_lock
(&
´_dlm
->
ls_mu‹x
);

1298 
ls
 = 
´_dlm
->ls;

1299 ià(!
ls
)

1300 
uÆock_ls
;

1301 
	`mem£t
(&
´_lksb
, 0, (pr_lksb));

1302 
»s
 = 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_EX
, &
´_lksb
, 0, 
PR_LOCK
,

1303 
NULL
);

1304 ià(
»s
 >= 0)

1305 
	`sc¡_Œigg”_»»ad_lvb
(
´_dlm
, 
ls
);

1306 ià(
´_lksb
.
lksb
.
sb_lkid
)

1307 
	`sc¡_dlm_uÆock_wa™
(
ls
, &
´_lksb
);

1309 
uÆock_ls
:

1310 
	`mu‹x_uÆock
(&
´_dlm
->
ls_mu‹x
);

1311 
	}
}

1314 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 20)

1315 
	$sc¡_lvb_upd_wÜk
(*
p
)

1317 
sc¡_´_dlm_d©a
 *
´_dlm
 = 
p
;

1319 
	$sc¡_lvb_upd_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1321 
sc¡_´_dlm_d©a
 *
´_dlm
 = 
	`cÚš”_of
(
wÜk
,

1322 
sc¡_´_dlm_d©a
, 
lvb_upd_wÜk
);

1324 
dlm_lock¥aû_t
 *
ls
;

1325 
sc¡_lksb
 
lksb
;

1326 
»s
;

1328 
	`mu‹x_lock
(&
´_dlm
->
ls_mu‹x
);

1329 
ls
 = 
´_dlm
->ls;

1330 ià(!
ls
)

1331 
uÆock_ls
;

1332 
	`mem£t
(&
lksb
, 0, (lksb));

1333 
»s
 = 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_EX
, &
lksb
, 0, 
PR_LOCK
, 
NULL
);

1334 ià(
»s
 >= 0)

1335 
	`sc¡_Œigg”_lvb_upd©e
(
´_dlm
, 
ls
);

1336 ià(
lksb
.lksb.
sb_lkid
)

1337 
	`sc¡_dlm_uÆock_wa™
(
ls
, &
lksb
);

1339 
uÆock_ls
:

1340 
	`mu‹x_uÆock
(&
´_dlm
->
ls_mu‹x
);

1341 
	}
}

1343 
wÜkqueue_¡ruù
 *
	$__´štf
(1, 2)

1344 
	$ü—‹_¡_wq
(cÚ¡ *
fmt
, ...)

1346 
wÜkqueue_¡ruù
 *
wq
 = 
NULL
;

1347 
va_li¡
 
­
;

1348 *
Çme
;

1350 
	`va_¡¬t
(
­
, 
fmt
);

1351 
Çme
 = 
	`kva¥rštf
(
GFP_KERNEL
, 
fmt
, 
­
);

1352 
	`va_’d
(
­
);

1353 ià(
Çme
)

1354 
wq
 = 
	`ü—‹_sšgËth»ad_wÜkqueue
(
Çme
);

1355 
	`kä“
(
Çme
);

1356  
wq
;

1357 
	}
}

1363 
	$sc¡_´_dlm_š™
(
sc¡_deviû
 *
dev
, cÚ¡ *
þ_dev_id
)

1365 
sc¡_´_dlm_d©a
 *
´_dlm
;

1366 
»s
 = -
ENOMEM
;

1368 
	`compže_time_size_checks
();

1369 
´_dlm
 = 
	`kz®loc
((*
dev
->´_dlm), 
GFP_KERNEL
);

1370 ià(!
´_dlm
)

1371 
out
;

1372 
dev
->
´_dlm
 =…r_dlm;

1373 
´_dlm
->
dev
 = dev;

1374 
	`mu‹x_š™
(&
´_dlm
->
ls_ü_mu‹x
);

1375 
	`mu‹x_š™
(&
´_dlm
->
ls_mu‹x
);

1376 
´_dlm
->
d©a_lksb
.
lksb
.
sb_lvb±r
 =…r_dlm->
lvb
;

1377 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 20)

1378 
	`INIT_WORK
(&
´_dlm
->
´e_još_wÜk
, 
sc¡_´e_još_wÜk
,…r_dlm);

1379 
	`INIT_WORK
(&
´_dlm
->
´e_upd_wÜk
, 
sc¡_´e_upd_wÜk
,…r_dlm);

1380 
	`INIT_WORK
(&
´_dlm
->
cÝy_äom_dlm_wÜk
, 
sc¡_cÝy_äom_dlm_wÜk
,…r_dlm);

1381 
	`INIT_WORK
(&
´_dlm
->
cÝy_to_dlm_wÜk
, 
sc¡_cÝy_to_dlm_wÜk
,…r_dlm);

1382 
	`INIT_WORK
(&
´_dlm
->
lvb_upd_wÜk
, 
sc¡_lvb_upd_wÜk
,…r_dlm);

1383 
	`INIT_WORK
(&
´_dlm
->
»»ad_lvb_wÜk
, 
sc¡_»»ad_lvb_wÜk
,…r_dlm);

1385 
	`INIT_WORK
(&
´_dlm
->
´e_još_wÜk
, 
sc¡_´e_još_wÜk
);

1386 
	`INIT_WORK
(&
´_dlm
->
´e_upd_wÜk
, 
sc¡_´e_upd_wÜk
);

1387 
	`INIT_WORK
(&
´_dlm
->
cÝy_äom_dlm_wÜk
, 
sc¡_cÝy_äom_dlm_wÜk
);

1388 
	`INIT_WORK
(&
´_dlm
->
cÝy_to_dlm_wÜk
, 
sc¡_cÝy_to_dlm_wÜk
);

1389 
	`INIT_WORK
(&
´_dlm
->
lvb_upd_wÜk
, 
sc¡_lvb_upd_wÜk
);

1390 
	`INIT_WORK
(&
´_dlm
->
»»ad_lvb_wÜk
, 
sc¡_»»ad_lvb_wÜk
);

1392 
´_dlm
->
Ï‹¡_lsü_©‹m±
 = 
jiff›s
 - 100 * 
HZ
;

1394 
»s
 = -
ENOMEM
;

1395 
´_dlm
->
þ_dev_id
 = 
	`k¡rdup
(þ_dev_id, 
GFP_KERNEL
);

1396 ià(!
´_dlm
->
þ_dev_id
)

1397 
”r_ä“
;

1399 
´_dlm
->
äom_wq
 = 
	`ü—‹_¡_wq
("%s_äom_dlm", 
dev
->
vœt_Çme
);

1400 ià(
	`IS_ERR
(
´_dlm
->
äom_wq
)) {

1401 
»s
 = 
	`PTR_ERR
(
´_dlm
->
äom_wq
);

1402 
´_dlm
->
äom_wq
 = 
NULL
;

1403 
”r_ä“
;

1406 
´_dlm
->
to_wq
 = 
	`ü—‹_¡_wq
("%s_to_dlm", 
dev
->
vœt_Çme
);

1407 ià(
	`IS_ERR
(
´_dlm
->
to_wq
)) {

1408 
»s
 = 
	`PTR_ERR
(
´_dlm
->
to_wq
);

1409 
´_dlm
->
to_wq
 = 
NULL
;

1410 
”r_ä“
;

1413 
´_dlm
->
upd_wq
 = 
	`ü—‹_¡_wq
("%s_upd_dlm", 
dev
->
vœt_Çme
);

1414 ià(
	`IS_ERR
(
´_dlm
->
upd_wq
)) {

1415 
»s
 = 
	`PTR_ERR
(
´_dlm
->
upd_wq
);

1416 
´_dlm
->
upd_wq
 = 
NULL
;

1417 
”r_ä“
;

1420 
»s
 = 0;

1422 
out
:

1423  
»s
;

1425 
”r_ä“
:

1426 
	`sc¡_´_dlm_þ—nup
(
dev
);

1427 
out
;

1428 
	}
}

1443 
	$sc¡_´_dlm_þ—nup
(
sc¡_deviû
 *
dev
)

1445 
sc¡_´_dlm_d©a
 *cÚ¡ 
´_dlm
 = 
dev
->pr_dlm;

1446 
dlm_lock¥aû_t
 *
ls
;

1447 
sc¡_lksb
 
´_lksb
;

1449 ià(!
´_dlm
)

1451 
ls
 = 
´_dlm
->ls;

1452 ià(
ls
) {

1453 
	`mem£t
(&
´_lksb
, 0, (pr_lksb));

1455 
	`mu‹x_lock
(&
´_dlm
->
ls_mu‹x
);

1456 
	`sc¡_dlm_lock_wa™
(
ls
, 
DLM_LOCK_EX
, &
´_lksb
, 0, 
PR_LOCK
, 
NULL
);

1457 
	`sc¡_dlm_»move_locks
(
´_dlm
, 
ls
);

1458 
	`sc¡_dlm_uÆock_wa™
(
ls
, &
´_lksb
);

1459 
´_dlm
->
ls
 = 
NULL
;

1460 
	`mu‹x_uÆock
(&
´_dlm
->
ls_mu‹x
);

1462 ià(
´_dlm
->
äom_wq
)

1463 
	`ÿnûl_wÜk_sync
(&
´_dlm
->
cÝy_äom_dlm_wÜk
);

1464 ià(
´_dlm
->
to_wq
)

1465 
	`ÿnûl_wÜk_sync
(&
´_dlm
->
cÝy_to_dlm_wÜk
);

1466 ià(
´_dlm
->
upd_wq
) {

1467 
	`ÿnûl_wÜk_sync
(&
´_dlm
->
lvb_upd_wÜk
);

1468 
	`ÿnûl_wÜk_sync
(&
´_dlm
->
»»ad_lvb_wÜk
);

1470 
	`»Ëa£_lock¥aû
(
ls
, 
´_dlm
->
þ_dev_id
);

1472 ià(
´_dlm
->
upd_wq
)

1473 
	`de¡roy_wÜkqueue
(
´_dlm
->
upd_wq
);

1474 ià(
´_dlm
->
to_wq
)

1475 
	`de¡roy_wÜkqueue
(
´_dlm
->
to_wq
);

1476 ià(
´_dlm
->
äom_wq
)

1477 
	`de¡roy_wÜkqueue
(
´_dlm
->
äom_wq
);

1478 
	`kä“
(
´_dlm
->
nodeid
);

1479 
	`kä“
(
´_dlm
->
þ_dev_id
);

1480 
	`kä“
(
´_dlm
);

1481 
dev
->
´_dlm
 = 
NULL
;

1482 
	}
}

1484 cÚ¡ 
sc¡_þ_Ýs
 
	gsc¡_dlm_þ_Ýs
 = {

1485 .
´_š™
 = 
sc¡_´_dlm_š™
,

1486 .
	g´_þ—nup
 = 
sc¡_´_dlm_þ—nup
,

1487 .
	g´_is_£t
 = 
sc¡_dlm_´_is_£t
,

1488 .
	g´_š™_»g
 = 
sc¡_dlm_´_š™_»g
,

1489 .
	g´_rm_»g
 = 
sc¡_dlm_´_rm_»g
,

1490 .
	g´_wr™e_lock
 = 
sc¡_dlm_´_wr™e_lock
,

1491 .
	g´_wr™e_uÆock
 = 
sc¡_dlm_´_wr™e_uÆock
,

1492 .
	g»£rved
 = 
sc¡_dlm_»£rved
,

1493 .
	g»s_lock
 = 
sc¡_dlm_»s_lock
,

1494 .
	g»s_uÆock
 = 
sc¡_dlm_»s_uÆock
,

1495 .
	gis_rsv_hÞd”
 = 
sc¡_dlm_is_rsv_hÞd”
,

1496 .
	gis_nÙ_rsv_hÞd”
 = 
sc¡_dlm_is_nÙ_rsv_hÞd”
,

1497 .
	g»£rve
 = 
sc¡_dlm_»£rve
,

	@scst/src/scst_dlm.h

18 #iâdeà
__SCST_PRES_DLM_H


19 
	#__SCST_PRES_DLM_H


	)

21 
	~<lšux/dlm.h
>

22 
	~<lšux/mu‹x.h
>

23 
	~<lšux/wÜkqueue.h
>

25 
	#SCST_DLM_LOCKSPACE_PFX
 "sc¡-"

	)

30 
	#PR_LOCK
 "´"

	)

31 
	#PR_DATA_LOCK
 "´_d©a"

	)

32 
	#PR_PRE_JOIN_LOCK
 "´_´e_još_%d"

	)

33 
	#PR_POST_JOIN_LOCK
 "´_po¡_još_%d"

	)

34 
	#PR_PRE_UPDATE_LOCK
 "´_´e_%d"

	)

35 
	#PR_POST_UPDATE_LOCK
 "´_po¡_%d"

	)

36 
	#PR_REG_LOCK
 "´_»g_%02d"

	)

52 
	ssc¡_´_dlm_d©a
 {

54 
sc¡_deviû
 *
	mdev
;

57 cÚ¡ *
	mþ_dev_id
;

60 
mu‹x
 
	mls_ü_mu‹x
;

63 
mu‹x
 
	mls_mu‹x
;

69 
dlm_lock¥aû_t
 *
	mls
;

72 
	mÏ‹¡_lsü_©‹m±
;

75 
ušt32_t
 
	mloÿl_nodeid
;

78 
	m·¹icªts
;

81 
ušt32_t
 *
	mnodeid
;

84 
wÜkqueue_¡ruù
 *
	mäom_wq
;

86 
wÜkqueue_¡ruù
 *
	mto_wq
;

88 
wÜkqueue_¡ruù
 *
	mupd_wq
;

90 
wÜk_¡ruù
 
	m´e_još_wÜk
;

91 
wÜk_¡ruù
 
	m´e_upd_wÜk
;

92 
wÜk_¡ruù
 
	mcÝy_äom_dlm_wÜk
;

93 
wÜk_¡ruù
 
	mcÝy_to_dlm_wÜk
;

94 
wÜk_¡ruù
 
	mlvb_upd_wÜk
;

95 
wÜk_¡ruù
 
	m»»ad_lvb_wÜk
;

101 
sc¡_lksb
 
	m´e_još_lksb
;

102 
sc¡_lksb
 
	mpo¡_još_lksb
;

103 
sc¡_lksb
 
	md©a_lksb
;

104 
sc¡_lksb
 
	m´e_upd_lksb
;

105 
sc¡_lksb
 
	mpo¡_upd_lksb
;

108 
ušt8_t
 
	mlvb
[
PR_DLM_LVB_LEN
];

111 
ušt32_t
 
	m»£rved_by_nodeid
;

126 
	s´_lvb
 {

127 
__be32
 
	mÄ_»gi¡¿Ás
;

128 
__be32
 
	m´_g’”©iÚ
;

129 
u8
 
	mv”siÚ
;

130 
u8
 
	m´_is_£t
;

131 
u8
 
	m´_ty³
;

132 
u8
 
	m´_scÝe
;

133 
u8
 
	m´_­l
;

134 
u8
 
	m»£rved
[3];

135 
__be32
 
	m»£rved_by_nodeid
;

146 
	s´_»g_lvb
 {

147 
__be64
 
	mkey
;

148 
__be16
 
	m»l_tgt_id
;

149 
u8
 
	mv”siÚ
;

150 
u8
 
	mis_hÞd”
;

151 
u8
 
	mtid
[228];

	@scst/src/scst_event.c

8 
	~<lšux/kth»ad.h
>

9 
	~<lšux/d–ay.h
>

10 
	~<lšux/pÞl.h
>

11 
	~<lšux/¡ddef.h
>

12 
	~<lšux/¦ab.h
>

13 
	~<lšux/moduË.h
>

15 #ifdeà
INSIDE_KERNEL_TREE


16 
	~<sc¡/sc¡.h
>

17 
	~<sc¡/sc¡_ev’t.h
>

19 
	~"sc¡.h
"

20 
	~"sc¡_ev’t.h
"

23 
	~"sc¡_´iv.h
"

25 
þass
 *
	gsc¡_ev’t_sysfs_þass
;

27 
	gsc¡_ev’t_majÜ
;

29 
	#SCST_MAX_EVENTS
 2048

	)

30 
	#SCST_MAX_PAYLOAD
 3*1024

	)

31 
	#SCST_DEFAULT_EVENT_TIMEOUT
 (60*
HZ
)

	)

33 
	ssc¡_ev’t_´iv
 {

34 
li¡_h—d
 
	m´ivs_li¡_’Œy
;

35 
	m®lowed_ev’ts_út
;

36 
	mqueued_ev’ts_út
;

37 
	mgošg_to_ex™
:1;

38 
	mblockšg
:1;

39 
pid_t
 
	mowÃr_pid
;

45 
li¡_h—d
 
	m®lowed_ev’ts_li¡
;

46 
li¡_h—d
 
	mqueued_ev’ts_li¡
;

47 
wa™_queue_h—d_t
 
	mqueued_ev’ts_wa™Q
;

48 
li¡_h—d
 
	m´oûssšg_ev’ts_li¡
;

51 
DEFINE_MUTEX
(
sc¡_ev’t_mu‹x
);

52 
LIST_HEAD
(
sc¡_ev’t_´ivs_li¡
);

61 
boÞ
 
	$sc¡_ev’t_cmp
(cÚ¡ 
sc¡_ev’t
 *
e1_wžd
,

62 cÚ¡ 
sc¡_ev’t
 *
e2
)

64 
»s
 = 
çl£
;

66 
	`TRACE_ENTRY
();

68 ià((
e1_wžd
->
ev’t_code
 !ð
e2
->event_code) &&

69 (
e1_wžd
->
ev’t_code
 != 0))

70 
out
;

72 ià((
	`¡rcmp
(
e1_wžd
->
issu”_Çme
, 
e2
->issuer_name) != 0) &&

73 (
	`¡rcmp
(
e1_wžd
->
issu”_Çme
, "*") != 0))

74 
out
;

76 ià(
e1_wžd
->
·ylßd_Ën
 == 0)

77 
out_Œue
;

79 ià((
e1_wžd
->
·ylßd_Ën
 !ð
e2
->payload_len) ||

80 (
	`memcmp
(
e1_wžd
->
·ylßd
, 
e2
->·ylßd,ƒ1_wžd->
·ylßd_Ën
) != 0))

81 
out
;

83 
out_Œue
:

84 
»s
 = 
Œue
;

86 
out
:

87 
	`TRACE_EXIT_RES
(
»s
);

88  
»s
;

89 
	}
}

91 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 20)

92 
	$sc¡_ev’t_timeout_â
(*
p
)

94 
sc¡_ev’t_’Œy
 *
ev’t_’Œy
 = 
p
;

96 
	$sc¡_ev’t_timeout_â
(
wÜk_¡ruù
 *
wÜk
)

98 
sc¡_ev’t_’Œy
 *
ev’t_’Œy
 = 
	`cÚš”_of
(
wÜk
,

99 
sc¡_ev’t_’Œy
, 
ev’t_timeout_wÜk
.
wÜk
);

102 
	`TRACE_ENTRY
();

104 
	`TRACE_MGMT_DBG
("Timeout ofƒvent %d (issuer %s, id %u,ƒntry %p)",

105 
ev’t_’Œy
->
ev’t
.
ev’t_code
,ƒv’t_’Œy->ev’t.
issu”_Çme
,

106 
ev’t_’Œy
->
ev’t
.
ev’t_id
,ƒvent_entry);

108 
	`mu‹x_lock
(&
sc¡_ev’t_mu‹x
);

110 ià(
	`li¡_em±y
(&
ev’t_’Œy
->
ev’ts_li¡_’Œy
)) {

112 
	`mu‹x_uÆock
(&
sc¡_ev’t_mu‹x
);

113 
out
;

115 
	`li¡_d–_š™
(&
ev’t_’Œy
->
ev’ts_li¡_’Œy
);

117 (*
ev’t_’Œy
->
pqueued_ev’ts_út
)--;

119 
	`mu‹x_uÆock
(&
sc¡_ev’t_mu‹x
);

121 
	`TRACE_DBG
("C®lšg‚Ùify_â oàev’t_’Œy %p", 
ev’t_’Œy
);

122 
ev’t_’Œy
->
	`ev’t_nÙify_â
(&ev’t_’Œy->
ev’t
,

123 
ev’t_’Œy
->
nÙify_â_´iv
, -
ETIMEDOUT
);

125 
	`TRACE_MEM
("F»ešgƒv’ˆ’Œy %p", 
ev’t_’Œy
);

126 
	`kä“
(
ev’t_’Œy
);

128 
out
:

129 
	`TRACE_EXIT
();

131 
	}
}

133 
	$sc¡_þÚe_ev’t
(cÚ¡ 
sc¡_ev’t_’Œy
 *
Üig_’Œy
,

134 
sc¡_ev’t_’Œy
 **
Ãw_ev’t_’Œy
)

136 
»s
 = 0;

137 cÚ¡ 
sc¡_ev’t
 *
ev’t
 = &
Üig_’Œy
->event;

138 
sc¡_ev’t_’Œy
 *
ev’t_’Œy
;

139 
ev’t_’Œy_Ën
 = (*
ev’t_’Œy
è+ 
ev’t
->
·ylßd_Ën
;

141 
	`TRACE_ENTRY
();

143 
ev’t_’Œy
 = 
	`kz®loc
(
ev’t_’Œy_Ën
, 
GFP_KERNEL
);

144 ià(
ev’t_’Œy
 =ð
NULL
) {

145 
	`PRINT_ERROR
("Unableo cloneƒventƒntry (size %d,ƒvent %d, "

146 "issu” %s", 
ev’t_’Œy_Ën
, 
ev’t
->
ev’t_code
,

147 
ev’t
->
issu”_Çme
);

148 
»s
 = -
ENOMEM
;

149 
out
;

152 
	`TRACE_MEM
("ev’t_’Œy %°Ö’ %dè®loÿ‹d", 
ev’t_’Œy
, 
ev’t_’Œy_Ën
);

154 
	`memýy
(&
ev’t_’Œy
->
ev’t
,ƒv’t, (*ev’tè+ƒv’t->
·ylßd_Ën
);

156 
	`WARN_ON
(
Üig_’Œy
->
ev’t_nÙify_â
 !ð
NULL
);

158 *
Ãw_ev’t_’Œy
 = 
ev’t_’Œy
;

160 
out
:

161 
	`TRACE_EXIT_RES
(
»s
);

162  
»s
;

163 
	}
}

165 
	$__sc¡_ev’t_queue
(
sc¡_ev’t_’Œy
 *
ev’t_’Œy
)

167 cÚ¡ 
sc¡_ev’t
 *
ev’t
 = &
ev’t_’Œy
->event;

168 
sc¡_ev’t_´iv
 *
´iv
;

169 
sc¡_ev’t_’Œy
 *
®lowed_’Œy
;

170 
boÞ
 
queued
 = 
çl£
;

171 
rc
 = 0;

172 
©omic_t
 
ba£_ev’t_id
 = 
	`ATOMIC_INIT
(0);

174 
	`TRACE_ENTRY
();

176 
	`mu‹x_lock
(&
sc¡_ev’t_mu‹x
);

178 
	`li¡_fÜ_—ch_’Œy
(
´iv
, &
sc¡_ev’t_´ivs_li¡
, 
´ivs_li¡_’Œy
) {

179 
	`li¡_fÜ_—ch_’Œy
(
®lowed_’Œy
, &
´iv
->
®lowed_ev’ts_li¡
,

180 
ev’ts_li¡_’Œy
) {

181 ià(
	`sc¡_ev’t_cmp
(&
®lowed_’Œy
->
ev’t
,ƒvent)) {

182 
sc¡_ev’t_’Œy
 *
Ãw_ev’t_’Œy
;

184 ià(
´iv
->
queued_ev’ts_út
 >ð
SCST_MAX_EVENTS
) {

185 
	`PRINT_ERROR
("Too many queuedƒvents %d, "

187 
´iv
->
queued_ev’ts_út
,

188 
ev’t
->
ev’t_code
,

189 
ev’t
->
issu”_Çme
);

190 
rc
 = -
EMFILE
;

194 ià(!
queued
)

195 
Ãw_ev’t_’Œy
 = 
ev’t_’Œy
;

196 ià(
ev’t_’Œy
->
ev’t_nÙify_â
 =ð
NULL
) {

197 
rc
 = 
	`sc¡_þÚe_ev’t
(
ev’t_’Œy
, &
Ãw_ev’t_’Œy
);

198 ià(
rc
 != 0)

199 
dÚe
;

201 
	`PRINT_WARNING
("Event %d can be queued only once, "

203 
ev’t
->
ev’t_code
, 
´iv
->
owÃr_pid
);

207 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 20)

208 
	`INIT_WORK
(&
Ãw_ev’t_’Œy
->
ev’t_timeout_wÜk
,

209 
sc¡_ev’t_timeout_â
,

210 
Ãw_ev’t_’Œy
);

212 
	`INIT_DELAYED_WORK
(&
Ãw_ev’t_’Œy
->
ev’t_timeout_wÜk
,

213 
sc¡_ev’t_timeout_â
);

215 ià(
Ãw_ev’t_’Œy
->
ev’t_nÙify_â
 !ð
NULL
) {

216 
Ãw_ev’t_’Œy
->
ev’t
.
ev’t_id
 = 
	`©omic_šc_»tuº
(&
ba£_ev’t_id
);

217 ià(
Ãw_ev’t_’Œy
->
ev’t_timeout
 == 0)

218 
Ãw_ev’t_’Œy
->
ev’t_timeout
 = 
SCST_DEFAULT_EVENT_TIMEOUT
;

219 
	`scheduË_d–ayed_wÜk
(&
Ãw_ev’t_’Œy
->
ev’t_timeout_wÜk
,

220 
Ãw_ev’t_’Œy
->
ev’t_timeout
);

223 
	`li¡_add_ž
(&
Ãw_ev’t_’Œy
->
ev’ts_li¡_’Œy
,

224 &
´iv
->
queued_ev’ts_li¡
);

225 
´iv
->
queued_ev’ts_út
++;

226 
Ãw_ev’t_’Œy
->
pqueued_ev’ts_út
 = &
´iv
->
queued_ev’ts_út
;

227 
queued
 = 
Œue
;

229 
	`TRACE_DBG
("event %d queued (issuer %s, id %u, "

230 "’Œy %p)", 
Ãw_ev’t_’Œy
->
ev’t
.
ev’t_code
,

231 
Ãw_ev’t_’Œy
->
ev’t
.
issu”_Çme
,

232 
Ãw_ev’t_’Œy
->
ev’t
.
ev’t_id
,‚ew_event_entry);

234 
	`wake_up_®l
(&
´iv
->
queued_ev’ts_wa™Q
);

239 
dÚe
:

240 
	`mu‹x_uÆock
(&
sc¡_ev’t_mu‹x
);

242 ià(!
queued
) {

243 ià(
ev’t_’Œy
->
ev’t_nÙify_â
 !ð
NULL
) {

244 ià(
rc
 == 0)

245 
rc
 = -
ENOENT
;

246 
	`TRACE_DBG
("Calling‚otify_fn ofƒvent_entry %p (rc %d)",

247 
ev’t_’Œy
, 
rc
);

248 
ev’t_’Œy
->
	`ev’t_nÙify_â
(&ev’t_’Œy->
ev’t
,

249 
ev’t_’Œy
->
nÙify_â_´iv
, 
rc
);

252 
	`TRACE_MEM
("F»ešg o½hªƒv’ˆ’Œy %p", 
ev’t_’Œy
);

253 
	`kä“
(
ev’t_’Œy
);

256 
	`TRACE_EXIT
();

258 
	}
}

260 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 20)

261 
	$sc¡_ev’t_queue_wÜk_â
(*
p
)

263 
sc¡_ev’t_’Œy
 *
e
 = 
p
;

265 
	$sc¡_ev’t_queue_wÜk_â
(
wÜk_¡ruù
 *
wÜk
)

267 
sc¡_ev’t_’Œy
 *
e
 = 
	`cÚš”_of
(
wÜk
,

268 
sc¡_ev’t_’Œy
, 
sc¡_ev’t_queue_wÜk
);

271 
	`TRACE_ENTRY
();

273 
	`__sc¡_ev’t_queue
(
e
);

275 
	`TRACE_EXIT
();

277 
	}
}

280 
	$sc¡_ev’t_queue
(
ušt32_t
 
ev’t_code
, cÚ¡ *
issu”_Çme
,

281 
sc¡_ev’t_’Œy
 *
e
)

283 
	`TRACE_ENTRY
();

285 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 20)

286 
	`INIT_WORK
(&
e
->
sc¡_ev’t_queue_wÜk
, 
sc¡_ev’t_queue_wÜk_â
,ƒ);

288 
	`INIT_WORK
(&
e
->
sc¡_ev’t_queue_wÜk
, 
sc¡_ev’t_queue_wÜk_â
);

291 
	`TRACE_DBG
("Schedulšgƒv’ˆ’Œy %p", 
e
);

293 
e
->
ev’t
.
ev’t_code
 =ƒvent_code;

294 
	`¡¾ýy
(
e
->
ev’t
.
issu”_Çme
, issuer_name, (e->event.issuer_name));

296 
	`scheduË_wÜk
(&
e
->
sc¡_ev’t_queue_wÜk
);

298 
	`TRACE_EXIT
();

300 
	}
}

301 
EXPORT_SYMBOL_GPL
(
sc¡_ev’t_queue
);

304 
	$sc¡_ev’t_queue_lun_nÙ_found
(cÚ¡ 
sc¡_cmd
 *
cmd
)

306 
»s
 = 0, 
ev’t_’Œy_Ën
;

307 
sc¡_ev’t_’Œy
 *
ev’t_’Œy
;

308 
sc¡_ev’t
 *
ev’t
;

309 
sc¡_ev’t_lun_nÙ_found_·ylßd
 *
·ylßd
;

311 
	`TRACE_ENTRY
();

313 
ev’t_’Œy_Ën
 = (*
ev’t_’Œy
è+ (*
·ylßd
);

314 
ev’t_’Œy
 = 
	`kz®loc
(
ev’t_’Œy_Ën
, 
GFP_ATOMIC
);

315 ià(
ev’t_’Œy
 =ð
NULL
) {

316 
	`PRINT_ERROR
("Unableo‡llocateƒvent (size %d). LUN‚ot found "

318 
ev’t_’Œy_Ën
, ()
cmd
->
lun
,

319 
cmd
->
£ss
->
š™ŸtÜ_Çme
, cmd->
tgt
->
tgt_Çme
);

320 
»s
 = -
ENOMEM
;

321 
out
;

324 
	`TRACE_MEM
("ev’t_’Œy %°Ö’ %dè®loÿ‹d", 
ev’t_’Œy
,

325 
ev’t_’Œy_Ën
);

327 
ev’t
 = &
ev’t_’Œy
->event;

329 
ev’t
->
·ylßd_Ën
 = (*
·ylßd
);

330 
·ylßd
 = (
sc¡_ev’t_lun_nÙ_found_·ylßd
 *)
ev’t
->payload;

332 
·ylßd
->
lun
 = 
cmd
->lun;

333 
	`¡¾ýy
(
·ylßd
->
š™ŸtÜ_Çme
, 
cmd
->
£ss
->initiator_name,

334 (
·ylßd
->
š™ŸtÜ_Çme
));

335 
	`¡¾ýy
(
·ylßd
->
rg‘_Çme
, 
cmd
->
tgt
->
tgt_Çme
,

336 (
·ylßd
->
rg‘_Çme
));

338 
	`sc¡_ev’t_queue
(
SCST_EVENT_LUN_NOT_FOUND
,

339 
SCST_EVENT_SCST_CORE_ISSUER
, 
ev’t_’Œy
);

341 
out
:

342 
	`TRACE_EXIT_RES
(
»s
);

343  
»s
;

344 
	}
}

346 
	$sc¡_ev’t_queue_Ãg©ive_luns_šquœy
(cÚ¡ 
sc¡_tgt
 *
tgt
,

347 cÚ¡ *
š™ŸtÜ_Çme
)

349 
»s
 = 0, 
ev’t_’Œy_Ën
;

350 
sc¡_ev’t_’Œy
 *
ev’t_’Œy
;

351 
sc¡_ev’t
 *
ev’t
;

352 
sc¡_ev’t_Ãg©ive_luns_šquœy_·ylßd
 *
·ylßd
;

354 
	`TRACE_ENTRY
();

356 
ev’t_’Œy_Ën
 = (*
ev’t_’Œy
è+ (*
·ylßd
);

357 
ev’t_’Œy
 = 
	`kz®loc
(
ev’t_’Œy_Ën
, 
GFP_ATOMIC
);

358 ià(
ev’t_’Œy
 =ð
NULL
) {

359 
	`PRINT_ERROR
("Unableo‡llocateƒvent (size %d). NEGATIVE LUNS "

361 
ev’t_’Œy_Ën
, 
š™ŸtÜ_Çme
, 
tgt
->
tgt_Çme
);

362 
»s
 = -
ENOMEM
;

363 
out
;

366 
	`TRACE_MEM
("ev’t_’Œy %°Ö’ %dè®loÿ‹d", 
ev’t_’Œy
,

367 
ev’t_’Œy_Ën
);

369 
ev’t
 = &
ev’t_’Œy
->event;

371 
ev’t
->
·ylßd_Ën
 = (*
·ylßd
);

372 
·ylßd
 = (
sc¡_ev’t_Ãg©ive_luns_šquœy_·ylßd
 *)
ev’t
->payload;

374 
	`¡¾ýy
(
·ylßd
->
š™ŸtÜ_Çme
, initiator_name,

375 (
·ylßd
->
š™ŸtÜ_Çme
));

376 
	`¡¾ýy
(
·ylßd
->
rg‘_Çme
, 
tgt
->
tgt_Çme
,

377 (
·ylßd
->
rg‘_Çme
));

379 
	`sc¡_ev’t_queue
(
SCST_EVENT_NEGATIVE_LUNS_INQUIRY
,

380 
SCST_EVENT_SCST_CORE_ISSUER
, 
ev’t_’Œy
);

382 
out
:

383 
	`TRACE_EXIT_RES
(
»s
);

384  
»s
;

385 
	}
}

388 
	$sc¡_ev’t_queue_ext_blockšg_dÚe
(
sc¡_deviû
 *
dev
, *
d©a
, 
Ën
)

390 
»s
, 
ev’t_’Œy_Ën
;

391 
sc¡_ev’t_’Œy
 *
ev’t_’Œy
;

392 
sc¡_ev’t
 *
ev’t
;

393 
sc¡_ev’t_ext_blockšg_dÚe_·ylßd
 *
·ylßd
;

395 
	`TRACE_ENTRY
();

397 
ev’t_’Œy_Ën
 = (*
ev’t_’Œy
è+ (*
·ylßd
è+ 
Ën
;

398 
ev’t_’Œy
 = 
	`kz®loc
(
ev’t_’Œy_Ën
, 
GFP_ATOMIC
);

399 ià(
ev’t_’Œy
 =ð
NULL
) {

400 
	`PRINT_CRIT_ERROR
("Unableo‡llocateƒvent. Ext blocking "

401 "dÚev’ˆi lo¡ (deviû %s, siz%zd)!", 
dev
->
vœt_Çme
,

402 (*
ev’t_’Œy
è+ (*
·ylßd
è+ 
Ën
);

403 
»s
 = -
ENOMEM
;

404 
out
;

407 
	`TRACE_MEM
("ev’t_’Œy %°Ö’ %dè®loÿ‹d", 
ev’t_’Œy
,

408 
ev’t_’Œy_Ën
);

410 
ev’t
 = &
ev’t_’Œy
->event;

412 
ev’t
->
·ylßd_Ën
 = (*
·ylßd
è+ 
Ën
;

413 
·ylßd
 = (
sc¡_ev’t_ext_blockšg_dÚe_·ylßd
 *)
ev’t
->payload;

415 
	`¡¾ýy
(
·ylßd
->
deviû_Çme
, 
dev
->
vœt_Çme
, (payload->device_name));

416 ià(
Ën
 > 0)

417 
	`memýy
(
·ylßd
->
d©a
, d©a, 
Ën
);

419 
	`sc¡_ev’t_queue
(
SCST_EVENT_EXT_BLOCKING_DONE
,

420 
SCST_EVENT_SCST_CORE_ISSUER
, 
ev’t_’Œy
);

421 
»s
 = 0;

423 
out
:

424 
	`TRACE_EXIT_RES
(
»s
);

425  
»s
;

426 
	}
}

429 
	$sc¡_ev’t_queue_tm_â_»ûived
(
sc¡_mgmt_cmd
 *
mcmd
)

431 
»s
 = 0, 
ev’t_’Œy_Ën
;

432 
sc¡_ev’t_’Œy
 *
ev’t_’Œy
;

433 
sc¡_ev’t
 *
ev’t
;

434 
sc¡_ev’t_tm_â_»ûived_·ylßd
 *
·ylßd
;

436 
	`TRACE_ENTRY
();

438 
ev’t_’Œy_Ën
 = (*
ev’t_’Œy
è+ (*
·ylßd
);

439 
ev’t_’Œy
 = 
	`kz®loc
(
ev’t_’Œy_Ën
, 
GFP_KERNEL
);

440 ià(
ev’t_’Œy
 =ð
NULL
) {

441 
	`PRINT_CRIT_ERROR
("Unableo‡llocateƒvent (size %d). External "

442 "TM fÀ»ûivedƒv’ˆi lo¡!", 
ev’t_’Œy_Ën
);

443 
»s
 = -
ENOMEM
;

444 
out
;

447 
	`TRACE_MEM
("ev’t_’Œy %°Ö’ %dè®loÿ‹d", 
ev’t_’Œy
,

448 
ev’t_’Œy_Ën
);

450 
ev’t
 = &
ev’t_’Œy
->event;

452 
ev’t
->
·ylßd_Ën
 = (*
·ylßd
);

453 
·ylßd
 = (
sc¡_ev’t_tm_â_»ûived_·ylßd
 *)
ev’t
->payload;

455 
·ylßd
->
â
 = 
mcmd
->fn;

456 
·ylßd
->
lun
 = 
mcmd
->lun;

457 ià(
mcmd
->
mcmd_tgt_dev
 !ð
NULL
)

458 
	`¡¾ýy
(
·ylßd
->
deviû_Çme
, 
mcmd
->
mcmd_tgt_dev
->
dev
->
vœt_Çme
,

459 (
·ylßd
->
deviû_Çme
));

460 
	`¡¾ýy
(
·ylßd
->
š™ŸtÜ_Çme
, 
mcmd
->
£ss
->initiator_name,

461 (
·ylßd
->
š™ŸtÜ_Çme
));

462 
	`¡¾ýy
(
·ylßd
->
rg‘_Çme
, 
mcmd
->
£ss
->
tgt
->
tgt_Çme
,

463 (
·ylßd
->
rg‘_Çme
));

464 
	`¡¾ýy
(
·ylßd
->
£ssiÚ_sysfs_Çme
, 
mcmd
->
£ss
->
£ss_Çme
,

465 (
·ylßd
->
£ssiÚ_sysfs_Çme
));

466 ià(
mcmd
->
cmd_to_abÜt
 !ð
NULL
) {

467 
·ylßd
->
cmd_to_abÜt_g
 = 
mcmd
->
cmd_to_abÜt
->
g
;

468 
	`¡¾ýy
(
·ylßd
->
cdb
, 
mcmd
->
cmd_to_abÜt
->cdb,

469 (
·ylßd
->
cdb
));

472 
	`sc¡_ev’t_queue
(
SCST_EVENT_TM_FN_RECEIVED
,

473 
SCST_EVENT_SCST_CORE_ISSUER
, 
ev’t_’Œy
);

475 
out
:

476 
	`TRACE_EXIT_RES
(
»s
);

477  
»s
;

478 
	}
}

481 
	$sc¡_»Ëa£_ev’t_’Œy
(
sc¡_ev’t_’Œy
 *
e
)

483 
	`TRACE_ENTRY
();

485 
	`TRACE_DBG
("D–‘šgƒv’ˆ’Œy %p", 
e
);

486 
	`li¡_d–
(&
e
->
ev’ts_li¡_’Œy
);

488 ià(
e
->
ev’t_nÙify_â
 !ð
NULL
) {

489 
	`mu‹x_uÆock
(&
sc¡_ev’t_mu‹x
);

491 
	`ÿnûl_d–ayed_wÜk_sync
(&
e
->
ev’t_timeout_wÜk
);

493 
	`TRACE_DBG
("C®lšg‚Ùify_â oàev’t_’Œy %p", 
e
);

494 
e
->
	`ev’t_nÙify_â
(&e->
ev’t
,ƒ->
nÙify_â_´iv
, -
EFAULT
);

496 
	`mu‹x_lock
(&
sc¡_ev’t_mu‹x
);

499 
	`TRACE_MEM
("F»ešg‚Ùif›dƒv’ˆ’Œy %p", 
e
);

500 
	`kä“
(
e
);

502 
	`TRACE_EXIT
();

504 
	}
}

506 
	$sc¡_ev’t_»Ëa£
(
šode
 *šode, 
fže
 *file)

508 
sc¡_ev’t_´iv
 *
´iv
;

509 
sc¡_ev’t_’Œy
 *
e
, *
‘
;

511 
	`TRACE_ENTRY
();

513 
	`mu‹x_lock
(&
sc¡_ev’t_mu‹x
);

515 
´iv
 = 
fže
->
´iv©e_d©a
;

516 ià(
´iv
 =ð
NULL
) {

517 
	`mu‹x_uÆock
(&
sc¡_ev’t_mu‹x
);

518 
out
;

520 
fže
->
´iv©e_d©a
 = 
NULL
;

522 
	`li¡_d–
(&
´iv
->
´ivs_li¡_’Œy
);

524 
	`mu‹x_uÆock
(&
sc¡_ev’t_mu‹x
);

526 
	`TRACE_DBG
("GošgØ»Ëa£ƒv’ˆ´iv %p", 
´iv
);

528 
´iv
->
gošg_to_ex™
 = 1;

529 
	`wake_up_®l
(&
´iv
->
queued_ev’ts_wa™Q
);

531 
	`li¡_fÜ_—ch_’Œy_§ã
(
e
, 
‘
, &
´iv
->
®lowed_ev’ts_li¡
,

532 
ev’ts_li¡_’Œy
) {

533 
	`TRACE_MEM
("D–‘šg‡Îowedƒv’ˆ’Œy %p", 
e
);

534 
	`li¡_d–
(&
e
->
ev’ts_li¡_’Œy
);

535 
	`kä“
(
e
);

538 
	`mu‹x_lock
(&
sc¡_ev’t_mu‹x
);

539 !
	`li¡_em±y
(&
´iv
->
queued_ev’ts_li¡
)) {

540 
e
 = 
	`li¡_’Œy
(
´iv
->
queued_ev’ts_li¡
.
Ãxt
,

541 
	`ty³of
(*
e
), 
ev’ts_li¡_’Œy
);

542 
	`sc¡_»Ëa£_ev’t_’Œy
(
e
);

544 !
	`li¡_em±y
(&
´iv
->
´oûssšg_ev’ts_li¡
)) {

545 
e
 = 
	`li¡_’Œy
(
´iv
->
´oûssšg_ev’ts_li¡
.
Ãxt
,

546 
	`ty³of
(*
e
), 
ev’ts_li¡_’Œy
);

547 
	`sc¡_»Ëa£_ev’t_’Œy
(
e
);

549 
	`mu‹x_uÆock
(&
sc¡_ev’t_mu‹x
);

551 
	`TRACE_MEM
("D–‘šg…riv %p", 
´iv
);

552 
	`kä“
(
´iv
);

554 
	`moduË_put
(
THIS_MODULE
);

556 
out
:

557 
	`TRACE_EXIT
();

559 
	}
}

566 
	$sc¡_ev’t_g‘_ev’t_äom_u£r
(
__u£r
 *
¬g
,

567 
sc¡_ev’t_’Œy
 **
out_ev’t_’Œy
)

569 
»s
, 
rc
, 
ev’t_’Œy_Ën
;

570 
ušt32_t
 
·ylßd_Ën
;

571 
sc¡_ev’t_’Œy
 *
ev’t_’Œy
;

573 
	`TRACE_ENTRY
();

575 
»s
 = 
	`g‘_u£r
(
·ylßd_Ën
, (
ušt32_t
 
__u£r
 *)
¬g
);

576 ià(
»s
 != 0) {

577 
	`PRINT_ERROR
("FažedØg‘…aylßd†’: %d", 
»s
);

578 
out
;

581 ià(
·ylßd_Ën
 > 
SCST_MAX_PAYLOAD
) {

582 
	`PRINT_ERROR
("Paylßd†’ %d i toØbig (max %d)", 
·ylßd_Ën
,

583 
SCST_MAX_PAYLOAD
);

584 
»s
 = -
EINVAL
;

585 
out
;

588 
	`TRACE_DBG
("·ylßd_ËÀ%d", 
·ylßd_Ën
);

590 
ev’t_’Œy_Ën
 = (*
ev’t_’Œy
è+ 
·ylßd_Ën
;

592 
ev’t_’Œy
 = 
	`kz®loc
(
ev’t_’Œy_Ën
, 
GFP_KERNEL
);

593 ià(
ev’t_’Œy
 =ð
NULL
) {

594 
	`PRINT_ERROR
("Unableo‡llocateƒventƒntry (size %d)",

595 
ev’t_’Œy_Ën
);

596 
»s
 = -
ENOMEM
;

597 
out
;

600 
	`TRACE_MEM
("AÎoÿ‹dƒv’ˆ’Œy %p", 
ev’t_’Œy
);

602 
rc
 = 
	`cÝy_äom_u£r
(&
ev’t_’Œy
->
ev’t
, 
¬g
,

603 (
ev’t_’Œy
->
ev’t
è+ 
·ylßd_Ën
);

604 ià(
rc
 != 0) {

605 
	`PRINT_ERROR
("FažedØcÝy %d u£r' by‹s", 
rc
);

606 
»s
 = -
EFAULT
;

607 
out_ä“
;

610 
ev’t_’Œy
->
ev’t
.
issu”_Çme
[(event_entry->event.issuer_name)-1] = '\0';

612 
	`TRACE_DBG
("userƒvent:ƒvent_code %d, issuer_name %s",

613 
ev’t_’Œy
->
ev’t
.
ev’t_code
,ƒv’t_’Œy->ev’t.
issu”_Çme
);

615 *
out_ev’t_’Œy
 = 
ev’t_’Œy
;

617 
out
:

618 
	`TRACE_EXIT_RES
(
»s
);

619  
»s
;

621 
out_ä“
:

622 
	`TRACE_MEM
("D–‘šgƒv’ˆ’Œy %p", 
ev’t_’Œy
);

623 
	`kä“
(
ev’t_’Œy
);

624 
out
;

625 
	}
}

628 
	$sc¡_ev’t_®low_ev’t
(
sc¡_ev’t_´iv
 *
´iv
, 
__u£r
 *
¬g
)

630 
»s
;

631 
sc¡_ev’t_’Œy
 *
ev’t_’Œy
, *
e
;

633 
	`TRACE_ENTRY
();

635 
»s
 = 
	`sc¡_ev’t_g‘_ev’t_äom_u£r
(
¬g
, &
ev’t_’Œy
);

636 ià(
»s
 != 0)

637 
out
;

639 
	`li¡_fÜ_—ch_’Œy
(
e
, &
´iv
->
®lowed_ev’ts_li¡
, 
ev’ts_li¡_’Œy
) {

640 ià(
	`sc¡_ev’t_cmp
(&
ev’t_’Œy
->
ev’t
, &
e
->event)) {

641 
	`PRINT_WARNING
("Allowedƒvent (event_code %d, "

643 
e
->
ev’t
.
ev’t_code
,ƒ->ev’t.
issu”_Çme
);

644 
»s
 = -
EEXIST
;

645 
out_ä“
;

649 ià(
´iv
->
®lowed_ev’ts_út
 >ð
SCST_MAX_EVENTS
) {

650 
	`PRINT_ERROR
("Too many‡llowedƒvents %d",

651 
´iv
->
®lowed_ev’ts_út
);

652 
»s
 = -
EMFILE
;

653 
out_ä“
;

656 
	`li¡_add_ž
(&
ev’t_’Œy
->
ev’ts_li¡_’Œy
,

657 &
´iv
->
®lowed_ev’ts_li¡
);

658 
´iv
->
®lowed_ev’ts_út
++;

659 
»s
 = 0;

661 
out
:

662 
	`TRACE_EXIT_RES
(
»s
);

663  
»s
;

665 
out_ä“
:

666 
	`TRACE_MEM
("D–‘šgƒv’ˆ’Œy %p", 
ev’t_’Œy
);

667 
	`kä“
(
ev’t_’Œy
);

668 
out
;

669 
	}
}

672 
	$sc¡_ev’t_di§Îow_ev’t
(
sc¡_ev’t_´iv
 *
´iv
,

673 
__u£r
 *
¬g
)

675 
»s
;

676 
sc¡_ev’t_’Œy
 *
ev’t_’Œy
, *
e
, *
‘
;

677 
boÞ
 
found
 = 
çl£
;

679 
	`TRACE_ENTRY
();

681 
»s
 = 
	`sc¡_ev’t_g‘_ev’t_äom_u£r
(
¬g
, &
ev’t_’Œy
);

682 ià(
»s
 != 0)

683 
out
;

686 
	`li¡_fÜ_—ch_’Œy_§ã
(
e
, 
‘
, &
´iv
->
®lowed_ev’ts_li¡
,

687 
ev’ts_li¡_’Œy
) {

688 ià(
	`sc¡_ev’t_cmp
(&
ev’t_’Œy
->
ev’t
, &
e
->event)) {

689 
	`PRINT_INFO
("Deleting‡llowedƒvent (event_code %d, "

690 "issu”_Çm%s)", 
e
->
ev’t
.
ev’t_code
,

691 
e
->
ev’t
.
issu”_Çme
);

692 
	`TRACE_MEM
("D–‘šgƒv’ˆ’Œy %p", 
e
);

693 
	`li¡_d–
(&
e
->
ev’ts_li¡_’Œy
);

694 
	`kä“
(
e
);

695 
´iv
->
®lowed_ev’ts_út
--;

696 
found
 = 
Œue
;

699 ià(!
found
) {

700 
	`PRINT_WARNING
("Allowedƒvent (event_code %d, issuer_name %s) "

701 "nÙ found", 
ev’t_’Œy
->
ev’t
.
ev’t_code
,

702 
ev’t_’Œy
->
ev’t
.
issu”_Çme
);

703 
»s
 = -
ENOENT
;

705 
»s
 = 0;

707 
	`TRACE_MEM
("D–‘šgƒv’ˆ’Œy %p", 
e
);

708 
	`kä“
(
ev’t_’Œy
);

710 
out
:

711 
	`TRACE_EXIT_RES
(
»s
);

712  
»s
;

713 
	}
}

716 
	$sc¡_ev’t_u£r_Ãxt_ev’t
(
sc¡_ev’t_´iv
 *
´iv
,

717 
__u£r
 *
¬g
)

719 
»s
, 
rc
;

720 
št32_t
 
max_ev’t_size
, 
Ãeded_size
;

721 
sc¡_ev’t_’Œy
 *
ev’t_’Œy
;

722 
sc¡_ev’t_u£r
 
__u£r
 *
ev’t_u£r
 = 
¬g
;

724 
	`TRACE_ENTRY
();

726 
»s
 = 
	`g‘_u£r
(
max_ev’t_size
, (
št32_t
 
__u£r
 *)
¬g
);

727 ià(
»s
 != 0) {

728 
	`PRINT_ERROR
("FažedØg‘ maxƒv’ˆsize: %d", 
»s
);

729 
out
;

733 
	`li¡_em±y
(&
´iv
->
queued_ev’ts_li¡
)) {

734 
	`mu‹x_uÆock
(&
sc¡_ev’t_mu‹x
);

735 
	`wa™_ev’t_š‹¼u±ibË
(
´iv
->
queued_ev’ts_wa™Q
,

736 (!
	`li¡_em±y
(&
´iv
->
queued_ev’ts_li¡
è||…riv->
gošg_to_ex™
 ||

737 !
´iv
->
blockšg
 || 
	`sigÇl_³ndšg
(
cu¼’t
)));

738 
	`mu‹x_lock
(&
sc¡_ev’t_mu‹x
);

739 ià(
´iv
->
gošg_to_ex™
 || 
	`sigÇl_³ndšg
(
cu¼’t
)) {

740 
»s
 = -
EINTR
;

741 
	`TRACE_DBG
("Signal…ending or going_to_exit (%d),„eturning",

742 
´iv
->
gošg_to_ex™
);

743 
out
;

744 } ià(
	`li¡_em±y
(&
´iv
->
queued_ev’ts_li¡
è&& !´iv->
blockšg
) {

745 
»s
 = -
EAGAIN
;

746 
	`TRACE_DBG
("NÙhšg…’dšg,„‘uºšg %d", 
»s
);

747 
out
;

751 
	`EXTRACHECKS_BUG_ON
(
	`li¡_em±y
(&
´iv
->
queued_ev’ts_li¡
));

753 
ev’t_’Œy
 = 
	`li¡_’Œy
(
´iv
->
queued_ev’ts_li¡
.
Ãxt
,

754 
sc¡_ev’t_’Œy
, 
ev’ts_li¡_’Œy
);

756 
Ãeded_size
 = (
ev’t_’Œy
->
ev’t
è+ƒv’t_’Œy->ev’t.
·ylßd_Ën
;

758 ià(
Ãeded_size
 > 
max_ev’t_size
) {

759 
	`TRACE_DBG
("ToØbigƒv’ˆ(siz%d, max siz%d)", 
Ãeded_size
,

760 
max_ev’t_size
);

761 
»s
 = 
	`put_u£r
(
Ãeded_size
, (
št32_t
 
__u£r
 *)
¬g
);

762 ià(
»s
 == 0)

763 
»s
 = -
ENOSPC
;

764 
out
;

767 
rc
 = 
	`cÝy_to_u£r
(&
ev’t_u£r
->
out_ev’t
, &
ev’t_’Œy
->
ev’t
, 
Ãeded_size
);

768 ià(
rc
 != 0) {

769 
	`PRINT_ERROR
("CÝyØu£¸çžed (%d)", 
rc
);

770 
»s
 = -
EFAULT
;

771 
out
;

774 ià(
ev’t_’Œy
->
ev’t_nÙify_â
) {

775 
	`TRACE_DBG
("Movingƒventƒntry %po…rocessingƒvents†ist",

776 
ev’t_’Œy
);

777 
	`li¡_move_ž
(&
ev’t_’Œy
->
ev’ts_li¡_’Œy
,

778 &
´iv
->
´oûssšg_ev’ts_li¡
);

780 
	`TRACE_MEM
("D–‘šgƒv’ˆ’Œy %p", 
ev’t_’Œy
);

781 
	`li¡_d–
(&
ev’t_’Œy
->
ev’ts_li¡_’Œy
);

782 
	`kä“
(
ev’t_’Œy
);

785 
´iv
->
queued_ev’ts_út
--;

787 
»s
 = 0;

789 
out
:

790 
	`TRACE_EXIT_RES
(
»s
);

791  
»s
;

792 
	}
}

795 
	$sc¡_ev’t_u£r_nÙify_dÚe
(
sc¡_ev’t_´iv
 *
´iv
,

796 
__u£r
 *
¬g
)

798 
»s
, 
rc
;

799 
sc¡_ev’t_nÙify_dÚe
 
n
;

800 
sc¡_ev’t_’Œy
 *
e
;

801 
boÞ
 
found
 = 
çl£
;

803 
	`TRACE_ENTRY
();

805 
rc
 = 
	`cÝy_äom_u£r
(&
n
, 
¬g
, (n));

806 ià(
rc
 != 0) {

807 
	`PRINT_ERROR
("FažedØcÝy %d u£r' by‹ oànÙify dÚe", 
rc
);

808 
»s
 = -
EFAULT
;

809 
out
;

812 
»s
 = 0;

814 
	`li¡_fÜ_—ch_’Œy
(
e
, &
´iv
->
´oûssšg_ev’ts_li¡
, 
ev’ts_li¡_’Œy
) {

815 ià(
e
->
ev’t
.
ev’t_id
 =ð
n
.event_id) {

816 
found
 = 
Œue
;

820 ià(!
found
) {

821 
	`PRINT_ERROR
("Wa™šgƒv’ˆfÜ id %u‚Ù found", 
n
.
ev’t_id
);

822 
»s
 = -
ENOENT
;

823 
out
;

826 
	`li¡_d–_š™
(&
e
->
ev’ts_li¡_’Œy
);

828 
	`mu‹x_uÆock
(&
sc¡_ev’t_mu‹x
);

830 
	`ÿnûl_d–ayed_wÜk_sync
(&
e
->
ev’t_timeout_wÜk
);

832 ià(
e
->
ev’t_nÙify_â
 !ð
NULL
) {

833 
	`TRACE_DBG
("C®lšg‚Ùify_â oàev’t_’Œy %p", 
e
);

834 
e
->
	`ev’t_nÙify_â
(&e->
ev’t
,ƒ->
nÙify_â_´iv
, 
n
.
¡©us
);

837 
	`TRACE_MEM
("F»ešgƒv’ˆ’Œy %p", 
e
);

838 
	`kä“
(
e
);

841 
	`mu‹x_lock
(&
sc¡_ev’t_mu‹x
);

843 
out
:

844 
	`TRACE_EXIT_RES
(
»s
);

845  
»s
;

846 
	}
}

849 
	$sc¡_ev’t_ü—‹_´iv
(
fže
 *file)

851 
»s
;

852 
sc¡_ev’t_´iv
 *
´iv
;

854 
	`TRACE_ENTRY
();

856 
	`EXTRACHECKS_BUG_ON
(
fže
->
´iv©e_d©a
 !ð
NULL
);

858 ià(!
	`Œy_moduË_g‘
(
THIS_MODULE
)) {

859 
	`PRINT_ERROR
("Failo get module");

860 
»s
 = -
ETXTBSY
;

861 
out
;

864 
´iv
 = 
	`kz®loc
((*´iv), 
GFP_KERNEL
);

865 ià(
´iv
 =ð
NULL
) {

866 
	`PRINT_ERROR
("Unableo‡llocate…riv (size %zd)",

867 (*
´iv
));

868 
»s
 = -
ENOMEM
;

869 
out_put
;

872 
	`TRACE_MEM
("´iv %°®loÿ‹d", 
´iv
);

874 
´iv
->
owÃr_pid
 = 
cu¼’t
->
pid
;

875 
	`INIT_LIST_HEAD
(&
´iv
->
®lowed_ev’ts_li¡
);

876 
	`š™_wa™queue_h—d
(&
´iv
->
queued_ev’ts_wa™Q
);

877 
	`INIT_LIST_HEAD
(&
´iv
->
queued_ev’ts_li¡
);

878 
	`INIT_LIST_HEAD
(&
´iv
->
´oûssšg_ev’ts_li¡
);

879 ià(
fže
->
f_æags
 & 
O_NONBLOCK
) {

880 
	`TRACE_DBG
("%s", "Non-blocking operations");

881 
´iv
->
blockšg
 = 0;

883 
´iv
->
blockšg
 = 1;

885 
	`li¡_add_ž
(&
´iv
->
´ivs_li¡_’Œy
, &
sc¡_ev’t_´ivs_li¡
);

887 
fže
->
´iv©e_d©a
 = 
´iv
;

889 
»s
 = 0;

891 
out
:

892 
	`TRACE_EXIT_RES
(
»s
);

893  
»s
;

895 
out_put
:

896 
	`moduË_put
(
THIS_MODULE
);

897 
out
;

898 
	}
}

900 
	$sc¡_ev’t_ioùl
(
fže
 *fže, 
cmd
,

901 
¬g
)

903 
»s
;

904 
sc¡_ev’t_´iv
 *
´iv
;

906 
	`TRACE_ENTRY
();

908 
	`mu‹x_lock
(&
sc¡_ev’t_mu‹x
);

910 
´iv
 = 
fže
->
´iv©e_d©a
;

911 ià(
	`uÆik–y
(
´iv
 =ð
NULL
)) {

913 
»s
 = 
	`sc¡_ev’t_ü—‹_´iv
(
fže
);

914 ià(
»s
 != 0)

915 
out_uÆock
;

916 
´iv
 = 
fže
->
´iv©e_d©a
;

919 
	`TRACE_DBG
("´iv %p", 
´iv
);

928 
cmd
) {

929 
SCST_EVENT_ALLOW_EVENT
:

930 
	`TRACE_DBG
("%s", "ALLOW_EVENT");

931 
»s
 = 
	`sc¡_ev’t_®low_ev’t
(
´iv
, (
__u£r
 *)
¬g
);

934 
SCST_EVENT_DISALLOW_EVENT
:

935 
	`TRACE_DBG
("%s", "DISALLOW_EVENT");

936 
»s
 = 
	`sc¡_ev’t_di§Îow_ev’t
(
´iv
, (
__u£r
 *)
¬g
);

939 
SCST_EVENT_GET_NEXT_EVENT
:

940 
	`TRACE_DBG
("%s", "GET_NEXT_EVENT");

941 
»s
 = 
	`sc¡_ev’t_u£r_Ãxt_ev’t
(
´iv
, (
__u£r
 *)
¬g
);

944 
SCST_EVENT_NOTIFY_DONE
:

945 
	`TRACE_DBG
("%s", "NOTIFY_DONE");

946 
»s
 = 
	`sc¡_ev’t_u£r_nÙify_dÚe
(
´iv
, (
__u£r
 *)
¬g
);

950 
	`PRINT_ERROR
("Inv®id ioùÈcmd %x", 
cmd
);

951 
»s
 = -
EINVAL
;

952 
out_uÆock
;

955 
out_uÆock
:

956 
	`mu‹x_uÆock
(&
sc¡_ev’t_mu‹x
);

958 
	`TRACE_EXIT_RES
(
»s
);

959  
»s
;

960 
	}
}

962 
	$sc¡_ev’t_pÞl
(
fže
 *fže, 
pÞl_bË
 *
wa™
)

964 
»s
 = 0;

965 
sc¡_ev’t_´iv
 *
´iv
;

967 
	`TRACE_ENTRY
();

969 
	`mu‹x_lock
(&
sc¡_ev’t_mu‹x
);

971 
´iv
 = 
fže
->
´iv©e_d©a
;

972 ià(
	`uÆik–y
(
´iv
 =ð
NULL
)) {

973 
	`PRINT_ERROR
("At†east one‡llowedƒvent must be set");

974 
»s
 = -
EINVAL
;

975 
out_uÆock
;

978 ià(!
	`li¡_em±y
(&
´iv
->
queued_ev’ts_li¡
)) {

979 
»s
 |ð
POLLIN
 | 
POLLRDNORM
;

980 
out_uÆock
;

983 
	`mu‹x_uÆock
(&
sc¡_ev’t_mu‹x
);

985 
	`TRACE_DBG
("BefÜpÞl_wa™(èÕriv %p)", 
´iv
);

986 
	`pÞl_wa™
(
fže
, &
´iv
->
queued_ev’ts_wa™Q
, 
wa™
);

987 
	`TRACE_DBG
("Aá”…Þl_wa™(èÕriv %p)", 
´iv
);

989 
	`mu‹x_lock
(&
sc¡_ev’t_mu‹x
);

991 ià(!
	`li¡_em±y
(&
´iv
->
queued_ev’ts_li¡
)) {

992 
»s
 |ð
POLLIN
 | 
POLLRDNORM
;

993 
out_uÆock
;

996 
out_uÆock
:

997 
	`mu‹x_uÆock
(&
sc¡_ev’t_mu‹x
);

999 
	`TRACE_EXIT_HRES
(
»s
);

1000  
»s
;

1001 
	}
}

1004 
	#CONFIG_EVENTS_WAIT_TEST


	)

1007 #ifdeà
CONFIG_EVENTS_WAIT_TEST


1008 
	$sc¡_ev’t_‹¡_nÙify_â
(
sc¡_ev’t
 *
ev’t
,

1009 *
´iv
, 
¡©us
)

1011 
	`TRACE_ENTRY
();

1013 
	`PRINT_INFO
("Notification forƒvent %u (id %d)„eceived with status %d "

1014 "Õriv %p)", 
ev’t
->
ev’t_code
,ƒv’t->
ev’t_id
, 
¡©us
,

1015 
´iv
);

1017 
	`TRACE_EXIT
();

1019 
	}
}

1021 
ssize_t
 
	$ev’t_wa™_‹¡_¡Üe
(
kobjeù
 *
kobj
,

1022 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

1024 
»s
 = 0, 
ev’t_’Œy_Ën
;

1025 
sc¡_ev’t_’Œy
 *
ev’t_’Œy
;

1027 
	`TRACE_ENTRY
();

1029 
ev’t_’Œy_Ën
 = (*
ev’t_’Œy
);

1030 
ev’t_’Œy
 = 
	`kz®loc
(
ev’t_’Œy_Ën
, 
GFP_KERNEL
);

1031 ià(
ev’t_’Œy
 =ð
NULL
) {

1032 
	`PRINT_ERROR
("Unableo‡llocateƒvent (size %d). Test "

1033 "ev’ˆi lo¡!", 
ev’t_’Œy_Ën
);

1034 
»s
 = -
ENOMEM
;

1035 
out
;

1038 
	`TRACE_MEM
("ev’t_’Œy %°Ö’ %dè®loÿ‹d", 
ev’t_’Œy
,

1039 
ev’t_’Œy_Ën
);

1041 
ev’t_’Œy
->
ev’t_nÙify_â
 = 
sc¡_ev’t_‹¡_nÙify_â
;

1042 
ev’t_’Œy
->
ev’t_timeout
 = 10*
HZ
;

1044 
	`sc¡_ev’t_queue
(0x12345, 
SCST_EVENT_SCST_CORE_ISSUER
, 
ev’t_’Œy
);

1046 ià(
»s
 == 0)

1047 
»s
 = 
couÁ
;

1049 
out
:

1050 
	`TRACE_EXIT_RES
(
»s
);

1051  
»s
;

1052 
	}
}

1054 
kobj_©Œibu‹
 
	gev’t_wa™_‹¡_©Œ
 =

1055 
__ATTR
(
ev’t_wa™_‹¡
, 
S_IWUSR
, 
NULL
, 
ev’t_wa™_‹¡_¡Üe
);

1059 cÚ¡ 
fže_Ý”©iÚs
 
	gsc¡_ev’t_fÝs
 = {

1060 .
pÞl
 = 
sc¡_ev’t_pÞl
,

1061 .
	guÆocked_ioùl
 = 
sc¡_ev’t_ioùl
,

1062 #ifdeà
CONFIG_COMPAT


1063 .
	gcom·t_ioùl
 = 
sc¡_ev’t_ioùl
,

1065 .
	g»Ëa£
 = 
sc¡_ev’t_»Ëa£
,

1068 
	$sc¡_ev’t_š™
()

1070 
»s
 = 0;

1071 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 21)

1072 
þass_deviû
 *
þass_memb”
;

1074 
deviû
 *
dev
;

1077 
	`TRACE_ENTRY
();

1079 
sc¡_ev’t_sysfs_þass
 = 
	`þass_ü—‹
(
THIS_MODULE
, 
SCST_EVENT_NAME
);

1080 ià(
	`IS_ERR
(
sc¡_ev’t_sysfs_þass
)) {

1081 
	`PRINT_ERROR
("%s", "Unable create sysfs class for SCSTƒvent");

1082 
»s
 = 
	`PTR_ERR
(
sc¡_ev’t_sysfs_þass
);

1083 
out
;

1086 
sc¡_ev’t_majÜ
 = 
	`»gi¡”_chrdev
(0, 
SCST_EVENT_NAME
, &
sc¡_ev’t_fÝs
);

1087 ià(
sc¡_ev’t_majÜ
 < 0) {

1088 
	`PRINT_ERROR
("»gi¡”_chrdev(èçžed: %d", 
»s
);

1089 
»s
 = 
sc¡_ev’t_majÜ
;

1090 
out_þass
;

1093 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 21)

1094 
þass_memb”
 = 
	`þass_deviû_ü—‹
(
sc¡_ev’t_sysfs_þass
, 
NULL
,

1095 
	`MKDEV
(
sc¡_ev’t_majÜ
, 0), 
NULL
,

1096 
SCST_EVENT_NAME
);

1097 ià(
	`IS_ERR
(
þass_memb”
)) {

1098 
»s
 = 
	`PTR_ERR
(
þass_memb”
);

1099 
out_chrdev
;

1102 
dev
 = 
	`deviû_ü—‹
(
sc¡_ev’t_sysfs_þass
, 
NULL
,

1103 
	`MKDEV
(
sc¡_ev’t_majÜ
, 0),

1104 
NULL
,

1105 
SCST_EVENT_NAME
);

1106 ià(
	`IS_ERR
(
dev
)) {

1107 
»s
 = 
	`PTR_ERR
(
dev
);

1108 
out_chrdev
;

1112 #ifdeà
CONFIG_EVENTS_WAIT_TEST


1113 
	`sysfs_ü—‹_fže
(
k”Ãl_kobj
, &
ev’t_wa™_‹¡_©Œ
.
©Œ
);

1116 
out
:

1117 
	`TRACE_EXIT_RES
(
»s
);

1118  
»s
;

1121 
out_chrdev
:

1122 
	`uÄegi¡”_chrdev
(
sc¡_ev’t_majÜ
, 
SCST_EVENT_NAME
);

1124 
out_þass
:

1125 
	`þass_de¡roy
(
sc¡_ev’t_sysfs_þass
);

1126 
out
;

1127 
	}
}

1129 
	$sc¡_ev’t_ex™
()

1131 
	`TRACE_ENTRY
();

1133 #ifdeà
CONFIG_EVENTS_WAIT_TEST


1134 
	`sysfs_»move_fže
(
k”Ãl_kobj
, &
ev’t_wa™_‹¡_©Œ
.
©Œ
);

1137 
	`uÄegi¡”_chrdev
(
sc¡_ev’t_majÜ
, 
SCST_EVENT_NAME
);

1139 
	`deviû_de¡roy
(
sc¡_ev’t_sysfs_þass
, 
	`MKDEV
(
sc¡_ev’t_majÜ
, 0));

1140 
	`þass_de¡roy
(
sc¡_ev’t_sysfs_þass
);

1143 
	`æush_scheduËd_wÜk
();

1145 
	`TRACE_EXIT
();

1147 
	}
}

	@scst/src/scst_lib.c

19 
	~<lšux/š™.h
>

20 
	~<lšux/k”Ãl.h
>

21 
	~<lšux/”ºo.h
>

22 
	~<lšux/li¡.h
>

23 
	~<lšux/¥šlock.h
>

24 
	~<lšux/¦ab.h
>

25 
	~<lšux/sched.h
>

26 
	~<lšux/kth»ad.h
>

27 
	~<lšux/cdrom.h
>

28 
	~<lšux/uni¡d.h
>

29 
	~<lšux/¡ršg.h
>

30 
	~<lšux/ùy³.h
>

31 
	~<lšux/d–ay.h
>

32 
	~<lšux/vm®loc.h
>

33 
	~<asm/km­_ty³s.h
>

34 
	~<asm/uÇligÃd.h
>

35 
	~<asm/checksum.h
>

36 
	~<lšux/v”siÚ.h
>

37 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 27)

38 
	~<lšux/üc-t10dif.h
>

40 
	~<lšux/Çmei.h
>

41 
	~<lšux/mouÁ.h
>

43 #iâdeà
INSIDE_KERNEL_TREE


44 
	~<lšux/v”siÚ.h
>

47 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 29)

48 
	~<lšux/wr™eback.h
>

51 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(3, 18, 0)

52 
	~<lšux/t10-pi.h
>

55 #ifdeà
INSIDE_KERNEL_TREE


56 
	~<sc¡/sc¡.h
>

58 
	~"sc¡.h
"

60 
	~"sc¡_´iv.h
"

61 
	~"sc¡_mem.h
"

62 
	~"sc¡_´es.h
"

74 
DEFINE_SPINLOCK
(
sc¡_glob®_¡pg_li¡_lock
);

75 
LIST_HEAD
(
sc¡_glob®_¡pg_li¡
);

77 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 20)

78 
sc¡_put_acg_wÜk
(*
p
);

80 
sc¡_put_acg_wÜk
(
wÜk_¡ruù
 *
wÜk
);

82 
sc¡_d–_aú
(
sc¡_aú
 *
aú
);

83 
sc¡_ä“_aú
(
sc¡_aú
 *
aú
, 
boÞ
 
»assign
);

85 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 30)

86 
	sscsi_io_cÚ‹xt
 {

87 *
	md©a
;

88 (*
	mdÚe
)(*
	md©a
, *
	m£n£
, 
	m»suÉ
, 
	m»sid
);

89 
	m£n£
[
SCST_SENSE_BUFFERSIZE
];

91 
kmem_ÿche
 *
	gscsi_io_cÚ‹xt_ÿche
;

93 
wÜkqueue_¡ruù
 *
	gsc¡_»Ëa£_acg_wq
;

95 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 22) \

96 && (!
defšed
(
RHEL_RELEASE_CODE
è|| 
	gRHEL_RELEASE_CODE
 -0 < 5 * 256 + 3) \

97 && !
	$defšed
(
CONFIG_PPC
)

98 
	$¡ºÿ£cmp
(cÚ¡ *
s1
, cÚ¡ *
s2
, 
size_t
 
n
)

100 
c1
, 
c2
;

103 
c1
 = 
	`tÞow”
(*
s1
++);

104 
c2
 = 
	`tÞow”
(*
s2
++);

105 } (--
n
 > 0è&& 
c1
 =ð
c2
 && c1 != 0);

106  
c1
 - 
c2
;

107 
	}
}

110 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 22)

111 *
	$kva¥rštf
(
gå_t
 
gå
, cÚ¡ *
fmt
, 
va_li¡
 
­
)

113 
Ën
;

114 *
p
;

115 
va_li¡
 
aq
;

117 
	`va_cÝy
(
aq
, 
­
);

118 
Ën
 = 
	`v¢´štf
(
NULL
, 0, 
fmt
, 
aq
);

119 
	`va_’d
(
aq
);

121 
p
 = 
	`km®loc_Œack_ÿÎ”
(
Ën
 + 1, 
gå
);

122 ià(!
p
)

123  
NULL
;

125 
	`v¢´štf
(
p
, 
Ën
 + 1, 
fmt
, 
­
);

127  
p
;

128 
	}
}

131 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 35) && \

132 (!
defšed
(
RHEL_MAJOR
è|| 
	gRHEL_MAJOR
 -0 < 6 || \

133 
	gRHEL_MAJOR
 -0 =ð6 && 
RHEL_MINOR
 -0 < 1)

138 
	$hex_to_bš
(
ch
)

140 ià(
ch
 >= '0' && ch <= '9')

141  
ch
 - '0';

142 
ch
 = 
	`tÞow”
(ch);

143 ià(
ch
 >= 'a' && ch <= 'f')

144  
ch
 - 'a' + 10;

146 
	}
}

147 
EXPORT_SYMBOL
(
hex_to_bš
);

150 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 30) || \

151 !
	$defšed
(
SCSI_EXEC_REQ_FIFO_DEFINED
)

152 
	`sg_cÝy
(
sÿ‰”li¡
 *
d¡_sg
, sÿ‰”li¡ *
¤c_sg
,

153 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3, 4, 0)

154 
ÃÁs_to_cÝy
, 
size_t
 
cÝy_Ën
,

155 
km_ty³
 
d_km_ty³
, km_ty³ 
s_km_ty³
);

157 
ÃÁs_to_cÝy
, 
size_t
 
cÝy_Ën
);

161 
	`sc¡_ä“_desütÜs
(
sc¡_cmd
 *
cmd
);

162 
boÞ
 
	`sg_cmp
(
sÿ‰”li¡
 *
d¡_sg
, sÿ‰”li¡ *
¤c_sg
,

163 
ÃÁs_to_cmp
, 
size_t
 
cmp_Ën
, *
miscom·»_offs


164 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3, 4, 0)

165 , 
km_ty³
 
d_km_ty³
, km_ty³ 
s_km_ty³


169 cÚ¡ 
sc¡_Ýcode_desütÜ
 
sc¡_Ý_desü_šquœy
 = {

170 .
od_Ýcode
 = 
INQUIRY
,

171 .
od_suµÜt
 = 3,

172 .
od_cdb_size
 = 6,

173 .
od_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

174 .
od_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_SMALL_TIMEOUT
/
HZ
,

175 .
od_cdb_u§ge_b™s
 = { 
INQUIRY
, 1, 0xFF, 0xFF, 0xFF, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

176 
	}
};

177 
EXPORT_SYMBOL
(
sc¡_Ý_desü_šquœy
);

179 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_ex‹nded_cÝy
 = {

180 .
od_Ýcode
 = 
EXTENDED_COPY
,

181 .
	god_suµÜt
 = 3,

182 .
	god_cdb_size
 = 16,

183 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

184 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_REG_TIMEOUT
/
HZ
,

185 .
	god_cdb_u§ge_b™s
 = { 
EXTENDED_COPY
, 0, 0, 0, 0, 0, 0, 0, 0, 0,

187 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

189 
EXPORT_SYMBOL
(
sc¡_Ý_desü_ex‹nded_cÝy
);

191 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_tur
 = {

192 .
od_Ýcode
 = 
TEST_UNIT_READY
,

193 .
	god_suµÜt
 = 3,

194 .
	god_cdb_size
 = 6,

195 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

196 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_SMALL_TIMEOUT
/
HZ
,

197 .
	god_cdb_u§ge_b™s
 = { 
TEST_UNIT_READY
, 0, 0, 0, 0, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

199 
EXPORT_SYMBOL
(
sc¡_Ý_desü_tur
);

201 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_log_£Ëù
 = {

202 .
od_Ýcode
 = 
LOG_SELECT
,

203 .
	god_suµÜt
 = 3,

204 .
	god_cdb_size
 = 10,

205 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

206 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_SMALL_TIMEOUT
/
HZ
,

207 .
	god_cdb_u§ge_b™s
 = { 
LOG_SELECT
, 3, 0xFF, 0xFF, 0, 0, 0, 0xFF, 0xFF,

208 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

210 
EXPORT_SYMBOL
(
sc¡_Ý_desü_log_£Ëù
);

212 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_log_£n£
 = {

213 .
od_Ýcode
 = 
LOG_SENSE
,

214 .
	god_suµÜt
 = 3,

215 .
	god_cdb_size
 = 10,

216 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

217 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_SMALL_TIMEOUT
/
HZ
,

218 .
	god_cdb_u§ge_b™s
 = { 
LOG_SENSE
, 1, 0xFF, 0xFF, 0, 0xFF, 0xFF, 0xFF, 0xFF,

219 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

221 
EXPORT_SYMBOL
(
sc¡_Ý_desü_log_£n£
);

223 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_mode_£Ëù6
 = {

224 .
od_Ýcode
 = 
MODE_SELECT
,

225 .
	god_suµÜt
 = 3,

226 .
	god_cdb_size
 = 6,

227 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

228 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_SMALL_TIMEOUT
/
HZ
,

229 .
	god_cdb_u§ge_b™s
 = { 
MODE_SELECT
, 0x11, 0, 0, 0xFF, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

231 
EXPORT_SYMBOL
(
sc¡_Ý_desü_mode_£Ëù6
);

233 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_mode_£n£6
 = {

234 .
od_Ýcode
 = 
MODE_SENSE
,

235 .
	god_suµÜt
 = 3,

236 .
	god_cdb_size
 = 6,

237 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

238 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_SMALL_TIMEOUT
/
HZ
,

239 .
	god_cdb_u§ge_b™s
 = { 
MODE_SENSE
, 8, 0xFF, 0xFF, 0xFF, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

241 
EXPORT_SYMBOL
(
sc¡_Ý_desü_mode_£n£6
);

243 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_mode_£Ëù10
 = {

244 .
od_Ýcode
 = 
MODE_SELECT_10
,

245 .
	god_suµÜt
 = 3,

246 .
	god_cdb_size
 = 10,

247 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

248 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_SMALL_TIMEOUT
/
HZ
,

249 .
	god_cdb_u§ge_b™s
 = { 
MODE_SELECT_10
, 0x11, 0, 0, 0, 0, 0, 0xFF, 0xFF,

250 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

252 
EXPORT_SYMBOL
(
sc¡_Ý_desü_mode_£Ëù10
);

254 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_mode_£n£10
 = {

255 .
od_Ýcode
 = 
MODE_SENSE_10
,

256 .
	god_suµÜt
 = 3,

257 .
	god_cdb_size
 = 10,

258 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

259 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_SMALL_TIMEOUT
/
HZ
,

260 .
	god_cdb_u§ge_b™s
 = { 
MODE_SENSE_10
, 0x18, 0xFF, 0xFF, 0, 0, 0, 0xFF, 0xFF,

261 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

263 
EXPORT_SYMBOL
(
sc¡_Ý_desü_mode_£n£10
);

265 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_¹pg
 = {

266 .
od_Ýcode
 = 
MAINTENANCE_IN
,

267 .
	god_£rv_aùiÚ
 = 
MI_REPORT_TARGET_PGS
,

268 .
	god_£rv_aùiÚ_v®id
 = 1,

269 .
	god_suµÜt
 = 3,

270 .
	god_cdb_size
 = 12,

271 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

272 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_SMALL_TIMEOUT
/
HZ
,

273 .
	god_cdb_u§ge_b™s
 = { 
MAINTENANCE_IN
, 0xE0|
MI_REPORT_TARGET_PGS
, 0, 0,

274 0, 0, 0xFF, 0xFF, 0xFF, 0xFF, 0, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

276 
EXPORT_SYMBOL
(
sc¡_Ý_desü_¹pg
);

278 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_¡pg
 = {

279 .
od_Ýcode
 = 
MAINTENANCE_OUT
,

280 .
	god_£rv_aùiÚ
 = 
MO_SET_TARGET_PGS
,

281 .
	god_£rv_aùiÚ_v®id
 = 1,

282 .
	god_suµÜt
 = 3,

283 .
	god_cdb_size
 = 12,

284 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

285 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_SMALL_TIMEOUT
/
HZ
,

286 .
	god_cdb_u§ge_b™s
 = { 
MAINTENANCE_OUT
, 
MO_SET_TARGET_PGS
, 0, 0, 0, 0,

287 0xFF, 0xFF, 0xFF, 0xFF, 0, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

289 
EXPORT_SYMBOL
(
sc¡_Ý_desü_¡pg
);

291 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_£nd_dŸgno¡ic
 = {

292 .
od_Ýcode
 = 
SEND_DIAGNOSTIC
,

293 .
	god_suµÜt
 = 3,

294 .
	god_cdb_size
 = 6,

295 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

296 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_SMALL_TIMEOUT
/
HZ
,

297 .
	god_cdb_u§ge_b™s
 = { 
SEND_DIAGNOSTIC
, 0xF7, 0, 0xFF, 0xFF,

298 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

300 
EXPORT_SYMBOL
(
sc¡_Ý_desü_£nd_dŸgno¡ic
);

302 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_»£rve6
 = {

303 .
od_Ýcode
 = 
RESERVE
,

304 .
	god_suµÜt
 = 3,

305 .
	god_cdb_size
 = 6,

306 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

307 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_SMALL_TIMEOUT
/
HZ
,

308 .
	god_cdb_u§ge_b™s
 = { 
RESERVE
, 0, 0, 0, 0, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

310 
EXPORT_SYMBOL
(
sc¡_Ý_desü_»£rve6
);

312 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_»Ëa£6
 = {

313 .
od_Ýcode
 = 
RELEASE
,

314 .
	god_suµÜt
 = 3,

315 .
	god_cdb_size
 = 6,

316 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

317 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_SMALL_TIMEOUT
/
HZ
,

318 .
	god_cdb_u§ge_b™s
 = { 
RELEASE
, 0, 0, 0, 0, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

320 
EXPORT_SYMBOL
(
sc¡_Ý_desü_»Ëa£6
);

322 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_»£rve10
 = {

323 .
od_Ýcode
 = 
RESERVE_10
,

324 .
	god_suµÜt
 = 3,

325 .
	god_cdb_size
 = 10,

326 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

327 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_SMALL_TIMEOUT
/
HZ
,

328 .
	god_cdb_u§ge_b™s
 = { 
RESERVE_10
, 0, 0, 0, 0, 0, 0, 0, 0,

329 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

331 
EXPORT_SYMBOL
(
sc¡_Ý_desü_»£rve10
);

333 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_»Ëa£10
 = {

334 .
od_Ýcode
 = 
RELEASE_10
,

335 .
	god_suµÜt
 = 3,

336 .
	god_cdb_size
 = 10,

337 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

338 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_SMALL_TIMEOUT
/
HZ
,

339 .
	god_cdb_u§ge_b™s
 = { 
RELEASE_10
, 0, 0, 0, 0, 0, 0, 0, 0,

340 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

342 
EXPORT_SYMBOL
(
sc¡_Ý_desü_»Ëa£10
);

344 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_´_š
 = {

345 .
od_Ýcode
 = 
PERSISTENT_RESERVE_IN
,

346 .
	god_suµÜt
 = 3,

347 .
	god_cdb_size
 = 10,

348 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

349 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_SMALL_TIMEOUT
/
HZ
,

350 .
	god_cdb_u§ge_b™s
 = { 
PERSISTENT_RESERVE_IN
, 0x1F, 0, 0, 0, 0, 0, 0xFF, 0xFF,

351 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

353 
EXPORT_SYMBOL
(
sc¡_Ý_desü_´_š
);

355 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_´_out
 = {

356 .
od_Ýcode
 = 
PERSISTENT_RESERVE_OUT
,

357 .
	god_suµÜt
 = 3,

358 .
	god_cdb_size
 = 10,

359 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

360 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_SMALL_TIMEOUT
/
HZ
,

361 .
	god_cdb_u§ge_b™s
 = { 
PERSISTENT_RESERVE_OUT
, 0x1F, 0xFF, 0, 0, 0xFF,

362 0xFF, 0xFF, 0xFF, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

364 
EXPORT_SYMBOL
(
sc¡_Ý_desü_´_out
);

366 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_»pÜt_luns
 = {

367 .
od_Ýcode
 = 
REPORT_LUNS
,

368 .
	god_suµÜt
 = 3,

369 .
	god_cdb_size
 = 12,

370 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

371 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_SMALL_TIMEOUT
/
HZ
,

372 .
	god_cdb_u§ge_b™s
 = { 
REPORT_LUNS
, 0, 0xFF, 0, 0, 0, 0xFF, 0xFF,

373 0xFF, 0xFF, 0, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

375 
EXPORT_SYMBOL
(
sc¡_Ý_desü_»pÜt_luns
);

377 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_»que¡_£n£
 = {

378 .
od_Ýcode
 = 
REQUEST_SENSE
,

379 .
	god_suµÜt
 = 3,

380 .
	god_cdb_size
 = 6,

381 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

382 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_SMALL_TIMEOUT
/
HZ
,

383 .
	god_cdb_u§ge_b™s
 = { 
REQUEST_SENSE
, 1, 0, 0, 0xFF, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

385 
EXPORT_SYMBOL
(
sc¡_Ý_desü_»que¡_£n£
);

387 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_»pÜt_suµ_tm_âs
 = {

388 .
od_Ýcode
 = 
MAINTENANCE_IN
,

389 .
	god_£rv_aùiÚ
 = 
MI_REPORT_SUPPORTED_TASK_MANAGEMENT_FUNCTIONS
,

390 .
	god_£rv_aùiÚ_v®id
 = 1,

391 .
	god_suµÜt
 = 3,

392 .
	god_cdb_size
 = 12,

393 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

394 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_SMALL_TIMEOUT
/
HZ
,

395 .
	god_cdb_u§ge_b™s
 = { 
MAINTENANCE_IN
, 
MI_REPORT_SUPPORTED_TASK_MANAGEMENT_FUNCTIONS
,

397 0xFF, 0, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

399 
EXPORT_SYMBOL
(
sc¡_Ý_desü_»pÜt_suµ_tm_âs
);

401 cÚ¡ 
sc¡_Ýcode_desütÜ
 
	gsc¡_Ý_desü_»pÜt_suµ_Ýcodes
 = {

402 .
od_Ýcode
 = 
MAINTENANCE_IN
,

403 .
	god_£rv_aùiÚ
 = 
MI_REPORT_SUPPORTED_OPERATION_CODES
,

404 .
	god_£rv_aùiÚ_v®id
 = 1,

405 .
	god_suµÜt
 = 3,

406 .
	god_cdb_size
 = 12,

407 .
	god_nomš®_timeout
 = 
SCST_DEFAULT_NOMINAL_TIMEOUT_SEC
,

408 .
	god_»comm’ded_timeout
 = 
SCST_GENERIC_DISK_SMALL_TIMEOUT
/
HZ
,

409 .
	god_cdb_u§ge_b™s
 = { 
MAINTENANCE_IN
, 
MI_REPORT_SUPPORTED_OPERATION_CODES
,

411 0xFF, 0, 
SCST_OD_DEFAULT_CONTROL_BYTE
 },

413 
EXPORT_SYMBOL
(
sc¡_Ý_desü_»pÜt_suµ_Ýcodes
);

415 
	gsc¡_sdbÝs
;

417 
g‘_cdb_šfo_Ën_10
(
sc¡_cmd
 *
cmd
,

418 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

419 
g‘_cdb_šfo_block_lim™
(
sc¡_cmd
 *
cmd
,

420 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

421 
g‘_cdb_šfo_»ad_ÿ·c™y
(
sc¡_cmd
 *
cmd
,

422 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

423 
g‘_cdb_šfo_£rv_aù_š
(
sc¡_cmd
 *
cmd
,

424 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

425 
g‘_cdb_šfo_sšgË
(
sc¡_cmd
 *
cmd
,

426 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

427 
g‘_cdb_šfo_»ad_pos
(
sc¡_cmd
 *
cmd
,

428 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

429 
g‘_cdb_šfo_´ev’t_®low_medium_»mov®
(
sc¡_cmd
 *
cmd
,

430 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

431 
g‘_cdb_šfo_¡¬t_¡Ý
(
sc¡_cmd
 *
cmd
,

432 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

433 
g‘_cdb_šfo_Ën_3_»ad_–em_¡©
(
sc¡_cmd
 *
cmd
,

434 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

435 
g‘_cdb_šfo_Ën_2
(
sc¡_cmd
 *
cmd
,

436 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

437 
g‘_cdb_šfo_fmt
(
sc¡_cmd
 *
cmd
,

438 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

439 
g‘_cdb_šfo_v”ify6
(
sc¡_cmd
 *
cmd
,

440 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

441 
g‘_cdb_šfo_v”ify10
(
sc¡_cmd
 *
cmd
,

442 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

443 
g‘_cdb_šfo_v”ify12
(
sc¡_cmd
 *
cmd
,

444 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

445 
g‘_cdb_šfo_v”ify16
(
sc¡_cmd
 *
cmd
,

446 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

447 
g‘_cdb_šfo_Ën_1
(
sc¡_cmd
 *
cmd
,

448 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

449 
g‘_cdb_šfo_lba_3_Ën_1_256_»ad
(
sc¡_cmd
 *
cmd
,

450 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

451 
g‘_cdb_šfo_lba_3_Ën_1_256_wr™e
(
sc¡_cmd
 *
cmd
,

452 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

453 
g‘_cdb_šfo_bidi_lba_4_Ën_2
(
sc¡_cmd
 *
cmd
,

454 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

455 
g‘_cdb_šfo_Ën_3
(
sc¡_cmd
 *
cmd
,

456 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

457 
g‘_cdb_šfo_Ën_4
(
sc¡_cmd
 *
cmd
,

458 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

459 
g‘_cdb_šfo_nÚe
(
sc¡_cmd
 *
cmd
,

460 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

461 
g‘_cdb_šfo_lba_2_nÚe
(
sc¡_cmd
 *
cmd
,

462 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

463 
g‘_cdb_šfo_lba_4_Ën_2
(
sc¡_cmd
 *
cmd
,

464 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

465 
g‘_cdb_šfo_»ad_10
(
sc¡_cmd
 *
cmd
,

466 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

467 
g‘_cdb_šfo_lba_4_Ën_2_w½rÙeù
(
sc¡_cmd
 *
cmd
,

468 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

469 
g‘_cdb_šfo_lba_4_nÚe
(
sc¡_cmd
 *
cmd
,

470 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

471 
g‘_cdb_šfo_lba_4_Ën_4_rd´Ùeù
(
sc¡_cmd
 *
cmd
,

472 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

473 
g‘_cdb_šfo_lba_4_Ën_4_w½rÙeù
(
sc¡_cmd
 *
cmd
,

474 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

475 
g‘_cdb_šfo_»ad_16
(
sc¡_cmd
 *
cmd
,

476 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

477 
g‘_cdb_šfo_lba_8_Ën_4_w½rÙeù
(
sc¡_cmd
 *
cmd
,

478 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

479 
g‘_cdb_šfo_lba_8_nÚe
(
sc¡_cmd
 *
cmd
,

480 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

481 
g‘_cdb_šfo_wr™e_§me10
(
sc¡_cmd
 *
cmd
,

482 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

483 
g‘_cdb_šfo_wr™e_§me16
(
sc¡_cmd
 *
cmd
,

484 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

485 
g‘_cdb_šfo_com·»_ªd_wr™e
(
sc¡_cmd
 *
cmd
,

486 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

487 
g‘_cdb_šfo_ext_cÝy
(
sc¡_cmd
 *
cmd
,

488 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

489 
g‘_cdb_šfo_­t
(
sc¡_cmd
 *
cmd
,

490 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

491 
g‘_cdb_šfo_mš
(
sc¡_cmd
 *
cmd
,

492 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

493 
g‘_cdb_šfo_mo
(
sc¡_cmd
 *
cmd
,

494 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

495 
g‘_cdb_šfo_v¬_Ën
(
sc¡_cmd
 *
cmd
,

496 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
);

513 
	#SCST_CDB_MANDATORY
 'M'

	)

514 
	#SCST_CDB_OPTIONAL
 'O'

	)

515 
	#SCST_CDB_VENDOR
 'V'

	)

516 
	#SCST_CDB_RESERVED
 'R'

	)

517 
	#SCST_CDB_NOTSUPP
 ' '

	)

519 
	ssc¡_sdbÝs
 {

520 
ušt8_t
 
	mÝs
;

521 
ušt8_t
 
	mdevkey
[16];

539 
ušt8_t
 
	mšfo_lba_off
;

540 
ušt8_t
 
	mšfo_lba_Ën
;

541 
ušt8_t
 
	mšfo_Ën_off
;

542 
ušt8_t
 
	mšfo_Ën_Ën
;

543 
ušt8_t
 
	mšfo_d©a_dœeùiÚ
;

547 
ušt32_t
 
	mšfo_Ý_æags
;

548 cÚ¡ *
	mšfo_Ý_Çme
;

549 (*
	mg‘_cdb_šfo
)(
sc¡_cmd
 *
	mcmd
, cÚ¡ 
sc¡_sdbÝs
 *
	msdbÝs
);

552 
	gsc¡_scsi_Ý_li¡
[256];

554 
	#FLAG_NONE
 0

	)

557 cÚ¡ 
sc¡_sdbÝs
 
	gsc¡_scsi_Ý_bË
[] = {

592 {.
Ýs
 = 0x00, .
	gdevkey
 = "MMMMMMMMMMMMMMMM",

593 .
	gšfo_Ý_Çme
 = "TEST UNIT READY",

594 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

596 .
	gšfo_Ý_æags
 = 
SCST_SMALL_TIMEOUT
|
SCST_IMPLICIT_HQ
|

597 
SCST_REG_RESERVE_ALLOWED
|
SCST_WRITE_EXCL_ALLOWED
|

598 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


599 
SCST_TEST_IO_IN_SIRQ_ALLOWED
|

601 
SCST_EXCL_ACCESS_ALLOWED
,

602 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

603 {.
	gÝs
 = 0x01, .
	gdevkey
 = " M ",

604 .
	gšfo_Ý_Çme
 = "REWIND",

605 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

606 .
	gšfo_Ý_æags
 = 
SCST_LONG_TIMEOUT
|
SCST_WRITE_EXCL_ALLOWED
,

607 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

608 {.
	gÝs
 = 0x03, .
	gdevkey
 = "MMMMMMMMMMMMMMMM",

609 .
	gšfo_Ý_Çme
 = "REQUEST SENSE",

610 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

611 .
	gšfo_Ý_æags
 = 
SCST_SMALL_TIMEOUT
|
SCST_SKIP_UA
|
SCST_LOCAL_CMD
|

612 
SCST_REG_RESERVE_ALLOWED
|
SCST_WRITE_EXCL_ALLOWED
|

613 
SCST_EXCL_ACCESS_ALLOWED
,

614 .
	gšfo_Ën_off
 = 4, .
	gšfo_Ën_Ën
 = 1,

615 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_1
},

616 {.
	gÝs
 = 0x04, .
	gdevkey
 = "M O O ",

617 .
	gšfo_Ý_Çme
 = "FORMAT UNIT",

618 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

619 .
	gšfo_Ý_æags
 = 
SCST_LONG_TIMEOUT
|
SCST_WRITE_MEDIUM
|
SCST_STRICTLY_SERIALIZED
,

620 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_fmt
},

621 {.
	gÝs
 = 0x04, .
	gdevkey
 = " O ",

622 .
	gšfo_Ý_Çme
 = "FORMAT MEDIUM",

623 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

624 .
	gšfo_Ý_æags
 = 
SCST_LONG_TIMEOUT
|
SCST_WRITE_MEDIUM
|
SCST_STRICTLY_SERIALIZED
,

625 .
	gšfo_Ën_off
 = 3, .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

626 {.
	gÝs
 = 0x04, .
	gdevkey
 = " O ",

627 .
	gšfo_Ý_Çme
 = "FORMAT",

628 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

629 .
	gšfo_Ý_æags
 = 
SCST_WRITE_MEDIUM
|
SCST_STRICTLY_SERIALIZED
,

630 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

631 {.
	gÝs
 = 0x05, .
	gdevkey
 = "VMVVVV V ",

632 .
	gšfo_Ý_Çme
 = "READ BLOCK LIMITS",

633 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

634 .
	gšfo_Ý_æags
 = 
SCST_SMALL_TIMEOUT
|
SCST_REG_RESERVE_ALLOWED
|

635 
SCST_WRITE_EXCL_ALLOWED
|
SCST_EXCL_ACCESS_ALLOWED
,

636 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_block_lim™
},

637 {.
	gÝs
 = 0x07, .
	gdevkey
 = " O ",

638 .
	gšfo_Ý_Çme
 = "INITIALIZE ELEMENT STATUS",

639 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

640 .
	gšfo_Ý_æags
 = 
SCST_LONG_TIMEOUT
,

641 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

642 {.
	gÝs
 = 0x07, .
	gdevkey
 = "OVV O OV ",

643 .
	gšfo_Ý_Çme
 = "REASSIGN BLOCKS",

644 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

645 .
	gšfo_Ý_æags
 = 
SCST_WRITE_MEDIUM
,

646 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

647 {.
	gÝs
 = 0x08, .
	gdevkey
 = "O ",

648 .
	gšfo_Ý_Çme
 = "READ(6)",

649 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

650 .
	gšfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
|

651 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


652 
SCST_TEST_IO_IN_SIRQ_ALLOWED
|

654 
SCST_WRITE_EXCL_ALLOWED
,

655 .
	gšfo_lba_off
 = 1, .
	gšfo_lba_Ën
 = 3,

656 .
	gšfo_Ën_off
 = 4, .
	gšfo_Ën_Ën
 = 1,

657 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_lba_3_Ën_1_256_»ad
},

658 {.
	gÝs
 = 0x08, .
	gdevkey
 = " MV O OV ",

659 .
	gšfo_Ý_Çme
 = "READ(6)",

660 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

661 .
	gšfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
|

662 
SCST_WRITE_EXCL_ALLOWED
,

663 .
	gšfo_Ën_off
 = 2, .
	gšfo_Ën_Ën
 = 3,

664 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_3
},

665 {.
	gÝs
 = 0x08, .
	gdevkey
 = " M ",

666 .
	gšfo_Ý_Çme
 = "GET MESSAGE(6)",

667 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

668 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

669 .
	gšfo_Ën_off
 = 2, .
	gšfo_Ën_Ën
 = 3,

670 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_3
},

671 {.
	gÝs
 = 0x08, .
	gdevkey
 = " O ",

672 .
	gšfo_Ý_Çme
 = "RECEIVE",

673 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

674 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

675 .
	gšfo_Ën_off
 = 2, .
	gšfo_Ën_Ën
 = 3,

676 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_3
},

677 {.
	gÝs
 = 0x0A, .
	gdevkey
 = "O ",

678 .
	gšfo_Ý_Çme
 = "WRITE(6)",

679 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

680 .
	gšfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
|

681 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


682 
SCST_TEST_IO_IN_SIRQ_ALLOWED
|

684 
SCST_WRITE_MEDIUM
,

685 .
	gšfo_lba_off
 = 1, .
	gšfo_lba_Ën
 = 3,

686 .
	gšfo_Ën_off
 = 4, .
	gšfo_Ën_Ën
 = 1,

687 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_lba_3_Ën_1_256_wr™e
},

688 {.
	gÝs
 = 0x0A, .
	gdevkey
 = " M O OV ",

689 .
	gšfo_Ý_Çme
 = "WRITE(6)",

690 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

691 .
	gšfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
|
SCST_WRITE_MEDIUM
,

692 .
	gšfo_Ën_off
 = 2, .
	gšfo_Ën_Ën
 = 3,

693 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_3
},

694 {.
	gÝs
 = 0x0A, .
	gdevkey
 = " M ",

695 .
	gšfo_Ý_Çme
 = "PRINT",

696 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

697 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

698 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

699 {.
	gÝs
 = 0x0A, .
	gdevkey
 = " M ",

700 .
	gšfo_Ý_Çme
 = "SEND MESSAGE(6)",

701 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

702 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

703 .
	gšfo_Ën_off
 = 2, .
	gšfo_Ën_Ën
 = 3,

704 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_3
},

705 {.
	gÝs
 = 0x0A, .
	gdevkey
 = " M ",

706 .
	gšfo_Ý_Çme
 = "SEND(6)",

707 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

708 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

709 .
	gšfo_Ën_off
 = 2, .
	gšfo_Ën_Ën
 = 3,

710 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_3
},

711 {.
	gÝs
 = 0x0B, .
	gdevkey
 = "O OO OV ",

712 .
	gšfo_Ý_Çme
 = "SEEK(6)",

713 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

714 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

715 .
	gšfo_lba_off
 = 2, .
	gšfo_lba_Ën
 = 2,

716 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_lba_2_nÚe
},

717 {.
	gÝs
 = 0x0B, .
	gdevkey
 = " O ",

718 .
	gšfo_Ý_Çme
 = "SLEW AND PRINT",

719 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

720 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

721 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

722 {.
	gÝs
 = 0x0C, .
	gdevkey
 = " VVVVV V ",

723 .
	gšfo_Ý_Çme
 = "SEEK BLOCK",

724 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

725 .
	gšfo_Ý_æags
 = 
SCST_LONG_TIMEOUT
,

726 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

727 {.
	gÝs
 = 0x0D, .
	gdevkey
 = " VVVVV V ",

728 .
	gšfo_Ý_Çme
 = "PARTITION",

729 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

730 .
	gšfo_Ý_æags
 = 
SCST_LONG_TIMEOUT
|
SCST_WRITE_MEDIUM
,

731 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

732 {.
	gÝs
 = 0x0F, .
	gdevkey
 = " OVVVV V ",

733 .
	gšfo_Ý_Çme
 = "READ REVERSE",

734 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

735 .
	gšfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
|

736 
SCST_WRITE_EXCL_ALLOWED
,

737 .
	gšfo_Ën_off
 = 12, .
	gšfo_Ën_Ën
 = 3,

738 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_3
},

739 {.
	gÝs
 = 0x10, .
	gdevkey
 = " M V V ",

740 .
	gšfo_Ý_Çme
 = "WRITE FILEMARKS(6)",

741 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

742 .
	gšfo_Ý_æags
 = 
SCST_WRITE_MEDIUM
,

743 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

744 {.
	gÝs
 = 0x10, .
	gdevkey
 = " O O ",

745 .
	gšfo_Ý_Çme
 = "SYNCHRONIZE BUFFER",

746 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

747 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

748 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

749 {.
	gÝs
 = 0x11, .
	gdevkey
 = "VMVVVV ",

750 .
	gšfo_Ý_Çme
 = "SPACE",

751 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

752 .
	gšfo_Ý_æags
 = 
SCST_LONG_TIMEOUT
|

753 
SCST_WRITE_EXCL_ALLOWED
,

754 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

755 {.
	gÝs
 = 0x12, .
	gdevkey
 = "MMMMMMMMMMMMMMMM",

756 .
	gšfo_Ý_Çme
 = "INQUIRY",

757 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

758 .
	gšfo_Ý_æags
 = 
SCST_SMALL_TIMEOUT
|
SCST_IMPLICIT_HQ
|
SCST_SKIP_UA
|

759 
SCST_REG_RESERVE_ALLOWED
|
SCST_WRITE_EXCL_ALLOWED
|

760 
SCST_EXCL_ACCESS_ALLOWED
,

761 .
	gšfo_Ën_off
 = 3, .
	gšfo_Ën_Ën
 = 2,

762 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

763 {.
	gÝs
 = 0x13, .
	gdevkey
 = " O ",

764 .
	gšfo_Ý_Çme
 = "VERIFY(6)",

765 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_UNKNOWN
,

766 .
	gšfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
|
SCST_WRITE_EXCL_ALLOWED
,

767 .
	gšfo_Ën_off
 = 2, .
	gšfo_Ën_Ën
 = 3,

768 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_v”ify6
},

769 {.
	gÝs
 = 0x14, .
	gdevkey
 = " OOVVV ",

770 .
	gšfo_Ý_Çme
 = "RECOVER BUFFERED DATA",

771 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

772 .
	gšfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
|
SCST_WRITE_EXCL_ALLOWED
,

773 .
	gšfo_Ën_off
 = 2, .
	gšfo_Ën_Ën
 = 3,

774 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_3
},

775 {.
	gÝs
 = 0x15, .
	gdevkey
 = "OMOOOOOOOOOOOOOO",

776 .
	gšfo_Ý_Çme
 = "MODE SELECT(6)",

777 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

778 .
	gšfo_Ý_æags
 = 
SCST_STRICTLY_SERIALIZED
,

779 .
	gšfo_Ën_off
 = 4, .
	gšfo_Ën_Ën
 = 1,

780 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_1
},

781 {.
	gÝs
 = 0x16, .
	gdevkey
 = "MMMMMMMMMMMMMMMM",

782 .
	gšfo_Ý_Çme
 = "RESERVE",

783 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

784 .
	gšfo_Ý_æags
 = 
SCST_SMALL_TIMEOUT
|
SCST_LOCAL_CMD
|
SCST_SERIALIZED
|

785 
SCST_WRITE_EXCL_ALLOWED
|
SCST_EXCL_ACCESS_ALLOWED
|

786 
SCST_SCSI_ATOMIC
 ,

787 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

788 {.
	gÝs
 = 0x17, .
	gdevkey
 = "MMMMMMMMMMMMMMMM",

789 .
	gšfo_Ý_Çme
 = "RELEASE",

790 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

791 .
	gšfo_Ý_æags
 = 
SCST_SMALL_TIMEOUT
|
SCST_LOCAL_CMD
|
SCST_SERIALIZED
|

792 
SCST_REG_RESERVE_ALLOWED
|
SCST_WRITE_EXCL_ALLOWED
|

793 
SCST_EXCL_ACCESS_ALLOWED
,

794 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

795 {.
	gÝs
 = 0x19, .
	gdevkey
 = " MVVVV ",

796 .
	gšfo_Ý_Çme
 = "ERASE",

797 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

798 .
	gšfo_Ý_æags
 = 
SCST_LONG_TIMEOUT
|
SCST_WRITE_MEDIUM
,

799 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

800 {.
	gÝs
 = 0x1A, .
	gdevkey
 = "OMOOOOOOOOOOOOOO",

801 .
	gšfo_Ý_Çme
 = "MODE SENSE(6)",

802 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

803 .
	gšfo_Ý_æags
 = 
SCST_SMALL_TIMEOUT
 |

804 
SCST_WRITE_EXCL_ALLOWED
,

805 .
	gšfo_Ën_off
 = 4, .
	gšfo_Ën_Ën
 = 1,

806 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_1
},

807 {.
	gÝs
 = 0x1B, .
	gdevkey
 = " O ",

808 .
	gšfo_Ý_Çme
 = "SCAN",

809 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

810 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

811 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

812 {.
	gÝs
 = 0x1B, .
	gdevkey
 = " O ",

813 .
	gšfo_Ý_Çme
 = "LOAD UNLOAD",

814 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

815 .
	gšfo_Ý_æags
 = 
SCST_LONG_TIMEOUT
,

816 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

817 {.
	gÝs
 = 0x1B, .
	gdevkey
 = " O ",

818 .
	gšfo_Ý_Çme
 = "STOP PRINT",

819 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

820 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

821 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

822 {.
	gÝs
 = 0x1B, .
	gdevkey
 = "O OO O O ",

823 .
	gšfo_Ý_Çme
 = "START STOP UNIT",

824 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

825 .
	gšfo_Ý_æags
 = 
SCST_LONG_TIMEOUT
,

826 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_¡¬t_¡Ý
},

827 {.
	gÝs
 = 0x1C, .
	gdevkey
 = "OOOOOOOOOOOOOOOO",

828 .
	gšfo_Ý_Çme
 = "RECEIVE DIAGNOSTIC RESULTS",

829 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

830 .
	gšfo_Ý_æags
 = 
SCST_WRITE_EXCL_ALLOWED
,

831 .
	gšfo_Ën_off
 = 3, .
	gšfo_Ën_Ën
 = 2,

832 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

833 {.
	gÝs
 = 0x1D, .
	gdevkey
 = "MMMMMMMMMMMMMMMM",

834 .
	gšfo_Ý_Çme
 = "SEND DIAGNOSTIC",

835 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

836 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

837 .
	gšfo_Ën_off
 = 3, .
	gšfo_Ën_Ën
 = 2,

838 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

839 {.
	gÝs
 = 0x1E, .
	gdevkey
 = "OOOOOOOOOOOOOOOO",

840 .
	gšfo_Ý_Çme
 = "PREVENT ALLOW MEDIUM REMOVAL",

841 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

842 .
	gšfo_Ý_æags
 = 
SCST_LONG_TIMEOUT
,

843 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_´ev’t_®low_medium_»mov®
},

844 {.
	gÝs
 = 0x1F, .
	gdevkey
 = " O ",

845 .
	gšfo_Ý_Çme
 = "PORT STATUS",

846 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

847 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

848 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

851 {.
	gÝs
 = 0x23, .
	gdevkey
 = "V VV V ",

852 .
	gšfo_Ý_Çme
 = "READ FORMAT CAPACITY",

853 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

854 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

855 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

856 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

857 {.
	gÝs
 = 0x24, .
	gdevkey
 = " VVM ",

858 .
	gšfo_Ý_Çme
 = "SET WINDOW",

859 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

860 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

861 .
	gšfo_Ën_off
 = 6, .
	gšfo_Ën_Ën
 = 3,

862 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_3
},

863 {.
	gÝs
 = 0x25, .
	gdevkey
 = "M MM M ",

864 .
	gšfo_Ý_Çme
 = "READ CAPACITY",

865 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

866 .
	gšfo_Ý_æags
 = 
SCST_IMPLICIT_HQ
|
SCST_REG_RESERVE_ALLOWED
|

867 
SCST_WRITE_EXCL_ALLOWED
|
SCST_EXCL_ACCESS_ALLOWED
,

868 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_»ad_ÿ·c™y
},

869 {.
	gÝs
 = 0x25, .
	gdevkey
 = " O ",

870 .
	gšfo_Ý_Çme
 = "GET WINDOW",

871 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

872 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

873 .
	gšfo_Ën_off
 = 6, .
	gšfo_Ën_Ën
 = 3,

874 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_3
},

875 {.
	gÝs
 = 0x28, .
	gdevkey
 = "M MMMM ",

876 .
	gšfo_Ý_Çme
 = "READ(10)",

877 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

878 .
	gšfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
|

879 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


880 
SCST_TEST_IO_IN_SIRQ_ALLOWED
|

882 
SCST_WRITE_EXCL_ALLOWED
,

883 .
	gšfo_lba_off
 = 2, .
	gšfo_lba_Ën
 = 4,

884 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

885 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_»ad_10
},

886 {.
	gÝs
 = 0x28, .
	gdevkey
 = " O ",

887 .
	gšfo_Ý_Çme
 = "GET MESSAGE(10)",

888 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

889 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

890 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

891 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

892 {.
	gÝs
 = 0x29, .
	gdevkey
 = "V VV O ",

893 .
	gšfo_Ý_Çme
 = "READ GENERATION",

894 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

895 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

896 .
	gšfo_Ën_off
 = 8, .
	gšfo_Ën_Ën
 = 1,

897 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_1
},

898 {.
	gÝs
 = 0x2A, .
	gdevkey
 = "O MO M ",

899 .
	gšfo_Ý_Çme
 = "WRITE(10)",

900 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

901 .
	gšfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
|

902 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


903 
SCST_TEST_IO_IN_SIRQ_ALLOWED
|

905 
SCST_WRITE_MEDIUM
,

906 .
	gšfo_lba_off
 = 2, .
	gšfo_lba_Ën
 = 4,

907 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

908 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_lba_4_Ën_2_w½rÙeù
},

909 {.
	gÝs
 = 0x2A, .
	gdevkey
 = " O ",

910 .
	gšfo_Ý_Çme
 = "SEND MESSAGE(10)",

911 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

912 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

913 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

914 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

915 {.
	gÝs
 = 0x2A, .
	gdevkey
 = " O ",

916 .
	gšfo_Ý_Çme
 = "SEND(10)",

917 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

918 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

919 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

920 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

921 {.
	gÝs
 = 0x2B, .
	gdevkey
 = " O ",

922 .
	gšfo_Ý_Çme
 = "LOCATE",

923 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

924 .
	gšfo_Ý_æags
 = 
SCST_LONG_TIMEOUT
|
SCST_WRITE_EXCL_ALLOWED
,

925 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

926 {.
	gÝs
 = 0x2B, .
	gdevkey
 = " O ",

927 .
	gšfo_Ý_Çme
 = "POSITION TO ELEMENT",

928 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

929 .
	gšfo_Ý_æags
 = 
SCST_LONG_TIMEOUT
,

930 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

931 {.
	gÝs
 = 0x2B, .
	gdevkey
 = "O OO O ",

932 .
	gšfo_Ý_Çme
 = "SEEK(10)",

933 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

934 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

935 .
	gšfo_lba_off
 = 2, .
	gšfo_lba_Ën
 = 4,

936 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_lba_4_nÚe
},

937 {.
	gÝs
 = 0x2C, .
	gdevkey
 = "V O O ",

938 .
	gšfo_Ý_Çme
 = "ERASE(10)",

939 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

940 .
	gšfo_Ý_æags
 = 
SCST_LONG_TIMEOUT
|
SCST_WRITE_MEDIUM
,

941 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

942 {.
	gÝs
 = 0x2D, .
	gdevkey
 = "V O O ",

943 .
	gšfo_Ý_Çme
 = "READ UPDATED BLOCK",

944 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

945 .
	gšfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
,

946 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_sšgË
},

947 {.
	gÝs
 = 0x2E, .
	gdevkey
 = "O OO O ",

948 .
	gšfo_Ý_Çme
 = "WRITE AND VERIFY(10)",

949 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

950 .
	gšfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
|
SCST_WRITE_MEDIUM
,

951 .
	gšfo_lba_off
 = 2, .
	gšfo_lba_Ën
 = 4,

952 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

953 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_lba_4_Ën_2_w½rÙeù
},

954 {.
	gÝs
 = 0x2F, .
	gdevkey
 = "O OO O ",

955 .
	gšfo_Ý_Çme
 = "VERIFY(10)",

956 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_UNKNOWN
,

957 .
	gšfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
|
SCST_WRITE_EXCL_ALLOWED
,

958 .
	gšfo_lba_off
 = 2, .
	gšfo_lba_Ën
 = 4,

959 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

960 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_v”ify10
},

961 {.
	gÝs
 = 0x33, .
	gdevkey
 = " OO O ",

962 .
	gšfo_Ý_Çme
 = "SET LIMITS(10)",

963 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

964 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

965 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

966 {.
	gÝs
 = 0x34, .
	gdevkey
 = " O ",

967 .
	gšfo_Ý_Çme
 = "READ POSITION",

968 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

969 .
	gšfo_Ý_æags
 = 
SCST_SMALL_TIMEOUT
|
SCST_WRITE_EXCL_ALLOWED
,

970 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

971 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_»ad_pos
},

972 {.
	gÝs
 = 0x34, .
	gdevkey
 = " O ",

973 .
	gšfo_Ý_Çme
 = "GET DATA BUFFER STATUS",

974 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

975 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

976 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

977 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

978 {.
	gÝs
 = 0x34, .
	gdevkey
 = "O OO O ",

979 .
	gšfo_Ý_Çme
 = "PRE-FETCH",

980 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

981 .
	gšfo_Ý_æags
 = 
SCST_WRITE_EXCL_ALLOWED
,

982 .
	gšfo_lba_off
 = 2, .
	gšfo_lba_Ën
 = 4,

983 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

984 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_lba_4_nÚe
},

985 {.
	gÝs
 = 0x35, .
	gdevkey
 = "O OO O ",

986 .
	gšfo_Ý_Çme
 = "SYNCHRONIZE CACHE(10)",

987 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

988 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

989 .
	gšfo_lba_off
 = 2, .
	gšfo_lba_Ën
 = 4,

990 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

991 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_lba_4_nÚe
},

992 {.
	gÝs
 = 0x36, .
	gdevkey
 = "O OO O ",

993 .
	gšfo_Ý_Çme
 = "LOCK UNLOCK CACHE",

994 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

995 .
	gšfo_Ý_æags
 = 
SCST_WRITE_EXCL_ALLOWED
,

996 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

997 {.
	gÝs
 = 0x37, .
	gdevkey
 = "O O ",

998 .
	gšfo_Ý_Çme
 = "READ DEFECT DATA(10)",

999 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1000 .
	gšfo_Ý_æags
 = 
SCST_WRITE_EXCL_ALLOWED
,

1001 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

1002 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

1003 {.
	gÝs
 = 0x37, .
	gdevkey
 = " O ",

1004 .
	gšfo_Ý_Çme
 = "INIT ELEMENT STATUS WRANGE",

1005 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1006 .
	gšfo_Ý_æags
 = 
SCST_LONG_TIMEOUT
,

1007 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1008 {.
	gÝs
 = 0x38, .
	gdevkey
 = " O O ",

1009 .
	gšfo_Ý_Çme
 = "MEDIUM SCAN",

1010 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1011 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1012 .
	gšfo_Ën_off
 = 8, .
	gšfo_Ën_Ën
 = 1,

1013 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_1
},

1014 {.
	gÝs
 = 0x3B, .
	gdevkey
 = "OOOOOOOOOOOOOOOO",

1015 .
	gšfo_Ý_Çme
 = "WRITE BUFFER",

1016 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1017 .
	gšfo_Ý_æags
 = 
SCST_SMALL_TIMEOUT
,

1018 .
	gšfo_Ën_off
 = 6, .
	gšfo_Ën_Ën
 = 3,

1019 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_3
},

1020 {.
	gÝs
 = 0x3C, .
	gdevkey
 = "OOOOOOOOOOOOOOOO",

1021 .
	gšfo_Ý_Çme
 = "READ BUFFER",

1022 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1023 .
	gšfo_Ý_æags
 = 
SCST_SMALL_TIMEOUT
 |

1024 
SCST_WRITE_EXCL_ALLOWED
,

1025 .
	gšfo_Ën_off
 = 6, .
	gšfo_Ën_Ën
 = 3,

1026 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_3
},

1027 {.
	gÝs
 = 0x3D, .
	gdevkey
 = " O O ",

1028 .
	gšfo_Ý_Çme
 = "UPDATE BLOCK",

1029 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1030 .
	gšfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
,

1031 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_sšgË
},

1032 {.
	gÝs
 = 0x3E, .
	gdevkey
 = "O OO O ",

1033 .
	gšfo_Ý_Çme
 = "READ LONG",

1034 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1035 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1036 .
	gšfo_lba_off
 = 2, .
	gšfo_lba_Ën
 = 4,

1037 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

1038 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_lba_4_Ën_2
},

1039 {.
	gÝs
 = 0x3F, .
	gdevkey
 = "O O O ",

1040 .
	gšfo_Ý_Çme
 = "WRITE LONG",

1041 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1042 .
	gšfo_Ý_æags
 = 
SCST_WRITE_MEDIUM
,

1043 .
	gšfo_lba_off
 = 2, .
	gšfo_lba_Ën
 = 4,

1044 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

1045 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_lba_4_Ën_2
},

1046 {.
	gÝs
 = 0x40, .
	gdevkey
 = "OOOOOOOOOO ",

1047 .
	gšfo_Ý_Çme
 = "CHANGE DEFINITION",

1048 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1049 .
	gšfo_Ý_æags
 = 
SCST_SMALL_TIMEOUT
,

1050 .
	gšfo_Ën_off
 = 8, .
	gšfo_Ën_Ën
 = 1,

1051 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_1
},

1052 {.
	gÝs
 = 0x41, .
	gdevkey
 = "O ",

1053 .
	gšfo_Ý_Çme
 = "WRITE SAME(10)",

1054 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1055 .
	gšfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
|
SCST_WRITE_MEDIUM
,

1056 .
	gšfo_lba_off
 = 2, .
	gšfo_lba_Ën
 = 4,

1057 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

1058 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_wr™e_§me10
},

1059 {.
	gÝs
 = 0x42, .
	gdevkey
 = " O ",

1060 .
	gšfo_Ý_Çme
 = "READ SUB-CHANNEL",

1061 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1062 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1063 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

1064 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

1065 {.
	gÝs
 = 0x42, .
	gdevkey
 = "O ",

1066 .
	gšfo_Ý_Çme
 = "UNMAP",

1067 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1068 .
	gšfo_Ý_æags
 = 
SCST_WRITE_MEDIUM
|
SCST_DESCRIPTORS_BASED
,

1069 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

1070 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

1071 {.
	gÝs
 = 0x43, .
	gdevkey
 = " O ",

1072 .
	gšfo_Ý_Çme
 = "READ TOC/PMA/ATIP",

1073 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1074 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1075 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

1076 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

1077 {.
	gÝs
 = 0x44, .
	gdevkey
 = " M ",

1078 .
	gšfo_Ý_Çme
 = "REPORT DENSITY SUPPORT",

1079 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1080 .
	gšfo_Ý_æags
 = 
SCST_REG_RESERVE_ALLOWED
|
SCST_WRITE_EXCL_ALLOWED
|

1081 
SCST_EXCL_ACCESS_ALLOWED
,

1082 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

1083 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

1084 {.
	gÝs
 = 0x44, .
	gdevkey
 = " O ",

1085 .
	gšfo_Ý_Çme
 = "READ HEADER",

1086 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1087 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1088 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

1089 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

1090 {.
	gÝs
 = 0x45, .
	gdevkey
 = " O ",

1091 .
	gšfo_Ý_Çme
 = "PLAY AUDIO(10)",

1092 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1093 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1094 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1095 {.
	gÝs
 = 0x46, .
	gdevkey
 = " O ",

1096 .
	gšfo_Ý_Çme
 = "GET CONFIGURATION",

1097 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1098 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1099 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

1100 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

1101 {.
	gÝs
 = 0x47, .
	gdevkey
 = " O ",

1102 .
	gšfo_Ý_Çme
 = "PLAY AUDIO MSF",

1103 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1104 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1105 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1106 {.
	gÝs
 = 0x48, .
	gdevkey
 = " O ",

1107 .
	gšfo_Ý_Çme
 = "PLAY AUDIO TRACK INDEX",

1108 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1109 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1110 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1111 {.
	gÝs
 = 0x49, .
	gdevkey
 = " O ",

1112 .
	gšfo_Ý_Çme
 = "PLAY TRACK RELATIVE(10)",

1113 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1114 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1115 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1116 {.
	gÝs
 = 0x4A, .
	gdevkey
 = " O ",

1117 .
	gšfo_Ý_Çme
 = "GET EVENT STATUS NOTIFICATION",

1118 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1119 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1120 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

1121 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

1122 {.
	gÝs
 = 0x4B, .
	gdevkey
 = " O ",

1123 .
	gšfo_Ý_Çme
 = "PAUSE/RESUME",

1124 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1125 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1126 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1127 {.
	gÝs
 = 0x4C, .
	gdevkey
 = "OOOOOOOOOOOOOOOO",

1128 .
	gšfo_Ý_Çme
 = "LOG SELECT",

1129 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1130 .
	gšfo_Ý_æags
 = 
SCST_STRICTLY_SERIALIZED
,

1131 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

1132 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

1133 {.
	gÝs
 = 0x4D, .
	gdevkey
 = "OOOOOOOOOOOOOOOO",

1134 .
	gšfo_Ý_Çme
 = "LOG SENSE",

1135 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1136 .
	gšfo_Ý_æags
 = 
SCST_SMALL_TIMEOUT
|
SCST_REG_RESERVE_ALLOWED
|

1137 
SCST_WRITE_EXCL_ALLOWED
|
SCST_EXCL_ACCESS_ALLOWED
,

1138 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

1139 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

1140 {.
	gÝs
 = 0x4E, .
	gdevkey
 = " O ",

1141 .
	gšfo_Ý_Çme
 = "STOP PLAY/SCAN",

1142 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1143 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1144 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1145 {.
	gÝs
 = 0x50, .
	gdevkey
 = "O ",

1146 .
	gšfo_Ý_Çme
 = "XDWRITE(10)",

1147 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1148 .
	gšfo_Ý_æags
 = 
SCST_WRITE_MEDIUM
,

1149 .
	gšfo_lba_off
 = 2, .
	gšfo_lba_Ën
 = 4,

1150 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

1151 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_lba_4_Ën_2_w½rÙeù
},

1152 {.
	gÝs
 = 0x51, .
	gdevkey
 = " O ",

1153 .
	gšfo_Ý_Çme
 = "READ DISC INFORMATION",

1154 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1155 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1156 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

1157 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

1158 {.
	gÝs
 = 0x51, .
	gdevkey
 = "O ",

1159 .
	gšfo_Ý_Çme
 = "XPWRITE",

1160 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1161 .
	gšfo_Ý_æags
 = 
SCST_WRITE_MEDIUM
,

1162 .
	gšfo_lba_off
 = 2, .
	gšfo_lba_Ën
 = 4,

1163 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

1164 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_lba_4_Ën_2
},

1165 {.
	gÝs
 = 0x52, .
	gdevkey
 = " O ",

1166 .
	gšfo_Ý_Çme
 = "READ TRACK INFORMATION",

1167 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1168 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1169 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

1170 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

1171 {.
	gÝs
 = 0x53, .
	gdevkey
 = "O ",

1172 .
	gšfo_Ý_Çme
 = "XDWRITEREAD(10)",

1173 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_BIDI
,

1174 .
	gšfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
|
SCST_WRITE_MEDIUM
,

1175 .
	gšfo_lba_off
 = 2, .
	gšfo_lba_Ën
 = 4,

1176 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

1177 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_bidi_lba_4_Ën_2
},

1178 {.
	gÝs
 = 0x53, .
	gdevkey
 = " O ",

1179 .
	gšfo_Ý_Çme
 = "RESERVE TRACK",

1180 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1181 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1182 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1183 {.
	gÝs
 = 0x54, .
	gdevkey
 = " O ",

1184 .
	gšfo_Ý_Çme
 = "SEND OPC INFORMATION",

1185 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1186 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1187 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

1188 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

1189 {.
	gÝs
 = 0x55, .
	gdevkey
 = "OOOOOOOOOOOOOOOO",

1190 .
	gšfo_Ý_Çme
 = "MODE SELECT(10)",

1191 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1192 .
	gšfo_Ý_æags
 = 
SCST_STRICTLY_SERIALIZED
,

1193 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

1194 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

1195 {.
	gÝs
 = 0x56, .
	gdevkey
 = "OOOOOOOOOOOOOOOO",

1196 .
	gšfo_Ý_Çme
 = "RESERVE(10)",

1197 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1198 .
	gšfo_Ý_æags
 = 
SCST_SMALL_TIMEOUT
|
SCST_LOCAL_CMD
|
SCST_SERIALIZED
|

1199 
SCST_WRITE_EXCL_ALLOWED
|
SCST_EXCL_ACCESS_ALLOWED
|

1200 
SCST_SCSI_ATOMIC
 ,

1201 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1202 {.
	gÝs
 = 0x57, .
	gdevkey
 = "OOOOOOOOOOOOOOOO",

1203 .
	gšfo_Ý_Çme
 = "RELEASE(10)",

1204 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1205 .
	gšfo_Ý_æags
 = 
SCST_SMALL_TIMEOUT
|
SCST_LOCAL_CMD
|
SCST_SERIALIZED
|

1206 
SCST_REG_RESERVE_ALLOWED
|
SCST_WRITE_EXCL_ALLOWED
|

1207 
SCST_EXCL_ACCESS_ALLOWED
,

1208 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1209 {.
	gÝs
 = 0x58, .
	gdevkey
 = " O ",

1210 .
	gšfo_Ý_Çme
 = "REPAIR TRACK",

1211 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1212 .
	gšfo_Ý_æags
 = 
SCST_WRITE_MEDIUM
,

1213 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1214 {.
	gÝs
 = 0x5A, .
	gdevkey
 = "OOOOOOOOOOOOOOOO",

1215 .
	gšfo_Ý_Çme
 = "MODE SENSE(10)",

1216 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1217 .
	gšfo_Ý_æags
 = 
SCST_SMALL_TIMEOUT
 |

1218 
SCST_WRITE_EXCL_ALLOWED
,

1219 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

1220 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

1221 {.
	gÝs
 = 0x5B, .
	gdevkey
 = " O ",

1222 .
	gšfo_Ý_Çme
 = "CLOSE TRACK/SESSION",

1223 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1224 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1225 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1226 {.
	gÝs
 = 0x5C, .
	gdevkey
 = " O ",

1227 .
	gšfo_Ý_Çme
 = "READ BUFFER CAPACITY",

1228 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1229 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1230 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 2,

1231 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

1232 {.
	gÝs
 = 0x5D, .
	gdevkey
 = " O ",

1233 .
	gšfo_Ý_Çme
 = "SEND CUE SHEET",

1234 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1235 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1236 .
	gšfo_Ën_off
 = 6, .
	gšfo_Ën_Ën
 = 3,

1237 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_3
},

1238 {.
	gÝs
 = 0x5E, .
	gdevkey
 = "OOOOO OOOO ",

1239 .
	gšfo_Ý_Çme
 = "PERSISTENT RESERVE IN",

1240 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1241 .
	gšfo_Ý_æags
 = 
SCST_SMALL_TIMEOUT
|
SCST_LOCAL_CMD
|
SCST_SERIALIZED
|

1242 
SCST_WRITE_EXCL_ALLOWED
|
SCST_EXCL_ACCESS_ALLOWED
,

1243 .
	gšfo_Ën_off
 = 5, .
	gšfo_Ën_Ën
 = 4,

1244 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_4
},

1245 {.
	gÝs
 = 0x5F, .
	gdevkey
 = "OOOOO OOOO ",

1246 .
	gšfo_Ý_Çme
 = "PERSISTENT RESERVE OUT",

1247 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1248 .
	gšfo_Ý_æags
 = 
SCST_SMALL_TIMEOUT
|
SCST_LOCAL_CMD
|
SCST_SERIALIZED
|

1249 
SCST_WRITE_EXCL_ALLOWED
|
SCST_EXCL_ACCESS_ALLOWED
,

1250 .
	gšfo_Ën_off
 = 5, .
	gšfo_Ën_Ën
 = 4,

1251 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_4
},

1254 {.
	gÝs
 = 0x7F, .
	gdevkey
 = "O ",

1255 .
	gšfo_Ý_Çme
 = "VAR LEN CDB",

1256 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_UNKNOWN
,

1257 .
	gšfo_Ý_æags
 = 0,

1258 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_v¬_Ën
},

1261 {.
	gÝs
 = 0x80, .
	gdevkey
 = " O ",

1262 .
	gšfo_Ý_Çme
 = "WRITE FILEMARKS(16)",

1263 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1264 .
	gšfo_Ý_æags
 = 
SCST_WRITE_MEDIUM
,

1265 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1266 {.
	gÝs
 = 0x81, .
	gdevkey
 = "O OO O ",

1267 .
	gšfo_Ý_Çme
 = "REBUILD",

1268 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1269 .
	gšfo_Ý_æags
 = 
SCST_WRITE_MEDIUM
,

1270 .
	gšfo_Ën_off
 = 10, .
	gšfo_Ën_Ën
 = 4,

1271 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_4
},

1272 {.
	gÝs
 = 0x82, .
	gdevkey
 = "O OO O ",

1273 .
	gšfo_Ý_Çme
 = "REGENERATE",

1274 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1275 .
	gšfo_Ý_æags
 = 
SCST_WRITE_MEDIUM
,

1276 .
	gšfo_Ën_off
 = 10, .
	gšfo_Ën_Ën
 = 4,

1277 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_4
},

1278 {.
	gÝs
 = 0x83, .
	gdevkey
 = "O ",

1279 .
	gšfo_Ý_Çme
 = "EXTENDED COPY",

1280 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1281 .
	gšfo_Ý_æags
 = 
SCST_WRITE_MEDIUM
|
SCST_CAN_GEN_3PARTY_COMMANDS
|

1282 
SCST_LOCAL_CMD
|
SCST_DESCRIPTORS_BASED
,

1283 .
	gšfo_Ën_off
 = 10, .
	gšfo_Ën_Ën
 = 4,

1284 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_ext_cÝy
},

1285 {.
	gÝs
 = 0x84, .
	gdevkey
 = "O ",

1286 .
	gšfo_Ý_Çme
 = "RECEIVE COPY RESULT",

1287 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1288 .
	gšfo_Ý_æags
 = 
SCST_FULLY_LOCAL_CMD
|
SCST_LOCAL_CMD
|

1289 
SCST_WRITE_EXCL_ALLOWED
|
SCST_EXCL_ACCESS_ALLOWED
,

1290 .
	gšfo_Ën_off
 = 10, .
	gšfo_Ën_Ën
 = 4,

1291 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_4
},

1292 {.
	gÝs
 = 0x85, .
	gdevkey
 = "O O O ",

1293 .
	gšfo_Ý_Çme
 = "ATA PASS-THROUGH(16)",

1294 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1295 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1296 .
	gšfo_lba_off
 = 7, .
	gšfo_lba_Ën
 = 6,

1297 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_­t
},

1298 {.
	gÝs
 = 0x86, .
	gdevkey
 = "OOOOOOOOOO ",

1299 .
	gšfo_Ý_Çme
 = "ACCESS CONTROL IN",

1300 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1301 .
	gšfo_Ý_æags
 = 
SCST_REG_RESERVE_ALLOWED
|
SCST_WRITE_EXCL_ALLOWED
|

1302 
SCST_EXCL_ACCESS_ALLOWED
,

1303 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1304 {.
	gÝs
 = 0x87, .
	gdevkey
 = "OOOOOOOOOO ",

1305 .
	gšfo_Ý_Çme
 = "ACCESS CONTROL OUT",

1306 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1307 .
	gšfo_Ý_æags
 = 
SCST_REG_RESERVE_ALLOWED
|
SCST_WRITE_EXCL_ALLOWED
|

1308 
SCST_EXCL_ACCESS_ALLOWED
,

1309 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1310 {.
	gÝs
 = 0x88, .
	gdevkey
 = "M MMMM ",

1311 .
	gšfo_Ý_Çme
 = "READ(16)",

1312 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1313 .
	gšfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
|

1314 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


1315 
SCST_TEST_IO_IN_SIRQ_ALLOWED
|

1317 
SCST_WRITE_EXCL_ALLOWED
,

1318 .
	gšfo_lba_off
 = 2, .
	gšfo_lba_Ën
 = 8,

1319 .
	gšfo_Ën_off
 = 10, .
	gšfo_Ën_Ën
 = 4,

1320 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_»ad_16
},

1321 {.
	gÝs
 = 0x89, .
	gdevkey
 = "O ",

1322 .
	gšfo_Ý_Çme
 = "COMPARE AND WRITE",

1323 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1324 .
	gšfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
|

1325 
SCST_FULLY_LOCAL_CMD
|
SCST_LOCAL_CMD
|

1326 
SCST_WRITE_MEDIUM
|
SCST_SCSI_ATOMIC
,

1327 .
	gšfo_lba_off
 = 2, .
	gšfo_lba_Ën
 = 8,

1328 .
	gšfo_Ën_off
 = 13, .
	gšfo_Ën_Ën
 = 1,

1329 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_com·»_ªd_wr™e
},

1330 {.
	gÝs
 = 0x8A, .
	gdevkey
 = "O OO O ",

1331 .
	gšfo_Ý_Çme
 = "WRITE(16)",

1332 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1333 .
	gšfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
|

1334 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


1335 
SCST_TEST_IO_IN_SIRQ_ALLOWED
|

1337 
SCST_WRITE_MEDIUM
,

1338 .
	gšfo_lba_off
 = 2, .
	gšfo_lba_Ën
 = 8,

1339 .
	gšfo_Ën_off
 = 10, .
	gšfo_Ën_Ën
 = 4,

1340 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_lba_8_Ën_4_w½rÙeù
},

1341 {.
	gÝs
 = 0x8C, .
	gdevkey
 = " OOOOOOOOO ",

1342 .
	gšfo_Ý_Çme
 = "READ ATTRIBUTE",

1343 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1344 .
	gšfo_Ý_æags
 = 
SCST_WRITE_EXCL_ALLOWED
,

1345 .
	gšfo_Ën_off
 = 10, .
	gšfo_Ën_Ën
 = 4,

1346 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_4
},

1347 {.
	gÝs
 = 0x8D, .
	gdevkey
 = " OOOOOOOOO ",

1348 .
	gšfo_Ý_Çme
 = "WRITE ATTRIBUTE",

1349 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1350 .
	gšfo_Ý_æags
 = 
SCST_WRITE_MEDIUM
,

1351 .
	gšfo_Ën_off
 = 10, .
	gšfo_Ën_Ën
 = 4,

1352 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_4
},

1353 {.
	gÝs
 = 0x8E, .
	gdevkey
 = "O OO O ",

1354 .
	gšfo_Ý_Çme
 = "WRITE AND VERIFY(16)",

1355 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1356 .
	gšfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
|
SCST_WRITE_MEDIUM
,

1357 .
	gšfo_lba_off
 = 2, .
	gšfo_lba_Ën
 = 8,

1358 .
	gšfo_Ën_off
 = 10, .
	gšfo_Ën_Ën
 = 4,

1359 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_lba_8_Ën_4_w½rÙeù
},

1360 {.
	gÝs
 = 0x8F, .
	gdevkey
 = "O OO O ",

1361 .
	gšfo_Ý_Çme
 = "VERIFY(16)",

1362 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_UNKNOWN
,

1363 .
	gšfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
|
SCST_WRITE_EXCL_ALLOWED
,

1364 .
	gšfo_lba_off
 = 2, .
	gšfo_lba_Ën
 = 8,

1365 .
	gšfo_Ën_off
 = 10, .
	gšfo_Ën_Ën
 = 4,

1366 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_v”ify16
},

1367 {.
	gÝs
 = 0x90, .
	gdevkey
 = "O OO O ",

1368 .
	gšfo_Ý_Çme
 = "PRE-FETCH(16)",

1369 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1370 .
	gšfo_Ý_æags
 = 
SCST_WRITE_EXCL_ALLOWED
,

1371 .
	gšfo_lba_off
 = 2, .
	gšfo_lba_Ën
 = 8,

1372 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_lba_8_nÚe
},

1373 {.
	gÝs
 = 0x91, .
	gdevkey
 = "O OO O ",

1374 .
	gšfo_Ý_Çme
 = "SYNCHRONIZE CACHE(16)",

1375 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1376 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1377 .
	gšfo_lba_off
 = 2, .
	gšfo_lba_Ën
 = 8,

1378 .
	gšfo_Ën_off
 = 10, .
	gšfo_Ën_Ën
 = 4,

1379 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_lba_8_nÚe
},

1380 {.
	gÝs
 = 0x91, .
	gdevkey
 = " M ",

1381 .
	gšfo_Ý_Çme
 = "SPACE(16)",

1382 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1383 .
	gšfo_Ý_æags
 = 
SCST_LONG_TIMEOUT
|
SCST_WRITE_EXCL_ALLOWED
,

1384 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1385 {.
	gÝs
 = 0x92, .
	gdevkey
 = "O OO O ",

1386 .
	gšfo_Ý_Çme
 = "LOCK UNLOCK CACHE(16)",

1387 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1388 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1389 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1390 {.
	gÝs
 = 0x92, .
	gdevkey
 = " O ",

1391 .
	gšfo_Ý_Çme
 = "LOCATE(16)",

1392 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1393 .
	gšfo_Ý_æags
 = 
SCST_LONG_TIMEOUT
|
SCST_WRITE_EXCL_ALLOWED
,

1394 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1395 {.
	gÝs
 = 0x93, .
	gdevkey
 = "O ",

1396 .
	gšfo_Ý_Çme
 = "WRITE SAME(16)",

1397 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1398 .
	gšfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
|
SCST_WRITE_MEDIUM
,

1399 .
	gšfo_lba_off
 = 2, .
	gšfo_lba_Ën
 = 8,

1400 .
	gšfo_Ën_off
 = 10, .
	gšfo_Ën_Ën
 = 4,

1401 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_wr™e_§me16
},

1402 {.
	gÝs
 = 0x93, .
	gdevkey
 = " M ",

1403 .
	gšfo_Ý_Çme
 = "ERASE(16)",

1404 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1405 .
	gšfo_Ý_æags
 = 
SCST_LONG_TIMEOUT
|
SCST_WRITE_MEDIUM
,

1406 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1407 {.
	gÝs
 = 0x9E, .
	gdevkey
 = "O ",

1408 .
	gšfo_Ý_Çme
 = "SERVICE ACTION IN",

1409 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1410 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1411 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_£rv_aù_š
},

1414 {.
	gÝs
 = 0xA0, .
	gdevkey
 = "VVVVVVVVVV M ",

1415 .
	gšfo_Ý_Çme
 = "REPORT LUNS",

1416 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1417 .
	gšfo_Ý_æags
 = 
SCST_SMALL_TIMEOUT
|
SCST_IMPLICIT_HQ
|
SCST_SKIP_UA
|

1418 
SCST_FULLY_LOCAL_CMD
|
SCST_LOCAL_CMD
|

1419 
SCST_REG_RESERVE_ALLOWED
|

1420 
SCST_WRITE_EXCL_ALLOWED
|
SCST_EXCL_ACCESS_ALLOWED
,

1421 .
	gšfo_Ën_off
 = 6, .
	gšfo_Ën_Ën
 = 4,

1422 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_4
},

1423 {.
	gÝs
 = 0xA1, .
	gdevkey
 = "O O O ",

1424 .
	gšfo_Ý_Çme
 = "ATA PASS-THROUGH(12)",

1425 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1426 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1427 .
	gšfo_lba_off
 = 5, .
	gšfo_lba_Ën
 = 3,

1428 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_­t
},

1429 {.
	gÝs
 = 0xA1, .
	gdevkey
 = " O ",

1430 .
	gšfo_Ý_Çme
 = "BLANK",

1431 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1432 .
	gšfo_Ý_æags
 = 
SCST_LONG_TIMEOUT
,

1433 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1434 {.
	gÝs
 = 0xA2, .
	gdevkey
 = "OO O ",

1435 .
	gšfo_Ý_Çme
 = "SECURITY PROTOCOL IN",

1436 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1437 .
	gšfo_Ý_æags
 = 
SCST_REG_RESERVE_ALLOWED
|
SCST_WRITE_EXCL_ALLOWED
,

1438 .
	gšfo_Ën_off
 = 6, .
	gšfo_Ën_Ën
 = 4,

1439 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_4
},

1440 {.
	gÝs
 = 0xA3, .
	gdevkey
 = " O ",

1441 .
	gšfo_Ý_Çme
 = "SEND KEY",

1442 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1443 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1444 .
	gšfo_Ën_off
 = 8, .
	gšfo_Ën_Ën
 = 2,

1445 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

1446 {.
	gÝs
 = 0xA3, .
	gdevkey
 = "OOO O OOOO MO O",

1447 .
	gšfo_Ý_Çme
 = "MAINTENANCE(IN)",

1448 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1449 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1450 .
	gšfo_Ën_off
 = 6, .
	gšfo_Ën_Ën
 = 4,

1451 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_mš
},

1452 {.
	gÝs
 = 0xA4, .
	gdevkey
 = " O ",

1453 .
	gšfo_Ý_Çme
 = "REPORT KEY",

1454 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1455 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1456 .
	gšfo_Ën_off
 = 8, .
	gšfo_Ën_Ën
 = 2,

1457 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

1458 {.
	gÝs
 = 0xA4, .
	gdevkey
 = "OOO O OOOO MO O",

1459 .
	gšfo_Ý_Çme
 = "MAINTENANCE(OUT)",

1460 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1461 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1462 .
	gšfo_Ën_off
 = 6, .
	gšfo_Ën_Ën
 = 4,

1463 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_mo
},

1464 {.
	gÝs
 = 0xA5, .
	gdevkey
 = " M ",

1465 .
	gšfo_Ý_Çme
 = "MOVE MEDIUM",

1466 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1467 .
	gšfo_Ý_æags
 = 
SCST_LONG_TIMEOUT
,

1468 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1469 {.
	gÝs
 = 0xA5, .
	gdevkey
 = " O ",

1470 .
	gšfo_Ý_Çme
 = "PLAY AUDIO(12)",

1471 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1472 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1473 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1474 {.
	gÝs
 = 0xA6, .
	gdevkey
 = " O O ",

1475 .
	gšfo_Ý_Çme
 = "EXCHANGE/LOAD/UNLOAD MEDIUM",

1476 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1477 .
	gšfo_Ý_æags
 = 
SCST_LONG_TIMEOUT
,

1478 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1479 {.
	gÝs
 = 0xA7, .
	gdevkey
 = " O ",

1480 .
	gšfo_Ý_Çme
 = "SET READ AHEAD",

1481 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1482 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1483 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1484 {.
	gÝs
 = 0xA8, .
	gdevkey
 = " O ",

1485 .
	gšfo_Ý_Çme
 = "GET MESSAGE(12)",

1486 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1487 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1488 .
	gšfo_Ën_off
 = 6, .
	gšfo_Ën_Ën
 = 4,

1489 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_4
},

1490 {.
	gÝs
 = 0xA8, .
	gdevkey
 = "O OO O ",

1491 .
	gšfo_Ý_Çme
 = "READ(12)",

1492 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1493 .
	gšfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
|

1494 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


1495 
SCST_TEST_IO_IN_SIRQ_ALLOWED
|

1497 
SCST_WRITE_EXCL_ALLOWED
,

1498 .
	gšfo_lba_off
 = 2, .
	gšfo_lba_Ën
 = 4,

1499 .
	gšfo_Ën_off
 = 6, .
	gšfo_Ën_Ën
 = 4,

1500 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_lba_4_Ën_4_rd´Ùeù
},

1501 {.
	gÝs
 = 0xA9, .
	gdevkey
 = " O ",

1502 .
	gšfo_Ý_Çme
 = "PLAY TRACK RELATIVE(12)",

1503 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1504 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1505 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1506 {.
	gÝs
 = 0xAA, .
	gdevkey
 = "O OO O ",

1507 .
	gšfo_Ý_Çme
 = "WRITE(12)",

1508 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1509 .
	gšfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
|

1510 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


1511 
SCST_TEST_IO_IN_SIRQ_ALLOWED
|

1513 
SCST_WRITE_MEDIUM
,

1514 .
	gšfo_lba_off
 = 2, .
	gšfo_lba_Ën
 = 4,

1515 .
	gšfo_Ën_off
 = 6, .
	gšfo_Ën_Ën
 = 4,

1516 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_lba_4_Ën_4_w½rÙeù
},

1517 {.
	gÝs
 = 0xAA, .
	gdevkey
 = " O ",

1518 .
	gšfo_Ý_Çme
 = "SEND MESSAGE(12)",

1519 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1520 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1521 .
	gšfo_Ën_off
 = 6, .
	gšfo_Ën_Ën
 = 4,

1522 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_4
},

1523 {.
	gÝs
 = 0xAC, .
	gdevkey
 = " O ",

1524 .
	gšfo_Ý_Çme
 = "ERASE(12)",

1525 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1526 .
	gšfo_Ý_æags
 = 
SCST_WRITE_MEDIUM
,

1527 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1528 {.
	gÝs
 = 0xAC, .
	gdevkey
 = " M ",

1529 .
	gšfo_Ý_Çme
 = "GET PERFORMANCE",

1530 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1531 .
	gšfo_Ý_æags
 = 
SCST_UNKNOWN_LENGTH
,

1532 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1533 {.
	gÝs
 = 0xAD, .
	gdevkey
 = " O ",

1534 .
	gšfo_Ý_Çme
 = "READ DVD STRUCTURE",

1535 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1536 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1537 .
	gšfo_Ën_off
 = 8, .
	gšfo_Ën_Ën
 = 2,

1538 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

1539 {.
	gÝs
 = 0xAE, .
	gdevkey
 = "O OO O ",

1540 .
	gšfo_Ý_Çme
 = "WRITE AND VERIFY(12)",

1541 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1542 .
	gšfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
|
SCST_WRITE_MEDIUM
,

1543 .
	gšfo_lba_off
 = 2, .
	gšfo_lba_Ën
 = 4,

1544 .
	gšfo_Ën_off
 = 6, .
	gšfo_Ën_Ën
 = 4,

1545 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_lba_4_Ën_4_w½rÙeù
},

1546 {.
	gÝs
 = 0xAF, .
	gdevkey
 = "O OO O ",

1547 .
	gšfo_Ý_Çme
 = "VERIFY(12)",

1548 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_UNKNOWN
,

1549 .
	gšfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
|
SCST_WRITE_EXCL_ALLOWED
,

1550 .
	gšfo_lba_off
 = 2, .
	gšfo_lba_Ën
 = 4,

1551 .
	gšfo_Ën_off
 = 6, .
	gšfo_Ën_Ën
 = 4,

1552 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_v”ify12
},

1553 {.
	gÝs
 = 0xB3, .
	gdevkey
 = " OO O ",

1554 .
	gšfo_Ý_Çme
 = "SET LIMITS(12)",

1555 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1556 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1557 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1558 {.
	gÝs
 = 0xB5, .
	gdevkey
 = "OO O ",

1559 .
	gšfo_Ý_Çme
 = "SECURITY PROTOCOL OUT",

1560 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1561 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1562 .
	gšfo_Ën_off
 = 6, .
	gšfo_Ën_Ën
 = 4,

1563 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_4
},

1564 {.
	gÝs
 = 0xB5, .
	gdevkey
 = " O ",

1565 .
	gšfo_Ý_Çme
 = "REQUEST VOLUME ELEMENT ADDRESS",

1566 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1567 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1568 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 3,

1569 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_3
},

1570 {.
	gÝs
 = 0xB6, .
	gdevkey
 = " O ",

1571 .
	gšfo_Ý_Çme
 = "SEND VOLUME TAG",

1572 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1573 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1574 .
	gšfo_Ën_off
 = 9, .
	gšfo_Ën_Ën
 = 1,

1575 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_1
},

1576 {.
	gÝs
 = 0xB6, .
	gdevkey
 = " M ",

1577 .
	gšfo_Ý_Çme
 = "SET STREAMING",

1578 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1579 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1580 .
	gšfo_Ën_off
 = 9, .
	gšfo_Ën_Ën
 = 2,

1581 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

1582 {.
	gÝs
 = 0xB7, .
	gdevkey
 = "O O ",

1583 .
	gšfo_Ý_Çme
 = "READ DEFECT DATA(12)",

1584 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1585 .
	gšfo_Ý_æags
 = 
SCST_WRITE_EXCL_ALLOWED
,

1586 .
	gšfo_Ën_off
 = 9, .
	gšfo_Ën_Ën
 = 1,

1587 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_1
},

1588 {.
	gÝs
 = 0xB8, .
	gdevkey
 = " O ",

1589 .
	gšfo_Ý_Çme
 = "READ ELEMENT STATUS",

1590 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1591 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1592 .
	gšfo_Ën_off
 = 7, .
	gšfo_Ën_Ën
 = 3,

1593 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_3_»ad_–em_¡©
},

1594 {.
	gÝs
 = 0xB9, .
	gdevkey
 = " O ",

1595 .
	gšfo_Ý_Çme
 = "READ CD MSF",

1596 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1597 .
	gšfo_Ý_æags
 = 
SCST_UNKNOWN_LENGTH
,

1598 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1599 {.
	gÝs
 = 0xBA, .
	gdevkey
 = " O ",

1600 .
	gšfo_Ý_Çme
 = "SCAN",

1601 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1602 .
	gšfo_Ý_æags
 = 
SCST_LONG_TIMEOUT
,

1603 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1604 {.
	gÝs
 = 0xBA, .
	gdevkey
 = " O ",

1605 .
	gšfo_Ý_Çme
 = "REDUNDANCY GROUP(IN)",

1606 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1607 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1608 .
	gšfo_Ën_off
 = 6, .
	gšfo_Ën_Ën
 = 4,

1609 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_4
},

1610 {.
	gÝs
 = 0xBB, .
	gdevkey
 = " O ",

1611 .
	gšfo_Ý_Çme
 = "SET SPEED",

1612 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1613 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1614 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_nÚe
},

1615 {.
	gÝs
 = 0xBB, .
	gdevkey
 = " O ",

1616 .
	gšfo_Ý_Çme
 = "REDUNDANCY GROUP(OUT)",

1617 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1618 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1619 .
	gšfo_Ën_off
 = 6, .
	gšfo_Ën_Ën
 = 4,

1620 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_4
},

1621 {.
	gÝs
 = 0xBC, .
	gdevkey
 = " O ",

1622 .
	gšfo_Ý_Çme
 = "SPARE(IN)",

1623 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1624 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1625 .
	gšfo_Ën_off
 = 6, .
	gšfo_Ën_Ën
 = 4,

1626 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_4
},

1627 {.
	gÝs
 = 0xBD, .
	gdevkey
 = " O ",

1628 .
	gšfo_Ý_Çme
 = "MECHANISM STATUS",

1629 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1630 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1631 .
	gšfo_Ën_off
 = 8, .
	gšfo_Ën_Ën
 = 2,

1632 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

1633 {.
	gÝs
 = 0xBD, .
	gdevkey
 = " O ",

1634 .
	gšfo_Ý_Çme
 = "SPARE(OUT)",

1635 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1636 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1637 .
	gšfo_Ën_off
 = 6, .
	gšfo_Ën_Ën
 = 4,

1638 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_4
},

1639 {.
	gÝs
 = 0xBE, .
	gdevkey
 = " O ",

1640 .
	gšfo_Ý_Çme
 = "READ CD",

1641 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1642 .
	gšfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
,

1643 .
	gšfo_Ën_off
 = 6, .
	gšfo_Ën_Ën
 = 3,

1644 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_3
},

1645 {.
	gÝs
 = 0xBE, .
	gdevkey
 = " O ",

1646 .
	gšfo_Ý_Çme
 = "VOLUME SET(IN)",

1647 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

1648 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1649 .
	gšfo_Ën_off
 = 6, .
	gšfo_Ën_Ën
 = 4,

1650 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_4
},

1651 {.
	gÝs
 = 0xBF, .
	gdevkey
 = " O ",

1652 .
	gšfo_Ý_Çme
 = "SEND DVD STRUCTUE",

1653 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1654 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1655 .
	gšfo_Ën_off
 = 8, .
	gšfo_Ën_Ën
 = 4,

1656 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_2
},

1657 {.
	gÝs
 = 0xBF, .
	gdevkey
 = " O ",

1658 .
	gšfo_Ý_Çme
 = "VOLUME SET(OUT)",

1659 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

1660 .
	gšfo_Ý_æags
 = 
FLAG_NONE
,

1661 .
	gšfo_Ën_off
 = 6, .
	gšfo_Ën_Ën
 = 4,

1662 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_4
},

1663 {.
	gÝs
 = 0xE7, .
	gdevkey
 = " V ",

1664 .
	gšfo_Ý_Çme
 = "INIT ELEMENT STATUS WRANGE",

1665 .
	gšfo_d©a_dœeùiÚ
 = 
SCST_DATA_NONE
,

1666 .
	gšfo_Ý_æags
 = 
SCST_LONG_TIMEOUT
,

1667 .
	gg‘_cdb_šfo
 = 
g‘_cdb_šfo_Ën_10
}

1670 
	#SCST_CDB_TBL_SIZE
 (()
	`ARRAY_SIZE
(
sc¡_scsi_Ý_bË
))

	)

1672 
sc¡_ä“_tgt_dev
(
sc¡_tgt_dev
 *
tgt_dev
);

1673 
sc¡_check_š‹º®_£n£
(
sc¡_deviû
 *
dev
, 
»suÉ
,

1674 
ušt8_t
 *
£n£
, 
£n£_Ën
);

1675 
sc¡_queue_»pÜt_luns_chªged_UA
(
sc¡_£ssiÚ
 *
£ss
,

1676 
æags
);

1677 
__sc¡_check_£t_UA
(
sc¡_tgt_dev
 *
tgt_dev
,

1678 cÚ¡ 
ušt8_t
 *
£n£
, 
£n£_Ën
, 
æags
);

1679 
sc¡_®loc_£t_UA
(
sc¡_tgt_dev
 *
tgt_dev
,

1680 cÚ¡ 
ušt8_t
 *
£n£
, 
£n£_Ën
, 
æags
);

1681 
sc¡_ä“_®l_UA
(
sc¡_tgt_dev
 *
tgt_dev
);

1682 
sc¡_»Ëa£_¥aû
(
sc¡_cmd
 *
cmd
);

1683 
sc¡_þ—r_»£rv©iÚ
(
sc¡_tgt_dev
 *
tgt_dev
);

1684 
sc¡_®loc_add_tgt_dev
(
sc¡_£ssiÚ
 *
£ss
,

1685 
sc¡_acg_dev
 *
acg_dev
, 
sc¡_tgt_dev
 **
out_tgt_dev
);

1686 
sc¡_tgt_»Œy_tim”_â
(
¬g
);

1688 #ifdeà
CONFIG_SCST_DEBUG_TM


1689 
tm_dbg_š™_tgt_dev
(
sc¡_tgt_dev
 *
tgt_dev
);

1690 
tm_dbg_deš™_tgt_dev
(
sc¡_tgt_dev
 *
tgt_dev
);

1692 
šlše
 
	$tm_dbg_š™_tgt_dev
(
sc¡_tgt_dev
 *
tgt_dev
è{
	}
}

1693 
šlše
 
	$tm_dbg_deš™_tgt_dev
(
sc¡_tgt_dev
 *
tgt_dev
è{
	}
}

1703 
	$sc¡_®loc_£n£
(
sc¡_cmd
 *
cmd
, 
©omic
)

1705 
»s
 = 0;

1706 
gå_t
 
gå_mask
 = 
©omic
 ? 
GFP_ATOMIC
 : (
cmd
->
cmd_gå_mask
|
__GFP_NOFAIL
);

1708 
	`TRACE_ENTRY
();

1710 ià(
cmd
->
£n£
 !ð
NULL
)

1711 
memz”o
;

1713 
cmd
->
£n£
 = 
	`mempoÞ_®loc
(
sc¡_£n£_mempoÞ
, 
gå_mask
);

1714 ià(
cmd
->
£n£
 =ð
NULL
) {

1715 
	`PRINT_CRIT_ERROR
("Sense memory‡llocation failed (op %s). "

1716 "Th£n£ d©¨wžÈblo¡!!", 
	`sc¡_g‘_Ýcode_Çme
(
cmd
));

1717 
»s
 = -
ENOMEM
;

1718 
out
;

1721 
cmd
->
£n£_buæ’
 = 
SCST_SENSE_BUFFERSIZE
;

1723 
memz”o
:

1724 
cmd
->
£n£_v®id_Ën
 = 0;

1725 
	`mem£t
(
cmd
->
£n£
, 0, cmd->
£n£_buæ’
);

1727 
out
:

1728 
	`TRACE_EXIT_RES
(
»s
);

1729  
»s
;

1730 
	}
}

1731 
EXPORT_SYMBOL
(
sc¡_®loc_£n£
);

1740 
	$sc¡_®loc_£t_£n£
(
sc¡_cmd
 *
cmd
, 
©omic
,

1741 cÚ¡ 
ušt8_t
 *
£n£
, 
Ën
)

1743 
»s
;

1745 
	`TRACE_ENTRY
();

1752 
»s
 = 
	`sc¡_®loc_£n£
(
cmd
, 
©omic
);

1753 ià(
»s
 != 0) {

1754 
	`PRINT_BUFFER
("Lo¡ s’£", 
£n£
, 
Ën
);

1755 
out
;

1758 
cmd
->
£n£_v®id_Ën
 = 
Ën
;

1759 ià(
cmd
->
£n£_buæ’
 < 
Ën
) {

1760 
	`PRINT_WARNING
("Senseruncated (needed %d), shall you increase "

1761 "SCST_SENSE_BUFFERSIZE? Op: %s", 
Ën
,

1762 
	`sc¡_g‘_Ýcode_Çme
(
cmd
));

1763 
cmd
->
£n£_v®id_Ën
 = cmd->
£n£_buæ’
;

1766 
	`memýy
(
cmd
->
£n£
, s’£, cmd->
£n£_v®id_Ën
);

1767 
	`TRACE_BUFFER
("S’£ s‘", 
cmd
->
£n£
, cmd->
£n£_v®id_Ën
);

1769 
out
:

1770 
	`TRACE_EXIT_RES
(
»s
);

1771  
»s
;

1772 
	}
}

1773 
EXPORT_SYMBOL
(
sc¡_®loc_£t_£n£
);

1784 
	$sc¡_£t_cmd_”rÜ_¡©us
(
sc¡_cmd
 *
cmd
, 
¡©us
)

1786 
»s
 = 0;

1788 
	`TRACE_ENTRY
();

1790 ià(
¡©us
 =ð
SAM_STAT_RESERVATION_CONFLICT
) {

1791 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
, "Reservation conflict (dev %s, "

1793 
cmd
->
dev
 ? cmd->dev->
vœt_Çme
 : 
NULL
,

1794 
cmd
->
£ss
->
š™ŸtÜ_Çme
, cmd->
tgt
->
»l_tgt_id
);

1797 ià(
cmd
->
¡©us
 != 0) {

1798 
	`TRACE_MGMT_DBG
("cmd %°®»ady ha ¡©u %x s‘", 
cmd
,

1799 
cmd
->
¡©us
);

1800 
»s
 = -
EEXIST
;

1801 
out
;

1804 
cmd
->
¡©us
 = status;

1805 
cmd
->
ho¡_¡©us
 = 
DID_OK
;

1807 
cmd
->
dbl_ua_Üig_»¥_d©a_Ën
 = cmd->
»¥_d©a_Ën
;

1808 
cmd
->
dbl_ua_Üig_d©a_dœeùiÚ
 = cmd->
d©a_dœeùiÚ
;

1810 
cmd
->
d©a_dœeùiÚ
 = 
SCST_DATA_NONE
;

1811 
cmd
->
»¥_d©a_Ën
 = 0;

1812 
cmd
->
»sid_possibË
 = 1;

1813 
cmd
->
is_£nd_¡©us
 = 1;

1815 
cmd
->
com¶‘ed
 = 1;

1817 
out
:

1818 
	`TRACE_EXIT_RES
(
»s
);

1819  
»s
;

1820 
	}
}

1821 
EXPORT_SYMBOL
(
sc¡_£t_cmd_”rÜ_¡©us
);

1823 
	$sc¡_£t_lun_nÙ_suµÜ‹d_»que¡_£n£
(
sc¡_cmd
 *
cmd
,

1824 
key
, 
asc
, 
ascq
)

1826 
»s
;

1827 
£n£_Ën
, 
Ën
;

1828 
sÿ‰”li¡
 *
sg
;

1830 
	`TRACE_ENTRY
();

1832 ià(
cmd
->
¡©us
 != 0) {

1833 
	`TRACE_MGMT_DBG
("cmd %°®»ady ha ¡©u %x s‘", 
cmd
,

1834 
cmd
->
¡©us
);

1835 
»s
 = -
EEXIST
;

1836 
out
;

1839 ià((
cmd
->
sg
 !ð
NULL
è&& 
	`sc¡_£n£_v®id
(
	`sg_vœt
(cmd->sg))) {

1840 
	`TRACE_MGMT_DBG
("cmd %°®»ady ha £n£ s‘", 
cmd
);

1841 
»s
 = -
EEXIST
;

1842 
out
;

1845 ià(
cmd
->
sg
 =ð
NULL
) {

1851 ià(
cmd
->
tgt_i_d©a_buf_®loûd
 && (cmd->
tgt_i_sg
 !ð
NULL
)) {

1852 
cmd
->
sg
 = cmd->
tgt_i_sg
;

1853 
cmd
->
sg_út
 = cmd->
tgt_i_sg_út
;

1854 
	`TRACE_MEM
("Tgˆsg u£d fÜ s’£ fÜ cmd %p", 
cmd
);

1855 
go
;

1858 ià(
cmd
->
bufæ’
 == 0)

1859 
cmd
->
bufæ’
 = cmd->
cdb
[4];

1861 
cmd
->
sg
 = 
	`sc¡_®loc_sg
(cmd->
bufæ’
, 
GFP_ATOMIC
, &cmd->
sg_út
);

1862 ià(
cmd
->
sg
 =ð
NULL
) {

1863 
	`PRINT_ERROR
("Unableo‡lloc sg for REQUEST SENSE"

1864 "(£n£ %x/%x/%x)", 
key
, 
asc
, 
ascq
);

1865 
»s
 = 1;

1866 
out
;

1869 
	`TRACE_MEM
("sg %p‡lloced for sense for cmd %p (cnt %d, "

1870 "ËÀ%d)", 
cmd
->
sg
, cmd, cmd->
sg_út
, cmd->
bufæ’
);

1873 
go
:

1874 
sg
 = 
cmd
->sg;

1875 
Ën
 = 
sg
->
Ëngth
;

1877 
	`TRACE_MEM
("sg %°Ö’ %dèfÜ s’£ fÜ cmd %p", 
sg
, 
Ën
, 
cmd
);

1879 
£n£_Ën
 = 
	`sc¡_£t_£n£
(
	`sg_vœt
(
sg
), 
Ën
, 
cmd
->
cdb
[1] & 1,

1880 
key
, 
asc
, 
ascq
);

1882 
	`TRACE_BUFFER
("S’£ s‘", 
	`sg_vœt
(
sg
), 
£n£_Ën
);

1884 
cmd
->
d©a_dœeùiÚ
 = 
SCST_DATA_READ
;

1885 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
£n£_Ën
);

1887 
»s
 = 0;

1888 
cmd
->
com¶‘ed
 = 1;

1889 
cmd
->
»sid_possibË
 = 1;

1891 
out
:

1892 
	`TRACE_EXIT_RES
(
»s
);

1893  
»s
;

1894 
	}
}

1896 
	$sc¡_£t_lun_nÙ_suµÜ‹d_šquœy
(
sc¡_cmd
 *
cmd
)

1898 
»s
;

1899 
ušt8_t
 *
buf
;

1900 
sÿ‰”li¡
 *
sg
;

1901 
Ën
;

1903 
	`TRACE_ENTRY
();

1905 ià(
cmd
->
¡©us
 != 0) {

1906 
	`TRACE_MGMT_DBG
("cmd %°®»ady ha ¡©u %x s‘", 
cmd
,

1907 
cmd
->
¡©us
);

1908 
»s
 = -
EEXIST
;

1909 
out
;

1912 ià(
cmd
->
sg
 =ð
NULL
) {

1913 ià(
cmd
->
bufæ’
 == 0)

1914 
cmd
->
bufæ’
 = 
	`mš_t
(, 36, 
	`g‘_uÇligÃd_be16
(&cmd->
cdb
[3]));

1921 ià(
cmd
->
tgt_i_d©a_buf_®loûd
 && (cmd->
tgt_i_sg
 !ð
NULL
)) {

1922 
cmd
->
sg
 = cmd->
tgt_i_sg
;

1923 
cmd
->
sg_út
 = cmd->
tgt_i_sg_út
;

1924 
	`TRACE_MEM
("Tgt used for INQUIRY for‚ot supported "

1925 "LUN fÜ cmd %p", 
cmd
);

1926 
go
;

1929 
cmd
->
sg
 = 
	`sc¡_®loc_sg
(cmd->
bufæ’
, 
GFP_ATOMIC
, &cmd->
sg_út
);

1930 ià(
cmd
->
sg
 =ð
NULL
) {

1931 
	`PRINT_ERROR
("%s", "Unableo‡lloc sg for INQUIRY "

1933 
»s
 = 1;

1934 
out
;

1937 
	`TRACE_MEM
("sg %p‡lloced for INQUIRY for‚ot supported LUN for "

1938 "cmd %°(úˆ%d,†’ %d)", 
cmd
->
sg
, cmd, cmd->
sg_út
,

1939 
cmd
->
bufæ’
);

1942 
go
:

1943 
sg
 = 
cmd
->sg;

1944 
Ën
 = 
sg
->
Ëngth
;

1946 
	`TRACE_MEM
("sg %°Ö’ %dèfÜ INQUIRY fÜ cmd %p", 
sg
, 
Ën
, 
cmd
);

1948 
buf
 = 
	`sg_vœt
(
sg
);

1949 
Ën
 = 
	`mš_t
(, 36,†en);

1951 
	`mem£t
(
buf
, 0, 
Ën
);

1952 
buf
[0] = 0x7F;

1953 
buf
[4] = 
Ën
 - 4;

1955 
	`TRACE_BUFFER
("INQUIRY fÜ‚Ù suµÜ‹d LUN s‘", 
buf
, 
Ën
);

1957 
cmd
->
d©a_dœeùiÚ
 = 
SCST_DATA_READ
;

1958 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
Ën
);

1960 
»s
 = 0;

1961 
cmd
->
com¶‘ed
 = 1;

1962 
cmd
->
»sid_possibË
 = 1;

1964 
out
:

1965 
	`TRACE_EXIT_RES
(
»s
);

1966  
»s
;

1967 
	}
}

1975 
	$sc¡_£t_cmd_”rÜ
(
sc¡_cmd
 *
cmd
, 
key
, 
asc
, 
ascq
)

1977 
»s
;

1979 
	`TRACE_ENTRY
();

1985 ià((
key
 =ð
ILLEGAL_REQUEST
è&& (
asc
 =ð0x25è&& (
ascq
 == 0)) {

1986 ià(
cmd
->
cdb
[0] =ð
REQUEST_SENSE
)

1987 
»s
 = 
	`sc¡_£t_lun_nÙ_suµÜ‹d_»que¡_£n£
(
cmd
,

1988 
key
, 
asc
, 
ascq
);

1989 ià(
cmd
->
cdb
[0] =ð
INQUIRY
)

1990 
»s
 = 
	`sc¡_£t_lun_nÙ_suµÜ‹d_šquœy
(
cmd
);

1992 
do_£n£
;

1994 ià(
»s
 > 0)

1995 
do_£n£
;

1997 
out
;

2000 
do_£n£
:

2001 
»s
 = 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_CHECK_CONDITION
);

2002 ià(
»s
 != 0)

2003 
out
;

2005 
»s
 = 
	`sc¡_®loc_£n£
(
cmd
, 1);

2006 ià(
»s
 != 0) {

2007 
	`PRINT_ERROR
("Lost sense data (key %x,‡sc %x,‡scq %x)",

2008 
key
, 
asc
, 
ascq
);

2009 
out
;

2012 
cmd
->
£n£_v®id_Ën
 = 
	`sc¡_£t_£n£
(cmd->
£n£
, cmd->
£n£_buæ’
,

2013 
	`sc¡_g‘_cmd_dev_d_£n£
(
cmd
), 
key
, 
asc
, 
ascq
);

2015 
out
:

2016 
	`TRACE_EXIT_RES
(
»s
);

2017  
»s
;

2018 
	}
}

2019 
EXPORT_SYMBOL
(
sc¡_£t_cmd_”rÜ
);

2021 
	$sc¡_£t_cmd_”rÜ_ªd_šf
(
sc¡_cmd
 *
cmd
, 
key
, 
asc
,

2022 
ascq
, 
ušt64_t
 
šfÜm©iÚ
)

2024 
»s
;

2026 
»s
 = 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
key
, 
asc
, 
ascq
);

2027 ià(
»s
)

2028 
out
;

2030 
cmd
->
£n£
[0] & 0x7f) {

2034 
ušt32_t
 
i
 = 
šfÜm©iÚ
;

2036 
cmd
->
£n£
[0] |= 0x80;

2037 
	`put_uÇligÃd_be32
(
i
, &
cmd
->
£n£
[3]);

2042 
cmd
->
£n£
[7] = 12;

2043 
cmd
->
£n£
[8 + 0] = 0;

2044 
cmd
->
£n£
[8 + 1] = 10;

2045 
cmd
->
£n£
[8 + 2] = 0x80;

2046 
	`put_uÇligÃd_be64
(
šfÜm©iÚ
, &
cmd
->
£n£
[8 + 4]);

2049 
	`sBUG
();

2052 
out
:

2053  
»s
;

2054 
	}
}

2055 
EXPORT_SYMBOL
(
sc¡_£t_cmd_”rÜ_ªd_šf
);

2057 
	$sc¡_fžl_f›ld_poš‹r_£n£
(
ušt8_t
 *
å_£n£
, 
f›ld_offs
,

2058 
b™_offs
, 
boÞ
 
cdb
)

2061 
å_£n£
[0] = 0x80;

2062 ià(
cdb
)

2063 
å_£n£
[0] |= 0x40;

2064 ià((
b™_offs
 & 
SCST_INVAL_FIELD_BIT_OFFS_VALID
) != 0)

2065 
å_£n£
[0] |ð(8 | (
b™_offs
 & 7));

2066 
	`put_uÇligÃd_be16
(
f›ld_offs
, &
å_£n£
[1]);

2068 
	}
}

2070 
	$sc¡_£t_šv®id_f›ld_š
(
sc¡_cmd
 *
cmd
, 
f›ld_offs
,

2071 
b™_offs
, 
boÞ
 
cdb
)

2073 
»s
, 
asc
 = 
cdb
 ? 0x24 : 0x26;

2074 
d_£n£
 = 
	`sc¡_g‘_cmd_dev_d_£n£
(
cmd
);

2076 
	`TRACE_ENTRY
();

2078 
	`TRACE_DBG
("cmd %p, cdb %d, bit_offs %d, field_offs %d (d_sense %d)",

2079 
cmd
, 
cdb
, 
b™_offs
, 
f›ld_offs
, 
d_£n£
);

2081 
»s
 = 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_CHECK_CONDITION
);

2082 ià(
»s
 != 0)

2083 
out
;

2085 
»s
 = 
	`sc¡_®loc_£n£
(
cmd
, 1);

2086 ià(
»s
 != 0) {

2087 
	`PRINT_ERROR
("Lo¡ % £n£ d©a", 
cdb
 ? "INVALID FIELD IN CDB" :

2089 
out
;

2092 
	`sBUG_ON
(
cmd
->
£n£_buæ’
 < 18);

2093 
	`BUILD_BUG_ON
(
SCST_SENSE_BUFFERSIZE
 < 18);

2095 ià(
d_£n£
) {

2097 
cmd
->
£n£
[0] = 0x72;

2098 
cmd
->
£n£
[1] = 
ILLEGAL_REQUEST
;

2099 
cmd
->
£n£
[2] = 
asc
;

2100 
cmd
->
£n£
[3] = 0;

2101 
cmd
->
£n£
[7] = 8;

2102 
cmd
->
£n£
[8] = 2;

2103 
cmd
->
£n£
[9] = 6;

2104 
	`sc¡_fžl_f›ld_poš‹r_£n£
(&
cmd
->
£n£
[12], 
f›ld_offs
,

2105 
b™_offs
, 
cdb
);

2106 
cmd
->
£n£_v®id_Ën
 = 16;

2109 
cmd
->
£n£
[0] = 0x70;

2110 
cmd
->
£n£
[2] = 
ILLEGAL_REQUEST
;

2111 
cmd
->
£n£
[7] = 0x0a;

2112 
cmd
->
£n£
[12] = 
asc
;

2113 
cmd
->
£n£
[13] = 0;

2114 
	`sc¡_fžl_f›ld_poš‹r_£n£
(&
cmd
->
£n£
[15], 
f›ld_offs
,

2115 
b™_offs
, 
cdb
);

2116 
cmd
->
£n£_v®id_Ën
 = 18;

2119 
	`TRACE_BUFFER
("S’£ s‘", 
cmd
->
£n£
, cmd->
£n£_v®id_Ën
);

2121 
out
:

2122 
	`TRACE_EXIT_RES
(
»s
);

2123  
»s
;

2124 
	}
}

2126 
	$sc¡_£t_šv®id_f›ld_š_cdb
(
sc¡_cmd
 *
cmd
, 
f›ld_offs
,

2127 
b™_offs
)

2129  
	`sc¡_£t_šv®id_f›ld_š
(
cmd
, 
f›ld_offs
, 
b™_offs
, 
Œue
);

2130 
	}
}

2131 
EXPORT_SYMBOL
(
sc¡_£t_šv®id_f›ld_š_cdb
);

2133 
	$sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
sc¡_cmd
 *
cmd
, 
f›ld_offs
,

2134 
b™_offs
)

2136  
	`sc¡_£t_šv®id_f›ld_š
(
cmd
, 
f›ld_offs
, 
b™_offs
, 
çl£
);

2137 
	}
}

2138 
EXPORT_SYMBOL
(
sc¡_£t_šv®id_f›ld_š_·rm_li¡
);

2146 
	$sc¡_£t_£n£
(
ušt8_t
 *
bufãr
, 
Ën
, 
boÞ
 
d_£n£
,

2147 
key
, 
asc
, 
ascq
)

2149 
»s
;

2151 
	`sBUG_ON
(
Ën
 == 0);

2153 
	`mem£t
(
bufãr
, 0, 
Ën
);

2161 ià((
key
 =ð
UNIT_ATTENTION
) &&

2162 ((
asc
 =ð0x29è|| (×sø=ð0x2Aè&& (
ascq
 == 1))))

2163 
d_£n£
 = 
çl£
;

2165 ià(
d_£n£
) {

2167 ià(
Ën
 < 8) {

2168 
	`PRINT_ERROR
("Length %d of sense bufferoo smallo "

2169 "f™ s’£ %x:%x:%x", 
Ën
, 
key
, 
asc
, 
ascq
);

2172 
bufãr
[0] = 0x72;

2173 ià(
Ën
 > 1)

2174 
bufãr
[1] = 
key
;

2175 ià(
Ën
 > 2)

2176 
bufãr
[2] = 
asc
;

2177 ià(
Ën
 > 3)

2178 
bufãr
[3] = 
ascq
;

2179 
»s
 = 8;

2182 ià(
Ën
 < 18) {

2183 
	`PRINT_ERROR
("Length %d of sense bufferoo smallo "

2184 "f™ s’£ %x:%x:%x", 
Ën
, 
key
, 
asc
, 
ascq
);

2187 
bufãr
[0] = 0x70;

2188 ià(
Ën
 > 2)

2189 
bufãr
[2] = 
key
;

2190 ià(
Ën
 > 7)

2191 
bufãr
[7] = 0x0a;

2192 ià(
Ën
 > 12)

2193 
bufãr
[12] = 
asc
;

2194 ià(
Ën
 > 13)

2195 
bufãr
[13] = 
ascq
;

2196 
»s
 = 18;

2199 
	`TRACE_BUFFER
("S’£ s‘", 
bufãr
, 
»s
);

2200  
»s
;

2201 
	}
}

2202 
EXPORT_SYMBOL
(
sc¡_£t_£n£
);

2211 
boÞ
 
	$sc¡_ª®yze_£n£
(cÚ¡ 
ušt8_t
 *
£n£
, 
Ën
, 
v®id_mask
,

2212 
key
, 
asc
, 
ascq
)

2214 
boÞ
 
»s
 = 
çl£
;

2217 ià((
	`sc¡_£n£_»¥Ú£_code
(
£n£
) == 0x70) ||

2218 (
	`sc¡_£n£_»¥Ú£_code
(
£n£
) == 0x71)) {

2222 ià(
v®id_mask
 & 
SCST_SENSE_KEY_VALID
) {

2223 ià(
Ën
 < 3)

2224 
out
;

2225 ià(
£n£
[2] !ð
key
)

2226 
out
;

2230 ià(
v®id_mask
 & 
SCST_SENSE_ASC_VALID
) {

2231 ià(
Ën
 < 13)

2232 
out
;

2233 ià(
£n£
[12] !ð
asc
)

2234 
out
;

2238 ià(
v®id_mask
 & 
SCST_SENSE_ASCQ_VALID
) {

2239 ià(
Ën
 < 14)

2240 
out
;

2241 ià(
£n£
[13] !ð
ascq
)

2242 
out
;

2244 } ià((
	`sc¡_£n£_»¥Ú£_code
(
£n£
) == 0x72) ||

2245 (
	`sc¡_£n£_»¥Ú£_code
(
£n£
) == 0x73)) {

2249 ià(
v®id_mask
 & 
SCST_SENSE_KEY_VALID
) {

2250 ià(
Ën
 < 2)

2251 
out
;

2252 ià(
£n£
[1] !ð
key
)

2253 
out
;

2257 ià(
v®id_mask
 & 
SCST_SENSE_ASC_VALID
) {

2258 ià(
Ën
 < 3)

2259 
out
;

2260 ià(
£n£
[2] !ð
asc
)

2261 
out
;

2265 ià(
v®id_mask
 & 
SCST_SENSE_ASCQ_VALID
) {

2266 ià(
Ën
 < 4)

2267 
out
;

2268 ià(
£n£
[3] !ð
ascq
)

2269 
out
;

2272 
	`PRINT_ERROR
("Unknown sense„esponse code 0x%x",

2273 
	`sc¡_£n£_»¥Ú£_code
(
£n£
));

2274 
out
;

2277 
»s
 = 
Œue
;

2279 
out
:

2280 
	`TRACE_EXIT_RES
(()
»s
);

2281  
»s
;

2282 
	}
}

2283 
EXPORT_SYMBOL
(
sc¡_ª®yze_£n£
);

2291 
boÞ
 
	$sc¡_is_ua_£n£
(cÚ¡ 
ušt8_t
 *
£n£
, 
Ën
)

2293 ià(
	`sc¡_£n£_v®id
(
£n£
))

2294  
	`sc¡_ª®yze_£n£
(
£n£
, 
Ën
,

2295 
SCST_SENSE_KEY_VALID
, 
UNIT_ATTENTION
, 0, 0);

2297  
çl£
;

2298 
	}
}

2299 
EXPORT_SYMBOL
(
sc¡_is_ua_£n£
);

2301 
boÞ
 
	$sc¡_is_ua_glob®
(cÚ¡ 
ušt8_t
 *
£n£
, 
Ën
)

2303 
boÞ
 
»s
;

2307 ià(
	`sc¡_ª®yze_£n£
(
£n£
, 
Ën
, 
SCST_SENSE_ALL_VALID
,

2308 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»pÜ‹d_luns_d©a_chªged
)))

2309 
»s
 = 
Œue
;

2311 
»s
 = 
çl£
;

2313  
»s
;

2314 
	}
}

2326 
	$sc¡_check_cÚv”t_£n£
(
sc¡_cmd
 *
cmd
)

2328 
boÞ
 
d_£n£
;

2330 
	`TRACE_ENTRY
();

2332 ià((
cmd
->
£n£
 =ð
NULL
è|| (cmd->
¡©us
 !ð
SAM_STAT_CHECK_CONDITION
))

2333 
out
;

2335 
d_£n£
 = 
	`sc¡_g‘_cmd_dev_d_£n£
(
cmd
);

2336 ià(
d_£n£
 && ((
	`sc¡_£n£_»¥Ú£_code
(
cmd
->
£n£
) == 0x70) ||

2337 (
	`sc¡_£n£_»¥Ú£_code
(
cmd
->
£n£
) == 0x71)) &&

2344 !((
cmd
->
£n£
[2] =ð
UNIT_ATTENTION
) &&

2345 ((
cmd
->
£n£
[12] == 0x29) ||

2346 ((
cmd
->
£n£
[12] == 0x2A) && (cmd->sense[13] == 1))))) {

2347 
	`TRACE_MGMT_DBG
("CÚv”tšg fixed s’£ØdesütÜ (cmd %p)", 
cmd
);

2348 ià((
cmd
->
£n£_v®id_Ën
 < 18)) {

2349 
	`PRINT_ERROR
("Senseoo smallo convert (%d, "

2350 "ty³: fixed)", 
cmd
->
£n£_buæ’
);

2351 
out
;

2353 
cmd
->
£n£_v®id_Ën
 = 
	`sc¡_£t_£n£
(cmd->
£n£
, cmd->
£n£_buæ’
,

2354 
d_£n£
, 
cmd
->
£n£
[2], cmd->sense[12], cmd->sense[13]);

2355 } ià(!
d_£n£
 && ((
	`sc¡_£n£_»¥Ú£_code
(
cmd
->
£n£
) == 0x72) ||

2356 (
	`sc¡_£n£_»¥Ú£_code
(
cmd
->
£n£
) == 0x73))) {

2357 
	`TRACE_MGMT_DBG
("Converting descriptor senseo fixed (cmd %p)",

2358 
cmd
);

2359 ià((
cmd
->
£n£_buæ’
 < 18è|| (cmd->
£n£_v®id_Ën
 < 8)) {

2360 
	`PRINT_ERROR
("Senseoo smallo convert (%d, "

2362 
cmd
->
£n£_buæ’
, cmd->
£n£_v®id_Ën
);

2363 
out
;

2365 
cmd
->
£n£_v®id_Ën
 = 
	`sc¡_£t_£n£
(cmd->
£n£
,

2366 
cmd
->
£n£_buæ’
, 
d_£n£
,

2367 
cmd
->
£n£
[1], cmd->sense[2], cmd->sense[3]);

2370 
out
:

2371 
	`TRACE_EXIT
();

2373 
	}
}

2374 
EXPORT_SYMBOL
(
sc¡_check_cÚv”t_£n£
);

2376 
	$sc¡_£t_cmd_”rÜ_£n£
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
£n£
,

2377 
Ën
)

2379 
»s
;

2381 
	`TRACE_ENTRY
();

2383 
»s
 = 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_CHECK_CONDITION
);

2384 ià(
»s
 != 0)

2385 
out
;

2387 
»s
 = 
	`sc¡_®loc_£t_£n£
(
cmd
, 1, 
£n£
, 
Ën
);

2389 
out
:

2390 
	`TRACE_EXIT_RES
(
»s
);

2391  
»s
;

2392 
	}
}

2400 
	$sc¡_£t_busy
(
sc¡_cmd
 *
cmd
)

2402 
c
 = 
	`©omic_»ad
(&
cmd
->
£ss
->
£ss_cmd_couÁ
);

2404 
	`TRACE_ENTRY
();

2406 ià((
c
 <ð1è|| (
cmd
->
£ss
->
š™_pha£
 !ð
SCST_SESS_IPH_READY
)) {

2407 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_BUSY
);

2408 
	`TRACE
(
TRACE_FLOW_CONTROL
, "Sending BUSY statuso initiator %s "

2410 
cmd
->
£ss
->
š™ŸtÜ_Çme
, 
c
,

2411 
cmd
->
queue_ty³
, cmd->
£ss
->
š™_pha£
);

2413 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_TASK_SET_FULL
);

2414 
	`TRACE
(
TRACE_FLOW_CONTROL
, "Sending QUEUE_FULL statuso "

2416 "£ss->š™_pha£ %d)", 
cmd
->
£ss
->
š™ŸtÜ_Çme
, 
c
,

2417 
cmd
->
queue_ty³
, cmd->
£ss
->
š™_pha£
);

2420 
	`TRACE_EXIT
();

2422 
	}
}

2423 
EXPORT_SYMBOL
(
sc¡_£t_busy
);

2431 
	$sc¡_£t_š™Ÿl_UA
(
sc¡_£ssiÚ
 *
£ss
, 
key
, 
asc
, 
ascq
)

2433 
i
;

2435 
	`TRACE_ENTRY
();

2437 
	`TRACE_MGMT_DBG
("S‘tšg fÜ ses %°š™ŸÈUA %x/%x/%x", 
£ss
, 
key
,

2438 
asc
, 
ascq
);

2441 
	`mu‹x_lock
(&
sc¡_mu‹x
);

2443 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

2444 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

2445 
sc¡_tgt_dev
 *
tgt_dev
;

2447 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
, 
£ss_tgt_dev_li¡_’Œy
) {

2448 
	`¥š_lock_bh
(&
tgt_dev
->
tgt_dev_lock
);

2449 ià(!
	`li¡_em±y
(&
tgt_dev
->
UA_li¡
)) {

2450 
sc¡_tgt_dev_UA
 *
ua
;

2452 
ua
 = 
	`li¡_fœ¡_’Œy
(&
tgt_dev
->
UA_li¡
,

2453 
	`ty³of
(*
ua
), 
UA_li¡_’Œy
);

2454 ià(
	`sc¡_ª®yze_£n£
(
ua
->
UA_£n£_bufãr
,

2455 
ua
->
UA_v®id_£n£_Ën
,

2456 
SCST_SENSE_ALL_VALID
,

2457 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»£t_UA
))) {

2458 
ua
->
UA_v®id_£n£_Ën
 = 
	`sc¡_£t_£n£
(

2459 
ua
->
UA_£n£_bufãr
,

2460 (
ua
->
UA_£n£_bufãr
),

2461 
tgt_dev
->
dev
->
d_£n£
,

2462 
key
, 
asc
, 
ascq
);

2464 
	`PRINT_ERROR
("%s",

2467 
	`PRINT_ERROR
("%s", "There's‚o RESET UAo "

2469 
	`¥š_uÆock_bh
(&
tgt_dev
->
tgt_dev_lock
);

2473 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

2475 
	`TRACE_EXIT
();

2477 
	}
}

2478 
EXPORT_SYMBOL
(
sc¡_£t_š™Ÿl_UA
);

2480 
sc¡_«n
 *
	$sc¡_®loc_«n
(
sc¡_£ssiÚ
 *
£ss
,

2481 
ušt64_t
 
uÅacked_lun
)

2483 
sc¡_«n
 *
«n
;

2485 
	`TRACE_ENTRY
();

2487 
«n
 = 
	`mempoÞ_®loc
(
sc¡_«n_mempoÞ
, 
GFP_KERNEL
);

2488 ià(
«n
 =ð
NULL
) {

2489 
	`PRINT_ERROR
("AEN memory‡llocation failed. Corresponding "

2491 "%s)", 
£ss
->
š™ŸtÜ_Çme
);

2492 
out
;

2494 
	`mem£t
(
«n
, 0, (*aen));

2496 
«n
->
£ss
 = sess;

2497 
	`sc¡_£ss_g‘
(
£ss
);

2499 
«n
->
lun
 = 
	`sc¡_·ck_lun
(
uÅacked_lun
, 
£ss
->
acg
->
addr_m‘hod
);

2501 
out
:

2502 
	`TRACE_EXIT_HRES
(()
«n
);

2503  
«n
;

2504 
	}
}

2506 
	$sc¡_ä“_«n
(
sc¡_«n
 *
«n
)

2508 
	`TRACE_ENTRY
();

2510 
	`sc¡_£ss_put
(
«n
->
£ss
);

2511 
	`mempoÞ_ä“
(
«n
, 
sc¡_«n_mempoÞ
);

2513 
	`TRACE_EXIT
();

2515 
	}
}

2518 
	$sc¡_g’_«n_Ü_ua
(
sc¡_tgt_dev
 *
tgt_dev
,

2519 
key
, 
asc
, 
ascq
)

2521 
sc¡_£ssiÚ
 *
£ss
 = 
tgt_dev
->sess;

2522 
sc¡_tgt_‹m¶©e
 *
tg‰
 = 
£ss
->
tgt
->tgtt;

2523 
ušt8_t
 
£n£_bufãr
[
SCST_STANDARD_SENSE_LEN
];

2524 
¦
;

2526 
	`TRACE_ENTRY
();

2528 ià(
£ss
->
š™_pha£
 !ð
SCST_SESS_IPH_READY
 ||

2529 
£ss
->
shut_pha£
 !ð
SCST_SESS_SPH_READY
)

2530 
out
;

2532 ià(
tg‰
->
»pÜt_«n
 !ð
NULL
) {

2533 
sc¡_«n
 *
«n
;

2534 
rc
;

2536 
«n
 = 
	`sc¡_®loc_«n
(
£ss
, 
tgt_dev
->
lun
);

2537 ià(
«n
 =ð
NULL
)

2538 
queue_ua
;

2540 
«n
->
ev’t_â
 = 
SCST_AEN_SCSI
;

2541 
«n
->
«n_£n£_Ën
 = 
	`sc¡_£t_£n£
×’->
«n_£n£
,

2542 (
«n
->
«n_£n£
), 
tgt_dev
->
dev
->
d_£n£
,

2543 
key
, 
asc
, 
ascq
);

2545 
	`TRACE_DBG
("Callingarget's %s„eport_aen(%p)",

2546 
tg‰
->
Çme
, 
«n
);

2547 
rc
 = 
tg‰
->
	`»pÜt_«n
(
«n
);

2548 
	`TRACE_DBG
("Target's %s„eport_aen(%p)„eturned %d",

2549 
tg‰
->
Çme
, 
«n
, 
rc
);

2550 ià(
rc
 =ð
SCST_AEN_RES_SUCCESS
)

2551 
out
;

2553 
	`sc¡_ä“_«n
(
«n
);

2556 
queue_ua
:

2557 
	`TRACE_MGMT_DBG
("AEN‚ot supported, queueing…lain UA (tgt_dev %p)",

2558 
tgt_dev
);

2559 
¦
 = 
	`sc¡_£t_£n£
(
£n£_bufãr
, (sense_buffer),

2560 
tgt_dev
->
dev
->
d_£n£
, 
key
, 
asc
, 
ascq
);

2561 
	`sc¡_check_£t_UA
(
tgt_dev
, 
£n£_bufãr
, 
¦
, 0);

2563 
out
:

2564 
	`TRACE_EXIT
();

2566 
	}
}

2573 
	$sc¡_ÿ·c™y_d©a_chªged
(
sc¡_deviû
 *
dev
)

2575 
sc¡_tgt_dev
 *
tgt_dev
;

2577 
	`TRACE_ENTRY
();

2579 ià(
dev
->
ty³
 !ð
TYPE_DISK
) {

2580 
	`TRACE_MGMT_DBG
("Deviceype %d isn't for CAPACITY DATA "

2581 "CHANGED UA", 
dev
->
ty³
);

2582 
out
;

2585 
	`TRACE_MGMT_DBG
("CAPACITY DATA CHANGED (dev %p)", 
dev
);

2587 
	`mu‹x_lock
(&
sc¡_mu‹x
);

2589 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

2590 
dev_tgt_dev_li¡_’Œy
) {

2591 
	`sc¡_g’_«n_Ü_ua
(
tgt_dev
,

2592 
	`SCST_LOAD_SENSE
(
sc¡_£n£_ÿ·c™y_d©a_chªged
));

2595 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

2597 
out
:

2598 
	`TRACE_EXIT
();

2600 
	}
}

2601 
EXPORT_SYMBOL_GPL
(
sc¡_ÿ·c™y_d©a_chªged
);

2603 
šlše
 
boÞ
 
	$sc¡_is_»pÜt_luns_chªged_ty³
(
ty³
)

2605 
ty³
) {

2606 
TYPE_DISK
:

2607 
TYPE_TAPE
:

2608 
TYPE_PRINTER
:

2609 
TYPE_PROCESSOR
:

2610 
TYPE_WORM
:

2611 
TYPE_ROM
:

2612 
TYPE_SCANNER
:

2613 
TYPE_MOD
:

2614 
TYPE_MEDIUM_CHANGER
:

2615 
TYPE_RAID
:

2616 
TYPE_ENCLOSURE
:

2617  
Œue
;

2619  
çl£
;

2621 
	}
}

2624 
	$sc¡_queue_»pÜt_luns_chªged_UA
(
sc¡_£ssiÚ
 *
£ss
,

2625 
æags
)

2627 
ušt8_t
 
£n£_bufãr
[
SCST_STANDARD_SENSE_LEN
];

2628 
li¡_h—d
 *
h—d
;

2629 
sc¡_tgt_dev
 *
tgt_dev
;

2630 
i
;

2632 
	`TRACE_ENTRY
();

2634 
	`TRACE_MGMT_DBG
("Queueing REPORTED LUNS DATA CHANGED UA "

2635 "(£s %p)", 
£ss
);

2637 
	`loÿl_bh_di§bË
();

2639 #ià!
	`defšed
(
__CHECKER__
)

2640 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

2641 
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

2643 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
,

2644 
£ss_tgt_dev_li¡_’Œy
) {

2646 
	`¥š_lock
(&
tgt_dev
->
tgt_dev_lock
);

2651 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

2652 
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

2654 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
, 
£ss_tgt_dev_li¡_’Œy
) {

2655 
¦
;

2657 ià(!
	`sc¡_is_»pÜt_luns_chªged_ty³
(

2658 
tgt_dev
->
dev
->
ty³
))

2661 
¦
 = 
	`sc¡_£t_£n£
(
£n£_bufãr
, (sense_buffer),

2662 
tgt_dev
->
dev
->
d_£n£
,

2663 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»pÜ‹d_luns_d©a_chªged
));

2665 
	`__sc¡_check_£t_UA
(
tgt_dev
, 
£n£_bufãr
,

2666 
¦
, 
æags
 | 
SCST_SET_UA_FLAG_GLOBAL
);

2670 #ià!
	`defšed
(
__CHECKER__
)

2671 
i
 = 
SESS_TGT_DEV_LIST_HASH_SIZE
-1; i >= 0; i--) {

2672 
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

2674 
	`li¡_fÜ_—ch_’Œy_»v”£
(
tgt_dev
, 
h—d
,

2675 
£ss_tgt_dev_li¡_’Œy
) {

2676 
	`¥š_uÆock
(&
tgt_dev
->
tgt_dev_lock
);

2681 
	`loÿl_bh_’abË
();

2683 
	`TRACE_EXIT
();

2685 
	}
}

2688 
	$sc¡_»pÜt_luns_chªged_£ss
(
sc¡_£ssiÚ
 *
£ss
)

2690 
i
;

2691 
sc¡_tgt_‹m¶©e
 *
tg‰
 = 
£ss
->
tgt
->tgtt;

2692 
d_£n£
 = 0;

2693 
ušt64_t
 
lun
 = 0;

2695 
	`TRACE_ENTRY
();

2697 ià((
£ss
->
š™_pha£
 !ð
SCST_SESS_IPH_READY
) ||

2698 (
£ss
->
shut_pha£
 !ð
SCST_SESS_SPH_READY
))

2699 
out
;

2701 
	`TRACE_DBG
("REPORTED LUNS DATA CHANGED (£s %p)", 
£ss
);

2703 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

2704 
li¡_h—d
 *
h—d
;

2705 
sc¡_tgt_dev
 *
tgt_dev
;

2707 
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

2709 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
,

2710 
£ss_tgt_dev_li¡_’Œy
) {

2711 ià(
	`sc¡_is_»pÜt_luns_chªged_ty³
(

2712 
tgt_dev
->
dev
->
ty³
)) {

2713 
lun
 = 
tgt_dev
->lun;

2714 
d_£n£
 = 
tgt_dev
->
dev
->d_sense;

2715 
found
;

2720 
found
:

2721 ià(
tg‰
->
»pÜt_«n
 !ð
NULL
) {

2722 
sc¡_«n
 *
«n
;

2723 
rc
;

2725 
«n
 = 
	`sc¡_®loc_«n
(
£ss
, 
lun
);

2726 ià(
«n
 =ð
NULL
)

2727 
queue_ua
;

2729 
«n
->
ev’t_â
 = 
SCST_AEN_SCSI
;

2730 
«n
->
«n_£n£_Ën
 = 
	`sc¡_£t_£n£
×’->
«n_£n£
,

2731 (
«n
->
«n_£n£
), 
d_£n£
,

2732 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»pÜ‹d_luns_d©a_chªged
));

2734 
	`TRACE_DBG
("Callingarget's %s„eport_aen(%p)",

2735 
tg‰
->
Çme
, 
«n
);

2736 
rc
 = 
tg‰
->
	`»pÜt_«n
(
«n
);

2737 
	`TRACE_DBG
("Target's %s„eport_aen(%p)„eturned %d",

2738 
tg‰
->
Çme
, 
«n
, 
rc
);

2739 ià(
rc
 =ð
SCST_AEN_RES_SUCCESS
)

2740 
out
;

2742 
	`sc¡_ä“_«n
(
«n
);

2745 
queue_ua
:

2746 
	`sc¡_queue_»pÜt_luns_chªged_UA
(
£ss
, 0);

2748 
out
:

2749 
	`TRACE_EXIT
();

2751 
	}
}

2754 
	$sc¡_»pÜt_luns_chªged
(
sc¡_acg
 *
acg
)

2756 
sc¡_£ssiÚ
 *
£ss
;

2758 
	`TRACE_ENTRY
();

2760 
	`TRACE_DBG
("REPORTED LUNS DATA CHANGED (acg %s)", 
acg
->
acg_Çme
);

2762 
	`li¡_fÜ_—ch_’Œy
(
£ss
, &
acg
->
acg_£ss_li¡
, 
acg_£ss_li¡_’Œy
) {

2763 
	`sc¡_»pÜt_luns_chªged_£ss
(
£ss
);

2766 
	`TRACE_EXIT
();

2768 
	}
}

2778 
	$sc¡_«n_dÚe
(
sc¡_«n
 *
«n
)

2780 
	`TRACE_ENTRY
();

2782 
	`TRACE_MGMT_DBG
("AEN %°(â %dèdÚ(š™ŸtÜ %s)", 
«n
,

2783 
«n
->
ev’t_â
,‡’->
£ss
->
š™ŸtÜ_Çme
);

2785 ià(
«n
->
d–iv”y_¡©us
 =ð
SCST_AEN_RES_SUCCESS
)

2786 
out_ä“
;

2788 ià(
«n
->
ev’t_â
 !ð
SCST_AEN_SCSI
)

2789 
out_ä“
;

2791 
	`TRACE_MGMT_DBG
("Delivery of SCSI AEN failed (initiator %s)",

2792 
«n
->
£ss
->
š™ŸtÜ_Çme
);

2794 ià(
	`sc¡_ª®yze_£n£
(
«n
->
«n_£n£
,‡’->
«n_£n£_Ën
,

2795 
SCST_SENSE_ALL_VALID
, 
	`SCST_LOAD_SENSE
(

2796 
sc¡_£n£_»pÜ‹d_luns_d©a_chªged
))) {

2797 
	`mu‹x_lock
(&
sc¡_mu‹x
);

2798 
	`sc¡_queue_»pÜt_luns_chªged_UA
(
«n
->
£ss
,

2799 
SCST_SET_UA_FLAG_AT_HEAD
);

2800 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

2802 
sc¡_£ssiÚ
 *
£ss
 = 
«n
->sess;

2803 
sc¡_tgt_dev
 *
tgt_dev
;

2804 
ušt64_t
 
lun
;

2806 
lun
 = 
	`sc¡_uÅack_lun
((
ušt8_t
 *)&
«n
->lun, (aen->lun));

2808 
	`mu‹x_lock
(&
sc¡_mu‹x
);

2811 
tgt_dev
 = 
	`sc¡_lookup_tgt_dev
(
£ss
, 
lun
);

2812 ià(
tgt_dev
) {

2813 
	`TRACE_MGMT_DBG
("Requeuing failed AEN UA forgt_dev %p",

2814 
tgt_dev
);

2815 
	`sc¡_check_£t_UA
(
tgt_dev
, 
«n
->
«n_£n£
,

2816 
«n
->
«n_£n£_Ën
,

2817 
SCST_SET_UA_FLAG_AT_HEAD
);

2820 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

2823 
out_ä“
:

2824 
	`sc¡_ä“_«n
(
«n
);

2826 
	`TRACE_EXIT
();

2828 
	}
}

2829 
EXPORT_SYMBOL
(
sc¡_«n_dÚe
);

2831 
	$sc¡_»queue_ua
(
sc¡_cmd
 *
cmd
, cÚ¡ 
ušt8_t
 *
buf
, 
size
)

2833 
	`TRACE_ENTRY
();

2835 ià(
buf
 =ð
NULL
) {

2836 
buf
 = 
cmd
->
£n£
;

2837 
size
 = 
cmd
->
£n£_v®id_Ën
;

2840 ià(
	`sc¡_ª®yze_£n£
(
buf
, 
size
, 
SCST_SENSE_ALL_VALID
,

2841 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»pÜ‹d_luns_d©a_chªged
))) {

2842 
	`TRACE_MGMT_DBG
("Requeuing REPORTED LUNS DATA CHANGED UA "

2843 "fÜ d–iv”y fažed cmd %p", 
cmd
);

2844 
	`mu‹x_lock
(&
sc¡_mu‹x
);

2845 
	`sc¡_queue_»pÜt_luns_chªged_UA
(
cmd
->
£ss
,

2846 
SCST_SET_UA_FLAG_AT_HEAD
);

2847 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

2849 
	`TRACE_MGMT_DBG
("Requeušg UA fÜ d–iv”y fažed cmd %p", 
cmd
);

2850 
	`sc¡_check_£t_UA
(
cmd
->
tgt_dev
, 
buf
, 
size
, 
SCST_SET_UA_FLAG_AT_HEAD
);

2853 
	`TRACE_EXIT
();

2855 
	}
}

2858 
	$sc¡_check_»assign_£ss
(
sc¡_£ssiÚ
 *
£ss
)

2860 
sc¡_acg
 *
acg
, *
Þd_acg
;

2861 
sc¡_acg_dev
 *
acg_dev
;

2862 
i
, 
rc
;

2863 
li¡_h—d
 *
h—d
;

2864 
sc¡_tgt_dev
 *
tgt_dev
;

2865 
boÞ
 
luns_chªged
 = 
çl£
;

2866 
boÞ
 
add_çžed
, 
som‘hšg_ä“d
;

2868 
	`TRACE_ENTRY
();

2870 ià(
£ss
->
shut_pha£
 !ð
SCST_SESS_SPH_READY
)

2871 
out
;

2873 
	`TRACE_DBG
("Checking„eassignment for sess %p (initiator %s)",

2874 
£ss
, sess->
š™ŸtÜ_Çme
);

2876 
acg
 = 
	`sc¡_fšd_acg
(
£ss
);

2877 ià(
acg
 =ð
£ss
->acg) {

2878 
	`TRACE_DBG
("NØ»assignm’ˆfÜ ses %p", 
£ss
);

2879 
out
;

2882 
	`PRINT_INFO
("sess %p (initiator %s) will be„eassigned from‡cg %so "

2883 "acg %s", 
£ss
, sess->
š™ŸtÜ_Çme
, sess->
acg
->
acg_Çme
,

2884 
acg
->
acg_Çme
);

2886 
Þd_acg
 = 
£ss
->
acg
;

2887 
£ss
->
acg
 = 
NULL
;

2889 
»Œy_add
:

2890 
add_çžed
 = 
çl£
;

2891 
	`li¡_fÜ_—ch_’Œy
(
acg_dev
, &
acg
->
acg_dev_li¡
, 
acg_dev_li¡_’Œy
) {

2892 
boÞ
 
šq_chªged_ua_Ãeded
 = 
çl£
;

2894 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

2895 
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

2897 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
,

2898 
£ss_tgt_dev_li¡_’Œy
) {

2899 ià((
tgt_dev
->
dev
 =ð
acg_dev
->dev) &&

2900 (
tgt_dev
->
lun
 =ð
acg_dev
->lun) &&

2901 (
tgt_dev
->
acg_dev
->
acg_dev_rd_Úly
 ==‡cg_dev->acg_dev_rd_only)) {

2902 
	`TRACE_MGMT_DBG
("sess %p:gt_dev %p for "

2904 
£ss
, 
tgt_dev
,

2905 ()
tgt_dev
->
lun
);

2906 
tgt_dev
->
acg_dev
 =‡cg_dev;

2907 
Ãxt
;

2908 } ià(
tgt_dev
->
lun
 =ð
acg_dev
->lun) {

2909 
	`TRACE_MGMT_DBG
("Replacing LUN %lld",

2910 ()
tgt_dev
->
lun
);

2911 
	`sc¡_ä“_tgt_dev
(
tgt_dev
);

2912 
šq_chªged_ua_Ãeded
 = 1;

2918 
luns_chªged
 = 
Œue
;

2920 
	`TRACE_MGMT_DBG
("sess %p: Allocing‚ewgt_dev for LUN %lld",

2921 
£ss
, ()
acg_dev
->
lun
);

2923 
rc
 = 
	`sc¡_®loc_add_tgt_dev
(
£ss
, 
acg_dev
, &
tgt_dev
);

2924 ià(
rc
 =ð-
EPERM
)

2926 ià(
rc
 != 0) {

2927 
add_çžed
 = 
Œue
;

2931 
tgt_dev
->
šq_chªged_ua_Ãeded
 = inq_changed_ua_needed;

2932 
Ãxt
:

2936 
som‘hšg_ä“d
 = 
çl£
;

2937 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

2938 
sc¡_tgt_dev
 *
t
;

2940 
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

2942 
	`li¡_fÜ_—ch_’Œy_§ã
(
tgt_dev
, 
t
, 
h—d
,

2943 
£ss_tgt_dev_li¡_’Œy
) {

2944 ià(
tgt_dev
->
acg_dev
->
acg
 !=‡cg) {

2945 
	`TRACE_MGMT_DBG
("sess %p: Deleting‚ot used "

2947 
£ss
, 
tgt_dev
,

2948 ()
tgt_dev
->
lun
);

2949 
luns_chªged
 = 
Œue
;

2950 
som‘hšg_ä“d
 = 
Œue
;

2951 
	`sc¡_ä“_tgt_dev
(
tgt_dev
);

2956 ià(
add_çžed
 && 
som‘hšg_ä“d
) {

2957 
	`TRACE_MGMT_DBG
("£s %p: R‘ryšg‡ddšg‚ewgt_devs", 
£ss
);

2958 
»Œy_add
;

2961 
£ss
->
acg
 =‡cg;

2963 
	`TRACE_DBG
("Movšg ses %°äom‡cg % tØacg %s", 
£ss
,

2964 
Þd_acg
->
acg_Çme
, 
acg
->acg_name);

2965 
	`li¡_move_ž
(&
£ss
->
acg_£ss_li¡_’Œy
, &
acg
->
acg_£ss_li¡
);

2966 
	`sc¡_g‘_acg
(
acg
);

2967 
	`sc¡_put_acg
(
Þd_acg
);

2969 #iâdeà
CONFIG_SCST_PROC


2970 
	`sc¡_»ü—‹_£ss_luns_lšk
(
£ss
);

2974 ià(
luns_chªged
) {

2975 
	`sc¡_»pÜt_luns_chªged_£ss
(
£ss
);

2977 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

2978 
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

2980 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
,

2981 
£ss_tgt_dev_li¡_’Œy
) {

2982 ià(
tgt_dev
->
šq_chªged_ua_Ãeded
) {

2983 
	`TRACE_MGMT_DBG
("sess %p: Setting "

2985 "Ñgt_dev %p)", 
£ss
, 
tgt_dev
);

2987 
tgt_dev
->
šq_chªged_ua_Ãeded
 = 0;

2989 
	`sc¡_g’_«n_Ü_ua
(
tgt_dev
,

2990 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šquœy_d©a_chªged
));

2996 
out
:

2997 
	`TRACE_EXIT
();

2999 
	}
}

3002 
	$sc¡_check_»assign_£ssiÚs
()

3004 
sc¡_tgt_‹m¶©e
 *
tg‰
;

3006 
	`TRACE_ENTRY
();

3008 
	`li¡_fÜ_—ch_’Œy
(
tg‰
, &
sc¡_‹m¶©e_li¡
, 
sc¡_‹m¶©e_li¡_’Œy
) {

3009 
sc¡_tgt
 *
tgt
;

3011 
	`li¡_fÜ_—ch_’Œy
(
tgt
, &
tg‰
->
tgt_li¡
, 
tgt_li¡_’Œy
) {

3012 
sc¡_£ssiÚ
 *
£ss
;

3014 
	`li¡_fÜ_—ch_’Œy
(
£ss
, &
tgt
->
£ss_li¡
,

3015 
£ss_li¡_’Œy
) {

3016 
	`sc¡_check_»assign_£ss
(
£ss
);

3021 
	`TRACE_EXIT
();

3023 
	}
}

3025 
	$sc¡_g‘_cmd_abnÜm®_dÚe_¡©e
(
sc¡_cmd
 *
cmd
)

3027 
»s
;

3028 
boÞ
 
Œaû
 = 
çl£
;

3030 
	`TRACE_ENTRY
();

3032 
cmd
->
¡©e
) {

3033 
SCST_CMD_STATE_INIT_WAIT
:

3034 
SCST_CMD_STATE_INIT
:

3035 
SCST_CMD_STATE_PARSE
:

3036 ià(
cmd
->
´•roûssšg_Úly
) {

3037 
»s
 = 
SCST_CMD_STATE_PREPROCESSING_DONE
;

3040 
Œaû
 = 
Œue
;

3042 
SCST_CMD_STATE_DEV_DONE
:

3043 ià(
cmd
->
š‹º®
)

3044 
»s
 = 
SCST_CMD_STATE_FINISHED_INTERNAL
;

3046 
»s
 = 
SCST_CMD_STATE_PRE_XMIT_RESP1
;

3049 
SCST_CMD_STATE_PRE_DEV_DONE
:

3050 
SCST_CMD_STATE_MODE_SELECT_CHECKS
:

3051 
»s
 = 
SCST_CMD_STATE_DEV_DONE
;

3054 
SCST_CMD_STATE_PRE_XMIT_RESP1
:

3055 
»s
 = 
SCST_CMD_STATE_PRE_XMIT_RESP2
;

3058 
SCST_CMD_STATE_PRE_XMIT_RESP2
:

3059 
»s
 = 
SCST_CMD_STATE_XMIT_RESP
;

3062 
SCST_CMD_STATE_PREPROCESSING_DONE
:

3063 
SCST_CMD_STATE_PREPROCESSING_DONE_CALLED
:

3064 ià(
cmd
->
tgt_dev
 =ð
NULL
) {

3065 
Œaû
 = 
Œue
;

3066 
»s
 = 
SCST_CMD_STATE_PRE_XMIT_RESP1
;

3068 
»s
 = 
SCST_CMD_STATE_PRE_DEV_DONE
;

3071 
SCST_CMD_STATE_PREPARE_SPACE
:

3072 ià(
cmd
->
´•roûssšg_Úly
) {

3073 
»s
 = 
SCST_CMD_STATE_PREPROCESSING_DONE
;

3076 
SCST_CMD_STATE_RDY_TO_XFER
:

3077 
SCST_CMD_STATE_DATA_WAIT
:

3078 
SCST_CMD_STATE_TGT_PRE_EXEC
:

3079 
SCST_CMD_STATE_EXEC_CHECK_BLOCKING
:

3080 
SCST_CMD_STATE_EXEC_CHECK_SN
:

3081 
SCST_CMD_STATE_LOCAL_EXEC
:

3082 
SCST_CMD_STATE_REAL_EXEC
:

3083 
SCST_CMD_STATE_EXEC_WAIT
:

3084 
»s
 = 
SCST_CMD_STATE_PRE_DEV_DONE
;

3088 
	`PRINT_CRIT_ERROR
("Wrong cmd state %d (cmd %p, op %s)",

3089 
cmd
->
¡©e
, cmd, 
	`sc¡_g‘_Ýcode_Çme
(cmd));

3090 
	`sBUG
();

3091 #ià
	`defšed
(
RHEL_MAJOR
) && RHEL_MAJOR -0 < 6

3093 
»s
 = 
SCST_CMD_STATE_LAST_ACTIVE
;

3097 ià(
Œaû
) {

3102 
	`TRACE
(
TRACE_SCSI
, "cmd %p, status %x, msg_status %x, host_status %x, "

3103 "driv”_¡©u %x,„e¥_d©a_ËÀ%d", 
cmd
, cmd->
¡©us
,

3104 
cmd
->
msg_¡©us
, cmd->
ho¡_¡©us
, cmd->
driv”_¡©us
,

3105 
cmd
->
»¥_d©a_Ën
);

3106 ià(
	`uÆik–y
(
cmd
->
¡©us
 =ð
SAM_STAT_CHECK_CONDITION
) &&

3107 
	`sc¡_£n£_v®id
(
cmd
->
£n£
)) {

3108 
	`PRINT_BUFF_FLAG
(
TRACE_SCSI
, "S’£", 
cmd
->
£n£
,

3109 
cmd
->
£n£_v®id_Ën
);

3113 
	`TRACE_EXIT_RES
(
»s
);

3114  
»s
;

3115 
	}
}

3116 
EXPORT_SYMBOL_GPL
(
sc¡_g‘_cmd_abnÜm®_dÚe_¡©e
);

3124 
	$sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
sc¡_cmd
 *
cmd
)

3126 
	`TRACE_ENTRY
();

3128 #ifdeà
CONFIG_SCST_EXTRACHECKS


3129 
cmd
->
¡©e
) {

3130 
SCST_CMD_STATE_XMIT_RESP
:

3131 
SCST_CMD_STATE_FINISHED
:

3132 
SCST_CMD_STATE_FINISHED_INTERNAL
:

3133 
SCST_CMD_STATE_XMIT_WAIT
:

3134 
	`PRINT_CRIT_ERROR
("Wrong cmd state %d (cmd %p, op %s)",

3135 
cmd
->
¡©e
, cmd, 
	`sc¡_g‘_Ýcode_Çme
(cmd));

3136 
	`sBUG
();

3140 
cmd
->
¡©e
 = 
	`sc¡_g‘_cmd_abnÜm®_dÚe_¡©e
(cmd);

3142 
cmd
->
¡©e
) {

3143 
SCST_CMD_STATE_INIT_WAIT
:

3144 
SCST_CMD_STATE_INIT
:

3145 
SCST_CMD_STATE_PARSE
:

3146 
SCST_CMD_STATE_PREPROCESSING_DONE
:

3147 
SCST_CMD_STATE_PREPROCESSING_DONE_CALLED
:

3148 
SCST_CMD_STATE_PREPARE_SPACE
:

3149 
SCST_CMD_STATE_RDY_TO_XFER
:

3150 
SCST_CMD_STATE_DATA_WAIT
:

3151 
cmd
->
wr™e_Ën
 = 0;

3152 
cmd
->
»sid_possibË
 = 1;

3154 
SCST_CMD_STATE_TGT_PRE_EXEC
:

3155 
SCST_CMD_STATE_EXEC_CHECK_SN
:

3156 
SCST_CMD_STATE_EXEC_CHECK_BLOCKING
:

3157 
SCST_CMD_STATE_LOCAL_EXEC
:

3158 
SCST_CMD_STATE_REAL_EXEC
:

3159 
SCST_CMD_STATE_EXEC_WAIT
:

3160 
SCST_CMD_STATE_DEV_DONE
:

3161 
SCST_CMD_STATE_PRE_DEV_DONE
:

3162 
SCST_CMD_STATE_MODE_SELECT_CHECKS
:

3163 
SCST_CMD_STATE_PRE_XMIT_RESP1
:

3164 
SCST_CMD_STATE_PRE_XMIT_RESP2
:

3165 
SCST_CMD_STATE_FINISHED_INTERNAL
:

3168 
	`PRINT_CRIT_ERROR
("Wrong cmd state %d (cmd %p, op %s)",

3169 
cmd
->
¡©e
, cmd, 
	`sc¡_g‘_Ýcode_Çme
(cmd));

3170 
	`sBUG
();

3174 #ifdeà
CONFIG_SCST_EXTRACHECKS


3175 ià(((
cmd
->
¡©e
 !ð
SCST_CMD_STATE_PRE_XMIT_RESP1
) &&

3176 (
cmd
->
¡©e
 !ð
SCST_CMD_STATE_PREPROCESSING_DONE
)) &&

3177 (
cmd
->
tgt_dev
 =ð
NULL
è&& !cmd->
š‹º®
) {

3178 
	`PRINT_CRIT_ERROR
("Wrong‚ot inited cmd state %d (cmd %p, "

3179 "Ý %s)", 
cmd
->
¡©e
, cmd, 
	`sc¡_g‘_Ýcode_Çme
(cmd));

3180 
	`sBUG
();

3184 
	`TRACE_EXIT
();

3186 
	}
}

3187 
EXPORT_SYMBOL_GPL
(
sc¡_£t_cmd_abnÜm®_dÚe_¡©e
);

3189 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

3190 cÚ¡ *
	$sc¡_g‘_Ýcode_Çme
(
sc¡_cmd
 *
cmd
)

3192 ià(
cmd
->
Ý_Çme
)

3193  
cmd
->
Ý_Çme
;

3195 
	`sú´štf
(
cmd
->
nÙ_·r£d_Ý_Çme
,

3196 (
cmd
->
nÙ_·r£d_Ý_Çme
), "0x%x", cmd->
cdb
[0]);

3197  
cmd
->
nÙ_·r£d_Ý_Çme
;

3199 
	}
}

3200 
EXPORT_SYMBOL
(
sc¡_g‘_Ýcode_Çme
);

3203 
	$sc¡_z”o_wr™e_»¡
(
sc¡_cmd
 *
cmd
)

3205 
Ën
, 
offs
 = 0;

3206 
ušt8_t
 *
buf
;

3208 
	`TRACE_ENTRY
();

3210 
Ën
 = 
	`sc¡_g‘_sg_buf_fœ¡
(
cmd
, &
buf
, *cmd->
wr™e_sg
,

3211 *
cmd
->
wr™e_sg_út
);

3212 
Ën
 > 0) {

3213 
cur_offs
;

3215 ià(
offs
 + 
Ën
 <ð
cmd
->
wr™e_Ën
)

3216 
Ãxt
;

3217 ià(
offs
 >ð
cmd
->
wr™e_Ën
)

3218 
cur_offs
 = 0;

3220 
cur_offs
 = 
cmd
->
wr™e_Ën
 - 
offs
;

3222 
	`mem£t
(&
buf
[
cur_offs
], 0, 
Ën
 - cur_offs);

3224 
Ãxt
:

3225 
offs
 +ð
Ën
;

3226 
	`sc¡_put_sg_buf
(
cmd
, 
buf
, *cmd->
wr™e_sg
, *cmd->
wr™e_sg_út
);

3227 
Ën
 = 
	`sc¡_g‘_sg_buf_Ãxt
(
cmd
, &
buf
, *cmd->
wr™e_sg
,

3228 *
cmd
->
wr™e_sg_út
);

3231 
	`TRACE_EXIT
();

3233 
	}
}

3235 
boÞ
 
	$__sc¡_adju¡_sg
(
sc¡_cmd
 *
cmd
, 
sÿ‰”li¡
 *
sg
,

3236 *
sg_út
, 
adju¡_Ën
, 
sc¡_Üig_sg_d©a
 *
Üig_sg
)

3238 
sÿ‰”li¡
 *
sgi
;

3239 
i
, 
l
;

3240 
boÞ
 
»s
 = 
çl£
;

3242 
	`TRACE_ENTRY
();

3244 
l
 = 0;

3245 
	`fÜ_—ch_sg
(
sg
, 
sgi
, *
sg_út
, 
i
) {

3246 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 24)

3247 
	`TRACE_DBG
("˜%d, sg_úˆ%d, sg %p,…age_lšk %lx,†’ %d", 
i
,

3248 *
sg_út
, 
sg
, 
sgi
->
·ge_lšk
, sgi->
Ëngth
);

3250 
	`TRACE_DBG
("˜%d, sg_úˆ%d, sg %p,…age_lšk %lx", 
i
,

3251 *
sg_út
, 
sg
, 0UL);

3253 
l
 +ð
sgi
->
Ëngth
;

3254 ià(
l
 >ð
adju¡_Ën
) {

3255 
Ëá
 = 
adju¡_Ën
 - (
l
 - 
sgi
->
Ëngth
);

3257 
	`TRACE_DBG_FLAG
(
TRACE_SG_OP
|
TRACE_MEMORY
|
TRACE_DEBUG
,

3260 
cmd
, ()cmd->
g
,

3261 
sg
, *
sg_út
, 
adju¡_Ën
, 
i
,

3262 
sgi
->
Ëngth
, 
Ëá
);

3264 
Üig_sg
->
p_Üig_sg_út
 = 
sg_út
;

3265 
Üig_sg
->
Üig_sg_út
 = *
sg_út
;

3266 
Üig_sg
->
Üig_sg_’Œy
 = 
sgi
;

3267 
Üig_sg
->
Üig_’Œy_offs
 = 
sgi
->
off£t
;

3268 
Üig_sg
->
Üig_’Œy_Ën
 = 
sgi
->
Ëngth
;

3269 *
sg_út
 = (
Ëá
 > 0è? 
i
+1 : i;

3270 
sgi
->
Ëngth
 = 
Ëá
;

3271 
»s
 = 
Œue
;

3276 
	`TRACE_EXIT_RES
(
»s
);

3277  
»s
;

3278 
	}
}

3284 
	$sc¡_adju¡_sg
(
sc¡_cmd
 *
cmd
, 
boÞ
 
»g_sg
,

3285 
adju¡_Ën
)

3287 
sÿ‰”li¡
 *
sg
;

3288 *
sg_út
;

3289 
boÞ
 
adju¡_dif
;

3291 
	`TRACE_ENTRY
();

3293 
	`EXTRACHECKS_BUG_ON
(
cmd
->
sg_buff_modif›d
 || cmd->
dif_sg_buff_modif›d
);

3295 ià(
»g_sg
) {

3296 
sg
 = 
cmd
->sg;

3297 
sg_út
 = &
cmd
->sg_cnt;

3298 
adju¡_dif
 = (
cmd
->
dif_sg
 !ð
NULL
);

3300 
sg
 = *
cmd
->
wr™e_sg
;

3301 
sg_út
 = 
cmd
->
wr™e_sg_út
;

3302 ià(
sg
 =ð
cmd
->sg)

3303 
adju¡_dif
 = (
cmd
->
dif_sg
 !ð
NULL
);

3305 
adju¡_dif
 = 
çl£
;

3308 
	`TRACE_DBG
("»g_sg %d,‡dju¡_ËÀ%d,‡dju¡_dià%d", 
»g_sg
,

3309 
adju¡_Ën
, 
adju¡_dif
);

3311 
cmd
->
sg_buff_modif›d
 = !!
	`__sc¡_adju¡_sg
(cmd, 
sg
, 
sg_út
, 
adju¡_Ën
,

3312 &
cmd
->
Üig_sg
);

3314 ià(
adju¡_dif
) {

3315 
adju¡_Ën
 >>ð(
cmd
->
dev
->
block_shiá
 - 
SCST_DIF_TAG_SHIFT
);

3316 
	`TRACE_DBG
("DIF‡dju¡_ËÀ%d", 
adju¡_Ën
);

3317 
cmd
->
dif_sg_buff_modif›d
 = 
	`__sc¡_adju¡_sg
(cmd, cmd->
dif_sg
,

3318 &
cmd
->
dif_sg_út
, 
adju¡_Ën
,

3319 &
cmd
->
Üig_dif_sg
);

3322 
	`TRACE_EXIT
();

3324 
	}
}

3326 
	$__sc¡_adju¡_sg_g‘_ž
(
sc¡_cmd
 *
cmd
,

3327 
sÿ‰”li¡
 *
sg
, *
sg_út
,

3328 
sÿ‰”li¡
 **
»s_sg
, *
»s_sg_út
,

3329 
adju¡_Ën
, 
sc¡_Üig_sg_d©a
 *
Üig_sg
, 
mu¡_Ëá
)

3331 
»s
 = -
ENOENT
, 
i
, 
j
, 
l
;

3333 
	`TRACE_ENTRY
();

3335 
	`TRACE_DBG
("cmd %p, sg_úˆ%d, sg %p", 
cmd
, *
sg_út
, 
sg
);

3337 
l
 = 0;

3338 
i
 = 0, 
j
 = 0; i < *
sg_út
; i++, j++) {

3339 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 24)

3340 
	`TRACE_DBG
("˜%d, j %d, sg %p,…age_lšk %lx,†’ %d", 
i
, 
j
,

3341 
sg
, sg[
j
].
·ge_lšk
, sg->
Ëngth
);

3343 
	`TRACE_DBG
("˜%d, j %d, sg %p", 
i
, 
j
, 
sg
);

3345 ià(
	`uÆik–y
(
	`sg_is_chaš
(&
sg
[
j
]))) {

3346 
sg
 = 
	`sg_chaš_±r
(&sg[
j
]);

3347 
j
 = 0;

3349 
l
 +ð
sg
[
j
].
Ëngth
;

3350 ià(
l
 >ð
adju¡_Ën
) {

3351 
offs
 = 
adju¡_Ën
 - (
l
 - 
sg
[
j
].
Ëngth
);

3353 
	`TRACE_DBG_FLAG
(
TRACE_SG_OP
|
TRACE_MEMORY
|
TRACE_DEBUG
,

3356 
cmd
, ()cmd->
g
,

3357 
sg
, 
adju¡_Ën
, 
i
, 
j
, sg[j].
Ëngth
, 
offs
);

3359 ià(
offs
 =ð
sg
[
j
].
Ëngth
) {

3360 
j
++;

3361 
offs
 = 0;

3364 
Üig_sg
->
p_Üig_sg_út
 = 
sg_út
;

3365 
Üig_sg
->
Üig_sg_út
 = *
sg_út
;

3366 
Üig_sg
->
Üig_sg_’Œy
 = &
sg
[
j
];

3367 
Üig_sg
->
Üig_’Œy_offs
 = 
sg
[
j
].
off£t
;

3368 
Üig_sg
->
Üig_’Œy_Ën
 = 
sg
[
j
].
Ëngth
;

3370 
sg
[
j
].
off£t
 +ð
offs
;

3371 
sg
[
j
].
Ëngth
 -ð
offs
;

3372 *
»s_sg
 = &
sg
[
j
];

3373 *
»s_sg_út
 = *
sg_út
 - 
j
;

3375 
	`TRACE_DBG
("j %d, sg %p, off %d,†en %d, cnt %d "

3376 "(off %d)", 
j
, &
sg
[j], sg[j].
off£t
,

3377 
sg
[
j
].
Ëngth
, *
»s_sg_út
, 
offs
);

3379 
»s
 = 0;

3384 ià(
»s
 != 0)

3385 
out
;

3387 #ifdeà
CONFIG_SCST_EXTRACHECKS


3388 
l
 = 0;

3389 
sg
 = *
»s_sg
;

3390 
i
 = 0; i < *
»s_sg_út
; i++)

3391 
l
 +ð
sg
[
i
].
Ëngth
;

3393 ià(
l
 !ð
mu¡_Ëá
) {

3394 
	`PRINT_ERROR
("Incorrect†ength %d of‡djusted sg (cmd %p, "

3395 "ex³ùed %d)", 
l
, 
cmd
, 
mu¡_Ëá
);

3396 
»s
 = -
EINVAL
;

3397 
	`sc¡_check_»¡Üe_sg_buff
(
cmd
);

3398 
out
;

3402 
out
:

3403 
	`TRACE_EXIT_RES
(
»s
);

3404  
»s
;

3405 
	}
}

3420 
	$sc¡_adju¡_sg_g‘_ž
(
sc¡_cmd
 *
cmd
,

3421 
sÿ‰”li¡
 **
»s_sg
, *
»s_sg_út
,

3422 
sÿ‰”li¡
 **
»s_dif_sg
, *
»s_dif_sg_út
,

3423 
adju¡_Ën
, 
mu¡_Ëá
)

3425 
»s
;

3427 
	`TRACE_ENTRY
();

3429 
	`EXTRACHECKS_BUG_ON
(
cmd
->
sg_buff_modif›d
 || cmd->
dif_sg_buff_modif›d
);

3431 
»s
 = 
	`__sc¡_adju¡_sg_g‘_ž
(
cmd
, cmd->
sg
, &cmd->
sg_út
, 
»s_sg
,

3432 
»s_sg_út
, 
adju¡_Ën
, &
cmd
->
Üig_sg
, 
mu¡_Ëá
);

3433 ià(
»s
 != 0)

3434 
out
;

3436 
cmd
->
sg_buff_modif›d
 = 1;

3438 ià(
cmd
->
dif_sg
 !ð
NULL
) {

3439 
adju¡_Ën
 >>ð(
cmd
->
dev
->
block_shiá
 - 
SCST_DIF_TAG_SHIFT
);

3440 
mu¡_Ëá
 >>ð(
cmd
->
dev
->
block_shiá
 - 
SCST_DIF_TAG_SHIFT
);

3442 
	`TRACE_DBG
("DIF‡dju¡_ËÀ%d, mu¡_Ëá %d", 
adju¡_Ën
, 
mu¡_Ëá
);

3444 
»s
 = 
	`__sc¡_adju¡_sg_g‘_ž
(
cmd
, cmd->
dif_sg
, &cmd->
dif_sg_út
,

3445 
»s_dif_sg
, 
»s_dif_sg_út
, 
adju¡_Ën
,

3446 &
cmd
->
Üig_dif_sg
, 
mu¡_Ëá
);

3447 ià(
»s
 != 0) {

3448 
	`sc¡_»¡Üe_sg_buff
(
cmd
);

3449 
out
;

3452 
cmd
->
dif_sg_buff_modif›d
 = 1;

3455 
out
:

3456 
	`TRACE_EXIT_RES
(
»s
);

3457  
»s
;

3458 
	}
}

3465 
	$sc¡_»¡Üe_sg_buff
(
sc¡_cmd
 *
cmd
)

3467 
	`TRACE_DBG_FLAG
(
TRACE_DEBUG
|
TRACE_MEMORY
, "cmd %p, sg %p, DATA: "

3470 "Üig_’Œy_off %d, orig_’Œy_ËÀ%d, orig_sg_úˆ%d", 
cmd
,

3471 
cmd
->
sg
, cmd->
Üig_sg
.
Üig_sg_’Œy
, cmd->Üig_sg.
Üig_’Œy_offs
,

3472 
cmd
->
Üig_sg
.
Üig_’Œy_Ën
, cmd->Üig_sg.
Üig_sg_út
,

3473 
cmd
->
Üig_dif_sg
.
Üig_sg_’Œy
, cmd->Üig_dif_sg.
Üig_’Œy_offs
,

3474 
cmd
->
Üig_dif_sg
.
Üig_’Œy_Ën
, cmd->Üig_dif_sg.
Üig_sg_út
);

3476 
	`EXTRACHECKS_BUG_ON
(!(
cmd
->
sg_buff_modif›d
 || cmd->
dif_sg_buff_modif›d
));

3478 ià(
cmd
->
sg_buff_modif›d
) {

3479 
cmd
->
Üig_sg
.
Üig_sg_’Œy
->
off£t
 = cmd->Üig_sg.
Üig_’Œy_offs
;

3480 
cmd
->
Üig_sg
.
Üig_sg_’Œy
->
Ëngth
 = cmd->Üig_sg.
Üig_’Œy_Ën
;

3481 *
cmd
->
Üig_sg
.
p_Üig_sg_út
 = cmd->Üig_sg.
Üig_sg_út
;

3484 ià(
cmd
->
dif_sg_buff_modif›d
) {

3485 
cmd
->
Üig_dif_sg
.
Üig_sg_’Œy
->
off£t
 = cmd->Üig_dif_sg.
Üig_’Œy_offs
;

3486 
cmd
->
Üig_dif_sg
.
Üig_sg_’Œy
->
Ëngth
 = cmd->Üig_dif_sg.
Üig_’Œy_Ën
;

3487 *
cmd
->
Üig_dif_sg
.
p_Üig_sg_út
 = cmd->Üig_dif_sg.
Üig_sg_út
;

3490 
cmd
->
sg_buff_modif›d
 = 0;

3491 
cmd
->
dif_sg_buff_modif›d
 = 0;

3492 
	}
}

3493 
EXPORT_SYMBOL
(
sc¡_»¡Üe_sg_buff
);

3503 
	$sc¡_£t_»¥_d©a_Ën
(
sc¡_cmd
 *
cmd
, 
»¥_d©a_Ën
)

3505 
	`TRACE_ENTRY
();

3507 
	`sc¡_check_»¡Üe_sg_buff
(
cmd
);

3508 
cmd
->
»¥_d©a_Ën
 =„esp_data_len;

3510 ià(
»¥_d©a_Ën
 =ð
cmd
->
bufæ’
)

3511 
out
;

3513 
	`TRACE_DBG
("cmd %p,„e¥_d©a_ËÀ%d", 
cmd
, 
»¥_d©a_Ën
);

3515 ià(
	`uÆik–y
(
»¥_d©a_Ën
 > 
cmd
->
bufæ’
)) {

3516 
	`PRINT_ERROR
("Too big„esponse data†en %d (max %d),†imiting "

3517 "™Øthmax (dev %s)", 
»¥_d©a_Ën
, 
cmd
->
bufæ’
,

3518 
cmd
->
dev
 ? cmd->dev->
vœt_Çme
 : "(no LUN)");

3523 
	`dump_¡ack
();

3524 
cmd
->
»¥_d©a_Ën
 = cmd->
bufæ’
;

3525 
out
;

3528 
	`sc¡_adju¡_sg
(
cmd
, 
Œue
, 
»¥_d©a_Ën
);

3530 
cmd
->
»sid_possibË
 = 1;

3532 
out
:

3533 
	`TRACE_EXIT
();

3535 
	}
}

3536 
EXPORT_SYMBOL_GPL
(
sc¡_£t_»¥_d©a_Ën
);

3538 
	$sc¡_lim™_sg_wr™e_Ën
(
sc¡_cmd
 *
cmd
)

3540 
	`TRACE_ENTRY
();

3542 
	`TRACE_MEM
("Limiting sg write†eno %d (cmd %p, sg %p, sg_cnt %d)",

3543 
cmd
->
wr™e_Ën
, cmd, *cmd->
wr™e_sg
, *cmd->
wr™e_sg_út
);

3545 
	`sc¡_check_»¡Üe_sg_buff
(
cmd
);

3546 
	`sc¡_adju¡_sg
(
cmd
, 
çl£
, cmd->
wr™e_Ën
);

3548 
	`TRACE_EXIT
();

3550 
	}
}

3552 
	$sc¡_fuÎ_Ën_to_d©a_Ën
(
fuÎ_Ën
, 
block_shiá
)

3554 
»m
, 
»s
;

3556 
»s
 = 
fuÎ_Ën
 << 
block_shiá
;

3557 
»m
 = 
	`do_div
(
»s
, (1 << 
block_shiá
è+ (1 << 
SCST_DIF_TAG_SHIFT
));

3558 ià(
	`uÆik–y
(
»m
 != 0))

3559 
	`TRACE
(
TRACE_MINOR
, "Reminder %d for full†en! (full†en%d)",

3560 
»m
, 
fuÎ_Ën
);

3562 
	`TRACE_DBG
("d©¨ËÀ%d (fuÎ %d)", 
»s
, 
fuÎ_Ën
);

3564  
»s
;

3565 
	}
}

3573 
	$sc¡_cmd_g‘_ex³ùed_Œªsãr_Ën_d©a
(
sc¡_cmd
 *
cmd
)

3575 
»m
, 
»s
;

3577 ià(!
cmd
->
tgt_dif_d©a_ex³ùed
)

3578  
cmd
->
ex³ùed_Œªsãr_Ën_fuÎ
;

3580 
»s
 = 
cmd
->
ex³ùed_Œªsãr_Ën_fuÎ
 << cmd->
dev
->
block_shiá
;

3581 
»m
 = 
	`do_div
(
»s
, 
cmd
->
dev
->
block_size
 + (1 << 
SCST_DIF_TAG_SHIFT
));

3582 ià(
	`uÆik–y
(
»m
 != 0))

3583 
	`TRACE
(
TRACE_MINOR
, "Reminder %d forƒxpectedransfer†en "

3584 "d©a! (cmd %p, o°%s,ƒx³ùed†’ fuÎ %d)", 
»m
,

3585 
cmd
, 
	`sc¡_g‘_Ýcode_Çme
(cmd),

3586 
cmd
->
ex³ùed_Œªsãr_Ën_fuÎ
);

3588 
	`TRACE_DBG
("Ex³ùed¿nsã¸ËÀd©¨%d (cmd %p)", 
»s
, 
cmd
);

3590  
»s
;

3591 
	}
}

3598 
	$sc¡_cmd_g‘_ex³ùed_Œªsãr_Ën_dif
(
sc¡_cmd
 *
cmd
)

3600 
»m
, 
»s
;

3602 ià(!
cmd
->
tgt_dif_d©a_ex³ùed
)

3605 
»s
 = 
cmd
->
ex³ùed_Œªsãr_Ën_fuÎ
 << 
SCST_DIF_TAG_SHIFT
;

3606 
»m
 = 
	`do_div
(
»s
, 
cmd
->
dev
->
block_size
 + (1 << 
SCST_DIF_TAG_SHIFT
));

3607 ià(
	`uÆik–y
(
»m
 != 0))

3608 
	`TRACE
(
TRACE_MINOR
, "Reminder %d forƒxpectedransfer†en dif! "

3609 "(cmd %p, o°%s,ƒx³ùed†’ fuÎ %d)", 
»m
, 
cmd
,

3610 
	`sc¡_g‘_Ýcode_Çme
(
cmd
), cmd->
ex³ùed_Œªsãr_Ën_fuÎ
);

3612 
	`TRACE_DBG
("Ex³ùed¿nsã¸ËÀDIF %d (cmd %p)", 
»s
, 
cmd
);

3614  
»s
;

3615 
	}
}

3617 
	$sc¡_adju¡_»¥_d©a_Ën
(
sc¡_cmd
 *
cmd
)

3619 
	`TRACE_ENTRY
();

3621 ià(!
cmd
->
ex³ùed_v®ues_£t
) {

3622 
cmd
->
adju¡ed_»¥_d©a_Ën
 = cmd->
»¥_d©a_Ën
;

3623 
out
;

3626 
cmd
->
adju¡ed_»¥_d©a_Ën
 = 
	`mš
(cmd->
»¥_d©a_Ën
,

3627 
	`sc¡_cmd_g‘_ex³ùed_Œªsãr_Ën_d©a
(
cmd
));

3629 ià(
cmd
->
adju¡ed_»¥_d©a_Ën
 !ðcmd->
»¥_d©a_Ën
) {

3630 
	`TRACE_MEM
("Adjusting„esp_data_leno %d (cmd %p, sg %p, "

3631 "sg_úˆ%d)", 
cmd
->
adju¡ed_»¥_d©a_Ën
, cmd, cmd->
sg
,

3632 
cmd
->
sg_út
);

3633 
	`sc¡_check_»¡Üe_sg_buff
(
cmd
);

3634 
	`sc¡_adju¡_sg
(
cmd
, 
Œue
, cmd->
adju¡ed_»¥_d©a_Ën
);

3637 
out
:

3638 
	`TRACE_EXIT
();

3640 
	}
}

3647 
	$sc¡_cmd_£t_wr™e_nÙ_»ûived_d©a_Ën
(
sc¡_cmd
 *
cmd
,

3648 
nÙ_»ûived
)

3650 
	`TRACE_ENTRY
();

3652 
cmd
->
wr™e_nÙ_»ûived_£t
 = 1;

3654 ià(!
cmd
->
ex³ùed_v®ues_£t
) {

3660 
	`TRACE_MGMT_DBG
("NØex³ùed v®ue £t, ignÜšg (cmd %p)", 
cmd
);

3661 
out
;

3664 
cmd
->
»sid_possibË
 = 1;

3666 ià((
cmd
->
ex³ùed_d©a_dœeùiÚ
 & 
SCST_DATA_READ
) &&

3667 (
cmd
->
ex³ùed_d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
)) {

3668 
cmd
->
wr™e_Ën
 = cmd->
ex³ùed_out_Œªsãr_Ën
 - 
nÙ_»ûived
;

3669 ià(
cmd
->
wr™e_Ën
 =ðcmd->
out_bufæ’
)

3670 
out
;

3671 } ià(
cmd
->
ex³ùed_d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
) {

3672 
cmd
->
wr™e_Ën
 = cmd->
ex³ùed_Œªsãr_Ën_fuÎ
 - 
nÙ_»ûived
;

3673 ià(
cmd
->
tgt_dif_d©a_ex³ùed
)

3674 
cmd
->
wr™e_Ën
 = 
	`sc¡_fuÎ_Ën_to_d©a_Ën
(cmd->write_len,

3675 
cmd
->
dev
->
block_shiá
);

3676 ià(
cmd
->
wr™e_Ën
 =ðcmd->
bufæ’
)

3677 
out
;

3685 
	`TRACE_DBG
("cmd %p,‚Ù_»ûived %d, wr™e_ËÀ%d", 
cmd
, 
nÙ_»ûived
,

3686 
cmd
->
wr™e_Ën
);

3688 ià(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
)

3689 
	`sc¡_lim™_sg_wr™e_Ën
(
cmd
);

3691 
out
:

3692 
	`TRACE_EXIT
();

3694 
	}
}

3695 
EXPORT_SYMBOL
(
sc¡_cmd_£t_wr™e_nÙ_»ûived_d©a_Ën
);

3697 
	$sc¡_cmd_£t_wr™e_no_d©a_»ûived
(
sc¡_cmd
 *
cmd
)

3699 
w
;

3701 
	`TRACE_ENTRY
();

3703 
	`EXTRACHECKS_BUG_ON
(
cmd
->
ex³ùed_v®ues_£t
 &&

3704 ((
cmd
->
ex³ùed_d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
) == 0));

3706 ià((
cmd
->
ex³ùed_d©a_dœeùiÚ
 & 
SCST_DATA_READ
) &&

3707 (
cmd
->
ex³ùed_d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
))

3708 
w
 = 
cmd
->
ex³ùed_out_Œªsãr_Ën
;

3710 
w
 = 
cmd
->
ex³ùed_Œªsãr_Ën_fuÎ
;

3712 
	`sc¡_cmd_£t_wr™e_nÙ_»ûived_d©a_Ën
(
cmd
, 
w
);

3714 
	`TRACE_EXIT
();

3716 
	}
}

3724 
boÞ
 
	$__sc¡_g‘_»sid
(
sc¡_cmd
 *
cmd
, *
»sid
, *
bidi_out_»sid
)

3726 
boÞ
 
»s
;

3728 
	`TRACE_ENTRY
();

3730 *
»sid
 = 0;

3731 ià(
bidi_out_»sid
 !ð
NULL
)

3732 *
bidi_out_»sid
 = 0;

3734 ià(!
cmd
->
ex³ùed_v®ues_£t
) {

3740 
	`TRACE_MGMT_DBG
("Noƒxpected values set,„eturning‚o„esidual "

3741 "(cmd %p)", 
cmd
);

3742 
»s
 = 
çl£
;

3743 
out
;

3746 ià(
cmd
->
ex³ùed_d©a_dœeùiÚ
 & 
SCST_DATA_READ
) {

3747 
»¥
 = 
cmd
->
»¥_d©a_Ën
;

3749 ià(
cmd
->
tgt_dif_d©a_ex³ùed
)

3750 
»¥
 +ðÔe¥ >> 
cmd
->
dev
->
block_shiá
è<< 
SCST_DIF_TAG_SHIFT
;

3751 *
»sid
 = 
cmd
->
ex³ùed_Œªsãr_Ën_fuÎ
 - 
»¥
;

3752 ià((
cmd
->
ex³ùed_d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
è&& 
bidi_out_»sid
) {

3753 ià(
cmd
->
wr™e_Ën
 < cmd->
ex³ùed_out_Œªsãr_Ën
)

3754 *
bidi_out_»sid
 = 
cmd
->
ex³ùed_out_Œªsãr_Ën
 -

3755 
cmd
->
wr™e_Ën
;

3757 *
bidi_out_»sid
 = 
cmd
->
wr™e_Ën
 - cmd->
out_bufæ’
;

3759 } ià(
cmd
->
ex³ùed_d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
) {

3760 
wl
 = 
cmd
->
wr™e_Ën
;

3762 ià(
cmd
->
tgt_dif_d©a_ex³ùed
)

3763 
wl
 +ð(wÈ>> 
cmd
->
dev
->
block_shiá
è<< 
SCST_DIF_TAG_SHIFT
;

3764 ià(
wl
 < 
cmd
->
ex³ùed_Œªsãr_Ën_fuÎ
)

3765 *
»sid
 = 
cmd
->
ex³ùed_Œªsãr_Ën_fuÎ
 - 
wl
;

3767 *
»sid
 = 
cmd
->
wr™e_Ën
 - cmd->
bufæ’
;

3768 ià(
cmd
->
tgt_dif_d©a_ex³ùed
) {

3769 
r
 = *
»sid
;

3771 ià(
r
 < 0)

3772 
r
 = -r;

3773 
r
 +ðÔ >> 
cmd
->
dev
->
block_shiá
è<< 
SCST_DIF_TAG_SHIFT
;

3774 ià(*
»sid
 > 0)

3775 *
»sid
 = 
r
;

3777 *
»sid
 = -
r
;

3782 
»s
 = 
Œue
;

3784 
	`TRACE_DBG
("cmd %p,„esid %d, bidi_out_resid %d (resp_data_len %d, "

3786 "tgt_dif_d©a_ex³ùed %d)", 
cmd
, *
»sid
,

3787 
bidi_out_»sid
 ? *bidi_out_»sid : 0, 
cmd
->
»¥_d©a_Ën
,

3788 
cmd
->
ex³ùed_d©a_dœeùiÚ
, cmd->
wr™e_Ën
, cmd->
bufæ’
,

3789 
cmd
->
tgt_dif_d©a_ex³ùed
);

3791 
out
:

3792 
	`TRACE_EXIT_RES
(
»s
);

3793  
»s
;

3794 
	}
}

3795 
EXPORT_SYMBOL
(
__sc¡_g‘_»sid
);

3798 
	$sc¡_queue_»Œy_cmd
(
sc¡_cmd
 *
cmd
)

3800 
sc¡_tgt
 *
tgt
 = 
cmd
->tgt;

3801 
æags
;

3803 
	`TRACE_ENTRY
();

3805 
	`¥š_lock_œq§ve
(&
tgt
->
tgt_lock
, 
æags
);

3807 
tgt
->
»Œy_cmds
++;

3809 
	`TRACE_RETRY
("Addšg cmd %°tØ»Œy cmd†i¡", 
cmd
);

3810 
	`li¡_add_ž
(&
cmd
->
cmd_li¡_’Œy
, &
tgt
->
»Œy_cmd_li¡
);

3812 ià(!
tgt
->
»Œy_tim”_aùive
) {

3813 
	`TRACE_DBG
("Aùiv©šg„‘ryim” fÜgˆ%p", 
tgt
);

3814 
tgt
->
»Œy_tim”
.
expœes
 = 
jiff›s
 + 
SCST_TGT_RETRY_TIMEOUT
;

3815 
	`add_tim”
(&
tgt
->
»Œy_tim”
);

3816 
tgt
->
»Œy_tim”_aùive
 = 1;

3819 
	`¥š_uÆock_œq»¡Üe
(&
tgt
->
tgt_lock
, 
æags
);

3821 
	`TRACE_EXIT
();

3823 
	}
}

3832 
	$sc¡_upd©e_hw_³ndšg_¡¬t
(
sc¡_cmd
 *
cmd
)

3834 
æags
;

3836 
	`TRACE_ENTRY
();

3839 
	`¥š_lock_œq§ve
(&
cmd
->
£ss
->
£ss_li¡_lock
, 
æags
);

3840 
cmd
->
hw_³ndšg_¡¬t
 = 
jiff›s
;

3841 
	`TRACE_MGMT_DBG
("Updated hw_pending_starto %ld (cmd %p)",

3842 
cmd
->
hw_³ndšg_¡¬t
, cmd);

3843 
	`¥š_uÆock_œq»¡Üe
(&
cmd
->
£ss
->
£ss_li¡_lock
, 
æags
);

3845 
	`TRACE_EXIT
();

3847 
	}
}

3848 
EXPORT_SYMBOL_GPL
(
sc¡_upd©e_hw_³ndšg_¡¬t
);

3854 
	$sc¡_check_hw_³ndšg_cmd
(
sc¡_cmd
 *
cmd
,

3855 
cur_time
, 
max_time
,

3856 
sc¡_£ssiÚ
 *
£ss
, *
æags
,

3857 
sc¡_tgt_‹m¶©e
 *
tg‰
)

3859 
»s
 = -1;

3861 
	`TRACE_DBG
("cmd %p, hw_pending %d,…rocime %ld, "

3862 "³ndšgim%ld", 
cmd
, cmd->
cmd_hw_³ndšg
,

3863 ()(
cur_time
 - 
cmd
->
¡¬t_time
è/ 
HZ
,

3864 ()(
cur_time
 - 
cmd
->
hw_³ndšg_¡¬t
è/ 
HZ
);

3866 ià(
	`time_befÜe
(
cur_time
, 
cmd
->
¡¬t_time
 + 
max_time
)) {

3868 
out
;

3871 ià(!
cmd
->
cmd_hw_³ndšg
) {

3872 
»s
 = 0;

3873 
out
;

3876 ià(
	`time_befÜe
(
cur_time
, 
cmd
->
hw_³ndšg_¡¬t
 + 
max_time
)) {

3877 
»s
 = 0;

3878 
out
;

3881 
	`TRACE
(
TRACE_MGMT
, "Cmd %p HW…ending foroo†ong %ld (state %x)",

3882 
cmd
, (
cur_time
 - cmd->
hw_³ndšg_¡¬t
è/ 
HZ
,

3883 
cmd
->
¡©e
);

3885 
cmd
->
cmd_hw_³ndšg
 = 0;

3887 
	`¥š_uÆock_œq»¡Üe
(&
£ss
->
£ss_li¡_lock
, *
æags
);

3888 
tg‰
->
	`Ú_hw_³ndšg_cmd_timeout
(
cmd
);

3889 
	`¥š_lock_œq§ve
(&
£ss
->
£ss_li¡_lock
, *
æags
);

3891 
»s
 = 1;

3893 
out
:

3894 
	`TRACE_EXIT_RES
(
»s
);

3895  
»s
;

3896 
	}
}

3898 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 20)

3899 
	$sc¡_hw_³ndšg_wÜk_â
(*
p
)

3901 
	$sc¡_hw_³ndšg_wÜk_â
(
wÜk_¡ruù
 *
wÜk
)

3904 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 20)

3905 
sc¡_£ssiÚ
 *
£ss
 = (sc¡_£ssiÚ *)
p
;

3907 
sc¡_£ssiÚ
 *
£ss
 = 
	`cÚš”_of
(
wÜk
, scst_session,

3908 
hw_³ndšg_wÜk
.
wÜk
);

3910 
sc¡_tgt_‹m¶©e
 *
tg‰
 = 
£ss
->
tgt
->tgtt;

3911 
sc¡_cmd
 *
cmd
;

3912 
cur_time
 = 
jiff›s
;

3913 
æags
;

3914 
max_time
 = 
tg‰
->
max_hw_³ndšg_time
 * 
HZ
;

3916 
	`TRACE_ENTRY
();

3918 
	`TRACE_DBG
("HW…’dšg wÜk (£s %p, maxim%ld)", 
£ss
, 
max_time
/
HZ
);

3920 
	`þ—r_b™
(
SCST_SESS_HW_PENDING_WORK_SCHEDULED
, &
£ss
->
£ss_aæags
);

3922 
	`¥š_lock_œq§ve
(&
£ss
->
£ss_li¡_lock
, 
æags
);

3924 
»¡¬t
:

3925 
	`li¡_fÜ_—ch_’Œy
(
cmd
, &
£ss
->
£ss_cmd_li¡
, 
£ss_cmd_li¡_’Œy
) {

3926 
rc
;

3928 
rc
 = 
	`sc¡_check_hw_³ndšg_cmd
(
cmd
, 
cur_time
, 
max_time
, 
£ss
,

3929 &
æags
, 
tg‰
);

3930 ià(
rc
 < 0)

3932 ià(
rc
 == 0)

3935 
»¡¬t
;

3938 ià(!
	`li¡_em±y
(&
£ss
->
£ss_cmd_li¡
)) {

3943 
	`TRACE_DBG
("Sched HW…ending work for sess %p (maxime %d)",

3944 
£ss
, 
tg‰
->
max_hw_³ndšg_time
);

3945 
	`£t_b™
(
SCST_SESS_HW_PENDING_WORK_SCHEDULED
, &
£ss
->
£ss_aæags
);

3946 
	`scheduË_d–ayed_wÜk
(&
£ss
->
hw_³ndšg_wÜk
,

3947 
tg‰
->
max_hw_³ndšg_time
 * 
HZ
);

3950 
	`¥š_uÆock_œq»¡Üe
(&
£ss
->
£ss_li¡_lock
, 
æags
);

3952 
	`TRACE_EXIT
();

3954 
	}
}

3956 
boÞ
 
	$__sc¡_is_»Ïtive_rg‘_pÜt_id_unique
(
ušt16_t
 
id
,

3957 cÚ¡ 
sc¡_tgt
 *
t
)

3959 
boÞ
 
»s
 = 
Œue
;

3960 
sc¡_tgt_‹m¶©e
 *
tg‰
;

3962 
	`TRACE_ENTRY
();

3964 
	`li¡_fÜ_—ch_’Œy
(
tg‰
, &
sc¡_‹m¶©e_li¡
,

3965 
sc¡_‹m¶©e_li¡_’Œy
) {

3966 
sc¡_tgt
 *
tgt
;

3968 
	`li¡_fÜ_—ch_’Œy
(
tgt
, &
tg‰
->
tgt_li¡
, 
tgt_li¡_’Œy
) {

3969 ià(
tgt
 =ð
t
)

3971 ià((
tgt
->
tg‰
->
is_rg‘_’abËd
 !ð
NULL
) &&

3972 !
tgt
->
tg‰
->
	`is_rg‘_’abËd
(tgt))

3974 ià(
id
 =ð
tgt
->
»l_tgt_id
) {

3975 
»s
 = 
çl£
;

3981 
	`TRACE_EXIT_RES
(
»s
);

3982  
»s
;

3983 
	}
}

3986 
boÞ
 
	$sc¡_is_»Ïtive_rg‘_pÜt_id_unique
(
ušt16_t
 
id
,

3987 cÚ¡ 
sc¡_tgt
 *
t
)

3989 
boÞ
 
»s
;

3991 
	`TRACE_ENTRY
();

3993 
	`mu‹x_lock
(&
sc¡_mu‹x
);

3994 
»s
 = 
	`__sc¡_is_»Ïtive_rg‘_pÜt_id_unique
(
id
, 
t
);

3995 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

3997 
	`TRACE_EXIT_RES
(
»s
);

3998  
»s
;

3999 
	}
}

4001 
	$g’_»Ïtive_rg‘_pÜt_id
(
ušt16_t
 *
id
)

4003 
»s
 = -
EOVERFLOW
;

4004 
¹i
 = 
SCST_MIN_REL_TGT_ID
, 
¹i_´ev
;

4006 
	`TRACE_ENTRY
();

4008 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

4009 ià(
»s
 != 0)

4010 
out
;

4012 
¹i_´ev
 = 
¹i
;

4014 ià(
	`__sc¡_is_»Ïtive_rg‘_pÜt_id_unique
(
¹i
, 
NULL
)) {

4015 *
id
 = (
ušt16_t
)
¹i
++;

4016 
»s
 = 0;

4017 
out_uÆock
;

4019 
¹i
++;

4020 ià(
¹i
 > 
SCST_MAX_REL_TGT_ID
)

4021 
¹i
 = 
SCST_MIN_REL_TGT_ID
;

4022 } 
¹i
 !ð
¹i_´ev
);

4024 
	`PRINT_ERROR
("%s", "Unableo create unique„elativearget…ort id");

4026 
out_uÆock
:

4027 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

4029 
out
:

4030 
	`TRACE_EXIT_RES
(
»s
);

4031  
»s
;

4032 
	}
}

4035 
	$sc¡_®loc_tgt
(
sc¡_tgt_‹m¶©e
 *
tg‰
, 
sc¡_tgt
 **
tgt
)

4037 
sc¡_tgt
 *
t
;

4038 
»s
 = 0;

4040 
	`TRACE_ENTRY
();

4042 
t
 = 
	`kmem_ÿche_z®loc
(
sc¡_tgt_ÿch•
, 
GFP_KERNEL
);

4043 ià(
t
 =ð
NULL
) {

4044 
	`PRINT_ERROR
("%s", "Allocation ofgt failed");

4045 
»s
 = -
ENOMEM
;

4046 
out
;

4049 
	`INIT_LIST_HEAD
(&
t
->
£ss_li¡
);

4050 
	`INIT_LIST_HEAD
(&
t
->
sysfs_£ss_li¡
);

4051 
	`š™_wa™queue_h—d
(&
t
->
uÄeg_wa™Q
);

4052 
t
->
tg‰
 =gtt;

4053 
t
->
sg_bËsize
 = 
tg‰
->sg_tablesize;

4054 
t
->
tgt_dif_suµÜ‹d
 = 
tg‰
->
dif_suµÜ‹d
;

4055 
t
->
tgt_hw_dif_ty³1_suµÜ‹d
 = 
tg‰
->
hw_dif_ty³1_suµÜ‹d
;

4056 
t
->
tgt_hw_dif_ty³2_suµÜ‹d
 = 
tg‰
->
hw_dif_ty³2_suµÜ‹d
;

4057 
t
->
tgt_hw_dif_ty³3_suµÜ‹d
 = 
tg‰
->
hw_dif_ty³3_suµÜ‹d
;

4058 
t
->
tgt_hw_dif__suµÜ‹d
 = 
tg‰
->
hw_dif__suµÜ‹d
;

4059 
t
->
tgt_hw_dif_§me_sg_Ïyout_»quœed
 = 
tg‰
->
hw_dif_§me_sg_Ïyout_»quœed
;

4060 
t
->
tgt_suµÜ‹d_dif_block_sizes
 = 
tg‰
->
suµÜ‹d_dif_block_sizes
;

4061 
	`¥š_lock_š™
(&
t
->
tgt_lock
);

4062 
	`INIT_LIST_HEAD
(&
t
->
»Œy_cmd_li¡
);

4063 
	`š™_tim”
(&
t
->
»Œy_tim”
);

4064 
t
->
»Œy_tim”
.
d©a
 = ()t;

4065 
t
->
»Œy_tim”
.
funùiÚ
 = 
sc¡_tgt_»Œy_tim”_â
;

4066 
	`©omic_£t
(&
t
->
tgt_dif_­p_çžed_tgt
, 0);

4067 
	`©omic_£t
(&
t
->
tgt_dif_»f_çžed_tgt
, 0);

4068 
	`©omic_£t
(&
t
->
tgt_dif_gu¬d_çžed_tgt
, 0);

4069 
	`©omic_£t
(&
t
->
tgt_dif_­p_çžed_sc¡
, 0);

4070 
	`©omic_£t
(&
t
->
tgt_dif_»f_çžed_sc¡
, 0);

4071 
	`©omic_£t
(&
t
->
tgt_dif_gu¬d_çžed_sc¡
, 0);

4072 
	`©omic_£t
(&
t
->
tgt_dif_­p_çžed_dev
, 0);

4073 
	`©omic_£t
(&
t
->
tgt_dif_»f_çžed_dev
, 0);

4074 
	`©omic_£t
(&
t
->
tgt_dif_gu¬d_çžed_dev
, 0);

4076 #ifdeà
CONFIG_SCST_PROC


4077 
»s
 = 
	`g’_»Ïtive_rg‘_pÜt_id
(&
t
->
»l_tgt_id
);

4078 ià(
»s
 != 0) {

4079 
	`sc¡_ä“_tgt
(
t
);

4080 
out
;

4083 
	`INIT_LIST_HEAD
(&
t
->
tgt_acg_li¡
);

4086 *
tgt
 = 
t
;

4088 
out
:

4089 
	`TRACE_EXIT_HRES
(
»s
);

4090  
»s
;

4091 
	}
}

4094 
	$sc¡_ä“_tgt
(
sc¡_tgt
 *
tgt
)

4096 
	`TRACE_ENTRY
();

4098 
	`kä“
(
tgt
->
tgt_Çme
);

4099 
	`kä“
(
tgt
->
tgt_comm’t
);

4100 #ifdeà
CONFIG_SCST_PROC


4101 
	`kä“
(
tgt
->
deçuÉ_group_Çme
);

4104 
	`kmem_ÿche_ä“
(
sc¡_tgt_ÿch•
, 
tgt
);

4106 
	`TRACE_EXIT
();

4108 
	}
}

4110 
	$sc¡_š™_Üd”_d©a
(
sc¡_Üd”_d©a
 *
Üd”_d©a
)

4112 
i
;

4114 
	`¥š_lock_š™
(&
Üd”_d©a
->
¢_lock
);

4115 
	`INIT_LIST_HEAD
(&
Üd”_d©a
->
deã¼ed_cmd_li¡
);

4116 
	`INIT_LIST_HEAD
(&
Üd”_d©a
->
sk³d_¢_li¡
);

4117 
Üd”_d©a
->
cu¼_¢
 = (
	`ty³of
(order_data->curr_sn))(-20);

4118 
Üd”_d©a
->
ex³ùed_¢
 = ord”_d©a->
cu¼_¢
;

4119 
Üd”_d©a
->
cur_¢_¦Ù
 = &Üd”_d©a->
¢_¦Ùs
[0];

4120 
i
 = 0; i < ()
	`ARRAY_SIZE
(
Üd”_d©a
->
¢_¦Ùs
); i++)

4121 
	`©omic_£t
(&
Üd”_d©a
->
¢_¦Ùs
[
i
], 0);

4122 
	`¥š_lock_š™
(&
Üd”_d©a
->
š™_dÚe_lock
);

4124 
	}
}

4126 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 20)

4127 
sc¡_ext_blockšg_dÚe_â
(*
p
);

4129 
sc¡_ext_blockšg_dÚe_â
(
wÜk_¡ruù
 *
wÜk
);

4132 
sc¡_dif_nÚe
(
sc¡_cmd
 *
cmd
);

4133 #ifdeà
CONFIG_SCST_DIF_INJECT_CORRUPTED_TAGS


4134 
sc¡_dif_nÚe_ty³1
(
sc¡_cmd
 *
cmd
);

4136 
	#sc¡_dif_nÚe_ty³1
 
sc¡_dif_nÚe


	)

4140 
	$sc¡_®loc_deviû
(
gå_t
 
gå_mask
, 
sc¡_deviû
 **
out_dev
)

4142 
sc¡_deviû
 *
dev
;

4143 
»s
 = 0;

4145 
	`TRACE_ENTRY
();

4147 
dev
 = 
	`kmem_ÿche_z®loc
(
sc¡_dev_ÿch•
, 
gå_mask
);

4148 ià(
dev
 =ð
NULL
) {

4149 
	`PRINT_ERROR
("%s", "Allocation of scst_device failed");

4150 
»s
 = -
ENOMEM
;

4151 
out
;

4154 
dev
->
hªdËr
 = &
sc¡_nuÎ_devty³
;

4155 #ifdeà
CONFIG_SCST_PER_DEVICE_CMD_COUNT_LIMIT


4156 
	`©omic_£t
(&
dev
->
dev_cmd_couÁ
, 0);

4158 
	`sc¡_š™_mem_lim
(&
dev
->
dev_mem_lim
);

4159 
	`¥š_lock_š™
(&
dev
->
dev_lock
);

4160 
	`INIT_LIST_HEAD
(&
dev
->
dev_exec_cmd_li¡
);

4161 
	`INIT_LIST_HEAD
(&
dev
->
blocked_cmd_li¡
);

4162 
	`INIT_LIST_HEAD
(&
dev
->
dev_tgt_dev_li¡
);

4163 
	`INIT_LIST_HEAD
(&
dev
->
dev_acg_dev_li¡
);

4164 
	`INIT_LIST_HEAD
(&
dev
->
ext_block”s_li¡
);

4165 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 20)

4166 
	`INIT_WORK
(&
dev
->
ext_block”s_wÜk
, 
sc¡_ext_blockšg_dÚe_â
, dev);

4168 
	`INIT_WORK
(&
dev
->
ext_block”s_wÜk
, 
sc¡_ext_blockšg_dÚe_â
);

4170 
dev
->
dev_doubË_ua_possibË
 = 1;

4171 
dev
->
queue_®g
 = 
SCST_QUEUE_ALG_1_UNRESTRICTED_REORDER
;

4173 
	`sc¡_´_š™
(
dev
);

4175 
	`BUILD_BUG_ON
(
SCST_DIF_NO_CHECK_APP_TAG
 != 0);

4176 
dev
->
dev_dif_¡©ic_­p_g
 = 
SCST_DIF_NO_CHECK_APP_TAG
;

4177 
dev
->
dev_dif_¡©ic_­p_»f_g
 = 
SCST_DIF_NO_CHECK_APP_TAG
;

4178 
dev
->
dev_dif_â
 = 
sc¡_dif_nÚe
;

4180 
	`sc¡_š™_Üd”_d©a
(&
dev
->
dev_Üd”_d©a
);

4182 
	`sc¡_š™_th»ads
(&
dev
->
dev_cmd_th»ads
);

4184 *
out_dev
 = 
dev
;

4186 
out
:

4187 
	`TRACE_EXIT_RES
(
»s
);

4188  
»s
;

4189 
	}
}

4191 
	$sc¡_ä“_deviû
(
sc¡_deviû
 *
dev
)

4193 
	`TRACE_ENTRY
();

4195 
	`EXTRACHECKS_BUG_ON
(
dev
->
dev_scsi_©omic_cmd_aùive
 != 0);

4196 
	`EXTRACHECKS_BUG_ON
(!
	`li¡_em±y
(&
dev
->
dev_exec_cmd_li¡
));

4198 #ifdeà
CONFIG_SCST_EXTRACHECKS


4199 ià(!
	`li¡_em±y
(&
dev
->
dev_tgt_dev_li¡
) ||

4200 !
	`li¡_em±y
(&
dev
->
dev_acg_dev_li¡
)) {

4201 
	`PRINT_CRIT_ERROR
("%s: dev_tgt_dev_list or dev_acg_dev_list "

4202 "i nÙƒm±y!", 
__func__
);

4203 
	`sBUG
();

4208 
	`æush_scheduËd_wÜk
();

4210 
	`sc¡_deš™_th»ads
(&
dev
->
dev_cmd_th»ads
);

4212 
	`sc¡_´_þ—nup
(
dev
);

4214 
	`kä“
(
dev
->
vœt_Çme
);

4215 
	`kmem_ÿche_ä“
(
sc¡_dev_ÿch•
, 
dev
);

4217 
	`TRACE_EXIT
();

4219 
	}
}

4221 
boÞ
 
	$sc¡_deviû_is_expÜ‹d
(
sc¡_deviû
 *
dev
)

4223 
	`lockd•_as£¹_h–d
(&
sc¡_mu‹x
);

4225 
	`WARN_ON_ONCE
(!
dev
->
dev_tgt_dev_li¡
.
Ãxt
);

4227  !
	`li¡_em±y
(&
dev
->
dev_tgt_dev_li¡
);

4228 
	}
}

4237 
	$sc¡_š™_mem_lim
(
sc¡_mem_lim
 *
mem_lim
)

4239 
	`©omic_£t
(&
mem_lim
->
®loûd_·ges
, 0);

4240 
mem_lim
->
max_®lowed_·ges
 =

4241 ((
ušt64_t
)
sc¡_max_dev_cmd_mem
 << 10è>> (
PAGE_SHIFT
 - 10);

4242 
	}
}

4243 
EXPORT_SYMBOL_GPL
(
sc¡_š™_mem_lim
);

4245 
sc¡_acg_dev
 *
	$sc¡_®loc_acg_dev
(
sc¡_acg
 *
acg
,

4246 
sc¡_deviû
 *
dev
, 
ušt64_t
 
lun
)

4248 
sc¡_acg_dev
 *
»s
;

4250 
	`TRACE_ENTRY
();

4252 
»s
 = 
	`kmem_ÿche_z®loc
(
sc¡_acgd_ÿch•
, 
GFP_KERNEL
);

4253 ià(
»s
 =ð
NULL
) {

4254 
	`PRINT_ERROR
("%s", "Allocation of scst_acg_dev failed");

4255 
out
;

4258 
»s
->
dev
 = dev;

4259 
»s
->
acg
 =‡cg;

4260 
»s
->
lun
 =†un;

4262 
out
:

4263 
	`TRACE_EXIT_HRES
(
»s
);

4264  
»s
;

4265 
	}
}

4271 
	$sc¡_d–_acg_dev
(
sc¡_acg_dev
 *
acg_dev
, 
boÞ
 
d–_sysfs
)

4273 
	`TRACE_DBG
("Removšg‡cg_dev %°äom dev_acg_dev_li¡", 
acg_dev
);

4274 
	`li¡_d–
(&
acg_dev
->
dev_acg_dev_li¡_’Œy
);

4276 ià(
d–_sysfs
)

4277 
	`sc¡_acg_dev_sysfs_d–
(
acg_dev
);

4278 
	}
}

4284 
	$sc¡_ä“_acg_dev
(
sc¡_acg_dev
 *
acg_dev
)

4286 
	`kmem_ÿche_ä“
(
sc¡_acgd_ÿch•
, 
acg_dev
);

4287 
	}
}

4293 
	$sc¡_d–_ä“_acg_dev
(
sc¡_acg_dev
 *
acg_dev
, 
boÞ
 
d–_sysfs
)

4295 
	`TRACE_ENTRY
();

4296 
	`TRACE_DBG
("Removšg‡cg_dev %°äom‡cg_dev_li¡", 
acg_dev
);

4297 
	`li¡_d–
(&
acg_dev
->
acg_dev_li¡_’Œy
);

4298 
	`sc¡_d–_acg_dev
(
acg_dev
, 
d–_sysfs
);

4299 
	`sc¡_ä“_acg_dev
(
acg_dev
);

4300 
	`TRACE_EXIT
();

4302 
	}
}

4304 
	$sc¡_check_dif_com·tibž™y
(cÚ¡ 
sc¡_acg
 *
acg
,

4305 cÚ¡ 
sc¡_deviû
 *
dev
)

4307 
»s
 = -
EINVAL
;

4308 
sc¡_tgt
 *
tgt
;

4309 cÚ¡ *
p
;

4310 
boÞ
 
suµÜ‹d
;

4312 
	`TRACE_ENTRY
();

4314 ià(
dev
->
dev_dif_mode
 =ð
SCST_DIF_MODE_NONE
)

4315 
out_ok
;

4317 
tgt
 = 
acg
->tgt;

4319 ià(!
tgt
->
tgt_dif_suµÜ‹d
) {

4320 
	`PRINT_ERROR
("Target %s doesn't support T10-PI (device %s)",

4321 
tgt
->
tgt_Çme
, 
dev
->
vœt_Çme
);

4322 
out
;

4325 ià(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_TGT
) {

4326 ià((
dev
->
dev_dif_ty³
 =ð1è&& !
tgt
->
tgt_hw_dif_ty³1_suµÜ‹d
) {

4327 
	`PRINT_ERROR
("Target %s doesn't supportype 1 "

4328 "´ÙeùiÚ TGT mod(deviû %s)", 
tgt
->
tgt_Çme
,

4329 
dev
->
vœt_Çme
);

4330 
out
;

4333 ià((
dev
->
dev_dif_ty³
 =ð2è&& !
tgt
->
tgt_hw_dif_ty³2_suµÜ‹d
) {

4334 
	`PRINT_ERROR
("Target %s doesn't supportype 2 "

4335 "´ÙeùiÚ TGT mod(deviû %s)", 
tgt
->
tgt_Çme
,

4336 
dev
->
vœt_Çme
);

4337 
out
;

4340 ià((
dev
->
dev_dif_ty³
 =ð3è&& !
tgt
->
tgt_hw_dif_ty³3_suµÜ‹d
) {

4341 
	`PRINT_ERROR
("Target %s doesn't supportype 3 "

4342 "´ÙeùiÚ TGT mod(deviû %s)", 
tgt
->
tgt_Çme
,

4343 
dev
->
vœt_Çme
);

4344 
out
;

4348 ià(
tgt
->
tgt_suµÜ‹d_dif_block_sizes
 =ð
NULL
)

4349 
out_ok
;

4351 
p
 = 
tgt
->
tgt_suµÜ‹d_dif_block_sizes
;

4352 
suµÜ‹d
 = 
çl£
;

4353 *
p
 != 0) {

4354 ià(*
p
 =ð
dev
->
block_size
) {

4355 
suµÜ‹d
 = 
Œue
;

4358 
p
++;

4360 ià(!
suµÜ‹d
) {

4361 
	`PRINT_ERROR
("Target %s doesn't support block size %d of "

4362 "deviû %s", 
tgt
->
tgt_Çme
, 
dev
->
block_size
, dev->
vœt_Çme
);

4363 
out
;

4366 
out_ok
:

4367 
»s
 = 0;

4369 
out
:

4370 
	`TRACE_EXIT_RES
(
»s
);

4371  
»s
;

4372 
	}
}

4375 
	$sc¡_acg_add_lun
(
sc¡_acg
 *
acg
, 
kobjeù
 *
·»Á
,

4376 
sc¡_deviû
 *
dev
, 
ušt64_t
 
lun
, 
æags
,

4377 
sc¡_acg_dev
 **
out_acg_dev
)

4379 
»s
;

4380 
sc¡_acg_dev
 *
acg_dev
;

4381 
sc¡_tgt_dev
 *
tgt_dev
, *
‰
;

4382 
sc¡_£ssiÚ
 *
£ss
;

4383 
	`LIST_HEAD
(
tmp_tgt_dev_li¡
);

4385 
	`TRACE_ENTRY
();

4387 
	`INIT_LIST_HEAD
(&
tmp_tgt_dev_li¡
);

4389 
»s
 = 
	`sc¡_check_dif_com·tibž™y
(
acg
, 
dev
);

4390 ià(
»s
 != 0)

4391 
out
;

4393 
acg_dev
 = 
	`sc¡_®loc_acg_dev
(
acg
, 
dev
, 
lun
);

4394 ià(
acg_dev
 =ð
NULL
) {

4395 
»s
 = -
ENOMEM
;

4396 
out
;

4398 
acg_dev
->
acg_dev_rd_Úly
 = ((
æags
 & 
SCST_ADD_LUN_READ_ONLY
) != 0);

4399 ià(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV_STORE
) {

4401 
acg_dev
->
acg_dev_dif_gu¬d_fÜm©
 = 
SCST_DIF_GUARD_FORMAT_CRC
;

4403 
acg_dev
->
acg_dev_dif_gu¬d_fÜm©
 =

4404 
acg
->
tgt
->
tgt_hw_dif__suµÜ‹d
 && !
dev
->
dev_dif__nÙ_suµÜ‹d
 ?

4405 
SCST_DIF_GUARD_FORMAT_IP
 :

4406 
SCST_DIF_GUARD_FORMAT_CRC
;

4408 
	`TRACE_DBG
("Adding‡cg_dev %po‡cg_dev_list‡nd dev_acg_dev_list",

4409 
acg_dev
);

4410 
	`li¡_add_ž
(&
acg_dev
->
acg_dev_li¡_’Œy
, &
acg
->
acg_dev_li¡
);

4411 
	`li¡_add_ž
(&
acg_dev
->
dev_acg_dev_li¡_’Œy
, &
dev
->
dev_acg_dev_li¡
);

4413 ià(!(
æags
 & 
SCST_ADD_LUN_CM
)) {

4414 
»s
 = 
	`sc¡_cm_Ú_add_lun
(
acg_dev
, 
lun
, &
æags
);

4415 ià(
»s
 != 0)

4416 
out_ä“
;

4419 
	`li¡_fÜ_—ch_’Œy
(
£ss
, &
acg
->
acg_£ss_li¡
, 
acg_£ss_li¡_’Œy
) {

4420 
»s
 = 
	`sc¡_®loc_add_tgt_dev
(
£ss
, 
acg_dev
, &
tgt_dev
);

4421 ià(
»s
 =ð-
EPERM
)

4423 ià(
»s
 != 0)

4424 
out_ä“
;

4426 
	`li¡_add_ž
(&
tgt_dev
->
exŒa_tgt_dev_li¡_’Œy
,

4427 &
tmp_tgt_dev_li¡
);

4430 
»s
 = 
	`sc¡_acg_dev_sysfs_ü—‹
(
acg_dev
, 
·»Á
);

4431 ià(
»s
 != 0)

4432 
out_Ú_d–
;

4434 ià(
æags
 & 
SCST_ADD_LUN_GEN_UA
)

4435 
	`sc¡_»pÜt_luns_chªged
(
acg
);

4437 
	`PRINT_INFO
("Added device %so group %s (LUN %lld, "

4438 "æag 0x%xètØrg‘ %s", 
dev
->
vœt_Çme
, 
acg
->
acg_Çme
,

4439 
lun
, 
æags
, 
acg
->
tgt
 ?‡cg->tgt->
tgt_Çme
 : "?");

4441 ià(
out_acg_dev
 !ð
NULL
)

4442 *
out_acg_dev
 = 
acg_dev
;

4444 
out
:

4445 
	`TRACE_EXIT_RES
(
»s
);

4446  
»s
;

4448 
out_Ú_d–
:

4449 ià(!(
æags
 & 
SCST_ADD_LUN_CM
))

4450 
	`sc¡_cm_Ú_d–_lun
(
acg_dev
, 
çl£
);

4452 
out_ä“
:

4453 
	`li¡_fÜ_—ch_’Œy_§ã
(
tgt_dev
, 
‰
, &
tmp_tgt_dev_li¡
,

4454 
exŒa_tgt_dev_li¡_’Œy
) {

4455 
	`sc¡_ä“_tgt_dev
(
tgt_dev
);

4457 
	`sc¡_d–_ä“_acg_dev
(
acg_dev
, 
çl£
);

4458 
out
;

4459 
	}
}

4462 
	$sc¡_acg_d–_lun
(
sc¡_acg
 *
acg
, 
ušt64_t
 
lun
,

4463 
boÞ
 
g’_»pÜt_luns_chªged
)

4465 
»s
 = 0;

4466 
sc¡_acg_dev
 *
acg_dev
 = 
NULL
, *
a
;

4467 
sc¡_tgt_dev
 *
tgt_dev
, *
‰
;

4469 
	`TRACE_ENTRY
();

4471 
	`li¡_fÜ_—ch_’Œy
(
a
, &
acg
->
acg_dev_li¡
, 
acg_dev_li¡_’Œy
) {

4472 ià(
a
->
lun
 ==†un) {

4473 
acg_dev
 = 
a
;

4477 ià(
acg_dev
 =ð
NULL
) {

4478 
	`PRINT_ERROR
("Deviû i nÙ found iÀgrou°%s", 
acg
->
acg_Çme
);

4479 
»s
 = -
EINVAL
;

4480 
out
;

4483 
g’_»pÜt_luns_chªged
 = 
	`sc¡_cm_Ú_d–_lun
(
acg_dev
, gen_report_luns_changed);

4485 
	`li¡_fÜ_—ch_’Œy_§ã
(
tgt_dev
, 
‰
, &
acg_dev
->
dev
->
dev_tgt_dev_li¡
,

4486 
dev_tgt_dev_li¡_’Œy
) {

4487 ià(
tgt_dev
->
acg_dev
 ==‡cg_dev)

4488 
	`sc¡_ä“_tgt_dev
(
tgt_dev
);

4491 
	`sc¡_d–_ä“_acg_dev
(
acg_dev
, 
Œue
);

4493 ià(
g’_»pÜt_luns_chªged
)

4494 
	`sc¡_»pÜt_luns_chªged
(
acg
);

4496 
	`PRINT_INFO
("Removed LUN %lld from group %s (target %s)",

4497 
lun
, 
acg
->
acg_Çme
,‡cg->
tgt
 ?‡cg->tgt->
tgt_Çme
 : "?");

4499 
out
:

4500 
	`TRACE_EXIT_RES
(
»s
);

4501  
»s
;

4502 
	}
}

4505 
	$sc¡_®loc_add_acg
(
sc¡_tgt
 *
tgt
, cÚ¡ *
acg_Çme
,

4506 
boÞ
 
tgt_acg
, 
sc¡_acg
 **
out_acg
)

4508 
sc¡_acg
 *
acg
;

4509 
»s
;

4511 
	`TRACE_ENTRY
();

4513 
acg
 = 
	`kz®loc
((*acg), 
GFP_KERNEL
);

4514 ià(
acg
 =ð
NULL
) {

4515 
	`PRINT_ERROR
("%s", "Allocation of‡cg failed");

4516 
»s
 = -
ENOMEM
;

4517 
out
;

4520 
	`k»f_š™
(&
acg
->
acg_k»f
);

4521 
acg
->
tgt
 =gt;

4522 
	`INIT_LIST_HEAD
(&
acg
->
acg_dev_li¡
);

4523 
	`INIT_LIST_HEAD
(&
acg
->
acg_£ss_li¡
);

4524 
	`INIT_LIST_HEAD
(&
acg
->
aú_li¡
);

4525 
	`ýumask_cÝy
(&
acg
->
acg_ýu_mask
, &
deçuÉ_ýu_mask
);

4526 
acg
->
acg_Çme
 = 
	`k¡rdup
×cg_Çme, 
GFP_KERNEL
);

4527 ià(
acg
->
acg_Çme
 =ð
NULL
) {

4528 
	`PRINT_ERROR
("%s", "Allocation of‡cg_name failed");

4529 
»s
 = -
ENOMEM
;

4530 
out_ä“
;

4533 
»s
 = 
	`sc¡_cm_Ú_add_acg
(
acg
);

4534 ià(
»s
 != 0)

4535 
out_undup
;

4537 #ifdeà
CONFIG_SCST_PROC


4538 
acg
->
addr_m‘hod
 = 
tgt
 &&gt->
tg‰
 ?gt->tg‰->
´eã¼ed_addr_m‘hod


4539 : 
SCST_LUN_ADDR_METHOD_PERIPHERAL
;

4541 
	`TRACE_DBG
("Addšg‡cg % tØsc¡_acg_li¡", 
acg_Çme
);

4542 
	`li¡_add_ž
(&
acg
->
acg_li¡_’Œy
, &
sc¡_acg_li¡
);

4544 
	`sc¡_check_»assign_£ssiÚs
();

4546 
acg
->
addr_m‘hod
 = 
tgt
->
tg‰
->
´eã¼ed_addr_m‘hod
;

4548 ià(
tgt_acg
) {

4549 
	`TRACE_DBG
("Addšg‡cg '%s'Ødeviû '%s'‡cg_li¡", 
acg_Çme
,

4550 
tgt
->
tgt_Çme
);

4551 
	`li¡_add_ž
(&
acg
->
acg_li¡_’Œy
, &
tgt
->
tgt_acg_li¡
);

4552 
acg
->
tgt_acg
 = 1;

4554 
»s
 = 
	`sc¡_acg_sysfs_ü—‹
(
tgt
, 
acg
);

4555 ià(
»s
 != 0)

4556 
out_d–
;

4559 
	`kobjeù_g‘
(&
tgt
->
tgt_kobj
);

4562 
»s
 = 0;

4564 
out
:

4565 *
out_acg
 = 
acg
;

4567 
	`TRACE_EXIT_RES
(
»s
);

4568  
»s
;

4570 #iâdeà
CONFIG_SCST_PROC


4571 
out_d–
:

4572 
	`li¡_d–
(&
acg
->
acg_li¡_’Œy
);

4575 
out_undup
:

4576 
	`kä“
(
acg
->
acg_Çme
);

4578 
out_ä“
:

4579 
	`kä“
(
acg
);

4580 
acg
 = 
NULL
;

4581 
out
;

4582 
	}
}

4592 
	$sc¡_d–_acg
(
sc¡_acg
 *
acg
)

4594 
sc¡_aú
 *
aú
, *
aút
;

4595 
sc¡_acg_dev
 *
acg_dev
, *
acg_dev_tmp
;

4597 
	`sc¡_as£¹_aùiv™y_su¥’ded
();

4598 
	`lockd•_as£¹_h–d
(&
sc¡_mu‹x
);

4600 
	`sc¡_cm_Ú_d–_acg
(
acg
);

4602 
	`li¡_fÜ_—ch_’Œy_§ã
(
acg_dev
, 
acg_dev_tmp
, &
acg
->
acg_dev_li¡
,

4603 
acg_dev_li¡_’Œy
)

4604 
	`sc¡_d–_acg_dev
(
acg_dev
, 
Œue
);

4606 
	`li¡_fÜ_—ch_’Œy_§ã
(
aú
, 
aút
, &
acg
->
aú_li¡
, 
aú_li¡_’Œy
)

4607 
	`sc¡_d–_aú
(
aú
);

4609 #ifdeà
CONFIG_SCST_PROC


4610 
	`li¡_d–
(&
acg
->
acg_li¡_’Œy
);

4612 ià(
acg
->
tgt_acg
) {

4613 
	`TRACE_DBG
("Removšg‡cg % äom†i¡", 
acg
->
acg_Çme
);

4614 
	`li¡_d–
(&
acg
->
acg_li¡_’Œy
);

4616 
	`sc¡_acg_sysfs_d–
(
acg
);

4618 
acg
->
tgt
->
deçuÉ_acg
 = 
NULL
;

4621 
	}
}

4628 
	$sc¡_ä“_acg
(
sc¡_acg
 *
acg
)

4630 
sc¡_acg_dev
 *
acg_dev
, *
acg_dev_tmp
;

4631 
sc¡_aú
 *
aú
, *
aút
;

4632 
sc¡_tgt
 *
tgt
 = 
acg
->tgt;

4634 
	`TRACE_DBG
("F»ešg‡cg %s/%s", 
tgt
->
tgt_Çme
, 
acg
->
acg_Çme
);

4636 
	`li¡_fÜ_—ch_’Œy_§ã
(
acg_dev
, 
acg_dev_tmp
, &
acg
->
acg_dev_li¡
,

4637 
acg_dev_li¡_’Œy
) {

4638 
sc¡_tgt_dev
 *
tgt_dev
, *
‰
;

4640 
	`li¡_fÜ_—ch_’Œy_§ã
(
tgt_dev
, 
‰
,

4641 &
acg_dev
->
dev
->
dev_tgt_dev_li¡
,

4642 
dev_tgt_dev_li¡_’Œy
) {

4643 ià(
tgt_dev
->
acg_dev
 ==‡cg_dev)

4644 
	`sc¡_ä“_tgt_dev
(
tgt_dev
);

4646 
	`sc¡_ä“_acg_dev
(
acg_dev
);

4649 
	`li¡_fÜ_—ch_’Œy_§ã
(
aú
, 
aút
, &
acg
->
aú_li¡
, 
aú_li¡_’Œy
) {

4650 
	`sc¡_ä“_aú
(
aú
,

4651 
	`li¡_is_Ï¡
(&
aú
->
aú_li¡_’Œy
, &
acg
->
aú_li¡
));

4654 
	`kä“
(
acg
->
acg_Çme
);

4655 
	`kä“
(
acg
);

4657 #iâdeà
CONFIG_SCST_PROC


4658 
	`kobjeù_put
(&
tgt
->
tgt_kobj
);

4660 
	}
}

4662 
	$sc¡_»Ëa£_acg
(
k»f
 *kref)

4664 
sc¡_acg
 *
acg
 = 
	`cÚš”_of
(
k»f
, sc¡_acg, 
acg_k»f
);

4666 
	`sc¡_ä“_acg
(
acg
);

4667 
	}
}

4669 
	ssc¡_acg_put_wÜk
 {

4670 
wÜk_¡ruù
 
	mwÜk
;

4671 
sc¡_acg
 *
	macg
;

4674 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 20)

4675 
	$sc¡_put_acg_wÜk
(*
p
)

4677 
sc¡_acg_put_wÜk
 *
put_wÜk
 = 
p
;

4679 
	$sc¡_put_acg_wÜk
(
wÜk_¡ruù
 *
wÜk
)

4681 
sc¡_acg_put_wÜk
 *
put_wÜk
 =

4682 
	`cÚš”_of
(
wÜk
, 
	`ty³of
(*
put_wÜk
), work);

4684 
sc¡_acg
 *
acg
 = 
put_wÜk
->acg;

4686 
	`kä“
(
put_wÜk
);

4687 
	`k»f_put
(&
acg
->
acg_k»f
, 
sc¡_»Ëa£_acg
);

4688 
	}
}

4690 
	$sc¡_put_acg
(
sc¡_acg
 *
acg
)

4692 
sc¡_acg_put_wÜk
 *
put_wÜk
;

4694 
put_wÜk
 = 
	`km®loc
((*put_wÜk), 
GFP_KERNEL
 | 
__GFP_NOFAIL
);

4695 ià(
	`WARN_ON_ONCE
(!
put_wÜk
)) {

4696 
	`k»f_put
(&
acg
->
acg_k»f
, 
sc¡_»Ëa£_acg
);

4700 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 20)

4701 
	`INIT_WORK
(&
put_wÜk
->
wÜk
, 
sc¡_put_acg_wÜk
,…ut_work);

4703 
	`INIT_WORK
(&
put_wÜk
->
wÜk
, 
sc¡_put_acg_wÜk
);

4705 
put_wÜk
->
acg
 =‡cg;

4711 
	`WARN_ON_ONCE
(!
	`queue_wÜk
(
sc¡_»Ëa£_acg_wq
, &
put_wÜk
->
wÜk
));

4712 
	}
}

4714 
	$sc¡_g‘_acg
(
sc¡_acg
 *
acg
)

4716 
	`k»f_g‘
(&
acg
->
acg_k»f
);

4717 
	}
}

4728 
	$sc¡_d–_ä“_acg
(
sc¡_acg
 *
acg
, 
boÞ
 
þo£_£ssiÚs
)

4730 
sc¡_tgt
 *
tgt
 = 
acg
->tgt;

4731 
sc¡_£ssiÚ
 *
£ss
, *
£ss_tmp
;

4733 
	`sc¡_as£¹_aùiv™y_su¥’ded
();

4734 
	`lockd•_as£¹_h–d
(&
sc¡_mu‹x
);

4736 ià((!
þo£_£ssiÚs
 && !
	`li¡_em±y
(&
acg
->
acg_£ss_li¡
)) ||

4737 (
þo£_£ssiÚs
 && !
tgt
->
tg‰
->
þo£_£ssiÚ
))

4738  -
EBUSY
;

4740 
	`sc¡_d–_acg
(
acg
);

4742 ià(
þo£_£ssiÚs
) {

4743 
	`TRACE_DBG
("Closšg sessiÚ fÜ grou°%s/%s", 
tgt
->
tgt_Çme
,

4744 
acg
->
acg_Çme
);

4745 
	`li¡_fÜ_—ch_’Œy_§ã
(
£ss
, 
£ss_tmp
, &
acg
->
acg_£ss_li¡
,

4746 
acg_£ss_li¡_’Œy
) {

4747 
	`TRACE_DBG
("Closšg sessiÚ %s/%s/%s", 
tgt
->
tgt_Çme
,

4748 
acg
->
acg_Çme
, 
£ss
->
š™ŸtÜ_Çme
);

4749 
tgt
->
tg‰
->
	`þo£_£ssiÚ
(
£ss
);

4753 
	`sc¡_put_acg
(
acg
);

4756 
	}
}

4758 #iâdeà
CONFIG_SCST_PROC


4761 
sc¡_acg
 *
	$sc¡_tgt_fšd_acg
(
sc¡_tgt
 *
tgt
, cÚ¡ *
Çme
)

4763 
sc¡_acg
 *
acg
, *
acg_»t
 = 
NULL
;

4765 
	`TRACE_ENTRY
();

4767 
	`li¡_fÜ_—ch_’Œy
(
acg
, &
tgt
->
tgt_acg_li¡
, 
acg_li¡_’Œy
) {

4768 ià(
	`¡rcmp
(
acg
->
acg_Çme
, 
Çme
) == 0) {

4769 
acg_»t
 = 
acg
;

4774 
	`TRACE_EXIT
();

4775  
acg_»t
;

4776 
	}
}

4781 
sc¡_tgt_dev
 *
	$sc¡_fšd_sh¬ed_io_tgt_dev
(

4782 
sc¡_tgt_dev
 *
tgt_dev
)

4784 
sc¡_cmd_th»ads
 *
a
;

4785 
sc¡_tgt_dev
 *
»s
 = 
NULL
;

4786 
sc¡_£ssiÚ
 *
£ss
 = 
tgt_dev
->sess;

4787 
sc¡_acg
 *
acg
 = 
tgt_dev
->
acg_dev
->acg;

4788 
sc¡_tgt_dev
 *
t
;

4790 
	`TRACE_ENTRY
();

4792 
	`TRACE_DBG
("tgt_dev %s (acg %p, io_grouping_type %d)",

4793 
£ss
->
š™ŸtÜ_Çme
, 
acg
,‡cg->
acg_io_groupšg_ty³
);

4795 
acg
->
acg_io_groupšg_ty³
) {

4796 
SCST_IO_GROUPING_AUTO
:

4797 ià(
£ss
->
š™ŸtÜ_Çme
 =ð
NULL
)

4798 
out
;

4800 
	`li¡_fÜ_—ch_’Œy
(
t
, &
tgt_dev
->
dev
->
dev_tgt_dev_li¡
,

4801 
dev_tgt_dev_li¡_’Œy
) {

4802 ià((
t
 =ð
tgt_dev
) ||

4803 (
t
->
£ss
->
š™ŸtÜ_Çme
 =ð
NULL
) ||

4804 (
t
->
aùive_cmd_th»ads
 =ð
NULL
))

4807 
	`TRACE_DBG
("ˆ%s", 
t
->
£ss
->
š™ŸtÜ_Çme
);

4811 ià(
	`¡rcmp
(
t
->
£ss
->
š™ŸtÜ_Çme
,

4812 
£ss
->
š™ŸtÜ_Çme
) == 0)

4813 
found
;

4817 
SCST_IO_GROUPING_THIS_GROUP_ONLY
:

4818 
	`li¡_fÜ_—ch_’Œy
(
t
, &
tgt_dev
->
dev
->
dev_tgt_dev_li¡
,

4819 
dev_tgt_dev_li¡_’Œy
) {

4820 ià((
t
 =ð
tgt_dev
è|| (t->
aùive_cmd_th»ads
 =ð
NULL
))

4823 
	`TRACE_DBG
("ˆ% ×cg %p)", 
t
->
£ss
->
š™ŸtÜ_Çme
,

4824 
t
->
acg_dev
->
acg
);

4826 ià(
t
->
acg_dev
->
acg
 ==‡cg)

4827 
found
;

4831 
SCST_IO_GROUPING_NEVER
:

4832 
out
;

4835 
	`li¡_fÜ_—ch_’Œy
(
t
, &
tgt_dev
->
dev
->
dev_tgt_dev_li¡
,

4836 
dev_tgt_dev_li¡_’Œy
) {

4837 ià((
t
 =ð
tgt_dev
è|| (t->
aùive_cmd_th»ads
 =ð
NULL
))

4840 
	`TRACE_DBG
("t %s (acg %p, io_grouping_type %d)",

4841 
t
->
£ss
->
š™ŸtÜ_Çme
,->
acg_dev
->
acg
,

4842 
t
->
acg_dev
->
acg
->
acg_io_groupšg_ty³
);

4844 ià(
t
->
acg_dev
->
acg
->
acg_io_groupšg_ty³
 ==

4845 
acg
->
acg_io_groupšg_ty³
)

4846 
found
;

4851 
out
:

4852 
	`TRACE_EXIT_HRES
(()
»s
);

4853  
»s
;

4855 
found
:

4856 
»s
 = 
t
;

4857 
a
 = 
t
->
aùive_cmd_th»ads
;

4858 ià(
a
 =ð&
sc¡_maš_cmd_th»ads
) {

4859 
	`TRACE_DBG
("Goingo share‡sync IO context %p (res %p, "

4861 
t
->
aic_k“³r
->
aic
, 
»s
,->
£ss
->
š™ŸtÜ_Çme
,

4862 
t
->
dev
->
vœt_Çme
,

4863 
t
->
acg_dev
->
acg
->
acg_io_groupšg_ty³
);

4865 
	`wa™_ev’t
(
a
->
ioùx_wq
,‡->
io_cÚ‹xt_»ady
);

4866 
	`smp_rmb
();

4867 
	`TRACE_DBG
("Goingo share IO context %p (res %p, ini %s, "

4869 
»s
->
aùive_cmd_th»ads
->
io_cÚ‹xt
,„es,

4870 
t
->
£ss
->
š™ŸtÜ_Çme
,->
dev
->
vœt_Çme
,

4871 
t
->
aùive_cmd_th»ads
,

4872 
t
->
acg_dev
->
acg
->
acg_io_groupšg_ty³
);

4874 
out
;

4875 
	}
}

4877 
sc¡_dev_ty³_th»ads_poÞ_ty³
 
	$sc¡_·r£_th»ads_poÞ_ty³
(cÚ¡ *
p
,

4878 
Ën
)

4880 
sc¡_dev_ty³_th»ads_poÞ_ty³
 
»s
;

4882 ià(
	`¡ºÿ£cmp
(
p
, 
SCST_THREADS_POOL_PER_INITIATOR_STR
,

4883 
	`mš_t
(, 
	`¡¾’
(
SCST_THREADS_POOL_PER_INITIATOR_STR
),

4884 
Ën
)) == 0)

4885 
»s
 = 
SCST_THREADS_POOL_PER_INITIATOR
;

4886 ià(
	`¡ºÿ£cmp
(
p
, 
SCST_THREADS_POOL_SHARED_STR
,

4887 
	`mš_t
(, 
	`¡¾’
(
SCST_THREADS_POOL_SHARED_STR
),

4888 
Ën
)) == 0)

4889 
»s
 = 
SCST_THREADS_POOL_SHARED
;

4891 
	`PRINT_ERROR
("UnknowÀth»ad poÞy³ %s", 
p
);

4892 
»s
 = 
SCST_THREADS_POOL_TYPE_INVALID
;

4895  
»s
;

4896 
	}
}

4898 
	$sc¡_ioc_k“³r_th»ad
(*
¬g
)

4900 
sc¡_async_io_cÚ‹xt_k“³r
 *
aic_k“³r
 =

4901 (
sc¡_async_io_cÚ‹xt_k“³r
 *)
¬g
;

4903 
	`TRACE_ENTRY
();

4905 
	`TRACE_MGMT_DBG
("AIC %°k“³¸th»ad %  s¹ed", 
aic_k“³r
, 
cu¼’t
->
comm
);

4907 
cu¼’t
->
æags
 |ð
PF_NOFREEZE
;

4909 
	`sBUG_ON
(
aic_k“³r
->
aic
 !ð
NULL
);

4911 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 25)

4912 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(3, 3, 0)

4913 
aic_k“³r
->
aic
 = 
	`g‘_sk_io_cÚ‹xt
(
cu¼’t
, 
GFP_KERNEL
, 
NUMA_NO_NODE
);

4915 
aic_k“³r
->
aic
 = 
	`g‘_io_cÚ‹xt
(
GFP_KERNEL
, -1);

4918 
	`TRACE_DBG
("Alloced‚ew‡sync IO context %p (aic %p)",

4919 
aic_k“³r
->
aic
,‡ic_keeper);

4922 
	`put_io_cÚ‹xt
(
aic_k“³r
->
aic
);

4925 
aic_k“³r
->
aic_»ady
 = 
Œue
;

4926 
	`wake_up_®l
(&
aic_k“³r
->
aic_k“³r_wa™Q
);

4928 
	`wa™_ev’t_š‹¼u±ibË
(
aic_k“³r
->
aic_k“³r_wa™Q
,

4929 
	`kth»ad_should_¡Ý
());

4931 
	`TRACE_MGMT_DBG
("AIC %°k“³¸th»ad % fšished", 
aic_k“³r
,

4932 
cu¼’t
->
comm
);

4934 
	`TRACE_EXIT
();

4936 
	}
}

4939 
	$sc¡_tgt_dev_£tup_th»ads
(
sc¡_tgt_dev
 *
tgt_dev
)

4941 
»s
 = 0;

4942 
sc¡_£ssiÚ
 *
£ss
 = 
tgt_dev
->sess;

4943 
sc¡_tgt_‹m¶©e
 *
tg‰
 = 
£ss
->
tgt
->tgtt;

4944 
sc¡_deviû
 *
dev
 = 
tgt_dev
->dev;

4945 
sc¡_async_io_cÚ‹xt_k“³r
 *
aic_k“³r
;

4947 
	`TRACE_ENTRY
();

4949 ià(
dev
->
th»ads_num
 < 0)

4950 
out
;

4952 ià(
dev
->
th»ads_num
 == 0) {

4953 
sc¡_tgt_dev
 *
sh¬ed_io_tgt_dev
;

4955 
tgt_dev
->
aùive_cmd_th»ads
 = &
sc¡_maš_cmd_th»ads
;

4957 
sh¬ed_io_tgt_dev
 = 
	`sc¡_fšd_sh¬ed_io_tgt_dev
(
tgt_dev
);

4958 ià(
sh¬ed_io_tgt_dev
 !ð
NULL
) {

4959 
aic_k“³r
 = 
sh¬ed_io_tgt_dev
->aic_keeper;

4960 
	`k»f_g‘
(&
aic_k“³r
->
aic_k“³r_k»f
);

4962 
	`TRACE_DBG
("Linking‡sync io context %p "

4964 
aic_k“³r
->
aic
, 
tgt_dev
,

4965 
tgt_dev
->
dev
->
vœt_Çme
);

4968 
aic_k“³r
 = 
	`kz®loc
((*aic_k“³r), 
GFP_KERNEL
);

4969 ià(
aic_k“³r
 =ð
NULL
) {

4970 
	`PRINT_ERROR
("Unableo‡lloc‡ic_keeper "

4971 "(siz%zd)", (*
aic_k“³r
));

4972 
»s
 = -
ENOMEM
;

4973 
out
;

4976 
	`k»f_š™
(&
aic_k“³r
->
aic_k“³r_k»f
);

4977 
	`š™_wa™queue_h—d
(&
aic_k“³r
->
aic_k“³r_wa™Q
);

4979 
aic_k“³r
->
aic_k“³r_thr
 =

4980 
	`kth»ad_run
(
sc¡_ioc_k“³r_th»ad
,

4981 
aic_k“³r
, "aic_keeper");

4982 ià(
	`IS_ERR
(
aic_k“³r
->
aic_k“³r_thr
)) {

4983 
	`PRINT_ERROR
("Error„unning ioc_keeper "

4984 "th»ad (tgt_dev %p)", 
tgt_dev
);

4985 
»s
 = 
	`PTR_ERR
(
aic_k“³r
->
aic_k“³r_thr
);

4986 
out_ä“_k“³r
;

4989 
	`wa™_ev’t
(
aic_k“³r
->
aic_k“³r_wa™Q
,

4990 
aic_k“³r
->
aic_»ady
);

4992 
	`TRACE_DBG
("Created‡sync io context %p "

4994 
aic_k“³r
->
aic
, 
tgt_dev
,

4995 
tgt_dev
->
dev
->
vœt_Çme
);

4998 
tgt_dev
->
async_io_cÚ‹xt
 = 
aic_k“³r
->
aic
;

4999 
tgt_dev
->
aic_k“³r
 =‡ic_keeper;

5001 
»s
 = 
	`sc¡_add_th»ads
(
tgt_dev
->
aùive_cmd_th»ads
, 
NULL
, NULL,

5002 
tg‰
->
th»ads_num
);

5003 
out
;

5006 
dev
->
th»ads_poÞ_ty³
) {

5007 
SCST_THREADS_POOL_PER_INITIATOR
:

5009 
sc¡_tgt_dev
 *
sh¬ed_io_tgt_dev
;

5011 
	`sc¡_š™_th»ads
(&
tgt_dev
->
tgt_dev_cmd_th»ads
);

5013 
tgt_dev
->
aùive_cmd_th»ads
 = &tgt_dev->
tgt_dev_cmd_th»ads
;

5015 
sh¬ed_io_tgt_dev
 = 
	`sc¡_fšd_sh¬ed_io_tgt_dev
(
tgt_dev
);

5016 ià(
sh¬ed_io_tgt_dev
 !ð
NULL
) {

5017 
	`TRACE_DBG
("Linking io context %p for "

5019 
sh¬ed_io_tgt_dev
->
aùive_cmd_th»ads
->
io_cÚ‹xt
,

5020 
tgt_dev
,gt_dev->
aùive_cmd_th»ads
);

5022 
tgt_dev
->
aùive_cmd_th»ads
->
io_cÚ‹xt
 =

5023 
sh¬ed_io_tgt_dev
->
aùive_cmd_th»ads
->
io_cÚ‹xt
;

5026 
»s
 = 
	`sc¡_add_th»ads
(
tgt_dev
->
aùive_cmd_th»ads
, 
NULL
,

5027 
tgt_dev
,

5028 
dev
->
th»ads_num
 + 
tg‰
->threads_num);

5029 ià(
»s
 != 0) {

5031 
tgt_dev
->
aùive_cmd_th»ads
->
io_cÚ‹xt
 = 
NULL
;

5035 
SCST_THREADS_POOL_SHARED
:

5037 
tgt_dev
->
aùive_cmd_th»ads
 = &
dev
->
dev_cmd_th»ads
;

5039 
»s
 = 
	`sc¡_add_th»ads
(
tgt_dev
->
aùive_cmd_th»ads
, 
dev
, 
NULL
,

5040 
tg‰
->
th»ads_num
);

5044 
	`PRINT_CRIT_ERROR
("Unknownhreads…oolype %d (dev %s)",

5045 
dev
->
th»ads_poÞ_ty³
, dev->
vœt_Çme
);

5046 
	`sBUG
();

5050 
out
:

5051 ià(
»s
 == 0)

5052 
	`tm_dbg_š™_tgt_dev
(
tgt_dev
);

5054 
	`TRACE_EXIT_RES
(
»s
);

5055  
»s
;

5057 
out_ä“_k“³r
:

5058 
	`kä“
(
aic_k“³r
);

5059 
out
;

5060 
	}
}

5062 
	$sc¡_aic_k“³r_»Ëa£
(
k»f
 *kref)

5064 
sc¡_async_io_cÚ‹xt_k“³r
 *
aic_k“³r
;

5066 
	`TRACE_ENTRY
();

5068 
aic_k“³r
 = 
	`cÚš”_of
(
k»f
, 
sc¡_async_io_cÚ‹xt_k“³r
,

5069 
aic_k“³r_k»f
);

5071 
	`kth»ad_¡Ý
(
aic_k“³r
->
aic_k“³r_thr
);

5073 
	`kä“
(
aic_k“³r
);

5075 
	`TRACE_EXIT
();

5077 
	}
}

5080 
	$sc¡_tgt_dev_¡Ý_th»ads
(
sc¡_tgt_dev
 *
tgt_dev
)

5082 
sc¡_tgt_‹m¶©e
 *
tg‰
 = 
tgt_dev
->
£ss
->
tgt
->tgtt;

5084 
	`TRACE_ENTRY
();

5086 ià(
tgt_dev
->
dev
->
th»ads_num
 < 0)

5087 
out_deš™
;

5089 ià(
tgt_dev
->
aùive_cmd_th»ads
 =ð&
sc¡_maš_cmd_th»ads
) {

5091 
	`k»f_put
(&
tgt_dev
->
aic_k“³r
->
aic_k“³r_k»f
,

5092 
sc¡_aic_k“³r_»Ëa£
);

5093 
tgt_dev
->
async_io_cÚ‹xt
 = 
NULL
;

5094 
tgt_dev
->
aic_k“³r
 = 
NULL
;

5095 } ià(
tgt_dev
->
aùive_cmd_th»ads
 =ð&tgt_dev->
dev
->
dev_cmd_th»ads
) {

5097 
	`sc¡_d–_th»ads
(
tgt_dev
->
aùive_cmd_th»ads
,

5098 
tg‰
->
th»ads_num
);

5099 } ià(
tgt_dev
->
aùive_cmd_th»ads
 =ð&tgt_dev->
tgt_dev_cmd_th»ads
) {

5101 
	`sc¡_d–_th»ads
(
tgt_dev
->
aùive_cmd_th»ads
, -1);

5102 
	`sc¡_deš™_th»ads
(&
tgt_dev
->
tgt_dev_cmd_th»ads
);

5105 
out_deš™
:

5106 
	`tm_dbg_deš™_tgt_dev
(
tgt_dev
);

5107 
tgt_dev
->
aùive_cmd_th»ads
 = 
NULL
;

5109 
	`TRACE_EXIT
();

5111 
	}
}

5113 
__be16
 
sc¡_dif_üc_â
(cÚ¡ *
d©a
, 
Ën
);

5114 
__be16
 
sc¡_dif__â
(cÚ¡ *
d©a
, 
Ën
);

5121 
	$sc¡_®loc_add_tgt_dev
(
sc¡_£ssiÚ
 *
£ss
,

5122 
sc¡_acg_dev
 *
acg_dev
, 
sc¡_tgt_dev
 **
out_tgt_dev
)

5124 
»s
 = 0;

5125 
sc¡_tgt_‹m¶©e
 *
tg‰
 = 
£ss
->
tgt
->tgtt;

5126 
ši_sg
, 
ši_unchecked_i§_dma
, 
ši_u£_þu¡”šg
;

5127 
sc¡_tgt_dev
 *
tgt_dev
;

5128 
sc¡_deviû
 *
dev
 = 
acg_dev
->dev;

5129 
li¡_h—d
 *
h—d
;

5130 
¦
;

5131 
ušt8_t
 
£n£_bufãr
[
SCST_STANDARD_SENSE_LEN
];

5133 
	`TRACE_ENTRY
();

5135 
tgt_dev
 = 
	`kmem_ÿche_z®loc
(
sc¡_tgtd_ÿch•
, 
GFP_KERNEL
);

5136 ià(
tgt_dev
 =ð
NULL
) {

5137 
	`PRINT_ERROR
("%s", "Allocation of scst_tgt_dev failed");

5138 
»s
 = -
ENOMEM
;

5139 
out
;

5142 
tgt_dev
->
dev
 = dev;

5143 
tgt_dev
->
lun
 = 
acg_dev
->lun;

5144 
tgt_dev
->
acg_dev
 =‡cg_dev;

5145 
tgt_dev
->
tgt_dev_rd_Úly
 = 
acg_dev
->
acg_dev_rd_Úly
 || 
dev
->
dev_rd_Úly
;

5146 ià(
£ss
->
tgt
->
tgt_fÜw¬dšg
)

5147 
	`£t_b™
(
SCST_TGT_DEV_FORWARDING
, &
tgt_dev
->
tgt_dev_æags
);

5149 
	`þ—r_b™
(
SCST_TGT_DEV_FORWARDING
, &
tgt_dev
->
tgt_dev_æags
);

5150 
tgt_dev
->
hw_dif_§me_sg_Ïyout_»quœed
 = 
£ss
->
tgt
->
tgt_hw_dif_§me_sg_Ïyout_»quœed
;

5151 
tgt_dev
->
tgt_dev_dif_gu¬d_fÜm©
 = 
acg_dev
->
acg_dev_dif_gu¬d_fÜm©
;

5152 ià(
tgt_dev
->
tgt_dev_dif_gu¬d_fÜm©
 =ð
SCST_DIF_GUARD_FORMAT_IP
)

5153 
tgt_dev
->
tgt_dev_dif_üc_â
 = 
sc¡_dif__â
;

5155 
	`EXTRACHECKS_BUG_ON
(
tgt_dev
->
tgt_dev_dif_gu¬d_fÜm©
 !ð
SCST_DIF_GUARD_FORMAT_CRC
);

5156 
tgt_dev
->
tgt_dev_dif_üc_â
 = 
sc¡_dif_üc_â
;

5158 
	`©omic_£t
(&
tgt_dev
->
tgt_dev_dif_­p_çžed_tgt
, 0);

5159 
	`©omic_£t
(&
tgt_dev
->
tgt_dev_dif_»f_çžed_tgt
, 0);

5160 
	`©omic_£t
(&
tgt_dev
->
tgt_dev_dif_gu¬d_çžed_tgt
, 0);

5161 
	`©omic_£t
(&
tgt_dev
->
tgt_dev_dif_­p_çžed_sc¡
, 0);

5162 
	`©omic_£t
(&
tgt_dev
->
tgt_dev_dif_»f_çžed_sc¡
, 0);

5163 
	`©omic_£t
(&
tgt_dev
->
tgt_dev_dif_gu¬d_çžed_sc¡
, 0);

5164 
	`©omic_£t
(&
tgt_dev
->
tgt_dev_dif_­p_çžed_dev
, 0);

5165 
	`©omic_£t
(&
tgt_dev
->
tgt_dev_dif_»f_çžed_dev
, 0);

5166 
	`©omic_£t
(&
tgt_dev
->
tgt_dev_dif_gu¬d_çžed_dev
, 0);

5168 
tgt_dev
->
£ss
 = sess;

5169 
	`©omic_£t
(&
tgt_dev
->
tgt_dev_cmd_couÁ
, 0);

5170 ià(
acg_dev
->
acg
->
acg_bÏck_hÞe_ty³
 !ð
SCST_ACG_BLACK_HOLE_NONE
)

5171 
	`£t_b™
(
SCST_TGT_DEV_BLACK_HOLE
, &
tgt_dev
->
tgt_dev_æags
);

5173 
	`þ—r_b™
(
SCST_TGT_DEV_BLACK_HOLE
, &
tgt_dev
->
tgt_dev_æags
);

5175 
	`sc¡_sgv_poÞ_u£_nÜm
(
tgt_dev
);

5177 ià(
dev
->
scsi_dev
 !ð
NULL
) {

5178 
ši_sg
 = 
dev
->
scsi_dev
->
ho¡
->
sg_bËsize
;

5179 
ši_unchecked_i§_dma
 = 
dev
->
scsi_dev
->
ho¡
->
unchecked_i§_dma
;

5180 
ši_u£_þu¡”šg
 = (
dev
->
scsi_dev
->
ho¡
->
u£_þu¡”šg
 ==

5181 
ENABLE_CLUSTERING
);

5183 
ši_sg
 = (1 << 15) ;

5184 
ši_unchecked_i§_dma
 = 0;

5185 
ši_u£_þu¡”šg
 = 0;

5187 
tgt_dev
->
max_sg_út
 = 
	`mš
(
ši_sg
, 
£ss
->
tgt
->
sg_bËsize
);

5189 ià((
£ss
->
tgt
->
tg‰
->
u£_þu¡”šg
 || 
ši_u£_þu¡”šg
) &&

5190 !
£ss
->
tgt
->
tg‰
->
no_þu¡”šg
 &&

5191 !(
£ss
->
tgt
->
tgt_hw_dif_§me_sg_Ïyout_»quœed
 &&

5192 (
tgt_dev
->
dev
->
dev_dif_ty³
 != 0)))

5193 
	`sc¡_sgv_poÞ_u£_nÜm_þu¡
(
tgt_dev
);

5195 ià(
£ss
->
tgt
->
tg‰
->
unchecked_i§_dma
 || 
ši_unchecked_i§_dma
)

5196 
	`sc¡_sgv_poÞ_u£_dma
(
tgt_dev
);

5198 
	`TRACE_MGMT_DBG
("Device %s on SCST†un=%lld",

5199 
dev
->
vœt_Çme
, ()
tgt_dev
->
lun
);

5201 
	`¥š_lock_š™
(&
tgt_dev
->
tgt_dev_lock
);

5202 
	`INIT_LIST_HEAD
(&
tgt_dev
->
UA_li¡
);

5204 
	`sc¡_š™_Üd”_d©a
(&
tgt_dev
->
tgt_dev_Üd”_d©a
);

5205 ià(
dev
->
t¡
 =ð
SCST_TST_1_SEP_TASK_SETS
)

5206 
tgt_dev
->
cu¼_Üd”_d©a
 = &tgt_dev->
tgt_dev_Üd”_d©a
;

5208 
tgt_dev
->
cu¼_Üd”_d©a
 = &
dev
->
dev_Üd”_d©a
;

5210 ià(
dev
->
hªdËr
->
·r£_©omic
 &&

5211 
dev
->
hªdËr
->
dev_®loc_d©a_buf_©omic
 &&

5212 (
£ss
->
tgt
->
tg‰
->
´•roûssšg_dÚe
 =ð
NULL
)) {

5213 ià(
£ss
->
tgt
->
tg‰
->
rdy_to_xãr_©omic
)

5214 
tgt_dev
->
tgt_dev_aá”_š™_wr_©omic
 = 1;

5216 ià(
dev
->
hªdËr
->
dev_dÚe_©omic
 &&

5217 
£ss
->
tgt
->
tg‰
->
xm™_»¥Ú£_©omic
)

5218 
tgt_dev
->
tgt_dev_aá”_exec_©omic
 = 1;

5220 
¦
 = 
	`sc¡_£t_£n£
(
£n£_bufãr
, (sense_buffer),

5221 
dev
->
d_£n£
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»£t_UA
));

5222 
	`sc¡_®loc_£t_UA
(
tgt_dev
, 
£n£_bufãr
, 
¦
, 0);

5224 ià(
£ss
->
tgt
->
tg‰
->
g‘_š™ŸtÜ_pÜt_Œª¥Üt_id
 =ð
NULL
) {

5225 ià(!
	`li¡_em±y
(&
dev
->
dev_»gi¡¿Ás_li¡
)) {

5226 
	`PRINT_WARNING
("Initiators fromarget %s can't connect "

5229 "P”si¡’ˆRe£rv©iÚs", 
£ss
->
tgt
->
tg‰
->
Çme
,

5230 
dev
->
vœt_Çme
);

5231 
»s
 = -
EPERM
;

5232 
out_ä“
;

5234 
dev
->
nÙ_´_suµÜtšg_tgt_devs_num
++;

5237 
»s
 = 
	`sc¡_´_š™_tgt_dev
(
tgt_dev
);

5238 ià(
»s
 != 0)

5239 
out_dec_ä“
;

5241 
»s
 = 
	`sc¡_tgt_dev_£tup_th»ads
(
tgt_dev
);

5242 ià(
»s
 != 0)

5243 
out_´_þ—r
;

5245 ià(
dev
->
hªdËr
->
©ch_tgt
) {

5246 
	`TRACE_DBG
("C®lšg dev hªdËr' ©ch_tgt(%p)", 
tgt_dev
);

5247 
»s
 = 
dev
->
hªdËr
->
	`©ch_tgt
(
tgt_dev
);

5248 
	`TRACE_DBG
("%s", "Dev handler's‡ttach_tgt()„eturned");

5249 ià(
»s
 != 0) {

5250 
	`PRINT_ERROR
("Device handler's %s‡ttach_tgt() "

5251 "çžed: %d", 
dev
->
hªdËr
->
Çme
, 
»s
);

5252 
out_¡Ý_th»ads
;

5256 
»s
 = 
	`sc¡_tgt_dev_sysfs_ü—‹
(
tgt_dev
);

5257 ià(
»s
 != 0)

5258 
out_d‘ach
;

5260 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

5261 
	`li¡_add_ž
(&
tgt_dev
->
dev_tgt_dev_li¡_’Œy
, &
dev
->
dev_tgt_dev_li¡
);

5262 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

5264 
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
	`SESS_TGT_DEV_LIST_HASH_FN
(
tgt_dev
->
lun
)];

5265 
	`li¡_add_ž
(&
tgt_dev
->
£ss_tgt_dev_li¡_’Œy
, 
h—d
);

5267 
	`sc¡_tg_š™_tgt_dev
(
tgt_dev
);

5269 *
out_tgt_dev
 = 
tgt_dev
;

5271 
out
:

5272 
	`TRACE_EXIT_RES
(
»s
);

5273  
»s
;

5275 
out_d‘ach
:

5276 ià(
dev
->
hªdËr
->
d‘ach_tgt
) {

5277 
	`TRACE_DBG
("Calling dev handler's detach_tgt(%p)",

5278 
tgt_dev
);

5279 
dev
->
hªdËr
->
	`d‘ach_tgt
(
tgt_dev
);

5280 
	`TRACE_DBG
("%s", "Dev handler's detach_tgt()„eturned");

5283 
out_¡Ý_th»ads
:

5284 
	`sc¡_tgt_dev_¡Ý_th»ads
(
tgt_dev
);

5286 
out_´_þ—r
:

5287 
	`sc¡_´_þ—r_tgt_dev
(
tgt_dev
);

5289 
out_dec_ä“
:

5290 ià(
tg‰
->
g‘_š™ŸtÜ_pÜt_Œª¥Üt_id
 =ð
NULL
)

5291 
dev
->
nÙ_´_suµÜtšg_tgt_devs_num
--;

5293 
out_ä“
:

5294 
	`sc¡_ä“_®l_UA
(
tgt_dev
);

5295 
	`kmem_ÿche_ä“
(
sc¡_tgtd_ÿch•
, 
tgt_dev
);

5296 
out
;

5297 
	}
}

5300 
	$sc¡_Ãxus_loss
(
sc¡_tgt_dev
 *
tgt_dev
, 
boÞ
 
queue_UA
)

5302 
	`TRACE_ENTRY
();

5304 ià(
queue_UA
) {

5305 
ušt8_t
 
£n£_bufãr
[
SCST_STANDARD_SENSE_LEN
];

5306 
¦
 = 
	`sc¡_£t_£n£
(
£n£_bufãr
, (sense_buffer),

5307 
tgt_dev
->
dev
->
d_£n£
,

5308 
	`SCST_LOAD_SENSE
(
sc¡_£n£_Ãxus_loss_UA
));

5309 
	`sc¡_check_£t_UA
(
tgt_dev
, 
£n£_bufãr
, 
¦
,

5310 
SCST_SET_UA_FLAG_AT_HEAD
);

5313 
	`TRACE_EXIT
();

5315 
	}
}

5321 
	$sc¡_ä“_tgt_dev
(
sc¡_tgt_dev
 *
tgt_dev
)

5323 
sc¡_tgt_‹m¶©e
 *
tg‰
 = 
tgt_dev
->
£ss
->
tgt
->tgtt;

5324 
sc¡_deviû
 *
dev
 = 
tgt_dev
->dev;

5326 
	`TRACE_ENTRY
();

5328 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

5329 
	`li¡_d–
(&
tgt_dev
->
dev_tgt_dev_li¡_’Œy
);

5330 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

5332 
	`li¡_d–
(&
tgt_dev
->
£ss_tgt_dev_li¡_’Œy
);

5334 
	`sc¡_tgt_dev_sysfs_d–
(
tgt_dev
);

5336 ià(
tg‰
->
g‘_š™ŸtÜ_pÜt_Œª¥Üt_id
 =ð
NULL
)

5337 
dev
->
nÙ_´_suµÜtšg_tgt_devs_num
--;

5339 
	`sc¡_þ—r_»£rv©iÚ
(
tgt_dev
);

5340 
	`sc¡_´_þ—r_tgt_dev
(
tgt_dev
);

5341 
	`sc¡_ä“_®l_UA
(
tgt_dev
);

5343 ià(
dev
->
hªdËr
 && dev->hªdËr->
d‘ach_tgt
) {

5344 
	`TRACE_DBG
("Calling dev handler's detach_tgt(%p)",

5345 
tgt_dev
);

5346 
dev
->
hªdËr
->
	`d‘ach_tgt
(
tgt_dev
);

5347 
	`TRACE_DBG
("%s", "Dev handler's detach_tgt()„eturned");

5350 
	`sc¡_tgt_dev_¡Ý_th»ads
(
tgt_dev
);

5352 
	`kmem_ÿche_ä“
(
sc¡_tgtd_ÿch•
, 
tgt_dev
);

5354 
	`TRACE_EXIT
();

5356 
	}
}

5359 
	$sc¡_£ss_®loc_tgt_devs
(
sc¡_£ssiÚ
 *
£ss
)

5361 
»s
 = 0;

5362 
sc¡_acg_dev
 *
acg_dev
;

5363 
sc¡_tgt_dev
 *
tgt_dev
;

5365 
	`TRACE_ENTRY
();

5367 
	`li¡_fÜ_—ch_’Œy
(
acg_dev
, &
£ss
->
acg
->
acg_dev_li¡
,

5368 
acg_dev_li¡_’Œy
) {

5369 
»s
 = 
	`sc¡_®loc_add_tgt_dev
(
£ss
, 
acg_dev
, &
tgt_dev
);

5370 ià(
»s
 =ð-
EPERM
)

5372 ià(
»s
 != 0)

5373 
out_ä“
;

5376 
out
:

5377 
	`TRACE_EXIT
();

5378  
»s
;

5380 
out_ä“
:

5381 
	`sc¡_£ss_ä“_tgt_devs
(
£ss
);

5382 
out
;

5383 
	}
}

5389 
	$sc¡_£ss_ä“_tgt_devs
(
sc¡_£ssiÚ
 *
£ss
)

5391 
i
;

5392 
sc¡_tgt_dev
 *
tgt_dev
, *
t
;

5394 
	`TRACE_ENTRY
();

5397 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

5398 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

5400 
	`li¡_fÜ_—ch_’Œy_§ã
(
tgt_dev
, 
t
, 
h—d
,

5401 
£ss_tgt_dev_li¡_’Œy
) {

5402 
	`sc¡_ä“_tgt_dev
(
tgt_dev
);

5404 
	`INIT_LIST_HEAD
(
h—d
);

5407 
	`TRACE_EXIT
();

5409 
	}
}

5412 
	$sc¡_acg_add_aú
(
sc¡_acg
 *
acg
, cÚ¡ *
Çme
)

5414 
»s
 = 0;

5415 
sc¡_aú
 *
aú
;

5416 *
nm
;

5418 
	`TRACE_ENTRY
();

5420 
	`li¡_fÜ_—ch_’Œy
(
aú
, &
acg
->
aú_li¡
, 
aú_li¡_’Œy
) {

5421 ià(
	`¡rcmp
(
aú
->
Çme
,‚ame) == 0) {

5422 
	`PRINT_ERROR
("Name %s‡lreadyƒxists in group %s",

5423 
Çme
, 
acg
->
acg_Çme
);

5424 
»s
 = -
EEXIST
;

5425 
out
;

5429 
aú
 = 
	`kz®loc
((*aú), 
GFP_KERNEL
);

5430 ià(
aú
 =ð
NULL
) {

5431 
	`PRINT_ERROR
("%s", "Unableo‡llocate scst_acn");

5432 
»s
 = -
ENOMEM
;

5433 
out
;

5436 
aú
->
acg
 =‡cg;

5438 
nm
 = 
	`k¡rdup
(
Çme
, 
GFP_KERNEL
);

5439 ià(
nm
 =ð
NULL
) {

5440 
	`PRINT_ERROR
("%s", "Unableo‡llocate scst_acn->name");

5441 
»s
 = -
ENOMEM
;

5442 
out_ä“
;

5444 
aú
->
Çme
 = 
nm
;

5446 
»s
 = 
	`sc¡_aú_sysfs_ü—‹
(
aú
);

5447 ià(
»s
 != 0)

5448 
out_ä“_nm
;

5450 
	`li¡_add_ž
(&
aú
->
aú_li¡_’Œy
, &
acg
->
aú_li¡
);

5452 
out
:

5453 ià(
»s
 == 0) {

5454 
	`PRINT_INFO
("Added‚am% tØgrou°% Ñ¬g‘ %s)", 
Çme
,

5455 
acg
->
acg_Çme
,‡cg->
tgt
 ?‡cg->tgt->
tgt_Çme
 : "?");

5456 
	`sc¡_check_»assign_£ssiÚs
();

5459 
	`TRACE_EXIT_RES
(
»s
);

5460  
»s
;

5462 
out_ä“_nm
:

5463 
	`kä“
(
nm
);

5465 
out_ä“
:

5466 
	`kä“
(
aú
);

5467 
out
;

5468 
	}
}

5471 
	$sc¡_d–_aú
(
sc¡_aú
 *
aú
)

5473 
	`li¡_d–
(&
aú
->
aú_li¡_’Œy
);

5475 
	`sc¡_aú_sysfs_d–
(
aú
);

5476 
	}
}

5479 
	$sc¡_ä“_aú
(
sc¡_aú
 *
aú
, 
boÞ
 
»assign
)

5481 
	`kä“
(
aú
->
Çme
);

5482 
	`kä“
(
aú
);

5484 ià(
»assign
)

5485 
	`sc¡_check_»assign_£ssiÚs
();

5486 
	}
}

5489 
	$sc¡_d–_ä“_aú
(
sc¡_aú
 *
aú
, 
boÞ
 
»assign
)

5491 
	`TRACE_ENTRY
();

5492 
	`sc¡_d–_aú
(
aú
);

5493 
	`sc¡_ä“_aú
(
aú
, 
»assign
);

5494 
	`TRACE_EXIT
();

5496 
	}
}

5499 
sc¡_aú
 *
	$sc¡_fšd_aú
(
sc¡_acg
 *
acg
, cÚ¡ *
Çme
)

5501 
sc¡_aú
 *
aú
;

5503 
	`TRACE_ENTRY
();

5505 
	`TRACE_DBG
("TryšgØfšd‚am'%s'", 
Çme
);

5507 
	`li¡_fÜ_—ch_’Œy
(
aú
, &
acg
->
aú_li¡
, 
aú_li¡_’Œy
) {

5508 ià(
	`¡rcmp
(
aú
->
Çme
,‚ame) == 0) {

5509 
	`TRACE_DBG
("%s", "Found");

5510 
out
;

5513 
aú
 = 
NULL
;

5514 
out
:

5515 
	`TRACE_EXIT
();

5516  
aú
;

5517 
	}
}

5519 #ifdeà
CONFIG_SCST_PROC


5521 
	$sc¡_acg_»move_Çme
(
sc¡_acg
 *
acg
, cÚ¡ *
Çme
, 
boÞ
 
»assign
)

5523 
»s
 = -
EINVAL
;

5524 
sc¡_aú
 *
aú
;

5526 
	`TRACE_ENTRY
();

5528 
	`li¡_fÜ_—ch_’Œy
(
aú
, &
acg
->
aú_li¡
, 
aú_li¡_’Œy
) {

5529 ià(
	`¡rcmp
(
aú
->
Çme
,‚ame) == 0) {

5530 
	`sc¡_d–_ä“_aú
(
aú
, 
çl£
);

5531 
»s
 = 0;

5536 ià(
»s
 == 0) {

5537 
	`PRINT_INFO
("Removed‚am% äom grou°% Ñ¬g‘ %s)", 
Çme
,

5538 
acg
->
acg_Çme
,‡cg->
tgt
 ?‡cg->tgt->
tgt_Çme
 : "?");

5539 ià(
»assign
)

5540 
	`sc¡_check_»assign_£ssiÚs
();

5542 
	`PRINT_ERROR
("UÇbËØfšd‚am'%s' iÀgrou°'%s'", 
Çme
,

5543 
acg
->
acg_Çme
);

5545 
	`TRACE_EXIT_RES
(
»s
);

5546  
»s
;

5547 
	}
}

5550 
sc¡_cmd
 *
	$__sc¡_ü—‹_´•¬e_š‹º®_cmd
(cÚ¡ 
ušt8_t
 *
cdb
,

5551 
cdb_Ën
, 
sc¡_cmd_queue_ty³
 
queue_ty³
,

5552 
sc¡_tgt_dev
 *
tgt_dev
, 
gå_t
 
gå_mask
, 
boÞ
 
çÁom
)

5554 
sc¡_cmd
 *
»s
;

5555 
rc
;

5556 
æags
;

5558 
	`TRACE_ENTRY
();

5560 
»s
 = 
	`sc¡_®loc_cmd
(
cdb
, 
cdb_Ën
, 
gå_mask
);

5561 ià(
»s
 =ð
NULL
)

5562 
out
;

5564 
»s
->
cmd_th»ads
 = 
tgt_dev
->
aùive_cmd_th»ads
;

5565 
»s
->
£ss
 = 
tgt_dev
->sess;

5566 
»s
->
š‹º®
 = 1;

5567 
»s
->
tg‰
 = 
tgt_dev
->
£ss
->
tgt
->tgtt;

5568 
»s
->
tgt
 = 
tgt_dev
->
£ss
->tgt;

5569 
»s
->
dev
 = 
tgt_dev
->dev;

5570 
»s
->
devt
 = 
tgt_dev
->
dev
->
hªdËr
;

5571 
»s
->
tgt_dev
 =gt_dev;

5572 
»s
->
cur_Üd”_d©a
 = 
tgt_dev
->
cu¼_Üd”_d©a
;

5573 
»s
->
lun
 = 
tgt_dev
->lun;

5574 
»s
->
queue_ty³
 = queue_type;

5575 
»s
->
d©a_dœeùiÚ
 = 
SCST_DATA_UNKNOWN
;

5577 ià(!
çÁom
) {

5588 
	`¥š_lock_œq§ve
(&
»s
->
£ss
->
£ss_li¡_lock
, 
æags
);

5589 
	`li¡_add_ž
(&
»s
->
£ss_cmd_li¡_’Œy
, &»s->
£ss
->
£ss_cmd_li¡
);

5590 
	`¥š_uÆock_œq»¡Üe
(&
»s
->
£ss
->
£ss_li¡_lock
, 
æags
);

5593 
	`sc¡_£ss_g‘
(
»s
->
£ss
);

5594 ià(
»s
->
tgt_dev
 !ð
NULL
)

5595 
»s
->
ýu_cmd_couÁ”
 = 
	`sc¡_g‘
();

5597 
	`sc¡_£t_¡¬t_time
(
»s
);

5599 
	`TRACE
(
TRACE_SCSI
, "New iÁ”ÇÈcmd %°(Ý %s)", 
»s
,

5600 
	`sc¡_g‘_Ýcode_Çme
(
»s
));

5602 
rc
 = 
	`sc¡_´e_·r£
(
»s
);

5603 
	`sBUG_ON
(
rc
 != 0);

5605 
»s
->
¡©e
 = 
SCST_CMD_STATE_PARSE
;

5607 
out
:

5608 
	`TRACE_EXIT_HRES
(()
»s
);

5609  
»s
;

5610 
	}
}

5612 
sc¡_cmd
 *
	$sc¡_ü—‹_´•¬e_š‹º®_cmd
(

5613 
sc¡_cmd
 *
Üig_cmd
, cÚ¡ 
ušt8_t
 *
cdb
,

5614 
cdb_Ën
, 
sc¡_cmd_queue_ty³
 
queue_ty³
)

5616 
sc¡_cmd
 *
»s
;

5617 
gå_t
 
gå_mask
 = 
	`sc¡_cmd_©omic
(
Üig_cmd
è? 
GFP_ATOMIC
 : orig_cmd->
cmd_gå_mask
;

5619 
	`TRACE_ENTRY
();

5621 
»s
 = 
	`__sc¡_ü—‹_´•¬e_š‹º®_cmd
(
cdb
, 
cdb_Ën
, 
queue_ty³
,

5622 
Üig_cmd
->
tgt_dev
, 
gå_mask
, 
çl£
);

5623 ià(
»s
 =ð
NULL
)

5624 
out
;

5626 
»s
->
©omic
 = 
	`sc¡_cmd_©omic
(
Üig_cmd
);

5628 
out
:

5629 
	`TRACE_EXIT_HRES
(()
»s
);

5630  
»s
;

5631 
	}
}

5633 
	$sc¡_´–im_fšish_š‹º®_cmd
(
sc¡_cmd
 *
cmd
)

5635 
æags
;

5637 
	`TRACE_ENTRY
();

5639 
	`sBUG_ON
(!
cmd
->
š‹º®
);

5641 
	`¥š_lock_œq§ve
(&
cmd
->
£ss
->
£ss_li¡_lock
, 
æags
);

5642 
	`li¡_d–
(&
cmd
->
£ss_cmd_li¡_’Œy
);

5643 
	`¥š_uÆock_œq»¡Üe
(&
cmd
->
£ss
->
£ss_li¡_lock
, 
æags
);

5645 
	`__sc¡_cmd_put
(
cmd
);

5647 
	`TRACE_EXIT
();

5649 
	}
}

5651 
	$sc¡_´•¬e_»que¡_£n£
(
sc¡_cmd
 *
Üig_cmd
)

5653 
»s
 = 0;

5654 cÚ¡ 
ušt8_t
 
»que¡_£n£
[6] = {

5655 
REQUEST_SENSE
, 0, 0, 0, 
SCST_SENSE_BUFFERSIZE
, 0

5657 
sc¡_cmd
 *
rs_cmd
;

5659 
	`TRACE_ENTRY
();

5661 ià(
Üig_cmd
->
£n£
 !ð
NULL
) {

5662 
	`TRACE_MEM
("Releasing sense %p (orig_cmd %p)",

5663 
Üig_cmd
->
£n£
, orig_cmd);

5664 
	`mempoÞ_ä“
(
Üig_cmd
->
£n£
, 
sc¡_£n£_mempoÞ
);

5665 
Üig_cmd
->
£n£
 = 
NULL
;

5668 
rs_cmd
 = 
	`sc¡_ü—‹_´•¬e_š‹º®_cmd
(
Üig_cmd
,

5669 
»que¡_£n£
, (request_sense),

5670 
SCST_CMD_QUEUE_HEAD_OF_QUEUE
);

5671 ià(
rs_cmd
 =ð
NULL
)

5672 
out_”rÜ
;

5674 
rs_cmd
->
tgt_i_´iv
 = 
Üig_cmd
;

5676 
rs_cmd
->
cdb
[1] |ð
	`sc¡_g‘_cmd_dev_d_£n£
(
Üig_cmd
);

5677 
rs_cmd
->
ex³ùed_d©a_dœeùiÚ
 = 
SCST_DATA_READ
;

5678 
rs_cmd
->
ex³ùed_Œªsãr_Ën_fuÎ
 = 
SCST_SENSE_BUFFERSIZE
;

5679 
rs_cmd
->
ex³ùed_v®ues_£t
 = 1;

5681 
	`TRACE_MGMT_DBG
("Adding REQUEST SENSE cmd %po head of‡ctive "

5682 "cmd†i¡", 
rs_cmd
);

5683 
	`¥š_lock_œq
(&
rs_cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

5684 
	`li¡_add
(&
rs_cmd
->
cmd_li¡_’Œy
, &rs_cmd->
cmd_th»ads
->
aùive_cmd_li¡
);

5685 
	`wake_up
(&
rs_cmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

5686 
	`¥š_uÆock_œq
(&
rs_cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

5688 
out
:

5689 
	`TRACE_EXIT_RES
(
»s
);

5690  
»s
;

5692 
out_”rÜ
:

5693 
»s
 = -1;

5694 
out
;

5695 
	}
}

5697 
	$sc¡_com¶‘e_»que¡_£n£
(
sc¡_cmd
 *
»q_cmd
)

5699 
sc¡_cmd
 *
Üig_cmd
 = 
»q_cmd
->
tgt_i_´iv
;

5700 
ušt8_t
 *
buf
;

5701 
Ën
;

5703 
	`TRACE_ENTRY
();

5705 
	`sBUG_ON
(
Üig_cmd
 =ð
NULL
);

5707 
Ën
 = 
	`sc¡_g‘_buf_fuÎ
(
»q_cmd
, &
buf
);

5709 ià(
	`scsi_¡©us_is_good
(
»q_cmd
->
¡©us
è&& (
Ën
 > 0) &&

5710 
	`sc¡_£n£_v®id
(
buf
)) {

5711 
	`TRACE
(
TRACE_SCSI
|
TRACE_MGMT_DEBUG
, "REQUEST SENSE %p„eturned "

5712 "v®id s’£ (Üig cmd %s)", 
»q_cmd
, 
Üig_cmd
->
Ý_Çme
);

5713 
	`PRINT_BUFF_FLAG
(
TRACE_SCSI
|
TRACE_MGMT_DEBUG
, "S’£", 
buf
, 
Ën
);

5714 ià(
	`sc¡_no_£n£
(
buf
))

5715 
	`PRINT_WARNING
("REQUEST SENSE„eturned NO SENSE (orig "

5716 "cmd %s)", 
Üig_cmd
->
Ý_Çme
);

5717 
	`sc¡_®loc_£t_£n£
(
Üig_cmd
, 
	`sc¡_cmd_©omic
(
»q_cmd
),

5718 
buf
, 
Ën
);

5720 ià(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
»q_cmd
->
cmd_æags
) &&

5721 !
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
Üig_cmd
->
cmd_æags
)) {

5722 
	`TRACE_MGMT_DBG
("REQUEST SENSE %p was‡borted, but "

5723 "Üig_cmd %°-‚Ù,„‘ry", 
»q_cmd
, 
Üig_cmd
);

5725 
	`PRINT_ERROR
("%s", "Unableo gethe sense via "

5727 
	`sc¡_£t_cmd_”rÜ
(
Üig_cmd
,

5728 
	`SCST_LOAD_SENSE
(
sc¡_£n£_š‹º®_çžu»
));

5732 ià(
Ën
 > 0)

5733 
	`sc¡_put_buf_fuÎ
(
»q_cmd
, 
buf
);

5735 
	`TRACE_MGMT_DBG
("Adding orig cmd %po head of‡ctive "

5736 "cmd†i¡", 
Üig_cmd
);

5737 
	`¥š_lock_œq
(&
Üig_cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

5738 
	`li¡_add
(&
Üig_cmd
->
cmd_li¡_’Œy
, &Üig_cmd->
cmd_th»ads
->
aùive_cmd_li¡
);

5739 
	`wake_up
(&
Üig_cmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

5740 
	`¥š_uÆock_œq
(&
Üig_cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

5742 
	`TRACE_EXIT
();

5744 
	}
}

5746 
	ssc¡_ws_sg_ž
 {

5747 
sÿ‰”li¡
 *
	msg
;

5748 
	msg_út
;

5751 
	ssc¡_wr™e_§me_´iv
 {

5753 
sc¡_i_fšish_â_t
 
	mws_fšish_â
;

5755 
sc¡_cmd
 *
	mws_Üig_cmd
;

5757 
mu‹x
 
	mws_mu‹x
;

5760 
sc¡_d©a_desütÜ
 *
	mws_desütÜs
;

5762 
	mws_cur_desü
;

5764 
	mws_Ëá_to_£nd
;

5765 
št64_t
 
	mws_cur_lba
;

5767 
__be16
 
	mgu¬d_g
;

5768 
__be16
 
	m­p_g
;

5769 
ušt32_t
 
	m»f_g
;

5770 
	mdif_v®id
:1;

5771 
	mšc_»f_g
:1;

5773 
	mws_max_—ch
;

5774 
	mws_cur_š_æight
;

5776 
sc¡_ws_sg_ž
 *
	mws_sg_žs
;

5778 
sÿ‰”li¡
 *
	mws_sg_fuÎ
;

5779 
	mws_sg_fuÎ_út
;

5782 #ifdeà
CONFIG_SCST_EXTRACHECKS


5783 
u64
 
	$sg_d©a_Ëngth
(
sÿ‰”li¡
 *
sgl
, 
Ä
)

5785 
sÿ‰”li¡
 *
sg
;

5786 
u64
 
Ën
 = 0;

5787 
i
;

5789 
	`fÜ_—ch_sg
(
sgl
, 
sg
, 
Ä
, 
i
)

5790 
Ën
 +ð
sg
->
Ëngth
;

5792  
Ën
;

5793 
	}
}

5797 
	$sc¡_ws_push_sšgË_wr™e
(
sc¡_wr™e_§me_´iv
 *
w¥
,

5798 
št64_t
 
lba
, 
blocks
)

5800 
sc¡_cmd
 *
ws_cmd
 = 
w¥
->
ws_Üig_cmd
;

5801 
sc¡_deviû
 *
dev
 = 
ws_cmd
->dev;

5802 
sÿ‰”li¡
 *
ws_sg
;

5803 
ws_sg_út
;

5804 
»s
;

5805 
ušt8_t
 
wr™e_cdb
[32];

5806 
wr™e_cdb_Ën
;

5807 
Ën
 = 
blocks
 << 
ws_cmd
->
dev
->
block_shiá
;

5808 
sc¡_cmd
 *
cmd
;

5809 
boÞ
 
Ãeds_dif
 = 
w¥
->
dif_v®id
;

5811 
	`TRACE_ENTRY
();

5813 ià(
blocks
 =ð
w¥
->
ws_max_—ch
) {

5814 
ws_sg
 = 
w¥
->
ws_sg_fuÎ
;

5815 
ws_sg_út
 = 
w¥
->
ws_sg_fuÎ_út
;

5817 
ws_sg
 = 
w¥
->
ws_sg_žs
[w¥->
ws_cur_desü
].
sg
;

5818 
ws_sg_út
 = 
w¥
->
ws_sg_žs
[w¥->
ws_cur_desü
].
sg_út
;

5821 #ifdeà
CONFIG_SCST_EXTRACHECKS


5822 ià(
Ën
 !ð
	`sg_d©a_Ëngth
(
ws_sg
, 
ws_sg_út
))

5823 
	`WARN_ONCE
(
Œue
, "lb¨%Îd: %d <> %Îd\n", 
lba
, 
Ën
,

5824 
	`sg_d©a_Ëngth
(
ws_sg
, 
ws_sg_út
));

5827 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
ws_cmd
->
cmd_æags
)) ||

5828 
	`uÆik–y
(
ws_cmd
->
com¶‘ed
)) {

5829 
	`TRACE_DBG
("ws cmd %p‡borted or completed (%d),‡borting "

5830 "fu¹h” wr™commªds", 
ws_cmd
, ws_cmd->
com¶‘ed
);

5831 
w¥
->
ws_Ëá_to_£nd
 = 0;

5832 
»s
 = -
EPIPE
;

5833 
out
;

5836 ià(!
Ãeds_dif
 || (
dev
->
dev_dif_ty³
 != 2)) {

5837 
	`mem£t
(
wr™e_cdb
, 0, (write_cdb));

5838 
wr™e_cdb
[0] = 
WRITE_16
;

5839 
wr™e_cdb_Ën
 = 16;

5840 
wr™e_cdb
[1] = 
ws_cmd
->
cdb
[1];

5841 ià(
Ãeds_dif
) {

5842 
ušt8_t
 
w½rÙeù
 = 
ws_cmd
->
cdb
[1] & 0xE0;

5844 ià(
w½rÙeù
 == 0)

5845 
w½rÙeù
 = 0x20;

5846 
wr™e_cdb
[1] |ð
w½rÙeù
;

5848 
	`put_uÇligÃd_be64
(
lba
, &
wr™e_cdb
[2]);

5849 
	`put_uÇligÃd_be32
(
blocks
, &
wr™e_cdb
[10]);

5852 
ušt8_t
 
w½rÙeù
;

5854 ià(
ws_cmd
->
cdb_Ën
 != 32)

5855 
w½rÙeù
 = 
ws_cmd
->
cdb
[1] & 0xE0;

5857 
w½rÙeù
 = 
ws_cmd
->
cdb
[10] & 0xE0;

5858 ià(
w½rÙeù
 == 0)

5859 
w½rÙeù
 = 0x20;

5860 
wr™e_cdb
[0] = 
VARIABLE_LENGTH_CMD
;

5861 
	`put_uÇligÃd_be16
(
SUBCODE_WRITE_32
, &
wr™e_cdb
[8]);

5862 
wr™e_cdb
[7] = 0x18;

5863 
wr™e_cdb_Ën
 = 32;

5864 
wr™e_cdb
[10] = 
ws_cmd
->
cdb
[10];

5865 
wr™e_cdb
[10] |ð
w½rÙeù
;

5866 
	`put_uÇligÃd_be64
(
lba
, &
wr™e_cdb
[12]);

5867 
	`put_uÇligÃd_be32
(
blocks
, &
wr™e_cdb
[28]);

5868 
	`put_uÇligÃd_be32
(
w¥
->
»f_g
, &
wr™e_cdb
[20]);

5869 
	`put_uÇligÃd
(
w¥
->
­p_g
, &
wr™e_cdb
[24]);

5870 
wr™e_cdb
[26] = 
ws_cmd
->
cdb
[26];

5871 
wr™e_cdb
[27] = 
ws_cmd
->
cdb
[27];

5874 
cmd
 = 
	`sc¡_ü—‹_´•¬e_š‹º®_cmd
(
ws_cmd
, 
wr™e_cdb
,

5875 
wr™e_cdb_Ën
, 
SCST_CMD_QUEUE_SIMPLE
);

5876 ià(
cmd
 =ð
NULL
) {

5877 
»s
 = -
ENOMEM
;

5878 
out_busy
;

5881 
cmd
->
ex³ùed_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
;

5882 
cmd
->
ex³ùed_Œªsãr_Ën_fuÎ
 = 
Ën
;

5883 
cmd
->
ex³ùed_v®ues_£t
 = 1;

5885 
cmd
->
tgt_i_´iv
 = 
w¥
;

5887 ià(
Ãeds_dif
) {

5888 
sÿ‰”li¡
 *
dif_sg
, *
s
;

5889 
sgv_poÞ_obj
 *
dif_sgv
 = 
NULL
;

5890 
dif_bufæ’
, 
i
, 
dif_sg_út
 = 0;

5892 
	`TRACE_DBG
("Allocating‡nd filling DIF buff for cmd %p "

5893 "(ws_cmd %p)", 
cmd
, 
ws_cmd
);

5895 
dif_bufæ’
 = 
blocks
 << 
SCST_DIF_TAG_SHIFT
;

5896 
cmd
->
ex³ùed_Œªsãr_Ën_fuÎ
 +ð
dif_bufæ’
;

5898 
dif_sg
 = 
	`sgv_poÞ_®loc
(
ws_cmd
->
tgt_dev
->
poÞ
,

5899 
dif_bufæ’
, 
GFP_KERNEL
, 0, &
dif_sg_út
, &
dif_sgv
,

5900 &
cmd
->
dev
->
dev_mem_lim
, 
NULL
);

5901 ià(
	`uÆik–y
(
dif_sg
 =ð
NULL
)) {

5902 
	`TRACE
(
TRACE_OUT_OF_MEM
, "Unableo‡lloc DIF sg "

5903 "fÜ %d blocks", 
blocks
);

5904 
»s
 = -
ENOMEM
;

5905 
out_ä“_cmd
;

5907 
cmd
->
out_sgv
 = 
dif_sgv
;

5908 
cmd
->
tgt_i_dif_sg
 = 
dif_sg
;

5909 
cmd
->
tgt_i_dif_sg_út
 = 
dif_sg_út
;

5911 
	`TRACE_DBG
("dif_sg %p, cÁ %d", 
dif_sg
, 
dif_sg_út
);

5913 
	`fÜ_—ch_sg
(
dif_sg
, 
s
, 
dif_sg_út
, 
i
) {

5914 
Ëá
 = (
s
->
Ëngth
 - s->
off£t
è>> 
SCST_DIF_TAG_SHIFT
;

5915 
t10_pi_tu¶e
 *
t
 = 
	`sg_vœt
(
s
);

5917 
	`TRACE_DBG
("sg %p, off£ˆ%d,†’gth %d,†eá %d", 
s
,

5918 
s
->
off£t
, s->
Ëngth
, 
Ëá
);

5919 
Ëá
 > 0) {

5920 
t
->
­p_g
 = 
w¥
->app_tag;

5921 
t
->
»f_g
 = 
	`ýu_to_be32
(
w¥
->ref_tag);

5922 ià(
w¥
->
šc_»f_g
)

5923 
w¥
->
»f_g
++;

5924 
t
->
gu¬d_g
 = 
w¥
->guard_tag;

5925 
t
++;

5926 
Ëá
--;

5931 
cmd
->
tgt_i_sg
 = 
ws_sg
;

5932 
cmd
->
tgt_i_sg_út
 = 
ws_sg_út
;

5933 
cmd
->
tgt_i_d©a_buf_®loûd
 = 1;

5935 
w¥
->
ws_cur_lba
 +ð
blocks
;

5936 
w¥
->
ws_Ëá_to_£nd
 -ð
blocks
;

5937 
w¥
->
ws_cur_š_æight
++;

5939 
	`TRACE_DBG
("Addšg WRITE(16ècmd %°tØaùivcmd†i¡", 
cmd
);

5940 
	`¥š_lock_œq
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

5941 
	`li¡_add_ž
(&
cmd
->
cmd_li¡_’Œy
, &cmd->
cmd_th»ads
->
aùive_cmd_li¡
);

5942 
	`¥š_uÆock_œq
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

5944 
»s
 = 0;

5946 
out
:

5947 
	`TRACE_EXIT_RES
(
»s
);

5948  
»s
;

5950 
out_ä“_cmd
:

5951 
	`sc¡_´–im_fšish_š‹º®_cmd
(
cmd
);

5953 
out_busy
:

5954 
	`sc¡_£t_busy
(
ws_cmd
);

5955 
out
;

5956 
	}
}

5958 
	$sc¡_ws_fšished
(
sc¡_wr™e_§me_´iv
 *
w¥
)

5960 
sc¡_cmd
 *
ws_cmd
 = 
w¥
->
ws_Üig_cmd
;

5961 
i
;

5963 
	`TRACE_ENTRY
();

5965 
	`TRACE_DBG
("w cmd %°fšished w™h stu %d", 
ws_cmd
, ws_cmd->
¡©us
);

5967 
	`sBUG_ON
(
w¥
->
ws_cur_š_æight
 != 0);

5969 ià(
w¥
->
ws_sg_fuÎ
 &&

5970 
	`sg_·ge
(&
w¥
->
ws_sg_fuÎ
[0]è!ðsg_·ge(
ws_cmd
->
sg
))

5971 
	`__ä“_·ge
(
	`sg_·ge
(&
w¥
->
ws_sg_fuÎ
[0]));

5972 ià(
w¥
->
ws_sg_žs
 && w¥->ws_sg_žs[0].
sg_út
 != 0 &&

5973 
	`sg_·ge
(&
w¥
->
ws_sg_žs
[0].
sg
[0]è!ðsg_·ge(
ws_cmd
->sg))

5974 
	`__ä“_·ge
(
	`sg_·ge
(&
w¥
->
ws_sg_žs
[0].
sg
[0]));

5975 
	`kä“
(
w¥
->
ws_sg_fuÎ
);

5976 ià(
w¥
->
ws_sg_žs
) {

5977 
i
 = 0; 
w¥
->
ws_desütÜs
[i].
sdd_blocks
 != 0; i++)

5978 ià(
w¥
->
ws_sg_žs
[
i
].
sg_út
 != 0)

5979 
	`kä“
(
w¥
->
ws_sg_žs
[
i
].
sg
);

5980 
	`kä“
(
w¥
->
ws_sg_žs
);

5982 
	`kä“
(
w¥
->
ws_desütÜs
);

5983 
	`kä“
(
w¥
);

5985 
ws_cmd
->
com¶‘ed
 = 1;

5986 
ws_cmd
->
	`sc¡_cmd_dÚe
(ws_cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_THREAD
);

5988 
	`TRACE_EXIT
();

5990 
	}
}

5993 
	$sc¡_ws_wr™e_cmd_fšished
(
sc¡_cmd
 *
cmd
)

5995 
sc¡_wr™e_§me_´iv
 *
w¥
 = 
cmd
->
tgt_i_´iv
;

5996 
sc¡_cmd
 *
ws_cmd
 = 
w¥
->
ws_Üig_cmd
;

5997 
rc
, 
blocks
;

5999 
	`TRACE_ENTRY
();

6001 
	`TRACE_DBG
("Write cmd %p finished (ws cmd %p, ws_cur_in_flight %d)",

6002 
cmd
, 
ws_cmd
, 
w¥
->
ws_cur_š_æight
);

6004 ià(
cmd
->
out_sgv
 !ð
NULL
)

6005 
	`sgv_poÞ_ä“
(
cmd
->
out_sgv
, &cmd->
dev
->
dev_mem_lim
);

6007 
cmd
->
sg
 = 
NULL
;

6008 
cmd
->
sg_út
 = 0;

6010 
	`mu‹x_lock
(&
w¥
->
ws_mu‹x
);

6012 
w¥
->
ws_cur_š_æight
--;

6014 ià(
cmd
->
¡©us
 != 0) {

6015 
rc
;

6017 
	`TRACE_DBG
("Write cmd %p (ws cmd %p) finished‚ot successfully",

6018 
cmd
, 
ws_cmd
);

6019 
	`sBUG_ON
(
cmd
->
»¥_d©a_Ën
 != 0);

6020 ià(
cmd
->
¡©us
 =ð
SAM_STAT_CHECK_CONDITION
)

6021 
rc
 = 
	`sc¡_£t_cmd_”rÜ_£n£
(
ws_cmd
, 
cmd
->
£n£
,

6022 
cmd
->
£n£_v®id_Ën
);

6024 
	`sBUG_ON
(
cmd
->
£n£
 !ð
NULL
);

6025 
rc
 = 
	`sc¡_£t_cmd_”rÜ_¡©us
(
ws_cmd
, 
cmd
->
¡©us
);

6027 ià(
rc
 != 0) {

6029 ià(
	`sc¡_is_ua_£n£
(
cmd
->
£n£
, cmd->
£n£_v®id_Ën
))

6030 
	`sc¡_»queue_ua
(
cmd
, 
NULL
, 0);

6034 ià(
w¥
->
ws_Ëá_to_£nd
 == 0) {

6035 ià(
w¥
->
ws_desütÜs
[w¥->
ws_cur_desü
+1].
sdd_blocks
 != 0) {

6036 
w¥
->
ws_cur_desü
++;

6037 
w¥
->
ws_cur_lba
 = w¥->
ws_desütÜs
[w¥->
ws_cur_desü
].
sdd_lba
;

6038 
w¥
->
ws_Ëá_to_£nd
 = w¥->
ws_desütÜs
[w¥->
ws_cur_desü
].
sdd_blocks
;

6039 
	`TRACE_DBG
("wsp %p, cur descr %d, cur†ba %lld,†eft %d",

6040 
w¥
, w¥->
ws_cur_desü
, ()w¥->
ws_cur_lba
,

6041 
w¥
->
ws_Ëá_to_£nd
);

6043 ià(
w¥
->
ws_Ëá_to_£nd
 == 0)

6044 
out_check_fšish
;

6047 
blocks
 = 
	`mš_t
(, 
w¥
->
ws_Ëá_to_£nd
, w¥->
ws_max_—ch
);

6049 
rc
 = 
	`sc¡_ws_push_sšgË_wr™e
(
w¥
, w¥->
ws_cur_lba
, 
blocks
);

6050 ià(
rc
 != 0)

6051 
out_check_fšish
;

6053 
	`wake_up
(&
ws_cmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

6055 
out_uÆock
:

6056 
	`mu‹x_uÆock
(&
w¥
->
ws_mu‹x
);

6058 
out
:

6059 
	`TRACE_EXIT
();

6062 
out_check_fšish
:

6063 ià(
w¥
->
ws_cur_š_æight
 > 0)

6064 
out_uÆock
;

6066 
	`mu‹x_uÆock
(&
w¥
->
ws_mu‹x
);

6067 
	`sc¡_ws_fšished
(
w¥
);

6068 
out
;

6069 
	}
}

6072 
	$sc¡_ws_g’_wr™es
(
sc¡_wr™e_§me_´iv
 *
w¥
)

6074 
sc¡_cmd
 *
ws_cmd
 = 
w¥
->
ws_Üig_cmd
;

6075 
út
 = 0;

6076 
rc
;

6078 
	`TRACE_ENTRY
();

6080 
	`mu‹x_lock
(&
w¥
->
ws_mu‹x
);

6082 
agaš
:

6083 
w¥
->
ws_Ëá_to_£nd
 >ðw¥->
ws_max_—ch
 &&

6084 
w¥
->
ws_cur_š_æight
 < 
SCST_MAX_IN_FLIGHT_INTERNAL_COMMANDS
) {

6085 
rc
 = 
	`sc¡_ws_push_sšgË_wr™e
(
w¥
, w¥->
ws_cur_lba
,

6086 
w¥
->
ws_max_—ch
);

6087 ià(
rc
 != 0)

6088 
out_”r
;

6090 
út
++;

6092 ià(
w¥
->
ws_Ëá_to_£nd
 > 0 &&

6093 
w¥
->
ws_cur_š_æight
 < 
SCST_MAX_IN_FLIGHT_INTERNAL_COMMANDS
) {

6094 
rc
 = 
	`sc¡_ws_push_sšgË_wr™e
(
w¥
, w¥->
ws_cur_lba
,

6095 
w¥
->
ws_Ëá_to_£nd
);

6096 ià(
rc
 != 0)

6097 
out_”r
;

6099 
út
++;

6102 ià((
w¥
->
ws_Ëá_to_£nd
 == 0) &&

6103 (
w¥
->
ws_desütÜs
[w¥->
ws_cur_desü
+1].
sdd_blocks
 != 0)) {

6104 
w¥
->
ws_cur_desü
++;

6105 
w¥
->
ws_cur_lba
 = w¥->
ws_desütÜs
[w¥->
ws_cur_desü
].
sdd_lba
;

6106 
w¥
->
ws_Ëá_to_£nd
 = w¥->
ws_desütÜs
[w¥->
ws_cur_desü
].
sdd_blocks
;

6107 
	`TRACE_DBG
("wsp %p, cur descr %d, cur†ba %lld,†eft %d",

6108 
w¥
, w¥->
ws_cur_desü
, ()w¥->
ws_cur_lba
,

6109 
w¥
->
ws_Ëá_to_£nd
);

6110 
agaš
;

6113 
out_wake
:

6114 ià(
út
 != 0)

6115 
	`wake_up
(&
ws_cmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

6117 
	`mu‹x_uÆock
(&
w¥
->
ws_mu‹x
);

6119 
out
:

6120 
	`TRACE_EXIT
();

6123 
out_”r
:

6124 ià(
w¥
->
ws_cur_š_æight
 != 0)

6125 
out_wake
;

6127 
	`mu‹x_uÆock
(&
w¥
->
ws_mu‹x
);

6128 
	`sc¡_ws_fšished
(
w¥
);

6129 
out
;

6131 
	}
}

6133 
	$sc¡_ws_sg_š™
(
sÿ‰”li¡
 **
ws_sg
, 
ws_sg_út
,

6134 
·ge
 *
pg
, 
off£t
, 
Ëngth
,

6135 
tÙ®_by‹s
)

6137 
sÿ‰”li¡
 *
sg
;

6138 
i
;

6140 *
ws_sg
 = 
	`km®loc_¬¿y
(
ws_sg_út
, (**ws_sg), 
GFP_KERNEL
);

6141 ià(*
ws_sg
 =ð
NULL
) {

6142 
	`PRINT_ERROR
("UÇbËØ®loøsg fÜ %dƒÁr›s", 
ws_sg_út
);

6143  -
ENOMEM
;

6145 
	`sg_š™_bË
(*
ws_sg
, 
ws_sg_út
);

6146 
	`fÜ_—ch_sg
(*
ws_sg
, 
sg
, 
ws_sg_út
, 
i
) {

6147 
u32
 
Ën
 = 
	`mš
(
tÙ®_by‹s
, 
Ëngth
);

6149 
	`sg_£t_·ge
(
sg
, 
pg
, 
Ën
, 
off£t
);

6150 
tÙ®_by‹s
 -ð
Ën
;

6152 
	`sBUG_ON
(
tÙ®_by‹s
 != 0);

6155 
	}
}

6157 
	$sc¡_ws_sg_žs_g‘
(
sc¡_d©a_desütÜ
 *
wh”e
, 
sc¡_wr™e_§me_´iv
 *
w¥
)

6159 
i
;

6160 
ušt64_t
 
n
;

6162 
	`TRACE_ENTRY
();

6164 
i
 = 0; 
wh”e
[i].
sdd_blocks
 != 0; i++) {

6165 ià(
wh”e
[
i
].
sdd_blocks
 >ð
w¥
->
ws_max_—ch
) {

6166 
w¥
->
ws_sg_fuÎ_út
 = w¥->
ws_max_—ch
;

6170 
wh”e
[
i
].
sdd_blocks
 != 0)

6171 
i
++;

6173 
w¥
->
ws_sg_žs
 = 
	`kÿÎoc
(
i
 + 1, (*wsp->ws_sg_tails),

6174 
GFP_KERNEL
);

6175 ià(
w¥
->
ws_sg_žs
 =ð
NULL
) {

6176 
	`PRINT_ERROR
("Unableo‡llocate ws_sg_tails (size %zd)",

6177 (*
w¥
->
ws_sg_žs
)*
i
);

6178  -
ENOMEM
;

6180 
i
 = 0; 
wh”e
[i].
sdd_blocks
 != 0; i++) {

6181 
n
 = 
wh”e
[
i
].
sdd_blocks
;

6182 
w¥
->
ws_sg_žs
[
i
].
sg_út
 = 
	`do_div
(
n
, w¥->
ws_max_—ch
);

6185 
	`TRACE_EXIT
();

6187 
	}
}

6197 
	$sc¡_wr™e_§me
(
sc¡_cmd
 *
cmd
, 
sc¡_d©a_desütÜ
 *
wh”e
)

6199 
sc¡_wr™e_§me_´iv
 *
w¥
;

6200 
i
, 
rc
;

6201 
·ge
 *
pg
 = 
NULL
;

6202 
off£t
, 
Ëngth
, 
muÉ
, 
ws_sg_fuÎ_blocks
, 
ws_sg_ž_blocks
;

6203 
ušt8_t
 
ù¾_offs
 = (
cmd
->
cdb_Ën
 < 32) ? 1 : 10;

6205 
	`TRACE_ENTRY
();

6207 
	`sc¡_£t_exec_time
(
cmd
);

6209 ià(
	`uÆik–y
(
cmd
->
d©a_Ën
 <= 0)) {

6210 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, cmd->
Ën_off
, 0);

6211 
out_dÚe
;

6214 ià(
cmd
->
sg_út
 != 1) {

6215 
	`PRINT_WARNING
("WRITE SAME must contain only single block of data "

6216 "š‡ sšgË SG (cmd %p)", 
cmd
);

6217 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_·¿m‘”_v®ue_šv®id
));

6218 
out_dÚe
;

6221 ià(
	`uÆik–y
((
cmd
->
cdb
[
ù¾_offs
] & 0x6) != 0)) {

6222 
	`TRACE
(
TRACE_MINOR
, "LBDATA‡nd/or PBDATA (ctrl %x)‡re‚ot "

6223 "suµÜ‹d", 
cmd
->
cdb
[
ù¾_offs
]);

6224 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 
ù¾_offs
,

6225 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 1);

6226 
out_dÚe
;

6229 ià(
	`uÆik–y
((
ušt64_t
)
cmd
->
d©a_Ën
 > cmd->
dev
->
max_wr™e_§me_Ën
)) {

6230 
	`PRINT_WARNING
("Invalid WRITE SAME data†en %lld (max‡llowed "

6231 "%Îd)", ()
cmd
->
d©a_Ën
,

6232 ()
cmd
->
dev
->
max_wr™e_§me_Ën
);

6233 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, cmd->
Ën_off
, 0);

6234 
out_dÚe
;

6237 ià(
wh”e
 =ð
NULL
) {

6238 
wh”e
 = 
	`kz®loc
((*wh”eè<< 1, 
GFP_KERNEL
);

6239 ià(
wh”e
 =ð
NULL
) {

6240 
	`PRINT_ERROR
("Unableo‡llocate ws_priv (size %zd, cmd %p)",

6241 (*
wh”e
è<< 1, 
cmd
);

6242 
out_busy
;

6244 
wh”e
->
sdd_lba
 = 
cmd
->
lba
;

6245 
wh”e
->
sdd_blocks
 = 
cmd
->
d©a_Ën
 >> cmd->
dev
->
block_shiá
;

6248 ià(
	`uÆik–y
(
wh”e
->
sdd_blocks
 == 0))

6249 
out_dÚe
;

6251 
rc
 = 
	`sc¡_dif_´oûss_wr™e
(
cmd
);

6252 ià(
	`uÆik–y
(
rc
 != 0))

6253 
out_dÚe
;

6255 
w¥
 = 
	`kz®loc
((*w¥), 
GFP_KERNEL
);

6256 ià(
w¥
 =ð
NULL
) {

6257 
	`PRINT_ERROR
("Unableo‡llocate ws_priv (size %zd, cmd %p)",

6258 (*
w¥
), 
cmd
);

6259 
out_busy
;

6262 
	`mu‹x_š™
(&
w¥
->
ws_mu‹x
);

6263 
w¥
->
ws_fšish_â
 = 
sc¡_ws_wr™e_cmd_fšished
;

6264 
w¥
->
ws_Üig_cmd
 = 
cmd
;

6266 
w¥
->
ws_desütÜs
 = 
wh”e
;

6267 
w¥
->
ws_cur_desü
 = 0;

6268 
w¥
->
ws_cur_lba
 = 
wh”e
[0].
sdd_lba
;

6269 
w¥
->
ws_Ëá_to_£nd
 = 
wh”e
[0].
sdd_blocks
;

6270 
w¥
->
ws_max_—ch
 = 
SCST_MAX_EACH_INTERNAL_IO_SIZE
 >> 
cmd
->
dev
->
block_shiá
;

6272 ià(
	`sc¡_ws_sg_žs_g‘
(
wh”e
, 
w¥
è=ð-
ENOMEM
)

6273 
out_busy
;

6275 ià(
cmd
->
bufæ’
 <ð
PAGE_SIZE
 / 2)

6276 
pg
 = 
	`®loc_·ge
(
GFP_KERNEL
);

6277 ià(
pg
) {

6278 
·ge
 *
¤c_pg
;

6279 *
¤c
, *
d¡
;

6280 
k
;

6282 
muÉ
 = 0;

6283 
¤c_pg
 = 
	`sg_·ge
(
cmd
->
sg
);

6284 
¤c
 = 
	`km­
(
¤c_pg
);

6285 
d¡
 = 
	`km­
(
pg
);

6286 
k
 = 0; k < 
PAGE_SIZE
; k +ð
cmd
->
bufæ’
, 
muÉ
++)

6287 
	`memýy
(
d¡
 + 
k
, 
¤c
 + 
cmd
->
sg
->
off£t
, cmd->
bufæ’
);

6288 
	`kunm­
(
pg
);

6289 
	`kunm­
(
¤c_pg
);

6290 
off£t
 = 0;

6291 
Ëngth
 = 
k
;

6293 
pg
 = 
	`sg_·ge
(
cmd
->
sg
);

6294 
off£t
 = 
cmd
->
sg
->offset;

6295 
Ëngth
 = 
cmd
->
sg
->length;

6296 
muÉ
 = 1;

6299 ià(
w¥
->
ws_sg_fuÎ_út
 != 0) {

6300 
ws_sg_fuÎ_blocks
 = 
w¥
->
ws_sg_fuÎ_út
;

6301 
w¥
->
ws_sg_fuÎ_út
 = (
ws_sg_fuÎ_blocks
 + 
muÉ
 - 1) / mult;

6302 
	`TRACE_DBG
("AÎoÿtšg %d SGs", 
w¥
->
ws_sg_fuÎ_út
);

6303 
rc
 = 
	`sc¡_ws_sg_š™
(&
w¥
->
ws_sg_fuÎ
, w¥->
ws_sg_fuÎ_út
, 
pg
,

6304 
off£t
, 
Ëngth
,

6305 
ws_sg_fuÎ_blocks
 << 
cmd
->
dev
->
block_shiá
);

6306 ià(
rc
 != 0)

6307 
out_ä“
;

6309 
i
 = 0; 
w¥
->
ws_desütÜs
[i].
sdd_blocks
 != 0; i++) {

6310 ià(
w¥
->
ws_sg_žs
[
i
].
sg_út
 != 0) {

6311 
ws_sg_ž_blocks
 = 
w¥
->
ws_sg_žs
[
i
].
sg_út
;

6312 
w¥
->
ws_sg_žs
[
i
].
sg_út
 = (
ws_sg_ž_blocks
 + 
muÉ
 - 1) / mult;

6313 
	`TRACE_DBG
("AÎoÿtšg %daž SG fÜ desütÜ[%d] ", 
w¥
->
ws_sg_žs
[
i
].
sg_út
, i);

6314 
rc
 = 
	`sc¡_ws_sg_š™
(&
w¥
->
ws_sg_žs
[
i
].
sg
, w¥->ws_sg_žs[i].
sg_út
, 
pg
,

6315 
off£t
, 
Ëngth
,

6316 
ws_sg_ž_blocks
 << 
cmd
->
dev
->
block_shiá
);

6317 ià(
rc
 != 0)

6318 
out_ä“
;

6322 ià(
	`sc¡_cmd_Ãeds_dif_buf
(
cmd
)) {

6323 
t10_pi_tu¶e
 *
t
;

6324 
sÿ‰”li¡
 *
gs_sg
 = 
NULL
;

6325 
gs_Ën
 = 0;

6327 
t
 = (
t10_pi_tu¶e
 *)
	`sc¡_g‘_dif_buf
(
cmd
, &
gs_sg
, &
gs_Ën
);

6329 
w¥
->
­p_g
 = 
t
->app_tag;

6330 
w¥
->
»f_g
 = 
	`be32_to_ýu
(
t
->ref_tag);

6331 
w¥
->
gu¬d_g
 = 
t
->guard_tag;

6332 
w¥
->
dif_v®id
 = 1;

6334 
cmd
->
dev
->
dev_dif_ty³
) {

6337 
w¥
->
šc_»f_g
 = 1;

6340 
w¥
->
šc_»f_g
 = 0;

6343 
	`sBUG
();

6347 
	`sc¡_put_dif_buf
(
cmd
, 
t
);

6350 
	`sc¡_ws_g’_wr™es
(
w¥
);

6352 
out
:

6353 
	`TRACE_EXIT
();

6356 
out_ä“
:

6357 ià(
pg
 &&…g !ð
	`sg_·ge
(
cmd
->
sg
))

6358 
	`__ä“_·ge
(
pg
);

6359 
	`kä“
(
w¥
);

6361 
out_busy
:

6362 
	`sc¡_£t_busy
(
cmd
);

6364 
out_dÚe
:

6365 
	`kä“
(
wh”e
);

6366 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_THREAD
);

6367 
out
;

6368 
	}
}

6369 
EXPORT_SYMBOL_GPL
(
sc¡_wr™e_§me
);

6371 
	ssc¡_cwr_´iv
 {

6373 
sc¡_i_fšish_â_t
 
	mcwr_fšish_â
;

6375 
sc¡_cmd
 *
	mcwr_Üig_cmd
;

6378 
	$sc¡_cwr_fšished
(
sc¡_cwr_´iv
 *
cw½
)

6380 
sc¡_cmd
 *
cwr_cmd
 = 
cw½
->
cwr_Üig_cmd
;

6382 
	`TRACE_ENTRY
();

6384 
	`TRACE_DBG
("cw¸cmd %°fšished w™h stu %d", 
cwr_cmd
, cwr_cmd->
¡©us
);

6386 
	`kä“
(
cw½
);

6388 
cwr_cmd
->
com¶‘ed
 = 1;

6389 
cwr_cmd
->
	`sc¡_cmd_dÚe
(cwr_cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_THREAD
);

6391 
	`TRACE_EXIT
();

6393 
	}
}

6395 
	$sc¡_cwr_wr™e_cmd_fšished
(
sc¡_cmd
 *
cmd
)

6397 
sc¡_cwr_´iv
 *
cw½
 = 
cmd
->
tgt_i_´iv
;

6398 
sc¡_cmd
 *
cwr_cmd
 = 
cw½
->
cwr_Üig_cmd
;

6400 
	`TRACE_ENTRY
();

6402 
	`TRACE_DBG
("WRITE cmd %°fšished (cw¸cmd %p)", 
cmd
, 
cwr_cmd
);

6404 
	`EXTRACHECKS_BUG_ON
(
cmd
->
cdb
[0] !ð
WRITE_16
);

6406 ià(
cmd
->
¡©us
 != 0) {

6407 
rc
;

6409 
	`TRACE_DBG
("WRITE cmd %p (cwr cmd %p) finished‚ot successfully",

6410 
cmd
, 
cwr_cmd
);

6411 
	`sBUG_ON
(
cmd
->
»¥_d©a_Ën
 != 0);

6412 ià(
cmd
->
¡©us
 =ð
SAM_STAT_CHECK_CONDITION
)

6413 
rc
 = 
	`sc¡_£t_cmd_”rÜ_£n£
(
cwr_cmd
, 
cmd
->
£n£
,

6414 
cmd
->
£n£_v®id_Ën
);

6416 
	`sBUG_ON
(
cmd
->
£n£
 !ð
NULL
);

6417 
rc
 = 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cwr_cmd
, 
cmd
->
¡©us
);

6419 ià(
rc
 != 0) {

6421 ià(
	`sc¡_is_ua_£n£
(
cmd
->
£n£
, cmd->
£n£_v®id_Ën
))

6422 
	`sc¡_»queue_ua
(
cmd
, 
NULL
, 0);

6426 
	`sc¡_cwr_fšished
(
cw½
);

6428 
	`TRACE_EXIT
();

6430 
	}
}

6432 
	$sc¡_cwr_»ad_cmd_fšished
(
sc¡_cmd
 *
cmd
)

6434 
sc¡_cwr_´iv
 *
cw½
 = 
cmd
->
tgt_i_´iv
;

6435 
sc¡_cmd
 *
cwr_cmd
 = 
cw½
->
cwr_Üig_cmd
;

6436 
boÞ
 
c
, 
dif
;

6437 
ušt8_t
 
wr™e16_cdb
[16];

6438 
sc¡_cmd
 *
wcmd
;

6439 
d©a_Ën
, 
miscom·»_offs
, 
rc
;

6441 
	`TRACE_ENTRY
();

6443 
	`TRACE_DBG
("READ cmd %°fšished (cw¸cmd %p)", 
cmd
, 
cwr_cmd
);

6445 ià(
cmd
->
¡©us
 != 0) {

6446 
rc
;

6448 
	`TRACE_DBG
("Read cmd %p (cwr cmd %p) finished‚ot successfully",

6449 
cmd
, 
cwr_cmd
);

6450 
	`sBUG_ON
(
cmd
->
»¥_d©a_Ën
 != 0);

6451 ià(
cmd
->
¡©us
 =ð
SAM_STAT_CHECK_CONDITION
)

6452 
rc
 = 
	`sc¡_£t_cmd_”rÜ_£n£
(
cwr_cmd
, 
cmd
->
£n£
,

6453 
cmd
->
£n£_v®id_Ën
);

6455 
	`sBUG_ON
(
cmd
->
£n£
 !ð
NULL
);

6456 
rc
 = 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cwr_cmd
, 
cmd
->
¡©us
);

6458 ià(
rc
 != 0) {

6460 ià(
	`sc¡_is_ua_£n£
(
cmd
->
£n£
, cmd->
£n£_v®id_Ën
))

6461 
	`sc¡_»queue_ua
(
cmd
, 
NULL
, 0);

6463 
out_fšish
;

6466 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cwr_cmd
->
cmd_æags
))) {

6467 
	`TRACE_MGMT_DBG
("cw¸cmd %°abÜ‹d", 
cwr_cmd
);

6468 
out_fšish
;

6471 
c
 = 
	`sg_cmp
(
cmd
->
sg
, 
cwr_cmd
->sg, 0, 0, &
miscom·»_offs


6472 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3, 4, 0)

6473 , 
KM_USER0
, 
KM_USER1


6476 ià(!
c
) {

6477 
	`sc¡_£t_cmd_”rÜ_ªd_šf
(
cwr_cmd
,

6478 
	`SCST_LOAD_SENSE
(
sc¡_£n£_miscom·»_”rÜ
), 
miscom·»_offs
);

6479 
out_fšish
;

6482 
d©a_Ën
 = 
cwr_cmd
->data_len;

6485 
rc
 = 
	`sc¡_dif_´oûss_wr™e
(
cmd
);

6486 ià(
	`uÆik–y
(
rc
 != 0))

6487 
out_fšish
;

6489 
	`mem£t
(
wr™e16_cdb
, 0, (write16_cdb));

6490 
wr™e16_cdb
[0] = 
WRITE_16
;

6491 
wr™e16_cdb
[1] = 
cwr_cmd
->
cdb
[1];

6492 
	`put_uÇligÃd_be64
(
cwr_cmd
->
lba
, &
wr™e16_cdb
[2]);

6493 
	`put_uÇligÃd_be32
(
d©a_Ën
 >> 
cmd
->
dev
->
block_shiá
, &
wr™e16_cdb
[10]);

6495 
dif
 = 
	`sc¡_cmd_Ãeds_dif_buf
(
cwr_cmd
è&& ((cwr_cmd->
cdb
[1] & 0xE0) != 0);

6496 ià(
dif
)

6497 
wr™e16_cdb
[1] |ð
cwr_cmd
->
cdb
[1] & 0xE0;

6499 
wcmd
 = 
	`sc¡_ü—‹_´•¬e_š‹º®_cmd
(
cwr_cmd
, 
wr™e16_cdb
,

6500 (
wr™e16_cdb
), 
SCST_CMD_QUEUE_HEAD_OF_QUEUE
);

6501 ià(
wcmd
 =ð
NULL
)

6502 
out_busy
;

6504 
wcmd
->
ex³ùed_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
;

6505 
wcmd
->
ex³ùed_Œªsãr_Ën_fuÎ
 = 
d©a_Ën
;

6506 ià(
dif
)

6507 
wcmd
->
ex³ùed_Œªsãr_Ën_fuÎ
 +=

6508 
d©a_Ën
 >> (
cmd
->
dev
->
block_shiá
 - 
SCST_DIF_TAG_SHIFT
);

6509 
wcmd
->
ex³ùed_v®ues_£t
 = 1;

6511 
wcmd
->
tgt_i_´iv
 = 
cw½
;

6513 
rc
 = 
	`sc¡_adju¡_sg_g‘_ž
(
cwr_cmd
, &
wcmd
->
tgt_i_sg
,

6514 &
wcmd
->
tgt_i_sg_út
, &wcmd->
tgt_i_dif_sg
,

6515 &
wcmd
->
tgt_i_dif_sg_út
, 
d©a_Ën
, data_len);

6520 
	`EXTRACHECKS_BUG_ON
(
rc
 != 0);

6522 
wcmd
->
tgt_i_d©a_buf_®loûd
 = 1;

6524 
cw½
->
cwr_fšish_â
 = 
sc¡_cwr_wr™e_cmd_fšished
;

6526 
	`TRACE_DBG
("Addšg WRITE(16èwcmd %°tØh—d oàaùivcmd†i¡", 
wcmd
);

6527 
	`¥š_lock_œq
(&
wcmd
->
cmd_th»ads
->
cmd_li¡_lock
);

6528 
	`li¡_add
(&
wcmd
->
cmd_li¡_’Œy
, &wcmd->
cmd_th»ads
->
aùive_cmd_li¡
);

6529 
	`wake_up
(&
wcmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

6530 
	`¥š_uÆock_œq
(&
wcmd
->
cmd_th»ads
->
cmd_li¡_lock
);

6532 
out
:

6533 
	`TRACE_EXIT
();

6536 
out_busy
:

6537 
	`sc¡_£t_busy
(
cwr_cmd
);

6539 
out_fšish
:

6540 
	`sc¡_cwr_fšished
(
cw½
);

6541 
out
;

6542 
	}
}

6544 
	$sc¡_cmp_wr_loÿl
(
sc¡_cmd
 *
cmd
)

6546 
»s
 = 
SCST_EXEC_COMPLETED
;

6547 
sc¡_cwr_´iv
 *
cw½
;

6548 
ušt8_t
 
»ad16_cdb
[16];

6549 
sc¡_cmd
 *
rcmd
;

6550 
d©a_Ën
;

6552 
	`TRACE_ENTRY
();

6555 
	`EXTRACHECKS_BUG_ON
(
cmd
->
dev
->
ty³
 !ð
TYPE_DISK
);

6557 
cmd
->
¡©us
 = 0;

6558 
cmd
->
msg_¡©us
 = 0;

6559 
cmd
->
ho¡_¡©us
 = 
DID_OK
;

6560 
cmd
->
driv”_¡©us
 = 0;

6562 ià(
	`uÆik–y
(
cmd
->
bufæ’
 == 0)) {

6563 
	`TRACE
(
TRACE_MINOR
, "Z”Øbufæ’ (cmd %p)", 
cmd
);

6564 
out_dÚe
;

6568 
cw½
 = 
	`kz®loc
((*cw½), 
GFP_KERNEL
);

6569 ià(
cw½
 =ð
NULL
) {

6570 
	`PRINT_ERROR
("Unableo‡llocate cwr_priv (size %zd, cmd %p)",

6571 (*
cw½
), 
cmd
);

6572 
out_busy
;

6575 
cw½
->
cwr_Üig_cmd
 = 
cmd
;

6576 
cw½
->
cwr_fšish_â
 = 
sc¡_cwr_»ad_cmd_fšished
;

6578 
d©a_Ën
 = 
cmd
->data_len;

6584 
	`mem£t
(
»ad16_cdb
, 0, (read16_cdb));

6585 
»ad16_cdb
[0] = 
READ_16
;

6586 
»ad16_cdb
[1] = 
cmd
->
cdb
[1] & ~0xE0;

6587 
	`put_uÇligÃd_be64
(
cmd
->
lba
, &
»ad16_cdb
[2]);

6588 
	`put_uÇligÃd_be32
(
d©a_Ën
 >> 
cmd
->
dev
->
block_shiá
, &
»ad16_cdb
[10]);

6590 
rcmd
 = 
	`sc¡_ü—‹_´•¬e_š‹º®_cmd
(
cmd
, 
»ad16_cdb
,

6591 (
»ad16_cdb
), 
SCST_CMD_QUEUE_HEAD_OF_QUEUE
);

6592 ià(
rcmd
 =ð
NULL
) {

6593 
»s
 = -
ENOMEM
;

6594 
out_ä“
;

6597 
rcmd
->
ex³ùed_d©a_dœeùiÚ
 = 
SCST_DATA_READ
;

6598 
rcmd
->
ex³ùed_Œªsãr_Ën_fuÎ
 = 
d©a_Ën
;

6599 
rcmd
->
ex³ùed_v®ues_£t
 = 1;

6601 
rcmd
->
tgt_i_´iv
 = 
cw½
;

6603 
	`TRACE_DBG
("Addšg READ(16ècmd %°tØh—d oàaùivcmd†i¡", 
rcmd
);

6604 
	`¥š_lock_œq
(&
rcmd
->
cmd_th»ads
->
cmd_li¡_lock
);

6605 
	`li¡_add
(&
rcmd
->
cmd_li¡_’Œy
, &rcmd->
cmd_th»ads
->
aùive_cmd_li¡
);

6606 
	`wake_up
(&
rcmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

6607 
	`¥š_uÆock_œq
(&
rcmd
->
cmd_th»ads
->
cmd_li¡_lock
);

6609 
out
:

6610 
	`TRACE_EXIT_RES
(
»s
);

6611  
»s
;

6613 
out_ä“
:

6614 
	`kä“
(
cw½
);

6616 
out_busy
:

6617 
	`sc¡_£t_busy
(
cmd
);

6619 
out_dÚe
:

6620 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_THREAD
);

6621 
out
;

6622 
	}
}

6625 
	$sc¡_fšish_š‹º®_cmd
(
sc¡_cmd
 *
cmd
)

6627 
»s
;

6628 
æags
;

6630 
	`TRACE_ENTRY
();

6632 
	`sBUG_ON
(!
cmd
->
š‹º®
);

6634 ià(
	`sc¡_cmd_©omic
(
cmd
)) {

6635 
	`TRACE_DBG
("Rescheduling finished internal‡tomic cmd %p in‡ "

6636 "th»ad cÚ‹xt", 
cmd
);

6637 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

6638 
out
;

6641 
	`¥š_lock_œq§ve
(&
cmd
->
£ss
->
£ss_li¡_lock
, 
æags
);

6642 
	`li¡_d–
(&
cmd
->
£ss_cmd_li¡_’Œy
);

6643 
cmd
->
dÚe
 = 1;

6644 
cmd
->
fšished
 = 1;

6645 
	`¥š_uÆock_œq»¡Üe
(&
cmd
->
£ss
->
£ss_li¡_lock
, 
æags
);

6647 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
))) {

6648 
	`sc¡_dÚe_cmd_mgmt
(
cmd
);

6649 
	`sc¡_fšish_cmd_mgmt
(
cmd
);

6652 ià(
cmd
->
cdb
[0] =ð
REQUEST_SENSE
)

6653 
	`sc¡_com¶‘e_»que¡_£n£
(
cmd
);

6655 
sc¡_i_fšish_â_t
 
f
 = (*è*((**)
cmd
->
tgt_i_´iv
);

6657 
	`f
(
cmd
);

6660 
	`__sc¡_cmd_put
(
cmd
);

6662 
»s
 = 
SCST_CMD_STATE_RES_CONT_NEXT
;

6664 
out
:

6665 
	`TRACE_EXIT_HRES
(
»s
);

6666  
»s
;

6667 
	}
}

6669 
	$sc¡_£nd_»Ëa£
(
sc¡_deviû
 *
dev
)

6671 
scsi_deviû
 *
scsi_dev
;

6672 
cdb
[6];

6673 
ušt8_t
 
£n£
[
SCSI_SENSE_BUFFERSIZE
];

6674 
rc
, 
i
;

6676 
	`TRACE_ENTRY
();

6678 ià(
dev
->
scsi_dev
 =ð
NULL
)

6679 
out
;

6681 
scsi_dev
 = 
dev
->scsi_dev;

6683 
i
 = 0; i < 5; i++) {

6684 
	`mem£t
(
cdb
, 0, (cdb));

6685 
cdb
[0] = 
RELEASE
;

6686 
cdb
[1] = (
scsi_dev
->
scsi_Ëv–
 <ð
SCSI_2
) ?

6687 ((
scsi_dev
->
lun
 << 5) & 0xe0) : 0;

6689 
	`mem£t
(
£n£
, 0, (sense));

6691 
	`TRACE
(
TRACE_DEBUG
 | 
TRACE_SCSI
, "%s", "Sending RELEASE„eqo "

6693 
rc
 = 
	`scsi_execu‹
(
scsi_dev
, 
cdb
, 
SCST_DATA_NONE
, 
NULL
, 0,

6694 
£n£
, 15, 0, 0

6695 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2,6,29)

6696 , 
NULL


6699 
	`TRACE_DBG
("RELEASE dÚe: %x", 
rc
);

6701 ià(
	`scsi_¡©us_is_good
(
rc
)) {

6704 
	`PRINT_ERROR
("RELEASE fažed: %d", 
rc
);

6705 
	`PRINT_BUFFER
("RELEASE s’£", 
£n£
, (sense));

6706 
	`sc¡_check_š‹º®_£n£
(
dev
, 
rc
, 
£n£
,

6707 (
£n£
));

6711 
out
:

6712 
	`TRACE_EXIT
();

6714 
	}
}

6717 
	$sc¡_þ—r_»£rv©iÚ
(
sc¡_tgt_dev
 *
tgt_dev
)

6719 
sc¡_deviû
 *
dev
 = 
tgt_dev
->dev;

6720 
sc¡_lksb
 
´_lksb
;

6721 
»Ëa£
 = 0;

6723 
	`TRACE_ENTRY
();

6725 
	`sc¡_»s_lock
(
dev
, &
´_lksb
);

6726 ià(
	`sc¡_is_»£rv©iÚ_hÞd”
(
dev
, 
tgt_dev
->
£ss
)) {

6728 
	`sc¡_þ—r_dev_»£rv©iÚ
(
dev
);

6729 
»Ëa£
 = 1;

6731 
	`sc¡_»s_uÆock
(
dev
, &
´_lksb
);

6733 ià(
»Ëa£
)

6734 
	`sc¡_£nd_»Ëa£
(
dev
);

6736 
	`TRACE_EXIT
();

6738 
	}
}

6740 
sc¡_£ssiÚ
 *
	$sc¡_®loc_£ssiÚ
(
sc¡_tgt
 *
tgt
, 
gå_t
 
gå_mask
,

6741 cÚ¡ *
š™ŸtÜ_Çme
)

6743 
sc¡_£ssiÚ
 *
£ss
;

6744 
i
;

6746 
	`TRACE_ENTRY
();

6748 
£ss
 = 
	`kmem_ÿche_z®loc
(
sc¡_£ss_ÿch•
, 
gå_mask
);

6749 ià(
£ss
 =ð
NULL
) {

6750 
	`PRINT_ERROR
("%s", "Allocation of scst_session failed");

6751 
out
;

6754 
£ss
->
š™_pha£
 = 
SCST_SESS_IPH_INITING
;

6755 
£ss
->
shut_pha£
 = 
SCST_SESS_SPH_READY
;

6756 
	`©omic_£t
(&
£ss
->
»fút
, 0);

6757 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

6758 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

6760 
	`INIT_LIST_HEAD
(
h—d
);

6762 
	`¥š_lock_š™
(&
£ss
->
£ss_li¡_lock
);

6763 
	`INIT_LIST_HEAD
(&
£ss
->
£ss_cmd_li¡
);

6764 
£ss
->
tgt
 =gt;

6765 
	`INIT_LIST_HEAD
(&
£ss
->
š™_deã¼ed_cmd_li¡
);

6766 
	`INIT_LIST_HEAD
(&
£ss
->
š™_deã¼ed_mcmd_li¡
);

6767 
	`INIT_LIST_HEAD
(&
£ss
->
£ss_cm_li¡_id_li¡
);

6768 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 20)

6769 
	`INIT_DELAYED_WORK
(&
£ss
->
£ss_cm_li¡_id_þ—nup_wÜk
,

6770 
£ss_cm_li¡_id_þ—nup_wÜk_â
);

6771 
	`INIT_DELAYED_WORK
(&
£ss
->
hw_³ndšg_wÜk
, 
sc¡_hw_³ndšg_wÜk_â
);

6773 
	`INIT_WORK
(&
£ss
->
£ss_cm_li¡_id_þ—nup_wÜk
,

6774 
£ss_cm_li¡_id_þ—nup_wÜk_â
, 
£ss
);

6775 
	`INIT_WORK
(&
£ss
->
hw_³ndšg_wÜk
, 
sc¡_hw_³ndšg_wÜk_â
, sess);

6778 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


6779 
	`¥š_lock_š™
(&
£ss
->
Ït_lock
);

6782 
£ss
->
š™ŸtÜ_Çme
 = 
	`k¡rdup
(š™ŸtÜ_Çme, 
gå_mask
);

6783 ià(
£ss
->
š™ŸtÜ_Çme
 =ð
NULL
) {

6784 
	`PRINT_ERROR
("%s", "Unableo dup sess->initiator_name");

6785 
out_ä“
;

6788 
out
:

6789 
	`TRACE_EXIT
();

6790  
£ss
;

6792 
out_ä“
:

6793 
	`kmem_ÿche_ä“
(
sc¡_£ss_ÿch•
, 
£ss
);

6794 
£ss
 = 
NULL
;

6795 
out
;

6796 
	}
}

6798 
	$sc¡_ä“_£ssiÚ
(
sc¡_£ssiÚ
 *
£ss
)

6800 
	`TRACE_ENTRY
();

6802 
	`mu‹x_lock
(&
sc¡_mu‹x
);

6804 
	`sc¡_£ss_ä“_tgt_devs
(
£ss
);

6806 
	`TRACE_DBG
("Removšg ses %°äomhli¡", 
£ss
);

6807 
	`li¡_d–
(&
£ss
->
£ss_li¡_’Œy
);

6809 
	`TRACE_DBG
("Removšg sessiÚ %°äom‡cg %s", 
£ss
, sess->
acg
->
acg_Çme
);

6810 
	`li¡_d–
(&
£ss
->
acg_£ss_li¡_’Œy
);

6811 
	`sc¡_put_acg
(
£ss
->
acg
);

6813 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

6815 #iâdeà
CONFIG_SCST_PROC


6816 
	`sc¡_£ss_sysfs_d–
(
£ss
);

6818 ià(
£ss
->
uÄeg_dÚe_â
) {

6819 
	`TRACE_DBG
("C®lšg uÄeg_dÚe_â(%p)", 
£ss
);

6820 
£ss
->
	`uÄeg_dÚe_â
(sess);

6821 
	`TRACE_DBG
("%s", "unreg_done_fn()„eturned");

6824 
	`mu‹x_lock
(&
sc¡_mu‹x
);

6826 
	`li¡_d–
(&
£ss
->
sysfs_£ss_li¡_’Œy
);

6829 
	`wake_up_®l
(&
£ss
->
tgt
->
uÄeg_wa™Q
);

6835 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

6837 
	`kä“
(
£ss
->
Œª¥Üt_id
);

6838 
	`kä“
(
£ss
->
š™ŸtÜ_Çme
);

6839 ià(
£ss
->
£ss_Çme
 !ð£ss->
š™ŸtÜ_Çme
)

6840 
	`kä“
(
£ss
->
£ss_Çme
);

6842 
	`kmem_ÿche_ä“
(
sc¡_£ss_ÿch•
, 
£ss
);

6844 
	`TRACE_EXIT
();

6846 
	}
}

6848 
	$sc¡_ä“_£ssiÚ_ÿÎback
(
sc¡_£ssiÚ
 *
£ss
)

6850 
com¶‘iÚ
 *
c
;

6852 
	`TRACE_ENTRY
();

6854 
	`TRACE_DBG
("F»ešg sessiÚ %p", 
£ss
);

6856 
	`ÿnûl_d–ayed_wÜk_sync
(&
£ss
->
hw_³ndšg_wÜk
);

6858 
c
 = 
£ss
->
shutdown_com¶
;

6860 
	`mu‹x_lock
(&
sc¡_mu‹x
);

6866 
£ss
->
shut_pha£
 = 
SCST_SESS_SPH_UNREG_DONE_CALLING
;

6867 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

6869 
	`sc¡_ä“_£ssiÚ
(
£ss
);

6871 ià(
c
)

6872 
	`com¶‘e_®l
(
c
);

6874 
	`TRACE_EXIT
();

6876 
	}
}

6878 
	$sc¡_sched_£ssiÚ_ä“
(
sc¡_£ssiÚ
 *
£ss
)

6880 
æags
;

6882 
	`TRACE_ENTRY
();

6884 ià(
£ss
->
shut_pha£
 !ð
SCST_SESS_SPH_SHUTDOWN
) {

6885 
	`PRINT_CRIT_ERROR
("session %p is goingo shutdown with unknown "

6886 "shuˆpha£ %lx", 
£ss
, sess->
shut_pha£
);

6887 
	`sBUG
();

6890 
	`¥š_lock_œq§ve
(&
sc¡_mgmt_lock
, 
æags
);

6891 
	`TRACE_DBG
("Addšg ses %°tØsc¡_£ss_shut_li¡", 
£ss
);

6892 
	`li¡_add_ž
(&
£ss
->
£ss_shut_li¡_’Œy
, &
sc¡_£ss_shut_li¡
);

6893 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_mgmt_lock
, 
æags
);

6895 
	`wake_up
(&
sc¡_mgmt_wa™Q
);

6897 
	`TRACE_EXIT
();

6899 
	}
}

6904 
	$sc¡_cmd_g‘
(
sc¡_cmd
 *
cmd
)

6906 
	`__sc¡_cmd_g‘
(
cmd
);

6907 
	}
}

6908 
EXPORT_SYMBOL
(
sc¡_cmd_g‘
);

6913 
	$sc¡_cmd_put
(
sc¡_cmd
 *
cmd
)

6915 
	`__sc¡_cmd_put
(
cmd
);

6916 
	}
}

6917 
EXPORT_SYMBOL
(
sc¡_cmd_put
);

6922 
	$sc¡_cmd_£t_ext_cdb
(
sc¡_cmd
 *
cmd
,

6923 
ušt8_t
 *
ext_cdb
, 
ext_cdb_Ën
,

6924 
gå_t
 
gå_mask
)

6926 
Ën
 = 
cmd
->
cdb_Ën
 + 
ext_cdb_Ën
;

6928 
	`TRACE_ENTRY
();

6930 ià(
Ën
 <ð(
cmd
->
cdb_buf
))

6931 
cÝy
;

6933 ià(
	`uÆik–y
(
Ën
 > 
SCST_MAX_LONG_CDB_SIZE
)) {

6934 
	`PRINT_ERROR
("ToØbig CDB (%d)", 
Ën
);

6935 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

6936 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

6937 
out
;

6941 
cmd
->
cdb
 = 
	`km®loc
(
Ën
, 
gå_mask
);

6942 ià(
	`uÆik–y
(
cmd
->
cdb
 =ð
NULL
)) {

6943 
	`PRINT_ERROR
("UÇbËØ®loøex‹nded CDB (siz%d)", 
Ën
);

6944 
out_”r
;

6947 
	`memýy
(
cmd
->
cdb
, cmd->
cdb_buf
, cmd->
cdb_Ën
);

6949 
cÝy
:

6950 
	`memýy
(&
cmd
->
cdb
[cmd->
cdb_Ën
], 
ext_cdb
, 
ext_cdb_Ën
);

6952 
cmd
->
cdb_Ën
 = cmd->cdb_ËÀ+ 
ext_cdb_Ën
;

6954 
out
:

6955 
	`TRACE_EXIT
();

6958 
out_”r
:

6959 
cmd
->
cdb
 = cmd->
cdb_buf
;

6960 
	`sc¡_£t_busy
(
cmd
);

6961 
out
;

6962 
	}
}

6963 
EXPORT_SYMBOL
(
sc¡_cmd_£t_ext_cdb
);

6965 
	$sc¡_´e_š™_cmd
(
sc¡_cmd
 *
cmd
, cÚ¡ 
ušt8_t
 *
cdb
,

6966 
cdb_Ën
, 
gå_t
 
gå_mask
)

6968 
»s
;

6970 
	`TRACE_ENTRY
();

6972 #ifdeà
CONFIG_SCST_EXTRACHECKS


6975 
i
;

6976 
ušt8_t
 *
b
 = (ušt8_ˆ*)
cmd
;

6978 
i
 = 0; i < (*
cmd
); i++)

6979 
	`EXTRACHECKS_BUG_ON
(
b
[
i
] != 0);

6983 
cmd
->
¡©e
 = 
SCST_CMD_STATE_INIT_WAIT
;

6984 
cmd
->
¡¬t_time
 = 
jiff›s
;

6985 
	`©omic_£t
(&
cmd
->
cmd_»f
, 1);

6986 
cmd
->
cmd_th»ads
 = &
sc¡_maš_cmd_th»ads
;

6987 
cmd
->
cmd_gå_mask
 = 
GFP_KERNEL
;

6988 
	`INIT_LIST_HEAD
(&
cmd
->
mgmt_cmd_li¡
);

6989 
cmd
->
cdb
 = cmd->
cdb_buf
;

6990 
cmd
->
queue_ty³
 = 
SCST_CMD_QUEUE_SIMPLE
;

6991 
cmd
->
timeout
 = 
SCST_DEFAULT_TIMEOUT
;

6992 
cmd
->
»Œ›s
 = 0;

6993 #ifdeà
CONFIG_SCST_EXTRACHECKS


6995 
cmd
->
lba
 = 
SCST_DEF_LBA_DATA_LEN
;

6996 
cmd
->
d©a_Ën
 = 
SCST_DEF_LBA_DATA_LEN
;

6998 
cmd
->
is_£nd_¡©us
 = 1;

6999 
cmd
->
»¥_d©a_Ën
 = -1;

7000 
cmd
->
wr™e_sg
 = &cmd->
sg
;

7001 
cmd
->
wr™e_sg_út
 = &cmd->
sg_út
;

7003 
cmd
->
dbl_ua_Üig_d©a_dœeùiÚ
 = 
SCST_DATA_UNKNOWN
;

7004 
cmd
->
dbl_ua_Üig_»¥_d©a_Ën
 = -1;

7006 ià(
	`uÆik–y
(
cdb_Ën
 == 0)) {

7007 
	`PRINT_ERROR
("%s", "Wrong CDB†en 0, finishing cmd");

7008 
»s
 = -
EINVAL
;

7009 
out
;

7010 } ià(
cdb_Ën
 <ð
SCST_MAX_CDB_SIZE
) {

7012 
	`memýy
(
cmd
->
cdb
, cdb, 
cdb_Ën
);

7014 ià(
	`uÆik–y
(
cdb_Ën
 > 
SCST_MAX_LONG_CDB_SIZE
)) {

7015 
	`PRINT_ERROR
("ToØbig CDB (%d), fšishšg cmd", 
cdb_Ën
);

7016 
»s
 = -
EINVAL
;

7017 
out
;

7020 
cmd
->
cdb
 = 
	`km®loc
(
cdb_Ën
, 
gå_mask
);

7021 ià(
	`uÆik–y
(
cmd
->
cdb
 =ð
NULL
)) {

7022 
	`PRINT_ERROR
("Unableo‡llocƒxtended CDB (size %d)",

7023 
cdb_Ën
);

7024 
»s
 = -
ENOMEM
;

7025 
out
;

7027 
	`memýy
(
cmd
->
cdb
, cdb, 
cdb_Ën
);

7030 
cmd
->
cdb_Ën
 = cdb_len;

7032 
»s
 = 0;

7034 
out
:

7035 
	`TRACE_EXIT_RES
(
»s
);

7036  
»s
;

7037 
	}
}

7039 
sc¡_cmd
 *
	$sc¡_®loc_cmd
(cÚ¡ 
ušt8_t
 *
cdb
,

7040 
cdb_Ën
, 
gå_t
 
gå_mask
)

7042 
sc¡_cmd
 *
cmd
;

7043 
rc
;

7045 
	`TRACE_ENTRY
();

7047 
cmd
 = 
	`kmem_ÿche_z®loc
(
sc¡_cmd_ÿch•
, 
gå_mask
);

7048 ià(
cmd
 =ð
NULL
) {

7049 
	`TRACE
(
TRACE_OUT_OF_MEM
, "%s", "Allocation of scst_cmd failed");

7050 
out
;

7053 
rc
 = 
	`sc¡_´e_š™_cmd
(
cmd
, 
cdb
, 
cdb_Ën
, 
gå_mask
);

7054 ià(
	`uÆik–y
(
rc
 != 0))

7055 
out_ä“
;

7057 
out
:

7058 
	`TRACE_EXIT
();

7059  
cmd
;

7061 
out_ä“
:

7062 
	`kmem_ÿche_ä“
(
sc¡_cmd_ÿch•
, 
cmd
);

7063 
cmd
 = 
NULL
;

7064 
out
;

7065 
	}
}

7067 
	$sc¡_de¡roy_cmd
(
sc¡_cmd
 *
cmd
)

7069 
boÞ
 
´e_®loûd
 = 
cmd
->pre_alloced;

7071 
	`TRACE_ENTRY
();

7073 
	`TRACE_DBG
("De¡royšg cmd %p", 
cmd
);

7075 
	`sc¡_£ss_put
(
cmd
->
£ss
);

7080 ià(
	`lik–y
(
cmd
->
tgt_dev
 !ð
NULL
))

7081 
	`sc¡_put
(
cmd
->
ýu_cmd_couÁ”
);

7083 
	`EXTRACHECKS_BUG_ON
(
cmd
->
´e_®loûd
 && cmd->
š‹º®
);

7085 ià((
cmd
->
tg‰
->
Ú_ä“_cmd
 !ð
NULL
è&& 
	`lik–y
(!cmd->
š‹º®
)) {

7086 
	`TRACE_DBG
("C®lšg¬g‘' Ú_ä“_cmd(%p)", 
cmd
);

7087 
cmd
->
tg‰
->
	`Ú_ä“_cmd
(cmd);

7088 
	`TRACE_DBG
("%s", "Target's on_free_cmd()„eturned");

7093 ià(!
´e_®loûd
)

7094 
	`kmem_ÿche_ä“
(
sc¡_cmd_ÿch•
, 
cmd
);

7096 
	`TRACE_EXIT
();

7098 
	}
}

7101 
	$sc¡_¡pg_d–_unblock_Ãxt
(
sc¡_cmd
 *
cmd
)

7103 
sc¡_cmd
 *
c
;

7105 
	`TRACE_ENTRY
();

7107 
	`¥š_lock_œq
(&
sc¡_glob®_¡pg_li¡_lock
);

7109 
	`EXTRACHECKS_BUG_ON
(!
cmd
->
cmd_Ú_glob®_¡pg_li¡
);

7111 
	`TRACE_DBG
("STPG cmd %°dÚe: unblockšg‚ext", 
cmd
);

7113 
	`li¡_d–
(&
cmd
->
glob®_¡pg_li¡_’Œy
);

7114 
cmd
->
cmd_Ú_glob®_¡pg_li¡
 = 0;

7116 ià(
	`li¡_em±y
(&
sc¡_glob®_¡pg_li¡
)) {

7117 
	`TRACE_DBG
("No more STPG commandso unblock");

7118 
	`¥š_uÆock_œq
(&
sc¡_glob®_¡pg_li¡_lock
);

7119 
out
;

7122 
c
 = 
	`li¡_fœ¡_’Œy
(&
sc¡_glob®_¡pg_li¡
, 
	`ty³of
(*c),

7123 
glob®_¡pg_li¡_’Œy
);

7125 
	`¥š_uÆock_œq
(&
sc¡_glob®_¡pg_li¡_lock
);

7127 
	`¥š_lock_bh
(&
c
->
dev
->
dev_lock
);

7129 ià(!
c
->
cmd_glob®_¡pg_blocked
) {

7130 
	`TRACE_DBG
("STPG cmd %°i nÙ cmd_glob®_¡pg_blocked", 
c
);

7131 
	`¥š_uÆock_bh
(&
c
->
dev
->
dev_lock
);

7132 
out
;

7135 
	`TRACE_BLOCK
("Unblockšg s”Ÿlized STPG cmd %p", 
c
);

7137 
	`li¡_d–
(&
c
->
blocked_cmd_li¡_’Œy
);

7138 
c
->
cmd_glob®_¡pg_blocked
 = 0;

7140 
	`¥š_uÆock_bh
(&
c
->
dev
->
dev_lock
);

7142 
	`¥š_lock_œq
(&
c
->
cmd_th»ads
->
cmd_li¡_lock
);

7143 
	`li¡_add
(&
c
->
cmd_li¡_’Œy
,

7144 &
c
->
cmd_th»ads
->
aùive_cmd_li¡
);

7145 
	`wake_up
(&
c
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

7146 
	`¥š_uÆock_œq
(&
c
->
cmd_th»ads
->
cmd_li¡_lock
);

7148 
out
:

7149 
	`TRACE_EXIT
();

7151 
	}
}

7152 
EXPORT_SYMBOL_GPL
(
sc¡_¡pg_d–_unblock_Ãxt
);

7155 
	$sc¡_ä“_cmd
(
sc¡_cmd
 *
cmd
)

7157 
de¡roy
 = 1;

7159 
	`TRACE_ENTRY
();

7161 
	`TRACE_DBG
("Freeing cmd %p (tag %llu)",

7162 
cmd
, ()cmd->
g
);

7164 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
)))

7165 
	`TRACE_MGMT_DBG
("F»ešg‡bÜ‹d cmd %p", 
cmd
);

7167 
	`EXTRACHECKS_BUG_ON
(
cmd
->
unblock_dev
 || cmd->
dec_Ú_dev_Ãeded
 ||

7168 
cmd
->
Ú_dev_exec_li¡
);

7174 ià(!
cmd
->
tgt_i_d©a_buf_®loûd
)

7175 
	`sc¡_check_»¡Üe_sg_buff
(
cmd
);

7177 ià(
	`lik–y
(
cmd
->
dev
 !ð
NULL
)) {

7178 
sc¡_dev_ty³
 *
devt
 = 
cmd
->devt;

7180 ià(
devt
->
Ú_ä“_cmd
 !ð
NULL
) {

7181 
	`TRACE_DBG
("Calling dev handler %s on_free_cmd(%p)",

7182 
devt
->
Çme
, 
cmd
);

7183 
devt
->
	`Ú_ä“_cmd
(
cmd
);

7184 
	`TRACE_DBG
("Dev handler %s on_free_cmd()„eturned",

7185 
devt
->
Çme
);

7189 
	`sc¡_»Ëa£_¥aû
(
cmd
);

7191 ià(
	`uÆik–y
(
cmd
->
£n£
 !ð
NULL
)) {

7192 
	`TRACE_MEM
("R–—sšg s’£ %°(cmd %p)", 
cmd
->
£n£
, cmd);

7193 
	`mempoÞ_ä“
(
cmd
->
£n£
, 
sc¡_£n£_mempoÞ
);

7194 
cmd
->
£n£
 = 
NULL
;

7197 ià(
	`lik–y
(
cmd
->
tgt_dev
 !ð
NULL
)) {

7198 
	`EXTRACHECKS_BUG_ON
(
cmd
->
¢_£t
 && !cmd->
out_of_¢
 &&

7199 !
	`‹¡_b™
(
SCST_CMD_INC_EXPECTED_SN_PASSED
, &
cmd
->
cmd_æags
));

7200 ià(
	`uÆik–y
(
cmd
->
out_of_¢
)) {

7201 
de¡roy
 = 
	`‹¡_ªd_£t_b™
(
SCST_CMD_CAN_BE_DESTROYED
,

7202 &
cmd
->
cmd_æags
);

7203 
	`TRACE_SN
("Out of SN cmd %p (tag %llu, sn %d), "

7204 "de¡roy=%d", 
cmd
,

7205 ()
cmd
->
g
,

7206 
cmd
->
¢
, 
de¡roy
);

7210 ià(
	`uÆik–y
(
cmd
->
Ý_æags
 & 
SCST_DESCRIPTORS_BASED
))

7211 
	`sc¡_ä“_desütÜs
(
cmd
);

7213 ià(
cmd
->
cdb
 !ðcmd->
cdb_buf
)

7214 
	`kä“
(
cmd
->
cdb
);

7216 ià(
	`lik–y
(
de¡roy
))

7217 
	`sc¡_de¡roy_cmd
(
cmd
);

7219 
	`TRACE_EXIT
();

7221 
	}
}

7224 
	$sc¡_check_»Œ›s
(
sc¡_tgt
 *
tgt
)

7226 
Ãed_wake_up
 = 0;

7228 
	`TRACE_ENTRY
();

7230 ià(
	`uÆik–y
(
tgt
->
»Œy_cmds
 > 0)) {

7231 
sc¡_cmd
 *
c
, *
tc
;

7232 
æags
;

7234 
	`TRACE_RETRY
("Checking„etry cmd†ist (retry_cmds %d)",

7235 
tgt
->
»Œy_cmds
);

7237 
	`¥š_lock_œq§ve
(&
tgt
->
tgt_lock
, 
æags
);

7238 
	`li¡_fÜ_—ch_’Œy_§ã
(
c
, 
tc
, &
tgt
->
»Œy_cmd_li¡
,

7239 
cmd_li¡_’Œy
) {

7240 
tgt
->
»Œy_cmds
--;

7242 
	`TRACE_RETRY
("Moving„etry cmd %po head of‡ctive "

7244 
c
, 
tgt
->
»Œy_cmds
);

7245 
	`¥š_lock
(&
c
->
cmd_th»ads
->
cmd_li¡_lock
);

7246 
	`li¡_move
(&
c
->
cmd_li¡_’Œy
,

7247 &
c
->
cmd_th»ads
->
aùive_cmd_li¡
);

7248 
	`wake_up
(&
c
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

7249 
	`¥š_uÆock
(&
c
->
cmd_th»ads
->
cmd_li¡_lock
);

7251 
Ãed_wake_up
++;

7252 ià(
Ãed_wake_up
 >= 20)

7255 
	`¥š_uÆock_œq»¡Üe
(&
tgt
->
tgt_lock
, 
æags
);

7258 
	`TRACE_EXIT
();

7260 
	}
}

7262 
	$sc¡_tgt_»Œy_tim”_â
(
¬g
)

7264 
sc¡_tgt
 *
tgt
 = (sc¡_tgˆ*)
¬g
;

7265 
æags
;

7267 
	`TRACE_RETRY
("R‘ryim”ƒxpœed (»Œy_cmd %d)", 
tgt
->
»Œy_cmds
);

7269 
	`¥š_lock_œq§ve
(&
tgt
->
tgt_lock
, 
æags
);

7270 
tgt
->
»Œy_tim”_aùive
 = 0;

7271 
	`¥š_uÆock_œq»¡Üe
(&
tgt
->
tgt_lock
, 
æags
);

7273 
	`sc¡_check_»Œ›s
(
tgt
);

7275 
	`¥š_lock_œq§ve
(&
tgt
->
tgt_lock
, 
æags
);

7276 ià((
tgt
->
»Œy_cmds
 > 0è&& !tgt->
»Œy_tim”_aùive
) {

7277 
	`TRACE_DBG
("R—ùiv©šg„‘ryim” fÜgˆ%p", 
tgt
);

7278 
tgt
->
»Œy_tim”
.
expœes
 = 
jiff›s
 + 
SCST_TGT_RETRY_TIMEOUT
;

7279 
	`add_tim”
(&
tgt
->
»Œy_tim”
);

7280 
tgt
->
»Œy_tim”_aùive
 = 1;

7282 
	`¥š_uÆock_œq»¡Üe
(&
tgt
->
tgt_lock
, 
æags
);

7284 
	`TRACE_EXIT
();

7286 
	}
}

7288 
sc¡_mgmt_cmd
 *
	$sc¡_®loc_mgmt_cmd
(
gå_t
 
gå_mask
)

7290 
sc¡_mgmt_cmd
 *
mcmd
;

7292 
	`TRACE_ENTRY
();

7294 
mcmd
 = 
	`mempoÞ_®loc
(
sc¡_mgmt_mempoÞ
, 
gå_mask
);

7295 ià(
mcmd
 =ð
NULL
) {

7296 
	`PRINT_CRIT_ERROR
("%s", "Allocation of management command "

7298 
out
;

7300 
	`mem£t
(
mcmd
, 0, (*mcmd));

7302 
mcmd
->
¡©us
 = 
SCST_MGMT_STATUS_SUCCESS
;

7304 
out
:

7305 
	`TRACE_EXIT
();

7306  
mcmd
;

7307 
	}
}

7309 
	$sc¡_ä“_mgmt_cmd
(
sc¡_mgmt_cmd
 *
mcmd
)

7311 
æags
;

7313 
	`TRACE_ENTRY
();

7315 
	`¥š_lock_œq§ve
(&
mcmd
->
£ss
->
£ss_li¡_lock
, 
æags
);

7316 
	`©omic_dec
(&
mcmd
->
£ss
->
£ss_cmd_couÁ
);

7317 
	`¥š_uÆock_œq»¡Üe
(&
mcmd
->
£ss
->
£ss_li¡_lock
, 
æags
);

7319 
	`sc¡_£ss_put
(
mcmd
->
£ss
);

7321 ià((
mcmd
->
mcmd_tgt_dev
 !ð
NULL
è|| mcmd->
sc¡_g‘_ÿÎed
)

7322 
	`sc¡_put
(
mcmd
->
ýu_cmd_couÁ”
);

7324 
	`mempoÞ_ä“
(
mcmd
, 
sc¡_mgmt_mempoÞ
);

7326 
	`TRACE_EXIT
();

7328 
	}
}

7330 
boÞ
 
	$sc¡_Ú_sg_bËsize_low
(
sc¡_cmd
 *
cmd
, 
boÞ
 
out
)

7332 
boÞ
 
»s
;

7333 
sg_út
 = 
out
 ? 
cmd
->
out_sg_út
 : cmd->sg_cnt;

7334 
Î
;

7335 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

7337 
	`TRACE_ENTRY
();

7339 ià(
sg_út
 > 
cmd
->
tgt
->
sg_bËsize
) {

7341 
çžed
;

7344 ià(
cmd
->
devt
->
Ú_sg_bËsize_low
 =ð
NULL
)

7345 
çžed
;

7347 
»s
 = 
cmd
->
devt
->
	`Ú_sg_bËsize_low
(cmd);

7349 
	`TRACE_DBG
("Ú_sg_bËsize_low(%pè»tuºed %d", 
cmd
, 
»s
);

7351 
out
:

7352 
	`TRACE_EXIT_RES
(
»s
);

7353  
»s
;

7355 
çžed
:

7356 
»s
 = 
çl£
;

7357 ià((
Î
 < 10è|| 
	`TRACING_MINOR
()) {

7358 
	`PRINT_INFO
("Unableo complete command dueo SG IO count "

7360 
out
 ? "OUT bufãr, " : "", 
cmd
->
sg_út
,

7361 
tgt_dev
->
max_sg_út
, 
cmd
->
tgt
->
sg_bËsize
);

7362 
Î
++;

7364 
out
;

7365 
	}
}

7367 
	$sc¡_»¡Üe_dif_sg
(
sc¡_cmd
 *
cmd
)

7369 
Ëá
 = 
cmd
->
bufæ’
;

7370 
sÿ‰”li¡
 *
sg
 = 
cmd
->
dif_sg
;

7372 
	`TRACE_ENTRY
();

7374 ià(!
cmd
->
dif_sg_nÜm®ized
)

7375 
out
;

7378 
sg
->
Ëngth
 = 
	`mš_t
(, 
PAGE_SIZE
, 
Ëá
);

7379 
Ëá
 -ð
sg
->
Ëngth
;

7380 
	`TRACE_DBG
("DIF sg %p,„e¡Üed†’ %d (Ëá %d)", 
sg
,

7381 
sg
->
Ëngth
, 
Ëá
);

7382 
sg
 = 
	`__sg_Ãxt_šlše
(sg);

7383 } 
Ëá
 > 0);

7385 
out
:

7386 
	`TRACE_EXIT
();

7388 
	}
}

7390 
	$sc¡_®loc_¥aû
(
sc¡_cmd
 *
cmd
)

7392 
gå_t
 
gå_mask
;

7393 
»s
 = -
ENOMEM
;

7394 
©omic
 = 
	`sc¡_cmd_©omic
(
cmd
);

7395 
æags
;

7396 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

7398 
	`TRACE_ENTRY
();

7400 
gå_mask
 = 
tgt_dev
->
tgt_dev_gå_mask
 | (
©omic
 ? 
GFP_ATOMIC
 : 
cmd
->
cmd_gå_mask
);

7402 
æags
 = 
©omic
 ? 
SGV_POOL_NO_ALLOC_ON_CACHE_MISS
 : 0;

7403 ià(
cmd
->
no_sgv
)

7404 
æags
 |ð
SGV_POOL_ALLOC_NO_CACHED
;

7406 
cmd
->
sg
 = 
	`sgv_poÞ_®loc
(
tgt_dev
->
poÞ
, cmd->
bufæ’
, 
gå_mask
, 
æags
,

7407 &
cmd
->
sg_út
, &cmd->
sgv
, &cmd->
dev
->
dev_mem_lim
, 
NULL
);

7408 ià(
	`uÆik–y
(
cmd
->
sg
 =ð
NULL
))

7409 
out
;

7411 ià(
	`uÆik–y
(
cmd
->
sg_út
 > 
tgt_dev
->
max_sg_út
))

7412 ià(!
	`sc¡_Ú_sg_bËsize_low
(
cmd
, 
çl£
))

7413 
out_sg_ä“
;

7415 ià((
	`sc¡_g‘_dif_aùiÚ
(
	`sc¡_g‘_sc¡_dif_aùiÚs
(
cmd
->
cmd_dif_aùiÚs
)è!ð
SCST_DIF_ACTION_NONE
) ||

7416 (
	`sc¡_g‘_dif_aùiÚ
(
	`sc¡_g‘_dev_dif_aùiÚs
(
cmd
->
cmd_dif_aùiÚs
)è!ð
SCST_DIF_ACTION_NONE
)) {

7417 
dif_bufæ’
;

7418 
boÞ
 
§me_Ïyout
;

7420 
§me_Ïyout
 = 
tgt_dev
->
hw_dif_§me_sg_Ïyout_»quœed
;

7421 ià(!
§me_Ïyout
)

7422 
dif_bufæ’
 = 
	`__sc¡_cmd_g‘_bufæ’_dif
(
cmd
);

7424 
dif_bufæ’
 = 
cmd
->
bufæ’
;

7426 
cmd
->
dif_sg
 = 
	`sgv_poÞ_®loc
(
tgt_dev
->
poÞ
, 
dif_bufæ’
, 
gå_mask
, 
æags
,

7427 &
cmd
->
dif_sg_út
, &cmd->
dif_sgv
, &cmd->
dev
->
dev_mem_lim
, 
NULL
);

7428 ià(
	`uÆik–y
(
cmd
->
dif_sg
 =ð
NULL
))

7429 
out_sg_ä“
;

7431 ià(
§me_Ïyout
) {

7432 
Ëá
 = 
dif_bufæ’
;

7433 
sÿ‰”li¡
 *
sgd
 = 
cmd
->
sg
;

7434 
sÿ‰”li¡
 *
sgt
 = 
cmd
->
dif_sg
;

7435 
block_shiá
 = 
cmd
->
dev
->block_shift;

7437 
	`EXTRACHECKS_BUG_ON
(
Ëá
 !ð
cmd
->
bufæ’
);

7440 
Ëá
 -ð
sgt
->
Ëngth
;

7441 
sgt
->
Ëngth
 = (
sgd
->Ëngth >> 
block_shiá
è<< 
SCST_DIF_TAG_SHIFT
;

7442 
	`TRACE_SG
("sgˆ%p,‚ew†’ %d", 
sgt
, sgt->
Ëngth
);

7443 
sgd
 = 
	`__sg_Ãxt_šlše
(sgd);

7444 
sgt
 = 
	`__sg_Ãxt_šlše
(sgt);

7445 } 
Ëá
 > 0);

7447 
cmd
->
dif_sg_nÜm®ized
 = 1;

7451 ià(
cmd
->
d©a_dœeùiÚ
 !ð
SCST_DATA_BIDI
)

7452 
sucûss
;

7454 
cmd
->
out_sg
 = 
	`sgv_poÞ_®loc
(
tgt_dev
->
poÞ
, cmd->
out_bufæ’
, 
gå_mask
,

7455 
æags
, &
cmd
->
out_sg_út
, &cmd->
out_sgv
,

7456 &
cmd
->
dev
->
dev_mem_lim
, 
NULL
);

7457 ià(
	`uÆik–y
(
cmd
->
out_sg
 =ð
NULL
))

7458 
out_dif_sg_ä“
;

7460 ià(
	`uÆik–y
(
cmd
->
out_sg_út
 > 
tgt_dev
->
max_sg_út
))

7461 ià(!
	`sc¡_Ú_sg_bËsize_low
(
cmd
, 
Œue
))

7462 
out_out_sg_ä“
;

7464 
sucûss
:

7465 
»s
 = 0;

7467 
out
:

7468 
	`TRACE_EXIT
();

7469  
»s
;

7471 
out_out_sg_ä“
:

7472 
	`sgv_poÞ_ä“
(
cmd
->
out_sgv
, &cmd->
dev
->
dev_mem_lim
);

7473 
cmd
->
out_sgv
 = 
NULL
;

7474 
cmd
->
out_sg
 = 
NULL
;

7475 
cmd
->
out_sg_út
 = 0;

7477 
out_dif_sg_ä“
:

7478 ià(
cmd
->
dif_sgv
 !ð
NULL
) {

7479 
	`sc¡_»¡Üe_dif_sg
(
cmd
);

7480 
	`sgv_poÞ_ä“
(
cmd
->
dif_sgv
, &cmd->
dev
->
dev_mem_lim
);

7481 
cmd
->
dif_sgv
 = 
NULL
;

7482 
cmd
->
dif_sg
 = 
NULL
;

7483 
cmd
->
dif_sg_út
 = 0;

7486 
out_sg_ä“
:

7487 
	`sgv_poÞ_ä“
(
cmd
->
sgv
, &cmd->
dev
->
dev_mem_lim
);

7488 
cmd
->
sgv
 = 
NULL
;

7489 
cmd
->
sg
 = 
NULL
;

7490 
cmd
->
sg_út
 = 0;

7491 
out
;

7492 
	}
}

7494 
	$sc¡_»Ëa£_¥aû
(
sc¡_cmd
 *
cmd
)

7496 
	`TRACE_ENTRY
();

7498 ià(
cmd
->
sgv
 =ð
NULL
) {

7499 ià((
cmd
->
sg
 !ð
NULL
) &&

7500 !(
cmd
->
tgt_i_d©a_buf_®loûd
 || cmd->
dh_d©a_buf_®loûd
)) {

7501 
	`TRACE_MEM
("F»ešg sg %°fÜ cmd %°(úˆ%d)", 
cmd
->
sg
,

7502 
cmd
, cmd->
sg_út
);

7503 
	`sc¡_ä“_sg
(
cmd
->
sg
, cmd->
sg_út
);

7504 
out_z”o
;

7506 
out
;

7509 ià(
cmd
->
tgt_i_d©a_buf_®loûd
 || cmd->
dh_d©a_buf_®loûd
) {

7510 
	`TRACE_MEM
("%s", "*data_buf_alloced set,„eturning");

7511 
out
;

7514 ià(
cmd
->
out_sgv
 !ð
NULL
) {

7515 
	`sgv_poÞ_ä“
(
cmd
->
out_sgv
, &cmd->
dev
->
dev_mem_lim
);

7516 
cmd
->
out_sgv
 = 
NULL
;

7517 
cmd
->
out_sg_út
 = 0;

7518 
cmd
->
out_sg
 = 
NULL
;

7519 
cmd
->
out_bufæ’
 = 0;

7522 ià(
cmd
->
dif_sgv
 !ð
NULL
) {

7523 
	`sc¡_»¡Üe_dif_sg
(
cmd
);

7524 
	`sgv_poÞ_ä“
(
cmd
->
dif_sgv
, &cmd->
dev
->
dev_mem_lim
);

7527 
	`sgv_poÞ_ä“
(
cmd
->
sgv
, &cmd->
dev
->
dev_mem_lim
);

7529 
out_z”o
:

7530 
cmd
->
sgv
 = 
NULL
;

7531 
cmd
->
sg_út
 = 0;

7532 
cmd
->
sg
 = 
NULL
;

7533 
cmd
->
dif_sgv
 = 
NULL
;

7534 
cmd
->
dif_sg
 = 
NULL
;

7535 
cmd
->
dif_sg_út
 = 0;

7536 
cmd
->
bufæ’
 = 0;

7537 
cmd
->
d©a_Ën
 = 0;

7539 
out
:

7540 
	`TRACE_EXIT
();

7542 
	}
}

7544 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 30)

7545 
	sblk_k”n_sg_wÜk
 {

7546 
©omic_t
 
	mbios_šæight
;

7547 
sg_bË
 
	msg_bË
;

7548 
sÿ‰”li¡
 *
	m¤c_sgl
;

7551 
	$blk_ä“_k”n_sg_wÜk
(
blk_k”n_sg_wÜk
 *
bw
)

7553 
sg_bË
 *
sgt
 = &
bw
->sg_table;

7554 
sÿ‰”li¡
 *
sg
;

7555 
·ge
 *
pg
;

7556 
i
;

7558 
	`fÜ_—ch_sg
(
sgt
->
sgl
, 
sg
, sgt->
Üig_ÃÁs
, 
i
) {

7559 
pg
 = 
	`sg_·ge
(
sg
);

7560 ià(
pg
 =ð
NULL
)

7562 
	`__ä“_·ge
(
pg
);

7565 
	`sg_ä“_bË
(
sgt
);

7566 
	`kä“
(
bw
);

7568 
	}
}

7570 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 3, 0)

7571 
	$blk_bio_m­_k”n_’dio
(
bio
 *bio, 
”r
)

7574 
	$blk_bio_m­_k”n_’dio
(
bio
 *bio)

7576 
”r
 = 
bio
->
bi_”rÜ
;

7578 
blk_k”n_sg_wÜk
 *
bw
 = 
bio
->
bi_´iv©e
;

7580 ià(
bw
 !ð
NULL
) {

7582 
	`BUG_ON
(
	`©omic_»ad
(&
bw
->
bios_šæight
) <= 0);

7583 ià(
	`©omic_dec_ªd_‹¡
(&
bw
->
bios_šæight
)) {

7584 ià(
	`bio_d©a_dœ
(
bio
è=ð
READ
 && 
”r
 == 0) {

7585 
æags
;

7587 
	`loÿl_œq_§ve
(
æags
);

7588 
	`sg_cÝy
(
bw
->
¤c_sgl
, bw->
sg_bË
.
sgl
, 0, 0

7589 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3, 4, 0)

7590 , 
KM_BIO_DST_IRQ
, 
KM_BIO_SRC_IRQ


7593 
	`loÿl_œq_»¡Üe
(
æags
);

7595 
	`blk_ä“_k”n_sg_wÜk
(
bw
);

7599 
	`bio_put
(
bio
);

7601 
	}
}

7603 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 31)

7608 
»que¡
 *
	$blk_make_»que¡
(
»que¡_queue
 *
q
,

7609 
bio
 *bio,

7610 
gå_t
 
gå_mask
)

7612 
»que¡
 *
rq
 = 
	`blk_g‘_»que¡
(
q
, 
	`bio_d©a_dœ
(
bio
), 
gå_mask
);

7614 ià(
	`uÆik–y
(!
rq
))

7615  
	`ERR_PTR
(-
ENOMEM
);

7617 
rq
->
cmd_ty³
 = 
REQ_TYPE_BLOCK_PC
;

7619  ; 
bio
; biØðbio->
bi_Ãxt
) {

7620 
bio
 *
bounû_bio
 = bio;

7621 
»t
;

7623 
	`blk_queue_bounû
(
q
, &
bounû_bio
);

7624 
»t
 = 
	`blk_rq_­³nd_bio
(
q
, 
rq
, 
bounû_bio
);

7625 ià(
	`uÆik–y
(
»t
)) {

7626 
	`blk_put_»que¡
(
rq
);

7627  
	`ERR_PTR
(
»t
);

7631  
rq
;

7632 
	}
}

7639 
blk_k”n_sg_wÜk
 *
	$blk_cÝy_k”n_sg
(
»que¡_queue
 *
q
,

7640 
sÿ‰”li¡
 *
sgl
, 
ÃÁs
, 
gå_t
 
gå_mask
, 
boÞ
 
»adšg
)

7642 
»s
 = 0, 
i
;

7643 
sÿ‰”li¡
 *
sg
;

7644 
sÿ‰”li¡
 *
Ãw_sgl
;

7645 
Ãw_sgl_ÃÁs
;

7646 
size_t
 
Ën
 = 0, 
to_cÝy
;

7647 
blk_k”n_sg_wÜk
 *
bw
;

7649 
»s
 = -
ENOMEM
;

7650 
bw
 = 
	`kz®loc
((*bw), 
gå_mask
);

7651 ià(
bw
 =ð
NULL
)

7652 
”r
;

7654 
bw
->
¤c_sgl
 = 
sgl
;

7656 
	`fÜ_—ch_sg
(
sgl
, 
sg
, 
ÃÁs
, 
i
)

7657 
Ën
 +ð
sg
->
Ëngth
;

7658 
to_cÝy
 = 
Ën
;

7660 
Ãw_sgl_ÃÁs
 = 
	`PFN_UP
(
Ën
);

7662 
»s
 = 
	`sg_®loc_bË
(&
bw
->
sg_bË
, 
Ãw_sgl_ÃÁs
, 
gå_mask
);

7663 ià(
»s
 != 0)

7664 
”r_ä“_bw
;

7666 
Ãw_sgl
 = 
bw
->
sg_bË
.
sgl
;

7668 
»s
 = -
ENOMEM
;

7669 
	`fÜ_—ch_sg
(
Ãw_sgl
, 
sg
, 
Ãw_sgl_ÃÁs
, 
i
) {

7670 
·ge
 *
pg
;

7672 
pg
 = 
	`®loc_·ge
(
q
->
bounû_gå
 | 
gå_mask
);

7673 ià(
pg
 =ð
NULL
)

7674 
”r_ä“_bË
;

7676 
	`sg_assign_·ge
(
sg
, 
pg
);

7677 
sg
->
Ëngth
 = 
	`mš_t
(
size_t
, 
PAGE_SIZE
, 
Ën
);

7679 
Ën
 -ð
PAGE_SIZE
;

7682 ià(!
»adšg
) {

7688 
	`sg_cÝy
(
Ãw_sgl
, 
sgl
, 0, 
to_cÝy


7689 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3, 4, 0)

7690 , 
KM_USER0
, 
KM_USER1


7695 
out
:

7696  
bw
;

7698 
”r_ä“_bË
:

7699 
	`sg_ä“_bË
(&
bw
->
sg_bË
);

7701 
”r_ä“_bw
:

7702 
	`blk_ä“_k”n_sg_wÜk
(
bw
);

7704 
”r
:

7705 
	`sBUG_ON
(
»s
 == 0);

7706 
bw
 = 
	`ERR_PTR
(
»s
);

7707 
out
;

7708 
	}
}

7710 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 28)

7711 
	$bio_km®loc_de¡ruùÜ
(
bio
 *bio)

7713 
	`kä“
(
bio
->
bi_io_vec
);

7714 
	`kä“
(
bio
);

7715 
	}
}

7719 
»que¡
 *
	$__blk_m­_k”n_sg
(
»que¡_queue
 *
q
,

7720 
sÿ‰”li¡
 *
sgl
, 
ÃÁs
, 
blk_k”n_sg_wÜk
 *
bw
,

7721 
gå_t
 
gå_mask
, 
boÞ
 
»adšg
)

7723 
»que¡
 *
rq
;

7724 
max_Ä_vecs
, 
i
;

7725 
size_t
 
tÙ_Ën
;

7726 
boÞ
 
Ãed_Ãw_bio
;

7727 
sÿ‰”li¡
 *
sg
;

7728 
bio
 *biØð
NULL
, *
hbio
 = NULL, *
tbio
 = NULL;

7729 
bios
;

7731 ià(
	`uÆik–y
(
sgl
 =ð
NULL
 || sgl->
Ëngth
 =ð0 || 
ÃÁs
 <= 0)) {

7732 
	`WARN_ON_ONCE
(
Œue
);

7733 
rq
 = 
	`ERR_PTR
(-
EINVAL
);

7734 
out
;

7741 
max_Ä_vecs
 = 
	`mš_t
(,

7742 (
PAGE_SIZE
 - (
bio
)è/ (
bio_vec
),

7743 
BIO_MAX_PAGES
);

7745 
Ãed_Ãw_bio
 = 
Œue
;

7746 
tÙ_Ën
 = 0;

7747 
bios
 = 0;

7748 
	`fÜ_—ch_sg
(
sgl
, 
sg
, 
ÃÁs
, 
i
) {

7749 
·ge
 *·gð
	`sg_·ge
(
sg
);

7750 *
·ge_addr
 = 
	`·ge_add»ss
(
·ge
);

7751 
size_t
 
Ën
 = 
sg
->
Ëngth
, 
l
;

7752 
size_t
 
off£t
 = 
sg
->offset;

7754 
tÙ_Ën
 +ð
Ën
;

7762 ià(
i
 =ð
ÃÁs
 - 1)

7763 
l
 = 0;

7765 
l
 = 
Ën
;

7766 ià(((
sg
->
off£t
 | 
l
è& 
	`queue_dma_®ignm’t
(
q
)) ||

7767 (
·ge_addr
 && 
	`objeù_is_Ú_¡ack
Õage_add¸+ 
sg
->
off£t
))) {

7768 
rq
 = 
	`ERR_PTR
(-
EINVAL
);

7769 
out_ä“_bios
;

7772 
Ën
 > 0) {

7773 
size_t
 
by‹s
;

7774 
rc
;

7776 ià(
Ãed_Ãw_bio
) {

7777 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 28)

7778 
bio
 = 
	`bio_®loc_bio£t
(
gå_mask
, 
max_Ä_vecs
, 
NULL
);

7779 ià(
bio
)

7780 
bio
->
bi_de¡ruùÜ
 =

7781 
bio_km®loc_de¡ruùÜ
;

7783 
bio
 = 
	`bio_km®loc
(
gå_mask
, 
max_Ä_vecs
);

7785 ià(
bio
 =ð
NULL
) {

7786 
rq
 = 
	`ERR_PTR
(-
ENOMEM
);

7787 
out_ä“_bios
;

7790 ià(!
»adšg
)

7791 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 36)

7792 
bio
->
bi_rw
 |ð1 << 
BIO_RW
;

7794 
bio
->
bi_rw
 |ð
REQ_WRITE
;

7796 
bios
++;

7797 
bio
->
bi_´iv©e
 = 
bw
;

7798 
bio
->
bi_’d_io
 = 
blk_bio_m­_k”n_’dio
;

7800 ià(
hbio
 =ð
NULL
)

7801 
hbio
 = 
bio
;

7803 
tbio
->
bi_Ãxt
 = 
bio
;

7804 
tbio
 = 
bio
;

7807 
by‹s
 = 
	`mš_t
(
size_t
, 
Ën
, 
PAGE_SIZE
 - 
off£t
);

7809 
rc
 = 
	`bio_add_pc_·ge
(
q
, 
bio
, 
·ge
, 
by‹s
, 
off£t
);

7810 ià(
rc
 < 
by‹s
) {

7811 ià(
	`uÆik–y
(
Ãed_Ãw_bio
 || 
rc
 < 0)) {

7812 
rq
 = 
	`ERR_PTR
(
rc
 < 0 ?„ø: -
EIO
);

7813 
out_ä“_bios
;

7815 
Ãed_Ãw_bio
 = 
Œue
;

7816 
Ën
 -ð
rc
;

7817 
off£t
 +ð
rc
;

7820 
Ãed_Ãw_bio
 = 
çl£
;

7821 
off£t
 = 0;

7822 
Ën
 -ð
by‹s
;

7823 
·ge
 = 
	`Áh_·ge
(page, 1);

7828 ià(
hbio
 =ð
NULL
) {

7829 
rq
 = 
	`ERR_PTR
(-
EINVAL
);

7830 
out_ä“_bios
;

7834 ià((
tÙ_Ën
 & 
q
->
dma_·d_mask
è&& 
bw
 !ð
NULL
) {

7835 
rq
 = 
	`ERR_PTR
(-
EINVAL
);

7836 
out_ä“_bios
;

7839 
rq
 = 
	`blk_make_»que¡
(
q
, 
hbio
, 
gå_mask
);

7840 ià(
	`uÆik–y
(
	`IS_ERR
(
rq
)))

7841 
out_ä“_bios
;

7843 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3, 16, 0)

7848 
rq
->
cmd_ty³
 = 
REQ_TYPE_BLOCK_PC
;

7851 ià(
bw
 !ð
NULL
) {

7852 
	`©omic_£t
(&
bw
->
bios_šæight
, 
bios
);

7853 
rq
->
cmd_æags
 |ð
REQ_COPY_USER
;

7856 
out
:

7857  
rq
;

7859 
out_ä“_bios
:

7860 
hbio
 !ð
NULL
) {

7861 
bio
 = 
hbio
;

7862 
hbio
 = hbio->
bi_Ãxt
;

7863 
	`bio_put
(
bio
);

7865 
out
;

7866 
	}
}

7879 
»que¡
 *
	$blk_m­_k”n_sg
(
»que¡_queue
 *
q
,

7880 
sÿ‰”li¡
 *
sgl
, 
ÃÁs
, 
gå_t
 
gå
, 
boÞ
 
»adšg
)

7882 
»que¡
 *
rq
;

7884 ià(!
sgl
) {

7885 
rq
 = 
	`blk_g‘_»que¡
(
q
, 
»adšg
 ? 
READ
 : 
WRITE
, 
gå
);

7886 ià(
	`uÆik–y
(!
rq
))

7887  
	`ERR_PTR
(-
ENOMEM
);

7889 
rq
->
cmd_ty³
 = 
REQ_TYPE_BLOCK_PC
;

7890 
out
;

7893 
rq
 = 
	`__blk_m­_k”n_sg
(
q
, 
sgl
, 
ÃÁs
, 
NULL
, 
gå
, 
»adšg
);

7894 ià(
	`uÆik–y
(
	`IS_ERR
(
rq
))) {

7895 
blk_k”n_sg_wÜk
 *
bw
;

7897 
bw
 = 
	`blk_cÝy_k”n_sg
(
q
, 
sgl
, 
ÃÁs
, 
gå
, 
»adšg
);

7898 ià(
	`uÆik–y
(
	`IS_ERR
(
bw
))) {

7899 
rq
 = 
	`ERR_PTR
(
	`PTR_ERR
(
bw
));

7900 
out
;

7903 
rq
 = 
	`__blk_m­_k”n_sg
(
q
, 
bw
->
sg_bË
.
sgl
, bw->sg_bË.
ÃÁs
,

7904 
bw
, 
gå
, 
»adšg
);

7905 ià(
	`IS_ERR
(
rq
)) {

7906 
	`blk_ä“_k”n_sg_wÜk
(
bw
);

7907 
out
;

7911 
out
:

7912  
rq
;

7913 
	}
}

7916 #ià!
defšed
(
SCSI_EXEC_REQ_FIFO_DEFINED
)

7922 
sg_cÝy_–em
(
sÿ‰”li¡
 **
pd¡_sg
, 
size_t
 *
pd¡_Ën
,

7923 
size_t
 *
pd¡_offs
, 
sÿ‰”li¡
 *
¤c_sg
,

7924 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 4, 0)

7925 
size_t
 
cÝy_Ën
,

7926 
km_ty³
 
d_km_ty³
, km_ty³ 
s_km_ty³
)

7928 
size_t
 
	gcÝy_Ën
)

7931 
	g»s
 = 0;

7932 
sÿ‰”li¡
 *
	gd¡_sg
;

7933 
size_t
 
	g¤c_Ën
, 
	gd¡_Ën
, 
	g¤c_offs
, 
	gd¡_offs
;

7934 
·ge
 *
	g¤c_·ge
, *
	gd¡_·ge
;

7936 
	gd¡_sg
 = *
pd¡_sg
;

7937 
	gd¡_Ën
 = *
pd¡_Ën
;

7938 
	gd¡_offs
 = *
pd¡_offs
;

7939 
	gd¡_·ge
 = 
sg_·ge
(
d¡_sg
);

7941 
	g¤c_·ge
 = 
sg_·ge
(
¤c_sg
);

7942 
	g¤c_Ën
 = 
¤c_sg
->
Ëngth
;

7943 
	g¤c_offs
 = 
¤c_sg
->
off£t
;

7946 *
	g§ddr
, *
	gdaddr
;

7947 
size_t
 
	gn
;

7949 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 4, 0)

7950 
	g§ddr
 = 
km­_©omic
(
¤c_·ge
 +

7951 (
¤c_offs
 >> 
PAGE_SHIFT
), 
s_km_ty³
) +

7952 (
	g¤c_offs
 & ~
	gPAGE_MASK
);

7953 
	gdaddr
 = 
km­_©omic
(
d¡_·ge
 +

7954 (
d¡_offs
 >> 
PAGE_SHIFT
), 
d_km_ty³
) +

7955 (
	gd¡_offs
 & ~
	gPAGE_MASK
);

7957 
	g§ddr
 = 
km­_©omic
(
¤c_·ge
 + (
¤c_offs
 >> 
PAGE_SHIFT
)) +

7958 (
¤c_offs
 & ~
PAGE_MASK
);

7959 
	gdaddr
 = 
km­_©omic
(
d¡_·ge
 + (
d¡_offs
 >> 
PAGE_SHIFT
)) +

7960 (
d¡_offs
 & ~
PAGE_MASK
);

7963 ià(((
	g¤c_offs
 & ~
	gPAGE_MASK
) == 0) &&

7964 ((
d¡_offs
 & ~
PAGE_MASK
) == 0) &&

7965 (
¤c_Ën
 >ð
PAGE_SIZE
è&& (
d¡_Ën
 >= PAGE_SIZE) &&

7966 (
cÝy_Ën
 >ð
PAGE_SIZE
)) {

7967 
cÝy_·ge
(
daddr
, 
§ddr
);

7968 
	gn
 = 
PAGE_SIZE
;

7970 
	gn
 = 
mš_t
(
size_t
, 
PAGE_SIZE
 - (
d¡_offs
 & ~
PAGE_MASK
),

7971 
PAGE_SIZE
 - (
¤c_offs
 & ~
PAGE_MASK
));

7972 
	gn
 = 
mš
(
n
, 
¤c_Ën
);

7973 
	gn
 = 
mš
(
n
, 
d¡_Ën
);

7974 
	gn
 = 
mš_t
(
size_t
, 
n
, 
cÝy_Ën
);

7975 
memýy
(
daddr
, 
§ddr
, 
n
);

7977 
	gd¡_offs
 +ð
n
;

7978 
	g¤c_offs
 +ð
n
;

7980 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 4, 0)

7981 
kunm­_©omic
(
§ddr
, 
s_km_ty³
);

7982 
kunm­_©omic
(
daddr
, 
d_km_ty³
);

7984 
kunm­_©omic
(
§ddr
);

7985 
kunm­_©omic
(
daddr
);

7988 
	g»s
 +ð
n
;

7989 
	gcÝy_Ën
 -ð
n
;

7990 ià(
	gcÝy_Ën
 == 0)

7991 
out
;

7993 
	g¤c_Ën
 -ð
n
;

7994 
	gd¡_Ën
 -ð
n
;

7995 ià(
	gd¡_Ën
 == 0) {

7996 
d¡_sg
 = 
sg_Ãxt_šlše
(dst_sg);

7997 ià(
	gd¡_sg
 =ð
NULL
)

7998 
out
;

7999 
	gd¡_·ge
 = 
sg_·ge
(
d¡_sg
);

8000 
	gd¡_Ën
 = 
d¡_sg
->
Ëngth
;

8001 
	gd¡_offs
 = 
d¡_sg
->
off£t
;

8003 } 
	g¤c_Ën
 > 0);

8005 
	gout
:

8006 *
pd¡_sg
 = 
d¡_sg
;

8007 *
	gpd¡_Ën
 = 
d¡_Ën
;

8008 *
	gpd¡_offs
 = 
d¡_offs
;

8009  
	g»s
;

8026 
sg_cÝy
(
sÿ‰”li¡
 *
d¡_sg
, sÿ‰”li¡ *
¤c_sg
,

8027 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 4, 0)

8028 
ÃÁs_to_cÝy
, 
size_t
 
cÝy_Ën
,

8029 
km_ty³
 
d_km_ty³
, km_ty³ 
s_km_ty³
)

8031 
	gÃÁs_to_cÝy
, 
size_t
 
	gcÝy_Ën
)

8034 
	g»s
 = 0;

8035 
size_t
 
	gd¡_Ën
, 
	gd¡_offs
;

8037 ià(
	gcÝy_Ën
 == 0)

8038 
cÝy_Ën
 = 0x7FFFFFFF;

8040 ià(
	gÃÁs_to_cÝy
 == 0)

8041 
ÃÁs_to_cÝy
 = 0x7FFFFFFF;

8043 
	gd¡_Ën
 = 
d¡_sg
->
Ëngth
;

8044 
	gd¡_offs
 = 
d¡_sg
->
off£t
;

8047 
	gcÝ›d
 = 
sg_cÝy_–em
(&
d¡_sg
, &
d¡_Ën
, &
d¡_offs
,

8048 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 4, 0)

8049 
¤c_sg
, 
cÝy_Ën
, 
d_km_ty³
, 
s_km_ty³
);

8051 
	g¤c_sg
, 
	gcÝy_Ën
);

8053 
	gcÝy_Ën
 -ð
cÝ›d
;

8054 
	g»s
 +ð
cÝ›d
;

8055 ià((
	gcÝy_Ën
 =ð0è|| (
d¡_sg
 =ð
NULL
))

8056 
out
;

8058 
	gÃÁs_to_cÝy
--;

8059 ià(
	gÃÁs_to_cÝy
 == 0)

8060 
out
;

8062 
	g¤c_sg
 = 
sg_Ãxt_šlše
(
¤c_sg
);

8063 } 
	g¤c_sg
 !ð
NULL
);

8065 
	gout
:

8066  
»s
;

8070 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 30)

8071 
	$scsi_’d_async
(
»que¡
 *
»q
, 
”rÜ
)

8073 
scsi_io_cÚ‹xt
 *
sioc
 = 
»q
->
’d_io_d©a
;

8075 
	`TRACE_DBG
("sioø%p, cmd %p", 
sioc
, sioc->
d©a
);

8077 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3, 17, 0)

8078 
	`lockd•_as£¹_h–d
(
»q
->
q
->
queue_lock
);

8080 ià(!
»q
->
q
->
mq_Ýs
)

8081 
	`lockd•_as£¹_h–d
(
»q
->
q
->
queue_lock
);

8084 ià(
sioc
->
dÚe
)

8085 #ià
LINUX_VERSION_CODE
 <ð
	`KERNEL_VERSION
(2, 6, 30)

8086 
sioc
->
	`dÚe
(sioc->
d©a
, sioc->
£n£
, 
»q
->
”rÜs
,„eq->
d©a_Ën
);

8088 
sioc
->
	`dÚe
(sioc->
d©a
, sioc->
£n£
, 
»q
->
”rÜs
,„eq->
»sid_Ën
);

8091 
	`kmem_ÿche_ä“
(
scsi_io_cÚ‹xt_ÿche
, 
sioc
);

8093 
	`__blk_put_»que¡
(
»q
->
q
,„eq);

8095 
	}
}

8103 
sc¡_scsi_exec_async
(
sc¡_cmd
 *
cmd
, *
d©a
,

8104 (*
dÚe
)(*
d©a
, *
£n£
, 
»suÉ
, 
»sid
))

8106 
»s
 = 0;

8107 
»que¡_queue
 *
q
 = 
cmd
->
dev
->
scsi_dev
->request_queue;

8108 
»que¡
 *
rq
;

8109 
scsi_io_cÚ‹xt
 *
sioc
;

8110 
boÞ
 
»adšg
 = !(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
);

8111 
gå_t
 
gå
 = 
cmd
->
cmd_gå_mask
;

8112 
cmd_Ën
 = 
cmd
->
cdb_Ën
;

8114 
sioc
 = 
	`kmem_ÿche_z®loc
(
scsi_io_cÚ‹xt_ÿche
, 
gå
);

8115 ià(
sioc
 =ð
NULL
) {

8116 
»s
 = -
ENOMEM
;

8117 
out
;

8120 ià(
cmd
->
d©a_dœeùiÚ
 =ð
SCST_DATA_BIDI
) {

8121 
»que¡
 *
Ãxt_rq
;

8123 ià(!
	`‹¡_b™
(
QUEUE_FLAG_BIDI
, &
q
->
queue_æags
)) {

8124 
»s
 = -
EOPNOTSUPP
;

8125 
out_ä“_sioc
;

8128 
rq
 = 
	`blk_m­_k”n_sg
(
q
, 
cmd
->
out_sg
, cmd->
out_sg_út
, 
gå
,

8129 
»adšg
);

8130 ià(
	`IS_ERR
(
rq
)) {

8131 
»s
 = 
	`PTR_ERR
(
rq
);

8132 
	`TRACE_DBG
("blk_m­_k”n_sg(èçžed: %d", 
»s
);

8133 
out_ä“_sioc
;

8136 
Ãxt_rq
 = 
	`blk_m­_k”n_sg
(
q
, 
cmd
->
sg
, cmd->
sg_út
, 
gå
, 
çl£
);

8137 ià(
	`IS_ERR
(
Ãxt_rq
)) {

8138 
»s
 = 
	`PTR_ERR
(
Ãxt_rq
);

8139 
	`TRACE_DBG
("blk_m­_k”n_sg(èçžed: %d", 
»s
);

8140 
out_ä“_unm­
;

8142 
rq
->
Ãxt_rq
 =‚ext_rq;

8144 
rq
 = 
	`blk_m­_k”n_sg
(
q
, 
cmd
->
sg
, cmd->
sg_út
, 
gå
, 
»adšg
);

8145 ià(
	`IS_ERR
(
rq
)) {

8146 
»s
 = 
	`PTR_ERR
(
rq
);

8147 
	`TRACE_DBG
("blk_m­_k”n_sg(èçžed: %d", 
»s
);

8148 
out_ä“_sioc
;

8152 
	`TRACE_DBG
("sioø%p, cmd %p", 
sioc
, 
cmd
);

8154 
sioc
->
d©a
 = data;

8155 
sioc
->
dÚe
 = done;

8157 
rq
->
cmd_Ën
 = cmd_len;

8158 ià(
rq
->
cmd_Ën
 <ð
BLK_MAX_CDB
) {

8159 
	`mem£t
(
rq
->
cmd
, 0, 
BLK_MAX_CDB
);

8160 
	`memýy
(
rq
->
cmd
, cmd->
cdb
, cmd->
cdb_Ën
);

8162 
rq
->
cmd
 = cmd->
cdb
;

8164 
rq
->
£n£
 = 
sioc
->sense;

8165 
rq
->
£n£_Ën
 = (
sioc
->
£n£
);

8166 
rq
->
timeout
 = 
cmd
->timeout;

8167 
rq
->
»Œ›s
 = 
cmd
->retries;

8168 
rq
->
’d_io_d©a
 = 
sioc
;

8169 #ià
LINUX_VERSION_CODE
 > 
	`KERNEL_VERSION
(2, 6, 35)

8170 
rq
->
cmd_æags
 |ð
REQ_FAILFAST_MASK
;

8173 
	`blk_execu‹_rq_nowa™
(
rq
->
q
, 
NULL
,„q,

8174 (
cmd
->
queue_ty³
 =ð
SCST_CMD_QUEUE_HEAD_OF_QUEUE
), 
scsi_’d_async
);

8175 
out
:

8176  
»s
;

8178 
out_ä“_unm­
:

8180 
bio
 *biØð
rq
->bio, *
b
;

8182 
bio
) {

8183 
b
 = 
bio
;

8184 
bio
 = bio->
bi_Ãxt
;

8185 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 3, 0)

8186 
b
->
	`bi_’d_io
(b, 
»s
);

8188 
b
->
bi_”rÜ
 = 
»s
;

8189 
b
->
	`bi_’d_io
(b);

8193 
rq
->
bio
 = 
NULL
;

8195 
	`blk_put_»que¡
(
rq
);

8197 
out_ä“_sioc
:

8198 
	`kmem_ÿche_ä“
(
scsi_io_cÚ‹xt_ÿche
, 
sioc
);

8199 
out
;

8200 
	}
}

8201 
EXPORT_SYMBOL
(
sc¡_scsi_exec_async
);

8210 
sg_cmp_–em
(
sÿ‰”li¡
 **
pd¡_sg
, 
size_t
 *
pd¡_Ën
,

8211 
size_t
 *
pd¡_offs
, 
sÿ‰”li¡
 *
¤c_sg
,

8212 
size_t
 
cmp_Ën
, *
miscom·»_offs
,

8213 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 4, 0)

8214 
km_ty³
 
d_km_ty³
, km_ty³ 
s_km_ty³
,

8216 
boÞ
 *
cmp_»s
)

8218 
	g»s
 = 0;

8219 
sÿ‰”li¡
 *
	gd¡_sg
;

8220 
size_t
 
	g¤c_Ën
, 
	gd¡_Ën
, 
	g¤c_offs
, 
	gd¡_offs
;

8221 
·ge
 *
	g¤c_·ge
, *
	gd¡_·ge
;

8222 *
	g§ddr
, *
	gdaddr
;

8224 *
	gcmp_»s
 = 
Œue
;

8226 
	gd¡_sg
 = *
pd¡_sg
;

8227 
	gd¡_Ën
 = *
pd¡_Ën
;

8228 
	gd¡_offs
 = *
pd¡_offs
;

8229 
	gd¡_·ge
 = 
sg_·ge
(
d¡_sg
);

8231 
	g¤c_·ge
 = 
sg_·ge
(
¤c_sg
);

8232 
	g¤c_Ën
 = 
¤c_sg
->
Ëngth
;

8233 
	g¤c_offs
 = 
¤c_sg
->
off£t
;

8236 
size_t
 
	gn
;

8237 
	grc
;

8239 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 4, 0)

8240 
	g§ddr
 = 
km­_©omic
(
¤c_·ge
 + (
¤c_offs
 >> 
PAGE_SHIFT
), 
s_km_ty³
) +

8241 (
	g¤c_offs
 & ~
	gPAGE_MASK
);

8242 
	gdaddr
 = 
km­_©omic
(
d¡_·ge
 + (
d¡_offs
 >> 
PAGE_SHIFT
), 
d_km_ty³
) +

8243 (
	gd¡_offs
 & ~
	gPAGE_MASK
);

8245 
	g§ddr
 = 
km­_©omic
(
¤c_·ge
 + (
¤c_offs
 >> 
PAGE_SHIFT
)) +

8246 (
¤c_offs
 & ~
PAGE_MASK
);

8247 
	gdaddr
 = 
km­_©omic
(
d¡_·ge
 + (
d¡_offs
 >> 
PAGE_SHIFT
)) +

8248 (
d¡_offs
 & ~
PAGE_MASK
);

8251 ià(((
	g¤c_offs
 & ~
	gPAGE_MASK
) == 0) &&

8252 ((
d¡_offs
 & ~
PAGE_MASK
) == 0) &&

8253 (
¤c_Ën
 >ð
PAGE_SIZE
è&& (
d¡_Ën
 >= PAGE_SIZE) &&

8254 (
cmp_Ën
 >ð
PAGE_SIZE
))

8255 
n
 = 
PAGE_SIZE
;

8257 
	gn
 = 
mš_t
(
size_t
, 
PAGE_SIZE
 - (
d¡_offs
 & ~
PAGE_MASK
),

8258 
PAGE_SIZE
 - (
¤c_offs
 & ~
PAGE_MASK
));

8259 
	gn
 = 
mš
(
n
, 
¤c_Ën
);

8260 
	gn
 = 
mš
(
n
, 
d¡_Ën
);

8261 
	gn
 = 
mš_t
(
size_t
, 
n
, 
cmp_Ën
);

8266 
	grc
 = 
memcmp
(
daddr
, 
§ddr
, 
n
);

8267 ià(
	grc
 != 0) {

8268 *
cmp_»s
 = 
çl£
;

8269 ià(
	gmiscom·»_offs
 !ð
NULL
) {

8270 
i
, 
Ën
 = 
n
;

8271 
	g§ddr_št
 = ()
§ddr
;

8272 
	gdaddr_št
 = ()
daddr
;

8273 
	g®ign_size
 = ();

8274 
	g®ign_mask
 = 
®ign_size
-1;

8276 *
	gmiscom·»_offs
 = -1;

8278 ià(((
	g§ddr_št
 & 
	g®ign_mask
) == 0) &&

8279 ((
daddr_št
 & 
®ign_mask
) == 0) &&

8280 ((
Ën
 & 
®ign_mask
) == 0)) {

8282 *
s
 = 
§ddr
;

8283 *
	gd
 = 
daddr
;

8285 
EXTRACHECKS_BUG_ON
(
Ën
 % 
®ign_size
 != 0);

8286 
	gËn
 /ð
®ign_size
;

8287 
	gi
 = 0; i < 
	gËn
; i++) {

8288 ià(
	gs
[
i
] !ð
d
[i]) {

8289 
ušt8_t
 *
s8
 = (ušt8_ˆ*)&
s
[
i
];

8290 
ušt8_t
 *
	gd8
 = (ušt8_ˆ*)&
d
[
i
];

8291 
	gj
;

8293 
	gj
 = 0; j < 
	g®ign_size
; j++) {

8294 ià(
	gs8
[
j
] !ð
d8
[j]) {

8295 *
miscom·»_offs
 = 
i
 * 
®ign_size
 + 
j
;

8303 
ušt8_t
 *
	gs
 = 
§ddr
;

8304 
ušt8_t
 *
	gd
 = 
daddr
;

8306 
	gi
 = 0; i < 
	gËn
; i++) {

8307 ià(
	gs
[
i
] !ð
d
[i]) {

8308 *
miscom·»_offs
 = 
i
;

8313 
EXTRACHECKS_BUG_ON
(*
miscom·»_offs
 == -1);

8315 
	gout_unm­
;

8318 
	gd¡_offs
 +ð
n
;

8319 
	g¤c_offs
 +ð
n
;

8321 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 4, 0)

8322 
kunm­_©omic
(
§ddr
, 
s_km_ty³
);

8323 
kunm­_©omic
(
daddr
, 
d_km_ty³
);

8325 
kunm­_©omic
(
§ddr
);

8326 
kunm­_©omic
(
daddr
);

8329 
	g»s
 +ð
n
;

8330 
	gcmp_Ën
 -ð
n
;

8331 ià(
	gcmp_Ën
 == 0)

8332 
out
;

8334 
	g¤c_Ën
 -ð
n
;

8335 
	gd¡_Ën
 -ð
n
;

8336 ià(
	gd¡_Ën
 == 0) {

8337 
d¡_sg
 = 
sg_Ãxt_šlše
(dst_sg);

8338 ià(
	gd¡_sg
 =ð
NULL
)

8339 
out
;

8340 
	gd¡_·ge
 = 
sg_·ge
(
d¡_sg
);

8341 
	gd¡_Ën
 = 
d¡_sg
->
Ëngth
;

8342 
	gd¡_offs
 = 
d¡_sg
->
off£t
;

8344 } 
	g¤c_Ën
 > 0);

8346 
	gout
:

8347 *
pd¡_sg
 = 
d¡_sg
;

8348 *
	gpd¡_Ën
 = 
d¡_Ën
;

8349 *
	gpd¡_offs
 = 
d¡_offs
;

8350  
	g»s
;

8352 
	gout_unm­
:

8353 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 4, 0)

8354 
kunm­_©omic
(
§ddr
, 
s_km_ty³
);

8355 
kunm­_©omic
(
daddr
, 
d_km_ty³
);

8357 
kunm­_©omic
(
§ddr
);

8358 
kunm­_©omic
(
daddr
);

8360 
	gout
;

8381 
boÞ
 
sg_cmp
(
sÿ‰”li¡
 *
d¡_sg
, sÿ‰”li¡ *
¤c_sg
,

8382 
ÃÁs_to_cmp
, 
size_t
 
cmp_Ën
, *
miscom·»_offs


8383 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 4, 0)

8384 , 
km_ty³
 
d_km_ty³
, km_ty³ 
s_km_ty³


8388 
boÞ
 
	g»s
 = 
Œue
;

8389 
size_t
 
	gd¡_Ën
, 
	gd¡_offs
;

8390 
	gcom·»d_®l
 = 0;

8392 
TRACE_ENTRY
();

8394 
TRACE_DBG
("dst_sg %p, src_sg %p,‚ents_to_cmp %d, cmp_len %zd",

8395 
d¡_sg
, 
¤c_sg
, 
ÃÁs_to_cmp
, 
cmp_Ën
);

8397 ià(
	gcmp_Ën
 == 0)

8398 
cmp_Ën
 = 0x7FFFFFFF;

8400 ià(
	gÃÁs_to_cmp
 == 0)

8401 
ÃÁs_to_cmp
 = 0x7FFFFFFF;

8403 
	gd¡_Ën
 = 
d¡_sg
->
Ëngth
;

8404 
	gd¡_offs
 = 
d¡_sg
->
off£t
;

8407 
	gcom·»d
;

8409 
TRACE_DBG
("dst_sg %p, dst_len %zd, dst_offs %zd, src_sg %p, "

8411 
d¡_sg
, 
d¡_Ën
, 
d¡_offs
, 
¤c_sg
, 
ÃÁs_to_cmp
,

8412 
cmp_Ën
, 
com·»d_®l
);

8414 
	gcom·»d
 = 
sg_cmp_–em
(&
d¡_sg
, &
d¡_Ën
, &
d¡_offs
,

8415 
¤c_sg
, 
cmp_Ën
, 
miscom·»_offs
,

8416 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 4, 0)

8417 
d_km_ty³
, 
s_km_ty³
,

8419 &
»s
);

8420 ià(!
	g»s
) {

8421 ià(
	gmiscom·»_offs
 !ð
NULL
) {

8422 *
miscom·»_offs
 +ð
com·»d_®l
;

8423 
TRACE_DBG
("miscompare_offs %d",

8424 *
miscom·»_offs
);

8426 
	gout
;

8428 
	gcmp_Ën
 -ð
com·»d
;

8429 
	gcom·»d_®l
 +ð
com·»d
;

8430 ià((
	gcmp_Ën
 =ð0è|| (
d¡_sg
 =ð
NULL
))

8431 
out
;

8433 
	gÃÁs_to_cmp
--;

8434 ià(
	gÃÁs_to_cmp
 == 0)

8435 
out
;

8437 
	g¤c_sg
 = 
sg_Ãxt_šlše
(
¤c_sg
);

8438 } 
	g¤c_sg
 !ð
NULL
);

8440 
	gout
:

8441 
TRACE_EXIT_RES
(
»s
);

8442  
	g»s
;

8452 
	$sc¡_cÝy_sg
(
sc¡_cmd
 *
cmd
, 
sc¡_sg_cÝy_dœ
 
cÝy_dœ
)

8454 
sÿ‰”li¡
 *
¤c_sg
, *
d¡_sg
;

8455 
sÿ‰”li¡
 *
¤c_sg_dif
, *
d¡_sg_dif
;

8456 
to_cÝy
, 
to_cÝy_dif
;

8457 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3, 4, 0)

8458 
©omic
 = 
	`sc¡_cmd_©omic
(
cmd
);

8461 
	`TRACE_ENTRY
();

8463 ià(
cÝy_dœ
 =ð
SCST_SG_COPY_FROM_TARGET
) {

8464 ià(
cmd
->
d©a_dœeùiÚ
 !ð
SCST_DATA_BIDI
) {

8465 
¤c_sg
 = 
cmd
->
tgt_i_sg
;

8466 
d¡_sg
 = 
cmd
->
sg
;

8467 
to_cÝy
 = 
cmd
->
bufæ’
;

8468 
¤c_sg_dif
 = 
cmd
->
tgt_i_dif_sg
;

8469 
d¡_sg_dif
 = 
cmd
->
dif_sg
;

8470 
to_cÝy_dif
 = 
	`sc¡_cmd_g‘_bufæ’_dif
(
cmd
);

8472 
	`TRACE_MEM
("BIDI cmd %p", 
cmd
);

8473 
¤c_sg
 = 
cmd
->
tgt_out_sg
;

8474 
d¡_sg
 = 
cmd
->
out_sg
;

8475 
to_cÝy
 = 
cmd
->
out_bufæ’
;

8476 
¤c_sg_dif
 = 
NULL
;

8477 
d¡_sg_dif
 = 
NULL
;

8478 
to_cÝy_dif
 = 0;

8481 
¤c_sg
 = 
cmd
->
sg
;

8482 
d¡_sg
 = 
cmd
->
tgt_i_sg
;

8483 
to_cÝy
 = 
cmd
->
adju¡ed_»¥_d©a_Ën
;

8484 
¤c_sg_dif
 = 
cmd
->
dif_sg
;

8485 
d¡_sg_dif
 = 
cmd
->
tgt_i_dif_sg
;

8486 
to_cÝy_dif
 = 
	`sc¡_cmd_g‘_bufæ’_dif
(
cmd
);

8489 
	`TRACE_MEM
("cmd %p, copy_dir %d, src_sg %p, dst_sg %p,o_copy %lld, "

8491 
cmd
, 
cÝy_dœ
, 
¤c_sg
, 
d¡_sg
, ()
to_cÝy
,

8492 
¤c_sg_dif
, 
d¡_sg_dif
, ()
to_cÝy_dif
);

8494 ià(
	`uÆik–y
(
¤c_sg
 =ð
NULL
è|| uÆik–y(
d¡_sg
 == NULL) ||

8495 
	`uÆik–y
(
to_cÝy
 == 0)) {

8500 
out
;

8503 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3, 4, 0)

8504 
	`sg_cÝy
(
d¡_sg
, 
¤c_sg
, 0, 
to_cÝy
,

8505 
©omic
 ? 
KM_SOFTIRQ0
 : 
KM_USER0
,

8506 
©omic
 ? 
KM_SOFTIRQ1
 : 
KM_USER1
);

8508 
	`sg_cÝy
(
d¡_sg
, 
¤c_sg
, 0, 
to_cÝy
);

8511 ià((
¤c_sg_dif
 =ð
NULL
è|| (
d¡_sg_dif
 =ðNULLè|| (
to_cÝy_dif
 == 0))

8512 
out
;

8514 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3, 4, 0)

8515 
	`sg_cÝy
(
d¡_sg_dif
, 
¤c_sg_dif
, 0, 
to_cÝy_dif
,

8516 
©omic
 ? 
KM_SOFTIRQ0
 : 
KM_USER0
,

8517 
©omic
 ? 
KM_SOFTIRQ1
 : 
KM_USER1
);

8519 
	`sg_cÝy
(
d¡_sg_dif
, 
¤c_sg_dif
, 0, 
to_cÝy_dif
);

8522 
out
:

8523 
	`TRACE_EXIT
();

8525 
	}
}

8526 
EXPORT_SYMBOL_GPL
(
sc¡_cÝy_sg
);

8537 
	$sc¡_g‘_buf_fuÎ
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 **
buf
)

8539 
»s
 = 0;

8541 
	`TRACE_ENTRY
();

8543 
	`EXTRACHECKS_BUG_ON
(
cmd
->
sg_buff_vm®loÿ‹d
);

8545 ià(
	`sc¡_g‘_buf_couÁ
(
cmd
) > 1) {

8546 
Ën
;

8547 
ušt8_t
 *
tmp_buf
;

8548 
fuÎ_size
;

8550 
fuÎ_size
 = 0;

8551 
Ën
 = 
	`sc¡_g‘_buf_fœ¡
(
cmd
, &
tmp_buf
);

8552 
Ën
 > 0) {

8553 
fuÎ_size
 +ð
Ën
;

8554 
	`sc¡_put_buf
(
cmd
, 
tmp_buf
);

8555 
Ën
 = 
	`sc¡_g‘_buf_Ãxt
(
cmd
, &
tmp_buf
);

8558 #ifdeà
__COVERITY__


8560 *
buf
 = 
fuÎ_size
 ? 
	`vm®loc
(fuÎ_sizeè: 
NULL
;

8562 *
buf
 = 
	`vm®loc
(
fuÎ_size
);

8564 ià(*
buf
 =ð
NULL
) {

8565 
	`TRACE
(
TRACE_OUT_OF_MEM
, "vmalloc() failed for opcode "

8566 "%s", 
	`sc¡_g‘_Ýcode_Çme
(
cmd
));

8567 
»s
 = -
ENOMEM
;

8568 
out
;

8570 
cmd
->
sg_buff_vm®loÿ‹d
 = 1;

8572 ià(
	`sc¡_cmd_g‘_d©a_dœeùiÚ
(
cmd
è=ð
SCST_DATA_WRITE
) {

8573 
ušt8_t
 *
buf_±r
;

8575 
buf_±r
 = *
buf
;

8577 
Ën
 = 
	`sc¡_g‘_buf_fœ¡
(
cmd
, &
tmp_buf
);

8578 
Ën
 > 0) {

8579 
	`memýy
(
buf_±r
, 
tmp_buf
, 
Ën
);

8580 
buf_±r
 +ð
Ën
;

8582 
	`sc¡_put_buf
(
cmd
, 
tmp_buf
);

8583 
Ën
 = 
	`sc¡_g‘_buf_Ãxt
(
cmd
, &
tmp_buf
);

8586 
»s
 = 
fuÎ_size
;

8588 
»s
 = 
	`sc¡_g‘_buf_fœ¡
(
cmd
, 
buf
);

8590 
out
:

8591 
	`TRACE_EXIT_RES
(
»s
);

8592  
»s
;

8593 
	}
}

8594 
EXPORT_SYMBOL
(
sc¡_g‘_buf_fuÎ
);

8604 
	$sc¡_g‘_buf_fuÎ_£n£
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 **
buf
)

8606 
»s
 = 0;

8608 
	`TRACE_ENTRY
();

8610 
»s
 = 
	`sc¡_g‘_buf_fuÎ
(
cmd
, 
buf
);

8611 ià(
	`uÆik–y
(
»s
 < 0)) {

8612 
	`PRINT_ERROR
("sc¡_g‘_buf_fuÎ(èçžed: %d", 
»s
);

8613 ià(
»s
 =ð-
ENOMEM
)

8614 
	`sc¡_£t_busy
(
cmd
);

8616 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

8617 
	`SCST_LOAD_SENSE
(
sc¡_£n£_š‹º®_çžu»
));

8618 
out
;

8621 
out
:

8622 
	`TRACE_EXIT_RES
(
»s
);

8623  
»s
;

8624 
	}
}

8625 
EXPORT_SYMBOL
(
sc¡_g‘_buf_fuÎ_£n£
);

8635 
	$sc¡_put_buf_fuÎ
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
buf
)

8637 
	`TRACE_ENTRY
();

8639 ià(
buf
 =ð
NULL
)

8640 
out
;

8642 ià(
cmd
->
sg_buff_vm®loÿ‹d
) {

8643 ià(
	`sc¡_cmd_g‘_d©a_dœeùiÚ
(
cmd
è=ð
SCST_DATA_READ
) {

8644 
Ën
;

8645 
ušt8_t
 *
tmp_buf
, *
buf_p
;

8647 
buf_p
 = 
buf
;

8649 
Ën
 = 
	`sc¡_g‘_buf_fœ¡
(
cmd
, &
tmp_buf
);

8650 
Ën
 > 0) {

8651 
	`memýy
(
tmp_buf
, 
buf_p
, 
Ën
);

8652 
buf_p
 +ð
Ën
;

8654 
	`sc¡_put_buf
(
cmd
, 
tmp_buf
);

8655 
Ën
 = 
	`sc¡_g‘_buf_Ãxt
(
cmd
, &
tmp_buf
);

8660 
cmd
->
sg_buff_vm®loÿ‹d
 = 0;

8662 
	`vä“
(
buf
);

8664 
	`sc¡_put_buf
(
cmd
, 
buf
);

8666 
out
:

8667 
	`TRACE_EXIT
();

8669 
	}
}

8670 
EXPORT_SYMBOL
(
sc¡_put_buf_fuÎ
);

8672 
__be16
 
	$sc¡_dif_üc_â
(cÚ¡ *
d©a
, 
Ën
)

8674 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 27)

8675  
	`ýu_to_be16
(
	`üc_t10dif
(
d©a
, 
Ën
));

8677 
	`WARN_ON_ONCE
(
Œue
);

8680 
	}
}

8682 
__be16
 
	$sc¡_dif__â
(cÚ¡ *
d©a
, 
Ën
)

8684  (
__fÜû
 
__be16
)
	`_compu‹_csum
(
d©a
, 
Ën
);

8685 
	}
}

8687 
	$sc¡_v”ify_dif_ty³1
(
sc¡_cmd
 *
cmd
)

8689 
»s
 = 0;

8690 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

8691 
sc¡_dif_aùiÚs
 
checks
 = 
	`sc¡_g‘_dif_checks
(
cmd
->
cmd_dif_aùiÚs
);

8692 
Ën
, 
gs_Ën
 = 0, 
g_size
 = 1 << 
SCST_DIF_TAG_SHIFT
;

8693 
sÿ‰”li¡
 *
gs_sg
 = 
NULL
;

8694 
ušt8_t
 *
buf
, *
gs_buf
 = 
NULL
;

8695 cÚ¡ 
t10_pi_tu¶e
 *
t
 = 
NULL
;

8696 
ušt64_t
 
lba
 = 
cmd
->lba;

8697 
block_size
 = 
dev
->block_size, 
block_shiá
 = dev->block_shift;

8698 
	`__be16
 (*
üc_â
)(cÚ¡ *
bufãr
, 
Ën
);

8700 
	`TRACE_ENTRY
();

8702 
	`EXTRACHECKS_BUG_ON
(
dev
->
dev_dif_ty³
 != 1);

8704 #ifdeà
CONFIG_SCST_EXTRACHECKS


8705 
	`sc¡_g‘_dif_aùiÚ
(
	`sc¡_g‘_sc¡_dif_aùiÚs
(
cmd
->
cmd_dif_aùiÚs
))) {

8706 
SCST_DIF_ACTION_STRIP
:

8707 
SCST_DIF_ACTION_PASS_CHECK
:

8710 
	`EXTRACHECKS_BUG_ON
(1);

8713 
	`EXTRACHECKS_BUG_ON
(
checks
 =ð
SCST_DIF_ACTION_NONE
);

8716 
üc_â
 = 
cmd
->
tgt_dev
->
tgt_dev_dif_üc_â
;

8718 
Ën
 = 
	`sc¡_g‘_buf_fœ¡
(
cmd
, &
buf
);

8719 
Ën
 > 0) {

8720 
i
;

8721 
ušt8_t
 *
cur_buf
 = 
buf
;

8723 
i
 = 0; i < (
Ën
 >> 
block_shiá
); i++) {

8724 ià(
gs_buf
 =ð
NULL
) {

8725 
gs_buf
 = 
	`sc¡_g‘_dif_buf
(
cmd
, &
gs_sg
, &
gs_Ën
);

8726 
	`EXTRACHECKS_BUG_ON
(
gs_Ën
 <= 0);

8727 
	`TRACE_DBG
("gs_buà%p", 
gs_buf
);

8728 
	`TRACE_BUFF_FLAG
(
TRACE_DEBUG
, "Tagso verify",

8729 
gs_buf
, 
gs_Ën
);

8730 
t
 = (
t10_pi_tu¶e
 *)
gs_buf
;

8733 ià(
t
->
­p_g
 =ð
SCST_DIF_NO_CHECK_ALL_APP_TAG
) {

8734 
	`TRACE_DBG
("Skippingag %lld (cmd %p)",

8735 ()
lba
, 
cmd
);

8736 
Ãxt
;

8739 ià(
checks
 & 
SCST_DIF_CHECK_APP_TAG
) {

8740 ià(
t
->
­p_g
 !ð
dev
->
dev_dif_¡©ic_­p_g
) {

8741 
	`PRINT_WARNING
("APP TAG check failed, "

8744 "dev %s)", 
dev
->
dev_dif_¡©ic_­p_g
,

8745 
t
->
­p_g
, 
cmd
, 
	`sc¡_g‘_Ýcode_Çme
(cmd),

8746 ()
lba
, 
dev
->
vœt_Çme
);

8747 
	`sc¡_dif_acc_­p_check_çžed_sc¡
(
cmd
);

8748 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

8749 
	`SCST_LOAD_SENSE
(
sc¡_logiÿl_block_­p_g_check_çžed
));

8750 
»s
 = -
EIO
;

8751 
out_put
;

8755 ià(
checks
 & 
SCST_DIF_CHECK_REF_TAG
) {

8756 ià(
t
->
»f_g
 !ð
	`ýu_to_be32
(
lba
 & 0xFFFFFFFF)) {

8757 
	`PRINT_WARNING
("REF TAG check failed, "

8760 "dev %s)", 
	`ýu_to_be32
(
lba
 & 0xFFFFFFFF),

8761 
t
->
»f_g
, 
cmd
, 
	`sc¡_g‘_Ýcode_Çme
(cmd),

8762 ()
lba
, 
dev
->
vœt_Çme
);

8763 
	`sc¡_dif_acc_»f_check_çžed_sc¡
(
cmd
);

8764 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

8765 
	`SCST_LOAD_SENSE
(
sc¡_logiÿl_block_»f_g_check_çžed
));

8766 
»s
 = -
EIO
;

8767 
out_put
;

8772 ià((
checks
 & 
SCST_DIF_CHECK_GUARD_TAG
) &&

8773 !
cmd
->
š‹º®
) {

8774 
__be16
 
üc
 = 
	`üc_â
(
cur_buf
, 
block_size
);

8776 ià(
t
->
gu¬d_g
 !ð
üc
) {

8777 
	`PRINT_WARNING
("GUARD TAG check failed, "

8780 "dev %s)", 
üc
, 
t
->
gu¬d_g
, 
cmd
,

8781 
	`sc¡_g‘_Ýcode_Çme
(
cmd
), ()
lba
,

8782 
dev
->
vœt_Çme
);

8783 
	`sc¡_dif_acc_gu¬d_check_çžed_sc¡
(
cmd
);

8784 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

8785 
	`SCST_LOAD_SENSE
(
sc¡_logiÿl_block_gu¬d_check_çžed
));

8786 
»s
 = -
EIO
;

8787 
out_put
;

8791 
Ãxt
:

8792 
cur_buf
 +ð
dev
->
block_size
;

8793 
lba
++;

8795 
t
++;

8796 
gs_Ën
 -ð
g_size
;

8797 ià(
gs_Ën
 == 0) {

8798 
	`sc¡_put_dif_buf
(
cmd
, 
gs_buf
);

8799 
gs_buf
 = 
NULL
;

8803 
	`sc¡_put_buf
(
cmd
, 
buf
);

8804 
Ën
 = 
	`sc¡_g‘_buf_Ãxt
(
cmd
, &
buf
);

8807 
	`EXTRACHECKS_BUG_ON
(
gs_buf
 !ð
NULL
);

8809 
out
:

8810 
	`TRACE_EXIT_RES
(
»s
);

8811  
»s
;

8813 
out_put
:

8814 
	`sc¡_put_buf
(
cmd
, 
buf
);

8815 
	`sc¡_put_dif_buf
(
cmd
, 
gs_buf
);

8816 
out
;

8817 
	}
}

8819 #ifdeà
CONFIG_SCST_DIF_INJECT_CORRUPTED_TAGS


8820 
	$sc¡_check_çž_»f_g
(
sc¡_cmd
 *
cmd
)

8822 
sc¡_dif_aùiÚs
 
checks
 = 
	`sc¡_g‘_dif_checks
(
cmd
->
cmd_dif_aùiÚs
);

8824 ià(((
cmd
->
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_TGT
) == 0) &&

8825 (
checks
 & 
SCST_DIF_CHECK_REF_TAG
)) {

8826 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
, "Nogt dif_mode, failing "

8827 "cmd %°w™h„eàg check fažed", 
cmd
);

8828 
	`sc¡_dif_acc_»f_check_çžed_sc¡
(
cmd
);

8829 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

8830 
	`SCST_LOAD_SENSE
(
sc¡_logiÿl_block_»f_g_check_çžed
));

8833 
	}
}

8835 
	$sc¡_check_çž_gu¬d_g
(
sc¡_cmd
 *
cmd
)

8837 
sc¡_dif_aùiÚs
 
checks
 = 
	`sc¡_g‘_dif_checks
(
cmd
->
cmd_dif_aùiÚs
);

8839 ià(((
cmd
->
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_TGT
) == 0) &&

8840 (
checks
 & 
SCST_DIF_CHECK_GUARD_TAG
)) {

8841 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
, "Nogt dif_mode, failing "

8842 "cmd %°w™h gu¬dag check fažed", 
cmd
);

8843 
	`sc¡_dif_acc_gu¬d_check_çžed_sc¡
(
cmd
);

8844 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

8845 
	`SCST_LOAD_SENSE
(
sc¡_logiÿl_block_gu¬d_check_çžed
));

8848 
	}
}

8851 
	$sc¡_g’”©e_dif_ty³1
(
sc¡_cmd
 *
cmd
)

8853 
»s
 = 0;

8854 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

8855 
Ën
, 
gs_Ën
 = 0, 
g_size
 = 1 << 
SCST_DIF_TAG_SHIFT
;

8856 
sÿ‰”li¡
 *
gs_sg
 = 
NULL
;

8857 
ušt8_t
 *
buf
, *
gs_buf
 = 
NULL
;

8858 
t10_pi_tu¶e
 *
t
 = 
NULL
;

8859 
ušt64_t
 
lba
 = 
cmd
->lba;

8860 
block_size
 = 
dev
->block_size, 
block_shiá
 = dev->block_shift;

8861 
	`__be16
 (*
üc_â
)(cÚ¡ *
bufãr
, 
Ën
);

8863 
	`TRACE_ENTRY
();

8865 
	`EXTRACHECKS_BUG_ON
(
dev
->
dev_dif_ty³
 != 1);

8867 #ifdeà
CONFIG_SCST_EXTRACHECKS


8868 
	`sc¡_g‘_dif_aùiÚ
(
	`sc¡_g‘_sc¡_dif_aùiÚs
(
cmd
->
cmd_dif_aùiÚs
))) {

8869 
SCST_DIF_ACTION_INSERT
:

8872 
	`EXTRACHECKS_BUG_ON
(1);

8877 
üc_â
 = 
cmd
->
tgt_dev
->
tgt_dev_dif_üc_â
;

8879 
Ën
 = 
	`sc¡_g‘_buf_fœ¡
(
cmd
, &
buf
);

8880 
Ën
 > 0) {

8881 
i
;

8882 
ušt8_t
 *
cur_buf
 = 
buf
;

8884 
	`TRACE_DBG
("ËÀ%d", 
Ën
);

8886 
i
 = 0; i < (
Ën
 >> 
block_shiá
); i++) {

8887 
	`TRACE_DBG
("lb¨%Îd,ags_ËÀ%d", ()
lba
, 
gs_Ën
);

8889 ià(
gs_buf
 =ð
NULL
) {

8890 
gs_buf
 = 
	`sc¡_g‘_dif_buf
(
cmd
, &
gs_sg
, &
gs_Ën
);

8891 
	`TRACE_DBG
("tags_sg %p,ags_buf %p,ags_len %d",

8892 
gs_sg
, 
gs_buf
, 
gs_Ën
);

8893 
	`EXTRACHECKS_BUG_ON
(
gs_Ën
 <= 0);

8894 
t
 = (
t10_pi_tu¶e
 *)
gs_buf
;

8897 
t
->
­p_g
 = 
dev
->
dev_dif_¡©ic_­p_g
;

8898 
t
->
»f_g
 = 
	`ýu_to_be32
(
lba
 & 0xFFFFFFFF);

8899 
t
->
gu¬d_g
 = 
	`üc_â
(
cur_buf
, 
block_size
);

8901 #ifdeà
CONFIG_SCST_DIF_INJECT_CORRUPTED_TAGS


8902 
cmd
->
cmd_cÜru±_dif_g
) {

8906 ià(
lba
 =ð
cmd
->lba) {

8907 ià(
cmd
->
cdb
[1] & 0x80) {

8908 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
,

8911 ()
lba
,

8912 
cmd
->
cmd_cÜru±_dif_g
, cmd);

8913 
t
->
»f_g
 = 
	`ýu_to_be32
(0xebfeedad);

8914 
	`sc¡_check_çž_»f_g
(
cmd
);

8916 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
,

8919 ()
lba
,

8920 
cmd
->
cmd_cÜru±_dif_g
, cmd);

8921 
t
->
gu¬d_g
 = 
	`ýu_to_be16
(0xebed);

8922 
	`sc¡_check_çž_gu¬d_g
(
cmd
);

8927 ià(
lba
 =ð(
cmd
->lba + 1)) {

8928 ià(
cmd
->
cdb
[1] & 0x80) {

8929 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
,

8932 ()
lba
,

8933 
cmd
->
cmd_cÜru±_dif_g
, cmd);

8934 
t
->
»f_g
 = 
	`ýu_to_be32
(0xebfeedad);

8935 
	`sc¡_check_çž_»f_g
(
cmd
);

8937 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
,

8940 ()
lba
,

8941 
cmd
->
cmd_cÜru±_dif_g
, cmd);

8942 
t
->
gu¬d_g
 = 
	`ýu_to_be16
(0xebed);

8943 
	`sc¡_check_çž_gu¬d_g
(
cmd
);

8948 ià(
lba
 =ð(
cmd
->lba + 2)) {

8949 ià(
cmd
->
cdb
[1] & 0x80) {

8950 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
,

8953 ()
lba
,

8954 
cmd
->
cmd_cÜru±_dif_g
, cmd);

8955 
t
->
»f_g
 = 
	`ýu_to_be32
(0xebfeedad);

8956 
	`sc¡_check_çž_»f_g
(
cmd
);

8958 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
,

8961 ()
lba
,

8962 
cmd
->
cmd_cÜru±_dif_g
, cmd);

8963 
t
->
gu¬d_g
 = 
	`ýu_to_be16
(0xebed);

8964 
	`sc¡_check_çž_gu¬d_g
(
cmd
);

8969 ià(
lba
 =ð(
cmd
->lb¨+ ((cmd->
d©a_Ën
 >> 
dev
->
block_shiá
) >> 1))) {

8970 ià(
cmd
->
cdb
[1] & 0x80) {

8971 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
,

8974 ()
lba
,

8975 
cmd
->
cmd_cÜru±_dif_g
, cmd);

8976 
t
->
»f_g
 = 
	`ýu_to_be32
(0xebfeedad);

8977 
	`sc¡_check_çž_»f_g
(
cmd
);

8979 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
,

8982 ()
lba
,

8983 
cmd
->
cmd_cÜru±_dif_g
, cmd);

8984 
t
->
gu¬d_g
 = 
	`ýu_to_be16
(0xebed);

8985 
	`sc¡_check_çž_gu¬d_g
(
cmd
);

8990 ià(
lba
 =ð(
cmd
->lb¨+ ((cmd->
d©a_Ën
 >> 
dev
->
block_shiá
) - 3))) {

8991 ià(
cmd
->
cdb
[1] & 0x80) {

8992 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
,

8995 ()
lba
,

8996 
cmd
->
cmd_cÜru±_dif_g
, cmd);

8997 
t
->
»f_g
 = 
	`ýu_to_be32
(0xebfeedad);

8998 
	`sc¡_check_çž_»f_g
(
cmd
);

9000 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
,

9003 ()
lba
,

9004 
cmd
->
cmd_cÜru±_dif_g
, cmd);

9005 
t
->
gu¬d_g
 = 
	`ýu_to_be16
(0xebed);

9006 
	`sc¡_check_çž_gu¬d_g
(
cmd
);

9011 ià(
lba
 =ð(
cmd
->lb¨+ ((cmd->
d©a_Ën
 >> 
dev
->
block_shiá
) - 2))) {

9012 ià(
cmd
->
cdb
[1] & 0x80) {

9013 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
,

9016 ()
lba
,

9017 
cmd
->
cmd_cÜru±_dif_g
, cmd);

9018 
t
->
»f_g
 = 
	`ýu_to_be32
(0xebfeedad);

9019 
	`sc¡_check_çž_»f_g
(
cmd
);

9021 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
,

9024 ()
lba
,

9025 
cmd
->
cmd_cÜru±_dif_g
, cmd);

9026 
t
->
gu¬d_g
 = 
	`ýu_to_be16
(0xebed);

9027 
	`sc¡_check_çž_gu¬d_g
(
cmd
);

9032 ià(
lba
 =ð(
cmd
->lb¨+ ((cmd->
d©a_Ën
 >> 
dev
->
block_shiá
) - 1))) {

9033 ià(
cmd
->
cdb
[1] & 0x80) {

9034 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
,

9037 ()
lba
,

9038 
cmd
->
cmd_cÜru±_dif_g
, cmd);

9039 
t
->
»f_g
 = 
	`ýu_to_be32
(0xebfeedad);

9040 
	`sc¡_check_çž_»f_g
(
cmd
);

9042 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
,

9045 ()
lba
,

9046 
cmd
->
cmd_cÜru±_dif_g
, cmd);

9047 
t
->
gu¬d_g
 = 
	`ýu_to_be16
(0xebed);

9048 
	`sc¡_check_çž_gu¬d_g
(
cmd
);

9054 
cur_buf
 +ð
dev
->
block_size
;

9055 
lba
++;

9057 
t
++;

9058 
gs_Ën
 -ð
g_size
;

9059 ià(
gs_Ën
 == 0) {

9060 
	`sc¡_put_dif_buf
(
cmd
, 
gs_buf
);

9061 
gs_buf
 = 
NULL
;

9065 
	`sc¡_put_buf
(
cmd
, 
buf
);

9066 
Ën
 = 
	`sc¡_g‘_buf_Ãxt
(
cmd
, &
buf
);

9069 
	`EXTRACHECKS_BUG_ON
(
gs_buf
 !ð
NULL
);

9071 
	`TRACE_EXIT_RES
(
»s
);

9072  
»s
;

9073 
	}
}

9075 
sc¡_do_dif
(
sc¡_cmd
 *
cmd
,

9076 (*
g’”©e_â
)(
sc¡_cmd
 *
cmd
),

9077 (*
v”ify_â
)(
sc¡_cmd
 *
cmd
))

9079 
»s
;

9080 
sc¡_dif_aùiÚs
 
aùiÚ
 = 
	`sc¡_g‘_dif_aùiÚ
(

9081 
	`sc¡_g‘_sc¡_dif_aùiÚs
(
cmd
->
cmd_dif_aùiÚs
));

9083 
	`TRACE_ENTRY
();

9085 
	`TRACE_DBG
("cmd %p,‡ùiÚ %d", 
cmd
, 
aùiÚ
);

9087 
aùiÚ
) {

9088 
SCST_DIF_ACTION_PASS
:

9090 
	`TRACE_DBG
("PASS DIF‡ùiÚ, skpšg (cmd %p)", 
cmd
);

9091 
»s
 = 0;

9094 
SCST_DIF_ACTION_STRIP
:

9095 
SCST_DIF_ACTION_PASS_CHECK
:

9097 
sc¡_dif_aùiÚs
 
checks
 = 
	`sc¡_g‘_dif_checks
(
cmd
->
cmd_dif_aùiÚs
);

9099 ià(
	`lik–y
(
checks
 !ð
SCST_DIF_ACTION_NONE
))

9100 
»s
 = 
	`v”ify_â
(
cmd
);

9102 
»s
 = 0;

9106 
SCST_DIF_ACTION_INSERT
:

9107 
»s
 = 
	`g’”©e_â
(
cmd
);

9111 
	`EXTRACHECKS_BUG_ON
(1);

9113 
SCST_DIF_ACTION_NONE
:

9115 
	`TRACE_DBG
("NONE DIF‡ùiÚ, skpšg (cmd %p)", 
cmd
);

9116 
»s
 = 0;

9120 
	`TRACE_EXIT_RES
(
»s
);

9121  
»s
;

9122 
	}
}

9124 
	$sc¡_dif_ty³1
(
sc¡_cmd
 *
cmd
)

9126 
»s
;

9128 
	`TRACE_ENTRY
();

9130 
	`EXTRACHECKS_BUG_ON
(
cmd
->
dev
->
dev_dif_ty³
 != 1);

9132 
»s
 = 
	`sc¡_do_dif
(
cmd
, 
sc¡_g’”©e_dif_ty³1
, 
sc¡_v”ify_dif_ty³1
);

9134 
	`TRACE_EXIT_RES
(
»s
);

9135  
»s
;

9136 
	}
}

9138 
	$sc¡_v”ify_dif_ty³2
(
sc¡_cmd
 *
cmd
)

9140 
»s
 = 0;

9141 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

9142 
sc¡_dif_aùiÚs
 
checks
 = 
	`sc¡_g‘_dif_checks
(
cmd
->
cmd_dif_aùiÚs
);

9143 
Ën
, 
gs_Ën
 = 0, 
g_size
 = 1 << 
SCST_DIF_TAG_SHIFT
;

9144 
sÿ‰”li¡
 *
gs_sg
 = 
NULL
;

9145 
ušt8_t
 *
buf
, *
gs_buf
 = 
NULL
;

9146 cÚ¡ 
t10_pi_tu¶e
 *
t
 = 
NULL
;

9147 
ušt64_t
 
lba
 = 
cmd
->lba;

9148 
block_size
 = 
dev
->block_size, 
block_shiá
 = dev->block_shift;

9149 
	`__be16
 (*
üc_â
)(cÚ¡ *
bufãr
, 
Ën
);

9150 
ušt32_t
 
»f_g
 = 
	`sc¡_cmd_g‘_dif_exp_»f_g
(
cmd
);

9152 
__be16
 
­p_g_mask
 = 
	`ýu_to_be16
(
	`sc¡_cmd_g‘_dif_­p_g_mask
(
cmd
));

9153 
__be16
 
­p_g_masked
 = 
	`ýu_to_be16
(
	`sc¡_cmd_g‘_dif_exp_­p_g
(
cmd
)è& 
­p_g_mask
;

9155 
	`TRACE_ENTRY
();

9157 
	`EXTRACHECKS_BUG_ON
(
dev
->
dev_dif_ty³
 != 2);

9159 #ifdeà
CONFIG_SCST_EXTRACHECKS


9160 
	`sc¡_g‘_dif_aùiÚ
(
	`sc¡_g‘_sc¡_dif_aùiÚs
(
cmd
->
cmd_dif_aùiÚs
))) {

9161 
SCST_DIF_ACTION_STRIP
:

9162 
SCST_DIF_ACTION_PASS_CHECK
:

9165 
	`EXTRACHECKS_BUG_ON
(1);

9168 
	`EXTRACHECKS_BUG_ON
(
checks
 =ð
SCST_DIF_ACTION_NONE
);

9171 
üc_â
 = 
cmd
->
tgt_dev
->
tgt_dev_dif_üc_â
;

9173 
Ën
 = 
	`sc¡_g‘_buf_fœ¡
(
cmd
, &
buf
);

9174 
Ën
 > 0) {

9175 
i
;

9176 
ušt8_t
 *
cur_buf
 = 
buf
;

9178 
i
 = 0; i < (
Ën
 >> 
block_shiá
); i++) {

9179 ià(
gs_buf
 =ð
NULL
) {

9180 
gs_buf
 = 
	`sc¡_g‘_dif_buf
(
cmd
, &
gs_sg
, &
gs_Ën
);

9181 
	`EXTRACHECKS_BUG_ON
(
gs_Ën
 <= 0);

9182 
t
 = (
t10_pi_tu¶e
 *)
gs_buf
;

9185 ià(
t
->
­p_g
 =ð
SCST_DIF_NO_CHECK_ALL_APP_TAG
) {

9186 
	`TRACE_DBG
("Skpšgag (cmd %p)", 
cmd
);

9187 
Ãxt
;

9190 ià(
checks
 & 
SCST_DIF_CHECK_APP_TAG
) {

9191 ià((
t
->
­p_g
 & 
­p_g_mask
è!ð
­p_g_masked
) {

9192 
	`PRINT_WARNING
("APP TAG check failed, "

9195 
­p_g_masked
, 
t
->
­p_g
 & 
­p_g_mask
,

9196 
cmd
, 
	`sc¡_g‘_Ýcode_Çme
(cmd), 
dev
->
vœt_Çme
);

9197 
	`sc¡_dif_acc_­p_check_çžed_sc¡
(
cmd
);

9198 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

9199 
	`SCST_LOAD_SENSE
(
sc¡_logiÿl_block_­p_g_check_çžed
));

9200 
»s
 = -
EIO
;

9201 
out_put
;

9205 ià(
checks
 & 
SCST_DIF_CHECK_REF_TAG
) {

9206 ià(
t
->
»f_g
 !ð
	`ýu_to_be32
(ref_tag)) {

9207 
	`PRINT_WARNING
("REF TAG check failed, "

9210 
	`ýu_to_be32
(
»f_g
),

9211 
t
->
»f_g
, 
cmd
, 
	`sc¡_g‘_Ýcode_Çme
(cmd),

9212 
dev
->
vœt_Çme
);

9213 
	`sc¡_dif_acc_»f_check_çžed_sc¡
(
cmd
);

9214 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

9215 
	`SCST_LOAD_SENSE
(
sc¡_logiÿl_block_»f_g_check_çžed
));

9216 
»s
 = -
EIO
;

9217 
out_put
;

9222 ià((
checks
 & 
SCST_DIF_CHECK_GUARD_TAG
) &&

9223 !
cmd
->
š‹º®
) {

9224 
__be16
 
üc
 = 
	`üc_â
(
cur_buf
, 
block_size
);

9226 ià(
t
->
gu¬d_g
 !ð
üc
) {

9227 
	`PRINT_WARNING
("GUARD TAG check failed, "

9230 "dev %s)", 
üc
, 
t
->
gu¬d_g
, 
cmd
,

9231 
	`sc¡_g‘_Ýcode_Çme
(
cmd
), ()
lba
,

9232 
dev
->
vœt_Çme
);

9233 
	`sc¡_dif_acc_gu¬d_check_çžed_sc¡
(
cmd
);

9234 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

9235 
	`SCST_LOAD_SENSE
(
sc¡_logiÿl_block_gu¬d_check_çžed
));

9236 
»s
 = -
EIO
;

9237 
out_put
;

9241 
Ãxt
:

9242 
cur_buf
 +ð
dev
->
block_size
;

9243 
lba
++;

9244 
»f_g
++;

9246 
t
++;

9247 
gs_Ën
 -ð
g_size
;

9248 ià(
gs_Ën
 == 0) {

9249 
	`sc¡_put_dif_buf
(
cmd
, 
gs_buf
);

9250 
gs_buf
 = 
NULL
;

9254 
	`sc¡_put_buf
(
cmd
, 
buf
);

9255 
Ën
 = 
	`sc¡_g‘_buf_Ãxt
(
cmd
, &
buf
);

9258 
	`EXTRACHECKS_BUG_ON
(
gs_buf
 !ð
NULL
);

9260 
out
:

9261 
	`TRACE_EXIT_RES
(
»s
);

9262  
»s
;

9264 
out_put
:

9265 
	`sc¡_put_buf
(
cmd
, 
buf
);

9266 
	`sc¡_put_dif_buf
(
cmd
, 
gs_buf
);

9267 
out
;

9268 
	}
}

9270 
	$sc¡_g’”©e_dif_ty³2
(
sc¡_cmd
 *
cmd
)

9272 
»s
 = 0;

9273 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

9274 
Ën
, 
gs_Ën
 = 0, 
g_size
 = 1 << 
SCST_DIF_TAG_SHIFT
;

9275 
sÿ‰”li¡
 *
gs_sg
 = 
NULL
;

9276 
ušt8_t
 *
buf
, *
gs_buf
 = 
NULL
;

9277 
t10_pi_tu¶e
 *
t
 = 
NULL
;

9278 
block_size
 = 
dev
->block_size, 
block_shiá
 = dev->block_shift;

9279 
	`__be16
 (*
üc_â
)(cÚ¡ *
bufãr
, 
Ën
);

9280 
ušt32_t
 
»f_g
 = 
	`sc¡_cmd_g‘_dif_exp_»f_g
(
cmd
);

9282 
__be16
 
­p_g_mask
 = 
	`ýu_to_be16
(
	`sc¡_cmd_g‘_dif_­p_g_mask
(
cmd
));

9283 
__be16
 
­p_g_masked
 = 
	`ýu_to_be16
(
	`sc¡_cmd_g‘_dif_exp_­p_g
(
cmd
)è& 
­p_g_mask
;

9285 
	`TRACE_ENTRY
();

9287 
	`EXTRACHECKS_BUG_ON
(
dev
->
dev_dif_ty³
 != 2);

9289 #ifdeà
CONFIG_SCST_EXTRACHECKS


9290 
	`sc¡_g‘_dif_aùiÚ
(
	`sc¡_g‘_sc¡_dif_aùiÚs
(
cmd
->
cmd_dif_aùiÚs
))) {

9291 
SCST_DIF_ACTION_INSERT
:

9294 
	`EXTRACHECKS_BUG_ON
(1);

9299 
üc_â
 = 
cmd
->
tgt_dev
->
tgt_dev_dif_üc_â
;

9301 
Ën
 = 
	`sc¡_g‘_buf_fœ¡
(
cmd
, &
buf
);

9302 
Ën
 > 0) {

9303 
i
;

9304 
ušt8_t
 *
cur_buf
 = 
buf
;

9306 
	`TRACE_DBG
("ËÀ%d", 
Ën
);

9308 
i
 = 0; i < (
Ën
 >> 
block_shiá
); i++) {

9309 
	`TRACE_DBG
("gs_ËÀ%d", 
gs_Ën
);

9311 ià(
gs_buf
 =ð
NULL
) {

9312 
gs_buf
 = 
	`sc¡_g‘_dif_buf
(
cmd
, &
gs_sg
, &
gs_Ën
);

9313 
	`TRACE_DBG
("tags_sg %p,ags_buf %p,ags_len %d",

9314 
gs_sg
, 
gs_buf
, 
gs_Ën
);

9315 
	`EXTRACHECKS_BUG_ON
(
gs_Ën
 <= 0);

9316 
t
 = (
t10_pi_tu¶e
 *)
gs_buf
;

9319 
t
->
­p_g
 = 
­p_g_masked
;

9320 
t
->
»f_g
 = 
	`ýu_to_be32
(ref_tag);

9321 
t
->
gu¬d_g
 = 
	`üc_â
(
cur_buf
, 
block_size
);

9323 
cur_buf
 +ð
dev
->
block_size
;

9324 
»f_g
++;

9326 
t
++;

9327 
gs_Ën
 -ð
g_size
;

9328 ià(
gs_Ën
 == 0) {

9329 
	`sc¡_put_dif_buf
(
cmd
, 
gs_buf
);

9330 
gs_buf
 = 
NULL
;

9334 
	`sc¡_put_buf
(
cmd
, 
buf
);

9335 
Ën
 = 
	`sc¡_g‘_buf_Ãxt
(
cmd
, &
buf
);

9338 
	`EXTRACHECKS_BUG_ON
(
gs_buf
 !ð
NULL
);

9340 
	`TRACE_EXIT_RES
(
»s
);

9341  
»s
;

9342 
	}
}

9344 
	$sc¡_dif_ty³2
(
sc¡_cmd
 *
cmd
)

9346 
»s
;

9348 
	`TRACE_ENTRY
();

9350 
	`EXTRACHECKS_BUG_ON
(
cmd
->
dev
->
dev_dif_ty³
 != 2);

9352 
»s
 = 
	`sc¡_do_dif
(
cmd
, 
sc¡_g’”©e_dif_ty³2
, 
sc¡_v”ify_dif_ty³2
);

9354 
	`TRACE_EXIT_RES
(
»s
);

9355  
»s
;

9356 
	}
}

9358 
	$sc¡_v”ify_dif_ty³3
(
sc¡_cmd
 *
cmd
)

9360 
»s
 = 0;

9361 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

9362 
sc¡_dif_aùiÚs
 
checks
 = 
	`sc¡_g‘_dif_checks
(
cmd
->
cmd_dif_aùiÚs
);

9363 
Ën
, 
gs_Ën
 = 0, 
g_size
 = 1 << 
SCST_DIF_TAG_SHIFT
;

9364 
sÿ‰”li¡
 *
gs_sg
 = 
NULL
;

9365 
ušt8_t
 *
buf
, *
gs_buf
 = 
NULL
;

9366 cÚ¡ 
t10_pi_tu¶e
 *
t
 = 
NULL
;

9367 
ušt64_t
 
lba
 = 
cmd
->lba;

9368 
block_size
 = 
dev
->block_size, 
block_shiá
 = dev->block_shift;

9369 
	`__be16
 (*
üc_â
)(cÚ¡ *
bufãr
, 
Ën
);

9371 
	`TRACE_ENTRY
();

9373 
	`EXTRACHECKS_BUG_ON
(
dev
->
dev_dif_ty³
 != 3);

9375 #ifdeà
CONFIG_SCST_EXTRACHECKS


9376 
	`sc¡_g‘_dif_aùiÚ
(
	`sc¡_g‘_sc¡_dif_aùiÚs
(
cmd
->
cmd_dif_aùiÚs
))) {

9377 
SCST_DIF_ACTION_STRIP
:

9378 
SCST_DIF_ACTION_PASS_CHECK
:

9381 
	`EXTRACHECKS_BUG_ON
(1);

9384 
	`EXTRACHECKS_BUG_ON
(
checks
 =ð
SCST_DIF_ACTION_NONE
);

9387 
üc_â
 = 
cmd
->
tgt_dev
->
tgt_dev_dif_üc_â
;

9389 
Ën
 = 
	`sc¡_g‘_buf_fœ¡
(
cmd
, &
buf
);

9390 
Ën
 > 0) {

9391 
i
;

9392 
ušt8_t
 *
cur_buf
 = 
buf
;

9394 
i
 = 0; i < (
Ën
 >> 
block_shiá
); i++) {

9395 ià(
gs_buf
 =ð
NULL
) {

9396 
gs_buf
 = 
	`sc¡_g‘_dif_buf
(
cmd
, &
gs_sg
, &
gs_Ën
);

9397 
	`EXTRACHECKS_BUG_ON
(
gs_Ën
 <= 0);

9398 
t
 = (
t10_pi_tu¶e
 *)
gs_buf
;

9401 ià((
t
->
­p_g
 =ð
SCST_DIF_NO_CHECK_ALL_APP_TAG
) &&

9402 (
t
->
»f_g
 =ð
SCST_DIF_NO_CHECK_ALL_REF_TAG
)) {

9403 
	`TRACE_DBG
("Skpšgag (cmd %p)", 
cmd
);

9404 
Ãxt
;

9407 ià(
checks
 & 
SCST_DIF_CHECK_APP_TAG
) {

9408 ià(
t
->
­p_g
 !ð
dev
->
dev_dif_¡©ic_­p_g
) {

9409 
	`PRINT_WARNING
("APP TAG check failed, "

9412 
dev
->
dev_dif_¡©ic_­p_g
,

9413 
t
->
­p_g
, 
cmd
, 
	`sc¡_g‘_Ýcode_Çme
(cmd),

9414 
dev
->
vœt_Çme
);

9415 
	`sc¡_dif_acc_­p_check_çžed_sc¡
(
cmd
);

9416 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

9417 
	`SCST_LOAD_SENSE
(
sc¡_logiÿl_block_­p_g_check_çžed
));

9418 
»s
 = -
EIO
;

9419 
out_put
;

9423 ià(
checks
 & 
SCST_DIF_CHECK_REF_TAG
) {

9424 ià(
t
->
»f_g
 !ð
dev
->
dev_dif_¡©ic_­p_»f_g
) {

9425 
	`PRINT_WARNING
("REF TAG check failed, "

9428 
dev
->
dev_dif_¡©ic_­p_»f_g
,

9429 
t
->
»f_g
, 
cmd
, 
	`sc¡_g‘_Ýcode_Çme
(cmd),

9430 
dev
->
vœt_Çme
);

9431 
	`sc¡_dif_acc_»f_check_çžed_sc¡
(
cmd
);

9432 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

9433 
	`SCST_LOAD_SENSE
(
sc¡_logiÿl_block_»f_g_check_çžed
));

9434 
»s
 = -
EIO
;

9435 
out_put
;

9440 ià((
checks
 & 
SCST_DIF_CHECK_GUARD_TAG
) &&

9441 !
cmd
->
š‹º®
) {

9442 
__be16
 
üc
 = 
	`üc_â
(
cur_buf
, 
block_size
);

9444 ià(
t
->
gu¬d_g
 !ð
üc
) {

9445 
	`PRINT_WARNING
("GUARD TAG check failed, "

9448 "dev %s)", 
üc
, 
t
->
gu¬d_g
, 
cmd
,

9449 
	`sc¡_g‘_Ýcode_Çme
(
cmd
), ()
lba
,

9450 
dev
->
vœt_Çme
);

9451 
	`sc¡_dif_acc_gu¬d_check_çžed_sc¡
(
cmd
);

9452 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

9453 
	`SCST_LOAD_SENSE
(
sc¡_logiÿl_block_gu¬d_check_çžed
));

9454 
»s
 = -
EIO
;

9455 
out_put
;

9459 
Ãxt
:

9460 
cur_buf
 +ð
dev
->
block_size
;

9461 
lba
++;

9463 
t
++;

9464 
gs_Ën
 -ð
g_size
;

9465 ià(
gs_Ën
 == 0) {

9466 
	`sc¡_put_dif_buf
(
cmd
, 
gs_buf
);

9467 
gs_buf
 = 
NULL
;

9471 
	`sc¡_put_buf
(
cmd
, 
buf
);

9472 
Ën
 = 
	`sc¡_g‘_buf_Ãxt
(
cmd
, &
buf
);

9475 
	`EXTRACHECKS_BUG_ON
(
gs_buf
 !ð
NULL
);

9477 
out
:

9478 
	`TRACE_EXIT_RES
(
»s
);

9479  
»s
;

9481 
out_put
:

9482 
	`sc¡_put_buf
(
cmd
, 
buf
);

9483 
	`sc¡_put_dif_buf
(
cmd
, 
gs_buf
);

9484 
out
;

9485 
	}
}

9487 
	$sc¡_g’”©e_dif_ty³3
(
sc¡_cmd
 *
cmd
)

9489 
»s
 = 0;

9490 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

9491 
Ën
, 
gs_Ën
 = 0, 
g_size
 = 1 << 
SCST_DIF_TAG_SHIFT
;

9492 
sÿ‰”li¡
 *
gs_sg
 = 
NULL
;

9493 
ušt8_t
 *
buf
, *
gs_buf
 = 
NULL
;

9494 
t10_pi_tu¶e
 *
t
 = 
NULL
;

9495 
block_size
 = 
dev
->block_size, 
block_shiá
 = dev->block_shift;

9496 
	`__be16
 (*
üc_â
)(cÚ¡ *
bufãr
, 
Ën
);

9498 
	`TRACE_ENTRY
();

9500 
	`EXTRACHECKS_BUG_ON
(
dev
->
dev_dif_ty³
 != 3);

9502 #ifdeà
CONFIG_SCST_EXTRACHECKS


9503 
	`sc¡_g‘_dif_aùiÚ
(
	`sc¡_g‘_sc¡_dif_aùiÚs
(
cmd
->
cmd_dif_aùiÚs
))) {

9504 
SCST_DIF_ACTION_INSERT
:

9507 
	`EXTRACHECKS_BUG_ON
(1);

9512 
üc_â
 = 
cmd
->
tgt_dev
->
tgt_dev_dif_üc_â
;

9514 
Ën
 = 
	`sc¡_g‘_buf_fœ¡
(
cmd
, &
buf
);

9515 
Ën
 > 0) {

9516 
i
;

9517 
ušt8_t
 *
cur_buf
 = 
buf
;

9519 
	`TRACE_DBG
("ËÀ%d", 
Ën
);

9521 
i
 = 0; i < (
Ën
 >> 
block_shiá
); i++) {

9522 
	`TRACE_DBG
("gs_ËÀ%d", 
gs_Ën
);

9524 ià(
gs_buf
 =ð
NULL
) {

9525 
gs_buf
 = 
	`sc¡_g‘_dif_buf
(
cmd
, &
gs_sg
, &
gs_Ën
);

9526 
	`TRACE_DBG
("tags_sg %p,ags_buf %p,ags_len %d",

9527 
gs_sg
, 
gs_buf
, 
gs_Ën
);

9528 
	`EXTRACHECKS_BUG_ON
(
gs_Ën
 <= 0);

9529 
t
 = (
t10_pi_tu¶e
 *)
gs_buf
;

9532 
t
->
­p_g
 = 
dev
->
dev_dif_¡©ic_­p_g
;

9533 
t
->
»f_g
 = 
dev
->
dev_dif_¡©ic_­p_»f_g
;

9534 
t
->
gu¬d_g
 = 
	`üc_â
(
cur_buf
, 
block_size
);

9536 
cur_buf
 +ð
dev
->
block_size
;

9538 
t
++;

9539 
gs_Ën
 -ð
g_size
;

9540 ià(
gs_Ën
 == 0) {

9541 
	`sc¡_put_dif_buf
(
cmd
, 
gs_buf
);

9542 
gs_buf
 = 
NULL
;

9546 
	`sc¡_put_buf
(
cmd
, 
buf
);

9547 
Ën
 = 
	`sc¡_g‘_buf_Ãxt
(
cmd
, &
buf
);

9550 
	`EXTRACHECKS_BUG_ON
(
gs_buf
 !ð
NULL
);

9552 
	`TRACE_EXIT_RES
(
»s
);

9553  
»s
;

9554 
	}
}

9556 
	$sc¡_dif_ty³3
(
sc¡_cmd
 *
cmd
)

9558 
»s
;

9560 
	`TRACE_ENTRY
();

9562 
	`EXTRACHECKS_BUG_ON
(
cmd
->
dev
->
dev_dif_ty³
 != 3);

9564 
»s
 = 
	`sc¡_do_dif
(
cmd
, 
sc¡_g’”©e_dif_ty³3
, 
sc¡_v”ify_dif_ty³3
);

9566 
	`TRACE_EXIT_RES
(
»s
);

9567  
»s
;

9568 
	}
}

9570 
	$sc¡_š™_dif_checks
(
sc¡_deviû
 *
dev
)

9572 
dev
->
dev_dif_ty³
) {

9574 
dev
->
dif_­p_chk
 = 0;

9575 
dev
->
dif_»f_chk
 = 0;

9578 ià(
	`sc¡_dev_g‘_dif_¡©ic_­p_g
(
dev
è!ð
SCST_DIF_NO_CHECK_APP_TAG
)

9579 
dev
->
dif_­p_chk
 = 
SCST_DIF_CHECK_APP_TAG
;

9581 
dev
->
dif_­p_chk
 = 0;

9582 
dev
->
dif_»f_chk
 = 
SCST_DIF_CHECK_REF_TAG
;

9585 
dev
->
dif_­p_chk
 = dev->
©o
 ? 
SCST_DIF_CHECK_APP_TAG
 : 0;

9586 
dev
->
dif_»f_chk
 = 
SCST_DIF_CHECK_REF_TAG
;

9589 ià(
	`sc¡_dev_g‘_dif_¡©ic_­p_g_combšed
(
dev
è!ð
SCST_DIF_NO_CHECK_APP_TAG
) {

9590 
dev
->
dif_­p_chk
 = 
SCST_DIF_CHECK_APP_TAG
;

9591 
dev
->
dif_»f_chk
 = 
SCST_DIF_CHECK_REF_TAG
;

9593 
dev
->
dif_­p_chk
 = 0;

9594 
dev
->
dif_»f_chk
 = 0;

9598 
	`WARN_ON
(1);

9602 
	}
}

9610 
	$sc¡_dev_£t_dif_¡©ic_­p_g_combšed
(

9611 
sc¡_deviû
 *
dev
, 
__be64
 
­p_g
)

9613 
ušt64_t
 
a
 = 
	`be64_to_ýu
(
­p_g
);

9615 
dev
->
dev_dif_¡©ic_­p_g
 = 
	`ýu_to_be16
(
a
 & 0xFFFF);

9616 ià(
dev
->
dev_dif_ty³
 == 3)

9617 
dev
->
dev_dif_¡©ic_­p_»f_g
 = 
	`ýu_to_be32
((
a
 >> 16) & 0xFFFFFFFF);

9618 
	`sc¡_š™_dif_checks
(
dev
);

9620 
	}
}

9621 
EXPORT_SYMBOL_GPL
(
sc¡_dev_£t_dif_¡©ic_­p_g_combšed
);

9623 
	$sc¡_š™_dif_aùiÚs
(
sc¡_deviû
 *
dev
)

9625 
»s
 = 0;

9627 
	`TRACE_ENTRY
();

9629 
	`BUILD_BUG_ON
(
SCST_DIF_ACTION_NONE
 != 0);

9631 ià((
dev
->
dev_dif_ty³
 =ð0è|| (dev->
dev_dif_mode
 == 0)) {

9632 
dev
->
dev_dif_rd_aùiÚs
 = 
SCST_DIF_ACTION_NONE
;

9633 
dev
->
dev_dif_wr_aùiÚs
 = 
SCST_DIF_ACTION_NONE
;

9634 
dev
->
dev_dif_rd_´Ù0_aùiÚs
 = 
SCST_DIF_ACTION_NONE
;

9635 
dev
->
dev_dif_wr_´Ù0_aùiÚs
 = 
SCST_DIF_ACTION_NONE
;

9636 
out
;

9639 ià((
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV_CHECK
) &&

9640 !(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV_STORE
)) {

9641 
	`PRINT_ERROR
("DEV CHECK is‚ot‡llowed without DEV STORE! "

9642 "(dev %s)", 
dev
->
vœt_Çme
);

9643 
»s
 = -
EINVAL
;

9644 
out
;

9659 
	`BUILD_BUG_ON
(
SCST_DIF_MODE_DEV
 !ð(
SCST_DIF_MODE_DEV_CHECK
 | 
SCST_DIF_MODE_DEV_STORE
));

9661 ià(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_TGT
) {

9662 ià(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_SCST
) {

9663 ià(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV
) {

9664 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_rd_aùiÚs
, 
SCST_DIF_ACTION_PASS_CHECK
);

9665 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_rd_aùiÚs
, 
SCST_DIF_ACTION_PASS_CHECK
);

9666 ià(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV_CHECK
) {

9668 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_rd_aùiÚs
, 
SCST_DIF_ACTION_PASS_CHECK
);

9670 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_rd_aùiÚs
, 
SCST_DIF_ACTION_PASS
);

9672 ià(
dev
->
dpicz
) {

9673 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9674 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9675 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9677 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_STRIP
);

9678 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_PASS_CHECK
);

9679 ià(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV_CHECK
) {

9681 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_PASS_CHECK
);

9683 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_PASS
);

9686 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_wr_aùiÚs
, 
SCST_DIF_ACTION_PASS_CHECK
);

9687 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_wr_aùiÚs
, 
SCST_DIF_ACTION_PASS_CHECK
);

9688 ià(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV_CHECK
) {

9690 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_wr_aùiÚs
, 
SCST_DIF_ACTION_PASS_CHECK
);

9692 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_wr_aùiÚs
, 
SCST_DIF_ACTION_PASS
);

9694 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_wr_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_INSERT
);

9695 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_wr_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_PASS_CHECK
);

9696 ià(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV_CHECK
) {

9698 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_wr_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_PASS_CHECK
);

9700 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_wr_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_PASS
);

9702 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_rd_aùiÚs
, 
SCST_DIF_ACTION_PASS_CHECK
);

9703 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_rd_aùiÚs
, 
SCST_DIF_ACTION_INSERT
);

9704 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_rd_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9706 ià(
dev
->
dpicz
) {

9707 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9708 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9710 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_STRIP
);

9711 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_INSERT
);

9713 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9715 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_wr_aùiÚs
, 
SCST_DIF_ACTION_PASS_CHECK
);

9716 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_wr_aùiÚs
, 
SCST_DIF_ACTION_STRIP
);

9717 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_wr_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9719 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_wr_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_INSERT
);

9720 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_wr_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_STRIP
);

9721 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_wr_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9724 ià(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV
) {

9725 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_rd_aùiÚs
, 
SCST_DIF_ACTION_PASS_CHECK
);

9726 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_rd_aùiÚs
, 
SCST_DIF_ACTION_PASS
);

9727 ià(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV_CHECK
) {

9729 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_rd_aùiÚs
, 
SCST_DIF_ACTION_PASS_CHECK
);

9731 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_rd_aùiÚs
, 
SCST_DIF_ACTION_PASS
);

9734 ià(
dev
->
dpicz
) {

9735 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9736 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9737 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9739 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_STRIP
);

9740 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_PASS
);

9741 ià(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV_CHECK
) {

9743 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_PASS_CHECK
);

9745 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_PASS
);

9748 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_wr_aùiÚs
, 
SCST_DIF_ACTION_PASS_CHECK
);

9749 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_wr_aùiÚs
, 
SCST_DIF_ACTION_PASS
);

9750 ià(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV_CHECK
) {

9752 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_wr_aùiÚs
, 
SCST_DIF_ACTION_PASS_CHECK
);

9754 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_wr_aùiÚs
, 
SCST_DIF_ACTION_PASS
);

9756 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_wr_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_INSERT
);

9757 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_wr_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_PASS
);

9758 ià(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV_CHECK
) {

9760 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_wr_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_PASS_CHECK
);

9762 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_wr_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_PASS
);

9764 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_rd_aùiÚs
, 
SCST_DIF_ACTION_INSERT
);

9765 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_rd_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9766 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_rd_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9768 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9769 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9770 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9781 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_wr_aùiÚs
, 
SCST_DIF_ACTION_PASS_CHECK
);

9782 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_wr_aùiÚs
, 
SCST_DIF_ACTION_PASS
);

9784 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_wr_aùiÚs
, 
SCST_DIF_ACTION_STRIP
);

9785 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_wr_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9787 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_wr_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9789 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_wr_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9790 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_wr_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9791 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_wr_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9795 ià(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_SCST
) {

9796 ià(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV
) {

9797 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_rd_aùiÚs
, 
SCST_DIF_ACTION_PASS
);

9798 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_rd_aùiÚs
, 
SCST_DIF_ACTION_PASS_CHECK
);

9799 ià(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV_CHECK
) {

9801 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_rd_aùiÚs
, 
SCST_DIF_ACTION_PASS_CHECK
);

9803 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_rd_aùiÚs
, 
SCST_DIF_ACTION_PASS
);

9805 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9806 ià(
dev
->
dpicz
) {

9807 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9808 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9810 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_STRIP
);

9811 ià(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV_CHECK
) {

9813 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_PASS_CHECK
);

9815 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_PASS
);

9818 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_wr_aùiÚs
, 
SCST_DIF_ACTION_PASS
);

9819 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_wr_aùiÚs
, 
SCST_DIF_ACTION_PASS_CHECK
);

9820 ià(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV_CHECK
) {

9822 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_wr_aùiÚs
, 
SCST_DIF_ACTION_PASS_CHECK
);

9824 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_wr_aùiÚs
, 
SCST_DIF_ACTION_PASS
);

9826 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_wr_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9827 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_wr_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_INSERT
);

9828 ià(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV_CHECK
) {

9830 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_wr_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_PASS_CHECK
);

9832 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_wr_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_PASS
);

9834 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_rd_aùiÚs
, 
SCST_DIF_ACTION_PASS
);

9835 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_rd_aùiÚs
, 
SCST_DIF_ACTION_INSERT
);

9836 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_rd_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9838 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9839 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9840 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9842 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_wr_aùiÚs
, 
SCST_DIF_ACTION_PASS
);

9843 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_wr_aùiÚs
, 
SCST_DIF_ACTION_STRIP
);

9844 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_wr_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9846 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_wr_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9847 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_wr_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9848 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_wr_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9851 ià(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV
) {

9852 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_rd_aùiÚs
, 
SCST_DIF_ACTION_PASS
);

9853 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_rd_aùiÚs
, 
SCST_DIF_ACTION_PASS
);

9854 ià(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV_CHECK
) {

9856 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_rd_aùiÚs
, 
SCST_DIF_ACTION_PASS_CHECK
);

9858 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_rd_aùiÚs
, 
SCST_DIF_ACTION_PASS
);

9860 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9861 ià(
dev
->
dpicz
) {

9862 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9863 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9865 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_PASS
);

9866 ià(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV_CHECK
) {

9868 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_PASS_CHECK
);

9870 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_rd_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_PASS
);

9873 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_wr_aùiÚs
, 
SCST_DIF_ACTION_PASS
);

9874 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_wr_aùiÚs
, 
SCST_DIF_ACTION_PASS
);

9875 ià(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV_CHECK
) {

9877 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_wr_aùiÚs
, 
SCST_DIF_ACTION_PASS_CHECK
);

9879 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_wr_aùiÚs
, 
SCST_DIF_ACTION_PASS
);

9881 
	`sc¡_£t_tgt_dif_aùiÚ
(&
dev
->
dev_dif_wr_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_NONE
);

9882 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
dev
->
dev_dif_wr_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_INSERT
);

9883 ià(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV_CHECK
) {

9885 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_wr_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_PASS_CHECK
);

9887 
	`sc¡_£t_dev_dif_aùiÚ
(&
dev
->
dev_dif_wr_´Ù0_aùiÚs
, 
SCST_DIF_ACTION_PASS
);

9889 
	`sBUG_ON
(1);

9894 
	`TRACE_DBG
("rd_actions %x,„d_prot0_actions %x, wr_actions %x, "

9895 "wr_´Ù0_aùiÚ %x", 
dev
->
dev_dif_rd_aùiÚs
,

9896 
dev
->
dev_dif_rd_´Ù0_aùiÚs
, dev->
dev_dif_wr_aùiÚs
,

9897 
dev
->
dev_dif_wr_´Ù0_aùiÚs
);

9899 
out
:

9900 
	`TRACE_EXIT_RES
(
»s
);

9901  
»s
;

9902 
	}
}

9912 
	$sc¡_£t_dif_·¿ms
(
sc¡_deviû
 *
dev
, 
sc¡_dif_mode
 
dif_mode
,

9913 
dif_ty³
)

9915 
»s
 = -
EINVAL
;

9917 
	`TRACE_ENTRY
();

9919 
	`BUILD_BUG_ON
(
SCST_DIF_ACTION_NONE
 != 0);

9921 ià(((
dif_mode
 & ~(
SCST_DIF_MODE_TGT
|
SCST_DIF_MODE_SCST
|
SCST_DIF_MODE_DEV
)) != 0)) {

9922 
	`PRINT_ERROR
("Inv®id DIF mod%x", 
dif_mode
);

9923 
out
;

9926 ià((
dif_ty³
 < 0) || (dif_type > 3)) {

9927 
	`PRINT_ERROR
("DIFy³ %d‚Ù suµÜ‹d", 
dif_ty³
);

9928 
out
;

9931 ià((
dif_mode
 =ð0è&& (
dif_ty³
 != 0)) {

9932 
	`PRINT_ERROR
("With DIF mode 0 DIFype must be 0 (dev %s)",

9933 
dev
->
vœt_Çme
);

9934 
out
;

9937 
dev
->
dev_dif_mode
 = 
dif_mode
;

9938 
dev
->
dev_dif_ty³
 = 
dif_ty³
;

9940 ià(
dif_ty³
 == 0) {

9941 
	`TRACE_DBG
("DIFype 0, ignoring DIF mode");

9942 
out_nÚe
;

9945 ià(
dif_mode
 == 0) {

9946 
	`TRACE_DBG
("DIF mode 0");

9947 
out_nÚe
;

9950 
	`sc¡_š™_dif_checks
(
dev
);

9952 ià(
dif_mode
 & 
SCST_DIF_MODE_SCST
) {

9953 
dif_ty³
) {

9955 
dev
->
dev_dif_â
 = 
sc¡_dif_ty³1
;

9958 
dev
->
dev_dif_â
 = 
sc¡_dif_ty³2
;

9961 
dev
->
dev_dif_â
 = 
sc¡_dif_ty³3
;

9964 
	`sBUG_ON
(1);

9968 ià((
dif_ty³
 =ð1è&& !(
dif_mode
 & 
SCST_DIF_MODE_TGT
))

9969 
dev
->
dev_dif_â
 = 
sc¡_dif_ty³1
;

9970 ià((
dif_ty³
 =ð1è&& (
dif_mode
 & 
SCST_DIF_MODE_TGT
))

9971 
dev
->
dev_dif_â
 = 
sc¡_dif_nÚe_ty³1
;

9973 
dev
->
dev_dif_â
 = 
sc¡_dif_nÚe
;

9976 
»s
 = 
	`sc¡_š™_dif_aùiÚs
(
dev
);

9977 ià(
»s
 != 0)

9978 
out
;

9980 
»s
 = 
	`sc¡_dev_sysfs_dif_ü—‹
(
dev
);

9981 ià(
»s
 != 0)

9982 
out
;

9984 
	`PRINT_INFO
("deviû %s: DIF mod%x, DIFy³ %d", 
dev
->
vœt_Çme
,

9985 
dev
->
dev_dif_mode
, dev->
dev_dif_ty³
);

9986 
	`TRACE_DBG
("­p_chk %x,„ef_chk %x", 
dev
->
dif_­p_chk
, dev->
dif_»f_chk
);

9988 
out
:

9989 
	`TRACE_EXIT_RES
(
»s
);

9990  
»s
;

9992 
out_nÚe
:

9993 
dev
->
dif_­p_chk
 = 0;

9994 ià(
dev
->
dev_dif_ty³
 == 3)

9995 
dev
->
dif_»f_chk
 = 0;

9996 
dev
->
dev_dif_¡©ic_­p_g
 = 
SCST_DIF_NO_CHECK_APP_TAG
;

9997 
dev
->
dev_dif_¡©ic_­p_»f_g
 = 
SCST_DIF_NO_CHECK_APP_TAG
;

9998 
dev
->
dev_dif_â
 = 
sc¡_dif_nÚe
;

9999 
»s
 = 
	`sc¡_š™_dif_aùiÚs
(
dev
);

10000 
out
;

10001 
	}
}

10002 
EXPORT_SYMBOL_GPL
(
sc¡_£t_dif_·¿ms
);

10004 
	$sc¡_dif_nÚe
(
sc¡_cmd
 *
cmd
)

10006 
»s
 = 0;

10008 
	`TRACE_ENTRY
();

10012 
	`TRACE_EXIT_RES
(
»s
);

10013  
»s
;

10014 
	}
}

10016 #ifdeà
CONFIG_SCST_DIF_INJECT_CORRUPTED_TAGS


10017 
	$sc¡_dif_nÚe_ty³1
(
sc¡_cmd
 *
cmd
)

10019 
»s
 = 0;

10021 
	`TRACE_ENTRY
();

10023 ià(
	`uÆik–y
(
cmd
->
cmd_cÜru±_dif_g
 != 0)) {

10024 
	`EXTRACHECKS_BUG_ON
(
cmd
->
dev
->
dev_dif_ty³
 != 1);

10025 
»s
 = 
	`sc¡_dif_ty³1
(
cmd
);

10028 
	`TRACE_EXIT_RES
(
»s
);

10029  
»s
;

10030 
	}
}

10037 
	$__sc¡_·r£_rd´Ùeù
(
sc¡_cmd
 *
cmd
, 
rd´Ùeù
,

10038 
rd´Ùeù_offs
)

10040 
»s
 = 0;

10041 cÚ¡ 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

10043 
	`TRACE_ENTRY
();

10045 
	`TRACE_DBG
("rd´Ùeù %x", 
rd´Ùeù
);

10047 
	`EXTRACHECKS_BUG_ON
(
dev
->
dev_dif_ty³
 == 0);

10049 
rd´Ùeù
) {

10051 
cmd
->
cmd_dif_aùiÚs
 = 
dev
->
dev_dif_rd_´Ù0_aùiÚs
 |

10052 
SCST_DIF_CHECK_GUARD_TAG
 | 
dev
->
dif_­p_chk
 |

10053 
dev
->
dif_»f_chk
;

10057 
cmd
->
cmd_dif_aùiÚs
 = 
dev
->
dev_dif_rd_aùiÚs
 |

10058 
SCST_DIF_CHECK_GUARD_TAG
 | 
dev
->
dif_­p_chk
 |

10059 
dev
->
dif_»f_chk
;

10060 
cmd
->
tgt_dif_d©a_ex³ùed
 = 1;

10063 
cmd
->
cmd_dif_aùiÚs
 = 
dev
->
dev_dif_rd_aùiÚs
 |

10064 
dev
->
dif_­p_chk
 | dev->
dif_»f_chk
;

10065 
cmd
->
tgt_dif_d©a_ex³ùed
 = 1;

10068 
cmd
->
cmd_dif_aùiÚs
 = 
dev
->
dev_dif_rd_aùiÚs
;

10069 
cmd
->
tgt_dif_d©a_ex³ùed
 = 1;

10072 
cmd
->
cmd_dif_aùiÚs
 = 
dev
->
dev_dif_rd_aùiÚs
 |

10073 
dev
->
dif_­p_chk
;

10074 
cmd
->
tgt_dif_d©a_ex³ùed
 = 1;

10077 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
, "Invalid RDPROTECT value %x "

10078 "(dev %s, cmd %p)", 
rd´Ùeù
, 
dev
->
vœt_Çme
, 
cmd
);

10079 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 
rd´Ùeù_offs
,

10080 5|
SCST_INVAL_FIELD_BIT_OFFS_VALID
);

10081 
»s
 = 
EINVAL
;

10082 
out
;

10085 
	`TRACE_DBG
("cmd_dif_actions %x,gt_dif_data_expected %d (cmd %p)",

10086 
cmd
->
cmd_dif_aùiÚs
, cmd->
tgt_dif_d©a_ex³ùed
, cmd);

10088 
out
:

10089 
	`TRACE_EXIT_RES
(
»s
);

10090  
»s
;

10091 
	}
}

10097 
	$sc¡_·r£_rd´Ùeù
(
sc¡_cmd
 *
cmd
)

10099 
»s
 = 0;

10100 
rd´Ùeù
 = (
cmd
->
cdb
[1] & 0xE0) >> 5;

10101 cÚ¡ 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

10103 
	`TRACE_ENTRY
();

10105 ià(
dev
->
dev_dif_mode
 =ð
SCST_DIF_MODE_NONE
) {

10106 ià(
	`lik–y
(
rd´Ùeù
 == 0))

10107 
out
;

10109 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
, "RDPROTECT %x‡nd‚o DIF "

10110 "deviû % (cmd %p)", 
rd´Ùeù
,

10111 
dev
->
vœt_Çme
, 
cmd
);

10112 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 1,

10113 5|
SCST_INVAL_FIELD_BIT_OFFS_VALID
);

10114 
»s
 = 
EINVAL
;

10115 
out
;

10118 ià(
	`uÆik–y
((
dev
->
dev_dif_ty³
 =ð2è&& (
rd´Ùeù
 != 0))) {

10119 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
, "Non-32-byte CDBs with‚on-zero "

10121 "(dev %s, cmd %p, o°%s)", 
rd´Ùeù
, 
dev
->
vœt_Çme
,

10122 
cmd
, 
	`sc¡_g‘_Ýcode_Çme
(cmd));

10123 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

10124 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

10125 
»s
 = 
EINVAL
;

10126 
out
;

10129 #ifdeà
CONFIG_SCST_DIF_INJECT_CORRUPTED_TAGS


10130 ià(
	`uÆik–y
(
cmd
->
cmd_cÜru±_dif_g
 != 0)) {

10131 ià((
cmd
->
dev
->
dev_dif_ty³
 == 1) &&

10132 ((
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV_STORE
) == 0)) {

10133 
	`TRACE_DBG
("cmd_corrupt_dif_tag %x,„dprotect %x, cmd %p",

10134 
cmd
->
cmd_cÜru±_dif_g
, 
rd´Ùeù
, cmd);

10136 
rd´Ùeù
 &= 3;

10139 
cmd
->
cmd_cÜru±_dif_g
 = 0;

10144 
»s
 = 
	`__sc¡_·r£_rd´Ùeù
(
cmd
, 
rd´Ùeù
, 1);

10146 #ifdeà
CONFIG_SCST_DIF_INJECT_CORRUPTED_TAGS


10147 ià(
	`uÆik–y
(
cmd
->
cmd_cÜru±_dif_g
 != 0)) {

10148 ià(
»s
 == 0) {

10149 
	`TRACE_DBG
("Corrupt DIFag, (re)set cmd_dif_actions "

10150 "(cmd %p)", 
cmd
);

10156 
	`sc¡_£t_sc¡_dif_aùiÚ
(&
cmd
->
cmd_dif_aùiÚs
,

10157 
SCST_DIF_ACTION_INSERT
);

10158 ià(
	`sc¡_g‘_dif_aùiÚ
(
	`sc¡_g‘_»ad_dif_tgt_aùiÚs
(
cmd
)è=ð
SCST_DIF_ACTION_INSERT
)

10159 
	`sc¡_£t_tgt_dif_aùiÚ
(&
cmd
->
cmd_dif_aùiÚs
,

10160 
SCST_DIF_ACTION_PASS_CHECK
);

10162 
	`TRACE_DBG
("·r£„d´Ùeù fažed: %d", 
»s
);

10166 
out
:

10167 
	`TRACE_EXIT_RES
(
»s
);

10168  
»s
;

10169 
	}
}

10175 
	$sc¡_·r£_rd´Ùeù32
(
sc¡_cmd
 *
cmd
)

10177 
»s
 = 0;

10178 
rd´Ùeù
 = (
cmd
->
cdb
[10] & 0xE0) >> 5;

10179 cÚ¡ 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

10181 
	`TRACE_ENTRY
();

10183 ià(
	`uÆik–y
(
dev
->
dev_dif_ty³
 != 2)) {

10184 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
, "32-byte CDBs‡re‚ot "

10186 
dev
->
dev_dif_ty³
, dev->
vœt_Çme
, 
cmd
,

10187 
	`sc¡_g‘_Ýcode_Çme
(
cmd
));

10188 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

10189 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

10190 
»s
 = 
EINVAL
;

10191 
out
;

10194 
»s
 = 
	`__sc¡_·r£_rd´Ùeù
(
cmd
, 
rd´Ùeù
, 10);

10196 
out
:

10197 
	`TRACE_EXIT_RES
(
»s
);

10198  
»s
;

10199 
	}
}

10205 
	$__sc¡_·r£_w½rÙeù
(
sc¡_cmd
 *
cmd
, 
w½rÙeù
,

10206 
w½rÙeù_offs
)

10208 
»s
 = 0;

10209 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

10211 
	`TRACE_ENTRY
();

10213 
	`TRACE_DBG
("w½rÙeù %x", 
w½rÙeù
);

10215 
	`EXTRACHECKS_BUG_ON
(
dev
->
dev_dif_ty³
 == 0);

10217 
w½rÙeù
) {

10219 
cmd
->
cmd_dif_aùiÚs
 = 
dev
->
dev_dif_wr_´Ù0_aùiÚs
 |

10220 
SCST_DIF_CHECK_GUARD_TAG
 | 
dev
->
dif_­p_chk
 |

10221 
dev
->
dif_»f_chk
;

10224 
cmd
->
cmd_dif_aùiÚs
 = 
dev
->
dev_dif_wr_aùiÚs
 |

10225 
SCST_DIF_CHECK_GUARD_TAG
 | 
dev
->
dif_­p_chk
 |

10226 
dev
->
dif_»f_chk
;

10227 
cmd
->
tgt_dif_d©a_ex³ùed
 = 1;

10230 
cmd
->
cmd_dif_aùiÚs
 = 
dev
->
dev_dif_wr_aùiÚs
 |

10231 
dev
->
dif_­p_chk
 | dev->
dif_»f_chk
;

10232 
cmd
->
tgt_dif_d©a_ex³ùed
 = 1;

10235 
cmd
->
cmd_dif_aùiÚs
 = 
dev
->
dev_dif_wr_aùiÚs
;

10236 
cmd
->
tgt_dif_d©a_ex³ùed
 = 1;

10239 
cmd
->
cmd_dif_aùiÚs
 = 
dev
->
dev_dif_wr_aùiÚs
 |

10240 
SCST_DIF_CHECK_GUARD_TAG
;

10241 
cmd
->
tgt_dif_d©a_ex³ùed
 = 1;

10244 
cmd
->
cmd_dif_aùiÚs
 = 
dev
->
dev_dif_wr_aùiÚs
 |

10245 
SCST_DIF_CHECK_GUARD_TAG
 | 
dev
->
dif_­p_chk
 |

10246 
dev
->
dif_»f_chk
;

10247 
cmd
->
tgt_dif_d©a_ex³ùed
 = 1;

10250 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
, "Invalid WRPROTECT value %x "

10251 "(dev %s, cmd %p)", 
w½rÙeù
, 
dev
->
vœt_Çme
, 
cmd
);

10252 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 
w½rÙeù_offs
,

10253 5|
SCST_INVAL_FIELD_BIT_OFFS_VALID
);

10254 
»s
 = 
EINVAL
;

10255 
out
;

10258 
	`TRACE_DBG
("cmd_dif_actions %x,gt_dif_data_expected %d (cmd %p)",

10259 
cmd
->
cmd_dif_aùiÚs
, cmd->
tgt_dif_d©a_ex³ùed
, cmd);

10261 
out
:

10262 
	`TRACE_EXIT_RES
(
»s
);

10263  
»s
;

10264 
	}
}

10270 
	$sc¡_·r£_w½rÙeù
(
sc¡_cmd
 *
cmd
)

10272 
»s
 = 0;

10273 
w½rÙeù
 = (
cmd
->
cdb
[1] & 0xE0) >> 5;

10274 cÚ¡ 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

10276 
	`TRACE_ENTRY
();

10278 ià(
dev
->
dev_dif_mode
 =ð
SCST_DIF_MODE_NONE
) {

10279 ià(
	`lik–y
(
w½rÙeù
 == 0))

10280 
out
;

10282 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
, "WRPROTECT %x‡nd‚o DIF "

10283 "deviû % (cmd %p)", 
w½rÙeù
,

10284 
dev
->
vœt_Çme
, 
cmd
);

10285 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 1,

10286 5|
SCST_INVAL_FIELD_BIT_OFFS_VALID
);

10287 
»s
 = 
EINVAL
;

10288 
out
;

10291 ià(
	`uÆik–y
((
dev
->
dev_dif_ty³
 =ð2è&& (
w½rÙeù
 != 0))) {

10292 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
, "Non-32-byte CDBs with‚on-zero "

10294 "(dev %s, cmd %p, o°%s)", 
w½rÙeù
, 
dev
->
vœt_Çme
,

10295 
cmd
, 
	`sc¡_g‘_Ýcode_Çme
(cmd));

10296 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

10297 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

10298 
»s
 = 
EINVAL
;

10299 
out
;

10302 
»s
 = 
	`__sc¡_·r£_w½rÙeù
(
cmd
, 
w½rÙeù
, 1);

10304 
out
:

10305 
	`TRACE_EXIT_RES
(
»s
);

10306  
»s
;

10307 
	}
}

10313 
	$sc¡_·r£_w½rÙeù32
(
sc¡_cmd
 *
cmd
)

10315 
»s
 = 0;

10316 
w½rÙeù
 = (
cmd
->
cdb
[10] & 0xE0) >> 5;

10317 cÚ¡ 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

10319 
	`TRACE_ENTRY
();

10321 ià(
	`uÆik–y
(
dev
->
dev_dif_ty³
 != 2)) {

10322 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
, "32-byte CDBs‡re‚ot "

10324 
dev
->
dev_dif_ty³
, dev->
vœt_Çme
, 
cmd
,

10325 
	`sc¡_g‘_Ýcode_Çme
(
cmd
));

10326 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

10327 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

10328 
»s
 = 
EINVAL
;

10329 
out
;

10332 
»s
 = 
	`__sc¡_·r£_w½rÙeù
(
cmd
, 
w½rÙeù
, 10);

10334 
out
:

10335 
	`TRACE_EXIT_RES
(
»s
);

10336  
»s
;

10337 
	}
}

10343 
	$__sc¡_·r£_v½rÙeù
(
sc¡_cmd
 *
cmd
, 
v½rÙeù_offs
)

10345 
»s
 = 0;

10346 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

10347 
v½rÙeù
 = (
cmd
->
cdb
[
v½rÙeù_offs
] & 0xE0) >> 5;

10348 
bytchk
 = (
cmd
->
cdb
[
v½rÙeù_offs
] & 6) >> 1;

10350 
	`TRACE_ENTRY
();

10352 
	`TRACE_DBG
("v½rÙeù %x", 
v½rÙeù
);

10354 
	`EXTRACHECKS_BUG_ON
(
dev
->
dev_dif_ty³
 == 0);

10356 
bytchk
) {

10358 
v½rÙeù
) {

10360 ià(
dev
->
dpicz
) {

10361 
cmd
->
cmd_dif_aùiÚs
 = 0;

10367 
cmd
->
cmd_dif_aùiÚs
 = 
SCST_DIF_CHECK_GUARD_TAG
 |

10368 
dev
->
dif_­p_chk
 | dev->
dif_»f_chk
;

10371 
cmd
->
cmd_dif_aùiÚs
 = 
dev
->
dif_­p_chk
 | dev->
dif_»f_chk
;

10374 
cmd
->
cmd_dif_aùiÚs
 = 0;

10377 
cmd
->
cmd_dif_aùiÚs
 = 
SCST_DIF_CHECK_GUARD_TAG
;

10380 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
, "Invalid VRPROTECT value %x "

10381 "(dev %s, cmd %p)", 
v½rÙeù
, 
dev
->
vœt_Çme
, 
cmd
);

10382 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 
v½rÙeù_offs
,

10383 5|
SCST_INVAL_FIELD_BIT_OFFS_VALID
);

10384 
»s
 = 
EINVAL
;

10385 
out
;

10390 
v½rÙeù
) {

10392 ià(
dev
->
dpicz
)

10393 
cmd
->
cmd_dif_aùiÚs
 = 0;

10395 
cmd
->
cmd_dif_aùiÚs
 = 
dev
->
dev_dif_wr_aùiÚs
 |

10396 
SCST_DIF_CHECK_GUARD_TAG
 | 
dev
->
dif_­p_chk
 |

10397 
dev
->
dif_»f_chk
;

10404 
cmd
->
cmd_dif_aùiÚs
 = 0;

10407 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
, "Invalid VRPROTECT value %x "

10408 "(dev %s, cmd %p)", 
v½rÙeù
, 
dev
->
vœt_Çme
, 
cmd
);

10409 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 
v½rÙeù_offs
,

10410 5|
SCST_INVAL_FIELD_BIT_OFFS_VALID
);

10411 
»s
 = 
EINVAL
;

10412 
out
;

10416 
	`sBUG_ON
(1);

10420 
	`TRACE_DBG
("cmd_dif_actions %x,gt_dif_data_expected %d (cmd %p, "

10421 "bytchk %d)", 
cmd
->
cmd_dif_aùiÚs
, cmd->
tgt_dif_d©a_ex³ùed
,

10422 
cmd
, 
bytchk
);

10424 
out
:

10425 
	`TRACE_EXIT_RES
(
»s
);

10426  
»s
;

10427 
	}
}

10433 
	$sc¡_·r£_v½rÙeù
(
sc¡_cmd
 *
cmd
)

10435 
»s
 = 0;

10436 
v½rÙeù
 = (
cmd
->
cdb
[1] & 0xE0) >> 5;

10437 cÚ¡ 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

10439 
	`TRACE_ENTRY
();

10441 ià(
dev
->
dev_dif_mode
 =ð
SCST_DIF_MODE_NONE
) {

10442 ià(
	`lik–y
(
v½rÙeù
 == 0))

10443 
out
;

10445 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
, "VRPROTECT %x‡nd‚o DIF "

10446 "deviû % (cmd %p)", 
v½rÙeù
,

10447 
dev
->
vœt_Çme
, 
cmd
);

10448 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 1,

10449 5|
SCST_INVAL_FIELD_BIT_OFFS_VALID
);

10450 
»s
 = 
EINVAL
;

10451 
out
;

10454 ià(
	`uÆik–y
((
dev
->
dev_dif_ty³
 =ð2è&& (
v½rÙeù
 != 0))) {

10455 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
, "Non-32-byte CDBs with‚on-zero "

10457 "(dev %s, cmd %p, o°%s)", 
v½rÙeù
,

10458 
dev
->
vœt_Çme
, 
cmd
, 
	`sc¡_g‘_Ýcode_Çme
(cmd));

10459 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

10460 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

10461 
»s
 = 
EINVAL
;

10462 
out
;

10465 
»s
 = 
	`__sc¡_·r£_v½rÙeù
(
cmd
, 1);

10467 
out
:

10468 
	`TRACE_EXIT_RES
(
»s
);

10469  
»s
;

10470 
	}
}

10476 
	$sc¡_·r£_v½rÙeù32
(
sc¡_cmd
 *
cmd
)

10478 
»s
 = 0;

10479 cÚ¡ 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

10481 
	`TRACE_ENTRY
();

10483 ià(
	`uÆik–y
(
dev
->
dev_dif_ty³
 != 2)) {

10484 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
, "32-byte CDBs‡re‚ot "

10486 
dev
->
dev_dif_ty³
, dev->
vœt_Çme
, 
cmd
,

10487 
	`sc¡_g‘_Ýcode_Çme
(
cmd
));

10488 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

10489 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

10490 
»s
 = 
EINVAL
;

10491 
out
;

10494 
»s
 = 
	`__sc¡_·r£_v½rÙeù
(
cmd
, 10);

10496 
out
:

10497 
	`TRACE_EXIT_RES
(
»s
);

10498  
»s
;

10499 
	}
}

10506 cÚ¡ 
	gsc¡_cdb_Ëngth
[8] = { 6, 10, 10, 32, 16, 12, 0, 0 };

10508 
	#SCST_CDB_GROUP
(
Ýcode
è((Ýcod>> 5è& 0x7)

	)

10509 
	#SCST_GET_CDB_LEN
(
Ýcode
è
sc¡_cdb_Ëngth
[
	`SCST_CDB_GROUP
(Ýcode)]

	)

10511 
	$g‘_cdb_šfo_Ën_10
(
sc¡_cmd
 *
cmd
,

10512 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

10514 
cmd
->
cdb_Ën
 = 10;

10515 
cmd
->
Ý_æags
 |ð
SCST_LBA_NOT_VALID
;

10516 
cmd
->
lba
 = 0;

10519 
	`EXTRACHECKS_BUG_ON
(
cmd
->
bufæ’
 != 0);

10521 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

10523 
	}
}

10525 
	$g‘_cdb_šfo_block_lim™
(
sc¡_cmd
 *
cmd
,

10526 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

10528 
cmd
->
Ý_æags
 |ð
SCST_LBA_NOT_VALID
;

10529 
cmd
->
lba
 = 0;

10530 
cmd
->
bufæ’
 = 6;

10531 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

10533 
	}
}

10535 
	$g‘_cdb_šfo_»ad_ÿ·c™y
(
sc¡_cmd
 *
cmd
,

10536 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

10538 
cmd
->
Ý_æags
 |ð
SCST_LBA_NOT_VALID
;

10539 
cmd
->
lba
 = 0;

10540 
cmd
->
bufæ’
 = 8;

10541 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

10543 
	}
}

10545 
	$g‘_cdb_šfo_£rv_aù_š
(
sc¡_cmd
 *
cmd
,

10546 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

10548 
»s
 = 0;

10550 
	`TRACE_ENTRY
();

10552 
cmd
->
lba
 = 0;

10554 
cmd
->
cdb
[1] & 0x1f) {

10555 
SAI_READ_CAPACITY_16
:

10556 
cmd
->
Ý_Çme
 = "READ CAPACITY(16)";

10557 
cmd
->
bufæ’
 = 
	`g‘_uÇligÃd_be32
(&cmd->
cdb
[10]);

10558 ià(
	`uÆik–y
(
cmd
->
bufæ’
 & 
SCST_MAX_VALID_BUFFLEN_MASK
))

10559 
out_šv®_bufæ’10
;

10560 
cmd
->
Ý_æags
 |ð
SCST_IMPLICIT_HQ
 | 
SCST_LBA_NOT_VALID
 |

10561 
SCST_REG_RESERVE_ALLOWED
 |

10562 
SCST_WRITE_EXCL_ALLOWED
 |

10563 
SCST_EXCL_ACCESS_ALLOWED
;

10565 
SAI_GET_LBA_STATUS
:

10566 
cmd
->
Ý_Çme
 = "GET LBA STATUS";

10567 
cmd
->
lba
 = 
	`g‘_uÇligÃd_be64
(&cmd->
cdb
[2]);

10568 
cmd
->
bufæ’
 = 
	`g‘_uÇligÃd_be32
(&cmd->
cdb
[10]);

10569 ià(
	`uÆik–y
(
cmd
->
bufæ’
 & 
SCST_MAX_VALID_BUFFLEN_MASK
))

10570 
out_šv®_bufæ’10
;

10571 
cmd
->
Ý_æags
 |ð
SCST_WRITE_EXCL_ALLOWED
;

10574 
cmd
->
Ý_æags
 |ð
SCST_UNKNOWN_LENGTH
 | 
SCST_LBA_NOT_VALID
;

10578 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

10580 
out
:

10581 
	`TRACE_EXIT_RES
(
»s
);

10582  
»s
;

10584 
out_šv®_bufæ’10
:

10585 
	`PRINT_ERROR
("ToØbig bufæ’ %d (Ý %s)", 
cmd
->
bufæ’
,

10586 
	`sc¡_g‘_Ýcode_Çme
(
cmd
));

10587 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 10, 0);

10588 
»s
 = 1;

10589 
out
;

10590 
	}
}

10592 
	$g‘_cdb_šfo_sšgË
(
sc¡_cmd
 *
cmd
,

10593 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

10595 
cmd
->
Ý_æags
 |ð
SCST_LBA_NOT_VALID
;

10596 
cmd
->
lba
 = 0;

10597 
cmd
->
bufæ’
 = 1;

10598 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

10600 
	}
}

10602 
	$g‘_cdb_šfo_»ad_pos
(
sc¡_cmd
 *
cmd
,

10603 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

10605 
»s
 = 0;

10607 
cmd
->
Ý_æags
 |ð
SCST_LBA_NOT_VALID
;

10608 
cmd
->
lba
 = 0;

10610 
cmd
->
bufæ’
 = 
	`g‘_uÇligÃd_be16
(cmd->
cdb
 + 
sdbÝs
->
šfo_Ën_off
);

10612 
cmd
->
cdb
[1] & 0x1f) {

10616 ià(
cmd
->
bufæ’
 != 0) {

10617 
	`PRINT_ERROR
("READ POSITION: Invalid‚on-zero (%d) "

10619 
cmd
->
bufæ’
, cmd->
cdb
[1] & 0x1f);

10620 
out_šv®_f›ld1
;

10625 
cmd
->
cdb
[1] & 0x1f) {

10628 
cmd
->
bufæ’
 = 20;

10631 
cmd
->
bufæ’
 = 32;

10634 
cmd
->
bufæ’
 = 
	`max
(32, cmd->bufflen);

10637 
	`PRINT_ERROR
("READ POSITION: Invalid service‡ction %x",

10638 
cmd
->
cdb
[1] & 0x1f);

10639 
out_šv®_f›ld1
;

10642 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

10644 
out
:

10645  
»s
;

10647 
out_šv®_f›ld1
:

10648 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 1, 0);

10649 
»s
 = 1;

10650 
out
;

10651 
	}
}

10653 
	$g‘_cdb_šfo_´ev’t_®low_medium_»mov®
(
sc¡_cmd
 *
cmd
,

10654 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

10656 
cmd
->
Ý_æags
 |ð
SCST_LBA_NOT_VALID
;

10657 
cmd
->
lba
 = 0;

10659 
cmd
->
d©a_Ën
 = 0;

10661 
	`EXTRACHECKS_BUG_ON
(
cmd
->
bufæ’
 != 0);

10662 ià((
cmd
->
cdb
[4] & 3) == 0)

10663 
cmd
->
Ý_æags
 |ð
SCST_REG_RESERVE_ALLOWED
 |

10664 
SCST_WRITE_EXCL_ALLOWED
 | 
SCST_EXCL_ACCESS_ALLOWED
;

10666 
	}
}

10668 
	$g‘_cdb_šfo_¡¬t_¡Ý
(
sc¡_cmd
 *
cmd
,

10669 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

10671 
cmd
->
Ý_æags
 |ð
SCST_LBA_NOT_VALID
;

10672 
cmd
->
lba
 = 0;

10674 
cmd
->
d©a_Ën
 = 0;

10676 
	`EXTRACHECKS_BUG_ON
(
cmd
->
bufæ’
 != 0);

10677 ià((
cmd
->
cdb
[4] & 0xF1) == 0x1)

10678 
cmd
->
Ý_æags
 |ð
SCST_REG_RESERVE_ALLOWED
 |

10679 
SCST_WRITE_EXCL_ALLOWED
 | 
SCST_EXCL_ACCESS_ALLOWED
;

10681 
	}
}

10683 
	$g‘_cdb_šfo_Ën_3_»ad_–em_¡©
(
sc¡_cmd
 *
cmd
,

10684 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

10686 
cmd
->
Ý_æags
 |ð
SCST_LBA_NOT_VALID
;

10687 
cmd
->
lba
 = 0;

10689 
cmd
->
bufæ’
 = 
	`g‘_uÇligÃd_be24
(cmd->
cdb
 + 
sdbÝs
->
šfo_Ën_off
);

10690 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

10692 ià((
cmd
->
cdb
[6] & 0x2) == 0x2)

10693 
cmd
->
Ý_æags
 |ð
SCST_REG_RESERVE_ALLOWED
 |

10694 
SCST_WRITE_EXCL_ALLOWED
 | 
SCST_EXCL_ACCESS_ALLOWED
;

10696 
	}
}

10698 
	$g‘_cdb_šfo_bidi_lba_4_Ën_2
(
sc¡_cmd
 *
cmd
,

10699 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

10701 
cmd
->
lba
 = 
	`g‘_uÇligÃd_be32
(cmd->
cdb
 + 
sdbÝs
->
šfo_lba_off
);

10702 
cmd
->
bufæ’
 = 
	`g‘_uÇligÃd_be16
(cmd->
cdb
 + 
sdbÝs
->
šfo_Ën_off
);

10703 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

10704 
cmd
->
out_bufæ’
 = cmd->
bufæ’
;

10706 
	}
}

10708 
	$g‘_cdb_šfo_fmt
(
sc¡_cmd
 *
cmd
,

10709 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

10711 
cmd
->
Ý_æags
 |ð
SCST_LBA_NOT_VALID
;

10712 
cmd
->
lba
 = 0;

10713 ià(
cmd
->
cdb
[1] & 0x10 ) {

10714 
cmd
->
d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
;

10715 
cmd
->
Ý_æags
 |ð
SCST_UNKNOWN_LENGTH
;

10716 
cmd
->
bufæ’
 = 4096;

10718 
cmd
->
bufæ’
 = 0;

10719 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

10721 
	}
}

10723 
	$g‘_cdb_šfo_v”ify10
(
sc¡_cmd
 *
cmd
,

10724 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

10726 ià(
	`uÆik–y
(
cmd
->
cdb
[1] & 4)) {

10727 
	`PRINT_ERROR
("VERIFY(10): BYTCHK 1x‚ot supported (dev %s)",

10728 
cmd
->
dev
 ? cmd->dev->
vœt_Çme
 : 
NULL
);

10729 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 1,

10730 2 | 
SCST_INVAL_FIELD_BIT_OFFS_VALID
);

10734 
cmd
->
lba
 = 
	`g‘_uÇligÃd_be32
(cmd->
cdb
 + 
sdbÝs
->
šfo_lba_off
);

10735 ià(
cmd
->
cdb
[1] & 2) {

10736 
cmd
->
bufæ’
 = 
	`g‘_uÇligÃd_be16
(cmd->
cdb
 + 
sdbÝs
->
šfo_Ën_off
);

10737 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

10738 
cmd
->
d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
;

10740 
cmd
->
bufæ’
 = 0;

10741 
cmd
->
d©a_Ën
 = 
	`g‘_uÇligÃd_be16
(cmd->
cdb
 + 
sdbÝs
->
šfo_Ën_off
);

10742 
cmd
->
d©a_dœeùiÚ
 = 
SCST_DATA_NONE
;

10744  
	`sc¡_·r£_v½rÙeù
(
cmd
);

10745 
	}
}

10747 
	$g‘_cdb_šfo_v”ify6
(
sc¡_cmd
 *
cmd
,

10748 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

10750 
cmd
->
Ý_æags
 |ð
SCST_LBA_NOT_VALID
;

10751 
cmd
->
lba
 = 0;

10753 ià(
	`uÆik–y
(
cmd
->
cdb
[1] & 4)) {

10754 
	`PRINT_ERROR
("VERIFY(6): BYTCHK 1x‚ot supported (dev %s)",

10755 
cmd
->
dev
 ? cmd->dev->
vœt_Çme
 : 
NULL
);

10756 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 1,

10757 2 | 
SCST_INVAL_FIELD_BIT_OFFS_VALID
);

10761 ià(
cmd
->
cdb
[1] & 2) {

10762 
cmd
->
bufæ’
 = 
	`g‘_uÇligÃd_be24
(cmd->
cdb
 + 
sdbÝs
->
šfo_Ën_off
);

10763 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

10764 
cmd
->
d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
;

10766 
cmd
->
bufæ’
 = 0;

10767 
cmd
->
d©a_Ën
 = 
	`g‘_uÇligÃd_be24
(cmd->
cdb
 + 
sdbÝs
->
šfo_Ën_off
);

10768 
cmd
->
d©a_dœeùiÚ
 = 
SCST_DATA_NONE
;

10771 
	}
}

10773 
	$g‘_cdb_šfo_v”ify12
(
sc¡_cmd
 *
cmd
,

10774 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

10776 ià(
	`uÆik–y
(
cmd
->
cdb
[1] & 4)) {

10777 
	`PRINT_ERROR
("VERIFY(12): BYTCHK 1x‚ot supported (dev %s)",

10778 
cmd
->
dev
 ? cmd->dev->
vœt_Çme
 : 
NULL
);

10779 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 1,

10780 2 | 
SCST_INVAL_FIELD_BIT_OFFS_VALID
);

10784 
cmd
->
lba
 = 
	`g‘_uÇligÃd_be32
(cmd->
cdb
 + 
sdbÝs
->
šfo_lba_off
);

10785 ià(
cmd
->
cdb
[1] & 2) {

10786 
cmd
->
bufæ’
 = 
	`g‘_uÇligÃd_be32
(cmd->
cdb
 + 
sdbÝs
->
šfo_Ën_off
);

10787 ià(
	`uÆik–y
(
cmd
->
bufæ’
 & 
SCST_MAX_VALID_BUFFLEN_MASK
)) {

10788 
	`PRINT_ERROR
("Too big bufflen %d (op %s)",

10789 
cmd
->
bufæ’
, 
	`sc¡_g‘_Ýcode_Çme
(cmd));

10790 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 
sdbÝs
->
šfo_Ën_off
, 0);

10793 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

10794 
cmd
->
d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
;

10796 
cmd
->
bufæ’
 = 0;

10797 
cmd
->
d©a_Ën
 = 
	`g‘_uÇligÃd_be32
(cmd->
cdb
 + 
sdbÝs
->
šfo_Ën_off
);

10798 
cmd
->
d©a_dœeùiÚ
 = 
SCST_DATA_NONE
;

10800  
	`sc¡_·r£_v½rÙeù
(
cmd
);

10801 
	}
}

10803 
	$g‘_cdb_šfo_v”ify16
(
sc¡_cmd
 *
cmd
,

10804 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

10806 ià(
	`uÆik–y
(
cmd
->
cdb
[1] & 4)) {

10807 
	`PRINT_ERROR
("VERIFY(16): BYTCHK 1x‚ot supported (dev %s)",

10808 
cmd
->
dev
 ? cmd->dev->
vœt_Çme
 : 
NULL
);

10809 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 1,

10810 2 | 
SCST_INVAL_FIELD_BIT_OFFS_VALID
);

10814 
cmd
->
lba
 = 
	`g‘_uÇligÃd_be64
(cmd->
cdb
 + 
sdbÝs
->
šfo_lba_off
);

10815 ià(
cmd
->
cdb
[1] & 2) {

10816 
cmd
->
bufæ’
 = 
	`g‘_uÇligÃd_be32
(cmd->
cdb
 + 
sdbÝs
->
šfo_Ën_off
);

10817 ià(
	`uÆik–y
(
cmd
->
bufæ’
 & 
SCST_MAX_VALID_BUFFLEN_MASK
)) {

10818 
	`PRINT_ERROR
("Too big bufflen %d (op %s)",

10819 
cmd
->
bufæ’
, 
	`sc¡_g‘_Ýcode_Çme
(cmd));

10820 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 
sdbÝs
->
šfo_Ën_off
, 0);

10823 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

10824 
cmd
->
d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
;

10826 
cmd
->
bufæ’
 = 0;

10827 
cmd
->
d©a_Ën
 = 
	`g‘_uÇligÃd_be32
(cmd->
cdb
 + 
sdbÝs
->
šfo_Ën_off
);

10828 
cmd
->
d©a_dœeùiÚ
 = 
SCST_DATA_NONE
;

10830  
	`sc¡_·r£_v½rÙeù
(
cmd
);

10831 
	}
}

10833 
	$g‘_cdb_šfo_v”ify32
(
sc¡_cmd
 *
cmd
,

10834 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

10836 ià(
	`uÆik–y
(
cmd
->
cdb
[10] & 4)) {

10837 
	`PRINT_ERROR
("VERIFY(16): BYTCHK 1x‚ot supported (dev %s)",

10838 
cmd
->
dev
 ? cmd->dev->
vœt_Çme
 : 
NULL
);

10839 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 1,

10840 2 | 
SCST_INVAL_FIELD_BIT_OFFS_VALID
);

10844 
cmd
->
lba
 = 
	`g‘_uÇligÃd_be64
(cmd->
cdb
 + 
sdbÝs
->
šfo_lba_off
);

10845 ià(
cmd
->
cdb
[10] & 2) {

10846 
cmd
->
bufæ’
 = 
	`g‘_uÇligÃd_be32
(cmd->
cdb
 + 
sdbÝs
->
šfo_Ën_off
);

10847 ià(
	`uÆik–y
(
cmd
->
bufæ’
 & 
SCST_MAX_VALID_BUFFLEN_MASK
)) {

10848 
	`PRINT_ERROR
("Too big bufflen %d (op %s)",

10849 
cmd
->
bufæ’
, 
	`sc¡_g‘_Ýcode_Çme
(cmd));

10850 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 
sdbÝs
->
šfo_Ën_off
, 0);

10853 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

10854 
cmd
->
d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
;

10856 
cmd
->
bufæ’
 = 0;

10857 
cmd
->
d©a_Ën
 = 
	`g‘_uÇligÃd_be32
(cmd->
cdb
 + 
sdbÝs
->
šfo_Ën_off
);

10858 
cmd
->
d©a_dœeùiÚ
 = 
SCST_DATA_NONE
;

10860  
	`sc¡_·r£_v½rÙeù32
(
cmd
);

10861 
	}
}

10863 
	$g‘_cdb_šfo_Ën_1
(
sc¡_cmd
 *
cmd
,

10864 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

10866 
cmd
->
Ý_æags
 |ð
SCST_LBA_NOT_VALID
;

10867 
cmd
->
lba
 = 0;

10869 
cmd
->
bufæ’
 = cmd->
cdb
[
sdbÝs
->
šfo_Ën_off
];

10870 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

10872 
	}
}

10874 
šlše
 
	$g‘_cdb_šfo_lba_3_Ën_1_256
(
sc¡_cmd
 *
cmd
,

10875 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

10877 
cmd
->
lba
 = (cmd->
cdb
[
sdbÝs
->
šfo_lba_off
] & 0x1F) << 16;

10878 
cmd
->
lba
 |ð
	`g‘_uÇligÃd_be16
(cmd->
cdb
 + 
sdbÝs
->
šfo_lba_off
 + 1);

10890 
cmd
->
bufæ’
 = (
u8
)(cmd->
cdb
[
sdbÝs
->
šfo_Ën_off
] - 1) + 1;

10891 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

10893 
	}
}

10895 
	$g‘_cdb_šfo_lba_3_Ën_1_256_»ad
(
sc¡_cmd
 *
cmd
,

10896 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

10898 
»s
 = 
	`g‘_cdb_šfo_lba_3_Ën_1_256
(
cmd
, 
sdbÝs
);

10900 ià(
»s
 != 0)

10901 
out
;

10903 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

10905 ià((
dev
->
dev_dif_mode
 !ð
SCST_DIF_MODE_NONE
è&& !dev->
dpicz
)

10906 
cmd
->
cmd_dif_aùiÚs
 = 
dev
->
dev_dif_rd_´Ù0_aùiÚs
 |

10907 
SCST_DIF_CHECK_GUARD_TAG
 | 
dev
->
dif_­p_chk
 |

10908 
SCST_DIF_CHECK_REF_TAG
;

10910 
out
:

10911  
»s
;

10912 
	}
}

10914 
	$g‘_cdb_šfo_lba_3_Ën_1_256_wr™e
(
sc¡_cmd
 *
cmd
,

10915 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

10917 
»s
 = 
	`g‘_cdb_šfo_lba_3_Ën_1_256
(
cmd
, 
sdbÝs
);

10919 ià(
»s
 != 0)

10920 
out
;

10922 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

10924 ià(
dev
->
dev_dif_mode
 !ð
SCST_DIF_MODE_NONE
)

10925 
cmd
->
cmd_dif_aùiÚs
 = 
dev
->
dev_dif_wr_´Ù0_aùiÚs
 |

10926 
SCST_DIF_CHECK_GUARD_TAG
 | 
dev
->
dif_­p_chk
 |

10927 
SCST_DIF_CHECK_REF_TAG
;

10929 
out
:

10930  
»s
;

10931 
	}
}

10933 
	$g‘_cdb_šfo_Ën_2
(
sc¡_cmd
 *
cmd
,

10934 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

10936 
cmd
->
Ý_æags
 |ð
SCST_LBA_NOT_VALID
;

10937 
cmd
->
lba
 = 0;

10938 
cmd
->
bufæ’
 = 
	`g‘_uÇligÃd_be16
(cmd->
cdb
 + 
sdbÝs
->
šfo_Ën_off
);

10939 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

10941 
	}
}

10943 
	$g‘_cdb_šfo_Ën_3
(
sc¡_cmd
 *
cmd
,

10944 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

10946 
cmd
->
Ý_æags
 |ð
SCST_LBA_NOT_VALID
;

10947 
cmd
->
lba
 = 0;

10948 
cmd
->
bufæ’
 = 
	`g‘_uÇligÃd_be24
(cmd->
cdb
 + 
sdbÝs
->
šfo_Ën_off
);

10949 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

10951 
	}
}

10953 
	$g‘_cdb_šfo_Ën_4
(
sc¡_cmd
 *
cmd
,

10954 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

10956 
cmd
->
Ý_æags
 |ð
SCST_LBA_NOT_VALID
;

10957 
cmd
->
lba
 = 0;

10958 
cmd
->
bufæ’
 = 
	`g‘_uÇligÃd_be32
(cmd->
cdb
 + 
sdbÝs
->
šfo_Ën_off
);

10959 ià(
	`uÆik–y
(
cmd
->
bufæ’
 & 
SCST_MAX_VALID_BUFFLEN_MASK
)) {

10960 
	`PRINT_ERROR
("ToØbig bufæ’ %d (Ý %s)", 
cmd
->
bufæ’
,

10961 
	`sc¡_g‘_Ýcode_Çme
(
cmd
));

10962 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 
sdbÝs
->
šfo_Ën_off
, 0);

10965 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

10967 
	}
}

10969 
	$g‘_cdb_šfo_nÚe
(
sc¡_cmd
 *
cmd
,

10970 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

10972 
cmd
->
Ý_æags
 |ð
SCST_LBA_NOT_VALID
;

10973 
cmd
->
lba
 = 0;

10976 
	`EXTRACHECKS_BUG_ON
(
cmd
->
bufæ’
 != 0);

10978 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

10980 
	}
}

10982 
	$g‘_cdb_šfo_lba_2_nÚe
(
sc¡_cmd
 *
cmd
,

10983 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

10985 
cmd
->
lba
 = 
	`g‘_uÇligÃd_be16
(cmd->
cdb
 + 
sdbÝs
->
šfo_lba_off
);

10988 
	`EXTRACHECKS_BUG_ON
(
cmd
->
bufæ’
 != 0);

10990 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

10992 
	}
}

10994 
	$g‘_cdb_šfo_lba_4_nÚe
(
sc¡_cmd
 *
cmd
,

10995 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

10997 
cmd
->
lba
 = 
	`g‘_uÇligÃd_be32
(cmd->
cdb
 + 
sdbÝs
->
šfo_lba_off
);

11000 
	`EXTRACHECKS_BUG_ON
(
cmd
->
bufæ’
 != 0);

11002 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

11004 
	}
}

11006 
	$g‘_cdb_šfo_lba_8_nÚe
(
sc¡_cmd
 *
cmd
,

11007 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

11009 
cmd
->
lba
 = 
	`g‘_uÇligÃd_be64
(cmd->
cdb
 + 
sdbÝs
->
šfo_lba_off
);

11012 
	`EXTRACHECKS_BUG_ON
(
cmd
->
bufæ’
 != 0);

11014 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

11016 
	}
}

11018 
	$g‘_cdb_šfo_lba_4_Ën_2
(
sc¡_cmd
 *
cmd
,

11019 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

11021 
cmd
->
lba
 = 
	`g‘_uÇligÃd_be32
(cmd->
cdb
 + 
sdbÝs
->
šfo_lba_off
);

11022 
cmd
->
bufæ’
 = 
	`g‘_uÇligÃd_be16
(cmd->
cdb
 + 
sdbÝs
->
šfo_Ën_off
);

11023 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

11025 
	}
}

11027 
	$g‘_cdb_šfo_»ad_10
(
sc¡_cmd
 *
cmd
,

11028 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

11030 
»s
 = 
	`g‘_cdb_šfo_lba_4_Ën_2
(
cmd
, 
sdbÝs
);

11032 ià(
»s
 != 0)

11033  
»s
;

11035 #ifdeà
CONFIG_SCST_DIF_INJECT_CORRUPTED_TAGS


11036 
	`EXTRACHECKS_BUG_ON
(
cmd
->
cdb
[0] !ð
READ_10
);

11037 
cmd
->
cmd_cÜru±_dif_g
 = (cmd->
cdb
[6] & 0xE0) >> 5;

11039  
	`sc¡_·r£_rd´Ùeù
(
cmd
);

11041 
	}
}

11043 
	$g‘_cdb_šfo_lba_4_Ën_2_w½rÙeù
(
sc¡_cmd
 *
cmd
,

11044 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

11046 
»s
 = 
	`g‘_cdb_šfo_lba_4_Ën_2
(
cmd
, 
sdbÝs
);

11048 ià(
»s
 != 0)

11049  
»s
;

11051  
	`sc¡_·r£_w½rÙeù
(
cmd
);

11052 
	}
}

11054 
šlše
 
	$g‘_cdb_šfo_lba_4_Ën_4
(
sc¡_cmd
 *
cmd
,

11055 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

11057 
cmd
->
lba
 = 
	`g‘_uÇligÃd_be32
(cmd->
cdb
 + 
sdbÝs
->
šfo_lba_off
);

11058 
cmd
->
bufæ’
 = 
	`g‘_uÇligÃd_be32
(cmd->
cdb
 + 
sdbÝs
->
šfo_Ën_off
);

11059 ià(
	`uÆik–y
(
cmd
->
bufæ’
 & 
SCST_MAX_VALID_BUFFLEN_MASK
)) {

11060 
	`PRINT_ERROR
("ToØbig bufæ’ %d (Ý %s)", 
cmd
->
bufæ’
,

11061 
	`sc¡_g‘_Ýcode_Çme
(
cmd
));

11062 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 
sdbÝs
->
šfo_Ën_off
, 0);

11065 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

11067 
	}
}

11069 
	$g‘_cdb_šfo_lba_4_Ën_4_rd´Ùeù
(
sc¡_cmd
 *
cmd
,

11070 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

11072 
»s
 = 
	`g‘_cdb_šfo_lba_4_Ën_4
(
cmd
, 
sdbÝs
);

11074 ià(
»s
 != 0)

11075  
»s
;

11077  
	`sc¡_·r£_rd´Ùeù
(
cmd
);

11078 
	}
}

11080 
	$g‘_cdb_šfo_lba_4_Ën_4_w½rÙeù
(
sc¡_cmd
 *
cmd
,

11081 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

11083 
»s
 = 
	`g‘_cdb_šfo_lba_4_Ën_4
(
cmd
, 
sdbÝs
);

11085 ià(
»s
 != 0)

11086  
»s
;

11088  
	`sc¡_·r£_w½rÙeù
(
cmd
);

11089 
	}
}

11091 
šlše
 
	$g‘_cdb_šfo_lba_8_Ën_4
(
sc¡_cmd
 *
cmd
,

11092 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

11094 
cmd
->
lba
 = 
	`g‘_uÇligÃd_be64
(cmd->
cdb
 + 
sdbÝs
->
šfo_lba_off
);

11095 
cmd
->
bufæ’
 = 
	`g‘_uÇligÃd_be32
(cmd->
cdb
 + 
sdbÝs
->
šfo_Ën_off
);

11096 ià(
	`uÆik–y
(
cmd
->
bufæ’
 & 
SCST_MAX_VALID_BUFFLEN_MASK
)) {

11097 
	`PRINT_ERROR
("ToØbig bufæ’ %d (Ý %s)", 
cmd
->
bufæ’
,

11098 
	`sc¡_g‘_Ýcode_Çme
(
cmd
));

11099 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 
sdbÝs
->
šfo_Ën_off
, 0);

11102 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

11104 
	}
}

11106 
	$g‘_cdb_šfo_»ad_16
(
sc¡_cmd
 *
cmd
,

11107 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

11109 
»s
 = 
	`g‘_cdb_šfo_lba_8_Ën_4
(
cmd
, 
sdbÝs
);

11111 ià(
»s
 != 0)

11112  
»s
;

11114 #ifdeà
CONFIG_SCST_DIF_INJECT_CORRUPTED_TAGS


11115 
	`EXTRACHECKS_BUG_ON
(
cmd
->
cdb
[0] !ð
READ_16
);

11116 
cmd
->
cmd_cÜru±_dif_g
 = (cmd->
cdb
[14] & 0xE0) >> 5;

11118  
	`sc¡_·r£_rd´Ùeù
(
cmd
);

11120 
	}
}

11122 
	$g‘_cdb_šfo_lba_8_Ën_4_w½rÙeù
(
sc¡_cmd
 *
cmd
,

11123 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

11125 
»s
 = 
	`g‘_cdb_šfo_lba_8_Ën_4
(
cmd
, 
sdbÝs
);

11127 ià(
»s
 != 0)

11128  
»s
;

11130  
	`sc¡_·r£_w½rÙeù
(
cmd
);

11131 
	}
}

11133 
	$g‘_cdb_šfo_lba_8_Ën_4_w½rÙeù32
(
sc¡_cmd
 *
cmd
,

11134 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

11136 
»s
 = 
	`g‘_cdb_šfo_lba_8_Ën_4
(
cmd
, 
sdbÝs
);

11138 ià(
»s
 != 0)

11139  
»s
;

11141  
	`sc¡_·r£_w½rÙeù32
(
cmd
);

11142 
	}
}

11144 
	$g‘_cdb_šfo_lba_8_Ën_4_rd´Ùeù32
(
sc¡_cmd
 *
cmd
,

11145 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

11147 
»s
 = 
	`g‘_cdb_šfo_lba_8_Ën_4
(
cmd
, 
sdbÝs
);

11149 ià(
»s
 != 0)

11150  
»s
;

11152  
	`sc¡_·r£_rd´Ùeù32
(
cmd
);

11153 
	}
}

11155 
	$g‘_cdb_šfo_wr™e_§me
(
sc¡_cmd
 *
cmd
,

11156 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
,

11157 cÚ¡ 
boÞ
 
ndob
)

11159 cÚ¡ 
ušt8_t
 
ù¾_offs
 = 
cmd
->
cdb_Ën
 < 32 ? 1 : 10;

11160 cÚ¡ 
boÞ
 
ªchÜ
 = (
cmd
->
cdb
[
ù¾_offs
] >> 4) & 1;

11161 cÚ¡ 
boÞ
 
unm­
 = (
cmd
->
cdb
[
ù¾_offs
] >> 3) & 1;

11163 ià(!
unm­
 && (
ªchÜ
 || 
ndob
)) {

11164 
	`PRINT_ERROR
("Received invalid %s command (UNMAP = %d;"

11166 
	`sc¡_g‘_Ýcode_Çme
(
cmd
), 
unm­
, 
ªchÜ
, 
ndob
);

11167 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 
ù¾_offs
,

11168 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | (
ndob
 ? 0 : 4));

11172 ià(
ndob
) {

11173 
cmd
->
bufæ’
 = 0;

11174 
cmd
->
d©a_dœeùiÚ
 = 
SCST_DATA_NONE
;

11176 
cmd
->
bufæ’
 = 1;

11177 
cmd
->
d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
;

11180  
cmd
->
cdb_Ën
 < 32 ? 
	`sc¡_·r£_w½rÙeù
(cmd) :

11181 
	`sc¡_·r£_w½rÙeù32
(
cmd
);

11182 
	}
}

11184 
	$g‘_cdb_šfo_wr™e_§me10
(
sc¡_cmd
 *
cmd
,

11185 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

11187 
cmd
->
lba
 = 
	`g‘_uÇligÃd_be32
(cmd->
cdb
 + 
sdbÝs
->
šfo_lba_off
);

11188 
cmd
->
d©a_Ën
 = 
	`g‘_uÇligÃd_be16
(cmd->
cdb
 + 
sdbÝs
->
šfo_Ën_off
);

11189  
	`g‘_cdb_šfo_wr™e_§me
(
cmd
, 
sdbÝs
, 
çl£
);

11190 
	}
}

11192 
	$g‘_cdb_šfo_wr™e_§me16
(
sc¡_cmd
 *
cmd
,

11193 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

11195 
cmd
->
lba
 = 
	`g‘_uÇligÃd_be64
(cmd->
cdb
 + 
sdbÝs
->
šfo_lba_off
);

11196 
cmd
->
d©a_Ën
 = 
	`g‘_uÇligÃd_be32
(cmd->
cdb
 + 
sdbÝs
->
šfo_Ën_off
);

11197  
	`g‘_cdb_šfo_wr™e_§me
(
cmd
, 
sdbÝs
, cmd->
cdb
[1] & 1 );

11198 
	}
}

11200 
	$g‘_cdb_šfo_wr™e_§me32
(
sc¡_cmd
 *
cmd
,

11201 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

11203 
cmd
->
lba
 = 
	`g‘_uÇligÃd_be64
(cmd->
cdb
 + 
sdbÝs
->
šfo_lba_off
);

11204 
cmd
->
d©a_Ën
 = 
	`g‘_uÇligÃd_be32
(cmd->
cdb
 + 
sdbÝs
->
šfo_Ën_off
);

11205  
	`g‘_cdb_šfo_wr™e_§me
(
cmd
, 
sdbÝs
, cmd->
cdb
[10] & 1 );

11206 
	}
}

11208 
	$sc¡_£t_cmd_äom_cdb_šfo
(
sc¡_cmd
 *
cmd
,

11209 cÚ¡ 
sc¡_sdbÝs
 *
±r
)

11211 
cmd
->
cdb_Ën
 = 
	`SCST_GET_CDB_LEN
(cmd->
cdb
[0]);

11212 
cmd
->
cmd_Çÿ
 = (cmd->
cdb
[cmd->
cdb_Ën
 - 1] & 
CONTROL_BYTE_NACA_BIT
);

11213 
cmd
->
cmd_lšked
 = (cmd->
cdb
[cmd->
cdb_Ën
 - 1] & 
CONTROL_BYTE_LINK_BIT
);

11214 
cmd
->
Ý_Çme
 = 
±r
->
šfo_Ý_Çme
;

11215 
cmd
->
d©a_dœeùiÚ
 = 
±r
->
šfo_d©a_dœeùiÚ
;

11216 
cmd
->
Ý_æags
 = 
±r
->
šfo_Ý_æags
 | 
SCST_INFO_VALID
;

11217 
cmd
->
lba_off
 = 
±r
->
šfo_lba_off
;

11218 
cmd
->
lba_Ën
 = 
±r
->
šfo_lba_Ën
;

11219 
cmd
->
Ën_off
 = 
±r
->
šfo_Ën_off
;

11220 
cmd
->
Ën_Ën
 = 
±r
->
šfo_Ën_Ën
;

11221  (*
±r
->
g‘_cdb_šfo
)(
cmd
,…tr);

11222 
	}
}

11224 
	$g‘_cdb_šfo_v¬_Ën
(
sc¡_cmd
 *
cmd
,

11225 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

11227 
»s
;

11233 cÚ¡ 
sc¡_sdbÝs
 
sc¡_scsi_Ý32_bË
[] = {

11234 {.
Ýs
 = 0x7F, .
devkey
 = "O ",

11235 .
šfo_Ý_Çme
 = "READ(32)",

11236 .
šfo_d©a_dœeùiÚ
 = 
SCST_DATA_READ
,

11237 .
šfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
|

11238 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


11239 
SCST_TEST_IO_IN_SIRQ_ALLOWED
|

11241 
SCST_WRITE_EXCL_ALLOWED
,

11242 .
šfo_lba_off
 = 12, .
šfo_lba_Ën
 = 8,

11243 .
šfo_Ën_off
 = 28, .
šfo_Ën_Ën
 = 4,

11244 .
g‘_cdb_šfo
 = 
g‘_cdb_šfo_lba_8_Ën_4_rd´Ùeù32
},

11245 {.
Ýs
 = 0x7F, .
devkey
 = "O ",

11246 .
šfo_Ý_Çme
 = "VERIFY(32)",

11247 .
šfo_d©a_dœeùiÚ
 = 
SCST_DATA_UNKNOWN
,

11248 .
šfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
|
SCST_WRITE_EXCL_ALLOWED
,

11249 .
šfo_lba_off
 = 12, .
šfo_lba_Ën
 = 8,

11250 .
šfo_Ën_off
 = 28, .
šfo_Ën_Ën
 = 4,

11251 .
g‘_cdb_šfo
 = 
g‘_cdb_šfo_v”ify32
},

11252 {.
Ýs
 = 0x7F, .
devkey
 = "O ",

11253 .
šfo_Ý_Çme
 = "WRITE(32)",

11254 .
šfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

11255 .
šfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
|

11256 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


11257 
SCST_TEST_IO_IN_SIRQ_ALLOWED
|

11259 
SCST_WRITE_MEDIUM
,

11260 .
šfo_lba_off
 = 12, .
šfo_lba_Ën
 = 8,

11261 .
šfo_Ën_off
 = 28, .
šfo_Ën_Ën
 = 4,

11262 .
g‘_cdb_šfo
 = 
g‘_cdb_šfo_lba_8_Ën_4_w½rÙeù32
},

11263 {.
Ýs
 = 0x7F, .
devkey
 = "O ",

11264 .
šfo_Ý_Çme
 = "WRITE AND VERIFY(32)",

11265 .
šfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

11266 .
šfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
|
SCST_WRITE_MEDIUM
,

11267 .
šfo_lba_off
 = 12, .
šfo_lba_Ën
 = 8,

11268 .
šfo_Ën_off
 = 28, .
šfo_Ën_Ën
 = 4,

11269 .
g‘_cdb_šfo
 = 
g‘_cdb_šfo_lba_8_Ën_4_w½rÙeù32
},

11270 {.
Ýs
 = 0x7F, .
devkey
 = "O ",

11271 .
šfo_Ý_Çme
 = "WRITE SAME(32)",

11272 .
šfo_d©a_dœeùiÚ
 = 
SCST_DATA_WRITE
,

11273 .
šfo_Ý_æags
 = 
SCST_TRANSFER_LEN_TYPE_FIXED
|
SCST_WRITE_MEDIUM
,

11274 .
šfo_lba_off
 = 12, .
šfo_lba_Ën
 = 8,

11275 .
šfo_Ën_off
 = 28, .
šfo_Ën_Ën
 = 4,

11276 .
g‘_cdb_šfo
 = 
g‘_cdb_šfo_wr™e_§me32
},

11278 cÚ¡ 
sc¡_sdbÝs
 *
±r
;

11279 
subcode
 = 
	`be16_to_ýu
(*(
__be16
 *)&
cmd
->
cdb
[8]);

11280 
i
 = 
subcode
 - 
SUBCODE_READ_32
;

11282 
	`EXTRACHECKS_BUG_ON
(
cmd
->
cdb
[0] != 0x7F);

11283 
	`EXTRACHECKS_BUG_ON
(
sdbÝs
->
Ýs
 != 0x7F);

11286 ià(
	`uÆik–y
(
i
 >ð
	`ARRAY_SIZE
(
sc¡_scsi_Ý32_bË
))) {

11287 
	`TRACE
(
TRACE_MINOR
, "Too big cmd index %d for 0x7F CDB (cmd %p)",

11288 
i
, 
cmd
);

11289 
out_unknown
;

11292 
±r
 = &
sc¡_scsi_Ý32_bË
[
i
];

11294 ià(
	`uÆik–y
(
±r
 =ð
NULL
))

11295 
out_unknown
;

11298 ià(
	`uÆik–y
(
cmd
->
cdb
[7] != 0x18)) {

11299 
	`TRACE
(
TRACE_MINOR
, "Incorrect ADDITIONAL CDB LENGTH %d for "

11300 "0x7F CDB (cmd %p)", 
cmd
->
cdb
[7], cmd);

11301 
cmd
->
Ý_æags
 |ð
SCST_LBA_NOT_VALID
;

11302 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 7, 0);

11303 
»s
 = 1;

11304 
out
;

11307 
»s
 = 
	`sc¡_£t_cmd_äom_cdb_šfo
(
cmd
, 
±r
);

11309 
cmd
->
cmd_Çÿ
 = (cmd->
cdb
[1] & 
CONTROL_BYTE_NACA_BIT
);

11310 
cmd
->
cmd_lšked
 = (cmd->
cdb
[1] & 
CONTROL_BYTE_LINK_BIT
);

11312 
out
:

11313 
	`TRACE_EXIT_RES
(
»s
);

11314  
»s
;

11316 
out_unknown
:

11317 
	`TRACE
(
TRACE_MINOR
, "Unknown opcode 0x%x, subcode %d forype %d",

11318 
cmd
->
cdb
[0], 
subcode
, cmd->
dev
->
ty³
);

11319 
cmd
->
Ý_æags
 &ð~
SCST_INFO_VALID
;

11320 
»s
 = -1;

11321 
out
;

11322 
	}
}

11324 
	$g‘_cdb_šfo_com·»_ªd_wr™e
(
sc¡_cmd
 *
cmd
,

11325 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

11327 
cmd
->
lba
 = 
	`g‘_uÇligÃd_be64
(cmd->
cdb
 + 
sdbÝs
->
šfo_lba_off
);

11328 
cmd
->
d©a_Ën
 = cmd->
cdb
[
sdbÝs
->
šfo_Ën_off
];

11329 
cmd
->
bufæ’
 = 2 * cmd->
d©a_Ën
;

11330  
	`sc¡_·r£_w½rÙeù
(
cmd
);

11331 
	}
}

11333 
	$g‘_cdb_šfo_ext_cÝy
(
sc¡_cmd
 *
cmd
,

11334 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

11336 ià(
	`uÆik–y
(
cmd
->
cdb
[1] != 0)) {

11337 
	`PRINT_WARNING
("Not supported %s service‡ction 0x%x",

11338 
	`sc¡_g‘_Ýcode_Çme
(
cmd
), cmd->
cdb
[1]);

11339 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 1,

11340 0 | 
SCST_INVAL_FIELD_BIT_OFFS_VALID
);

11344  
	`g‘_cdb_šfo_Ën_4
(
cmd
, 
sdbÝs
);

11345 
	}
}

11353 
	$g‘_cdb_šfo_­t
(
sc¡_cmd
 *
cmd
,

11354 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

11356 cÚ¡ 
u8
 *cÚ¡ 
cdb
 = 
cmd
->cdb;

11357 cÚ¡ 
u8
 
Ý
 = 
cdb
[0];

11358 cÚ¡ 
u8
 
ex‹nd
 = 
cdb
[1] & 1;

11359 cÚ¡ 
u8
 
muÉË
 = 
cdb
[1] >> 5;

11360 cÚ¡ 
u8
 
´ÙocÞ
 = (
cdb
[1] >> 1) & 0xf;

11361 cÚ¡ 
u8
 
t_ty³
 = (
cdb
[2] >> 4) & 1;

11362 cÚ¡ 
u8
 
t_dœ
 = (
cdb
[2] >> 3) & 1;

11363 cÚ¡ 
u8
 
by‹_block
 = (
cdb
[2] >> 2) & 1;

11364 cÚ¡ 
u8
 
t_Ëngth
 = 
cdb
[2] & 3;

11365 
bufæ’
 = 0;

11372 ià(
´ÙocÞ
 == 0xf)

11373 
out
;

11375 
Ý
) {

11376 
ATA_12
:

11377 
t_Ëngth
) {

11379 
bufæ’
 = 0;

11382 
bufæ’
 = 
cdb
[3];

11385 
bufæ’
 = 
cdb
[4];

11393 
	`WARN_ON
(
Œue
);

11397 
ATA_16
:

11398 
t_Ëngth
) {

11400 
bufæ’
 = 0;

11403 
bufæ’
 = 
ex‹nd
 ? 
	`g‘_uÇligÃd_be16
(&
cdb
[3]) : cdb[4];

11406 
bufæ’
 = 
ex‹nd
 ? 
	`g‘_uÇligÃd_be16
(&
cdb
[5]) : cdb[6];

11409 
	`WARN_ON
(
Œue
);

11416 
cmd
->
cdb_Ën
 = 
	`SCST_GET_CDB_LEN
(
Ý
);

11417 ià(
t_Ëngth
 !ð0 && 
by‹_block
 != 0) {

11422 
bufæ’
 *ð
t_ty³
 ? 
cmd
->
dev
->
block_size
 : 512;

11431 
cmd
->
d©a_dœeùiÚ
 = (
t_Ëngth
 =ð0 ? 
SCST_DATA_NONE
 : 
t_dœ
 ?

11432 
SCST_DATA_READ
 : 
SCST_DATA_WRITE
);

11433 
cmd
->
lba
 = 0;

11434 
cmd
->
bufæ’
 = bufæ’ << 
muÉË
;

11435 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

11436 
out
:

11437 
cmd
->
Ý_æags
 = 
SCST_INFO_VALID
;

11439 
	}
}

11442 
	$g‘_cdb_šfo_mš
(
sc¡_cmd
 *
cmd
,

11443 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

11445 
cmd
->
cdb
[1] & 0x1f) {

11446 
MI_REPORT_IDENTIFYING_INFORMATION
:

11447 
cmd
->
Ý_Çme
 = "REPORT IDENTIFYING INFORMATION";

11448 
cmd
->
Ý_æags
 |ð
SCST_REG_RESERVE_ALLOWED
 |

11449 
SCST_WRITE_EXCL_ALLOWED
 | 
SCST_EXCL_ACCESS_ALLOWED
;

11451 
MI_REPORT_TARGET_PGS
:

11452 
cmd
->
Ý_Çme
 = "REPORT TARGET PORT GROUPS";

11453 
cmd
->
Ý_æags
 |ð
SCST_REG_RESERVE_ALLOWED
 |

11454 
SCST_WRITE_EXCL_ALLOWED
 | 
SCST_EXCL_ACCESS_ALLOWED
;

11456 
MI_REPORT_SUPPORTED_OPERATION_CODES
:

11457 
cmd
->
Ý_Çme
 = "REPORT SUPPORTED OPERATION CODES";

11458 
cmd
->
Ý_æags
 |ð
SCST_WRITE_EXCL_ALLOWED
;

11459 ià(
cmd
->
devt
->
g‘_suµÜ‹d_Ýcodes
 !ð
NULL
)

11460 
cmd
->
Ý_æags
 |ð
SCST_LOCAL_CMD
 | 
SCST_FULLY_LOCAL_CMD
;

11462 
MI_REPORT_SUPPORTED_TASK_MANAGEMENT_FUNCTIONS
:

11463 
cmd
->
Ý_Çme
 = "REPORT SUPPORTED TASK MANAGEMENT FUNCTIONS";

11464 
cmd
->
Ý_æags
 |ð
SCST_WRITE_EXCL_ALLOWED
 |

11465 
SCST_LOCAL_CMD
 | 
SCST_FULLY_LOCAL_CMD
;

11471  
	`g‘_cdb_šfo_Ën_4
(
cmd
, 
sdbÝs
);

11472 
	}
}

11475 
	$g‘_cdb_šfo_mo
(
sc¡_cmd
 *
cmd
,

11476 cÚ¡ 
sc¡_sdbÝs
 *
sdbÝs
)

11478 
cmd
->
cdb
[1] & 0x1f) {

11479 
MO_SET_TARGET_PGS
:

11481 
æags
;

11483 
cmd
->
Ý_Çme
 = "SET TARGET PORT GROUPS";

11484 
cmd
->
Ý_æags
 |ð
SCST_STRICTLY_SERIALIZED
;

11485 
	`¥š_lock_œq§ve
(&
sc¡_glob®_¡pg_li¡_lock
, 
æags
);

11486 
	`TRACE_DBG
("Addšg STPG cmd %°tØglob®_¡pg_li¡", 
cmd
);

11487 
cmd
->
cmd_Ú_glob®_¡pg_li¡
 = 1;

11488 
	`li¡_add_ž
(&
cmd
->
glob®_¡pg_li¡_’Œy
, &
sc¡_glob®_¡pg_li¡
);

11489 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_glob®_¡pg_li¡_lock
, 
æags
);

11494  
	`g‘_cdb_šfo_Ën_4
(
cmd
, 
sdbÝs
);

11495 
	}
}

11507 
	$sc¡_g‘_cdb_šfo
(
sc¡_cmd
 *
cmd
)

11509 
dev_ty³
 = 
cmd
->
dev
->
ty³
;

11510 
i
, 
»s
 = 0;

11511 
ušt8_t
 
Ý
;

11512 cÚ¡ 
sc¡_sdbÝs
 *
±r
 = 
NULL
;

11514 
	`TRACE_ENTRY
();

11516 
Ý
 = 
cmd
->
cdb
[0];

11518 
	`TRACE_DBG
("Ýcode=%02x, cdbËn=%d by‹s, dev_ty³=%d", 
Ý
,

11519 
	`SCST_GET_CDB_LEN
(
Ý
), 
dev_ty³
);

11521 
i
 = 
sc¡_scsi_Ý_li¡
[
Ý
];

11522 
i
 < 
SCST_CDB_TBL_SIZE
 && 
sc¡_scsi_Ý_bË
[i].
Ýs
 =ð
Ý
) {

11523 ià(
sc¡_scsi_Ý_bË
[
i
].
devkey
[
dev_ty³
] !ð
SCST_CDB_NOTSUPP
) {

11524 
±r
 = &
sc¡_scsi_Ý_bË
[
i
];

11525 
	`TRACE_DBG
("op = 0x%02x+'%c%c%c%c%c%c%c%c%c%c'+<%s>",

11526 
±r
->
Ýs
,…Œ->
devkey
[0],

11527 
±r
->
devkey
[1],

11528 
±r
->
devkey
[2],

11529 
±r
->
devkey
[3],

11530 
±r
->
devkey
[4],

11531 
±r
->
devkey
[5],

11532 
±r
->
devkey
[6],

11533 
±r
->
devkey
[7],

11534 
±r
->
devkey
[8],

11535 
±r
->
devkey
[9],

11536 
±r
->
šfo_Ý_Çme
);

11537 
	`TRACE_DBG
("data direction %d, op flags 0x%x,†ba off %d, "

11539 
±r
->
šfo_d©a_dœeùiÚ
,…Œ->
šfo_Ý_æags
,

11540 
±r
->
šfo_lba_off
,…Œ->
šfo_lba_Ën
,

11541 
±r
->
šfo_Ën_off
,…Œ->
šfo_Ën_Ën
);

11544 
i
++;

11547 ià(
	`uÆik–y
(
±r
 =ð
NULL
)) {

11549 
	`TRACE
(
TRACE_MINOR
, "UnknowÀÝcod0x%x fÜy³ %d", 
Ý
,

11550 
dev_ty³
);

11551 
cmd
->
Ý_æags
 |ð
SCST_LBA_NOT_VALID
;

11552 
»s
 = -1;

11553 
out
;

11556 
»s
 = 
	`sc¡_£t_cmd_äom_cdb_šfo
(
cmd
, 
±r
);

11558 
out
:

11559 
	`TRACE_EXIT_RES
(
»s
);

11560  
»s
;

11561 
	}
}

11562 
EXPORT_SYMBOL_GPL
(
sc¡_g‘_cdb_šfo
);

11565 
__be64
 
	$sc¡_·ck_lun
(cÚ¡ 
ušt64_t
 
lun
, 
sc¡_lun_addr_m‘hod
 
addr_m‘hod
)

11567 
ušt64_t
 
»s
 = 0;

11569 ià(
lun
) {

11570 
»s
 = (
addr_m‘hod
 << 14è| (
lun
 & 0x3fff);

11571 
»s
 =„es << 48;

11574 
	`TRACE_EXIT_HRES
(
»s
 >> 48);

11575  
	`ýu_to_be64
(
»s
);

11576 
	}
}

11577 
EXPORT_SYMBOL
(
sc¡_·ck_lun
);

11584 
ušt64_t
 
	$sc¡_uÅack_lun
(cÚ¡ 
ušt8_t
 *
lun
, 
Ën
)

11586 
ušt64_t
 
»s
 = 
NO_SUCH_LUN
;

11587 
add»ss_m‘hod
;

11589 
	`TRACE_ENTRY
();

11591 
	`TRACE_BUFF_FLAG
(
TRACE_DEBUG
, "Raw LUN", 
lun
, 
Ën
);

11593 
Ën
) {

11597 ià((*((
__be64
 *)
lun
è& 
	`ýu_to_be64
(0x0000FFFFFFFFFFFFLL)) != 0)

11598 
out_”r
;

11601 ià(*((
__be16
 *)&
lun
[2]) != 0)

11602 
out_”r
;

11605 ià(*((
__be32
 *)&
lun
[2]) != 0)

11606 
out_”r
;

11610 
	`PRINT_ERROR
("Illegal†un†ength %d,ƒxpected 2 bytes "

11611 "Ü mÜe", 
Ën
);

11612 
out
;

11614 
out_”r
;

11617 
add»ss_m‘hod
 = (*
lun
) >> 6;

11618 
add»ss_m‘hod
) {

11619 
SCST_LUN_ADDR_METHOD_PERIPHERAL
:

11620 
SCST_LUN_ADDR_METHOD_FLAT
:

11621 
SCST_LUN_ADDR_METHOD_LUN
:

11622 
»s
 = *(
lun
 + 1) | (((*lun) & 0x3f) << 8);

11625 
SCST_LUN_ADDR_METHOD_EXTENDED_LUN
:

11627 
	`PRINT_ERROR
("Unimplemented LUN‡ddressing method %u",

11628 
add»ss_m‘hod
);

11632 
out
:

11633 
	`TRACE_EXIT_RES
(()
»s
);

11634  
»s
;

11636 
out_”r
:

11637 
	`PRINT_ERROR
("%s", "Multi-level LUN unimplemented");

11638 
out
;

11639 
	}
}

11640 
EXPORT_SYMBOL
(
sc¡_uÅack_lun
);

11653 
	$sc¡_ÿlc_block_shiá
(
£ùÜ_size
)

11655 
block_shiá
;

11657 ià(
£ùÜ_size
 == 0)

11658 
£ùÜ_size
 = 512;

11660 
block_shiá
 = 
	`žog2
(
£ùÜ_size
);

11661 
	`WARN_ONCE
(1 << 
block_shiá
 !ð
£ùÜ_size
, "1 << %d != %d\n",

11662 
block_shiá
, 
£ùÜ_size
);

11664 ià(
block_shiá
 < 9) {

11665 
	`PRINT_ERROR
("WrÚg seùÜ siz%d", 
£ùÜ_size
);

11666 
block_shiá
 = -1;

11669 
	`TRACE_EXIT_RES
(
block_shiá
);

11670  
block_shiá
;

11671 
	}
}

11672 
EXPORT_SYMBOL_GPL
(
sc¡_ÿlc_block_shiá
);

11678 
	#shiá_Ëá_ov”æows
(
a
, 
b
) \

11680 
	`ty³of
(
a
è
_mšus_Úe
 = -1LL; \

11681 
	`ty³of
(
a
è
_¶us_Úe
 = 1; \

11682 
boÞ
 
_a_is_sigÃd
 = 
_mšus_Úe
 < 0; \

11683 
_shiá
 = (
a
è* 8 - ((
b
è+ 
_a_is_sigÃd
); \

11684 
_shiá
 < 0 || ((
a
è& ~((
_¶us_Úe
 << _shift) - 1)) != 0;\

11685 })

	)

11690 
šlše
 
	$sc¡_g’”ic_·r£
(
sc¡_cmd
 *
cmd
, cÚ¡ 
timeout
[3])

11692 cÚ¡ 
block_shiá
 = 
cmd
->
dev
->block_shift;

11693 
»s
 = -
EINVAL
;

11695 
	`TRACE_ENTRY
();

11697 
	`EXTRACHECKS_BUG_ON
(
block_shiá
 < 0);

11704 ià(
cmd
->
Ý_æags
 & 
SCST_TRANSFER_LEN_TYPE_FIXED
) {

11709 
boÞ
 
ov”æow
 = 
	`shiá_Ëá_ov”æows
(
cmd
->
bufæ’
, 
block_shiá
) ||

11710 
	`shiá_Ëá_ov”æows
(
cmd
->
d©a_Ën
, 
block_shiá
) ||

11711 
	`shiá_Ëá_ov”æows
(
cmd
->
out_bufæ’
, 
block_shiá
);

11712 ià(
	`uÆik–y
(
ov”æow
)) {

11713 
	`PRINT_WARNING
("bufflen %u, data_len %llu or out_bufflen"

11715 " %u)", 
cmd
->
bufæ’
, cmd->
d©a_Ën
,

11716 
cmd
->
out_bufæ’
, cmd->
dev
->
vœt_Çme
,

11717 1 << 
block_shiá
);

11718 
	`PRINT_BUFFER
("CDB", 
cmd
->
cdb
, cmd->
cdb_Ën
);

11719 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(

11720 
sc¡_£n£_block_out_¿nge_”rÜ
));

11721 
out
;

11723 
cmd
->
bufæ’
 = cmd->bufæ’ << 
block_shiá
;

11724 
cmd
->
d©a_Ën
 = cmd->d©a_ËÀ<< 
block_shiá
;

11725 
cmd
->
out_bufæ’
 = cmd->out_bufæ’ << 
block_shiá
;

11728 ià(
	`uÆik–y
(!(
cmd
->
Ý_æags
 & 
SCST_LBA_NOT_VALID
) &&

11729 
	`shiá_Ëá_ov”æows
(
cmd
->
lba
, 
block_shiá
))) {

11730 
	`PRINT_WARNING
("offset %llu * %u >= 2**63 for device %s (len %lld)",

11731 
cmd
->
lba
, 1 << 
block_shiá
, cmd->
dev
->
vœt_Çme
,

11732 
cmd
->
d©a_Ën
);

11733 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(

11734 
sc¡_£n£_block_out_¿nge_”rÜ
));

11735 
out
;

11738 
cmd
->
timeout
 =imeout[cmd->
Ý_æags
 & 
SCST_BOTH_TIMEOUTS
];

11739 
»s
 = 0;

11741 
out
:

11742 
	`TRACE_DBG
("» %d, bufæ’ %d, d©a_ËÀ%Îd, dœeù %d", 
»s
,

11743 
cmd
->
bufæ’
, ()cmd->
d©a_Ën
, cmd->
d©a_dœeùiÚ
);

11745 
	`TRACE_EXIT_RES
(
»s
);

11746  
»s
;

11747 
	}
}

11754 
	$sc¡_sbc_g’”ic_·r£
(
sc¡_cmd
 *
cmd
)

11756 cÚ¡ 
disk_timeout
[] = {

11757 [0] = 
SCST_GENERIC_DISK_REG_TIMEOUT
,

11758 [
SCST_SMALL_TIMEOUT
] = 
SCST_GENERIC_DISK_SMALL_TIMEOUT
,

11759 [
SCST_LONG_TIMEOUT
] = 
SCST_GENERIC_DISK_LONG_TIMEOUT
,

11760 [
SCST_BOTH_TIMEOUTS
] = 
SCST_GENERIC_DISK_LONG_TIMEOUT
,

11762 
	`BUILD_BUG_ON
(
SCST_SMALL_TIMEOUT
 != 1);

11763 
	`BUILD_BUG_ON
(
SCST_LONG_TIMEOUT
 != 2);

11764 
	`BUILD_BUG_ON
(
SCST_BOTH_TIMEOUTS
 != 3);

11766  
	`sc¡_g’”ic_·r£
(
cmd
, 
disk_timeout
);

11767 
	}
}

11768 
EXPORT_SYMBOL_GPL
(
sc¡_sbc_g’”ic_·r£
);

11775 
	$sc¡_cdrom_g’”ic_·r£
(
sc¡_cmd
 *
cmd
)

11777 cÚ¡ 
cdrom_timeout
[] = {

11778 [0] = 
SCST_GENERIC_CDROM_REG_TIMEOUT
,

11779 [
SCST_SMALL_TIMEOUT
] = 
SCST_GENERIC_CDROM_SMALL_TIMEOUT
,

11780 [
SCST_LONG_TIMEOUT
] = 
SCST_GENERIC_CDROM_LONG_TIMEOUT
,

11781 [
SCST_BOTH_TIMEOUTS
] = 
SCST_GENERIC_CDROM_LONG_TIMEOUT
,

11783 
	`BUILD_BUG_ON
(
SCST_SMALL_TIMEOUT
 != 1);

11784 
	`BUILD_BUG_ON
(
SCST_LONG_TIMEOUT
 != 2);

11785 
	`BUILD_BUG_ON
(
SCST_BOTH_TIMEOUTS
 != 3);

11787 
cmd
->
cdb
[1] &= 0x1f;

11788  
	`sc¡_g’”ic_·r£
(
cmd
, 
cdrom_timeout
);

11789 
	}
}

11790 
EXPORT_SYMBOL_GPL
(
sc¡_cdrom_g’”ic_·r£
);

11797 
	$sc¡_modisk_g’”ic_·r£
(
sc¡_cmd
 *
cmd
)

11799 cÚ¡ 
modisk_timeout
[] = {

11800 [0] = 
SCST_GENERIC_MODISK_REG_TIMEOUT
,

11801 [
SCST_SMALL_TIMEOUT
] = 
SCST_GENERIC_MODISK_SMALL_TIMEOUT
,

11802 [
SCST_LONG_TIMEOUT
] = 
SCST_GENERIC_MODISK_LONG_TIMEOUT
,

11803 [
SCST_BOTH_TIMEOUTS
] = 
SCST_GENERIC_MODISK_LONG_TIMEOUT
,

11805 
	`BUILD_BUG_ON
(
SCST_SMALL_TIMEOUT
 != 1);

11806 
	`BUILD_BUG_ON
(
SCST_LONG_TIMEOUT
 != 2);

11807 
	`BUILD_BUG_ON
(
SCST_BOTH_TIMEOUTS
 != 3);

11809 
cmd
->
cdb
[1] &= 0x1f;

11810  
	`sc¡_g’”ic_·r£
(
cmd
, 
modisk_timeout
);

11811 
	}
}

11812 
EXPORT_SYMBOL_GPL
(
sc¡_modisk_g’”ic_·r£
);

11819 
	$sc¡_³_g’”ic_·r£
(
sc¡_cmd
 *
cmd
)

11821 
»s
 = 0;

11823 
	`TRACE_ENTRY
();

11830 ià(
cmd
->
cdb
[0] =ð
READ_POSITION
) {

11831 
tþp
 = 
cmd
->
cdb
[1] & 4;

11832 
lÚg_b™
 = 
cmd
->
cdb
[1] & 2;

11833 
bt
 = 
cmd
->
cdb
[1] & 1;

11835 ià((
tþp
 =ð
lÚg_b™
è&& (!
bt
 || !long_bit)) {

11836 
cmd
->
bufæ’
 =

11837 
tþp
 ? 
POSITION_LEN_LONG
 : 
POSITION_LEN_SHORT
;

11838 
cmd
->
d©a_dœeùiÚ
 = 
SCST_DATA_READ
;

11840 
cmd
->
bufæ’
 = 0;

11841 
cmd
->
d©a_dœeùiÚ
 = 
SCST_DATA_NONE
;

11843 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

11846 ià(
cmd
->
Ý_æags
 & 
SCST_TRANSFER_LEN_TYPE_FIXED
 && cmd->
cdb
[1] & 1) {

11847 
block_size
 = 
cmd
->
dev
->block_size;

11849 
cmd
->
bufæ’
 = cmd->bufæ’ * 
block_size
;

11850 
cmd
->
d©a_Ën
 = cmd->d©a_ËÀ* 
block_size
;

11851 
cmd
->
out_bufæ’
 = cmd->out_bufæ’ * 
block_size
;

11854 ià((
cmd
->
Ý_æags
 & (
SCST_SMALL_TIMEOUT
 | 
SCST_LONG_TIMEOUT
)) == 0)

11855 
cmd
->
timeout
 = 
SCST_GENERIC_TAPE_REG_TIMEOUT
;

11856 ià(
cmd
->
Ý_æags
 & 
SCST_SMALL_TIMEOUT
)

11857 
cmd
->
timeout
 = 
SCST_GENERIC_TAPE_SMALL_TIMEOUT
;

11858 ià(
cmd
->
Ý_æags
 & 
SCST_LONG_TIMEOUT
)

11859 
cmd
->
timeout
 = 
SCST_GENERIC_TAPE_LONG_TIMEOUT
;

11861 
	`TRACE_EXIT_RES
(
»s
);

11862  
»s
;

11863 
	}
}

11864 
EXPORT_SYMBOL_GPL
(
sc¡_³_g’”ic_·r£
);

11866 
	$sc¡_nuÎ_·r£
(
sc¡_cmd
 *
cmd
)

11868 
»s
 = 0;

11870 
	`TRACE_ENTRY
();

11878 
cmd
->
cdb
[0]) {

11885 
	`TRACE_DBG
("res %d bufflen %d direct %d",

11886 
»s
, 
cmd
->
bufæ’
, cmd->
d©a_dœeùiÚ
);

11888 
	`TRACE_EXIT
();

11889  
»s
;

11890 
	}
}

11897 
	$sc¡_chªg”_g’”ic_·r£
(
sc¡_cmd
 *
cmd
)

11899 
»s
 = 
	`sc¡_nuÎ_·r£
(
cmd
);

11901 ià(
cmd
->
Ý_æags
 & 
SCST_LONG_TIMEOUT
)

11902 
cmd
->
timeout
 = 
SCST_GENERIC_CHANGER_LONG_TIMEOUT
;

11904 
cmd
->
timeout
 = 
SCST_GENERIC_CHANGER_TIMEOUT
;

11906  
»s
;

11907 
	}
}

11908 
EXPORT_SYMBOL_GPL
(
sc¡_chªg”_g’”ic_·r£
);

11915 
	$sc¡_´oûssÜ_g’”ic_·r£
(
sc¡_cmd
 *
cmd
)

11917 
»s
 = 
	`sc¡_nuÎ_·r£
(
cmd
);

11919 ià(
cmd
->
Ý_æags
 & 
SCST_LONG_TIMEOUT
)

11920 
cmd
->
timeout
 = 
SCST_GENERIC_PROCESSOR_LONG_TIMEOUT
;

11922 
cmd
->
timeout
 = 
SCST_GENERIC_PROCESSOR_TIMEOUT
;

11924  
»s
;

11925 
	}
}

11926 
EXPORT_SYMBOL_GPL
(
sc¡_´oûssÜ_g’”ic_·r£
);

11933 
	$sc¡_¿id_g’”ic_·r£
(
sc¡_cmd
 *
cmd
)

11935 
»s
 = 
	`sc¡_nuÎ_·r£
(
cmd
);

11937 ià(
cmd
->
Ý_æags
 & 
SCST_LONG_TIMEOUT
)

11938 
cmd
->
timeout
 = 
SCST_GENERIC_RAID_LONG_TIMEOUT
;

11940 
cmd
->
timeout
 = 
SCST_GENERIC_RAID_TIMEOUT
;

11942  
»s
;

11943 
	}
}

11944 
EXPORT_SYMBOL_GPL
(
sc¡_¿id_g’”ic_·r£
);

11946 
	$sc¡_do_š‹º®_·rsšg
(
sc¡_cmd
 *
cmd
)

11948 
»s
, 
rc
;

11950 
	`TRACE_ENTRY
();

11952 
cmd
->
dev
->
ty³
) {

11953 
TYPE_DISK
:

11954 
rc
 = 
	`sc¡_sbc_g’”ic_·r£
(
cmd
);

11956 
TYPE_TAPE
:

11957 
rc
 = 
	`sc¡_³_g’”ic_·r£
(
cmd
);

11959 
TYPE_PROCESSOR
:

11960 
rc
 = 
	`sc¡_´oûssÜ_g’”ic_·r£
(
cmd
);

11962 
TYPE_ROM
:

11963 
rc
 = 
	`sc¡_cdrom_g’”ic_·r£
(
cmd
);

11965 
TYPE_MOD
:

11966 
rc
 = 
	`sc¡_modisk_g’”ic_·r£
(
cmd
);

11968 
TYPE_MEDIUM_CHANGER
:

11969 
rc
 = 
	`sc¡_chªg”_g’”ic_·r£
(
cmd
);

11971 
TYPE_RAID
:

11972 
rc
 = 
	`sc¡_¿id_g’”ic_·r£
(
cmd
);

11975 
	`PRINT_ERROR
("Internal…arse forype %d‚ot supported",

11976 
cmd
->
dev
->
ty³
);

11977 
out_hw_”r
;

11980 ià(
rc
 != 0)

11981 
out_abn
;

11983 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

11985 
out
:

11986 
	`TRACE_EXIT
();

11987  
»s
;

11989 
out_hw_”r
:

11990 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

11992 
out_abn
:

11993 
»s
 = 
	`sc¡_g‘_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

11994 
out
;

11995 
	}
}

12008 
sc¡_block_g’”ic_dev_dÚe
(
sc¡_cmd
 *
cmd
,

12009 (*
£t_block_shiá
)(
sc¡_cmd
 *
cmd
, 
block_shiá
))

12011 
Ýcode
 = 
cmd
->
cdb
[0];

12012 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

12014 
	`TRACE_ENTRY
();

12022 ià(
	`uÆik–y
(
Ýcode
 =ð
READ_CAPACITY
)) {

12023 ià(
	`sc¡_cmd_com¶‘ed_good
(
cmd
)) {

12025 
bufãr_size
, 
£ùÜ_size
, 
sh
;

12026 
ušt8_t
 *
bufãr
;

12028 
bufãr_size
 = 
	`sc¡_g‘_buf_fuÎ
(
cmd
, &
bufãr
);

12029 ià(
	`uÆik–y
(
bufãr_size
 <= 0)) {

12030 ià(
bufãr_size
 < 0) {

12031 
	`PRINT_ERROR
("%s: Unableo get cmd "

12032 "bufã¸(%d)", 
__func__
,

12033 
bufãr_size
);

12035 
out
;

12038 
£ùÜ_size
 = 
	`g‘_uÇligÃd_be32
(&
bufãr
[4]);

12039 
	`sc¡_put_buf_fuÎ
(
cmd
, 
bufãr
);

12040 ià(
£ùÜ_size
 != 0)

12041 
sh
 = 
	`sc¡_ÿlc_block_shiá
(
£ùÜ_size
);

12043 
sh
 = 0;

12044 
	`£t_block_shiá
(
cmd
, 
sh
);

12045 
	`TRACE_DBG
("block_shiá %d", 
sh
);

12051 
	`TRACE_DBG
("cmd->is_send_status=%x, cmd->resp_data_len=%d, "

12052 "»s=%d", 
cmd
->
is_£nd_¡©us
, cmd->
»¥_d©a_Ën
, 
»s
);

12054 
out
:

12055 
	`TRACE_EXIT_RES
(
»s
);

12056  
»s
;

12057 
	}
}

12058 
EXPORT_SYMBOL_GPL
(
sc¡_block_g’”ic_dev_dÚe
);

12065 
sc¡_³_g’”ic_dev_dÚe
(
sc¡_cmd
 *
cmd
,

12066 (*
£t_block_size
)(
sc¡_cmd
 *
cmd
, 
block_shiá
))

12068 
Ýcode
 = 
cmd
->
cdb
[0];

12069 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

12070 
bufãr_size
, 
bs
;

12071 
ušt8_t
 *
bufãr
 = 
NULL
;

12073 
	`TRACE_ENTRY
();

12081 ià(
	`uÆik–y
(!
	`sc¡_cmd_com¶‘ed_good
(
cmd
)))

12082 
out
;

12084 
Ýcode
) {

12085 
MODE_SENSE
:

12086 
MODE_SELECT
:

12087 
bufãr_size
 = 
	`sc¡_g‘_buf_fuÎ
(
cmd
, &
bufãr
);

12088 ià(
	`uÆik–y
(
bufãr_size
 <= 0)) {

12089 ià(
bufãr_size
 < 0) {

12090 
	`PRINT_ERROR
("%s: Unableo gethe buffer (%d)",

12091 
__func__
, 
bufãr_size
);

12093 
out
;

12098 
Ýcode
) {

12099 
MODE_SENSE
:

12100 
	`TRACE_DBG
("%s", "MODE_SENSE");

12101 ià((
cmd
->
cdb
[2] & 0xC0) == 0) {

12102 ià(
bufãr
[3] == 8) {

12103 
bs
 = 
	`g‘_uÇligÃd_be24
(&
bufãr
[9]);

12104 
	`£t_block_size
(
cmd
, 
bs
);

12108 
MODE_SELECT
:

12109 
	`TRACE_DBG
("%s", "MODE_SELECT");

12110 ià(
bufãr
[3] == 8) {

12111 
bs
 = 
	`g‘_uÇligÃd_be24
(&
bufãr
[9]);

12112 
	`£t_block_size
(
cmd
, 
bs
);

12120 
Ýcode
) {

12121 
MODE_SENSE
:

12122 
MODE_SELECT
:

12123 
	`sc¡_put_buf_fuÎ
(
cmd
, 
bufãr
);

12127 
out
:

12128 
	`TRACE_EXIT_RES
(
»s
);

12129  
»s
;

12130 
	}
}

12131 
EXPORT_SYMBOL_GPL
(
sc¡_³_g’”ic_dev_dÚe
);

12133 (*
	tsc¡_£t_cdb_lba_â_t
)(
	tsc¡_cmd
 *
	tcmd
, 
	tšt64_t
 
	tlba
);

12135 
	$sc¡_£t_cdb_lba1
(
sc¡_cmd
 *
cmd
, 
št64_t
 
lba
)

12137 
	`TRACE_ENTRY
();

12139 
cmd
->
cdb
[cmd->
lba_off
] = 
lba
;

12141 
	`TRACE_EXIT
();

12143 
	}
}

12145 
	$sc¡_£t_cdb_lba2
(
sc¡_cmd
 *
cmd
, 
št64_t
 
lba
)

12147 
	`TRACE_ENTRY
();

12149 
	`put_uÇligÃd_be16
(
lba
, &
cmd
->
cdb
[cmd->
lba_off
]);

12151 
	`TRACE_EXIT
();

12153 
	}
}

12155 
	$sc¡_£t_cdb_lba3
(
sc¡_cmd
 *
cmd
, 
št64_t
 
lba
)

12157 
	`TRACE_ENTRY
();

12159 
	`put_uÇligÃd_be24
(
lba
, &
cmd
->
cdb
[cmd->
lba_off
]);

12161 
	`TRACE_EXIT
();

12163 
	}
}

12165 
	$sc¡_£t_cdb_lba4
(
sc¡_cmd
 *
cmd
, 
št64_t
 
lba
)

12167 
	`TRACE_ENTRY
();

12169 
	`put_uÇligÃd_be32
(
lba
, &
cmd
->
cdb
[cmd->
lba_off
]);

12171 
	`TRACE_EXIT
();

12173 
	}
}

12175 
	$sc¡_£t_cdb_lba8
(
sc¡_cmd
 *
cmd
, 
št64_t
 
lba
)

12177 
	`TRACE_ENTRY
();

12179 
	`put_uÇligÃd_be64
(
lba
, &
cmd
->
cdb
[cmd->
lba_off
]);

12181 
	`TRACE_EXIT
();

12183 
	}
}

12185 cÚ¡ 
sc¡_£t_cdb_lba_â_t
 
	gsc¡_£t_cdb_lba_âs
[9] = {

12186 [1] = 
sc¡_£t_cdb_lba1
,

12187 [2] = 
sc¡_£t_cdb_lba2
,

12188 [3] = 
sc¡_£t_cdb_lba3
,

12189 [4] = 
sc¡_£t_cdb_lba4
,

12190 [8] = 
sc¡_£t_cdb_lba8
,

12193 
	$sc¡_£t_cdb_lba
(
sc¡_cmd
 *
cmd
, 
št64_t
 
lba
)

12195 
»s
;

12197 
	`TRACE_ENTRY
();

12199 
	`EXTRACHECKS_BUG_ON
(
cmd
->
Ý_æags
 & 
SCST_LBA_NOT_VALID
);

12201 
sc¡_£t_cdb_lba_âs
[
cmd
->
lba_Ën
](cmd, 
lba
);

12202 
»s
 = 0;

12204 
	`TRACE_DBG
("cmd %p,‚ew LBA %Îd", 
cmd
, ()
lba
);

12206 
	`TRACE_EXIT_RES
(
»s
);

12207  
»s
;

12208 
	}
}

12209 
EXPORT_SYMBOL_GPL
(
sc¡_£t_cdb_lba
);

12211 (*
	tsc¡_£t_cdb_Œªsf_Ën_â_t
)(
	tsc¡_cmd
 *
	tcmd
, 
	tËn
);

12213 
	$sc¡_£t_cdb_Œªsf_Ën1
(
sc¡_cmd
 *
cmd
, 
Ën
)

12215 
	`TRACE_ENTRY
();

12217 
cmd
->
cdb
[cmd->
Ën_off
] = 
Ën
;

12219 
	`TRACE_EXIT
();

12221 
	}
}

12223 
	$sc¡_£t_cdb_Œªsf_Ën2
(
sc¡_cmd
 *
cmd
, 
Ën
)

12225 
	`TRACE_ENTRY
();

12227 
	`put_uÇligÃd_be16
(
Ën
, &
cmd
->
cdb
[cmd->
Ën_off
]);

12229 
	`TRACE_EXIT
();

12231 
	}
}

12233 
	$sc¡_£t_cdb_Œªsf_Ën3
(
sc¡_cmd
 *
cmd
, 
Ën
)

12235 
	`TRACE_ENTRY
();

12237 
	`put_uÇligÃd_be24
(
Ën
, &
cmd
->
cdb
[cmd->
Ën_off
]);

12239 
	`TRACE_EXIT
();

12241 
	}
}

12243 
	$sc¡_£t_cdb_Œªsf_Ën4
(
sc¡_cmd
 *
cmd
, 
Ën
)

12245 
	`TRACE_ENTRY
();

12247 
	`put_uÇligÃd_be32
(
Ën
, &
cmd
->
cdb
[cmd->
Ën_off
]);

12249 
	`TRACE_EXIT
();

12251 
	}
}

12253 
	$sc¡_£t_cdb_Œªsf_Ën8
(
sc¡_cmd
 *
cmd
, 
Ën
)

12255 
	`TRACE_ENTRY
();

12257 
	`put_uÇligÃd_be64
(
Ën
, &
cmd
->
cdb
[cmd->
Ën_off
]);

12259 
	`TRACE_EXIT
();

12261 
	}
}

12263 cÚ¡ 
sc¡_£t_cdb_Œªsf_Ën_â_t
 
	gsc¡_£t_cdb_Œªsf_Ën_âs
[9] = {

12264 [1] = 
sc¡_£t_cdb_Œªsf_Ën1
,

12265 [2] = 
sc¡_£t_cdb_Œªsf_Ën2
,

12266 [3] = 
sc¡_£t_cdb_Œªsf_Ën3
,

12267 [4] = 
sc¡_£t_cdb_Œªsf_Ën4
,

12268 [8] = 
sc¡_£t_cdb_Œªsf_Ën8
,

12271 
	$sc¡_£t_cdb_Œªsf_Ën
(
sc¡_cmd
 *
cmd
, 
Ën
)

12273 
»s
;

12275 
	`TRACE_ENTRY
();

12277 
sc¡_£t_cdb_Œªsf_Ën_âs
[
cmd
->
Ën_Ën
](cmd, 
Ën
);

12278 
»s
 = 0;

12280 
	`TRACE_DBG
("cmd %p,‚ew†’ %d", 
cmd
, 
Ën
);

12282 
	`TRACE_EXIT_RES
(
»s
);

12283  
»s
;

12284 
	}
}

12285 
EXPORT_SYMBOL_GPL
(
sc¡_£t_cdb_Œªsf_Ën
);

12287 
	$sc¡_check_š‹º®_£n£
(
sc¡_deviû
 *
dev
, 
»suÉ
,

12288 
ušt8_t
 *
£n£
, 
£n£_Ën
)

12290 
	`TRACE_ENTRY
();

12292 ià(
	`ho¡_by‹
(
»suÉ
è=ð
DID_RESET
) {

12293 
¦
;

12295 
	`TRACE
(
TRACE_MGMT
, "DID_RESET„eceived for device %s, "

12296 "Œigg”šg„e£ˆUA", 
dev
->
vœt_Çme
);

12297 
¦
 = 
	`sc¡_£t_£n£
(
£n£
, 
£n£_Ën
, 
dev
->
d_£n£
,

12298 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»£t_UA
));

12299 
	`sc¡_dev_check_£t_UA
(
dev
, 
NULL
, 
£n£
, 
¦
);

12300 } ià((
	`¡©us_by‹
(
»suÉ
è=ð
CHECK_CONDITION
) &&

12301 
	`sc¡_is_ua_£n£
(
£n£
, 
£n£_Ën
))

12302 
	`sc¡_dev_check_£t_UA
(
dev
, 
NULL
, 
£n£
, 
£n£_Ën
);

12304 
	`TRACE_EXIT
();

12306 
	}
}

12314 
dma_d©a_dœeùiÚ
 
	$sc¡_to_dma_dœ
(
sc¡_dœ
)

12316 cÚ¡ 
dma_d©a_dœeùiÚ
 
Œ_tbl
[] = { 
DMA_NONE
,

12317 
DMA_TO_DEVICE
, 
DMA_FROM_DEVICE
, 
DMA_BIDIRECTIONAL
, 
DMA_NONE
 };

12319  
Œ_tbl
[
sc¡_dœ
];

12320 
	}
}

12321 
EXPORT_SYMBOL
(
sc¡_to_dma_dœ
);

12329 
dma_d©a_dœeùiÚ
 
	$sc¡_to_tgt_dma_dœ
(
sc¡_dœ
)

12331 cÚ¡ 
dma_d©a_dœeùiÚ
 
Œ_tbl
[] = { 
DMA_NONE
,

12332 
DMA_FROM_DEVICE
, 
DMA_TO_DEVICE
, 
DMA_BIDIRECTIONAL
, 
DMA_NONE
 };

12334  
Œ_tbl
[
sc¡_dœ
];

12335 
	}
}

12336 
EXPORT_SYMBOL
(
sc¡_to_tgt_dma_dœ
);

12343 
	$sc¡_´oûss_»£t
(
sc¡_deviû
 *
dev
,

12344 
sc¡_£ssiÚ
 *
Üigš©Ü
, 
sc¡_cmd
 *
exþude_cmd
,

12345 
sc¡_mgmt_cmd
 *
mcmd
, 
boÞ
 
£tUA
)

12347 
sc¡_tgt_dev
 *
tgt_dev
;

12348 
sc¡_cmd
 *
cmd
;

12350 
	`TRACE_ENTRY
();

12353 
	`sc¡_þ—r_dev_»£rv©iÚ
(
dev
);

12360 
dev
->
dev_doubË_ua_possibË
 = 1;

12362 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

12363 
dev_tgt_dev_li¡_’Œy
) {

12364 
sc¡_£ssiÚ
 *
£ss
 = 
tgt_dev
->sess;

12370 
	`¥š_lock_bh
(&
tgt_dev
->
tgt_dev_lock
);

12371 
	`sc¡_ä“_®l_UA
(
tgt_dev
);

12372 
	`mem£t
(
tgt_dev
->
tgt_dev_£n£
, 0,

12373 (
tgt_dev
->
tgt_dev_£n£
));

12374 
	`¥š_uÆock_bh
(&
tgt_dev
->
tgt_dev_lock
);

12377 
	`¥š_lock_œq
(&
£ss
->
£ss_li¡_lock
);

12379 
	`TRACE_DBG
("S—rchšg iÀ£s cmd†i¡ (£ss=%p)", 
£ss
);

12380 
	`li¡_fÜ_—ch_’Œy
(
cmd
, &
£ss
->
£ss_cmd_li¡
,

12381 
£ss_cmd_li¡_’Œy
) {

12382 ià(
cmd
 =ð
exþude_cmd
)

12384 ià((
cmd
->
tgt_dev
 ==gt_dev) ||

12385 ((
cmd
->
tgt_dev
 =ð
NULL
) &&

12386 (
cmd
->
lun
 =ð
tgt_dev
->lun))) {

12387 
	`sc¡_abÜt_cmd
(
cmd
, 
mcmd
,

12388 (
tgt_dev
->
£ss
 !ð
Üigš©Ü
), 0);

12391 
	`¥š_uÆock_œq
(&
£ss
->
£ss_li¡_lock
);

12394 ià(
£tUA
) {

12395 
ušt8_t
 
£n£_bufãr
[
SCST_STANDARD_SENSE_LEN
];

12396 
¦
 = 
	`sc¡_£t_£n£
(
£n£_bufãr
, (sense_buffer),

12397 
dev
->
d_£n£
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»£t_UA
));

12409 
	`sc¡_dev_check_£t_loÿl_UA
(
dev
, 
exþude_cmd
, 
£n£_bufãr
, 
¦
);

12412 
	`TRACE_EXIT
();

12414 
	}
}

12417 
	$sc¡_tgt_dev_d–_ä“_UA
(
sc¡_tgt_dev
 *
tgt_dev
,

12418 
sc¡_tgt_dev_UA
 *
ua
)

12420 
	`li¡_d–
(&
ua
->
UA_li¡_’Œy
);

12421 ià(
	`li¡_em±y
(&
tgt_dev
->
UA_li¡
))

12422 
	`þ—r_b™
(
SCST_TGT_DEV_UA_PENDING
, &
tgt_dev
->
tgt_dev_æags
);

12423 
	`mempoÞ_ä“
(
ua
, 
sc¡_ua_mempoÞ
);

12424 
	}
}

12427 
	$sc¡_£t_³ndšg_UA
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
buf
, *
size
)

12429 
»s
 = 0, 
i
;

12430 
sc¡_tgt_dev_UA
 *
UA_’Œy
;

12431 
boÞ
 
fœ¡
 = 
Œue
, 
glob®_uÆock
 = 
çl£
;

12432 
sc¡_£ssiÚ
 *
£ss
 = 
cmd
->sess;

12434 
	`TRACE_ENTRY
();

12442 
	`smp_rmb
();

12443 ià(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
)) {

12444 
	`TRACE_MGMT_DBG
("NÙ s‘…’dšg UA fÜ‡bÜ‹d cmd %p", 
cmd
);

12445 
»s
 = -1;

12446 
out
;

12449 
	`¥š_lock_bh
(&
cmd
->
tgt_dev
->
tgt_dev_lock
);

12451 
agaš
:

12453 ià(
	`li¡_em±y
(&
cmd
->
tgt_dev
->
UA_li¡
)) {

12454 
	`TRACE_DBG
("SCST_TGT_DEV_UA_PENDING set, but UA_listƒmpty");

12455 
»s
 = -1;

12456 
out_uÆock
;

12458 
	`TRACE_MGMT_DBG
("Setting…ending UA cmd %p (tgt_dev %p, dev %s, "

12459 "š™ŸtÜ %s)", 
cmd
, cmd->
tgt_dev
, cmd->
dev
->
vœt_Çme
,

12460 
cmd
->
£ss
->
š™ŸtÜ_Çme
);

12462 
UA_’Œy
 = 
	`li¡_fœ¡_’Œy
(&
cmd
->
tgt_dev
->
UA_li¡
, 
	`ty³of
(*UA_entry),

12463 
UA_li¡_’Œy
);

12465 
	`TRACE_DBG
("S‘tšg…’dšg UA %°tØcmd %p", 
UA_’Œy
, 
cmd
);

12467 ià(
UA_’Œy
->
glob®_UA
 && 
fœ¡
) {

12468 
	`TRACE_MGMT_DBG
("Glob® UA %°d‘eùed", 
UA_’Œy
);

12470 #ià!
	`defšed
(
__CHECKER__
)

12471 
	`¥š_uÆock_bh
(&
cmd
->
tgt_dev
->
tgt_dev_lock
);

12479 
	`loÿl_bh_di§bË
();

12481 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

12482 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

12483 
sc¡_tgt_dev
 *
tgt_dev
;

12485 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
,

12486 
£ss_tgt_dev_li¡_’Œy
) {

12488 
	`¥š_lock
(&
tgt_dev
->
tgt_dev_lock
);

12493 
fœ¡
 = 
çl£
;

12494 
glob®_uÆock
 = 
Œue
;

12495 
agaš
;

12498 ià(
buf
 =ð
NULL
) {

12499 ià(
	`sc¡_£t_cmd_”rÜ_£n£
(
cmd
, 
UA_’Œy
->
UA_£n£_bufãr
,

12500 
UA_’Œy
->
UA_v®id_£n£_Ën
) != 0)

12501 
out_uÆock
;

12503 
	`sBUG_ON
(*
size
 == 0);

12504 ià(
UA_’Œy
->
UA_v®id_£n£_Ën
 > *
size
) {

12505 
	`TRACE
(
TRACE_MINOR
, "%s: Being„eturned UAruncated "

12506 "tØsiz%d (Ãeded %d)", 
cmd
->
Ý_Çme
,

12507 *
size
, 
UA_’Œy
->
UA_v®id_£n£_Ën
);

12508 *
size
 = 
UA_’Œy
->
UA_v®id_£n£_Ën
;

12510 
	`TRACE_DBG
("R‘uºšg UA iÀbufã¸%°(siz%d)", 
buf
, *
size
);

12511 
	`memýy
(
buf
, 
UA_’Œy
->
UA_£n£_bufãr
, *
size
);

12512 *
size
 = 
UA_’Œy
->
UA_v®id_£n£_Ën
;

12515 
cmd
->
ua_ignÜe
 = 1;

12517 
	`li¡_d–
(&
UA_’Œy
->
UA_li¡_’Œy
);

12519 ià(
UA_’Œy
->
glob®_UA
) {

12520 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

12521 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

12522 
sc¡_tgt_dev
 *
tgt_dev
;

12524 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
,

12525 
£ss_tgt_dev_li¡_’Œy
) {

12526 
sc¡_tgt_dev_UA
 *
ua
;

12528 
	`li¡_fÜ_—ch_’Œy
(
ua
, &
tgt_dev
->
UA_li¡
,

12529 
UA_li¡_’Œy
) {

12530 ià(
ua
->
glob®_UA
 &&

12531 
	`memcmp
(
ua
->
UA_£n£_bufãr
,

12532 
UA_’Œy
->
UA_£n£_bufãr
,

12533 (
ua
->
UA_£n£_bufãr
)) == 0) {

12534 
	`TRACE_MGMT_DBG
("Freeing‚ot "

12536 
ua
);

12537 
	`sc¡_tgt_dev_d–_ä“_UA
(
tgt_dev
,

12538 
ua
);

12546 
	`mempoÞ_ä“
(
UA_’Œy
, 
sc¡_ua_mempoÞ
);

12548 ià(
	`li¡_em±y
(&
cmd
->
tgt_dev
->
UA_li¡
)) {

12549 
	`þ—r_b™
(
SCST_TGT_DEV_UA_PENDING
,

12550 &
cmd
->
tgt_dev
->
tgt_dev_æags
);

12553 
out_uÆock
:

12554 ià(
glob®_uÆock
) {

12555 #ià!
	`defšed
(
__CHECKER__
)

12556 
i
 = 
SESS_TGT_DEV_LIST_HASH_SIZE
-1; i >= 0; i--) {

12557 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

12558 
sc¡_tgt_dev
 *
tgt_dev
;

12560 
	`li¡_fÜ_—ch_’Œy_»v”£
(
tgt_dev
, 
h—d
,

12561 
£ss_tgt_dev_li¡_’Œy
) {

12562 
	`¥š_uÆock
(&
tgt_dev
->
tgt_dev_lock
);

12566 
	`loÿl_bh_’abË
();

12567 
	`¥š_lock_bh
(&
cmd
->
tgt_dev
->
tgt_dev_lock
);

12571 
	`¥š_uÆock_bh
(&
cmd
->
tgt_dev
->
tgt_dev_lock
);

12573 
out
:

12574 
	`TRACE_EXIT_RES
(
»s
);

12575  
»s
;

12576 
	}
}

12582 
	$sc¡_®loc_£t_UA
(
sc¡_tgt_dev
 *
tgt_dev
,

12583 cÚ¡ 
ušt8_t
 *
£n£
, 
£n£_Ën
, 
æags
)

12585 
sc¡_tgt_dev_UA
 *
UA_’Œy
 = 
NULL
;

12587 
	`TRACE_ENTRY
();

12589 
UA_’Œy
 = 
	`mempoÞ_®loc
(
sc¡_ua_mempoÞ
, 
GFP_ATOMIC
);

12590 ià(
UA_’Œy
 =ð
NULL
) {

12591 
	`PRINT_CRIT_ERROR
("%s", "UNIT ATTENTION memory "

12594 
	`PRINT_BUFFER
("Lo¡ UA", 
£n£
, 
£n£_Ën
);

12595 
out
;

12597 
	`mem£t
(
UA_’Œy
, 0, (*UA_entry));

12599 
UA_’Œy
->
glob®_UA
 = (
æags
 & 
SCST_SET_UA_FLAG_GLOBAL
) != 0;

12601 
	`TRACE
(
TRACE_MGMT_DEBUG
|
TRACE_SCSI
, "Queuing‚ew %sUA %p (%x:%x:%x, "

12603 
UA_’Œy
->
glob®_UA
 ? "glob® " : "", UA_’Œy, 
£n£
[2],

12604 
£n£
[12], s’£[13], 
tgt_dev
->
dev
->
d_£n£
,gt_dev,

12605 
tgt_dev
->
dev
->
vœt_Çme
,gt_dev->
£ss
->
š™ŸtÜ_Çme
);

12606 
	`TRACE_BUFF_FLAG
(
TRACE_DEBUG
, "UA s’£", 
£n£
, 
£n£_Ën
);

12608 ià(
£n£_Ën
 > ()(
UA_’Œy
->
UA_£n£_bufãr
)) {

12609 
	`PRINT_WARNING
("Senseruncated (needed %d), shall you increase "

12610 "SCST_SENSE_BUFFERSIZE?", 
£n£_Ën
);

12611 
£n£_Ën
 = (
UA_’Œy
->
UA_£n£_bufãr
);

12613 
	`memýy
(
UA_’Œy
->
UA_£n£_bufãr
, 
£n£
, 
£n£_Ën
);

12614 
UA_’Œy
->
UA_v®id_£n£_Ën
 = 
£n£_Ën
;

12616 
	`£t_b™
(
SCST_TGT_DEV_UA_PENDING
, &
tgt_dev
->
tgt_dev_æags
);

12618 ià(
æags
 & 
SCST_SET_UA_FLAG_AT_HEAD
)

12619 
	`li¡_add
(&
UA_’Œy
->
UA_li¡_’Œy
, &
tgt_dev
->
UA_li¡
);

12621 
	`li¡_add_ž
(&
UA_’Œy
->
UA_li¡_’Œy
, &
tgt_dev
->
UA_li¡
);

12623 
out
:

12624 
	`TRACE_EXIT
();

12626 
	}
}

12629 
	$__sc¡_check_£t_UA
(
sc¡_tgt_dev
 *
tgt_dev
,

12630 cÚ¡ 
ušt8_t
 *
£n£
, 
£n£_Ën
, 
æags
)

12632 
sk_UA
 = 0;

12633 
sc¡_tgt_dev_UA
 *
UA_’Œy_tmp
;

12634 
Ën
 = 
	`mš_t
(, (
UA_’Œy_tmp
->
UA_£n£_bufãr
), 
£n£_Ën
);

12636 
	`TRACE_ENTRY
();

12638 
	`li¡_fÜ_—ch_’Œy
(
UA_’Œy_tmp
, &
tgt_dev
->
UA_li¡
,

12639 
UA_li¡_’Œy
) {

12640 ià(
	`memcmp
(
£n£
, 
UA_’Œy_tmp
->
UA_£n£_bufãr
, 
Ën
) == 0) {

12641 
	`TRACE_DBG
("UA‡lreadyƒxists (dev %s, "

12642 "š™ŸtÜ %s)", 
tgt_dev
->
dev
->
vœt_Çme
,

12643 
tgt_dev
->
£ss
->
š™ŸtÜ_Çme
);

12644 
sk_UA
 = 1;

12649 ià(
sk_UA
 == 0)

12650 
	`sc¡_®loc_£t_UA
(
tgt_dev
, 
£n£
, 
Ën
, 
æags
);

12652 
	`TRACE_EXIT
();

12654 
	}
}

12656 
	$sc¡_check_£t_UA
(
sc¡_tgt_dev
 *
tgt_dev
,

12657 cÚ¡ 
ušt8_t
 *
£n£
, 
£n£_Ën
, 
æags
)

12659 
	`TRACE_ENTRY
();

12661 
	`¥š_lock_bh
(&
tgt_dev
->
tgt_dev_lock
);

12662 
	`__sc¡_check_£t_UA
(
tgt_dev
, 
£n£
, 
£n£_Ën
, 
æags
);

12663 
	`¥š_uÆock_bh
(&
tgt_dev
->
tgt_dev_lock
);

12665 
	`TRACE_EXIT
();

12667 
	}
}

12670 
	$sc¡_dev_check_£t_loÿl_UA
(
sc¡_deviû
 *
dev
,

12671 
sc¡_cmd
 *
exþude
, cÚ¡ 
ušt8_t
 *
£n£
, 
£n£_Ën
)

12673 
sc¡_tgt_dev
 *
tgt_dev
, *
exþude_tgt_dev
 = 
NULL
;

12675 
	`TRACE_ENTRY
();

12677 ià(
exþude
 !ð
NULL
)

12678 
exþude_tgt_dev
 = 
exþude
->
tgt_dev
;

12680 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

12681 
dev_tgt_dev_li¡_’Œy
) {

12682 ià(
tgt_dev
 !ð
exþude_tgt_dev
)

12683 
	`sc¡_check_£t_UA
(
tgt_dev
, 
£n£
, 
£n£_Ën
, 0);

12686 
	`TRACE_EXIT
();

12688 
	}
}

12694 
boÞ
 
	$__sc¡_dev_check_£t_UA
(
sc¡_deviû
 *
dev
,

12695 
sc¡_cmd
 *
exþude
, cÚ¡ 
ušt8_t
 *
£n£
, 
£n£_Ën
)

12697 
boÞ
 
»s
 = 
çl£
;

12699 
	`TRACE_ENTRY
();

12701 
	`TRACE_MGMT_DBG
("Proûssšg UA dev %s", 
dev
->
vœt_Çme
);

12704 ià(
	`sc¡_ª®yze_£n£
(
£n£
, 
£n£_Ën
, 
SCST_SENSE_ASC_VALID
,

12705 0, 
SCST_SENSE_ASC_UA_RESET
, 0)) {

12706 
	`sc¡_´oûss_»£t
(
dev
,

12707 (
exþude
 !ð
NULL
è?ƒxþude->
£ss
 : NULL,

12708 
exþude
, 
NULL
, 
çl£
);

12709 
»s
 = 
Œue
;

12712 
	`sc¡_dev_check_£t_loÿl_UA
(
dev
, 
exþude
, 
£n£
, 
£n£_Ën
);

12714 
	`TRACE_EXIT_RES
(
»s
);

12715  
»s
;

12716 
	}
}

12718 
	$sc¡_dev_check_£t_UA
(
sc¡_deviû
 *
dev
,

12719 
sc¡_cmd
 *
exþude
, cÚ¡ 
ušt8_t
 *
£n£
, 
£n£_Ën
)

12721 
sc¡_lksb
 
lksb
;

12722 
boÞ
 
rc
;

12724 
	`sc¡_»s_lock
(
dev
, &
lksb
);

12725 
rc
 = 
	`__sc¡_dev_check_£t_UA
(
dev
, 
exþude
, 
£n£
, 
£n£_Ën
);

12726 
	`sc¡_»s_uÆock
(
dev
, &
lksb
);

12728 ià(
rc
)

12729 
	`sc¡_unblock_abÜ‹d_cmds
(
NULL
, NULL, 
dev
, 
çl£
);

12732 
	}
}

12735 
	$sc¡_ä“_®l_UA
(
sc¡_tgt_dev
 *
tgt_dev
)

12737 
sc¡_tgt_dev_UA
 *
UA_’Œy
, *
t
;

12739 
	`TRACE_ENTRY
();

12741 
	`li¡_fÜ_—ch_’Œy_§ã
(
UA_’Œy
, 
t
,

12742 &
tgt_dev
->
UA_li¡
, 
UA_li¡_’Œy
) {

12743 
	`TRACE_MGMT_DBG
("Clearing UA forgt_dev LUN %lld",

12744 ()
tgt_dev
->
lun
);

12745 
	`li¡_d–
(&
UA_’Œy
->
UA_li¡_’Œy
);

12746 
	`mempoÞ_ä“
(
UA_’Œy
, 
sc¡_ua_mempoÞ
);

12748 
	`INIT_LIST_HEAD
(&
tgt_dev
->
UA_li¡
);

12749 
	`þ—r_b™
(
SCST_TGT_DEV_UA_PENDING
, &
tgt_dev
->
tgt_dev_æags
);

12751 
	`TRACE_EXIT
();

12753 
	}
}

12759 
sc¡_cmd
 *
	$__sc¡_check_deã¼ed_commªds_locked
(

12760 
sc¡_Üd”_d©a
 *
Üd”_d©a
, 
boÞ
 
»tuº_fœ¡
)

12761 
	`__»Ëa£s
(&
Üd”_d©a
->
¢_lock
)

12762 
	`__acquœes
(&
Üd”_d©a
->
¢_lock
)

12764 
sc¡_cmd
 *
»s
 = 
NULL
, *
cmd
, *
t
;

12765 
	`ty³of
(
Üd”_d©a
->
ex³ùed_¢
)ƒxpected_sn = order_data->expected_sn;

12766 
boÞ
 
aùiv©e
 = !
»tuº_fœ¡
, 
fœ¡
 = 
Œue
, 
found
 = 
çl£
;

12768 
	`TRACE_ENTRY
();

12770 ià(
	`uÆik–y
(
Üd”_d©a
->
hq_cmd_couÁ
 != 0))

12771 
out
;

12773 
»¡¬t
:

12774 
	`li¡_fÜ_—ch_’Œy_§ã
(
cmd
, 
t
, &
Üd”_d©a
->
deã¼ed_cmd_li¡
,

12775 
deã¼ed_cmd_li¡_’Œy
) {

12776 
	`EXTRACHECKS_BUG_ON
((
cmd
->
queue_ty³
 !ð
SCST_CMD_QUEUE_SIMPLE
) &&

12777 (
cmd
->
queue_ty³
 !ð
SCST_CMD_QUEUE_ORDERED
));

12778 ià(
cmd
->
¢
 =ð
ex³ùed_¢
) {

12779 
boÞ
 
¡Ý
 = (
cmd
->
¢_¦Ù
 =ð
NULL
);

12781 
	`TRACE_SN
("Deferred command %p (sn %d, set %d) found",

12782 
cmd
, cmd->
¢
, cmd->
¢_£t
);

12784 
Üd”_d©a
->
def_cmd_couÁ
--;

12785 
	`li¡_d–
(&
cmd
->
deã¼ed_cmd_li¡_’Œy
);

12787 ià(
aùiv©e
) {

12788 
	`¥š_lock
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

12789 
	`TRACE_SN
("Addšg cmd %°tØaùivcmd†i¡", 
cmd
);

12790 
	`li¡_add_ž
(&
cmd
->
cmd_li¡_’Œy
,

12791 &
cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

12792 
	`wake_up
(&
cmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

12793 
	`¥š_uÆock
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

12796 ià(
fœ¡
) {

12797 ià(!
aùiv©e
)

12798 
»s
 = 
cmd
;

12799 ià(
¡Ý
) {

12805 
out
;

12807 
fœ¡
 = 
çl£
;

12808 
aùiv©e
 = 
Œue
;

12810 
found
 = 
Œue
;

12813 ià(
found
)

12814 
out
;

12816 
	`li¡_fÜ_—ch_’Œy
(
cmd
, &
Üd”_d©a
->
sk³d_¢_li¡
,

12817 
deã¼ed_cmd_li¡_’Œy
) {

12818 
	`EXTRACHECKS_BUG_ON
(
cmd
->
queue_ty³
 =ð
SCST_CMD_QUEUE_HEAD_OF_QUEUE
);

12819 ià(
cmd
->
¢
 =ð
ex³ùed_¢
) {

12826 
	`TRACE_SN
("cmd %p (tag %llu) with skipped sn %d found",

12827 
cmd
, ()cmd->
g
, cmd->
¢
);

12828 
Üd”_d©a
->
def_cmd_couÁ
--;

12829 
	`li¡_d–
(&
cmd
->
deã¼ed_cmd_li¡_’Œy
);

12830 
	`¥š_uÆock_œq
(&
Üd”_d©a
->
¢_lock
);

12831 
	`sc¡_šc_ex³ùed_¢
(
cmd
);

12832 ià(
	`‹¡_ªd_£t_b™
(
SCST_CMD_CAN_BE_DESTROYED
,

12833 &
cmd
->
cmd_æags
))

12834 
	`sc¡_de¡roy_cmd
(
cmd
);

12835 
ex³ùed_¢
 = 
Üd”_d©a
->expected_sn;

12836 
	`¥š_lock_œq
(&
Üd”_d©a
->
¢_lock
);

12837 
»¡¬t
;

12841 
out
:

12842 
	`TRACE_EXIT_HRES
(()
»s
);

12843  
»s
;

12844 
	}
}

12847 
sc¡_cmd
 *
	$__sc¡_check_deã¼ed_commªds
(

12848 
sc¡_Üd”_d©a
 *
Üd”_d©a
, 
boÞ
 
»tuº_fœ¡
)

12850 
sc¡_cmd
 *
»s
;

12852 
	`TRACE_ENTRY
();

12854 
	`¥š_lock_œq
(&
Üd”_d©a
->
¢_lock
);

12855 
»s
 = 
	`__sc¡_check_deã¼ed_commªds_locked
(
Üd”_d©a
, 
»tuº_fœ¡
);

12856 
	`¥š_uÆock_œq
(&
Üd”_d©a
->
¢_lock
);

12858 
	`TRACE_EXIT_HRES
(()
»s
);

12859  
»s
;

12860 
	}
}

12862 
	$sc¡_unblock_deã¼ed
(
sc¡_Üd”_d©a
 *
Üd”_d©a
,

12863 
sc¡_cmd
 *
out_of_¢_cmd
)

12865 
	`TRACE_ENTRY
();

12867 ià(!
out_of_¢_cmd
->
¢_£t
) {

12868 
	`TRACE_SN
("cmd %°w™houˆ¢", 
out_of_¢_cmd
);

12869 
out
;

12872 ià(
out_of_¢_cmd
->
¢
 =ð
Üd”_d©a
->
ex³ùed_¢
) {

12873 
	`TRACE_SN
("out of sn cmd %p (expected sn %d)",

12874 
out_of_¢_cmd
, 
Üd”_d©a
->
ex³ùed_¢
);

12875 
	`sc¡_šc_ex³ùed_¢
(
out_of_¢_cmd
);

12877 
out_of_¢_cmd
->
out_of_¢
 = 1;

12878 
	`¥š_lock_œq
(&
Üd”_d©a
->
¢_lock
);

12879 
Üd”_d©a
->
def_cmd_couÁ
++;

12880 
	`li¡_add_ž
(&
out_of_¢_cmd
->
deã¼ed_cmd_li¡_’Œy
,

12881 &
Üd”_d©a
->
sk³d_¢_li¡
);

12882 
	`TRACE_SN
("out_of_sn_cmd %p with sn %d‡ddedo skipped_sn_list"

12883 " (ex³ùed_¢ %d)", 
out_of_¢_cmd
, out_of_¢_cmd->
¢
,

12884 
Üd”_d©a
->
ex³ùed_¢
);

12885 
	`¥š_uÆock_œq
(&
Üd”_d©a
->
¢_lock
);

12892 
	`sc¡_make_deã¼ed_commªds_aùive
(
Üd”_d©a
);

12894 
out
:

12895 
	`TRACE_EXIT
();

12897 
	}
}

12900 
	$sc¡_block_dev
(
sc¡_deviû
 *
dev
)

12902 
dev
->
block_couÁ
++;

12903 
	`TRACE_BLOCK
("Deviû BLOCK (Ãw couÁ %d), dev %s", 
dev
->
block_couÁ
,

12904 
dev
->
vœt_Çme
);

12905 
	}
}

12911 
boÞ
 
	$__sc¡_check_blocked_dev
(
sc¡_cmd
 *
cmd
)

12913 
»s
 = 
çl£
;

12914 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

12916 
	`TRACE_ENTRY
();

12918 
	`EXTRACHECKS_BUG_ON
(
cmd
->
unblock_dev
);

12919 
	`EXTRACHECKS_BUG_ON
(
cmd
->
š‹º®
 && cmd->
cdb
[0] !ð
EXTENDED_COPY
);

12921 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
)))

12922 
out
;

12924 ià(
dev
->
block_couÁ
 > 0) {

12925 
	`TRACE_BLOCK
("Delaying cmd %p dueo blocking "

12926 "Ñag %Îu, o°%s, dev %s)", 
cmd
,

12927 ()
cmd
->
g
,

12928 
	`sc¡_g‘_Ýcode_Çme
(
cmd
), 
dev
->
vœt_Çme
);

12929 
out_block
;

12930 } ià((
cmd
->
Ý_æags
 & 
SCST_STRICTLY_SERIALIZED
) == SCST_STRICTLY_SERIALIZED) {

12931 
	`TRACE_BLOCK
("Strictly serialized cmd %p (tag %llu, op %s, dev %s)",

12932 
cmd
, ()cmd->
g
,

12933 
	`sc¡_g‘_Ýcode_Çme
(
cmd
), 
dev
->
vœt_Çme
);

12935 ià((
cmd
->
cdb
[0] =ð
MAINTENANCE_OUT
) &&

12936 ((
cmd
->
cdb
[1] & 0x1fè=ð
MO_SET_TARGET_PGS
)) {

12937 cÚ¡ 
sc¡_cmd
 *
c
;

12942 
c
 = 
	`li¡_fœ¡_’Œy
(&
sc¡_glob®_¡pg_li¡
, 
	`ty³of
(*c),

12943 
glob®_¡pg_li¡_’Œy
);

12944 ià(
cmd
 !ð
c
) {

12945 
	`TRACE_BLOCK
("Blocking serialized STPG cmd %p "

12946 "(h—d %p)", 
cmd
, 
c
);

12947 
cmd
->
cmd_glob®_¡pg_blocked
 = 1;

12948 
out_block
;

12952 
	`sc¡_block_dev
(
dev
);

12953 ià(
dev
->
Ú_dev_cmd_couÁ
 > 1) {

12954 
	`TRACE_BLOCK
("Delaying strictly serialized cmd %p "

12955 "(dev %s, on_dev_cmd tØwa™ %d)", 
cmd
,

12956 
dev
->
vœt_Çme
, dev->
Ú_dev_cmd_couÁ
-1);

12957 
	`EXTRACHECKS_BUG_ON
(
dev
->
¡riùly_£rŸlized_cmd_wa™šg
);

12958 
dev
->
¡riùly_£rŸlized_cmd_wa™šg
 = 1;

12959 
out_block
;

12961 
cmd
->
unblock_dev
 = 1;

12962 } ià((
dev
->
dev_doubË_ua_possibË
) ||

12963 ((
cmd
->
Ý_æags
 & 
SCST_SERIALIZED
) != 0)) {

12964 
	`TRACE_BLOCK
("cmd %p (tag %llu, op %s): blocking further cmds "

12965 "Ú dev % dutØ%s", 
cmd
, ()cmd->
g
,

12966 
	`sc¡_g‘_Ýcode_Çme
(
cmd
), 
dev
->
vœt_Çme
,

12967 
dev
->
dev_doubË_ua_possibË
 ? "possible double„eset UA" :

12969 
	`sc¡_block_dev
(
dev
);

12970 
cmd
->
unblock_dev
 = 1;

12972 
	`TRACE_BLOCK
("NØblock fÜ deviû %s", 
dev
->
vœt_Çme
);

12974 
out
:

12975 
	`TRACE_EXIT_RES
(
»s
);

12976  
»s
;

12978 
out_block
:

12979 ià(
cmd
->
queue_ty³
 =ð
SCST_CMD_QUEUE_HEAD_OF_QUEUE
)

12980 
	`li¡_add
(&
cmd
->
blocked_cmd_li¡_’Œy
,

12981 &
dev
->
blocked_cmd_li¡
);

12983 
	`li¡_add_ž
(&
cmd
->
blocked_cmd_li¡_’Œy
,

12984 &
dev
->
blocked_cmd_li¡
);

12985 
»s
 = 
Œue
;

12986 
out
;

12987 
	}
}

12990 
	$sc¡_unblock_dev
(
sc¡_deviû
 *
dev
)

12992 
	`TRACE_ENTRY
();

12994 
	`TRACE_BLOCK
("Device UNBLOCK (new %d), dev %s",

12995 
dev
->
block_couÁ
-1, dev->
vœt_Çme
);

12997 ià(--
dev
->
block_couÁ
 == 0) {

12998 
sc¡_cmd
 *
cmd
, *
tcmd
;

12999 
æags
;

13001 
	`loÿl_œq_§ve_nÜt
(
æags
);

13002 
	`li¡_fÜ_—ch_’Œy_§ã
(
cmd
, 
tcmd
, &
dev
->
blocked_cmd_li¡
,

13003 
blocked_cmd_li¡_’Œy
) {

13004 
boÞ
 
¡riùly_£rŸlized
 =

13005 ((
cmd
->
Ý_æags
 & 
SCST_STRICTLY_SERIALIZED
) == SCST_STRICTLY_SERIALIZED);

13007 ià(
dev
->
¡riùly_£rŸlized_cmd_wa™šg
 &&

13008 !
¡riùly_£rŸlized
)

13011 
	`li¡_d–
(&
cmd
->
blocked_cmd_li¡_’Œy
);

13012 
cmd
->
cmd_glob®_¡pg_blocked
 = 0;

13014 
	`TRACE_BLOCK
("Addšg blocked cmd %°tØaùivcmd†i¡", 
cmd
);

13015 
	`¥š_lock
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

13016 ià(
cmd
->
queue_ty³
 =ð
SCST_CMD_QUEUE_HEAD_OF_QUEUE
)

13017 
	`li¡_add
(&
cmd
->
cmd_li¡_’Œy
,

13018 &
cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

13020 
	`li¡_add_ž
(&
cmd
->
cmd_li¡_’Œy
,

13021 &
cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

13022 
	`wake_up
(&
cmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

13023 
	`¥š_uÆock
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

13025 ià(
dev
->
¡riùly_£rŸlized_cmd_wa™šg
 && 
¡riùly_£rŸlized
)

13028 
	`loÿl_œq_»¡Üe_nÜt
(
æags
);

13031 
	`sBUG_ON
(
dev
->
block_couÁ
 < 0);

13033 
	`TRACE_EXIT
();

13035 
	}
}

13049 
	$sc¡_obš_deviû_·¿m‘”s
(
sc¡_deviû
 *
dev
,

13050 cÚ¡ 
ušt8_t
 *
mode_£Ëù_cdb
)

13052 
rc
, 
i
;

13053 
ušt8_t
 
cmd
[16];

13054 
ušt8_t
 
bufãr
[4+0x0A];

13055 
ušt8_t
 
£n£_bufãr
[
SCSI_SENSE_BUFFERSIZE
];

13057 
	`TRACE_ENTRY
();

13059 
	`EXTRACHECKS_BUG_ON
(
dev
->
scsi_dev
 =ð
NULL
);

13061 ià(
mode_£Ëù_cdb
 !ð
NULL
) {

13062 ià((
mode_£Ëù_cdb
[2] & 0x3F) != 0x0A) {

13063 
	`TRACE_DBG
("Not control mode…age (%x) change„equested, "

13064 "skpšg", 
mode_£Ëù_cdb
[2] & 0x3F);

13065 
out
;

13069 
i
 = 0; i < 5; i++) {

13071 
	`mem£t
(
cmd
, 0, (cmd));

13073 
cmd
[0] = 
MODE_SENSE_10
;

13074 
cmd
[1] = 0;

13075 
cmd
[2] = 0x0A;

13076 
cmd
[8] = (
bufãr
);

13078 
cmd
[0] = 
MODE_SENSE
;

13079 
cmd
[1] = 8;

13080 
cmd
[2] = 0x0A;

13081 
cmd
[4] = (
bufãr
);

13084 
	`mem£t
(
bufãr
, 0, (buffer));

13085 
	`mem£t
(
£n£_bufãr
, 0, (sense_buffer));

13087 
	`TRACE
(
TRACE_SCSI
, "%s", "Doing internal MODE_SENSE");

13088 
rc
 = 
	`scsi_execu‹
(
dev
->
scsi_dev
, 
cmd
, 
SCST_DATA_READ
, 
bufãr
,

13089 (
bufãr
), 
£n£_bufãr
, 15, 0, 0

13090 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2,6,29)

13091 , 
NULL


13095 
	`TRACE_DBG
("MODE_SENSE dÚe: %x", 
rc
);

13097 ià(
	`scsi_¡©us_is_good
(
rc
)) {

13098 
q
;

13100 
	`PRINT_BUFF_FLAG
(
TRACE_SCSI
, "Returned control mode "

13101 "·gd©a", 
bufãr
, (buffer));

13103 
dev
->
t¡
 = 
bufãr
[4+2] >> 5;

13104 
dev
->
tmf_Úly
 = (
bufãr
[4+2] & 0x10) >> 4;

13105 
dev
->
dpicz
 = (
bufãr
[4+2] & 0x8) >> 3;

13106 
q
 = 
bufãr
[4+3] >> 4;

13107 ià(
q
 > 
SCST_QUEUE_ALG_1_UNRESTRICTED_REORDER
) {

13108 
	`PRINT_ERROR
("Too big QUEUE ALG %x, dev %s, "

13110 
dev
->
queue_®g
, dev->
vœt_Çme
);

13111 
q
 = 
SCST_QUEUE_ALG_1_UNRESTRICTED_REORDER
;

13113 
dev
->
queue_®g
 = 
q
;

13114 
dev
->
q”r
 = (
bufãr
[4+3] & 0x6) >> 1;

13115 
dev
->
swp
 = (
bufãr
[4+4] & 0x8) >> 3;

13116 
dev
->
s
 = (
bufãr
[4+5] & 0x40) >> 6;

13117 
dev
->
d_£n£
 = (
bufãr
[4+2] & 0x4) >> 2;

13125 
dev
->
has_own_Üd”_mgmt
 = !dev->
queue_®g
;

13127 
	`PRINT_INFO
("Device %s: TST %x, TMF_ONLY %x, QUEUE ALG %x, "

13129 "has_own_Üd”_mgmˆ%d", 
dev
->
vœt_Çme
,

13130 
dev
->
t¡
, dev->
tmf_Úly
, dev->
queue_®g
,

13131 
dev
->
q”r
, dev->
swp
, dev->
s
, dev->
d_£n£
,

13132 
dev
->
dpicz
, dev->
has_own_Üd”_mgmt
);

13134 
out
;

13136 
	`sc¡_check_š‹º®_£n£
(
dev
, 
rc
, 
£n£_bufãr
,

13137 (
£n£_bufãr
));

13139 ià((
	`¡©us_by‹
(
rc
è=ð
CHECK_CONDITION
) &&

13140 
	`sc¡_£n£_v®id
(
£n£_bufãr
)) {

13146 ià(
	`sc¡_£n£_v®id
(
£n£_bufãr
)) {

13148 
	`PRINT_BUFF_FLAG
(
TRACE_SCSI
, "MODE SENSE„eturned "

13149 "£n£", 
£n£_bufãr
, (sense_buffer));

13150 ià(
	`sc¡_ª®yze_£n£
(
£n£_bufãr
,

13151 (
£n£_bufãr
),

13152 
SCST_SENSE_KEY_VALID
,

13153 
ILLEGAL_REQUEST
, 0, 0)) {

13154 
	`PRINT_INFO
("Device %s doesn't support "

13156 
dev
->
vœt_Çme
);

13158 } ià(
	`sc¡_ª®yze_£n£
(
£n£_bufãr
,

13159 (
£n£_bufãr
),

13160 
SCST_SENSE_KEY_VALID
,

13161 
NOT_READY
, 0, 0)) {

13162 
	`PRINT_ERROR
("Device %s‚ot„eady",

13163 
dev
->
vœt_Çme
);

13167 
	`PRINT_INFO
("Internal MODE SENSEo "

13169 
dev
->
vœt_Çme
, 
rc
);

13170 
	`ho¡_by‹
(
rc
)) {

13171 
DID_RESET
:

13172 
DID_ABORT
:

13173 
DID_SOFT_ERROR
:

13176 
brk
;

13178 
	`driv”_by‹
(
rc
)) {

13179 
DRIVER_BUSY
:

13180 
DRIVER_SOFT
:

13183 
brk
;

13188 
brk
:

13189 
	`PRINT_WARNING
("Unableo get device's %s control mode…age, using "

13192 "has_own_Üd”_mgmˆ%d", 
dev
->
vœt_Çme
, dev->
t¡
,

13193 
dev
->
tmf_Úly
, dev->
queue_®g
, dev->
q”r
, dev->
swp
, dev->
s
,

13194 
dev
->
d_£n£
, dev->
dpicz
, dev->
has_own_Üd”_mgmt
);

13196 
out
:

13197 
	`TRACE_EXIT
();

13199 
	}
}

13200 
EXPORT_SYMBOL_GPL
(
sc¡_obš_deviû_·¿m‘”s
);

13202 
	$sc¡_Ú_hq_cmd_»¥Ú£
(
sc¡_cmd
 *
cmd
)

13204 
sc¡_Üd”_d©a
 *
Üd”_d©a
 = 
cmd
->
cur_Üd”_d©a
;

13206 
	`TRACE_ENTRY
();

13208 ià(!
cmd
->
hq_cmd_šûd
)

13209 
out
;

13211 
	`¥š_lock_œq
(&
Üd”_d©a
->
¢_lock
);

13212 
Üd”_d©a
->
hq_cmd_couÁ
--;

13213 
	`¥š_uÆock_œq
(&
Üd”_d©a
->
¢_lock
);

13215 
	`EXTRACHECKS_BUG_ON
(
Üd”_d©a
->
hq_cmd_couÁ
 < 0);

13222 ià(
Üd”_d©a
->
hq_cmd_couÁ
 == 0)

13223 
	`sc¡_make_deã¼ed_commªds_aùive
(
Üd”_d©a
);

13225 
out
:

13226 
	`TRACE_EXIT
();

13228 
	}
}

13230 
	$sc¡_¡Üe_£n£
(
sc¡_cmd
 *
cmd
)

13232 
	`TRACE_ENTRY
();

13234 ià(
	`sc¡_£n£_v®id
(
cmd
->
£n£
) &&

13235 !
	`‹¡_b™
(
SCST_CMD_NO_RESP
, &
cmd
->
cmd_æags
) &&

13236 (
cmd
->
tgt_dev
 !ð
NULL
)) {

13237 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

13239 
	`TRACE_DBG
("StÜšg s’£ (cmd %p)", 
cmd
);

13241 
	`¥š_lock_bh
(&
tgt_dev
->
tgt_dev_lock
);

13243 ià(
cmd
->
£n£_v®id_Ën
 <ð(
tgt_dev
->
tgt_dev_£n£
))

13244 
tgt_dev
->
tgt_dev_v®id_£n£_Ën
 = 
cmd
->
£n£_v®id_Ën
;

13246 
tgt_dev
->
tgt_dev_v®id_£n£_Ën
 = Ñgt_dev->
tgt_dev_£n£
);

13247 
	`PRINT_ERROR
("Stored senseruncatedo size %d "

13248 "Ò“ded %d)", 
tgt_dev
->
tgt_dev_v®id_£n£_Ën
,

13249 
cmd
->
£n£_v®id_Ën
);

13251 
	`memýy
(
tgt_dev
->
tgt_dev_£n£
, 
cmd
->
£n£
,

13252 
tgt_dev
->
tgt_dev_v®id_£n£_Ën
);

13254 
	`¥š_uÆock_bh
(&
tgt_dev
->
tgt_dev_lock
);

13257 
	`TRACE_EXIT
();

13259 
	}
}

13262 
	$sc¡_abÜt_cmds_tgt_dev
(
sc¡_tgt_dev
 *
tgt_dev
,

13263 
sc¡_cmd
 *
exþude_cmd
)

13265 
sc¡_£ssiÚ
 *
£ss
 = 
tgt_dev
->sess;

13266 
sc¡_cmd
 *
cmd
;

13268 
	`TRACE_ENTRY
();

13270 
	`TRACE_MGMT_DBG
("QErr:‡borting commands forgt_dev %p "

13271 "Óxþude_cmd %p), iàth”¬ªy", 
tgt_dev
, 
exþude_cmd
);

13273 
	`¥š_lock_œq
(&
£ss
->
£ss_li¡_lock
);

13275 
	`li¡_fÜ_—ch_’Œy
(
cmd
, &
£ss
->
£ss_cmd_li¡
, 
£ss_cmd_li¡_’Œy
) {

13276 ià(
cmd
 =ð
exþude_cmd
)

13278 ià((
cmd
->
tgt_dev
 ==gt_dev) ||

13279 ((
cmd
->
tgt_dev
 =ð
NULL
) &&

13280 (
cmd
->
lun
 =ð
tgt_dev
->lun))) {

13281 
	`sc¡_abÜt_cmd
(
cmd
, 
NULL
, (
tgt_dev
 !ð
exþude_cmd
->tgt_dev), 0);

13284 
	`¥š_uÆock_œq
(&
£ss
->
£ss_li¡_lock
);

13286 
	`TRACE_EXIT
();

13288 
	}
}

13291 
	$sc¡_abÜt_cmds_dev
(
sc¡_deviû
 *
dev
,

13292 
sc¡_cmd
 *
exþude_cmd
)

13294 
sc¡_tgt_dev
 *
tgt_dev
;

13295 
ušt8_t
 
£n£_bufãr
[
SCST_STANDARD_SENSE_LEN
];

13296 
¦
 = 0;

13297 
boÞ
 
£t_ua
 = (
dev
->
s
 == 0);

13299 
	`TRACE_ENTRY
();

13301 
	`TRACE_MGMT_DBG
("QErr: Aborting commands for dev %p (exclude_cmd %p, "

13302 "£t_u¨%d), iàth”¬ªy", 
dev
, 
exþude_cmd
, 
£t_ua
);

13304 ià(
£t_ua
)

13305 
¦
 = 
	`sc¡_£t_£n£
(
£n£_bufãr
, (£n£_bufãr), 
dev
->
d_£n£
,

13306 
	`SCST_LOAD_SENSE
(
sc¡_£n£_þ—»d_by_ªÙh”_ši_UA
));

13308 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
, 
dev_tgt_dev_li¡_’Œy
) {

13309 
	`sc¡_abÜt_cmds_tgt_dev
(
tgt_dev
, 
exþude_cmd
);

13321 ià(
£t_ua
 && (
tgt_dev
 !ð
exþude_cmd
->tgt_dev))

13322 
	`sc¡_check_£t_UA
(
tgt_dev
, 
£n£_bufãr
, 
¦
, 0);

13325 
	`TRACE_EXIT
();

13327 
	}
}

13330 
	$sc¡_´oûss_q”r
(
sc¡_cmd
 *
cmd
)

13332 
boÞ
 
unblock
 = 
çl£
;

13333 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

13334 
q”r
, 
q
;

13336 
	`TRACE_ENTRY
();

13339 
q
 = 
dev
->
q”r
;

13340 
q”r
 = 
	`ACCESS_ONCE
(
q
);

13342 
	`TRACE_DBG
("Proûssšg QE¼ %d fÜ cmd %p", 
q”r
, 
cmd
);

13344 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

13346 
q”r
) {

13347 
SCST_QERR_2_RESERVED
:

13349 
	`PRINT_WARNING
("Invalid QErr value %x for device %s,…rocess‡s "

13350 "0", 
q”r
, 
dev
->
vœt_Çme
);

13352 
SCST_QERR_0_ALL_RESUME
:

13355 
SCST_QERR_1_ABORT_ALL
:

13356 ià(
dev
->
t¡
 =ð
SCST_TST_0_SINGLE_TASK_SET
)

13357 
	`sc¡_abÜt_cmds_dev
(
dev
, 
cmd
);

13359 
	`sc¡_abÜt_cmds_tgt_dev
(
cmd
->
tgt_dev
, cmd);

13360 
unblock
 = 
Œue
;

13362 
SCST_QERR_3_ABORT_THIS_NEXUS_ONLY
:

13363 
	`sc¡_abÜt_cmds_tgt_dev
(
cmd
->
tgt_dev
, cmd);

13364 
unblock
 = 
Œue
;

13368 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

13370 ià(
unblock
)

13371 
	`sc¡_unblock_abÜ‹d_cmds
(
cmd
->
tgt
, cmd->
£ss
, 
dev
, 
çl£
);

13373 
	`TRACE_EXIT
();

13375 
	}
}

13381 
	$sc¡_´oûss_check_cÚd™iÚ
(
sc¡_cmd
 *
cmd
)

13383 
»s
;

13385 
	`TRACE_ENTRY
();

13387 
	`EXTRACHECKS_BUG_ON
(
	`‹¡_b™
(
SCST_CMD_NO_RESP
, &
cmd
->
cmd_æags
));

13389 
	`TRACE_DBG
("CHECK CONDITION fÜ cmd %°Ñgt_dev %p)", 
cmd
, cmd->
tgt_dev
);

13391 
	`sc¡_´oûss_q”r
(
cmd
);

13393 
	`sc¡_¡Üe_£n£
(
cmd
);

13395 
»s
 = 0;

13397 
	`TRACE_EXIT_RES
(
»s
);

13398  
»s
;

13399 
	}
}

13401 
	$sc¡_xm™_´oûss_abÜ‹d_cmd
(
sc¡_cmd
 *
cmd
)

13403 
	`TRACE_ENTRY
();

13405 
	`TRACE_MGMT_DBG
("AbÜ‹d cmd %°dÚ(cmd_»à%d)", 
cmd
,

13406 
	`©omic_»ad
(&
cmd
->
cmd_»f
));

13408 
	`sc¡_dÚe_cmd_mgmt
(
cmd
);

13410 ià(
	`‹¡_b™
(
SCST_CMD_ABORTED_OTHER
, &
cmd
->
cmd_æags
)) {

13411 ià(
cmd
->
com¶‘ed
) {

13413 
out
;

13417 ià(
	`‹¡_b™
(
SCST_CMD_DEVICE_TAS
, &
cmd
->
cmd_æags
)) {

13418 
	`TRACE_MGMT_DBG
("Flag ABORTED OTHER set for cmd %p "

13419 "Ñag %Îu),„‘uºšg TASK ABORTED ", 
cmd
,

13420 ()
cmd
->
g
);

13421 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_TASK_ABORTED
);

13423 
	`TRACE_MGMT_DBG
("Flag ABORTED OTHER set for cmd %p "

13426 
cmd
, ()cmd->
g
);

13432 
	`þ—r_b™
(
SCST_CMD_ABORTED_OTHER
, &
cmd
->
cmd_æags
);

13436 
out
:

13437 
	`TRACE_EXIT
();

13439 
	}
}

13453 
	$sc¡_g‘_max_lun_commªds
(
sc¡_£ssiÚ
 *
£ss
, 
ušt64_t
 
lun
)

13455  
SCST_MAX_TGT_DEV_COMMANDS
;

13456 
	}
}

13457 
EXPORT_SYMBOL
(
sc¡_g‘_max_lun_commªds
);

13464 
	$sc¡_»assign_»šed_£ss_¡©es
(
sc¡_£ssiÚ
 *
Ãw_£ss
,

13465 
sc¡_£ssiÚ
 *
Þd_£ss
)

13467 
sc¡_deviû
 *
dev
;

13469 
	`TRACE_ENTRY
();

13471 
	`TRACE_MGMT_DBG
("Reassigning„etained states from old_sess %po "

13472 "Ãw_£s %p", 
Þd_£ss
, 
Ãw_£ss
);

13474 ià((
Ãw_£ss
 =ð
NULL
è|| (
Þd_£ss
 == NULL)) {

13475 
	`TRACE_DBG
("%s", "new_sess or old_sess is NULL");

13476 
out
;

13479 ià(
Ãw_£ss
 =ð
Þd_£ss
) {

13480 
	`TRACE_DBG
("%s", "new_sess or old_sess‡rehe same");

13481 
out
;

13484 ià((
Ãw_£ss
->
Œª¥Üt_id
 =ð
NULL
) ||

13485 (
Þd_£ss
->
Œª¥Üt_id
 =ð
NULL
)) {

13486 
	`TRACE_DBG
("%s", "new_sess or old_sess doesn't support PRs");

13487 
out
;

13490 
	`mu‹x_lock
(&
sc¡_mu‹x
);

13492 
	`li¡_fÜ_—ch_’Œy
(
dev
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

13493 
sc¡_tgt_dev
 *
tgt_dev
;

13494 
sc¡_tgt_dev
 *
Ãw_tgt_dev
 = 
NULL
, *
Þd_tgt_dev
 = NULL;

13495 
sc¡_lksb
 
´_lksb
;

13497 
	`TRACE_DBG
("Proûssšg dev %s", 
dev
->
vœt_Çme
);

13499 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

13500 
dev_tgt_dev_li¡_’Œy
) {

13501 ià(
tgt_dev
->
£ss
 =ð
Ãw_£ss
) {

13502 
Ãw_tgt_dev
 = 
tgt_dev
;

13503 ià(
Þd_tgt_dev
 !ð
NULL
)

13506 ià(
tgt_dev
->
£ss
 =ð
Þd_£ss
) {

13507 
Þd_tgt_dev
 = 
tgt_dev
;

13508 ià(
Ãw_tgt_dev
 !ð
NULL
)

13513 ià((
Ãw_tgt_dev
 =ð
NULL
è|| (
Þd_tgt_dev
 == NULL)) {

13514 
	`TRACE_DBG
("new_tgt_dev %p or old_sess %p is NULL, "

13515 "skpšg (dev %s)", 
Ãw_tgt_dev
, 
Þd_tgt_dev
,

13516 
dev
->
vœt_Çme
);

13522 
	`sc¡_»s_lock
(
dev
, &
´_lksb
);

13523 ià(
	`sc¡_is_»£rv©iÚ_hÞd”
(
dev
, 
Þd_£ss
)) {

13524 
	`sc¡_»£rve_dev
(
dev
, 
Ãw_£ss
);

13525 
	`TRACE_DBG
("Reservation„eassigned from old_tgt_dev %p "

13526 "tØÃw_tgt_dev %p", 
Þd_tgt_dev
, 
Ãw_tgt_dev
);

13528 
	`sc¡_»s_uÆock
(
dev
, &
´_lksb
);

13532 ià((
Ãw_£ss
->
Œª¥Üt_id
 =ð
NULL
) ||

13533 (
Þd_£ss
->
Œª¥Üt_id
 =ð
NULL
)) {

13534 
	`TRACE_DBG
("%s", "new_sess or old_sess doesn't support PRs");

13535 
Ãxt
;

13538 
	`sc¡_´_wr™e_lock
(
dev
);

13540 ià(
Þd_tgt_dev
->
»gi¡¿Á
 !ð
NULL
) {

13541 
	`TRACE_PR
("Reassigning„eg %p fromgt_dev %po %p",

13542 
Þd_tgt_dev
->
»gi¡¿Á
, old_tgt_dev,

13543 
Ãw_tgt_dev
);

13545 ià(
Ãw_tgt_dev
->
»gi¡¿Á
 !ð
NULL
)

13546 
Ãw_tgt_dev
->
»gi¡¿Á
->
tgt_dev
 = 
NULL
;

13548 
Ãw_tgt_dev
->
»gi¡¿Á
 = 
Þd_tgt_dev
->registrant;

13549 
Ãw_tgt_dev
->
»gi¡¿Á
->
tgt_dev
 =‚ew_tgt_dev;

13551 
Þd_tgt_dev
->
»gi¡¿Á
 = 
NULL
;

13554 
	`sc¡_´_wr™e_uÆock
(
dev
);

13555 
Ãxt
:

13558 ià(
dev
->
hªdËr
->
»assign_»šed_¡©es
 !ð
NULL
) {

13559 
	`TRACE_DBG
("Calling dev's %s„eassign_retained_states(%p, %p)",

13560 
dev
->
vœt_Çme
, 
Ãw_tgt_dev
, 
Þd_tgt_dev
);

13561 
dev
->
hªdËr
->
	`»assign_»šed_¡©es
(
Ãw_tgt_dev
, 
Þd_tgt_dev
);

13562 
	`TRACE_DBG
("Dev's %s„eassign_retained_states()„eturned",

13563 
dev
->
vœt_Çme
);

13567 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

13569 
out
:

13570 
	`TRACE_EXIT
();

13572 
	}
}

13573 
EXPORT_SYMBOL
(
sc¡_»assign_»šed_£ss_¡©es
);

13582 *
	$sc¡_g‘_Ãxt_Ëxem
(**
tok’_¡r
)

13584 *
p
, *
q
;

13585 cÚ¡ 
bÏnk
 = '\0';

13587 ià((
tok’_¡r
 =ð
NULL
) || (*token_str == NULL))

13588  (*)&
bÏnk
;

13590 
p
 = *
tok’_¡r
; (*°!ð'\0'è&& (
	`is¥aû
(*p) || (*p == '='));…++)

13593 
q
 = 
p
; (*q !ð'\0'è&& !
	`is¥aû
(*q) && (*q != '='); q++)

13596 ià(*
q
 != '\0')

13597 *
q
++ = '\0';

13599 *
tok’_¡r
 = 
q
;

13600  
p
;

13601 
	}
}

13602 
EXPORT_SYMBOL_GPL
(
sc¡_g‘_Ãxt_Ëxem
);

13611 
	$sc¡_»¡Üe_tok’_¡r
(*
´ev_Ëxem
, *
tok’_¡r
)

13613 ià(&
´ev_Ëxem
[
	`¡¾’
Õ»v_Ëxem)] !ð
tok’_¡r
)

13614 
´ev_Ëxem
[
	`¡¾’
(prev_lexem)] = ' ';

13616 
	}
}

13617 
EXPORT_SYMBOL_GPL
(
sc¡_»¡Üe_tok’_¡r
);

13626 *
	$sc¡_g‘_Ãxt_tok’_¡r
(**
šput_¡r
)

13628 *
p
 = *
šput_¡r
;

13629 
i
 = 0;

13631 (
p
[
i
] != '\n') && (p[i] != ';') && (p[i] != '\0'))

13632 
i
++;

13634 ià(
i
 == 0)

13635  
NULL
;

13637 ià(
p
[
i
] == '\0')

13638 *
šput_¡r
 = &
p
[
i
];

13640 *
šput_¡r
 = &
p
[
i
+1];

13642 
p
[
i
] = '\0';

13644  
p
;

13645 
	}
}

13646 
EXPORT_SYMBOL_GPL
(
sc¡_g‘_Ãxt_tok’_¡r
);

13648 
	$sc¡_·r£_unm­_desütÜs
(
sc¡_cmd
 *
cmd
)

13650 
»s
 = 0;

13651 
ssize_t
 
Ëngth
 = 0;

13652 
ušt8_t
 *
add»ss
;

13653 
i
, 
út
, 
off£t
, 
desütÜ_Ën
, 
tÙ®_Ën
;

13654 
sc¡_d©a_desütÜ
 *
pd
;

13656 
	`TRACE_ENTRY
();

13658 
	`EXTRACHECKS_BUG_ON
(
cmd
->
cmd_d©a_desütÜs
 !ð
NULL
);

13659 
	`EXTRACHECKS_BUG_ON
(
cmd
->
cmd_d©a_desütÜs_út
 != 0);

13661 
Ëngth
 = 
	`sc¡_g‘_buf_fuÎ_£n£
(
cmd
, &
add»ss
);

13662 ià(
	`uÆik–y
(
Ëngth
 <= 0)) {

13663 ià(
Ëngth
 == 0)

13664 
out
;

13666 
out_abn
;

13669 
tÙ®_Ën
 = 
	`g‘_uÇligÃd_be16
(&
cmd
->
cdb
[7]);

13670 
off£t
 = 8;

13672 
desütÜ_Ën
 = 
	`g‘_uÇligÃd_be16
(&
add»ss
[2]);

13674 
	`TRACE_DBG
("tÙ®_ËÀ%d, desütÜ_ËÀ%d", 
tÙ®_Ën
, 
desütÜ_Ën
);

13676 ià(
desütÜ_Ën
 == 0)

13677 
out_put
;

13679 ià(
	`uÆik–y
((
desütÜ_Ën
 > (
tÙ®_Ën
 - 8)) ||

13680 ((
desütÜ_Ën
 % 16) != 0))) {

13681 
	`PRINT_ERROR
("Bad descriptor†ength: %d < %d - 8",

13682 
desütÜ_Ën
, 
tÙ®_Ën
);

13683 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 2, 0);

13684 
out_abn_put
;

13687 
út
 = 
desütÜ_Ën
/16;

13688 ià(
út
 == 0)

13689 
out_put
;

13691 
pd
 = 
	`kÿÎoc
(
út
, (*pd), 
GFP_KERNEL
);

13692 ià(
pd
 =ð
NULL
) {

13693 
	`PRINT_ERROR
("UÇbËØkm®loøUNMAP %d desütÜs", 
út
+1);

13694 
	`sc¡_£t_busy
(
cmd
);

13695 
out_abn_put
;

13698 
	`TRACE_DBG
("úˆ%d,…d %p", 
út
, 
pd
);

13700 
i
 = 0;

13701 (
off£t
 - 8è< 
desütÜ_Ën
) {

13702 
sc¡_d©a_desütÜ
 *
d
 = &
pd
[
i
];

13704 
d
->
sdd_lba
 = 
	`g‘_uÇligÃd_be64
(&
add»ss
[
off£t
]);

13705 
off£t
 += 8;

13706 
d
->
sdd_blocks
 = 
	`g‘_uÇligÃd_be32
(&
add»ss
[
off£t
]);

13707 
off£t
 += 8;

13708 
	`TRACE_DBG
("˜%d,†b¨%Îd, block %Îd", 
i
,

13709 ()
d
->
sdd_lba
, ()d->
sdd_blocks
);

13710 
i
++;

13713 
cmd
->
cmd_d©a_desütÜs
 = 
pd
;

13714 
cmd
->
cmd_d©a_desütÜs_út
 = 
út
;

13716 
out_put
:

13717 
	`sc¡_put_buf_fuÎ
(
cmd
, 
add»ss
);

13719 
out
:

13720 
	`TRACE_EXIT_RES
(
»s
);

13721  
»s
;

13723 
out_abn_put
:

13724 
	`sc¡_put_buf_fuÎ
(
cmd
, 
add»ss
);

13726 
out_abn
:

13727 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

13728 
»s
 = -1;

13729 
out
;

13730 
	}
}

13732 
	$sc¡_ä“_unm­_desütÜs
(
sc¡_cmd
 *
cmd
)

13734 
	`TRACE_ENTRY
();

13736 
	`kä“
(
cmd
->
cmd_d©a_desütÜs
);

13737 
cmd
->
cmd_d©a_desütÜs
 = 
NULL
;

13739 
	`TRACE_EXIT
();

13741 
	}
}

13743 
	$sc¡_·r£_desütÜs
(
sc¡_cmd
 *
cmd
)

13745 
»s
;

13747 
	`TRACE_ENTRY
();

13749 
cmd
->
cdb
[0]) {

13750 
UNMAP
:

13751 
»s
 = 
	`sc¡_·r£_unm­_desütÜs
(
cmd
);

13753 
EXTENDED_COPY
:

13754 
»s
 = 
	`sc¡_cm_·r£_desütÜs
(
cmd
);

13757 
	`sBUG
();

13760 
	`TRACE_EXIT_RES
(
»s
);

13761  
»s
;

13762 
	}
}

13764 
	$sc¡_ä“_desütÜs
(
sc¡_cmd
 *
cmd
)

13766 
	`TRACE_ENTRY
();

13768 
cmd
->
cdb
[0]) {

13769 
UNMAP
:

13770 
	`sc¡_ä“_unm­_desütÜs
(
cmd
);

13772 
EXTENDED_COPY
:

13773 
	`sc¡_cm_ä“_desütÜs
(
cmd
);

13776 
	`sBUG
();

13780 
	`TRACE_EXIT
();

13782 
	}
}

13790 
	#SCST_TAS_LABEL
 "TAS"

	)

13791 
	#SCST_QERR_LABEL
 "QERR"

	)

13792 
	#SCST_TMF_ONLY_LABEL
 "TMF_ONLY"

	)

13793 
	#SCST_SWP_LABEL
 "SWP"

	)

13794 
	#SCST_DSENSE_LABEL
 "D_SENSE"

	)

13795 
	#SCST_QUEUE_ALG_LABEL
 "QUEUE_ALG"

	)

13796 
	#SCST_DPICZ_LABEL
 "DPICZ"

	)

13798 
	$sc¡_§ve_glob®_mode_·ges
(cÚ¡ 
sc¡_deviû
 *
dev
,

13799 
ušt8_t
 *
buf
, 
size
)

13801 
»s
 = 0;

13803 
	`TRACE_ENTRY
();

13805 ià(
dev
->
s
 !ðdev->
s_deçuÉ
) {

13806 
»s
 +ð
	`sú´štf
(&
buf
[»s], 
size
 -„es, "%s=%d\n",

13807 
SCST_TAS_LABEL
, 
dev
->
s
);

13808 ià(
»s
 >ð
size
-1)

13809 
out_ov”æow
;

13812 ià(
dev
->
q”r
 !ðdev->
q”r_deçuÉ
) {

13813 
»s
 +ð
	`sú´štf
(&
buf
[»s], 
size
 -„es, "%s=%d\n",

13814 
SCST_QERR_LABEL
, 
dev
->
q”r
);

13815 ià(
»s
 >ð
size
-1)

13816 
out_ov”æow
;

13819 ià(
dev
->
tmf_Úly
 !ðdev->
tmf_Úly_deçuÉ
) {

13820 
»s
 +ð
	`sú´štf
(&
buf
[»s], 
size
 -„es, "%s=%d\n",

13821 
SCST_TMF_ONLY_LABEL
, 
dev
->
tmf_Úly
);

13822 ià(
»s
 >ð
size
-1)

13823 
out_ov”æow
;

13826 ià(
dev
->
swp
 !ðdev->
swp_deçuÉ
) {

13827 
»s
 +ð
	`sú´štf
(&
buf
[»s], 
size
 -„es, "%s=%d\n",

13828 
SCST_SWP_LABEL
, 
dev
->
swp
);

13829 ià(
»s
 >ð
size
-1)

13830 
out_ov”æow
;

13833 ià(
dev
->
d_£n£
 !ðdev->
d_£n£_deçuÉ
) {

13834 
»s
 +ð
	`sú´štf
(&
buf
[»s], 
size
 -„es, "%s=%d\n",

13835 
SCST_DSENSE_LABEL
, 
dev
->
d_£n£
);

13836 ià(
»s
 >ð
size
-1)

13837 
out_ov”æow
;

13840 ià(
dev
->
dpicz
 !ðdev->
dpicz_deçuÉ
) {

13841 
»s
 +ð
	`sú´štf
(&
buf
[»s], 
size
 -„es, "%s=%d\n",

13842 
SCST_DPICZ_LABEL
, 
dev
->
dpicz
);

13843 ià(
»s
 >ð
size
-1)

13844 
out_ov”æow
;

13847 ià(
dev
->
queue_®g
 !ðdev->
queue_®g_deçuÉ
) {

13848 
»s
 +ð
	`sú´štf
(&
buf
[»s], 
size
 -„es, "%s=%d\n",

13849 
SCST_QUEUE_ALG_LABEL
, 
dev
->
queue_®g
);

13850 ià(
»s
 >ð
size
-1)

13851 
out_ov”æow
;

13854 
out
:

13855 
	`TRACE_EXIT_RES
(
»s
);

13856  
»s
;

13858 
out_ov”æow
:

13859 
	`PRINT_ERROR
("Glob® mod·ge bufã¸ov”æow (siz%d)", 
size
);

13860 
»s
 = -
EOVERFLOW
;

13861 
out
;

13862 
	}
}

13863 
EXPORT_SYMBOL_GPL
(
sc¡_§ve_glob®_mode_·ges
);

13865 
	$sc¡_»¡Üe_s
(
sc¡_deviû
 *
dev
, 
v®
)

13867 
»s
;

13869 
	`TRACE_ENTRY
();

13871 ià(
v®
 > 1) {

13872 
	`PRINT_ERROR
("Invalid value %d for…arameter %s (device %s)",

13873 
v®
, 
SCST_TAS_LABEL
, 
dev
->
vœt_Çme
);

13874 
»s
 = -
EINVAL
;

13875 
out
;

13878 
dev
->
s
 = 
v®
;

13879 
dev
->
s_§ved
 = 
v®
;

13881 
	`PRINT_INFO
("% »¡ÜedØ%d fÜ deviû %s", 
SCST_TAS_LABEL
,

13882 
dev
->
s
, dev->
vœt_Çme
);

13884 
»s
 = 0;

13886 
out
:

13887 
	`TRACE_EXIT_RES
(
»s
);

13888  
»s
;

13889 
	}
}

13891 
	$sc¡_»¡Üe_q”r
(
sc¡_deviû
 *
dev
, 
v®
)

13893 
»s
;

13895 
	`TRACE_ENTRY
();

13897 ià((
v®
 =ð
SCST_QERR_2_RESERVED
) ||

13898 (
v®
 > 
SCST_QERR_3_ABORT_THIS_NEXUS_ONLY
)) {

13899 
	`PRINT_ERROR
("Invalid value %d for…arameter %s (device %s)",

13900 
v®
, 
SCST_QERR_LABEL
, 
dev
->
vœt_Çme
);

13901 
»s
 = -
EINVAL
;

13902 
out
;

13905 
dev
->
q”r
 = 
v®
;

13906 
dev
->
q”r_§ved
 = 
v®
;

13908 
	`PRINT_INFO
("% »¡ÜedØ%d fÜ deviû %s", 
SCST_QERR_LABEL
,

13909 
dev
->
q”r
, dev->
vœt_Çme
);

13911 
»s
 = 0;

13913 
out
:

13914 
	`TRACE_EXIT_RES
(
»s
);

13915  
»s
;

13916 
	}
}

13918 
	$sc¡_»¡Üe_tmf_Úly
(
sc¡_deviû
 *
dev
, 
v®
)

13920 
»s
;

13922 
	`TRACE_ENTRY
();

13924 ià(
v®
 > 1) {

13925 
	`PRINT_ERROR
("Invalid value %d for…arameter %s (device %s)",

13926 
v®
, 
SCST_TMF_ONLY_LABEL
, 
dev
->
vœt_Çme
);

13927 
»s
 = -
EINVAL
;

13928 
out
;

13931 
dev
->
tmf_Úly
 = 
v®
;

13932 
dev
->
tmf_Úly_§ved
 = 
v®
;

13934 
	`PRINT_INFO
("% »¡ÜedØ%d fÜ deviû %s", 
SCST_TMF_ONLY_LABEL
,

13935 
dev
->
tmf_Úly
, dev->
vœt_Çme
);

13937 
»s
 = 0;

13939 
out
:

13940 
	`TRACE_EXIT_RES
(
»s
);

13941  
»s
;

13942 
	}
}

13944 
	$sc¡_»¡Üe_swp
(
sc¡_deviû
 *
dev
, 
v®
)

13946 
»s
;

13948 
	`TRACE_ENTRY
();

13950 ià(
v®
 > 1) {

13951 
	`PRINT_ERROR
("Invalid value %d for…arameter %s (device %s)",

13952 
v®
, 
SCST_SWP_LABEL
, 
dev
->
vœt_Çme
);

13953 
»s
 = -
EINVAL
;

13954 
out
;

13957 
dev
->
swp
 = 
v®
;

13958 
dev
->
swp_§ved
 = 
v®
;

13960 
	`PRINT_INFO
("% »¡ÜedØ%d fÜ deviû %s", 
SCST_SWP_LABEL
,

13961 
dev
->
swp
, dev->
vœt_Çme
);

13963 
»s
 = 0;

13965 
out
:

13966 
	`TRACE_EXIT_RES
(
»s
);

13967  
»s
;

13968 
	}
}

13970 
	$sc¡_»¡Üe_d£n£
(
sc¡_deviû
 *
dev
, 
v®
)

13972 
»s
;

13974 
	`TRACE_ENTRY
();

13976 ià(
v®
 > 1) {

13977 
	`PRINT_ERROR
("Invalid value %d for…arameter %s (device %s)",

13978 
v®
, 
SCST_DSENSE_LABEL
, 
dev
->
vœt_Çme
);

13979 
»s
 = -
EINVAL
;

13980 
out
;

13983 
dev
->
d_£n£
 = 
v®
;

13984 
dev
->
d_£n£_§ved
 = 
v®
;

13986 
	`PRINT_INFO
("% »¡ÜedØ%d fÜ deviû %s", 
SCST_DSENSE_LABEL
,

13987 
dev
->
d_£n£
, dev->
vœt_Çme
);

13989 
»s
 = 0;

13991 
out
:

13992 
	`TRACE_EXIT_RES
(
»s
);

13993  
»s
;

13994 
	}
}

13996 
	$sc¡_»¡Üe_dpicz
(
sc¡_deviû
 *
dev
, 
v®
)

13998 
»s
;

14000 
	`TRACE_ENTRY
();

14002 ià(
v®
 > 1) {

14003 
	`PRINT_ERROR
("Invalid value %d for…arameter %s (device %s)",

14004 
v®
, 
SCST_DPICZ_LABEL
, 
dev
->
vœt_Çme
);

14005 
»s
 = -
EINVAL
;

14006 
out
;

14009 
dev
->
dpicz
 = 
v®
;

14010 
dev
->
dpicz_§ved
 = 
v®
;

14012 
	`PRINT_INFO
("% »¡ÜedØ%d fÜ deviû %s", 
SCST_DPICZ_LABEL
,

14013 
dev
->
dpicz
, dev->
vœt_Çme
);

14015 
»s
 = 0;

14017 
out
:

14018 
	`TRACE_EXIT_RES
(
»s
);

14019  
»s
;

14020 
	}
}

14022 
	$sc¡_»¡Üe_queue_®g
(
sc¡_deviû
 *
dev
, 
v®
)

14024 
»s
;

14026 
	`TRACE_ENTRY
();

14028 ià((
v®
 !ð
SCST_QUEUE_ALG_0_RESTRICTED_REORDER
) &&

14029 (
v®
 !ð
SCST_QUEUE_ALG_1_UNRESTRICTED_REORDER
)) {

14030 
	`PRINT_ERROR
("Invalid value %d for…arameter %s (device %s)",

14031 
v®
, 
SCST_QUEUE_ALG_LABEL
, 
dev
->
vœt_Çme
);

14032 
»s
 = -
EINVAL
;

14033 
out
;

14036 
dev
->
queue_®g
 = 
v®
;

14037 
dev
->
queue_®g_§ved
 = 
v®
;

14039 
	`PRINT_INFO
("% »¡ÜedØ%d fÜ deviû %s", 
SCST_QUEUE_ALG_LABEL
,

14040 
dev
->
queue_®g
, dev->
vœt_Çme
);

14042 
»s
 = 0;

14044 
out
:

14045 
	`TRACE_EXIT_RES
(
»s
);

14046  
»s
;

14047 
	}
}

14050 
	$sc¡_»¡Üe_glob®_mode_·ges
(
sc¡_deviû
 *
dev
, *
·¿ms
,

14051 **
Ï¡_·¿m
)

14053 
»s
;

14054 *
·¿m
, *
p
, *
µ
;

14055 
v®
;

14057 
	`TRACE_ENTRY
();

14060 
·¿m
 = 
	`sc¡_g‘_Ãxt_tok’_¡r
(&
·¿ms
);

14061 ià(
·¿m
 =ð
NULL
)

14064 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
·¿m
);

14065 ià(*
p
 == '\0')

14068 
µ
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
·¿m
);

14069 ià(*
µ
 == '\0')

14070 
out_Ãed_·¿m
;

14072 ià(
	`sc¡_g‘_Ãxt_Ëxem
(&
·¿m
)[0] != '\0')

14073 
out_too_mªy
;

14075 
»s
 = 
	`k¡¹oul
(
µ
, 0, &
v®
);

14076 ià(
»s
 != 0)

14077 
out_¡¹oul_çžed
;

14079 ià(
	`¡rÿ£cmp
(
SCST_TAS_LABEL
, 
p
) == 0)

14080 
»s
 = 
	`sc¡_»¡Üe_s
(
dev
, 
v®
);

14081 ià(
	`¡rÿ£cmp
(
SCST_QERR_LABEL
, 
p
) == 0)

14082 
»s
 = 
	`sc¡_»¡Üe_q”r
(
dev
, 
v®
);

14083 ià(
	`¡rÿ£cmp
(
SCST_TMF_ONLY_LABEL
, 
p
) == 0)

14084 
»s
 = 
	`sc¡_»¡Üe_tmf_Úly
(
dev
, 
v®
);

14085 ià(
	`¡rÿ£cmp
(
SCST_SWP_LABEL
, 
p
) == 0)

14086 
»s
 = 
	`sc¡_»¡Üe_swp
(
dev
, 
v®
);

14087 ià(
	`¡rÿ£cmp
(
SCST_DSENSE_LABEL
, 
p
) == 0)

14088 
»s
 = 
	`sc¡_»¡Üe_d£n£
(
dev
, 
v®
);

14089 ià(
	`¡rÿ£cmp
(
SCST_DPICZ_LABEL
, 
p
) == 0)

14090 
»s
 = 
	`sc¡_»¡Üe_dpicz
(
dev
, 
v®
);

14091 ià(
	`¡rÿ£cmp
(
SCST_QUEUE_ALG_LABEL
, 
p
) == 0)

14092 
»s
 = 
	`sc¡_»¡Üe_queue_®g
(
dev
, 
v®
);

14094 
	`TRACE_DBG
("UnknowÀ·¿m‘” %s", 
p
);

14095 
	`sc¡_»¡Üe_tok’_¡r
(
p
, 
·¿m
);

14096 *
Ï¡_·¿m
 = 
p
;

14097 
out
;

14099 ià(
»s
 != 0)

14100 
out
;

14103 *
Ï¡_·¿m
 = 
NULL
;

14104 
»s
 = 0;

14106 
out
:

14107 
	`TRACE_EXIT_RES
(
»s
);

14108  
»s
;

14110 
out_¡¹oul_çžed
:

14111 
	`PRINT_ERROR
("¡¹oul(èfÜ % çžed: %d (deviû %s)", 
µ
, 
»s
,

14112 
dev
->
vœt_Çme
);

14113 
out
;

14115 
out_Ãed_·¿m
:

14116 
	`PRINT_ERROR
("P¬am‘” % v®umis£d fÜ deviû %s", 
p
, 
dev
->
vœt_Çme
);

14117 
»s
 = -
EINVAL
;

14118 
out
;

14120 
out_too_mªy
:

14121 
	`PRINT_ERROR
("ToØmªy…¬am‘”' % v®ue (deviû %s)", 
p
, 
dev
->
vœt_Çme
);

14122 
»s
 = -
EINVAL
;

14123 
out
;

14124 
	}
}

14125 
EXPORT_SYMBOL_GPL
(
sc¡_»¡Üe_glob®_mode_·ges
);

14128 
	$__sc¡_ext_blockšg_dÚe
(
sc¡_deviû
 *
dev
)

14130 
boÞ
 
¡Ý
;

14132 
	`TRACE_ENTRY
();

14134 
	`TRACE_BLOCK
("Notifyingƒxt blockers for dev %s (ext_blocks_cnt %d)",

14135 
dev
->
vœt_Çme
, dev->
ext_blocks_út
);

14137 
¡Ý
 = 
	`li¡_em±y
(&
dev
->
ext_block”s_li¡
);

14138 !
¡Ý
) {

14139 
sc¡_ext_block”
 *
b
;

14141 
b
 = 
	`li¡_fœ¡_’Œy
(&
dev
->
ext_block”s_li¡
, 
	`ty³of
(*b),

14142 
ext_block”s_li¡_’Œy
);

14144 
	`TRACE_DBG
("NÙifyšg‡synøexˆblock” %°(úˆ%d)", 
b
,

14145 
dev
->
ext_blocks_út
);

14147 
	`li¡_d–
(&
b
->
ext_block”s_li¡_’Œy
);

14149 
¡Ý
 = 
	`li¡_em±y
(&
dev
->
ext_block”s_li¡
);

14150 ià(
¡Ý
)

14151 
dev
->
ext_blockšg_³ndšg
 = 0;

14153 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

14155 
b
->
	`ext_block”_dÚe_â
(
dev
, b->
ext_block”_d©a
,

14156 
b
->
ext_block”_d©a_Ën
);

14158 
	`kä“
(
b
);

14160 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

14163 
	`TRACE_EXIT
();

14165 
	}
}

14167 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 20)

14168 
	$sc¡_ext_blockšg_dÚe_â
(*
p
)

14170 
sc¡_deviû
 *
dev
 = 
p
;

14172 
	$sc¡_ext_blockšg_dÚe_â
(
wÜk_¡ruù
 *
wÜk
)

14174 
sc¡_deviû
 *
dev
 = 
	`cÚš”_of
(
wÜk
, scst_device,

14175 
ext_block”s_wÜk
);

14178 
	`TRACE_ENTRY
();

14180 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

14182 
	`WARN_ON
(!
dev
->
ext_unblock_scheduËd
);

14185 !
	`li¡_em±y
(&
dev
->
ext_block”s_li¡
))

14186 
	`__sc¡_ext_blockšg_dÚe
(
dev
);

14188 
	`WARN_ON
(!
dev
->
ext_unblock_scheduËd
);

14189 
dev
->
ext_unblock_scheduËd
 = 0;

14191 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

14193 
	`TRACE_EXIT
();

14195 
	}
}

14198 
	$sc¡_ext_blockšg_dÚe
(
sc¡_deviû
 *
dev
)

14200 
	`TRACE_ENTRY
();

14202 
	`lockd•_as£¹_h–d
(&
dev
->
dev_lock
);

14204 ià(
dev
->
ext_unblock_scheduËd
)

14205 
out
;

14207 
	`TRACE_DBG
("Schedulšgƒxt_block”s_wÜk fÜ dev %s", 
dev
->
vœt_Çme
);

14209 
dev
->
ext_unblock_scheduËd
 = 1;

14210 
	`scheduË_wÜk
(&
dev
->
ext_block”s_wÜk
);

14212 
out
:

14213 
	`TRACE_EXIT
();

14215 
	}
}

14217 
	$sc¡_sync_ext_blockšg_dÚe
(
sc¡_deviû
 *
dev
,

14218 
ušt8_t
 *
d©a
, 
Ën
)

14220 
wa™_queue_h—d_t
 *
w
;

14222 
	`TRACE_ENTRY
();

14224 
w
 = (*)*((*)
d©a
);

14225 
	`wake_up_®l
(
w
);

14227 
	`TRACE_EXIT
();

14229 
	}
}

14231 
	$sc¡_ext_block_dev
(
sc¡_deviû
 *
dev
, 
ext_block”_dÚe_â_t
 
dÚe_â
,

14232 cÚ¡ 
ušt8_t
 *
´iv
, 
´iv_Ën
, 
æags
)

14234 
»s
;

14235 
sc¡_ext_block”
 *
b
;

14237 
	`TRACE_ENTRY
();

14239 ià(
æags
 & 
SCST_EXT_BLOCK_SYNC
)

14240 
´iv_Ën
 = (*);

14242 
b
 = 
	`kz®loc
((*bè+ 
´iv_Ën
, 
GFP_KERNEL
);

14243 ià(
b
 =ð
NULL
) {

14244 
	`PRINT_ERROR
("Unableo‡lloc struct scst_ext_blocker with data "

14245 "(siz%zd)", (*
b
è+ 
´iv_Ën
);

14246 
»s
 = -
ENOMEM
;

14247 
out
;

14250 
	`TRACE_MGMT_DBG
("New %dƒxt blocker %p for dev %s (flags %x)",

14251 
dev
->
ext_blocks_út
+1, 
b
, dev->
vœt_Çme
, 
æags
);

14253 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

14255 ià(
dev
->
¡riùly_£rŸlized_cmd_wa™šg
) {

14261 
	`TRACE_DBG
("Un¡riùly£rŸlizdev %s", 
dev
->
vœt_Çme
);

14262 
dev
->
¡riùly_£rŸlized_cmd_wa™šg
 = 0;

14265 
	`sc¡_block_dev
(
dev
);

14267 ià(
æags
 & 
SCST_EXT_BLOCK_STPG
) {

14268 
	`WARN_ON
(
dev
->
¡pg_ext_blocked
);

14269 
dev
->
¡pg_ext_blocked
 = 1;

14272 
dev
->
ext_blocks_út
++;

14273 
	`TRACE_DBG
("ext_blocks_úˆ%d", 
dev
->
ext_blocks_út
);

14275 ià((
æags
 & 
SCST_EXT_BLOCK_SYNC
è&& (
dev
->
Ú_dev_cmd_couÁ
 == 0)) {

14276 
	`TRACE_DBG
("No commandso wait for sync blocking (dev %s)",

14277 
dev
->
vœt_Çme
);

14278 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

14279 
out_ä“_sucûss
;

14282 
	`li¡_add_ž
(&
b
->
ext_block”s_li¡_’Œy
, &
dev
->
ext_block”s_li¡
);

14283 
dev
->
ext_blockšg_³ndšg
 = 1;

14285 ià(
æags
 & 
SCST_EXT_BLOCK_SYNC
) {

14286 
	`DECLARE_WAIT_QUEUE_HEAD_ONSTACK
(
w
);

14288 
b
->
ext_block”_dÚe_â
 = 
sc¡_sync_ext_blockšg_dÚe
;

14289 *((**)&
b
->
ext_block”_d©a
[0]èð&
w
;

14291 
	`wa™_ev’t_locked
(
w
, (
dev
->
Ú_dev_cmd_couÁ
 == 0),

14292 
lock_bh
, 
dev
->
dev_lock
);

14294 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

14296 
b
->
ext_block”_dÚe_â
 = 
dÚe_â
;

14297 ià(
´iv_Ën
 > 0) {

14298 
b
->
ext_block”_d©a_Ën
 = 
´iv_Ën
;

14299 
	`memýy
(
b
->
ext_block”_d©a
, 
´iv
, 
´iv_Ën
);

14301 ià(
dev
->
Ú_dev_cmd_couÁ
 == 0) {

14302 
	`TRACE_DBG
("No commandso wait for‡sync blocking "

14303 "(dev %s)", 
dev
->
vœt_Çme
);

14304 ià(!
dev
->
ext_unblock_scheduËd
)

14305 
	`__sc¡_ext_blockšg_dÚe
(
dev
);

14306 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

14308 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

14311 
out_sucûss
:

14312 
»s
 = 0;

14314 
out
:

14315 
	`TRACE_EXIT_RES
(
»s
);

14316  
»s
;

14318 
out_ä“_sucûss
:

14319 
	`sBUG_ON
(!(
æags
 & 
SCST_EXT_BLOCK_SYNC
));

14320 
	`kä“
(
b
);

14321 
out_sucûss
;

14322 
	}
}

14324 
	$sc¡_ext_unblock_dev
(
sc¡_deviû
 *
dev
, 
boÞ
 
¡pg
)

14326 
	`TRACE_ENTRY
();

14328 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

14330 ià(
dev
->
ext_blocks_út
 == 0) {

14331 
	`TRACE_DBG
("NÙhšgØunblock (dev %s)", 
dev
->
vœt_Çme
);

14332 
out_uÆock
;

14335 ià((
dev
->
ext_blocks_út
 =ð1è&& dev->
¡pg_ext_blocked
 && !
¡pg
) {

14340 
	`TRACE_MGMT_DBG
("Can‚ot unblock internal STPGƒxt block "

14342 
dev
->
vœt_Çme
, dev->
ext_blocks_út
,

14343 
dev
->
¡pg_ext_blocked
, 
¡pg
);

14344 
out_uÆock
;

14347 
dev
->
ext_blocks_út
--;

14348 
	`TRACE_MGMT_DBG
("Ext unblocking for dev %s (left: %d,…ending %d)",

14349 
dev
->
vœt_Çme
, dev->
ext_blocks_út
,

14350 
dev
->
ext_blockšg_³ndšg
);

14352 ià((
dev
->
ext_blocks_út
 =ð0è&& dev->
ext_blockšg_³ndšg
) {

14353 
rc
;

14355 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

14356 
	`TRACE_DBG
("Ext unblock (dev %s): still…ending...",

14357 
dev
->
vœt_Çme
);

14358 
rc
 = 
	`sc¡_ext_block_dev
(
dev
, 
NULL
, NULL, 0, 
SCST_EXT_BLOCK_SYNC
);

14359 ià(
rc
 != 0) {

14361 
	`PRINT_WARNING
("scst_ext_block_dev(dev %s) failed, "

14362 "sw™chØpÞlšg", 
dev
->
vœt_Çme
);

14363 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

14364 
dev
->
ext_blockšg_³ndšg
) {

14365 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

14366 
	`m¦“p
(10);

14367 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

14369 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

14371 
	`TRACE_DBG
("Ext unblock:…ending done, unblocking...");

14372 
	`sc¡_ext_unblock_dev
(
dev
, 
¡pg
);

14374 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

14377 
	`sc¡_unblock_dev
(
dev
);

14379 
out_uÆock
:

14380 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

14382 
	`TRACE_EXIT
();

14384 
	}
}

14387 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 39)

14388 
	$sc¡_vfs_uÆšk_ªd_put
(
Çmeid©a
 *
nd
)

14390 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2,6,25)

14391 
	`vfs_uÆšk
(
nd
->
d’Œy
->
d_·»Á
->
d_šode
,‚d->dentry);

14392 
	`dput
(
nd
->
d’Œy
);

14393 
	`mÁput
(
nd
->
mÁ
);

14395 
	`vfs_uÆšk
(
nd
->
·th
.
d’Œy
->
d_·»Á
->
d_šode
,

14396 
nd
->
·th
.
d’Œy
);

14397 
	`·th_put
(&
nd
->
·th
);

14399 
	}
}

14401 
	$sc¡_vfs_uÆšk_ªd_put
(
·th
 *path)

14403 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3, 13, 0) && \

14404 (!
	`defšed
(
RHEL_MAJOR
) || RHEL_MAJOR -0 < 7) && \

14405 (!
	`defšed
(
CONFIG_SUSE_KERNEL
) || \

14406 
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3, 12, 0))

14407 
	`vfs_uÆšk
(
·th
->
d’Œy
->
d_·»Á
->
d_šode
,…ath->dentry);

14409 
	`vfs_uÆšk
(
·th
->
d’Œy
->
d_·»Á
->
d_šode
,…©h->d’Œy, 
NULL
);

14411 
	`·th_put
(
·th
);

14412 
	}
}

14415 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 39)

14416 
	$sc¡_·th_put
(
Çmeid©a
 *
nd
)

14418 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2,6,25)

14419 
	`dput
(
nd
->
d’Œy
);

14420 
	`mÁput
(
nd
->
mÁ
);

14422 
	`·th_put
(&
nd
->
·th
);

14424 
	}
}

14425 
EXPORT_SYMBOL
(
sc¡_·th_put
);

14428 
	$sc¡_cÝy_fže
(cÚ¡ *
¤c
, cÚ¡ *
de¡
)

14430 
»s
 = 0;

14431 
šode
 *inode;

14432 
loff_t
 
fže_size
, 
pos
;

14433 
ušt8_t
 *
buf
 = 
NULL
;

14434 
fže
 *
fže_¤c
 = 
NULL
, *
fže_de¡
 = NULL;

14435 
mm_£gm’t_t
 
Þd_fs
 = 
	`g‘_fs
();

14437 
	`TRACE_ENTRY
();

14439 ià(
¤c
 =ð
NULL
 || 
de¡
 == NULL) {

14440 
»s
 = -
EINVAL
;

14441 
	`PRINT_ERROR
("%s", "Invalid…ersistent files…ath - backup "

14443 
out
;

14446 
	`TRACE_DBG
("CÝyšg '%s' iÁØ'%s'", 
¤c
, 
de¡
);

14448 
	`£t_fs
(
KERNEL_DS
);

14450 
fže_¤c
 = 
	`fžp_Ý’
(
¤c
, 
O_RDONLY
, 0);

14451 ià(
	`IS_ERR
(
fže_¤c
)) {

14452 
»s
 = 
	`PTR_ERR
(
fže_¤c
);

14453 
	`TRACE_DBG
("UÇbËØÝ’ fž'%s' -ƒ¼Ü %d", 
¤c
, 
»s
);

14454 
out_ä“
;

14457 
fže_de¡
 = 
	`fžp_Ý’
(
de¡
, 
O_WRONLY
 | 
O_CREAT
 | 
O_TRUNC
, 0644);

14458 ià(
	`IS_ERR
(
fže_de¡
)) {

14459 
»s
 = 
	`PTR_ERR
(
fže_de¡
);

14460 
	`TRACE_DBG
("UÇbËØÝ’ backu°fž'%s' -ƒ¼Ü %d", 
de¡
,

14461 
»s
);

14462 
out_þo£
;

14465 
šode
 = 
	`fže_šode
(
fže_¤c
);

14467 ià(
	`S_ISREG
(
šode
->
i_mode
)) {

14469 } ià(
	`S_ISBLK
(
šode
->
i_mode
)) {

14470 
šode
 = inode->
i_bdev
->
bd_šode
;

14472 
	`PRINT_ERROR
("Inv®id fžmod0x%x", 
šode
->
i_mode
);

14473 
»s
 = -
EINVAL
;

14474 
	`£t_fs
(
Þd_fs
);

14475 
out_sk
;

14478 
fže_size
 = 
šode
->
i_size
;

14480 
buf
 = 
	`vm®loc
(
fže_size
);

14481 ià(
buf
 =ð
NULL
) {

14482 
»s
 = -
ENOMEM
;

14483 
	`PRINT_ERROR
("%s", "Unableo‡llocateemporary buffer");

14484 
out_sk
;

14487 
pos
 = 0;

14488 
»s
 = 
	`vfs_»ad
(
fže_¤c
, (
__fÜû
 
__u£r
 *)
buf
, 
fže_size
, &
pos
);

14489 ià(
»s
 !ð
fže_size
) {

14490 
	`PRINT_ERROR
("UÇbËØ»ad fž'%s' -ƒ¼Ü %d", 
¤c
, 
»s
);

14491 
out_sk
;

14494 
pos
 = 0;

14495 
»s
 = 
	`vfs_wr™e
(
fže_de¡
, (
__fÜû
 
__u£r
 *)
buf
, 
fže_size
, &
pos
);

14496 ià(
»s
 !ð
fže_size
) {

14497 
	`PRINT_ERROR
("UÇbËØwr™tØ'%s' -ƒ¼Ü %d", 
de¡
, 
»s
);

14498 
out_sk
;

14501 
»s
 = 
	`vfs_fsync
(
fže_de¡
, 0);

14502 ià(
»s
 != 0) {

14503 
	`PRINT_ERROR
("fsync(èoàthbacku°PR fžçžed: %d", 
»s
);

14504 
out_sk
;

14507 
out_sk
:

14508 
	`fžp_þo£
(
fže_de¡
, 
NULL
);

14510 
out_þo£
:

14511 
	`fžp_þo£
(
fže_¤c
, 
NULL
);

14513 
out_ä“
:

14514 ià(
buf
 !ð
NULL
)

14515 
	`vä“
(
buf
);

14517 
	`£t_fs
(
Þd_fs
);

14519 
out
:

14520 
	`TRACE_EXIT_RES
(
»s
);

14521  
»s
;

14522 
	}
}

14524 
	$sc¡_»move_fže
(cÚ¡ *
Çme
)

14526 
»s
 = 0;

14527 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 39)

14528 
Çmeid©a
 
nd
;

14530 
·th
…ath;

14532 
mm_£gm’t_t
 
Þd_fs
 = 
	`g‘_fs
();

14534 
	`TRACE_ENTRY
();

14536 
	`£t_fs
(
KERNEL_DS
);

14538 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 39)

14539 
»s
 = 
	`·th_lookup
(
Çme
, 0, &
nd
);

14540 ià(!
»s
)

14541 
	`sc¡_vfs_uÆšk_ªd_put
(&
nd
);

14543 
	`TRACE_DBG
("UÇbËØlooku°fž'%s' -ƒ¼Ü %d", 
Çme
, 
»s
);

14545 
»s
 = 
	`k”n_·th
(
Çme
, 0, &
·th
);

14546 ià(!
»s
)

14547 
	`sc¡_vfs_uÆšk_ªd_put
(&
·th
);

14549 
	`TRACE_DBG
("UÇbËØlooku°fž'%s' -ƒ¼Ü %d", 
Çme
, 
»s
);

14552 
	`£t_fs
(
Þd_fs
);

14554 
	`TRACE_EXIT_RES
(
»s
);

14555  
»s
;

14556 
	}
}

14557 
EXPORT_SYMBOL_GPL
(
sc¡_»move_fže
);

14560 
	$sc¡_wr™e_fže_Œª§ùiÚ®
(cÚ¡ *
Çme
, cÚ¡ *
Çme1
,

14561 cÚ¡ *
sigÇtu»
, 
sigÇtu»_Ën
, cÚ¡ 
ušt8_t
 *
buf
, 
size
)

14563 
»s
;

14564 
fže
 *file;

14565 
mm_£gm’t_t
 
Þd_fs
 = 
	`g‘_fs
();

14566 
loff_t
 
pos
 = 0;

14567 
n
 = '\n';

14569 
	`TRACE_ENTRY
();

14571 
»s
 = 
	`sc¡_cÝy_fže
(
Çme
, 
Çme1
);

14572 ià((
»s
 !ð0è&& (» !ð-
ENOENT
))

14573 
out
;

14575 
	`£t_fs
(
KERNEL_DS
);

14577 
fže
 = 
	`fžp_Ý’
(
Çme
, 
O_WRONLY
 | 
O_CREAT
 | 
O_TRUNC
, 0644);

14578 ià(
	`IS_ERR
(
fže
)) {

14579 
»s
 = 
	`PTR_ERR
(
fže
);

14580 
	`PRINT_ERROR
("Unableo (re)create file '%s' -ƒrror %d",

14581 
Çme
, 
»s
);

14582 
out_£t_fs
;

14585 
	`TRACE_DBG
("Wr™šg fž'%s'", 
Çme
);

14587 
pos
 = 
sigÇtu»_Ën
+1;

14589 
»s
 = 
	`vfs_wr™e
(
fže
, (
__fÜû
 
__u£r
 *)
buf
, 
size
, &
pos
);

14590 ià(
»s
 !ð
size
)

14591 
wr™e_”rÜ
;

14593 
»s
 = 
	`vfs_fsync
(
fže
, 1);

14594 ià(
»s
 != 0) {

14595 
	`PRINT_ERROR
("fsync(èoàfž% çžed: %d", 
Çme
, 
»s
);

14596 
wr™e_”rÜ_þo£
;

14599 
pos
 = 0;

14600 
»s
 = 
	`vfs_wr™e
(
fže
, (
__fÜû
 
__u£r
 *)
sigÇtu»
, 
sigÇtu»_Ën
, &
pos
);

14601 ià(
»s
 !ð
sigÇtu»_Ën
)

14602 
wr™e_”rÜ
;

14604 
»s
 = 
	`vfs_wr™e
(
fže
, (
__fÜû
 
__u£r
 *)&
n
, Ò), &
pos
);

14605 ià(
»s
 !ð(
n
))

14606 
wr™e_”rÜ
;

14608 
»s
 = 
	`vfs_fsync
(
fže
, 1);

14609 ià(
»s
 != 0) {

14610 
	`PRINT_ERROR
("fsync(èoàfž% çžed: %d", 
Çme
, 
»s
);

14611 
wr™e_”rÜ_þo£
;

14614 
»s
 = 0;

14616 
	`fžp_þo£
(
fže
, 
NULL
);

14618 
out_£t_fs
:

14619 
	`£t_fs
(
Þd_fs
);

14621 ià(
»s
 == 0)

14622 
	`sc¡_»move_fže
(
Çme1
);

14624 
	`sc¡_»move_fže
(
Çme
);

14626 
out
:

14627 
	`TRACE_EXIT_RES
(
»s
);

14628  
»s
;

14630 
wr™e_”rÜ
:

14631 
	`PRINT_ERROR
("E¼Ü wr™šgØ'%s' -ƒ¼Ü %d", 
Çme
, 
»s
);

14633 
wr™e_”rÜ_þo£
:

14634 
	`fžp_þo£
(
fže
, 
NULL
);

14635 ià(
»s
 > 0)

14636 
»s
 = -
EIO
;

14637 
out_£t_fs
;

14638 
	}
}

14639 
EXPORT_SYMBOL_GPL
(
sc¡_wr™e_fže_Œª§ùiÚ®
);

14641 
	$__sc¡_»ad_fže_Œª§ùiÚ®
(cÚ¡ *
fže_Çme
,

14642 cÚ¡ *
sigÇtu»
, 
sigÇtu»_Ën
, 
ušt8_t
 *
buf
, 
size
)

14644 
»s
;

14645 
fže
 *fžð
NULL
;

14646 
šode
 *inode;

14647 
loff_t
 
fže_size
, 
pos
;

14648 
mm_£gm’t_t
 
Þd_fs
;

14650 
	`TRACE_ENTRY
();

14652 
Þd_fs
 = 
	`g‘_fs
();

14653 
	`£t_fs
(
KERNEL_DS
);

14655 
	`TRACE_DBG
("Lßdšg fž'%s'", 
fže_Çme
);

14657 
fže
 = 
	`fžp_Ý’
(
fže_Çme
, 
O_RDONLY
, 0);

14658 ià(
	`IS_ERR
(
fže
)) {

14659 
»s
 = 
	`PTR_ERR
(
fže
);

14660 
	`TRACE_DBG
("UÇbËØÝ’ fž'%s' -ƒ¼Ü %d", 
fže_Çme
, 
»s
);

14661 
out
;

14664 
šode
 = 
	`fže_šode
(
fže
);

14666 ià(
	`S_ISREG
(
šode
->
i_mode
)) {

14668 } ià(
	`S_ISBLK
(
šode
->
i_mode
)) {

14669 
šode
 = inode->
i_bdev
->
bd_šode
;

14671 
	`PRINT_ERROR
("Inv®id fžmod0x%x", 
šode
->
i_mode
);

14672 
»s
 = -
EINVAL
;

14673 
out_þo£
;

14676 
fže_size
 = 
šode
->
i_size
;

14678 ià(
fže_size
 > 
size
) {

14679 
	`PRINT_ERROR
("Suµl›d bufã¸(%dètoØsm®ÈÒ“d %d)", 
size
,

14680 ()
fže_size
);

14681 
»s
 = -
EOVERFLOW
;

14682 
out_þo£
;

14685 
pos
 = 0;

14686 
»s
 = 
	`vfs_»ad
(
fže
, (
__fÜû
 
__u£r
 *)
buf
, 
fže_size
, &
pos
);

14687 ià(
»s
 !ð
fže_size
) {

14688 
	`PRINT_ERROR
("UÇbËØ»ad fž'%s' -ƒ¼Ü %d", 
fže_Çme
, 
»s
);

14689 ià(
»s
 > 0)

14690 
»s
 = -
EIO
;

14691 
out_þo£
;

14694 ià(
	`memcmp
(
buf
, 
sigÇtu»
, 
sigÇtu»_Ën
) != 0) {

14695 
»s
 = -
EINVAL
;

14696 
	`PRINT_ERROR
("Inv®id sigÇtu» iÀfž%s", 
fže_Çme
);

14697 
out_þo£
;

14700 
out_þo£
:

14701 
	`fžp_þo£
(
fže
, 
NULL
);

14703 
out
:

14704 
	`£t_fs
(
Þd_fs
);

14706 
	`TRACE_EXIT_RES
(
»s
);

14707  
»s
;

14708 
	}
}

14715 
	$sc¡_»ad_fže_Œª§ùiÚ®
(cÚ¡ *
Çme
, cÚ¡ *
Çme1
,

14716 cÚ¡ *
sigÇtu»
, 
sigÇtu»_Ën
, 
ušt8_t
 *
buf
, 
size
)

14718 
»s
;

14720 
	`TRACE_ENTRY
();

14722 
»s
 = 
	`__sc¡_»ad_fže_Œª§ùiÚ®
(
Çme
, 
sigÇtu»
, 
sigÇtu»_Ën
, 
buf
, 
size
);

14723 ià(
»s
 <= 0)

14724 
»s
 = 
	`__sc¡_»ad_fže_Œª§ùiÚ®
(
Çme1
, 
sigÇtu»
,

14725 
sigÇtu»_Ën
, 
buf
, 
size
);

14727 ià(
»s
 > 0)

14728 
	`TRACE_BUFFER
("R—d d©a", 
buf
, 
»s
);

14730 
	`TRACE_EXIT_RES
(
»s
);

14731  
»s
;

14732 
	}
}

14733 
EXPORT_SYMBOL_GPL
(
sc¡_»ad_fže_Œª§ùiÚ®
);

14739 
	$sc¡_g‘_fže_mode
(cÚ¡ *
·th
)

14741 
fže
 *file;

14742 
»s
;

14744 
fže
 = 
	`fžp_Ý’
(
·th
, 
O_RDONLY
, 0400);

14745 ià(
	`IS_ERR
(
fže
)) {

14746 
»s
 = 
	`PTR_ERR
(
fže
);

14747 
out
;

14749 
»s
 = 
	`fže_šode
(
fže
)->
i_mode
;

14750 
	`fžp_þo£
(
fže
, 
NULL
);

14752 
out
:

14753  
»s
;

14754 
	}
}

14755 
EXPORT_SYMBOL
(
sc¡_g‘_fže_mode
);

14761 
boÞ
 
	$sc¡_·»Á_dœ_exi¡s
(cÚ¡ *
·th
)

14763 cÚ¡ *
Ï¡_¦ash
 = 
	`¡¼chr
(
·th
, '/');

14764 cÚ¡ *
dœ
;

14765 
dœ_mode
;

14766 
boÞ
 
»s
 = 
Œue
;

14768 ià(
Ï¡_¦ash
 &&†a¡_¦ash > 
·th
) {

14769 
dœ
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%.*s", ()(
Ï¡_¦ash
 - 
·th
),

14770 
·th
);

14771 ià(
dœ
) {

14772 
dœ_mode
 = 
	`sc¡_g‘_fže_mode
(
dœ
);

14773 
	`kä“
(
dœ
);

14774 
»s
 = 
dœ_mode
 >ð0 && 
	`S_ISDIR
(dir_mode);

14776 
»s
 = 
çl£
;

14780  
»s
;

14781 
	}
}

14782 
EXPORT_SYMBOL
(
sc¡_·»Á_dœ_exi¡s
);

14784 
__š™
 
	$sc¡_scsi_Ý_li¡_š™
()

14786 
i
;

14787 
ušt8_t
 
Ý
 = 0xff;

14789 
	`TRACE_ENTRY
();

14791 
	`TRACE_DBG
("tblsize=%d", 
SCST_CDB_TBL_SIZE
);

14793 
i
 = 0; i < 256; i++)

14794 
sc¡_scsi_Ý_li¡
[
i
] = 
SCST_CDB_TBL_SIZE
;

14796 
i
 = 0; i < 
SCST_CDB_TBL_SIZE
; i++) {

14797 ià(
sc¡_scsi_Ý_bË
[
i
].
Ýs
 !ð
Ý
) {

14798 
Ý
 = 
sc¡_scsi_Ý_bË
[
i
].
Ýs
;

14799 
sc¡_scsi_Ý_li¡
[
Ý
] = 
i
;

14803 
	`TRACE_BUFFER
("sc¡_scsi_Ý_li¡", 
sc¡_scsi_Ý_li¡
,

14804 (
sc¡_scsi_Ý_li¡
));

14806 
sc¡_»Ëa£_acg_wq
 = 
	`ü—‹_wÜkqueue
("scst_release_acg");

14807 
	`WARN_ON_ONCE
(
	`IS_ERR
(
sc¡_»Ëa£_acg_wq
));

14809 
	`TRACE_EXIT
();

14811 
	}
}

14813 
__š™
 
	$sc¡_lib_š™
()

14815 
»s
 = 0;

14817 
	`sc¡_scsi_Ý_li¡_š™
();

14819 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 30)

14820 
scsi_io_cÚ‹xt_ÿche
 = 
	`kmem_ÿche_ü—‹
("scst_scsi_io_context",

14821 (
scsi_io_cÚ‹xt
),

14822 
	`__®ignof__
(
scsi_io_cÚ‹xt
),

14823 
SCST_SLAB_FLAGS
|
SLAB_HWCACHE_ALIGN
, 
NULL
);

14824 ià(!
scsi_io_cÚ‹xt_ÿche
) {

14825 
	`PRINT_ERROR
("%s", "Can't init scsi io context cache");

14826 
»s
 = -
ENOMEM
;

14827 
out
;

14830 
out
:

14832 
	`TRACE_EXIT_RES
(
»s
);

14833  
»s
;

14834 
	}
}

14836 
	$sc¡_lib_ex™
()

14839 
	`æush_wÜkqueue
(
sc¡_»Ëa£_acg_wq
);

14840 
	`de¡roy_wÜkqueue
(
sc¡_»Ëa£_acg_wq
);

14842 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 30)

14843 
	`BUILD_BUG_ON
(
SCST_MAX_CDB_SIZE
 !ð
BLK_MAX_CDB
);

14844 
	`BUILD_BUG_ON
(
SCST_SENSE_BUFFERSIZE
 < 
SCSI_SENSE_BUFFERSIZE
);

14846 
	`kmem_ÿche_de¡roy
(
scsi_io_cÚ‹xt_ÿche
);

14848 
	}
}

14850 #ifdeà
CONFIG_SCST_DEBUG


14860 
	$sc¡_¿ndom
()

14862 
In™ed
;

14863 
RªdomV®ue
;

14864 
	`DEFINE_SPINLOCK
(
lock
);

14866 
rv
;

14867 
lo
;

14868 
hi
;

14869 
æags
;

14871 
	`¥š_lock_œq§ve
(&
lock
, 
æags
);

14872 ià(!
In™ed
) {

14873 
RªdomV®ue
 = 
jiff›s
;

14874 
In™ed
 = 1;

14876 
rv
 = 
RªdomV®ue
;

14877 
hi
 = 
rv
 / 127773;

14878 
lo
 = 
rv
 % 127773;

14879 
rv
 = 16807 * 
lo
 - 2836 * 
hi
;

14880 ià(
rv
 <= 0)

14881 
rv
 += 2147483647;

14882 
RªdomV®ue
 = 
rv
;

14883 
	`¥š_uÆock_œq»¡Üe
(&
lock
, 
æags
);

14884  
rv
;

14885 
	}
}

14886 
EXPORT_SYMBOL_GPL
(
sc¡_¿ndom
);

14889 #ifdeà
CONFIG_SCST_DEBUG_TM


14891 
	#TM_DBG_STATE_ABORT
 0

	)

14892 
	#TM_DBG_STATE_RESET
 1

	)

14893 
	#TM_DBG_STATE_OFFLINE
 2

	)

14895 
	#INIT_TM_DBG_STATE
 
TM_DBG_STATE_ABORT


	)

14897 
tm_dbg_tim”_â
(
¬g
);

14899 
DEFINE_SPINLOCK
(
sc¡_tm_dbg_lock
);

14902 
	mtm_dbg_»Ëa£
:1;

14903 
	mtm_dbg_blocked
:1;

14904 } 
	gtm_dbg_æags
;

14905 
LIST_HEAD
(
tm_dbg_d–ayed_cmd_li¡
);

14906 
	gtm_dbg_d–ayed_cmds_couÁ
;

14907 
	gtm_dbg_·s£d_cmds_couÁ
;

14908 
	gtm_dbg_¡©e
;

14909 
	gtm_dbg_Ú_¡©e_·s£s
;

14910 
DEFINE_TIMER
(
tm_dbg_tim”
, 
tm_dbg_tim”_â
, 0, 0);

14911 
sc¡_tgt_dev
 *
	gtm_dbg_tgt_dev
;

14913 cÚ¡ 
	gtm_dbg_Ú_¡©e_num_·s£s
[] = { 5, 1, 0x7ffffff };

14915 
	$tm_dbg_š™_tgt_dev
(
sc¡_tgt_dev
 *
tgt_dev
)

14917 ià(
tgt_dev
->
lun
 == 15) {

14918 
æags
;

14920 ià(
tm_dbg_tgt_dev
 !ð
NULL
)

14921 
	`tm_dbg_deš™_tgt_dev
(
tm_dbg_tgt_dev
);

14923 
	`¥š_lock_œq§ve
(&
sc¡_tm_dbg_lock
, 
æags
);

14924 
tm_dbg_¡©e
 = 
INIT_TM_DBG_STATE
;

14925 
tm_dbg_Ú_¡©e_·s£s
 =

14926 
tm_dbg_Ú_¡©e_num_·s£s
[
tm_dbg_¡©e
];

14927 
tm_dbg_tgt_dev
 = 
tgt_dev
;

14928 
	`PRINT_INFO
("LUN %lld connected from initiator %s is under "

14930 ()
tgt_dev
->
lun
,

14931 
tgt_dev
->
£ss
->
š™ŸtÜ_Çme
,gt_dev);

14932 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_tm_dbg_lock
, 
æags
);

14935 
	}
}

14937 
	$tm_dbg_deš™_tgt_dev
(
sc¡_tgt_dev
 *
tgt_dev
)

14939 ià(
tm_dbg_tgt_dev
 =ð
tgt_dev
) {

14940 
æags
;

14942 
	`TRACE_MGMT_DBG
("Deš™ TM debuggšggt_dev %p", 
tgt_dev
);

14943 
	`d–_tim”_sync
(&
tm_dbg_tim”
);

14944 
	`¥š_lock_œq§ve
(&
sc¡_tm_dbg_lock
, 
æags
);

14945 
tm_dbg_tgt_dev
 = 
NULL
;

14946 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_tm_dbg_lock
, 
æags
);

14949 
	}
}

14951 
	$tm_dbg_tim”_â
(
¬g
)

14953 
	`TRACE_MGMT_DBG
("%s", "delayed cmdimerƒxpired");

14954 
tm_dbg_æags
.
tm_dbg_»Ëa£
 = 1;

14955 
	`wake_up_®l
(&
tm_dbg_tgt_dev
->
aùive_cmd_th»ads
->
cmd_li¡_wa™Q
);

14957 
	}
}

14960 
	$tm_dbg_d–ay_cmd
(
sc¡_cmd
 *
cmd
)

14962 
tm_dbg_¡©e
) {

14963 
TM_DBG_STATE_ABORT
:

14964 ià(
tm_dbg_d–ayed_cmds_couÁ
 == 0) {

14965 
d
 = 58*
HZ
 + (
	`sc¡_¿ndom
() % (4*HZ));

14967 
	`TRACE_MGMT_DBG
("STATE ABORT: delaying cmd %p (tag %llu)"

14969 "tm_dbg_Ú_¡©e_·s£s=%d", 
cmd
, cmd->
g
,

14970 
d
/
HZ
, (d%HZ)*100/HZ, d, 
tm_dbg_Ú_¡©e_·s£s
);

14971 
	`mod_tim”
(&
tm_dbg_tim”
, 
jiff›s
 + 
d
);

14973 
tm_dbg_æags
.
tm_dbg_blocked
 = 1;

14976 
	`TRACE_MGMT_DBG
("Delaying‡notherimed cmd %p "

14978 "tm_dbg_Ú_¡©e_·s£s=%d", 
cmd
, cmd->
g
,

14979 
tm_dbg_d–ayed_cmds_couÁ
,

14980 
tm_dbg_Ú_¡©e_·s£s
);

14981 ià(
tm_dbg_d–ayed_cmds_couÁ
 == 2)

14982 
tm_dbg_æags
.
tm_dbg_blocked
 = 0;

14986 
TM_DBG_STATE_RESET
:

14987 
TM_DBG_STATE_OFFLINE
:

14988 
	`TRACE_MGMT_DBG
("STATE RESET/OFFLINE: delaying cmd %p "

14990 "tm_dbg_Ú_¡©e_·s£s=%d", 
cmd
, cmd->
g
,

14991 
tm_dbg_d–ayed_cmds_couÁ
, 
tm_dbg_Ú_¡©e_·s£s
);

14992 
tm_dbg_æags
.
tm_dbg_blocked
 = 1;

14996 
	`sBUG
();

14999 
	`¥š_lock
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

15000 
	`li¡_add_ž
(&
cmd
->
cmd_li¡_’Œy
, &
tm_dbg_d–ayed_cmd_li¡
);

15001 
	`¥š_uÆock
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

15002 
cmd
->
tm_dbg_d–ayed
 = 1;

15003 
tm_dbg_d–ayed_cmds_couÁ
++;

15005 
	}
}

15008 
	$tm_dbg_check_»Ëa£d_cmds
()

15010 ià(
tm_dbg_æags
.
tm_dbg_»Ëa£
) {

15011 
sc¡_cmd
 *
cmd
, *
tc
;

15013 
	`¥š_lock_œq
(&
sc¡_tm_dbg_lock
);

15014 
	`li¡_fÜ_—ch_’Œy_§ã_»v”£
(
cmd
, 
tc
,

15015 &
tm_dbg_d–ayed_cmd_li¡
, 
cmd_li¡_’Œy
) {

15016 
	`TRACE_MGMT_DBG
("Releasingimed cmd %p (tag %llu), "

15017 "d–ayed_cmds_couÁ=%d", 
cmd
, cmd->
g
,

15018 
tm_dbg_d–ayed_cmds_couÁ
);

15019 
	`¥š_lock
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

15020 
	`li¡_move
(&
cmd
->
cmd_li¡_’Œy
,

15021 &
cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

15022 
	`¥š_uÆock
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

15024 
tm_dbg_æags
.
tm_dbg_»Ëa£
 = 0;

15025 
	`¥š_uÆock_œq
(&
sc¡_tm_dbg_lock
);

15027 
	}
}

15030 
	$tm_dbg_chªge_¡©e
(*
æags
)

15032 
tm_dbg_æags
.
tm_dbg_blocked
 = 0;

15033 ià(--
tm_dbg_Ú_¡©e_·s£s
 == 0) {

15034 
tm_dbg_¡©e
) {

15035 
TM_DBG_STATE_ABORT
:

15036 
	`TRACE_MGMT_DBG
("%s", "Changing "

15038 
tm_dbg_¡©e
 = 
TM_DBG_STATE_RESET
;

15039 
tm_dbg_æags
.
tm_dbg_blocked
 = 0;

15041 
TM_DBG_STATE_RESET
:

15042 
TM_DBG_STATE_OFFLINE
:

15043 #ifdeà
CONFIG_SCST_TM_DBG_GO_OFFLINE


15044 
	`TRACE_MGMT_DBG
("%s", "Changing "

15046 
tm_dbg_¡©e
 = 
TM_DBG_STATE_OFFLINE
;

15048 
	`TRACE_MGMT_DBG
("%s", "Changing "

15050 
tm_dbg_¡©e
 = 
TM_DBG_STATE_ABORT
;

15054 
	`sBUG
();

15056 
tm_dbg_Ú_¡©e_·s£s
 =

15057 
tm_dbg_Ú_¡©e_num_·s£s
[
tm_dbg_¡©e
];

15060 
	`TRACE_MGMT_DBG
("%s", "Deletingimer");

15061 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_tm_dbg_lock
, *
æags
);

15062 
	`d–_tim”_sync
(&
tm_dbg_tim”
);

15063 
	`¥š_lock_œq§ve
(&
sc¡_tm_dbg_lock
, *
æags
);

15065 
	}
}

15068 
	$tm_dbg_check_cmd
(
sc¡_cmd
 *
cmd
)

15070 
»s
 = 0;

15071 
æags
;

15073 ià(
cmd
->
tm_dbg_immut
)

15074 
out
;

15076 ià(
cmd
->
tm_dbg_d–ayed
) {

15077 
	`¥š_lock_œq§ve
(&
sc¡_tm_dbg_lock
, 
æags
);

15078 
	`TRACE_MGMT_DBG
("Processing delayed cmd %p (tag %llu), "

15079 "d–ayed_cmds_couÁ=%d", 
cmd
, cmd->
g
,

15080 
tm_dbg_d–ayed_cmds_couÁ
);

15082 
cmd
->
tm_dbg_immut
 = 1;

15083 
tm_dbg_d–ayed_cmds_couÁ
--;

15084 ià((
tm_dbg_d–ayed_cmds_couÁ
 == 0) &&

15085 (
tm_dbg_¡©e
 =ð
TM_DBG_STATE_ABORT
))

15086 
	`tm_dbg_chªge_¡©e
(&
æags
);

15087 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_tm_dbg_lock
, 
æags
);

15088 } ià(
cmd
->
tgt_dev
 && (
tm_dbg_tgt_dev
 == cmd->tgt_dev)) {

15090 
	`¥š_lock_œq§ve
(&
sc¡_tm_dbg_lock
, 
æags
);

15091 ià(
tm_dbg_æags
.
tm_dbg_blocked
 ||

15092 (++
tm_dbg_·s£d_cmds_couÁ
 % 5000) == 0) {

15093 
	`tm_dbg_d–ay_cmd
(
cmd
);

15094 
»s
 = 1;

15096 
cmd
->
tm_dbg_immut
 = 1;

15097 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_tm_dbg_lock
, 
æags
);

15100 
out
:

15101  
»s
;

15102 
	}
}

15105 
	$tm_dbg_»Ëa£_cmd
(
sc¡_cmd
 *
cmd
)

15107 
sc¡_cmd
 *
c
;

15108 
æags
;

15110 
	`¥š_lock_œq§ve
(&
sc¡_tm_dbg_lock
, 
æags
);

15111 
	`li¡_fÜ_—ch_’Œy
(
c
, &
tm_dbg_d–ayed_cmd_li¡
,

15112 
cmd_li¡_’Œy
) {

15113 ià(
c
 =ð
cmd
) {

15114 
	`TRACE_MGMT_DBG
("Abort„equest for "

15117 
c
, c->
g
, 
tm_dbg_d–ayed_cmds_couÁ
);

15119 ià(!(
	`š_©omic
(è|| 
	`š_š‹¼u±
(è|| 
	`œqs_di§bËd
()))

15120 
	`m¦“p
(2000);

15122 ià(!
	`‹¡_b™
(
SCST_CMD_ABORTED_OTHER
,

15123 &
cmd
->
cmd_æags
)) {

15125 ià(((
	`sc¡_¿ndom
() % 10) == 5)) {

15126 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

15127 
	`SCST_LOAD_SENSE
(

15128 
sc¡_£n£_š‹º®_çžu»
));

15133 
	`¥š_lock
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

15134 
	`li¡_move
(&
c
->
cmd_li¡_’Œy
,

15135 &
c
->
cmd_th»ads
->
aùive_cmd_li¡
);

15136 
	`wake_up
(&
c
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

15137 
	`¥š_uÆock
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

15141 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_tm_dbg_lock
, 
æags
);

15143 
	}
}

15146 
	$tm_dbg_sk_mgmt
(
sc¡_deviû
 *
dev
, cÚ¡ *
â
, 
fÜû
)

15148 
æags
;

15150 ià(
dev
 !ð
NULL
) {

15151 ià(
tm_dbg_tgt_dev
 =ð
NULL
)

15152 
out
;

15154 ià(
tm_dbg_tgt_dev
->
dev
 != dev)

15155 
out
;

15158 
	`¥š_lock_œq§ve
(&
sc¡_tm_dbg_lock
, 
æags
);

15159 ià((
tm_dbg_¡©e
 !ð
TM_DBG_STATE_OFFLINE
è|| 
fÜû
) {

15160 
	`TRACE_MGMT_DBG
("%s: f»ešg %d d–ayed cmds", 
â
,

15161 
tm_dbg_d–ayed_cmds_couÁ
);

15162 
	`tm_dbg_chªge_¡©e
(&
æags
);

15163 
tm_dbg_æags
.
tm_dbg_»Ëa£
 = 1;

15168 
	`smp_wmb
();

15169 ià(
tm_dbg_tgt_dev
 !ð
NULL
)

15170 
	`wake_up_®l
(&
tm_dbg_tgt_dev
->
aùive_cmd_th»ads
->
cmd_li¡_wa™Q
);

15172 
	`TRACE_MGMT_DBG
("%s: whžOFFLINE s‹, došg‚Ùhšg", 
â
);

15174 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_tm_dbg_lock
, 
æags
);

15176 
out
:

15178 
	}
}

15180 
	$tm_dbg_is_»Ëa£
()

15182  
tm_dbg_æags
.
tm_dbg_»Ëa£
;

15183 
	}
}

15186 #ifdeà
CONFIG_SCST_DEBUG_SN


15187 
	$sc¡_check_debug_¢
(
sc¡_cmd
 *
cmd
)

15189 
Þd
 = 
cmd
->
queue_ty³
;

15192 ià(!
	`š_š‹¼u±
(è&& (
	`sc¡_¿ndom
() % 120) == 8) {

15193 
t
 = 
	`sc¡_¿ndom
() % 1200;

15195 
	`TRACE_SN
("D–ayšg IO oÀ%d ms", 
t
);

15196 
	`m¦“p
(
t
);

15199 ià((
	`sc¡_¿ndom
() % 15) == 7)

15200 
cmd
->
queue_ty³
 = 
SCST_CMD_QUEUE_ORDERED
;

15201 ià((
	`sc¡_¿ndom
() % 1000) == 751)

15202 
cmd
->
queue_ty³
 = 
SCST_CMD_QUEUE_HEAD_OF_QUEUE
;

15203 ià((
	`sc¡_¿ndom
() % 1000) == 752)

15204 
cmd
->
queue_ty³
 = 
SCST_CMD_QUEUE_SIMPLE
;

15206 ià(
Þd
 !ð
cmd
->
queue_ty³
)

15207 
	`TRACE_SN
("DbgSN queueype changed for cmd %p from %do %d",

15208 
cmd
, 
Þd
, cmd->
queue_ty³
);

15210 
	}
}

15213 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


15215 
ušt64_t
 
	$sc¡_g‘_u£c
()

15217 
time¥ec
 
ts
;

15219 
	`ktime_g‘_ts
(&
ts
);

15220 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 16)

15221  ((
ušt64_t
)
ts
.
tv_£c
 * 1000000000 +s.
tv_n£c
) / 1000;

15223 #ià(
BITS_PER_LONG
 > 32)

15224  
	`time¥ec_to_ns
(&
ts
) / 1000;

15226  
	`time¥ec_to_ns
(&
ts
) >> 10;

15229 
	}
}

15231 
	$sc¡_£t_¡¬t_time
(
sc¡_cmd
 *
cmd
)

15233 
cmd
->
¡¬t
 = 
	`sc¡_g‘_u£c
();

15234 
	`TRACE_DBG
("cmd %p: s¹ %Îd", 
cmd
, cmd->
¡¬t
);

15235 
	}
}

15237 
	$sc¡_£t_cur_¡¬t
(
sc¡_cmd
 *
cmd
)

15239 
cmd
->
cu¼_¡¬t
 = 
	`sc¡_g‘_u£c
();

15240 
	`TRACE_DBG
("cmd %p: cur_¡¬ˆ%Îd", 
cmd
, cmd->
cu¼_¡¬t
);

15241 
	}
}

15243 
	$sc¡_£t_·r£_time
(
sc¡_cmd
 *
cmd
)

15245 
cmd
->
·r£_time
 +ð
	`sc¡_g‘_u£c
(è- cmd->
cu¼_¡¬t
;

15246 
	`TRACE_DBG
("cmd %p:…¬£_tim%Îd", 
cmd
, cmd->
·r£_time
);

15247 
	}
}

15249 
	$sc¡_£t_®loc_buf_time
(
sc¡_cmd
 *
cmd
)

15251 
cmd
->
®loc_buf_time
 +ð
	`sc¡_g‘_u£c
(è- cmd->
cu¼_¡¬t
;

15252 
	`TRACE_DBG
("cmd %p:‡Îoc_buf_tim%Îd", 
cmd
, cmd->
®loc_buf_time
);

15253 
	}
}

15255 
	$sc¡_£t_»¡¬t_wa™šg_time
(
sc¡_cmd
 *
cmd
)

15257 
cmd
->
»¡¬t_wa™šg_time
 +ð
	`sc¡_g‘_u£c
(è- cmd->
cu¼_¡¬t
;

15258 
	`TRACE_DBG
("cmd %p:„e¡¬t_wa™šg_tim%Îd", 
cmd
,

15259 
cmd
->
»¡¬t_wa™šg_time
);

15260 
	}
}

15262 
	$sc¡_£t_rdy_to_xãr_time
(
sc¡_cmd
 *
cmd
)

15264 
cmd
->
rdy_to_xãr_time
 +ð
	`sc¡_g‘_u£c
(è- cmd->
cu¼_¡¬t
;

15265 
	`TRACE_DBG
("cmd %p:„dy_to_xãr_tim%Îd", 
cmd
, cmd->
rdy_to_xãr_time
);

15266 
	}
}

15268 
	$sc¡_£t_´e_exec_time
(
sc¡_cmd
 *
cmd
)

15270 
cmd
->
´e_exec_time
 +ð
	`sc¡_g‘_u£c
(è- cmd->
cu¼_¡¬t
;

15271 
	`TRACE_DBG
("cmd %p:…»_exec_tim%Îd", 
cmd
, cmd->
´e_exec_time
);

15272 
	}
}

15274 
	$sc¡_£t_exec_¡¬t
(
sc¡_cmd
 *
cmd
)

15276 
cmd
->
exec_time_couÁšg
 = 
Œue
;

15277 
	`sc¡_£t_cur_¡¬t
(
cmd
);

15278 
	}
}

15280 
	$sc¡_£t_exec_time
(
sc¡_cmd
 *
cmd
)

15282 
cmd
->
exec_time
 +ð
	`sc¡_g‘_u£c
(è- cmd->
cu¼_¡¬t
;

15283 
	`TRACE_DBG
("cmd %p:ƒxec_tim%Îd", 
cmd
, cmd->
exec_time
);

15284 
	}
}

15286 
	$sc¡_£t_dev_dÚe_time
(
sc¡_cmd
 *
cmd
)

15288 
cmd
->
dev_dÚe_time
 +ð
	`sc¡_g‘_u£c
(è- cmd->
cu¼_¡¬t
;

15289 
	`TRACE_DBG
("cmd %p: dev_dÚe_tim%Îd", 
cmd
, cmd->
dev_dÚe_time
);

15290 
	}
}

15292 
	$sc¡_£t_xm™_time
(
sc¡_cmd
 *
cmd
)

15294 
cmd
->
xm™_time
 +ð
	`sc¡_g‘_u£c
(è- cmd->
cu¼_¡¬t
;

15295 
	`TRACE_DBG
("cmd %p: xm™_tim%Îd", 
cmd
, cmd->
xm™_time
);

15296 
	}
}

15298 
	$sc¡_upd©e_Ït_¡©s
(
sc¡_cmd
 *
cmd
)

15300 
ušt64_t
 
fšish
, 
sc¡_time
, 
tgt_time
, 
dev_time
;

15301 
sc¡_£ssiÚ
 *
£ss
 = 
cmd
->sess;

15302 
d©a_Ën
;

15303 
i
;

15304 
sc¡_ext_Ï‹ncy_¡©
 *
Ï‹ncy_¡©
, *
dev_Ï‹ncy_¡©
;

15306 
fšish
 = 
	`sc¡_g‘_u£c
();

15309 
d©a_Ën
 = 
cmd
->
bufæ’
;

15310 
i
 = 
SCST_LATENCY_STAT_INDEX_OTHER
;

15311 ià(
d©a_Ën
 <ð
SCST_IO_SIZE_THRESHOLD_SMALL
)

15312 
i
 = 
SCST_LATENCY_STAT_INDEX_SMALL
;

15313 ià(
d©a_Ën
 <ð
SCST_IO_SIZE_THRESHOLD_MEDIUM
)

15314 
i
 = 
SCST_LATENCY_STAT_INDEX_MEDIUM
;

15315 ià(
d©a_Ën
 <ð
SCST_IO_SIZE_THRESHOLD_LARGE
)

15316 
i
 = 
SCST_LATENCY_STAT_INDEX_LARGE
;

15317 ià(
d©a_Ën
 <ð
SCST_IO_SIZE_THRESHOLD_VERY_LARGE
)

15318 
i
 = 
SCST_LATENCY_STAT_INDEX_VERY_LARGE
;

15319 
Ï‹ncy_¡©
 = &
£ss
->
£ss_Ï‹ncy_¡©
[
i
];

15320 ià(
cmd
->
tgt_dev
 !ð
NULL
)

15321 
dev_Ï‹ncy_¡©
 = &
cmd
->
tgt_dev
->dev_Ï‹ncy_¡©[
i
];

15323 
dev_Ï‹ncy_¡©
 = 
NULL
;

15326 
sc¡_time
 = 
fšish
 - 
cmd
->
¡¬t
 - (cmd->
·r£_time
 +

15327 
cmd
->
®loc_buf_time
 + cmd->
»¡¬t_wa™šg_time
 +

15328 
cmd
->
rdy_to_xãr_time
 + cmd->
´e_exec_time
 +

15329 
cmd
->
exec_time
 + cmd->
dev_dÚe_time
 + cmd->
xm™_time
);

15330 
tgt_time
 = 
cmd
->
®loc_buf_time
 + cmd->
»¡¬t_wa™šg_time
 +

15331 
cmd
->
rdy_to_xãr_time
 + cmd->
´e_exec_time
;

15332 
dev_time
 = 
cmd
->
·r£_time
 + cmd->
exec_time
 + cmd->
dev_dÚe_time
;

15334 
	`¥š_lock_bh
(&
£ss
->
Ït_lock
);

15337 
£ss
->
sc¡_time
 += scst_time;

15338 
£ss
->
tgt_time
 +=gt_time;

15339 
£ss
->
dev_time
 += dev_time;

15340 
£ss
->
´oûs£d_cmds
++;

15342 ià((
£ss
->
mš_sc¡_time
 == 0) ||

15343 (
£ss
->
mš_sc¡_time
 > 
sc¡_time
))

15344 
£ss
->
mš_sc¡_time
 = 
sc¡_time
;

15345 ià((
£ss
->
mš_tgt_time
 == 0) ||

15346 (
£ss
->
mš_tgt_time
 > 
tgt_time
))

15347 
£ss
->
mš_tgt_time
 = 
tgt_time
;

15348 ià((
£ss
->
mš_dev_time
 == 0) ||

15349 (
£ss
->
mš_dev_time
 > 
dev_time
))

15350 
£ss
->
mš_dev_time
 = 
dev_time
;

15352 ià(
£ss
->
max_sc¡_time
 < 
sc¡_time
)

15353 
£ss
->
max_sc¡_time
 = 
sc¡_time
;

15354 ià(
£ss
->
max_tgt_time
 < 
tgt_time
)

15355 
£ss
->
max_tgt_time
 = 
tgt_time
;

15356 ià(
£ss
->
max_dev_time
 < 
dev_time
)

15357 
£ss
->
max_dev_time
 = 
dev_time
;

15360 ià(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_READ
) {

15361 
Ï‹ncy_¡©
->
sc¡_time_rd
 +ð
sc¡_time
;

15362 
Ï‹ncy_¡©
->
tgt_time_rd
 +ð
tgt_time
;

15363 
Ï‹ncy_¡©
->
dev_time_rd
 +ð
dev_time
;

15364 
Ï‹ncy_¡©
->
´oûs£d_cmds_rd
++;

15366 ià((
Ï‹ncy_¡©
->
mš_sc¡_time_rd
 == 0) ||

15367 (
Ï‹ncy_¡©
->
mš_sc¡_time_rd
 > 
sc¡_time
))

15368 
Ï‹ncy_¡©
->
mš_sc¡_time_rd
 = 
sc¡_time
;

15369 ià((
Ï‹ncy_¡©
->
mš_tgt_time_rd
 == 0) ||

15370 (
Ï‹ncy_¡©
->
mš_tgt_time_rd
 > 
tgt_time
))

15371 
Ï‹ncy_¡©
->
mš_tgt_time_rd
 = 
tgt_time
;

15372 ià((
Ï‹ncy_¡©
->
mš_dev_time_rd
 == 0) ||

15373 (
Ï‹ncy_¡©
->
mš_dev_time_rd
 > 
dev_time
))

15374 
Ï‹ncy_¡©
->
mš_dev_time_rd
 = 
dev_time
;

15376 ià(
Ï‹ncy_¡©
->
max_sc¡_time_rd
 < 
sc¡_time
)

15377 
Ï‹ncy_¡©
->
max_sc¡_time_rd
 = 
sc¡_time
;

15378 ià(
Ï‹ncy_¡©
->
max_tgt_time_rd
 < 
tgt_time
)

15379 
Ï‹ncy_¡©
->
max_tgt_time_rd
 = 
tgt_time
;

15380 ià(
Ï‹ncy_¡©
->
max_dev_time_rd
 < 
dev_time
)

15381 
Ï‹ncy_¡©
->
max_dev_time_rd
 = 
dev_time
;

15383 ià(
dev_Ï‹ncy_¡©
 !ð
NULL
) {

15384 
dev_Ï‹ncy_¡©
->
sc¡_time_rd
 +ð
sc¡_time
;

15385 
dev_Ï‹ncy_¡©
->
tgt_time_rd
 +ð
tgt_time
;

15386 
dev_Ï‹ncy_¡©
->
dev_time_rd
 +ð
dev_time
;

15387 
dev_Ï‹ncy_¡©
->
´oûs£d_cmds_rd
++;

15389 ià((
dev_Ï‹ncy_¡©
->
mš_sc¡_time_rd
 == 0) ||

15390 (
dev_Ï‹ncy_¡©
->
mš_sc¡_time_rd
 > 
sc¡_time
))

15391 
dev_Ï‹ncy_¡©
->
mš_sc¡_time_rd
 = 
sc¡_time
;

15392 ià((
dev_Ï‹ncy_¡©
->
mš_tgt_time_rd
 == 0) ||

15393 (
dev_Ï‹ncy_¡©
->
mš_tgt_time_rd
 > 
tgt_time
))

15394 
dev_Ï‹ncy_¡©
->
mš_tgt_time_rd
 = 
tgt_time
;

15395 ià((
dev_Ï‹ncy_¡©
->
mš_dev_time_rd
 == 0) ||

15396 (
dev_Ï‹ncy_¡©
->
mš_dev_time_rd
 > 
dev_time
))

15397 
dev_Ï‹ncy_¡©
->
mš_dev_time_rd
 = 
dev_time
;

15399 ià(
dev_Ï‹ncy_¡©
->
max_sc¡_time_rd
 < 
sc¡_time
)

15400 
dev_Ï‹ncy_¡©
->
max_sc¡_time_rd
 = 
sc¡_time
;

15401 ià(
dev_Ï‹ncy_¡©
->
max_tgt_time_rd
 < 
tgt_time
)

15402 
dev_Ï‹ncy_¡©
->
max_tgt_time_rd
 = 
tgt_time
;

15403 ià(
dev_Ï‹ncy_¡©
->
max_dev_time_rd
 < 
dev_time
)

15404 
dev_Ï‹ncy_¡©
->
max_dev_time_rd
 = 
dev_time
;

15406 } ià(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
) {

15407 
Ï‹ncy_¡©
->
sc¡_time_wr
 +ð
sc¡_time
;

15408 
Ï‹ncy_¡©
->
tgt_time_wr
 +ð
tgt_time
;

15409 
Ï‹ncy_¡©
->
dev_time_wr
 +ð
dev_time
;

15410 
Ï‹ncy_¡©
->
´oûs£d_cmds_wr
++;

15412 ià((
Ï‹ncy_¡©
->
mš_sc¡_time_wr
 == 0) ||

15413 (
Ï‹ncy_¡©
->
mš_sc¡_time_wr
 > 
sc¡_time
))

15414 
Ï‹ncy_¡©
->
mš_sc¡_time_wr
 = 
sc¡_time
;

15415 ià((
Ï‹ncy_¡©
->
mš_tgt_time_wr
 == 0) ||

15416 (
Ï‹ncy_¡©
->
mš_tgt_time_wr
 > 
tgt_time
))

15417 
Ï‹ncy_¡©
->
mš_tgt_time_wr
 = 
tgt_time
;

15418 ià((
Ï‹ncy_¡©
->
mš_dev_time_wr
 == 0) ||

15419 (
Ï‹ncy_¡©
->
mš_dev_time_wr
 > 
dev_time
))

15420 
Ï‹ncy_¡©
->
mš_dev_time_wr
 = 
dev_time
;

15422 ià(
Ï‹ncy_¡©
->
max_sc¡_time_wr
 < 
sc¡_time
)

15423 
Ï‹ncy_¡©
->
max_sc¡_time_wr
 = 
sc¡_time
;

15424 ià(
Ï‹ncy_¡©
->
max_tgt_time_wr
 < 
tgt_time
)

15425 
Ï‹ncy_¡©
->
max_tgt_time_wr
 = 
tgt_time
;

15426 ià(
Ï‹ncy_¡©
->
max_dev_time_wr
 < 
dev_time
)

15427 
Ï‹ncy_¡©
->
max_dev_time_wr
 = 
dev_time
;

15429 ià(
dev_Ï‹ncy_¡©
 !ð
NULL
) {

15430 
dev_Ï‹ncy_¡©
->
sc¡_time_wr
 +ð
sc¡_time
;

15431 
dev_Ï‹ncy_¡©
->
tgt_time_wr
 +ð
tgt_time
;

15432 
dev_Ï‹ncy_¡©
->
dev_time_wr
 +ð
dev_time
;

15433 
dev_Ï‹ncy_¡©
->
´oûs£d_cmds_wr
++;

15435 ià((
dev_Ï‹ncy_¡©
->
mš_sc¡_time_wr
 == 0) ||

15436 (
dev_Ï‹ncy_¡©
->
mš_sc¡_time_wr
 > 
sc¡_time
))

15437 
dev_Ï‹ncy_¡©
->
mš_sc¡_time_wr
 = 
sc¡_time
;

15438 ià((
dev_Ï‹ncy_¡©
->
mš_tgt_time_wr
 == 0) ||

15439 (
dev_Ï‹ncy_¡©
->
mš_tgt_time_wr
 > 
tgt_time
))

15440 
dev_Ï‹ncy_¡©
->
mš_tgt_time_wr
 = 
tgt_time
;

15441 ià((
dev_Ï‹ncy_¡©
->
mš_dev_time_wr
 == 0) ||

15442 (
dev_Ï‹ncy_¡©
->
mš_dev_time_wr
 > 
dev_time
))

15443 
dev_Ï‹ncy_¡©
->
mš_dev_time_wr
 = 
dev_time
;

15445 ià(
dev_Ï‹ncy_¡©
->
max_sc¡_time_wr
 < 
sc¡_time
)

15446 
dev_Ï‹ncy_¡©
->
max_sc¡_time_wr
 = 
sc¡_time
;

15447 ià(
dev_Ï‹ncy_¡©
->
max_tgt_time_wr
 < 
tgt_time
)

15448 
dev_Ï‹ncy_¡©
->
max_tgt_time_wr
 = 
tgt_time
;

15449 ià(
dev_Ï‹ncy_¡©
->
max_dev_time_wr
 < 
dev_time
)

15450 
dev_Ï‹ncy_¡©
->
max_dev_time_wr
 = 
dev_time
;

15454 
	`¥š_uÆock_bh
(&
£ss
->
Ït_lock
);

15456 
	`TRACE_DBG
("cmd %p: finish %lld, scst_time %lld, "

15457 "tgt_tim%Îd, dev_tim%Îd", 
cmd
, 
fšish
, 
sc¡_time
,

15458 
tgt_time
, 
dev_time
);

15460 
	}
}

	@scst/src/scst_main.c

19 
	~<lšux/moduË.h
>

21 
	~<lšux/š™.h
>

22 
	~<lšux/k”Ãl.h
>

23 
	~<lšux/”ºo.h
>

24 
	~<lšux/li¡.h
>

25 
	~<lšux/¥šlock.h
>

26 
	~<lšux/¦ab.h
>

27 
	~<lšux/sched.h
>

28 
	~<lšux/uni¡d.h
>

29 
	~<lšux/¡ršg.h
>

30 
	~<lšux/kth»ad.h
>

31 
	~<lšux/d–ay.h
>

32 
	~<lšux/lockd•.h
>

34 #ifdeà
INSIDE_KERNEL_TREE


35 
	~<sc¡/sc¡.h
>

37 
	~"sc¡.h
"

39 
	~"sc¡_´iv.h
"

40 
	~"sc¡_mem.h
"

41 
	~"sc¡_´es.h
"

43 #ià
defšed
(
CONFIG_HIGHMEM4G
è|| defšed(
CONFIG_HIGHMEM64G
)

44 #w¬nšg 
HIGHMEM
 
k”Ãl
 
cÚfigu¿tiÚs
 
¬e
 
fuÎy
 
suµÜ‹d
, 
but
 
nÙ
 \

45 
»comm’ded
 
³rfÜmªû
 
	g»asÚs
. 
CÚsid”
 
chªgšg
 
	gVMSPLIT
 \

46 
ÝtiÚ
 
Ü
 
u£
 
	ga
 64-
b™
 
cÚfigu¿tiÚ
 
	gš¡—d
. 
S“
 
README
 
fže
 \

47 
	gd‘ažs
.

50 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 30) && \

51 !
defšed
(
SCSI_EXEC_REQ_FIFO_DEFINED
) && \

52 !
	$defšed
(
CONFIG_SCST_STRICT_SERIALIZING
)

53 #w¬nšg 
P©ch
 
sc¡_exec_»q_fifo
-<
k”Ãl
-
v”siÚ
> 
was
 
nÙ
 
­¶›d
 
Ú
 \

54 
your
 
k”Ãl
 
ªd
 
CONFIG_SCST_STRICT_SERIALIZING
 
is
 
nÙ
 
defšed
. \

55 
Pass
-
through
 
dev
 
hªdËrs
 
wžl
 
nÙ
 
wÜk
.

73 
mu‹x
 
sc¡_mu‹x
;

74 
	`EXPORT_SYMBOL_GPL
(
sc¡_mu‹x
);

82 
mu‹x
 
sc¡_mu‹x2
;

85 
li¡_h—d
 
sc¡_‹m¶©e_li¡
;

86 
li¡_h—d
 
sc¡_dev_li¡
;

89 
li¡_h—d
 
sc¡_dev_ty³_li¡
;

90 
li¡_h—d
 
sc¡_vœtu®_dev_ty³_li¡
;

92 
kmem_ÿche
 *
sc¡_mgmt_ÿch•
;

93 
mempoÞ_t
 *
sc¡_mgmt_mempoÞ
;

94 
kmem_ÿche
 *
sc¡_mgmt_¡ub_ÿch•
;

95 
mempoÞ_t
 *
sc¡_mgmt_¡ub_mempoÞ
;

96 
kmem_ÿche
 *
sc¡_ua_ÿch•
;

97 
mempoÞ_t
 *
sc¡_ua_mempoÞ
;

98 
kmem_ÿche
 *
sc¡_£n£_ÿch•
;

99 
mempoÞ_t
 *
sc¡_£n£_mempoÞ
;

100 
kmem_ÿche
 *
sc¡_«n_ÿch•
;

101 
mempoÞ_t
 *
sc¡_«n_mempoÞ
;

102 
kmem_ÿche
 *
sc¡_tgt_ÿch•
;

103 
kmem_ÿche
 *
sc¡_dev_ÿch•
;

104 
kmem_ÿche
 *
sc¡_tgtd_ÿch•
;

105 
kmem_ÿche
 *
sc¡_£ss_ÿch•
;

106 
kmem_ÿche
 *
sc¡_acgd_ÿch•
;

108 #ifdeà
CONFIG_SCST_PROC


109 
li¡_h—d
 
sc¡_acg_li¡
;

110 
sc¡_acg
 *
sc¡_deçuÉ_acg
;

112 
sc¡_£tup_id
;

115 
¥šlock_t
 
sc¡_š™_lock
;

116 
wa™_queue_h—d_t
 
sc¡_š™_cmd_li¡_wa™Q
;

117 
li¡_h—d
 
sc¡_š™_cmd_li¡
;

118 
sc¡_š™_pÞl_út
;

120 
kmem_ÿche
 *
sc¡_cmd_ÿch•
;

122 #ià
	`defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

123 
sc¡_Œaû_æag
;

126 
sc¡_max_skËt_cmd
 = 
SCST_DEF_MAX_TASKLET_CMD
;

128 
sc¡_æags
;

130 
sc¡_cmd_th»ads
 
sc¡_maš_cmd_th»ads
;

132 
sc¡_³rýu_šfo
 
sc¡_³rýu_šfos
[
NR_CPUS
];

134 
¥šlock_t
 
sc¡_mcmd_lock
;

135 
li¡_h—d
 
sc¡_aùive_mgmt_cmd_li¡
;

136 
li¡_h—d
 
sc¡_d–ayed_mgmt_cmd_li¡
;

137 
wa™_queue_h—d_t
 
sc¡_mgmt_cmd_li¡_wa™Q
;

139 
wa™_queue_h—d_t
 
sc¡_mgmt_wa™Q
;

140 
¥šlock_t
 
sc¡_mgmt_lock
;

141 
li¡_h—d
 
sc¡_£ss_š™_li¡
;

142 
li¡_h—d
 
sc¡_£ss_shut_li¡
;

144 
wa™_queue_h—d_t
 
sc¡_dev_cmd_wa™Q
;

146 
mu‹x
 
sc¡_cmd_th»ads_mu‹x
;

148 
li¡_h—d
 
sc¡_cmd_th»ads_li¡
;

150 
sc¡_th»ads
;

151 
sk_¡ruù
 *
sc¡_š™_cmd_th»ad
;

152 
sk_¡ruù
 *
sc¡_mgmt_th»ad
;

153 
sk_¡ruù
 *
sc¡_mgmt_cmd_th»ad
;

159 
mu‹x
 
sc¡_su¥’d_mu‹x
;

160 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 29)

161 #ifdeà
CONFIG_LOCKDEP


162 
lock_þass_key
 
sc¡_su¥’d_key
;

163 
lockd•_m­
 
sc¡_su¥’d_d•_m­
 =

164 
	`STATIC_LOCKDEP_MAP_INIT
("sc¡_su¥’d_aùiv™y", &
sc¡_su¥’d_key
);

169 
su¥’d_couÁ
;

171 
sc¡_vœt_dev_Ï¡_id
;

173 
ýumask_t
 
deçuÉ_ýu_mask
;

175 
sc¡_max_cmd_mem
;

176 
sc¡_max_dev_cmd_mem
;

177 
sc¡_fÜcibly_þo£_£ssiÚs
;

179 
	`moduË_·¿m_Çmed
(
sc¡_th»ads
, scst_threads, , 0);

180 
	`MODULE_PARM_DESC
(
sc¡_th»ads
, "SCSIargethreads count");

182 
	`moduË_·¿m_Çmed
(
sc¡_max_cmd_mem
, sc¡_max_cmd_mem, , 
S_IRUGO
);

183 
	`MODULE_PARM_DESC
(
sc¡_max_cmd_mem
, "Maximum memory‡llowedo be consumed by "

186 
	`moduË_·¿m_Çmed
(
sc¡_max_dev_cmd_mem
, sc¡_max_dev_cmd_mem, , 
S_IRUGO
);

187 
	`MODULE_PARM_DESC
(
sc¡_max_dev_cmd_mem
, "Maximum memory‡llowedo be consumed "

190 
	`moduË_·¿m_Çmed
(
fÜcibly_þo£_£ssiÚs
, 
sc¡_fÜcibly_þo£_£ssiÚs
, ,

191 
S_IWUSR
 | 
S_IRUGO
);

192 
	`MODULE_PARM_DESC
(
fÜcibly_þo£_£ssiÚs
,

197 
sc¡_dev_ty³
 
sc¡_nuÎ_devty³
 = {

198 .
Çme
 = "none",

199 .
th»ads_num
 = -1,

200 
	}
};

202 
__sc¡_»sume_aùiv™y
();

218 
	$__sc¡_»gi¡”_rg‘_‹m¶©e
(
sc¡_tgt_‹m¶©e
 *
v‰
,

219 cÚ¡ *
v”siÚ
)

221 
»s
 = 0;

222 
sc¡_tgt_‹m¶©e
 *
t
;

224 
	`TRACE_ENTRY
();

226 
	`INIT_LIST_HEAD
(&
v‰
->
tgt_li¡
);

228 ià(
	`¡rcmp
(
v”siÚ
, 
SCST_INTERFACE_VERSION
) != 0) {

229 
	`PRINT_ERROR
("IncÜ»ù v”siÚ oàrg‘ %s", 
v‰
->
Çme
);

230 
»s
 = -
EINVAL
;

231 
out
;

234 ià(
v‰
->
d‘eù
)

235 
	`PRINT_WARNING
("detect() method is obsolete‡nd scheduled for "

236 "»mov® (rg‘ driv” %s)", 
v‰
->
Çme
);

238 ià(!
v‰
->
»Ëa£
) {

239 
	`PRINT_ERROR
("Target driver %s must have "

240 "»Ëa£(èm‘hod.", 
v‰
->
Çme
);

241 
»s
 = -
EINVAL
;

242 
out
;

245 ià(!
v‰
->
xm™_»¥Ú£
) {

246 
	`PRINT_ERROR
("Target driver %s must have "

247 "xm™_»¥Ú£(èm‘hod.", 
v‰
->
Çme
);

248 
»s
 = -
EINVAL
;

249 
out
;

252 ià(
v‰
->
g‘_š™ŸtÜ_pÜt_Œª¥Üt_id
 =ð
NULL
)

253 
	`PRINT_WARNING
("Target driver %s doesn't support Persistent "

254 "Re£rv©iÚs", 
v‰
->
Çme
);

256 ià(
v‰
->
th»ads_num
 < 0) {

257 
	`PRINT_ERROR
("Wronghreads_num value %d for "

258 "rg‘ \"%s\"", 
v‰
->
th»ads_num
,

259 
v‰
->
Çme
);

260 
»s
 = -
EINVAL
;

261 
out
;

264 #iâdeà
CONFIG_SCST_PROC


265 ià((!
v‰
->
’abË_rg‘
 || !v‰->
is_rg‘_’abËd
) &&

266 !
v‰
->
’abËd_©Œ_nÙ_Ãeded
)

267 
	`PRINT_WARNING
("Target driver %s doesn't haveƒnable_target() "

271 "deviû Ü‚Ødeviû ©‡Î!", 
v‰
->
Çme
);

273 ià(((
v‰
->
add_rg‘
 !ð
NULL
è&& (v‰->
d–_rg‘
 == NULL)) ||

274 ((
v‰
->
add_rg‘
 =ð
NULL
è&& (v‰->
d–_rg‘
 != NULL))) {

275 
	`PRINT_ERROR
("Target driver %s mustƒither define both "

276 "add_rg‘(èªd d–_rg‘(), o¸nÚe.", 
v‰
->
Çme
);

277 
»s
 = -
EINVAL
;

278 
out
;

282 ià(
v‰
->
rdy_to_xãr
 =ð
NULL
)

283 
v‰
->
rdy_to_xãr_©omic
 = 1;

285 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

286 ià(
»s
 != 0)

287 
out
;

288 
	`li¡_fÜ_—ch_’Œy
(
t
, &
sc¡_‹m¶©e_li¡
, 
sc¡_‹m¶©e_li¡_’Œy
) {

289 ià(
	`¡rcmp
(
t
->
Çme
, 
v‰
->name) == 0) {

290 
	`PRINT_ERROR
("Target driver %s‡lready„egistered",

291 
v‰
->
Çme
);

292 
out_uÆock
;

295 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

297 #iâdeà
CONFIG_SCST_PROC


298 
»s
 = 
	`sc¡_tg‰_sysfs_ü—‹
(
v‰
);

299 ià(
»s
 != 0)

300 
out
;

302 ià(!
v‰
->
no_´oc_’Œy
) {

303 
»s
 = 
	`sc¡_bužd_´oc_rg‘_dœ_’Œ›s
(
v‰
);

304 ià(
»s
 < 0)

305 
out
;

309 
	`mu‹x_lock
(&
sc¡_mu‹x
);

310 
	`mu‹x_lock
(&
sc¡_mu‹x2
);

311 
	`li¡_add_ž
(&
v‰
->
sc¡_‹m¶©e_li¡_’Œy
, &
sc¡_‹m¶©e_li¡
);

312 
	`mu‹x_uÆock
(&
sc¡_mu‹x2
);

313 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

315 
	`TRACE_DBG
("%s", "Callingarget driver's detect()");

316 
»s
 = 
v‰
->
d‘eù
 ? v‰->
	`d‘eù
(vtt) : 0;

317 
	`TRACE_DBG
("T¬g‘ driv”' d‘eù(è»tuºed %d", 
»s
);

318 ià(
»s
 < 0) {

319 
	`PRINT_ERROR
("%s", "The detect()„outine failed");

320 
»s
 = -
EINVAL
;

321 
out_d–
;

324 
	`PRINT_INFO
("T¬g‘em¶©% »gi¡”ed sucûssfuÎy", 
v‰
->
Çme
);

326 
out
:

327 
	`TRACE_EXIT_RES
(
»s
);

328  
»s
;

330 
out_d–
:

331 #ifdeà
CONFIG_SCST_PROC


332 
	`sc¡_þ—nup_´oc_rg‘_dœ_’Œ›s
(
v‰
);

334 
	`sc¡_tg‰_sysfs_d–
(
v‰
);

337 
	`mu‹x_lock
(&
sc¡_mu‹x
);

339 
	`mu‹x_lock
(&
sc¡_mu‹x2
);

340 
	`li¡_d–
(&
v‰
->
sc¡_‹m¶©e_li¡_’Œy
);

341 
	`mu‹x_uÆock
(&
sc¡_mu‹x2
);

343 
out_uÆock
:

344 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

345 
out
;

346 
	}
}

347 
EXPORT_SYMBOL_GPL
(
__sc¡_»gi¡”_rg‘_‹m¶©e
);

349 
	$sc¡_check_nÚ_g¶_rg‘_‹m¶©e
(
sc¡_tgt_‹m¶©e
 *
v‰
)

351 
»s
;

353 
	`TRACE_ENTRY
();

355 ià(
v‰
->
sk_mgmt_afãùed_cmds_dÚe
 || v‰->
th»ads_num
 ||

356 
v‰
->
Ú_hw_³ndšg_cmd_timeout
) {

357 
	`PRINT_ERROR
("Not‡llowed functionality in‚on-GPL version for "

358 "rg‘em¶©%s", 
v‰
->
Çme
);

359 
»s
 = -
EPERM
;

360 
out
;

363 
»s
 = 0;

365 
out
:

366 
	`TRACE_EXIT_RES
(
»s
);

367  
»s
;

368 
	}
}

384 
	$__sc¡_»gi¡”_rg‘_‹m¶©e_nÚ_g¶
(
sc¡_tgt_‹m¶©e
 *
v‰
,

385 cÚ¡ *
v”siÚ
)

387 
»s
;

389 
	`TRACE_ENTRY
();

391 
»s
 = 
	`sc¡_check_nÚ_g¶_rg‘_‹m¶©e
(
v‰
);

392 ià(
»s
 != 0)

393 
out
;

395 
»s
 = 
	`__sc¡_»gi¡”_rg‘_‹m¶©e
(
v‰
, 
v”siÚ
);

397 
out
:

398 
	`TRACE_EXIT_RES
(
»s
);

399  
»s
;

400 
	}
}

401 
EXPORT_SYMBOL
(
__sc¡_»gi¡”_rg‘_‹m¶©e_nÚ_g¶
);

411 
	$sc¡_uÄegi¡”_rg‘_‹m¶©e
(
sc¡_tgt_‹m¶©e
 *
v‰
)

413 
sc¡_tgt
 *
tgt
;

414 
sc¡_tgt_‹m¶©e
 *
t
;

415 
found
 = 0;

417 
	`TRACE_ENTRY
();

419 
	`mu‹x_lock
(&
sc¡_mu‹x
);

421 
	`li¡_fÜ_—ch_’Œy
(
t
, &
sc¡_‹m¶©e_li¡
, 
sc¡_‹m¶©e_li¡_’Œy
) {

422 ià(
	`¡rcmp
(
t
->
Çme
, 
v‰
->name) == 0) {

423 
found
 = 1;

427 ià(!
found
) {

428 
	`PRINT_ERROR
("T¬g‘ driv” % i¢'ˆ»gi¡”ed", 
v‰
->
Çme
);

429 
out_”r_up
;

432 
	`mu‹x_lock
(&
sc¡_mu‹x2
);

433 
	`li¡_d–
(&
v‰
->
sc¡_‹m¶©e_li¡_’Œy
);

434 
	`mu‹x_uÆock
(&
sc¡_mu‹x2
);

436 #iâdeà
CONFIG_SCST_PROC


438 
v‰
->
tg‰_aùive_sysfs_wÜks_couÁ
 > 0) {

439 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

440 
	`m¦“p
(100);

441 
	`mu‹x_lock
(&
sc¡_mu‹x
);

445 !
	`li¡_em±y
(&
v‰
->
tgt_li¡
)) {

446 
tgt
 = 
	`li¡_fœ¡_’Œy
(&
v‰
->
tgt_li¡
, 
	`ty³of
(*tgt),

447 
tgt_li¡_’Œy
);

448 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

449 
	`sc¡_uÄegi¡”_rg‘
(
tgt
);

450 
	`mu‹x_lock
(&
sc¡_mu‹x
);

453 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

455 #ifdeà
CONFIG_SCST_PROC


456 
	`sc¡_þ—nup_´oc_rg‘_dœ_’Œ›s
(
v‰
);

458 
	`sc¡_tg‰_sysfs_d–
(
v‰
);

461 
	`PRINT_INFO
("T¬g‘em¶©% uÄegi¡”ed sucûssfuÎy", 
v‰
->
Çme
);

463 
out
:

464 
	`TRACE_EXIT
();

467 
out_”r_up
:

468 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

469 
out
;

470 
	}
}

471 
EXPORT_SYMBOL
(
sc¡_uÄegi¡”_rg‘_‹m¶©e
);

479 
sc¡_tgt
 *
	$sc¡_»gi¡”_rg‘
(
sc¡_tgt_‹m¶©e
 *
v‰
,

480 cÚ¡ *
rg‘_Çme
)

482 
sc¡_tgt
 *
tgt
, *
t
;

483 
rc
 = 0;

485 
	`TRACE_ENTRY
();

487 
rc
 = 
	`sc¡_®loc_tgt
(
v‰
, &
tgt
);

488 ià(
rc
 != 0)

489 
out
;

491 ià(
rg‘_Çme
 !ð
NULL
) {

492 #ifdeà
CONFIG_SCST_PROC


493 
tgt
->
deçuÉ_group_Çme
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%s_%s",

494 
SCST_DEFAULT_ACG_NAME
,

495 
rg‘_Çme
);

496 ià(
tgt
->
deçuÉ_group_Çme
 =ð
NULL
) {

497 
	`PRINT_ERROR
("Allocation of default "

498 "grou°Çmçžed (tgˆ%s)", 
rg‘_Çme
);

499 
rc
 = -
ENOMEM
;

500 
out_ä“_tgt
;

505 
tgt
->
tgt_Çme
 = 
	`k¡rdup
(
rg‘_Çme
, 
GFP_KERNEL
);

506 ià(
tgt
->
tgt_Çme
 =ð
NULL
) {

507 
	`PRINT_ERROR
("Allocation ofgt‚ame %s failed",

508 
rg‘_Çme
);

509 
rc
 = -
ENOMEM
;

510 
out_ä“_tgt
;

513 
tgt_num
;

515 
	`PRINT_WARNING
("Usage of‡utogenerated SCSTarget‚ames "

519 "Çme š¡—d", 
v‰
->
Çme
);

521 
tgt
->
tgt_Çme
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%s%s%d", 
v‰
->
Çme
,

522 
SCST_DEFAULT_TGT_NAME_SUFFIX
, 
tgt_num
);

523 ià(
tgt
->
tgt_Çme
 =ð
NULL
) {

524 
	`PRINT_ERROR
("Allocation ofgt‚ame failed "

525 "Ñem¶©Çm%s)", 
v‰
->
Çme
);

526 
rc
 = -
ENOMEM
;

527 
out_ä“_tgt
;

529 
tgt_num
++;

532 
rc
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

533 ià(
rc
 != 0)

534 
out_ä“_tgt
;

536 
	`li¡_fÜ_—ch_’Œy
(
t
, &
v‰
->
tgt_li¡
, 
tgt_li¡_’Œy
) {

537 ià(
	`¡rcmp
(
t
->
tgt_Çme
, 
tgt
->tgt_name) == 0) {

538 
	`PRINT_ERROR
("rg‘ % ®»adyƒxi¡s", 
tgt
->
tgt_Çme
);

539 
rc
 = -
EEXIST
;

540 
out_uÆock
;

544 #ifdeà
CONFIG_SCST_PROC


545 
rc
 = 
	`sc¡_bužd_´oc_rg‘_’Œ›s
(
tgt
);

546 ià(
rc
 < 0)

547 
out_uÆock
;

549 
rc
 = 
	`sc¡_tgt_sysfs_ü—‹
(
tgt
);

550 ià(
rc
 < 0)

551 
out_uÆock
;

553 
rc
 = 
	`sc¡_®loc_add_acg
(
tgt
,gt->
tgt_Çme
, 
çl£
, &tgt->
deçuÉ_acg
);

554 ià(
rc
 != 0)

555 
out_sysfs_d–
;

558 
	`mu‹x_lock
(&
sc¡_mu‹x2
);

559 
	`li¡_add_ž
(&
tgt
->
tgt_li¡_’Œy
, &
v‰
->
tgt_li¡
);

560 
	`mu‹x_uÆock
(&
sc¡_mu‹x2
);

562 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

564 #ifdeà
CONFIG_SCST_PROC


565 
	`PRINT_INFO
("Target %s (relativearget id %d) foremplate %s„egistered "

566 "sucûssfuÎy", 
tgt
->
tgt_Çme
,gt->
»l_tgt_id
, 
v‰
->
Çme
);

568 
	`PRINT_INFO
("Target %s foremplate %s„egistered successfully",

569 
tgt
->
tgt_Çme
, 
v‰
->
Çme
);

572 
	`TRACE_DBG
("tgˆ%p", 
tgt
);

574 
out
:

575 
	`TRACE_EXIT
();

576  
tgt
;

578 #iâdeà
CONFIG_SCST_PROC


579 
out_sysfs_d–
:

580 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

581 
	`sc¡_tgt_sysfs_d–
(
tgt
);

582 
out_ä“_tgt
;

585 
out_uÆock
:

586 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

588 
out_ä“_tgt
:

590 
	`sc¡_ä“_tgt
(
tgt
);

591 
tgt
 = 
NULL
;

592 
out
;

593 
	}
}

594 
EXPORT_SYMBOL
(
sc¡_»gi¡”_rg‘
);

602 
	$sc¡_uÄegi¡”_rg‘
(
sc¡_tgt
 *
tgt
)

604 
sc¡_tgt_‹m¶©e
 *
v‰
 = 
tgt
->
tg‰
;

605 #iâdeà
CONFIG_SCST_PROC


606 
sc¡_acg
 *
acg
, *
acg_tmp
;

609 
	`TRACE_ENTRY
();

616 #ifdeà
CONFIG_SCST_PROC


617 
	`sc¡_þ—nup_´oc_rg‘_’Œ›s
(
tgt
);

619 
	`sc¡_tgt_sysfs_d–
(
tgt
);

622 
	`TRACE_DBG
("%s", "Callingarget driver's„elease()");

623 
tgt
->
tg‰
->
	`»Ëa£
(tgt);

624 
	`TRACE_DBG
("%s", "Target driver's„elease()„eturned");

627 
	`mu‹x_lock
(&
sc¡_mu‹x
);

628 
agaš
:

630 
sc¡_£ssiÚ
 *
£ss
;

632 
	`li¡_fÜ_—ch_’Œy
(
£ss
, &
tgt
->
£ss_li¡
, 
£ss_li¡_’Œy
) {

633 ià(
£ss
->
shut_pha£
 =ð
SCST_SESS_SPH_READY
) {

638 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

639 
	`sc¡_uÄegi¡”_£ssiÚ
(
£ss
, 0, 
NULL
);

640 
	`mu‹x_lock
(&
sc¡_mu‹x
);

641 
agaš
;

645 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

660 
	`TRACE_DBG
("%s", "Waiting for sessions shutdown");

661 
	`wa™_ev’t
(
tgt
->
uÄeg_wa™Q
, 
	`li¡_em±y
(&tgt->
sysfs_£ss_li¡
));

662 
	`TRACE_DBG
("%s", "wait_event()„eturned");

664 
	`sc¡_su¥’d_aùiv™y
(
SCST_SUSPEND_TIMEOUT_UNLIMITED
);

665 
	`mu‹x_lock
(&
sc¡_mu‹x
);

667 
	`mu‹x_lock
(&
sc¡_mu‹x2
);

668 
	`li¡_d–
(&
tgt
->
tgt_li¡_’Œy
);

669 
	`mu‹x_uÆock
(&
sc¡_mu‹x2
);

671 
	`d–_tim”_sync
(&
tgt
->
»Œy_tim”
);

673 
	`sc¡_tg_tgt_»move_by_tgt
(
tgt
);

675 #iâdeà
CONFIG_SCST_PROC


676 
	`sc¡_d–_ä“_acg
(
tgt
->
deçuÉ_acg
, 
çl£
);

678 
	`li¡_fÜ_—ch_’Œy_§ã
(
acg
, 
acg_tmp
, &
tgt
->
tgt_acg_li¡
,

679 
acg_li¡_’Œy
) {

680 
	`sc¡_d–_ä“_acg
(
acg
, 
çl£
);

684 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

685 
	`sc¡_»sume_aùiv™y
();

687 #iâdeà
CONFIG_SCST_PROC


688 
	`sc¡_tgt_sysfs_put
(
tgt
);

691 
	`PRINT_INFO
("Target %s foremplate %s unregistered successfully",

692 
tgt
->
tgt_Çme
, 
v‰
->
Çme
);

694 
	`sc¡_ä“_tgt
(
tgt
);

696 
	`TRACE_DBG
("UÄegi¡”šggˆ%°fšished", 
tgt
);

698 
	`TRACE_EXIT
();

700 
	}
}

701 
EXPORT_SYMBOL
(
sc¡_uÄegi¡”_rg‘
);

703 cÚ¡ *cÚ¡ 
	gsc¡_cmd_¡©e_Çme
[] = {

704 [
SCST_CMD_STATE_PARSE
] = "PARSE",

705 [
SCST_CMD_STATE_PREPARE_SPACE
] = "PREPARE_SPACE",

706 [
SCST_CMD_STATE_PREPROCESSING_DONE
] = "PREP_DONE",

707 [
SCST_CMD_STATE_RDY_TO_XFER
] = "RDY_TO_XFER",

708 [
SCST_CMD_STATE_TGT_PRE_EXEC
] = "TGT_PRE_EXEC",

709 [
SCST_CMD_STATE_EXEC_CHECK_SN
] = "EXEC_CHECK_SN",

710 [
SCST_CMD_STATE_PRE_DEV_DONE
] = "PRE_DEV_DONE",

711 [
SCST_CMD_STATE_MODE_SELECT_CHECKS
] = "MODE_SELECT_CHECKS",

712 [
SCST_CMD_STATE_DEV_DONE
] = "DEV_DONE",

713 [
SCST_CMD_STATE_PRE_XMIT_RESP
] = "PRE_XMIT_RESP",

714 [
SCST_CMD_STATE_XMIT_RESP
] = "XMIT_RESP",

715 [
SCST_CMD_STATE_FINISHED
] = "FINISHED",

716 [
SCST_CMD_STATE_FINISHED_INTERNAL
] = "FINISHED_INTERNAL",

717 [
SCST_CMD_STATE_INIT_WAIT
] = "INIT_WAIT",

718 [
SCST_CMD_STATE_INIT
] = "INIT",

719 [
SCST_CMD_STATE_PREPROCESSING_DONE_CALLED
] = "PREP_DONE_CALLED",

720 [
SCST_CMD_STATE_DATA_WAIT
] = "DATA_WAIT",

721 [
SCST_CMD_STATE_EXEC_CHECK_BLOCKING
] = "EXEC_CHECK_BLOCKING",

722 [
SCST_CMD_STATE_LOCAL_EXEC
] = "LOCAL_EXEC",

723 [
SCST_CMD_STATE_REAL_EXEC
] = "REAL_EXEC",

724 [
SCST_CMD_STATE_EXEC_WAIT
] = "EXEC_WAIT",

725 [
SCST_CMD_STATE_XMIT_WAIT
] = "XMIT_WAIT",

728 *
	$sc¡_g‘_cmd_¡©e_Çme
(*
Çme
, 
Ën
, 
¡©e
)

730 ià(
¡©e
 < 
	`ARRAY_SIZE
(
sc¡_cmd_¡©e_Çme
) &&

731 
sc¡_cmd_¡©e_Çme
[
¡©e
])

732 
	`¡¾ýy
(
Çme
, 
sc¡_cmd_¡©e_Çme
[
¡©e
], 
Ën
);

734 
	`¢´štf
(
Çme
, 
Ën
, "%d", 
¡©e
);

735  
Çme
;

736 
	}
}

738 *
	$sc¡_dump_cdb
(*
buf
, 
buf_Ën
, 
sc¡_cmd
 *
cmd
)

740 *
p
 = 
buf
, *
’d
 = buà+ 
buf_Ën
;

741 
i
;

743 
i
 = 0; i < 
cmd
->
cdb_Ën
 && 
p
 < 
’d
; i++)

744 
p
 +ð
	`sú´štf
Õ, 
’d
 -…, "%s%02x", 
i
 ? " " : "", 
cmd
->
cdb
[i]);

746  
buf
;

747 
	}
}

749 
	$sc¡_Œaû_cmds
(
sc¡_show_â
 
show
, *
¬g
)

751 
sc¡_tgt_‹m¶©e
 *
t
;

752 
sc¡_tgt
 *
tgt
;

753 
sc¡_£ssiÚ
 *
£ss
;

754 
sc¡_cmd
 *
cmd
;

755 
sc¡_tgt_dev
 *
tgt_dev
;

756 
¡©e_Çme
[32];

757 
cdb
[64];

759 
	`mu‹x_lock
(&
sc¡_mu‹x
);

760 
	`li¡_fÜ_—ch_’Œy
(
t
, &
sc¡_‹m¶©e_li¡
, 
sc¡_‹m¶©e_li¡_’Œy
) {

761 
	`li¡_fÜ_—ch_’Œy
(
tgt
, &
t
->
tgt_li¡
, 
tgt_li¡_’Œy
) {

762 
	`li¡_fÜ_—ch_’Œy
(
£ss
, &
tgt
->
£ss_li¡
,

763 
£ss_li¡_’Œy
) {

764 
	`¥š_lock_œq
(&
£ss
->
£ss_li¡_lock
);

765 
	`li¡_fÜ_—ch_’Œy
(
cmd
, &
£ss
->
£ss_cmd_li¡
,

766 
£ss_cmd_li¡_’Œy
) {

767 
tgt_dev
 = 
cmd
->tgt_dev;

768 
	`sc¡_dump_cdb
(
cdb
, (cdb), 
cmd
);

769 
	`sc¡_g‘_cmd_¡©e_Çme
(
¡©e_Çme
,

770 (
¡©e_Çme
),

771 
cmd
->
¡©e
);

772 
	`show
(
¬g
, "cmd %p: state %s; op %s; "

776 
cmd
, 
¡©e_Çme
,

777 
	`sc¡_g‘_Ýcode_Çme
(
cmd
),

778 ()(
jiff›s
 - 
cmd
->
¡¬t_time
è/ 
HZ
,

779 
t
->
Çme
, 
tgt
->
tgt_Çme
, 
£ss
->
£ss_Çme
,

780 
tgt_dev
 ? (tgt_dev->
acg_dev
->
acg
->
acg_Çme
 ?

782 
cmd
->
lun
, 
£ss
->
š™ŸtÜ_Çme
, 
cdb
);

784 
	`¥š_uÆock_œq
(&
£ss
->
£ss_li¡_lock
);

788 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

790 
	}
}

792 cÚ¡ *cÚ¡ 
	gsc¡_tm_â_Çme
[] = {

793 [
SCST_ABORT_TASK
] = "ABORT_TASK",

794 [
SCST_ABORT_TASK_SET
] = "ABORT_TASK_SET",

795 [
SCST_CLEAR_ACA
] = "CLEAR_ACA",

796 [
SCST_CLEAR_TASK_SET
] = "CLEAR_TASK_SET",

797 [
SCST_LUN_RESET
] = "LUN_RESET",

798 [
SCST_TARGET_RESET
] = "TARGET_RESET",

799 [
SCST_NEXUS_LOSS_SESS
] = "NEXUS_LOSS_SESS",

800 [
SCST_ABORT_ALL_TASKS_SESS
] = "ABORT_ALL_TASKS_SESS",

801 [
SCST_NEXUS_LOSS
] = "NEXUS_LOSS",

802 [
SCST_ABORT_ALL_TASKS
] = "ABORT_ALL_TASKS",

803 [
SCST_UNREG_SESS_TM
] = "UNREG_SESS_TM",

804 [
SCST_PR_ABORT_ALL
] = "PR_ABORT_ALL",

807 *
	$sc¡_g‘_tm_â_Çme
(*
Çme
, 
Ën
, 
â
)

809 ià(
â
 < 
	`ARRAY_SIZE
(
sc¡_tm_â_Çme
) && scst_tm_fn_name[fn])

810 
	`¡¾ýy
(
Çme
, 
sc¡_tm_â_Çme
[
â
], 
Ën
);

812 
	`¢´štf
(
Çme
, 
Ën
, "%d", 
â
);

813  
Çme
;

814 
	}
}

816 cÚ¡ *cÚ¡ 
	gsc¡_mcmd_¡©e_Çme
[] = {

817 [
SCST_MCMD_STATE_INIT
] = "INIT",

818 [
SCST_MCMD_STATE_EXEC
] = "EXEC",

819 [
SCST_MCMD_STATE_WAITING_AFFECTED_CMDS_DONE
] = "WAITING_AFFECTED_CMDS_DONE",

820 [
SCST_MCMD_STATE_AFFECTED_CMDS_DONE
] = "AFFECTED_CMDS_DONE",

821 [
SCST_MCMD_STATE_WAITING_AFFECTED_CMDS_FINISHED
] = "WAITING_AFFECTED_CMDS_FINISHED",

822 [
SCST_MCMD_STATE_DONE
] = "DONE",

823 [
SCST_MCMD_STATE_FINISHED
] = "FINISHED",

826 *
	$sc¡_g‘_mcmd_¡©e_Çme
(*
Çme
, 
Ën
, 
¡©e
)

828 ià(
¡©e
 < 
	`ARRAY_SIZE
(
sc¡_mcmd_¡©e_Çme
) &&

829 
sc¡_mcmd_¡©e_Çme
[
¡©e
])

830 
	`¡¾ýy
(
Çme
, 
sc¡_mcmd_¡©e_Çme
[
¡©e
], 
Ën
);

832 
	`¢´štf
(
Çme
, 
Ën
, "%d", 
¡©e
);

833  
Çme
;

834 
	}
}

836 
	$sc¡_Œaû_mcmds
(
sc¡_show_â
 
show
, *
¬g
)

838 
sc¡_mgmt_cmd
 *
mcmd
;

839 
â_Çme
[16], 
¡©e_Çme
[32];

841 
	`¥š_lock_œq
(&
sc¡_mcmd_lock
);

842 
	`li¡_fÜ_—ch_’Œy
(
mcmd
, &
sc¡_aùive_mgmt_cmd_li¡
,

843 
mgmt_cmd_li¡_’Œy
) {

844 
	`sc¡_g‘_tm_â_Çme
(
â_Çme
, (â_Çme), 
mcmd
->
â
);

845 
	`sc¡_g‘_mcmd_¡©e_Çme
(
¡©e_Çme
, (state_name),

846 
mcmd
->
¡©e
);

847 
	`show
(
¬g
, "mcmd %p: state %s;gtt %s;gt %s; session %s; fn %s;"

849 
mcmd
, 
¡©e_Çme
, mcmd->
£ss
->
tgt
->
tg‰
->
Çme
,

850 
mcmd
->
£ss
->
tgt
->
tgt_Çme
, mcmd->£ss->
£ss_Çme
, 
â_Çme
,

851 
mcmd
->
lun
, mcmd->
g
, mcmd->
cmd_dÚe_wa™_couÁ
);

853 
	`¥š_uÆock_œq
(&
sc¡_mcmd_lock
);

855 
	}
}

857 
	$__´štf
(2, 3è
	$sc¡_to_sy¦og
(*
¬g
, cÚ¡ *
fmt
, ...)

859 
boÞ
 *
h—d”_´š‹d
 = 
¬g
;

860 
va_li¡
 
¬gs
;

862 ià(!*
h—d”_´š‹d
) {

863 
	`PRINT_INFO
("Pending commands:");

864 *
h—d”_´š‹d
 = 
Œue
;

867 
	`va_¡¬t
(
¬gs
, 
fmt
);

868 
	`´_šfo
(" ");

869 
	`v´štk
(
fmt
, 
¬gs
);

870 
	`va_’d
(
¬gs
);

872 
	}
}

874 
	$sc¡_g‘_cmd_couÁ”
()

876 
i
, 
»s
 = 0;

878 
i
 = 0; i < ()
	`ARRAY_SIZE
(
sc¡_³rýu_šfos
); i++)

879 
»s
 +ð
	`©omic_»ad
(&
sc¡_³rýu_šfos
[
i
].
ýu_cmd_couÁ
);

880  
»s
;

881 
	}
}

883 
	$sc¡_su¥_wa™
(
timeout
)

885 
»s
;

886 
t
;

887 
boÞ
 
hp
 = 
çl£
;

888 
	#SCST_SUSP_WAIT_REPORT_TIMEOUT
 (5UL * 
HZ
)

	)

890 
	`TRACE_ENTRY
();

892 ià(
timeout
 =ð
SCST_SUSPEND_TIMEOUT_UNLIMITED
)

893 
t
 = 
SCST_SUSP_WAIT_REPORT_TIMEOUT
;

895 
t
 = 
	`mš
(
timeout
, 
SCST_SUSP_WAIT_REPORT_TIMEOUT
);

897 
»s
 = 
	`wa™_ev’t_š‹¼u±ibË_timeout
(
sc¡_dev_cmd_wa™Q
,

898 (
	`sc¡_g‘_cmd_couÁ”
(è=ð0), 
t
);

899 ià(
»s
 > 0) {

900 
»s
 = 0;

901 
out
;

902 } ià((
»s
 < 0è&& (
timeout
 !ð
SCST_SUSPEND_TIMEOUT_UNLIMITED
))

903 
out
;

905 ià(
»s
 == 0) {

906 
	`PRINT_INFO
("%d‡ctive commandso still‚ot completed. See "

907 "README fÜ…ossibË„—sÚs.", 
	`sc¡_g‘_cmd_couÁ”
());

908 
	`sc¡_Œaû_cmds
(
sc¡_to_sy¦og
, &
hp
);

909 
	`sc¡_Œaû_mcmds
(
sc¡_to_sy¦og
, &
hp
);

912 ià(
timeout
 !ð
SCST_SUSPEND_TIMEOUT_UNLIMITED
) {

913 
»s
 = 
	`wa™_ev’t_š‹¼u±ibË_timeout
(
sc¡_dev_cmd_wa™Q
,

914 (
	`sc¡_g‘_cmd_couÁ”
(è=ð0), 
timeout
 - 
t
);

915 ià(
»s
 == 0)

916 
»s
 = -
EBUSY
;

917 ià(
»s
 > 0)

918 
»s
 = 0;

920 
	`wa™_ev’t
(
sc¡_dev_cmd_wa™Q
, 
	`sc¡_g‘_cmd_couÁ”
() == 0);

921 
»s
 = 0;

924 
out
:

925 
	`TRACE_MGMT_DBG
("wa™_ev’t(è»tuºed %d", 
»s
);

927 
	`TRACE_EXIT_RES
(
»s
);

928  
»s
;

929 #undeà
SCST_SUSP_WAIT_REPORT_TIMEOUT


930 
	}
}

946 
	$sc¡_su¥’d_aùiv™y
(
timeout
)

948 
»s
 = 0;

949 
boÞ
 
»p
 = 
çl£
;

950 
cur_time
 = 
jiff›s
, 
wa™_time
;

952 
	`TRACE_ENTRY
();

954 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 29)

955 
	`rwlock_acquœe_»ad
(&
sc¡_su¥’d_d•_m­
, 0, 0, 
_RET_IP_
);

958 ià(
timeout
 !ð
SCST_SUSPEND_TIMEOUT_UNLIMITED
) {

959 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_su¥’d_mu‹x
);

960 ià(
»s
 != 0)

961 
out
;

963 
	`mu‹x_lock
(&
sc¡_su¥’d_mu‹x
);

965 
	`TRACE_MGMT_DBG
("su¥’d_couÁ %d", 
su¥’d_couÁ
);

966 
su¥’d_couÁ
++;

967 ià(
su¥’d_couÁ
 > 1)

968 
out_up
;

970 
	`£t_b™
(
SCST_FLAG_SUSPENDING
, &
sc¡_æags
);

971 
	`£t_b™
(
SCST_FLAG_SUSPENDED
, &
sc¡_æags
);

977 
	`smp_mb__aá”_£t_b™
();

988 ià(
	`sc¡_g‘_cmd_couÁ”
() != 0) {

989 
	`PRINT_INFO
("Waiting for %d‡ctive commandso complete...",

990 
	`sc¡_g‘_cmd_couÁ”
());

991 
»p
 = 
Œue
;

993 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 29)

994 
	`lock_cÚ‹nded
(&
sc¡_su¥’d_d•_m­
, 
_RET_IP_
);

998 
»s
 = 
	`sc¡_su¥_wa™
(
timeout
);

999 ià(
»s
 != 0)

1000 
out_þ—r
;

1002 
	`þ—r_b™
(
SCST_FLAG_SUSPENDING
, &
sc¡_æags
);

1004 
	`smp_mb__aá”_þ—r_b™
();

1006 ià(
	`sc¡_g‘_cmd_couÁ”
() != 0)

1007 
	`TRACE_MGMT_DBG
("Waiting for %d‡ctive commands finallyo "

1008 "com¶‘e", 
	`sc¡_g‘_cmd_couÁ”
());

1010 ià(
timeout
 !ð
SCST_SUSPEND_TIMEOUT_UNLIMITED
) {

1011 
wa™_time
 = 
jiff›s
 - 
cur_time
;

1013 ià(
wa™_time
 >ð
timeout
) {

1014 
»s
 = -
EBUSY
;

1015 
out_»sume
;

1017 
wa™_time
 = 
timeout
 - wait_time;

1019 
wa™_time
 = 
SCST_SUSPEND_TIMEOUT_UNLIMITED
;

1021 
»s
 = 
	`sc¡_su¥_wa™
(
wa™_time
);

1022 ià(
»s
 != 0)

1023 
out_»sume
;

1025 ià(
»p
)

1026 
	`PRINT_INFO
("%s", "All‡ctive commands completed");

1028 
out_up
:

1029 
	`mu‹x_uÆock
(&
sc¡_su¥’d_mu‹x
);

1031 
out
:

1032 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 29)

1033 ià(
»s
 == 0)

1034 
	`lock_acquœed
(&
sc¡_su¥’d_d•_m­
, 
_RET_IP_
);

1036 
	`rwlock_»Ëa£
(&
sc¡_su¥’d_d•_m­
, 1, 
_RET_IP_
);

1039 
	`TRACE_EXIT_RES
(
»s
);

1040  
»s
;

1042 
out_þ—r
:

1043 
	`þ—r_b™
(
SCST_FLAG_SUSPENDING
, &
sc¡_æags
);

1045 
	`smp_mb__aá”_þ—r_b™
();

1047 
out_»sume
:

1048 
	`__sc¡_»sume_aùiv™y
();

1049 
	`EXTRACHECKS_BUG_ON
(
su¥’d_couÁ
 != 0);

1050 
out_up
;

1051 
	}
}

1052 
EXPORT_SYMBOL_GPL
(
sc¡_su¥’d_aùiv™y
);

1055 
	$__sc¡_»sume_aùiv™y
()

1057 
sc¡_cmd_th»ads
 *
l
;

1058 
sc¡_mgmt_cmd
 *
m
;

1060 
	`TRACE_ENTRY
();

1062 ià(
su¥’d_couÁ
 == 0) {

1063 
	`PRINT_WARNING
("Resume without suspend");

1064 
out
;

1067 
su¥’d_couÁ
--;

1068 
	`TRACE_MGMT_DBG
("su¥’d_couÁ %d†eá", 
su¥’d_couÁ
);

1069 ià(
su¥’d_couÁ
 > 0)

1070 
out
;

1072 
	`þ—r_b™
(
SCST_FLAG_SUSPENDED
, &
sc¡_æags
);

1074 
	`mu‹x_lock
(&
sc¡_cmd_th»ads_mu‹x
);

1075 
	`li¡_fÜ_—ch_’Œy
(
l
, &
sc¡_cmd_th»ads_li¡
, 
li¡s_li¡_’Œy
) {

1076 
	`wake_up_®l
(&
l
->
cmd_li¡_wa™Q
);

1078 
	`mu‹x_uÆock
(&
sc¡_cmd_th»ads_mu‹x
);

1084 
	`¥š_lock_œq
(&
sc¡_š™_lock
);

1085 
	`¥š_uÆock_œq
(&
sc¡_š™_lock
);

1087 
	`wake_up_®l
(&
sc¡_š™_cmd_li¡_wa™Q
);

1089 
	`¥š_lock_œq
(&
sc¡_mcmd_lock
);

1090 
	`li¡_fÜ_—ch_’Œy
(
m
, &
sc¡_d–ayed_mgmt_cmd_li¡
,

1091 
mgmt_cmd_li¡_’Œy
) {

1092 
	`TRACE_MGMT_DBG
("Moving delayed mgmt cmd %po head of‡ctive "

1093 "mgmˆcmd†i¡", 
m
);

1095 
	`li¡_¥liû
(&
sc¡_d–ayed_mgmt_cmd_li¡
, &
sc¡_aùive_mgmt_cmd_li¡
);

1096 
	`¥š_uÆock_œq
(&
sc¡_mcmd_lock
);

1098 
	`wake_up_®l
(&
sc¡_mgmt_cmd_li¡_wa™Q
);

1100 
out
:

1101 
	`TRACE_EXIT
();

1103 
	}
}

1110 
	$sc¡_»sume_aùiv™y
()

1112 
	`TRACE_ENTRY
();

1114 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 29)

1115 
	`rwlock_»Ëa£
(&
sc¡_su¥’d_d•_m­
, 1, 
_RET_IP_
);

1118 
	`mu‹x_lock
(&
sc¡_su¥’d_mu‹x
);

1119 
	`__sc¡_»sume_aùiv™y
();

1120 
	`mu‹x_uÆock
(&
sc¡_su¥’d_mu‹x
);

1122 
	`TRACE_EXIT
();

1124 
	}
}

1125 
EXPORT_SYMBOL_GPL
(
sc¡_»sume_aùiv™y
);

1127 
	$sc¡_g‘_su¥’d_couÁ
()

1129  
su¥’d_couÁ
;

1130 
	}
}

1132 
	$sc¡_»gi¡”_deviû
(
scsi_deviû
 *
scsidp
)

1134 
»s
;

1135 
sc¡_deviû
 *
dev
, *
d
;

1136 #ifdeà
CONFIG_SCST_PROC


1137 
sc¡_dev_ty³
 *
dt
;

1140 
	`TRACE_ENTRY
();

1142 #ifdeà
CONFIG_SCST_PROC


1143 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
SCST_SUSPEND_TIMEOUT_USER
);

1144 ià(
»s
 != 0)

1145 
out
;

1148 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

1149 ià(
»s
 != 0)

1150 #ifdeà
CONFIG_SCST_PROC


1151 
out_»sume
;

1153 
out
;

1156 
»s
 = 
	`sc¡_®loc_deviû
(
GFP_KERNEL
, &
dev
);

1157 ià(
»s
 != 0)

1158 
out_uÆock
;

1160 
dev
->
ty³
 = 
scsidp
->type;

1162 
dev
->
vœt_Çme
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%d:%d:%d:%lld",

1163 
scsidp
->
ho¡
->
ho¡_no
, scsidp->
chªÃl
,

1164 
scsidp
->
id
, (
u64
)scsidp->
lun
);

1165 ià(
dev
->
vœt_Çme
 =ð
NULL
) {

1166 
	`PRINT_ERROR
("%s", "Unableo‡lloc device‚ame");

1167 
»s
 = -
ENOMEM
;

1168 
out_ä“_dev
;

1171 
	`li¡_fÜ_—ch_’Œy
(
d
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

1172 ià(
	`¡rcmp
(
d
->
vœt_Çme
, 
dev
->virt_name) == 0) {

1173 
	`PRINT_ERROR
("Deviû % ®»adyƒxi¡s", 
dev
->
vœt_Çme
);

1174 
»s
 = -
EEXIST
;

1175 
out_ä“_dev
;

1179 
dev
->
scsi_dev
 = 
scsidp
;

1181 
	`li¡_add_ž
(&
dev
->
dev_li¡_’Œy
, &
sc¡_dev_li¡
);

1183 #ifdeà
CONFIG_SCST_PROC


1188 
	`li¡_fÜ_—ch_’Œy
(
dt
, &
sc¡_dev_ty³_li¡
, 
dev_ty³_li¡_’Œy
) {

1189 ià(
dt
->
ty³
 =ð
scsidp
->type) {

1190 
»s
 = 
	`sc¡_assign_dev_hªdËr
(
dev
, 
dt
);

1191 ià(
»s
 != 0)

1192 
out_d–_locked
;

1197 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1198 
	`sc¡_»sume_aùiv™y
();

1200 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1202 
»s
 = 
	`sc¡_dev_sysfs_ü—‹
(
dev
);

1203 ià(
»s
 != 0)

1204 
out_d–_uÆocked
;

1207 
	`PRINT_INFO
("Attachedo scsi%d, channel %d, id %d,†un %lld,ype %d",

1208 
scsidp
->
ho¡
->
ho¡_no
, scsidp->
chªÃl
, scsidp->
id
,

1209 (
u64
)
scsidp
->
lun
, scsidp->
ty³
);

1211 
out
:

1212 
	`TRACE_EXIT_RES
(
»s
);

1213  
»s
;

1215 #iâdeà
CONFIG_SCST_PROC


1216 
out_d–_uÆocked
:

1217 
	`mu‹x_lock
(&
sc¡_mu‹x
);

1218 
	`li¡_d–_š™
(&
dev
->
dev_li¡_’Œy
);

1219 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1221 
	`sc¡_ä“_deviû
(
dev
);

1222 
out
;

1224 
out_d–_locked
:

1225 
	`li¡_d–_š™
(&
dev
->
dev_li¡_’Œy
);

1228 
out_ä“_dev
:

1229 
	`sc¡_ä“_deviû
(
dev
);

1231 
out_uÆock
:

1232 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1233 #ifdeà
CONFIG_SCST_PROC


1234 
out_»sume
:

1235 
	`sc¡_»sume_aùiv™y
();

1237 
out
;

1238 
	}
}

1240 
sc¡_deviû
 *
	$__sc¡_lookup_deviû
(
scsi_deviû
 *
scsidp
)

1242 
sc¡_deviû
 *
d
;

1244 
	`lockd•_as£¹_h–d
(&
sc¡_mu‹x
);

1246 
	`li¡_fÜ_—ch_’Œy
(
d
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
)

1247 ià(
d
->
scsi_dev
 =ð
scsidp
)

1248  
d
;

1250  
NULL
;

1251 
	}
}

1253 
	$sc¡_uÄegi¡”_deviû
(
scsi_deviû
 *
scsidp
)

1255 
sc¡_deviû
 *
dev
;

1256 
sc¡_acg_dev
 *
acg_dev
, *
¯
;

1257 
boÞ
 
aùiv™y_su¥’ded
 = 
çl£
;

1259 
	`TRACE_ENTRY
();

1261 
	`mu‹x_lock
(&
sc¡_mu‹x
);

1263 
dev
 = 
	`__sc¡_lookup_deviû
(
scsidp
);

1265 ià(
dev
 &&

1266 (!
	`li¡_em±y
(&
dev
->
dev_tgt_dev_li¡
) ||

1267 !
	`li¡_em±y
(&
dev
->
dev_acg_dev_li¡
))) {

1268 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1270 
	`sc¡_su¥’d_aùiv™y
(
SCST_SUSPEND_TIMEOUT_UNLIMITED
);

1271 
aùiv™y_su¥’ded
 = 
Œue
;

1272 
	`mu‹x_lock
(&
sc¡_mu‹x
);

1273 
dev
 = 
	`__sc¡_lookup_deviû
(
scsidp
);

1276 ià(
dev
 =ð
NULL
) {

1277 
	`PRINT_ERROR
("SCST device for SCSI device %d:%d:%d:%lld‚ot found",

1278 
scsidp
->
ho¡
->
ho¡_no
, scsidp->
chªÃl
, scsidp->
id
,

1279 (
u64
)
scsidp
->
lun
);

1280 
out_uÆock
;

1283 
dev
->
dev_uÄegi¡”šg
 = 1;

1285 
	`li¡_d–_š™
(&
dev
->
dev_li¡_’Œy
);

1287 
	`sc¡_dg_dev_»move_by_dev
(
dev
);

1289 
	`sc¡_assign_dev_hªdËr
(
dev
, &
sc¡_nuÎ_devty³
);

1291 
	`li¡_fÜ_—ch_’Œy_§ã
(
acg_dev
, 
¯
, &
dev
->
dev_acg_dev_li¡
,

1292 
dev_acg_dev_li¡_’Œy
) {

1293 
	`sc¡_acg_d–_lun
(
acg_dev
->
acg
,‡cg_dev->
lun
, 
Œue
);

1296 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1298 ià(
aùiv™y_su¥’ded
)

1299 
	`sc¡_»sume_aùiv™y
();

1301 
	`sc¡_dev_sysfs_d–
(
dev
);

1303 
	`PRINT_INFO
("Detached from scsi%d, channel %d, id %d,†un %lld,ype %d",

1304 
scsidp
->
ho¡
->
ho¡_no
, scsidp->
chªÃl
, scsidp->
id
,

1305 (
u64
)
scsidp
->
lun
, scsidp->
ty³
);

1307 
	`sc¡_ä“_deviû
(
dev
);

1309 
out
:

1310 
	`TRACE_EXIT
();

1313 
out_uÆock
:

1314 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1315 ià(
aùiv™y_su¥’ded
)

1316 
	`sc¡_»sume_aùiv™y
();

1317 
out
;

1318 
	}
}

1320 
	$sc¡_dev_hªdËr_check
(
sc¡_dev_ty³
 *
dev_hªdËr
)

1322 
»s
 = 0;

1324 ià(
dev_hªdËr
->
·r£
 =ð
NULL
) {

1325 
	`PRINT_ERROR
("scst dev handler %s must have "

1326 "·r£(èm‘hod.", 
dev_hªdËr
->
Çme
);

1327 
»s
 = -
EINVAL
;

1328 
out
;

1331 #iâdeà
CONFIG_SCST_PROC


1332 ià(((
dev_hªdËr
->
add_deviû
 !ð
NULL
) &&

1333 (
dev_hªdËr
->
d–_deviû
 =ð
NULL
)) ||

1334 ((
dev_hªdËr
->
add_deviû
 =ð
NULL
) &&

1335 (
dev_hªdËr
->
d–_deviû
 !ð
NULL
))) {

1336 
	`PRINT_ERROR
("Dev handler %s mustƒither define both "

1338 
dev_hªdËr
->
Çme
);

1339 
»s
 = -
EINVAL
;

1340 
out
;

1344 ià(
dev_hªdËr
->
dev_®loc_d©a_buf
 =ð
NULL
)

1345 
dev_hªdËr
->
dev_®loc_d©a_buf_©omic
 = 1;

1347 ià(
dev_hªdËr
->
dev_dÚe
 =ð
NULL
)

1348 
dev_hªdËr
->
dev_dÚe_©omic
 = 1;

1350 
out
:

1351 
	`TRACE_EXIT_RES
(
»s
);

1352  
»s
;

1353 
	}
}

1355 
	$sc¡_check_deviû_Çme
(cÚ¡ *
dev_Çme
)

1357 
»s
 = 0;

1359 ià(
	`¡rchr
(
dev_Çme
, '/'è!ð
NULL
) {

1360 
	`PRINT_ERROR
("Dev‚ame %s contains illegal character '/'",

1361 
dev_Çme
);

1362 
»s
 = -
EINVAL
;

1363 
out
;

1367 ià(
	`¡rchr
(
dev_Çme
, '.'è!ð
NULL
) {

1368 
	`PRINT_ERROR
("Dev‚ame %s contains illegal character '.'",

1369 
dev_Çme
);

1370 
»s
 = -
EINVAL
;

1371 
out
;

1374 
out
:

1375 
	`TRACE_EXIT_RES
(
»s
);

1376  
»s
;

1377 
	}
}

1388 
	$sc¡_»gi¡”_vœtu®_deviû
(
sc¡_dev_ty³
 *
dev_hªdËr
,

1389 cÚ¡ *
dev_Çme
)

1391 
»s
;

1392 
sc¡_deviû
 *
dev
, *
d
;

1393 
boÞ
 
sysfs_d–
 = 
çl£
;

1395 
	`TRACE_ENTRY
();

1397 ià(
dev_hªdËr
 =ð
NULL
) {

1398 
	`PRINT_ERROR
("%s: valid device handler must be supplied",

1399 
__func__
);

1400 
»s
 = -
EINVAL
;

1401 
out
;

1404 ià(
dev_Çme
 =ð
NULL
) {

1405 
	`PRINT_ERROR
("%s: deviû‚ammu¡ bnÚ-NULL", 
__func__
);

1406 
»s
 = -
EINVAL
;

1407 
out
;

1410 
»s
 = 
	`sc¡_check_deviû_Çme
(
dev_Çme
);

1411 ià(
»s
 != 0)

1412 
out
;

1414 
»s
 = 
	`sc¡_dev_hªdËr_check
(
dev_hªdËr
);

1415 ià(
»s
 != 0)

1416 
out
;

1418 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
SCST_SUSPEND_TIMEOUT_USER
);

1419 ià(
»s
 != 0)

1420 
out
;

1422 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

1423 ià(
»s
 != 0)

1424 
out_»sume
;

1426 
»s
 = 
	`sc¡_®loc_deviû
(
GFP_KERNEL
, &
dev
);

1427 ià(
»s
 != 0)

1428 
out_uÆock
;

1430 
dev
->
ty³
 = 
dev_hªdËr
->type;

1431 
dev
->
scsi_dev
 = 
NULL
;

1432 
dev
->
vœt_Çme
 = 
	`k¡rdup
(
dev_Çme
, 
GFP_KERNEL
);

1433 ià(
dev
->
vœt_Çme
 =ð
NULL
) {

1434 
	`PRINT_ERROR
("Unableo‡llocate virt_name for dev %s",

1435 
dev_Çme
);

1436 
»s
 = -
ENOMEM
;

1437 
out_ä“_dev
;

1441 
dev
->
vœt_id
 = 
sc¡_vœt_dev_Ï¡_id
++;

1442 ià(
dev
->
vœt_id
 > 0)

1444 
sc¡_vœt_dev_Ï¡_id
 = 1;

1447 
»s
 = 
	`sc¡_´_£t_fže_Çme
(
dev
, 
NULL
, "%s/%s", 
SCST_PR_DIR
,

1448 
dev
->
vœt_Çme
);

1449 ià(
»s
 != 0)

1450 
out_ä“_dev
;

1452 
»s
 = 
	`sc¡_´_š™_dev
(
dev
);

1453 ià(
»s
 != 0)

1454 
out_ä“_dev
;

1456 #iâdeà
CONFIG_SCST_PROC


1461 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1463 
»s
 = 
	`sc¡_dev_sysfs_ü—‹
(
dev
);

1464 ià(
»s
 != 0)

1465 
out_lock_´_þ—r_dev
;

1467 
	`mu‹x_lock
(&
sc¡_mu‹x
);

1470 
	`li¡_fÜ_—ch_’Œy
(
d
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

1471 ià(
	`¡rcmp
(
d
->
vœt_Çme
, 
dev_Çme
) == 0) {

1472 
	`PRINT_ERROR
("Deviû % ®»adyƒxi¡s", 
dev_Çme
);

1473 
»s
 = -
EEXIST
;

1474 
sysfs_d–
 = 
Œue
;

1475 
out_´_þ—r_dev
;

1479 
»s
 = 
	`sc¡_assign_dev_hªdËr
(
dev
, 
dev_hªdËr
);

1480 ià(
»s
 != 0) {

1481 
sysfs_d–
 = 
Œue
;

1482 
out_´_þ—r_dev
;

1485 
	`li¡_add_ž
(&
dev
->
dev_li¡_’Œy
, &
sc¡_dev_li¡
);

1487 
»s
 = 
	`sc¡_cm_Ú_dev_»gi¡”
(
dev
);

1488 ià(
»s
 != 0)

1489 
out_uÄeg
;

1491 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1492 
	`sc¡_»sume_aùiv™y
();

1494 
»s
 = 
dev
->
vœt_id
;

1496 
	`PRINT_INFO
("A‰achedØvœtu® deviû % (id %d)", 
dev_Çme
, 
»s
);

1498 
out
:

1499 
	`TRACE_EXIT_RES
(
»s
);

1500  
»s
;

1502 
out_uÄeg
:

1503 
dev
->
dev_uÄegi¡”šg
 = 1;

1504 
	`li¡_d–
(&
dev
->
dev_li¡_’Œy
);

1505 
	`sc¡_assign_dev_hªdËr
(
dev
, &
sc¡_nuÎ_devty³
);

1506 
out_´_þ—r_dev
;

1508 #iâdeà
CONFIG_SCST_PROC


1509 
out_lock_´_þ—r_dev
:

1510 
	`mu‹x_lock
(&
sc¡_mu‹x
);

1513 
out_´_þ—r_dev
:

1514 
	`sc¡_´_þ—r_dev
(
dev
);

1516 
out_ä“_dev
:

1517 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1518 ià(
sysfs_d–
)

1519 
	`sc¡_dev_sysfs_d–
(
dev
);

1520 
	`sc¡_ä“_deviû
(
dev
);

1521 
out_»sume
;

1523 
out_uÆock
:

1524 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1526 
out_»sume
:

1527 
	`sc¡_»sume_aùiv™y
();

1528 
out
;

1529 
	}
}

1530 
EXPORT_SYMBOL_GPL
(
sc¡_»gi¡”_vœtu®_deviû
);

1536 
	$sc¡_uÄegi¡”_vœtu®_deviû
(
id
)

1538 
sc¡_deviû
 *
d
, *
dev
 = 
NULL
;

1539 
sc¡_acg_dev
 *
acg_dev
, *
¯
;

1541 
	`TRACE_ENTRY
();

1543 
	`sc¡_su¥’d_aùiv™y
(
SCST_SUSPEND_TIMEOUT_UNLIMITED
);

1544 
	`mu‹x_lock
(&
sc¡_mu‹x
);

1546 
	`li¡_fÜ_—ch_’Œy
(
d
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

1547 ià(
d
->
vœt_id
 =ð
id
) {

1548 
dev
 = 
d
;

1549 
	`TRACE_DBG
("Vœtu® deviû %°(id %dèfound", 
dev
, 
id
);

1553 ià(
dev
 =ð
NULL
) {

1554 
	`PRINT_ERROR
("Vœtu® deviû (id %dènÙ found", 
id
);

1555 
out_uÆock
;

1558 
dev
->
dev_uÄegi¡”šg
 = 1;

1560 
	`sc¡_cm_Ú_dev_uÄegi¡”
(
dev
);

1562 
	`li¡_d–_š™
(&
dev
->
dev_li¡_’Œy
);

1564 
	`sc¡_´_þ—r_dev
(
dev
);

1566 
	`sc¡_dg_dev_»move_by_dev
(
dev
);

1568 
	`sc¡_assign_dev_hªdËr
(
dev
, &
sc¡_nuÎ_devty³
);

1570 
	`li¡_fÜ_—ch_’Œy_§ã
(
acg_dev
, 
¯
, &
dev
->
dev_acg_dev_li¡
,

1571 
dev_acg_dev_li¡_’Œy
) {

1572 
	`sc¡_acg_d–_lun
(
acg_dev
->
acg
,‡cg_dev->
lun
, 
Œue
);

1575 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1576 
	`sc¡_»sume_aùiv™y
();

1578 
	`sc¡_dev_sysfs_d–
(
dev
);

1580 
	`PRINT_INFO
("Detached from virtual device %s (id %d)",

1581 
dev
->
vœt_Çme
, dev->
vœt_id
);

1583 
	`sc¡_ä“_deviû
(
dev
);

1585 
out
:

1586 
	`TRACE_EXIT
();

1589 
out_uÆock
:

1590 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1591 
	`sc¡_»sume_aùiv™y
();

1592 
out
;

1593 
	}
}

1594 
EXPORT_SYMBOL_GPL
(
sc¡_uÄegi¡”_vœtu®_deviû
);

1607 
	$__sc¡_»gi¡”_dev_driv”
(
sc¡_dev_ty³
 *
dev_ty³
,

1608 cÚ¡ *
v”siÚ
)

1610 
»s
, 
exi¡
;

1611 
sc¡_dev_ty³
 *
dt
;

1612 #ifdeà
CONFIG_SCST_PROC


1613 
sc¡_deviû
 *
dev
;

1616 
	`TRACE_ENTRY
();

1618 
»s
 = -
EINVAL
;

1619 ià(
	`¡rcmp
(
v”siÚ
, 
SCST_INTERFACE_VERSION
) != 0) {

1620 
	`PRINT_ERROR
("Incorrect version of dev handler %s",

1621 
dev_ty³
->
Çme
);

1622 
out
;

1625 
»s
 = 
	`sc¡_dev_hªdËr_check
(
dev_ty³
);

1626 ià(
»s
 != 0)

1627 
out
;

1629 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 30) && \

1630 !
	`defšed
(
SCSI_EXEC_REQ_FIFO_DEFINED
) && \

1631 !
	`defšed
(
CONFIG_SCST_STRICT_SERIALIZING
)

1632 ià(
dev_ty³
->
exec
 =ð
NULL
) {

1633 
	`PRINT_ERROR
("Pass-through dev handlers (handler \"%s\")‚ot "

1636 "CONFIG_SCST_STRICT_SERIALIZING", 
dev_ty³
->
Çme
);

1637 
»s
 = -
EINVAL
;

1638 
out
;

1642 #ifdeà
CONFIG_SCST_PROC


1643 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
SCST_SUSPEND_TIMEOUT_USER
);

1644 ià(
»s
 != 0)

1645 
out
;

1648 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

1649 ià(
»s
 != 0)

1650 #ifdeà
CONFIG_SCST_PROC


1651 
out_»sume
;

1653 
out
;

1656 
exi¡
 = 0;

1657 
	`li¡_fÜ_—ch_’Œy
(
dt
, &
sc¡_dev_ty³_li¡
, 
dev_ty³_li¡_’Œy
) {

1658 ià(
	`¡rcmp
(
dt
->
Çme
, 
dev_ty³
->name) == 0) {

1659 
	`PRINT_ERROR
("Deviceype handler \"%s\"‡lready "

1660 "exi¡s", 
dt
->
Çme
);

1661 
exi¡
 = 1;

1665 ià(
exi¡
)

1666 
out_uÆock
;

1668 
	`li¡_add_ž
(&
dev_ty³
->
dev_ty³_li¡_’Œy
, &
sc¡_dev_ty³_li¡
);

1670 #ifdeà
CONFIG_SCST_PROC


1671 ià(!
dev_ty³
->
no_´oc
) {

1672 
»s
 = 
	`sc¡_bužd_´oc_dev_hªdËr_dœ_’Œ›s
(
dev_ty³
);

1673 ià(
»s
 < 0)

1674 
out_uÆock
;

1681 
	`li¡_fÜ_—ch_’Œy
(
dev
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

1682 ià(
dev
->
scsi_dev
 =ð
NULL
 || dev->
hªdËr
 !ð&
sc¡_nuÎ_devty³
)

1684 ià(
dev
->
scsi_dev
->
ty³
 =ð
dev_ty³
->type)

1685 
	`sc¡_assign_dev_hªdËr
(
dev
, 
dev_ty³
);

1688 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1689 
	`sc¡_»sume_aùiv™y
();

1691 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1693 
»s
 = 
	`sc¡_devt_sysfs_ü—‹
(
dev_ty³
);

1694 ià(
»s
 < 0)

1695 
out
;

1698 
	`PRINT_INFO
("Device handler \"%s\" forype %d„egistered "

1699 "sucûssfuÎy", 
dev_ty³
->
Çme
, dev_ty³->
ty³
);

1701 
out
:

1702 
	`TRACE_EXIT_RES
(
»s
);

1703  
»s
;

1705 
out_uÆock
:

1706 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1707 #ifdeà
CONFIG_SCST_PROC


1708 
out_»sume
:

1709 
	`sc¡_»sume_aùiv™y
();

1711 
out
;

1712 
	}
}

1713 
EXPORT_SYMBOL_GPL
(
__sc¡_»gi¡”_dev_driv”
);

1718 
	$sc¡_uÄegi¡”_dev_driv”
(
sc¡_dev_ty³
 *
dev_ty³
)

1720 
sc¡_deviû
 *
dev
;

1721 
sc¡_dev_ty³
 *
dt
;

1722 
found
 = 0;

1724 
	`TRACE_ENTRY
();

1726 
	`sc¡_su¥’d_aùiv™y
(
SCST_SUSPEND_TIMEOUT_UNLIMITED
);

1727 
	`mu‹x_lock
(&
sc¡_mu‹x
);

1729 
	`li¡_fÜ_—ch_’Œy
(
dt
, &
sc¡_dev_ty³_li¡
, 
dev_ty³_li¡_’Œy
) {

1730 ià(
	`¡rcmp
(
dt
->
Çme
, 
dev_ty³
->name) == 0) {

1731 
found
 = 1;

1735 ià(!
found
) {

1736 
	`PRINT_ERROR
("Dev handler \"%s\" isn't„egistered",

1737 
dev_ty³
->
Çme
);

1738 
out_up
;

1741 
	`li¡_fÜ_—ch_’Œy
(
dev
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

1742 ià(
dev
->
hªdËr
 =ð
dev_ty³
) {

1743 
	`sc¡_assign_dev_hªdËr
(
dev
, &
sc¡_nuÎ_devty³
);

1744 
	`TRACE_DBG
("Dev hªdË¸»moved from deviû %p", 
dev
);

1748 
	`li¡_d–
(&
dev_ty³
->
dev_ty³_li¡_’Œy
);

1750 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1751 
	`sc¡_»sume_aùiv™y
();

1753 #ifdeà
CONFIG_SCST_PROC


1754 
	`sc¡_þ—nup_´oc_dev_hªdËr_dœ_’Œ›s
(
dev_ty³
);

1756 
	`sc¡_devt_sysfs_d–
(
dev_ty³
);

1759 
	`PRINT_INFO
("Device handler \"%s\" forype %d unloaded",

1760 
dev_ty³
->
Çme
, dev_ty³->
ty³
);

1762 
out
:

1763 
	`TRACE_EXIT
();

1766 
out_up
:

1767 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1768 
	`sc¡_»sume_aùiv™y
();

1769 
out
;

1770 
	}
}

1771 
EXPORT_SYMBOL_GPL
(
sc¡_uÄegi¡”_dev_driv”
);

1784 
	$__sc¡_»gi¡”_vœtu®_dev_driv”
(
sc¡_dev_ty³
 *
dev_ty³
,

1785 cÚ¡ *
v”siÚ
)

1787 
»s
;

1789 
	`TRACE_ENTRY
();

1791 ià(
	`¡rcmp
(
v”siÚ
, 
SCST_INTERFACE_VERSION
) != 0) {

1792 
	`PRINT_ERROR
("Incorrect version of virtual dev handler %s",

1793 
dev_ty³
->
Çme
);

1794 
»s
 = -
EINVAL
;

1795 
out
;

1798 
»s
 = 
	`sc¡_dev_hªdËr_check
(
dev_ty³
);

1799 ià(
»s
 != 0)

1800 
out
;

1802 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

1803 ià(
»s
 != 0)

1804 
out
;

1805 
	`li¡_add_ž
(&
dev_ty³
->
dev_ty³_li¡_’Œy
, &
sc¡_vœtu®_dev_ty³_li¡
);

1806 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1808 #ifdeà
CONFIG_SCST_PROC


1809 ià(!
dev_ty³
->
no_´oc
) {

1810 
»s
 = 
	`sc¡_bužd_´oc_dev_hªdËr_dœ_’Œ›s
(
dev_ty³
);

1811 ià(
»s
 < 0)

1812 
out
;

1815 
»s
 = 
	`sc¡_devt_sysfs_ü—‹
(
dev_ty³
);

1816 ià(
»s
 < 0)

1817 
out
;

1820 ià(
dev_ty³
->
ty³
 != -1) {

1821 
	`PRINT_INFO
("Virtual device handler %s forype %d "

1822 "»gi¡”ed sucûssfuÎy", 
dev_ty³
->
Çme
,

1823 
dev_ty³
->
ty³
);

1825 
	`PRINT_INFO
("Virtual device handler \"%s\"„egistered "

1826 "sucûssfuÎy", 
dev_ty³
->
Çme
);

1829 
out
:

1830 
	`TRACE_EXIT_RES
(
»s
);

1831  
»s
;

1832 
	}
}

1833 
EXPORT_SYMBOL_GPL
(
__sc¡_»gi¡”_vœtu®_dev_driv”
);

1838 
	$sc¡_uÄegi¡”_vœtu®_dev_driv”
(
sc¡_dev_ty³
 *
dev_ty³
)

1840 
	`TRACE_ENTRY
();

1842 
	`mu‹x_lock
(&
sc¡_mu‹x
);

1845 
	`li¡_d–
(&
dev_ty³
->
dev_ty³_li¡_’Œy
);

1847 #iâdeà
CONFIG_SCST_PROC


1849 
dev_ty³
->
devt_aùive_sysfs_wÜks_couÁ
 > 0) {

1850 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1851 
	`m¦“p
(100);

1852 
	`mu‹x_lock
(&
sc¡_mu‹x
);

1856 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1858 #ifdeà
CONFIG_SCST_PROC


1859 ià(!
dev_ty³
->
no_´oc
)

1860 
	`sc¡_þ—nup_´oc_dev_hªdËr_dœ_’Œ›s
(
dev_ty³
);

1862 
	`sc¡_devt_sysfs_d–
(
dev_ty³
);

1865 
	`PRINT_INFO
("Deviû hªdË¸\"%s\" uÆßded", 
dev_ty³
->
Çme
);

1867 
	`TRACE_EXIT
();

1869 
	}
}

1870 
EXPORT_SYMBOL_GPL
(
sc¡_uÄegi¡”_vœtu®_dev_driv”
);

1872 
	$sc¡_add_th»ads
(
sc¡_cmd_th»ads
 *
cmd_th»ads
,

1873 
sc¡_deviû
 *
dev
, 
sc¡_tgt_dev
 *
tgt_dev
, 
num
)

1875 
»s
 = 0, 
i
;

1876 
sc¡_cmd_th»ad_t
 *
thr
;

1877 
n
 = 0, 
tgt_dev_num
 = 0;

1879 
	`TRACE_ENTRY
();

1881 ià(
num
 == 0) {

1882 
»s
 = 0;

1883 
out
;

1886 
	`¥š_lock
(&
cmd_th»ads
->
thr_lock
);

1887 
n
 = 
cmd_th»ads
->
Ä_th»ads
;

1888 
	`¥š_uÆock
(&
cmd_th»ads
->
thr_lock
);

1890 
	`TRACE_DBG
("cmd_threads %p, dev %s,gt_dev %p,‚um %d,‚ %d",

1891 
cmd_th»ads
, 
dev
 ? dev->
vœt_Çme
 : 
NULL
, 
tgt_dev
, 
num
, 
n
);

1893 ià(
tgt_dev
 !ð
NULL
) {

1894 
sc¡_tgt_dev
 *
t
;

1896 
	`li¡_fÜ_—ch_’Œy
(
t
, &
tgt_dev
->
dev
->
dev_tgt_dev_li¡
,

1897 
dev_tgt_dev_li¡_’Œy
) {

1898 ià(
t
 =ð
tgt_dev
)

1900 
tgt_dev_num
++;

1904 
i
 = 0; i < 
num
; i++) {

1905 
thr
 = 
	`kz®loc
((*thr), 
GFP_KERNEL
);

1906 ià(!
thr
) {

1907 
»s
 = -
ENOMEM
;

1908 
	`PRINT_ERROR
("FažØ®loÿ‹h¸%d", 
»s
);

1909 
out_wa™
;

1912 ià(
dev
 !ð
NULL
) {

1913 
thr
->
cmd_th»ad
 = 
	`kth»ad_ü—‹
(
sc¡_cmd_th»ad
,

1914 
cmd_th»ads
, "%.13s%d", 
dev
->
vœt_Çme
, 
n
++);

1915 } ià(
tgt_dev
 !ð
NULL
) {

1916 
thr
->
cmd_th»ad
 = 
	`kth»ad_ü—‹
(
sc¡_cmd_th»ad
,

1917 
cmd_th»ads
, "%.10s%d_%d",

1918 
tgt_dev
->
dev
->
vœt_Çme
, 
tgt_dev_num
, 
n
++);

1920 
thr
->
cmd_th»ad
 = 
	`kth»ad_ü—‹
(
sc¡_cmd_th»ad
,

1921 
cmd_th»ads
, "sc¡d%d", 
n
++);

1923 ià(
	`IS_ERR
(
thr
->
cmd_th»ad
)) {

1924 
»s
 = 
	`PTR_ERR
(
thr
->
cmd_th»ad
);

1925 
	`PRINT_ERROR
("kth»ad_ü—‹(èçžed: %d", 
»s
);

1926 
	`kä“
(
thr
);

1927 
out_wa™
;

1930 ià(
tgt_dev
 !ð
NULL
) {

1931 
rc
;

1936 
rc
 = 
	`£t_ýus_®lowed_±r
(
thr
->
cmd_th»ad
,

1937 &
tgt_dev
->
acg_dev
->
acg
->
acg_ýu_mask
);

1938 ià(
rc
 != 0)

1939 
	`PRINT_ERROR
("Setting CPU‡ffinity failed: "

1940 "%d", 
rc
);

1943 
	`¥š_lock
(&
cmd_th»ads
->
thr_lock
);

1944 
	`li¡_add
(&
thr
->
th»ad_li¡_’Œy
, &
cmd_th»ads
->
th»ads_li¡
);

1945 
cmd_th»ads
->
Ä_th»ads
++;

1946 
	`¥š_uÆock
(&
cmd_th»ads
->
thr_lock
);

1948 
	`TRACE_DBG
("Addedhr %pohreads†ist (nr_threads %d,‚ %d)",

1949 
thr
, 
cmd_th»ads
->
Ä_th»ads
, 
n
);

1951 
	`wake_up_´oûss
(
thr
->
cmd_th»ad
);

1954 
out_wa™
:

1955 ià(
i
 > 0 && 
cmd_th»ads
 !ð&
sc¡_maš_cmd_th»ads
) {

1960 
	`wa™_ev’t
(
cmd_th»ads
->
ioùx_wq
,

1961 
cmd_th»ads
->
io_cÚ‹xt_»ady
);

1962 
	`smp_rmb
();

1965 ià(
»s
 != 0)

1966 
	`sc¡_d–_th»ads
(
cmd_th»ads
, 
i
);

1968 
out
:

1969 
	`TRACE_EXIT_RES
(
»s
);

1970  
»s
;

1971 
	}
}

1973 
	$sc¡_d–_th»ads
(
sc¡_cmd_th»ads
 *
cmd_th»ads
, 
num
)

1975 
	`TRACE_ENTRY
();

1977  ; 
num
 != 0;‚um--) {

1978 
sc¡_cmd_th»ad_t
 *
ù
 = 
NULL
, *
ù2
;

1979 
rc
;

1981 
	`¥š_lock
(&
cmd_th»ads
->
thr_lock
);

1982 
	`li¡_fÜ_—ch_’Œy_»v”£
(
ù2
, &
cmd_th»ads
->
th»ads_li¡
,

1983 
th»ad_li¡_’Œy
) {

1984 ià(!
ù2
->
bešg_¡Ý³d
) {

1985 
ù
 = 
ù2
;

1986 
	`li¡_d–
(&
ù
->
th»ad_li¡_’Œy
);

1987 
ù
->
bešg_¡Ý³d
 = 
Œue
;

1988 
cmd_th»ads
->
Ä_th»ads
--;

1992 
	`¥š_uÆock
(&
cmd_th»ads
->
thr_lock
);

1994 ià(!
ù
)

1997 
rc
 = 
	`kth»ad_¡Ý
(
ù
->
cmd_th»ad
);

1998 ià(
rc
 !ð0 &&„ø!ð-
EINTR
)

1999 
	`TRACE_MGMT_DBG
("kth»ad_¡Ý(èçžed: %d", 
rc
);

2001 
	`kä“
(
ù
);

2004 
	`EXTRACHECKS_BUG_ON
((
cmd_th»ads
->
Ä_th»ads
 == 0) &&

2005 (
cmd_th»ads
->
io_cÚ‹xt
 !ð
NULL
));

2007 
	`TRACE_EXIT
();

2009 
	}
}

2012 
	$sc¡_£t_thr_ýu_mask
(
sc¡_cmd_th»ads
 *
cmd_th»ads
,

2013 
ýumask_t
 *
ýu_mask
)

2015 
sc¡_cmd_th»ad_t
 *
thr
;

2016 
rc
 = 0;

2018 
	`¥š_lock
(&
cmd_th»ads
->
thr_lock
);

2019 
	`li¡_fÜ_—ch_’Œy
(
thr
, &
cmd_th»ads
->
th»ads_li¡
,

2020 
th»ad_li¡_’Œy
) {

2021 
rc
 = 
	`£t_ýus_®lowed_±r
(
thr
->
cmd_th»ad
, 
ýu_mask
);

2022 ià(
rc
)

2025 
	`¥š_uÆock
(&
cmd_th»ads
->
thr_lock
);

2027  
rc
;

2028 
	}
}

2029 
EXPORT_SYMBOL
(
sc¡_£t_thr_ýu_mask
);

2032 
	$sc¡_¡Ý_dev_th»ads
(
sc¡_deviû
 *
dev
)

2034 
sc¡_tgt_dev
 *
tgt_dev
;

2036 
	`TRACE_ENTRY
();

2038 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

2039 
dev_tgt_dev_li¡_’Œy
) {

2040 
	`sc¡_tgt_dev_¡Ý_th»ads
(
tgt_dev
);

2043 ià((
dev
->
th»ads_num
 > 0) &&

2044 (
dev
->
th»ads_poÞ_ty³
 =ð
SCST_THREADS_POOL_SHARED
))

2045 
	`sc¡_d–_th»ads
(&
dev
->
dev_cmd_th»ads
, -1);

2047 
	`TRACE_EXIT
();

2049 
	}
}

2052 
	$sc¡_ü—‹_dev_th»ads
(
sc¡_deviû
 *
dev
)

2054 
»s
 = 0;

2055 
sc¡_tgt_dev
 *
tgt_dev
;

2057 
	`TRACE_ENTRY
();

2059 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

2060 
dev_tgt_dev_li¡_’Œy
) {

2061 
»s
 = 
	`sc¡_tgt_dev_£tup_th»ads
(
tgt_dev
);

2062 ià(
»s
 != 0)

2063 
out_”r
;

2066 ià((
dev
->
th»ads_num
 > 0) &&

2067 (
dev
->
th»ads_poÞ_ty³
 =ð
SCST_THREADS_POOL_SHARED
)) {

2068 
»s
 = 
	`sc¡_add_th»ads
(&
dev
->
dev_cmd_th»ads
, dev, 
NULL
,

2069 
dev
->
th»ads_num
);

2070 ià(
»s
 != 0)

2071 
out_”r
;

2074 
out
:

2075 
	`TRACE_EXIT_RES
(
»s
);

2076  
»s
;

2078 
out_”r
:

2079 
	`sc¡_¡Ý_dev_th»ads
(
dev
);

2080 
out
;

2081 
	}
}

2084 
	$sc¡_assign_dev_hªdËr
(
sc¡_deviû
 *
dev
,

2085 
sc¡_dev_ty³
 *
hªdËr
)

2087 
»s
 = 0;

2088 
sc¡_tgt_dev
 *
tgt_dev
;

2089 
	`LIST_HEAD
(
©ched_tgt_devs
);

2091 
	`TRACE_ENTRY
();

2093 
	`sBUG_ON
(
hªdËr
 =ð
NULL
);

2095 ià(
dev
->
hªdËr
 == handler)

2096 
out
;

2098 ià(
dev
->
hªdËr
 =ð
NULL
)

2099 
assign
;

2101 ià(
dev
->
hªdËr
->
d‘ach_tgt
) {

2102 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

2103 
dev_tgt_dev_li¡_’Œy
) {

2104 
	`TRACE_DBG
("Calling dev handler's detach_tgt(%p)",

2105 
tgt_dev
);

2106 
dev
->
hªdËr
->
	`d‘ach_tgt
(
tgt_dev
);

2107 
	`TRACE_DBG
("%s", "Dev handler's detach_tgt()„eturned");

2116 
	`sc¡_devt_dev_sysfs_d–
(
dev
);

2118 ià(
dev
->
hªdËr
->
d‘ach
) {

2119 
	`TRACE_DBG
("%s", "Calling dev handler's detach()");

2120 
dev
->
hªdËr
->
	`d‘ach
(dev);

2121 
	`TRACE_DBG
("%s", "Old handler's detach()„eturned");

2124 
	`sc¡_¡Ý_dev_th»ads
(
dev
);

2126 
assign
:

2127 
dev
->
hªdËr
 = handler;

2128 
dev
->
th»ads_num
 = 
hªdËr
->threads_num;

2129 
dev
->
th»ads_poÞ_ty³
 = 
hªdËr
->threads_pool_type;

2130 
dev
->
max_wr™e_§me_Ën
 = 256 * 1024 * 1024;

2132 ià(
hªdËr
->
©ch
) {

2133 
	`TRACE_DBG
("C®lšg‚ew dev hªdËr' ©ch(%p)", 
dev
);

2134 
»s
 = 
hªdËr
->
	`©ch
(
dev
);

2135 
	`TRACE_DBG
("New dev hªdËr' ©ch(è»tuºed %d", 
»s
);

2136 ià(
»s
 != 0) {

2137 
	`PRINT_ERROR
("New device handler's %s‡ttach() "

2138 "çžed: %d", 
hªdËr
->
Çme
, 
»s
);

2139 
out
;

2143 
»s
 = 
	`sc¡_devt_dev_sysfs_ü—‹
(
dev
);

2144 ià(
»s
 != 0)

2145 
out_d‘ach
;

2147 ià(
hªdËr
->
©ch_tgt
) {

2148 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

2149 
dev_tgt_dev_li¡_’Œy
) {

2150 
	`TRACE_DBG
("Calling dev handler's‡ttach_tgt(%p)",

2151 
tgt_dev
);

2152 
»s
 = 
hªdËr
->
	`©ch_tgt
(
tgt_dev
);

2153 
	`TRACE_DBG
("%s", "Dev handler's‡ttach_tgt()„eturned");

2154 ià(
»s
 != 0) {

2155 
	`PRINT_ERROR
("Device handler's %s‡ttach_tgt() "

2156 "çžed: %d", 
hªdËr
->
Çme
, 
»s
);

2157 
out_”r_d‘ach_tgt
;

2159 
	`li¡_add_ž
(&
tgt_dev
->
exŒa_tgt_dev_li¡_’Œy
,

2160 &
©ched_tgt_devs
);

2164 
»s
 = 
	`sc¡_ü—‹_dev_th»ads
(
dev
);

2165 ià(
»s
 != 0)

2166 
out_”r_d‘ach_tgt
;

2168 
out
:

2169 
	`TRACE_EXIT_RES
(
»s
);

2170  
»s
;

2172 
out_”r_d‘ach_tgt
:

2173 ià(
hªdËr
->
d‘ach_tgt
) {

2174 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
©ched_tgt_devs
,

2175 
exŒa_tgt_dev_li¡_’Œy
) {

2176 
	`TRACE_DBG
("Calling handler's detach_tgt(%p)",

2177 
tgt_dev
);

2178 
hªdËr
->
	`d‘ach_tgt
(
tgt_dev
);

2179 
	`TRACE_DBG
("%s", "Handler's detach_tgt()„eturned");

2183 
	`sc¡_devt_dev_sysfs_d–
(
dev
);

2185 
out_d‘ach
:

2186 ià(
hªdËr
->
d‘ach
) {

2187 
	`TRACE_DBG
("%s", "Calling handler's detach()");

2188 
hªdËr
->
	`d‘ach
(
dev
);

2189 
	`TRACE_DBG
("%s", "Handler's detach()„eturned");

2192 
dev
->
hªdËr
 = &
sc¡_nuÎ_devty³
;

2193 
dev
->
th»ads_num
 = 
sc¡_nuÎ_devty³
.threads_num;

2194 
dev
->
th»ads_poÞ_ty³
 = 
sc¡_nuÎ_devty³
.threads_pool_type;

2195 
out
;

2196 
	}
}

2203 
	$sc¡_š™_th»ads
(
sc¡_cmd_th»ads
 *
cmd_th»ads
)

2205 
	`TRACE_ENTRY
();

2207 
	`¥š_lock_š™
(&
cmd_th»ads
->
cmd_li¡_lock
);

2208 
	`INIT_LIST_HEAD
(&
cmd_th»ads
->
aùive_cmd_li¡
);

2209 
	`š™_wa™queue_h—d
(&
cmd_th»ads
->
cmd_li¡_wa™Q
);

2210 
	`š™_wa™queue_h—d
(&
cmd_th»ads
->
ioùx_wq
);

2211 
	`INIT_LIST_HEAD
(&
cmd_th»ads
->
th»ads_li¡
);

2212 
	`mu‹x_š™
(&
cmd_th»ads
->
io_cÚ‹xt_mu‹x
);

2213 
	`¥š_lock_š™
(&
cmd_th»ads
->
thr_lock
);

2215 
	`mu‹x_lock
(&
sc¡_cmd_th»ads_mu‹x
);

2216 
	`li¡_add_ž
(&
cmd_th»ads
->
li¡s_li¡_’Œy
,

2217 &
sc¡_cmd_th»ads_li¡
);

2218 
	`mu‹x_uÆock
(&
sc¡_cmd_th»ads_mu‹x
);

2220 
	`TRACE_EXIT
();

2222 
	}
}

2223 
EXPORT_SYMBOL_GPL
(
sc¡_š™_th»ads
);

2230 
	$sc¡_deš™_th»ads
(
sc¡_cmd_th»ads
 *
cmd_th»ads
)

2232 
	`TRACE_ENTRY
();

2234 
	`mu‹x_lock
(&
sc¡_cmd_th»ads_mu‹x
);

2235 
	`li¡_d–
(&
cmd_th»ads
->
li¡s_li¡_’Œy
);

2236 
	`mu‹x_uÆock
(&
sc¡_cmd_th»ads_mu‹x
);

2238 
	`sBUG_ON
(
cmd_th»ads
->
io_cÚ‹xt
);

2240 
	`TRACE_EXIT
();

2242 
	}
}

2243 
EXPORT_SYMBOL_GPL
(
sc¡_deš™_th»ads
);

2245 
	$sc¡_¡Ý_glob®_th»ads
()

2247 
	`TRACE_ENTRY
();

2249 
	`mu‹x_lock
(&
sc¡_mu‹x
);

2251 
	`sc¡_d–_th»ads
(&
sc¡_maš_cmd_th»ads
, -1);

2253 ià(
sc¡_mgmt_cmd_th»ad
)

2254 
	`kth»ad_¡Ý
(
sc¡_mgmt_cmd_th»ad
);

2255 ià(
sc¡_mgmt_th»ad
)

2256 
	`kth»ad_¡Ý
(
sc¡_mgmt_th»ad
);

2257 ià(
sc¡_š™_cmd_th»ad
)

2258 
	`kth»ad_¡Ý
(
sc¡_š™_cmd_th»ad
);

2260 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

2262 
	`TRACE_EXIT
();

2264 
	}
}

2267 
	$sc¡_¡¬t_glob®_th»ads
(
num
)

2269 
»s
;

2271 
	`TRACE_ENTRY
();

2273 
	`mu‹x_lock
(&
sc¡_mu‹x
);

2275 
»s
 = 
	`sc¡_add_th»ads
(&
sc¡_maš_cmd_th»ads
, 
NULL
, NULL, 
num
);

2276 ià(
»s
 < 0)

2277 
out_uÆock
;

2279 
sc¡_š™_cmd_th»ad
 = 
	`kth»ad_run
(
sc¡_š™_th»ad
,

2280 
NULL
, "scst_initd");

2281 ià(
	`IS_ERR
(
sc¡_š™_cmd_th»ad
)) {

2282 
»s
 = 
	`PTR_ERR
(
sc¡_š™_cmd_th»ad
);

2283 
	`PRINT_ERROR
("kth»ad_ü—‹(èfÜ in™ cmd fažed: %d", 
»s
);

2284 
sc¡_š™_cmd_th»ad
 = 
NULL
;

2285 
out_uÆock
;

2288 
sc¡_mgmt_cmd_th»ad
 = 
	`kth»ad_run
(
sc¡_tm_th»ad
,

2289 
NULL
, "scsi_tm");

2290 ià(
	`IS_ERR
(
sc¡_mgmt_cmd_th»ad
)) {

2291 
»s
 = 
	`PTR_ERR
(
sc¡_mgmt_cmd_th»ad
);

2292 
	`PRINT_ERROR
("kth»ad_ü—‹(èfÜ TM fažed: %d", 
»s
);

2293 
sc¡_mgmt_cmd_th»ad
 = 
NULL
;

2294 
out_uÆock
;

2297 
sc¡_mgmt_th»ad
 = 
	`kth»ad_run
(
sc¡_glob®_mgmt_th»ad
,

2298 
NULL
, "scst_mgmtd");

2299 ià(
	`IS_ERR
(
sc¡_mgmt_th»ad
)) {

2300 
»s
 = 
	`PTR_ERR
(
sc¡_mgmt_th»ad
);

2301 
	`PRINT_ERROR
("kth»ad_ü—‹(èfÜ mgmˆçžed: %d", 
»s
);

2302 
sc¡_mgmt_th»ad
 = 
NULL
;

2303 
out_uÆock
;

2306 
out_uÆock
:

2307 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

2309 
	`TRACE_EXIT_RES
(
»s
);

2310  
»s
;

2311 
	}
}

2313 #iâdeà
CONFIG_SCST_PROC


2320 
	$sc¡_g‘_£tup_id
()

2322  
sc¡_£tup_id
;

2323 
	}
}

2324 
EXPORT_SYMBOL_GPL
(
sc¡_g‘_£tup_id
);

2327 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 26)

2328 
	$sc¡_add
(
þass_deviû
 *
cdev
, 
þass_š‹rçû
 *
štf
)

2330 
	$sc¡_add
(
deviû
 *
cdev
, 
þass_š‹rçû
 *
štf
)

2333 
scsi_deviû
 *
scsidp
;

2334 
»s
 = 0;

2336 
	`TRACE_ENTRY
();

2338 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 26)

2339 
scsidp
 = 
	`to_scsi_deviû
(
cdev
->
dev
);

2341 
scsidp
 = 
	`to_scsi_deviû
(
cdev
->
·»Á
);

2344 ià((
scsidp
->
ho¡
->
ho¡t
->
Çme
 =ð
NULL
) ||

2345 (
	`¡rcmp
(
scsidp
->
ho¡
->
ho¡t
->
Çme
, 
SCST_LOCAL_NAME
) != 0))

2346 
»s
 = 
	`sc¡_»gi¡”_deviû
(
scsidp
);

2348 
	`TRACE_EXIT
();

2349  
»s
;

2350 
	}
}

2352 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 26)

2353 
	$sc¡_»move
(
þass_deviû
 *
cdev
, 
þass_š‹rçû
 *
štf
)

2355 
	$sc¡_»move
(
deviû
 *
cdev
, 
þass_š‹rçû
 *
štf
)

2358 
scsi_deviû
 *
scsidp
;

2360 
	`TRACE_ENTRY
();

2362 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 26)

2363 
scsidp
 = 
	`to_scsi_deviû
(
cdev
->
dev
);

2365 
scsidp
 = 
	`to_scsi_deviû
(
cdev
->
·»Á
);

2368 ià((
scsidp
->
ho¡
->
ho¡t
->
Çme
 =ð
NULL
) ||

2369 (
	`¡rcmp
(
scsidp
->
ho¡
->
ho¡t
->
Çme
, 
SCST_LOCAL_NAME
) != 0))

2370 
	`sc¡_uÄegi¡”_deviû
(
scsidp
);

2372 
	`TRACE_EXIT
();

2374 
	}
}

2376 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 26)

2377 
þass_š‹rçû
 
	gsc¡_š‹rçû
 = {

2378 .
add
 = 
sc¡_add
,

2379 .
	g»move
 = 
sc¡_»move
,

2382 
þass_š‹rçû
 
	gsc¡_š‹rçû
 = {

2383 .
add_dev
 = 
sc¡_add
,

2384 .
	g»move_dev
 = 
sc¡_»move
,

2388 
__š™
 
	$sc¡_´št_cÚfig
()

2390 
buf
[128];

2391 
i
, 
j
;

2393 
i
 = 
	`¢´štf
(
buf
, (buf), "Enabled features: ");

2394 
j
 = 
i
;

2396 #ifdeà
CONFIG_SCST_STRICT_SERIALIZING


2397 
i
 +ð
	`¢´štf
(&
buf
[i], (buf) - i, "STRICT_SERIALIZING");

2400 #ifdeà
CONFIG_SCST_EXTRACHECKS


2401 
i
 +ð
	`¢´štf
(&
buf
[i], (buf) - i, "%sEXTRACHECKS",

2402 (
j
 =ð
i
) ? "" : ", ");

2405 #ifdeà
CONFIG_SCST_TRACING


2406 
i
 +ð
	`¢´štf
(&
buf
[i], (buf) - i, "%sTRACING",

2407 (
j
 =ð
i
) ? "" : ", ");

2410 #ifdeà
CONFIG_SCST_DEBUG


2411 
i
 +ð
	`¢´štf
(&
buf
[i], (buf) - i, "%sDEBUG",

2412 (
j
 =ð
i
) ? "" : ", ");

2415 #ifdeà
CONFIG_SCST_DEBUG_TM


2416 
i
 +ð
	`¢´štf
(&
buf
[i], (buf) - i, "%sDEBUG_TM",

2417 (
j
 =ð
i
) ? "" : ", ");

2420 #ifdeà
CONFIG_SCST_DEBUG_RETRY


2421 
i
 +ð
	`¢´štf
(&
buf
[i], (buf) - i, "%sDEBUG_RETRY",

2422 (
j
 =ð
i
) ? "" : ", ");

2425 #ifdeà
CONFIG_SCST_DEBUG_OOM


2426 
i
 +ð
	`¢´štf
(&
buf
[i], (buf) - i, "%sDEBUG_OOM",

2427 (
j
 =ð
i
) ? "" : ", ");

2430 #ifdeà
CONFIG_SCST_DEBUG_SN


2431 
i
 +ð
	`¢´štf
(&
buf
[i], (buf) - i, "%sDEBUG_SN",

2432 (
j
 =ð
i
) ? "" : ", ");

2435 #ifdeà
CONFIG_SCST_USE_EXPECTED_VALUES


2436 
i
 +ð
	`¢´štf
(&
buf
[i], (buf) - i, "%sUSE_EXPECTED_VALUES",

2437 (
j
 =ð
i
) ? "" : ", ");

2440 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


2441 
i
 +ð
	`¢´štf
(&
buf
[i], (buf) - i,

2443 (
j
 =ð
i
) ? "" : ", ");

2446 #ifdeà
CONFIG_SCST_STRICT_SECURITY


2447 
i
 +ð
	`¢´štf
(&
buf
[i], (buf) - i, "%sSTRICT_SECURITY",

2448 (
j
 =ð
i
) ? "" : ", ");

2451 ià(
j
 !ð
i
)

2452 
	`PRINT_INFO
("%s", 
buf
);

2453 
	}
}

2455 
__š™
 
	$š™_sc¡
()

2457 
»s
, 
i
;

2458 
sc¡_num_ýus
;

2460 
	`TRACE_ENTRY
();

2463 
scsi_£n£_hdr
 *
shdr
;

2464 
sc¡_Üd”_d©a
 *
o
;

2465 
sc¡_cmd
 *
c
;

2467 
	`BUILD_BUG_ON
((*
shdr
è> 
SCST_SENSE_BUFFERSIZE
);

2468 
	`BUILD_BUG_ON
((
o
->
cu¼_¢
è!ð(o->
ex³ùed_¢
));

2469 
	`BUILD_BUG_ON
((
c
->
¢
è!ð(
o
->
ex³ùed_¢
));

2472 
	`mu‹x_š™
(&
sc¡_mu‹x
);

2473 
	`mu‹x_š™
(&
sc¡_mu‹x2
);

2474 
	`INIT_LIST_HEAD
(&
sc¡_‹m¶©e_li¡
);

2475 
	`INIT_LIST_HEAD
(&
sc¡_dev_li¡
);

2476 
	`INIT_LIST_HEAD
(&
sc¡_dev_ty³_li¡
);

2477 
	`INIT_LIST_HEAD
(&
sc¡_vœtu®_dev_ty³_li¡
);

2478 #ifdeà
CONFIG_SCST_PROC


2479 
	`INIT_LIST_HEAD
(&
sc¡_acg_li¡
);

2481 
	`¥š_lock_š™
(&
sc¡_š™_lock
);

2482 
	`š™_wa™queue_h—d
(&
sc¡_š™_cmd_li¡_wa™Q
);

2483 
	`INIT_LIST_HEAD
(&
sc¡_š™_cmd_li¡
);

2484 #ià
	`defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

2485 
sc¡_Œaû_æag
 = 
SCST_DEFAULT_LOG_FLAGS
;

2487 
	`¥š_lock_š™
(&
sc¡_mcmd_lock
);

2488 
	`INIT_LIST_HEAD
(&
sc¡_aùive_mgmt_cmd_li¡
);

2489 
	`INIT_LIST_HEAD
(&
sc¡_d–ayed_mgmt_cmd_li¡
);

2490 
	`š™_wa™queue_h—d
(&
sc¡_mgmt_cmd_li¡_wa™Q
);

2491 
	`š™_wa™queue_h—d
(&
sc¡_mgmt_wa™Q
);

2492 
	`¥š_lock_š™
(&
sc¡_mgmt_lock
);

2493 
	`INIT_LIST_HEAD
(&
sc¡_£ss_š™_li¡
);

2494 
	`INIT_LIST_HEAD
(&
sc¡_£ss_shut_li¡
);

2495 
	`š™_wa™queue_h—d
(&
sc¡_dev_cmd_wa™Q
);

2496 
	`mu‹x_š™
(&
sc¡_su¥’d_mu‹x
);

2497 
	`mu‹x_š™
(&
sc¡_cmd_th»ads_mu‹x
);

2498 
	`INIT_LIST_HEAD
(&
sc¡_cmd_th»ads_li¡
);

2499 
	`ýumask_£Î
(&
deçuÉ_ýu_mask
);

2501 
	`sc¡_š™_th»ads
(&
sc¡_maš_cmd_th»ads
);

2503 
»s
 = 
	`sc¡_lib_š™
();

2504 ià(
»s
 != 0)

2505 
out_deš™_th»ads
;

2507 
sc¡_num_ýus
 = 
	`num_Úlše_ýus
();

2511 ià(
sc¡_th»ads
 == 0)

2512 
sc¡_th»ads
 = 
sc¡_num_ýus
;

2514 ià(
sc¡_th»ads
 < 1) {

2515 
	`PRINT_ERROR
("%s", "scst_threads can‚ot be†esshan 1");

2516 
sc¡_th»ads
 = 
sc¡_num_ýus
;

2520 
	#INIT_CACHEP
(
p
, 
s
) ({ \

2521 (
p
èð
	`KMEM_CACHE
(
s
, 
SCST_SLAB_FLAGS
); \

2522 
	`TRACE_MEM
("SÏb c»©e: % © %°siz%zd", #s, (
p
), \

2523 (
s
)); \

2524 (
p
); \

2525 })

	)

2528 
	#INIT_CACHEP_ALIGN
(
p
, 
s
) ({ \

2529 (
p
èð
	`KMEM_CACHE
(
s
, 
SCST_SLAB_FLAGS
|
SLAB_HWCACHE_ALIGN
);\

2530 
	`TRACE_MEM
("SÏb c»©e: % © %°siz%zd", #s, (
p
), \

2531 (
s
)); \

2532 (
p
); \

2533 })

	)

2535 
»s
 = -
ENOMEM
;

2536 ià(!
	`INIT_CACHEP
(
sc¡_mgmt_ÿch•
, 
sc¡_mgmt_cmd
))

2537 
out_lib_ex™
;

2538 ià(!
	`INIT_CACHEP
(
sc¡_mgmt_¡ub_ÿch•
, 
sc¡_mgmt_cmd_¡ub
))

2539 
out_de¡roy_mgmt_ÿche
;

2540 ià(!
	`INIT_CACHEP
(
sc¡_ua_ÿch•
, 
sc¡_tgt_dev_UA
))

2541 
out_de¡roy_mgmt_¡ub_ÿche
;

2543 
	ssc¡_£n£
 { 
ušt8_t
 
s
[
SCST_SENSE_BUFFERSIZE
]; };

2544 ià(!
	`INIT_CACHEP
(
sc¡_£n£_ÿch•
, 
sc¡_£n£
))

2545 
out_de¡roy_ua_ÿche
;

2547 ià(!
	`INIT_CACHEP
(
sc¡_«n_ÿch•
, 
sc¡_«n
))

2548 
out_de¡roy_£n£_ÿche
;

2549 ià(!
	`INIT_CACHEP_ALIGN
(
sc¡_cmd_ÿch•
, 
sc¡_cmd
))

2550 
out_de¡roy_«n_ÿche
;

2551 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


2552 ià(!
	`INIT_CACHEP_ALIGN
(
sc¡_£ss_ÿch•
, 
sc¡_£ssiÚ
))

2553 
out_de¡roy_cmd_ÿche
;

2556 ià(!
	`INIT_CACHEP
(
sc¡_£ss_ÿch•
, 
sc¡_£ssiÚ
))

2557 
out_de¡roy_cmd_ÿche
;

2559 ià(!
	`INIT_CACHEP
(
sc¡_dev_ÿch•
, 
sc¡_deviû
))

2560 
out_de¡roy_£ss_ÿche
;

2561 ià(!
	`INIT_CACHEP
(
sc¡_tgt_ÿch•
, 
sc¡_tgt
))

2562 
out_de¡roy_dev_ÿche
;

2563 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


2564 ià(!
	`INIT_CACHEP_ALIGN
(
sc¡_tgtd_ÿch•
, 
sc¡_tgt_dev
))

2565 
out_de¡roy_tgt_ÿche
;

2568 ià(!
	`INIT_CACHEP
(
sc¡_tgtd_ÿch•
, 
sc¡_tgt_dev
))

2569 
out_de¡roy_tgt_ÿche
;

2571 ià(!
	`INIT_CACHEP
(
sc¡_acgd_ÿch•
, 
sc¡_acg_dev
))

2572 
out_de¡roy_tgtd_ÿche
;

2574 
sc¡_mgmt_mempoÞ
 = 
	`mempoÞ_ü—‹
(64, 
mempoÞ_®loc_¦ab
,

2575 
mempoÞ_ä“_¦ab
, 
sc¡_mgmt_ÿch•
);

2576 ià(
sc¡_mgmt_mempoÞ
 =ð
NULL
) {

2577 
»s
 = -
ENOMEM
;

2578 
out_de¡roy_acg_ÿche
;

2586 
sc¡_mgmt_¡ub_mempoÞ
 = 
	`mempoÞ_ü—‹
(1024, 
mempoÞ_®loc_¦ab
,

2587 
mempoÞ_ä“_¦ab
, 
sc¡_mgmt_¡ub_ÿch•
);

2588 ià(
sc¡_mgmt_¡ub_mempoÞ
 =ð
NULL
) {

2589 
»s
 = -
ENOMEM
;

2590 
out_de¡roy_mgmt_mempoÞ
;

2593 
sc¡_ua_mempoÞ
 = 
	`mempoÞ_ü—‹
(512, 
mempoÞ_®loc_¦ab
,

2594 
mempoÞ_ä“_¦ab
, 
sc¡_ua_ÿch•
);

2595 ià(
sc¡_ua_mempoÞ
 =ð
NULL
) {

2596 
»s
 = -
ENOMEM
;

2597 
out_de¡roy_mgmt_¡ub_mempoÞ
;

2600 
sc¡_£n£_mempoÞ
 = 
	`mempoÞ_ü—‹
(1024, 
mempoÞ_®loc_¦ab
,

2601 
mempoÞ_ä“_¦ab
, 
sc¡_£n£_ÿch•
);

2602 ià(
sc¡_£n£_mempoÞ
 =ð
NULL
) {

2603 
»s
 = -
ENOMEM
;

2604 
out_de¡roy_ua_mempoÞ
;

2607 
sc¡_«n_mempoÞ
 = 
	`mempoÞ_ü—‹
(100, 
mempoÞ_®loc_¦ab
,

2608 
mempoÞ_ä“_¦ab
, 
sc¡_«n_ÿch•
);

2609 ià(
sc¡_«n_mempoÞ
 =ð
NULL
) {

2610 
»s
 = -
ENOMEM
;

2611 
out_de¡roy_£n£_mempoÞ
;

2614 
»s
 = 
	`sc¡_ev’t_š™
();

2615 ià(
»s
 != 0)

2616 
out_de¡roy_«n_mempoÞ
;

2618 
»s
 = 
	`sc¡_sysfs_š™
();

2619 ià(
»s
 != 0)

2620 
out_ev’t_ex™
;

2622 
	`sc¡_tg_š™
();

2624 ià(
sc¡_max_cmd_mem
 == 0) {

2625 
sysšfo
 
si
;

2627 
	`si_memšfo
(&
si
);

2628 #ià
BITS_PER_LONG
 == 32

2629 
sc¡_max_cmd_mem
 = 
	`mš
(

2630 (((
ušt64_t
)(
si
.
tÙ®¿m
 - si.
tÙ®high
è<< 
PAGE_SHIFT
)

2631 >> 20è>> 2, (
ušt64_t
)1 << 30);

2633 
sc¡_max_cmd_mem
 = (((
si
.
tÙ®¿m
 - si.
tÙ®high
è<< 
PAGE_SHIFT
)

2638 ià(
sc¡_max_dev_cmd_mem
 != 0) {

2639 ià(
sc¡_max_dev_cmd_mem
 > 
sc¡_max_cmd_mem
) {

2640 
	`PRINT_ERROR
("scst_max_dev_cmd_mem (%d) > "

2642 
sc¡_max_dev_cmd_mem
,

2643 
sc¡_max_cmd_mem
);

2644 
sc¡_max_dev_cmd_mem
 = 
sc¡_max_cmd_mem
;

2647 
sc¡_max_dev_cmd_mem
 = 
sc¡_max_cmd_mem
 * 2 / 5;

2649 
»s
 = 
	`sc¡_sgv_poÞs_š™
(

2650 ((
ušt64_t
)
sc¡_max_cmd_mem
 << 10è>> (
PAGE_SHIFT
 - 10), 0);

2651 ià(
»s
 != 0)

2652 
out_sysfs_þ—nup
;

2654 #ifdeà
CONFIG_SCST_PROC


2655 
»s
 = 
	`sc¡_®loc_add_acg
(
NULL
, 
SCST_DEFAULT_ACG_NAME
, 
çl£
, &
sc¡_deçuÉ_acg
);

2656 ià(
»s
 != 0)

2657 
out_de¡roy_sgv_poÞ
;

2660 
»s
 = 
	`scsi_»gi¡”_š‹rçû
(&
sc¡_š‹rçû
);

2661 ià(
»s
 != 0)

2662 #ifdeà
CONFIG_SCST_PROC


2663 
out_ä“_acg
;

2665 
out_de¡roy_sgv_poÞ
;

2668 
i
 = 0; i < ()
	`ARRAY_SIZE
(
sc¡_³rýu_šfos
); i++) {

2669 
	`©omic_£t
(&
sc¡_³rýu_šfos
[
i
].
ýu_cmd_couÁ
, 0);

2670 
	`¥š_lock_š™
(&
sc¡_³rýu_šfos
[
i
].
skËt_lock
);

2671 
	`INIT_LIST_HEAD
(&
sc¡_³rýu_šfos
[
i
].
skËt_cmd_li¡
);

2672 
	`skËt_š™
(&
sc¡_³rýu_šfos
[
i
].
skËt
,

2673 (*)
sc¡_cmd_skËt
,

2674 ()&
sc¡_³rýu_šfos
[
i
]);

2677 
	`TRACE_DBG
("%d CPU found, s¹šg %dh»ads", 
sc¡_num_ýus
,

2678 
sc¡_th»ads
);

2680 
»s
 = 
	`sc¡_¡¬t_glob®_th»ads
(
sc¡_th»ads
);

2681 ià(
»s
 < 0)

2682 
out_th»ad_ä“
;

2684 #ifdeà
CONFIG_SCST_PROC


2685 
»s
 = 
	`sc¡_´oc_š™_moduË
();

2686 ià(
»s
 != 0)

2687 
out_th»ad_ä“
;

2690 
»s
 = 
	`sc¡_cm_š™
();

2691 ià(
»s
 != 0)

2692 #ifdeà
CONFIG_SCST_PROC


2693 
out_´oc_þ—nup
;

2695 
out_th»ad_ä“
;

2698 
	`PRINT_INFO
("SCST version %s†oaded successfully (max mem for "

2699 "commªd %dMB,…” deviû %dMB)", 
SCST_VERSION_STRING
,

2700 
sc¡_max_cmd_mem
, 
sc¡_max_dev_cmd_mem
);

2702 
	`sc¡_´št_cÚfig
();

2704 
out
:

2705 
	`TRACE_EXIT_RES
(
»s
);

2706  
»s
;

2708 #ifdeà
CONFIG_SCST_PROC


2709 
out_´oc_þ—nup
:

2710 
	`sc¡_´oc_þ—nup_moduË
();

2713 
out_th»ad_ä“
:

2714 
	`sc¡_¡Ý_glob®_th»ads
();

2716 
	`scsi_uÄegi¡”_š‹rçû
(&
sc¡_š‹rçû
);

2718 #ifdeà
CONFIG_SCST_PROC


2719 
out_ä“_acg
:

2720 
	`sc¡_d–_ä“_acg
(
sc¡_deçuÉ_acg
, 
çl£
);

2723 
out_de¡roy_sgv_poÞ
:

2724 
	`sc¡_sgv_poÞs_deš™
();

2725 
	`sc¡_tg_þ—nup
();

2727 
out_sysfs_þ—nup
:

2728 
	`sc¡_sysfs_þ—nup
();

2730 
out_ev’t_ex™
:

2731 
	`sc¡_ev’t_ex™
();

2733 
out_de¡roy_«n_mempoÞ
:

2734 
	`mempoÞ_de¡roy
(
sc¡_«n_mempoÞ
);

2736 
out_de¡roy_£n£_mempoÞ
:

2737 
	`mempoÞ_de¡roy
(
sc¡_£n£_mempoÞ
);

2739 
out_de¡roy_ua_mempoÞ
:

2740 
	`mempoÞ_de¡roy
(
sc¡_ua_mempoÞ
);

2742 
out_de¡roy_mgmt_¡ub_mempoÞ
:

2743 
	`mempoÞ_de¡roy
(
sc¡_mgmt_¡ub_mempoÞ
);

2745 
out_de¡roy_mgmt_mempoÞ
:

2746 
	`mempoÞ_de¡roy
(
sc¡_mgmt_mempoÞ
);

2748 
out_de¡roy_acg_ÿche
:

2749 
	`kmem_ÿche_de¡roy
(
sc¡_acgd_ÿch•
);

2751 
out_de¡roy_tgtd_ÿche
:

2752 
	`kmem_ÿche_de¡roy
(
sc¡_tgtd_ÿch•
);

2754 
out_de¡roy_tgt_ÿche
:

2755 
	`kmem_ÿche_de¡roy
(
sc¡_tgt_ÿch•
);

2757 
out_de¡roy_dev_ÿche
:

2758 
	`kmem_ÿche_de¡roy
(
sc¡_dev_ÿch•
);

2760 
out_de¡roy_£ss_ÿche
:

2761 
	`kmem_ÿche_de¡roy
(
sc¡_£ss_ÿch•
);

2763 
out_de¡roy_cmd_ÿche
:

2764 
	`kmem_ÿche_de¡roy
(
sc¡_cmd_ÿch•
);

2766 
out_de¡roy_«n_ÿche
:

2767 
	`kmem_ÿche_de¡roy
(
sc¡_«n_ÿch•
);

2769 
out_de¡roy_£n£_ÿche
:

2770 
	`kmem_ÿche_de¡roy
(
sc¡_£n£_ÿch•
);

2772 
out_de¡roy_ua_ÿche
:

2773 
	`kmem_ÿche_de¡roy
(
sc¡_ua_ÿch•
);

2775 
out_de¡roy_mgmt_¡ub_ÿche
:

2776 
	`kmem_ÿche_de¡roy
(
sc¡_mgmt_¡ub_ÿch•
);

2778 
out_de¡roy_mgmt_ÿche
:

2779 
	`kmem_ÿche_de¡roy
(
sc¡_mgmt_ÿch•
);

2781 
out_lib_ex™
:

2782 
	`sc¡_lib_ex™
();

2784 
out_deš™_th»ads
:

2785 
	`sc¡_deš™_th»ads
(&
sc¡_maš_cmd_th»ads
);

2786 
out
;

2787 
	}
}

2789 
__ex™
 
	$ex™_sc¡
()

2791 
	`TRACE_ENTRY
();

2795 
	`sc¡_cm_ex™
();

2797 #ifdeà
CONFIG_SCST_PROC


2798 
	`sc¡_´oc_þ—nup_moduË
();

2801 
	`sc¡_¡Ý_glob®_th»ads
();

2803 
	`sc¡_deš™_th»ads
(&
sc¡_maš_cmd_th»ads
);

2805 
	`scsi_uÄegi¡”_š‹rçû
(&
sc¡_š‹rçû
);

2806 #ifdeà
CONFIG_SCST_PROC


2807 
	`sc¡_d–_ä“_acg
(
sc¡_deçuÉ_acg
, 
çl£
);

2810 
	`sc¡_sgv_poÞs_deš™
();

2812 
	`sc¡_tg_þ—nup
();

2814 
	`sc¡_sysfs_þ—nup
();

2816 
	`sc¡_ev’t_ex™
();

2818 
	#DEINIT_CACHEP
(
p
) do { \

2819 
	`kmem_ÿche_de¡roy
(
p
); \

2820 
p
 = 
NULL
; \

2821 } 0)

	)

2823 
	`mempoÞ_de¡roy
(
sc¡_mgmt_mempoÞ
);

2824 
	`mempoÞ_de¡roy
(
sc¡_mgmt_¡ub_mempoÞ
);

2825 
	`mempoÞ_de¡roy
(
sc¡_ua_mempoÞ
);

2826 
	`mempoÞ_de¡roy
(
sc¡_£n£_mempoÞ
);

2827 
	`mempoÞ_de¡roy
(
sc¡_«n_mempoÞ
);

2829 
	`DEINIT_CACHEP
(
sc¡_mgmt_ÿch•
);

2830 
	`DEINIT_CACHEP
(
sc¡_mgmt_¡ub_ÿch•
);

2831 
	`DEINIT_CACHEP
(
sc¡_ua_ÿch•
);

2832 
	`DEINIT_CACHEP
(
sc¡_£n£_ÿch•
);

2833 
	`DEINIT_CACHEP
(
sc¡_«n_ÿch•
);

2834 
	`DEINIT_CACHEP
(
sc¡_cmd_ÿch•
);

2835 
	`DEINIT_CACHEP
(
sc¡_£ss_ÿch•
);

2836 
	`DEINIT_CACHEP
(
sc¡_tgtd_ÿch•
);

2837 
	`DEINIT_CACHEP
(
sc¡_dev_ÿch•
);

2838 
	`DEINIT_CACHEP
(
sc¡_tgt_ÿch•
);

2839 
	`DEINIT_CACHEP
(
sc¡_acgd_ÿch•
);

2841 
	`sc¡_lib_ex™
();

2843 
	`PRINT_INFO
("%s", "SCST unloaded");

2845 
	`TRACE_EXIT
();

2847 
	}
}

2849 
moduË_š™
(
š™_sc¡
);

2850 
moduË_ex™
(
ex™_sc¡
);

2852 
MODULE_AUTHOR
("Vladislav Bolkhovitin");

2853 
MODULE_LICENSE
("GPL");

2854 
MODULE_DESCRIPTION
("SCSIarget core");

2855 
MODULE_VERSION
(
SCST_VERSION_STRING
);

	@scst/src/scst_mem.c

18 
	~<lšux/š™.h
>

19 
	~<lšux/k”Ãl.h
>

20 
	~<lšux/”ºo.h
>

21 
	~<lšux/li¡.h
>

22 
	~<lšux/¥šlock.h
>

23 
	~<lšux/¦ab.h
>

24 
	~<lšux/sched.h
>

25 
	~<lšux/mm.h
>

26 
	~<lšux/uni¡d.h
>

27 
	~<lšux/¡ršg.h
>

29 #ifdeà
INSIDE_KERNEL_TREE


30 
	~<sc¡/sc¡.h
>

32 
	~"sc¡.h
"

34 
	~"sc¡_´iv.h
"

35 
	~"sc¡_mem.h
"

37 
	#SGV_DEFAULT_PURGE_INTERVAL
 (60 * 
HZ
)

	)

38 
	#SGV_MIN_SHRINK_INTERVAL
 (1 * 
HZ
)

	)

41 
	#MAX_PAGES_PER_POOL
 50

	)

43 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 29)

44 #ià
defšed
(
CONFIG_LOCKDEP
è&& !defšed(
CONFIG_SCST_PROC
)

45 
lock_þass_key
 
	gsc¡_poÞ_key
;

46 
lockd•_m­
 
	gsc¡_poÞ_d•_m­
 =

47 
STATIC_LOCKDEP_MAP_INIT
("sc¡_poÞ_k»f", &
sc¡_poÞ_key
);

51 
sgv_poÞ
 *
	gsgv_nÜm_þu¡_poÞ
, *
	gsgv_nÜm_poÞ
, *
	gsgv_dma_poÞ
;

53 
©omic_t
 
	gsgv_·ges_tÙ®
 = 
ATOMIC_INIT
(0);

56 
	gsgv_hi_wmk
;

57 
	gsgv_lo_wmk
;

59 
	gsgv_max_loÿl_·ges
, 
	gsgv_max_Œªs_·ges
;

61 
DEFINE_SPINLOCK
(
sgv_poÞs_lock
);

62 
DEFINE_MUTEX
(
sgv_poÞs_mu‹x
);

65 
sgv_poÞ
 *
	gsgv_cur_purge_poÞ
;

66 
LIST_HEAD
(
sgv_aùive_poÞs_li¡
);

68 
©omic_t
 
	gsgv_»Ëa£s_Ú_hiwmk
 = 
ATOMIC_INIT
(0);

69 
©omic_t
 
	gsgv_»Ëa£s_Ú_hiwmk_çžed
 = 
ATOMIC_INIT
(0);

71 
©omic_t
 
	gsgv_Ùh”_tÙ®_®loc
 = 
ATOMIC_INIT
(0);

73 #ià(
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 23))

74 
shršk”
 *
	gsgv_shršk”
;

76 
shršk”
 
	gsgv_shršk”
;

79 
kmem_ÿche
 *
	gsgv_poÞ_ÿch•
;

85 
LIST_HEAD
(
sgv_poÞs_li¡
);

87 #iâdeà
CONFIG_SCST_PROC


88 
kobjeù
 *
	gsc¡_sgv_kobj
;

89 
sc¡_sgv_sysfs_ü—‹
(
sgv_poÞ
 *
poÞ
);

90 
sc¡_sgv_sysfs_d–
(
sgv_poÞ
 *
poÞ
);

93 
šlše
 
boÞ
 
	$sgv_poÞ_þu¡”ed
(cÚ¡ 
sgv_poÞ
 *
poÞ
)

95  
poÞ
->
þu¡”šg_ty³
 !ð
sgv_no_þu¡”šg
;

96 
	}
}

98 
	$sc¡_sgv_poÞ_u£_nÜm
(
sc¡_tgt_dev
 *
tgt_dev
)

100 
tgt_dev
->
tgt_dev_gå_mask
 = 
__GFP_NOWARN
;

101 
tgt_dev
->
poÞ
 = 
sgv_nÜm_poÞ
;

102 
tgt_dev
->
tgt_dev_þu¡_poÞ
 = 0;

103 
	}
}

105 
	$sc¡_sgv_poÞ_u£_nÜm_þu¡
(
sc¡_tgt_dev
 *
tgt_dev
)

107 
	`TRACE_MEM
("%s", "Use clustering");

108 
tgt_dev
->
tgt_dev_gå_mask
 = 
__GFP_NOWARN
;

109 
tgt_dev
->
poÞ
 = 
sgv_nÜm_þu¡_poÞ
;

110 
tgt_dev
->
tgt_dev_þu¡_poÞ
 = 1;

111 
	}
}

113 
	$sc¡_sgv_poÞ_u£_dma
(
sc¡_tgt_dev
 *
tgt_dev
)

115 
	`TRACE_MEM
("%s", "Use ISA DMA memory");

116 
tgt_dev
->
tgt_dev_gå_mask
 = 
__GFP_NOWARN
 | 
GFP_DMA
;

117 
tgt_dev
->
poÞ
 = 
sgv_dma_poÞ
;

118 
tgt_dev
->
tgt_dev_þu¡_poÞ
 = 0;

119 
	}
}

122 
	$sgv_dtÜ_ªd_ä“
(
sgv_poÞ_obj
 *
obj
)

124 
sgv_poÞ
 *
poÞ
 = 
obj
->
owÃr_poÞ
;

126 
	`TRACE_MEM
("De¡royšg sgv obj %p", 
obj
);

128 ià(
obj
->
sg_couÁ
 != 0) {

129 
poÞ
->
®loc_âs
.
	`ä“_·ges_â
(
obj
->
sg_’Œ›s
,

130 
obj
->
sg_couÁ
, obj->
®loÿtÜ_´iv
);

132 ià(
obj
->
sg_’Œ›s
 !ðobj->
sg_’Œ›s_d©a
) {

133 ià(
obj
->
Œªs_tbl
 !=

134 (
Œªs_tbl_’t
 *)
obj
->
sg_’Œ›s_d©a
) {

136 
	`kä“
(
obj
->
Œªs_tbl
);

137 
obj
->
Œªs_tbl
 = 
NULL
;

139 
	`kä“
(
obj
->
sg_’Œ›s
);

142 
	`kmem_ÿche_ä“
(
poÞ
->
ÿches
[
obj
->
ÿche_num
], obj);

144 
	}
}

147 
šlše
 
	$sgv_d–_äom_aùive
(
sgv_poÞ
 *
poÞ
)

149 
li¡_h—d
 *
Ãxt
;

151 
	`TRACE_MEM
("D–‘šg sgv…oÞ %°äomhaùivli¡", 
poÞ
);

153 
	`¥š_lock_bh
(&
sgv_poÞs_lock
);

155 
Ãxt
 = 
poÞ
->
sgv_aùive_poÞs_li¡_’Œy
.next;

156 
	`li¡_d–
(&
poÞ
->
sgv_aùive_poÞs_li¡_’Œy
);

158 ià(
sgv_cur_purge_poÞ
 =ð
poÞ
) {

159 
	`TRACE_MEM
("Sgv…oÞ %°i sgv cu¸purgpoÞ", 
poÞ
);

161 ià(
Ãxt
 =ð&
sgv_aùive_poÞs_li¡
)

162 
Ãxt
 =‚ext->next;

164 ià(
Ãxt
 =ð&
sgv_aùive_poÞs_li¡
) {

165 
sgv_cur_purge_poÞ
 = 
NULL
;

166 
	`TRACE_MEM
("%s", "Sgv‡ctive†ist‚owƒmpty");

168 
sgv_cur_purge_poÞ
 = 
	`li¡_’Œy
(
Ãxt
, 
	`ty³of
(*
poÞ
),

169 
sgv_aùive_poÞs_li¡_’Œy
);

170 
	`TRACE_MEM
("New sgv cur…urge…ool %p",

171 
sgv_cur_purge_poÞ
);

175 
	`¥š_uÆock_bh
(&
sgv_poÞs_lock
);

177 
	}
}

180 
	$sgv_dec_ÿched_’Œ›s
(
sgv_poÞ
 *
poÞ
, 
·ges
)

182 
poÞ
->
ÿched_’Œ›s
--;

183 
poÞ
->
ÿched_·ges
 -ð
·ges
;

185 ià(
poÞ
->
ÿched_’Œ›s
 == 0)

186 
	`sgv_d–_äom_aùive
(
poÞ
);

189 
	}
}

192 
	$__sgv_purge_äom_ÿche
(
sgv_poÞ_obj
 *
obj
)

194 
·ges
 = 
obj
->pages;

195 
sgv_poÞ
 *
poÞ
 = 
obj
->
owÃr_poÞ
;

197 
	`TRACE_MEM
("Purging sgv obj %p from…ool %p (new cached_entries %d)",

198 
obj
, 
poÞ
,…oÞ->
ÿched_’Œ›s
-1);

200 
	`li¡_d–
(&
obj
->
sÜ‹d_»cyþšg_li¡_’Œy
);

201 
	`li¡_d–
(&
obj
->
»cyþšg_li¡_’Œy
);

203 
poÞ
->
šaùive_ÿched_·ges
 -ð
·ges
;

204 
	`sgv_dec_ÿched_’Œ›s
(
poÞ
, 
·ges
);

206 
	`©omic_sub
(
·ges
, &
sgv_·ges_tÙ®
);

209 
	}
}

212 
boÞ
 
	$sgv_purge_äom_ÿche
(
sgv_poÞ_obj
 *
obj
, 
mš_š‹rv®
,

213 
cur_time
)

215 
	`EXTRACHECKS_BUG_ON
(
mš_š‹rv®
 < 0);

217 
	`TRACE_MEM
("Checking if sgv obj %p should be…urged (curime %ld, "

218 "objim%ld,imtØpurg%ld)", 
obj
, 
cur_time
,

219 
obj
->
time_¡amp
, obj->time_¡am°+ 
mš_š‹rv®
);

221 ià(
	`time_aá”_eq
(
cur_time
, (
obj
->
time_¡amp
 + 
mš_š‹rv®
))) {

222 
	`__sgv_purge_äom_ÿche
(
obj
);

223  
Œue
;

225  
çl£
;

226 
	}
}

229 
	$sgv_shršk_poÞ
(
sgv_poÞ
 *
poÞ
, 
Ä
, 
mš_š‹rv®
,

230 
cur_time
, *
out_ä“d
)

232 
ä“d
 = 0;

234 
	`TRACE_ENTRY
();

236 
	`TRACE_MEM
("Tryingo shrink…ool %p (nr %d, min_interval %d)",

237 
poÞ
, 
Ä
, 
mš_š‹rv®
);

239 ià(
poÞ
->
purge_š‹rv®
 < 0) {

240 
	`TRACE_MEM
("NÙ shrškabË…oÞ %p, skpšg", 
poÞ
);

241 
out
;

244 
	`¥š_lock_bh
(&
poÞ
->
sgv_poÞ_lock
);

246 !
	`li¡_em±y
(&
poÞ
->
sÜ‹d_»cyþšg_li¡
) &&

247 (
	`©omic_»ad
(&
sgv_·ges_tÙ®
è> 
sgv_lo_wmk
)) {

248 
sgv_poÞ_obj
 *
obj
 = 
	`li¡_fœ¡_’Œy
(

249 &
poÞ
->
sÜ‹d_»cyþšg_li¡
,

250 
sgv_poÞ_obj
, 
sÜ‹d_»cyþšg_li¡_’Œy
);

252 ià(
	`sgv_purge_äom_ÿche
(
obj
, 
mš_š‹rv®
, 
cur_time
)) {

253 
·ges
 = 
obj
->pages;

255 
ä“d
 +ð
·ges
;

256 
Ä
 -ð
·ges
;

258 
	`TRACE_MEM
("%d…ages…urged from…ool %p (nr†eft %d, "

259 "tÙ® f»ed %d)", 
·ges
, 
poÞ
, 
Ä
, 
ä“d
);

261 
	`¥š_uÆock_bh
(&
poÞ
->
sgv_poÞ_lock
);

262 
	`sgv_dtÜ_ªd_ä“
(
obj
);

263 
	`¥š_lock_bh
(&
poÞ
->
sgv_poÞ_lock
);

267 ià((
Ä
 <ð0è|| (
ä“d
 >ð
MAX_PAGES_PER_POOL
)) {

268 ià(
ä“d
 >ð
MAX_PAGES_PER_POOL
)

269 
	`TRACE_MEM
("%d…ages…urged from…ool %p, "

270 "Ëavšg", 
ä“d
, 
poÞ
);

275 
	`¥š_uÆock_bh
(&
poÞ
->
sgv_poÞ_lock
);

277 
out
:

278 *
out_ä“d
 +ð
ä“d
;

280 
	`TRACE_EXIT_RES
(
Ä
);

281  
Ä
;

282 
	}
}

285 
	$__sgv_shršk
(
Ä
, 
mš_š‹rv®
, *
out_ä“d
)

287 
sgv_poÞ
 *
poÞ
;

288 
cur_time
 = 
jiff›s
;

289 
´ev_Ä
 = 
Ä
;

290 
boÞ
 
cœþe
 = 
çl£
;

292 
	`TRACE_ENTRY
();

294 
	`TRACE_MEM
("Tryingo shrink %d…ages from‡ll sgv…ools "

295 "(mš_š‹rv® %d)", 
Ä
, 
mš_š‹rv®
);

297 
Ä
 > 0) {

298 
li¡_h—d
 *
Ãxt
;

300 
	`¥š_lock_bh
(&
sgv_poÞs_lock
);

302 
poÞ
 = 
sgv_cur_purge_poÞ
;

303 ià(
poÞ
 =ð
NULL
) {

304 ià(
	`li¡_em±y
(&
sgv_aùive_poÞs_li¡
)) {

305 
	`TRACE_MEM
("%s", "Active…ools†ist isƒmpty");

306 
out_uÆock
;

309 
poÞ
 = 
	`li¡_fœ¡_’Œy
(&
sgv_aùive_poÞs_li¡
,

310 
	`ty³of
(*
poÞ
),

311 
sgv_aùive_poÞs_li¡_’Œy
);

313 
	`sgv_poÞ_g‘
(
poÞ
);

315 
Ãxt
 = 
poÞ
->
sgv_aùive_poÞs_li¡_’Œy
.next;

316 ià(
Ãxt
 =ð&
sgv_aùive_poÞs_li¡
) {

317 ià(
cœþe
 && (
´ev_Ä
 =ð
Ä
)) {

318 
	`TRACE_MEM
("Full circle done, but‚o…rogress, "

319 "Ëavšg (Ä %d)", 
Ä
);

320 
out_uÆock_put
;

322 
cœþe
 = 
Œue
;

323 
´ev_Ä
 = 
Ä
;

325 
Ãxt
 =‚ext->next;

328 
sgv_cur_purge_poÞ
 = 
	`li¡_’Œy
(
Ãxt
, 
	`ty³of
(*
poÞ
),

329 
sgv_aùive_poÞs_li¡_’Œy
);

330 
	`TRACE_MEM
("New cu¸purgpoÞ %p", 
sgv_cur_purge_poÞ
);

332 
	`¥š_uÆock_bh
(&
sgv_poÞs_lock
);

334 
Ä
 = 
	`sgv_shršk_poÞ
(
poÞ
,‚r, 
mš_š‹rv®
, 
cur_time
, 
out_ä“d
);

336 
	`sgv_poÞ_put
(
poÞ
);

339 
out
:

340 
	`TRACE_EXIT_RES
(
Ä
);

341  
Ä
;

343 
out_uÆock
:

344 
	`¥š_uÆock_bh
(&
sgv_poÞs_lock
);

345 
out
;

347 
out_uÆock_put
:

348 
	`¥š_uÆock_bh
(&
sgv_poÞs_lock
);

349 
	`sgv_poÞ_put
(
poÞ
);

350 
out
;

351 
	}
}

353 
	$__sgv_ÿn_be_shrunk
()

355 
»s
;

356 
sgv_poÞ
 *
poÞ
;

357 
šaùive_·ges
 = 0;

359 
	`TRACE_ENTRY
();

361 
	`¥š_lock_bh
(&
sgv_poÞs_lock
);

362 
	`li¡_fÜ_—ch_’Œy
(
poÞ
, &
sgv_aùive_poÞs_li¡
,

363 
sgv_aùive_poÞs_li¡_’Œy
) {

364 ià(
poÞ
->
purge_š‹rv®
 > 0)

365 
šaùive_·ges
 +ð
poÞ
->
šaùive_ÿched_·ges
;

367 
	`¥š_uÆock_bh
(&
sgv_poÞs_lock
);

369 
»s
 = 
	`max
(()0, 
šaùive_·ges
 - 
sgv_lo_wmk
);

370 
	`TRACE_MEM
("Cª f»%ld (tÙ® %d)", 
»s
, 
	`©omic_»ad
(&
sgv_·ges_tÙ®
));

372 
	`TRACE_EXIT_RES
(
»s
);

373  
»s
;

374 
	}
}

376 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(3, 12, 0)

377 
	$sgv_ÿn_be_shrunk
(
shršk”
 *shrinker,

378 
shršk_cÚŒÞ
 *
sc
)

380  
	`__sgv_ÿn_be_shrunk
();

381 
	}
}

383 
	$sgv_sÿn_shršk
(
shršk”
 *shrinker,

384 
shršk_cÚŒÞ
 *
sc
)

386 
ä“d
 = 0;

388 
	`TRACE_ENTRY
();

390 
	`__sgv_shršk
(
sc
->
Ä_to_sÿn
, 
SGV_MIN_SHRINK_INTERVAL
, &
ä“d
);

391 
	`TRACE_MEM
("F»ed %d", 
ä“d
);

393 
	`TRACE_EXIT_RES
(
ä“d
);

394  
ä“d
;

395 
	}
}

397 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 35è&& (!
defšed
(
RHEL_MAJOR
) || RHEL_MAJOR -0 < 6)

398 
	$sgv_shršk
(
Ä
, 
gå_t
 
gåm
)

399 #–ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3, 0, 0)

400 
	$sgv_shršk
(
shršk”
 *shršk”, 
Ä
, 
gå_t
 
gåm
)

402 
	$sgv_shršk
(
shršk”
 *shršk”, 
shršk_cÚŒÞ
 *
sc
)

405 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(3, 0, 0)

406 
Ä
 = 
sc
->
Ä_to_sÿn
;

408 
ä“d
 = 0;

410 
	`TRACE_ENTRY
();

412 ià(
Ä
 > 0) {

413 
Ä
 = 
	`__sgv_shršk
Òr, 
SGV_MIN_SHRINK_INTERVAL
, &
ä“d
);

414 
	`TRACE_MEM
("Leá %d", 
Ä
);

416 
Ä
 = 
	`__sgv_ÿn_be_shrunk
();

418 
	`TRACE_EXIT_RES
(
Ä
);

419  
Ä
;

420 
	}
}

423 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 20)

424 
	$sgv_purge_wÜk_â
(*
p
)

426 
	$sgv_purge_wÜk_â
(
wÜk_¡ruù
 *
wÜk
)

429 
cur_time
 = 
jiff›s
;

430 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 20)

431 
sgv_poÞ
 *
poÞ
 = (sgv_poÞ *)
p
;

433 
sgv_poÞ
 *
poÞ
 = 
	`cÚš”_of
(
wÜk
, sgv_pool,

434 
sgv_purge_wÜk
.
wÜk
);

437 
	`TRACE_ENTRY
();

439 
	`TRACE_MEM
("PurgwÜk fÜ…oÞ %p", 
poÞ
);

441 
	`¥š_lock_bh
(&
poÞ
->
sgv_poÞ_lock
);

443 
poÞ
->
purge_wÜk_scheduËd
 = 
çl£
;

445 !
	`li¡_em±y
(&
poÞ
->
sÜ‹d_»cyþšg_li¡
)) {

446 
sgv_poÞ_obj
 *
obj
 = 
	`li¡_fœ¡_’Œy
(

447 &
poÞ
->
sÜ‹d_»cyþšg_li¡
,

448 
sgv_poÞ_obj
, 
sÜ‹d_»cyþšg_li¡_’Œy
);

450 ià(
	`sgv_purge_äom_ÿche
(
obj
, 
poÞ
->
purge_š‹rv®
, 
cur_time
)) {

451 
	`¥š_uÆock_bh
(&
poÞ
->
sgv_poÞ_lock
);

452 
	`sgv_dtÜ_ªd_ä“
(
obj
);

453 
	`¥š_lock_bh
(&
poÞ
->
sgv_poÞ_lock
);

460 
	`TRACE_MEM
("Rescheduling…urge work for…ool %p (delay "

461 "%d HZ/%d sec)", 
poÞ
,…oÞ->
purge_š‹rv®
,

462 
poÞ
->
purge_š‹rv®
/
HZ
);

463 
	`scheduË_d–ayed_wÜk
(&
poÞ
->
sgv_purge_wÜk
,

464 
poÞ
->
purge_š‹rv®
);

465 
poÞ
->
purge_wÜk_scheduËd
 = 
Œue
;

470 
	`¥š_uÆock_bh
(&
poÞ
->
sgv_poÞ_lock
);

472 
	`TRACE_MEM
("L—všg…urgwÜk fÜ…oÞ %p", 
poÞ
);

474 
	`TRACE_EXIT
();

476 
	}
}

478 
	$sgv_check_fuÎ_þu¡”šg
(
sÿ‰”li¡
 *
sg
, 
cur
, 
hšt
)

480 
»s
 = -1;

481 
i
 = 
hšt
;

482 
pâ_cur
 = 
	`·ge_to_pâ
(
	`sg_·ge
(&
sg
[
cur
]));

483 
Ën_cur
 = 
sg
[
cur
].
Ëngth
;

484 
pâ_cur_Ãxt
 = 
pâ_cur
 + (
Ën_cur
 >> 
PAGE_SHIFT
);

485 
fuÎ_·ge_cur
 = (
Ën_cur
 & (
PAGE_SIZE
 - 1)) == 0;

486 
pâ
, 
pâ_Ãxt
;

487 
boÞ
 
fuÎ_·ge
;

490 
	`TRACE_MEM
("pfn_cur %ld,…fn_cur_next %ld,†en_cur %d, full_page_cur %d",

491 
pâ_cur
, 
pâ_cur_Ãxt
, 
Ën_cur
, 
fuÎ_·ge_cur
);

495 ià(
i
 >= 0) {

496 
pâ
 = 
	`·ge_to_pâ
(
	`sg_·ge
(&
sg
[
i
]));

497 
pâ_Ãxt
 = 
pâ
 + (
sg
[
i
].
Ëngth
 >> 
PAGE_SHIFT
);

498 
fuÎ_·ge
 = (
sg
[
i
].
Ëngth
 & (
PAGE_SIZE
 - 1)) == 0;

500 ià((
pâ
 =ð
pâ_cur_Ãxt
è&& 
fuÎ_·ge_cur
)

501 
out_h—d
;

503 ià((
pâ_Ãxt
 =ð
pâ_cur
è&& 
fuÎ_·ge
)

504 
out_ž
;

508 
i
 = 
cur
 - 1; i >= 0; i--) {

509 
pâ
 = 
	`·ge_to_pâ
(
	`sg_·ge
(&
sg
[
i
]));

510 
pâ_Ãxt
 = 
pâ
 + (
sg
[
i
].
Ëngth
 >> 
PAGE_SHIFT
);

511 
fuÎ_·ge
 = (
sg
[
i
].
Ëngth
 & (
PAGE_SIZE
 - 1)) == 0;

513 ià((
pâ
 =ð
pâ_cur_Ãxt
è&& 
fuÎ_·ge_cur
)

514 
out_h—d
;

516 ià((
pâ_Ãxt
 =ð
pâ_cur
è&& 
fuÎ_·ge
)

517 
out_ž
;

520 
out
:

521  
»s
;

523 
out_ž
:

524 
	`TRACE_MEM
("SG segm’ˆ%d wžÈbž m”ged w™h segm’ˆ%d", 
cur
, 
i
);

525 
sg
[
i
].
Ëngth
 +ð
Ën_cur
;

526 
	`sg_þ—r
(&
sg
[
cur
]);

527 
»s
 = 
i
;

528 
out
;

530 
out_h—d
:

531 
	`TRACE_MEM
("SG segm’ˆ%d wžÈbh—d m”ged w™h segm’ˆ%d", 
cur
, 
i
);

532 
	`sg_assign_·ge
(&
sg
[
i
], 
	`sg_·ge
(&sg[
cur
]));

533 
sg
[
i
].
Ëngth
 +ð
Ën_cur
;

534 
	`sg_þ—r
(&
sg
[
cur
]);

535 
»s
 = 
i
;

536 
out
;

537 
	}
}

539 
	$sgv_check_ž_þu¡”šg
(
sÿ‰”li¡
 *
sg
, 
cur
, 
hšt
)

541 
»s
 = -1;

542 
pâ_cur
 = 
	`·ge_to_pâ
(
	`sg_·ge
(&
sg
[
cur
]));

543 
Ën_cur
 = 
sg
[
cur
].
Ëngth
;

544 
´ev
;

545 
pâ_´ev
;

546 
boÞ
 
fuÎ_·ge
;

548 #ifdeà
SCST_HIGHMEM


549 ià(
·ge
 >ð
highmem_¡¬t_·ge
) {

550 
	`TRACE_MEM
("%s", "HIGHMEM…age‡llocated,‚o clustering")

551 
out
;

556 
	`TRACE_MEM
("pfn_cur %ld,…fn_cur_next %ld,†en_cur %d, full_page_cur %d",

557 
pâ_cur
, 
pâ_cur_Ãxt
, 
Ën_cur
, 
fuÎ_·ge_cur
);

560 ià(
cur
 == 0)

561 
out
;

563 
´ev
 = 
cur
 - 1;

564 
pâ_´ev
 = 
	`·ge_to_pâ
(
	`sg_·ge
(&
sg
[
´ev
])) +

565 (
sg
[
´ev
].
Ëngth
 >> 
PAGE_SHIFT
);

566 
fuÎ_·ge
 = (
sg
[
´ev
].
Ëngth
 & (
PAGE_SIZE
 - 1)) == 0;

568 ià((
pâ_´ev
 =ð
pâ_cur
è&& 
fuÎ_·ge
) {

569 
	`TRACE_MEM
("SG segment %d will beail merged with segment %d",

570 
cur
, 
´ev
);

571 
sg
[
´ev
].
Ëngth
 +ð
Ën_cur
;

572 
	`sg_þ—r
(&
sg
[
cur
]);

573 
»s
 = 
´ev
;

576 
out
:

577  
»s
;

578 
	}
}

580 
	$sgv_ä“_sys_sg_’Œ›s
(
sÿ‰”li¡
 *
sg
, 
sg_couÁ
,

581 *
´iv
)

583 
i
;

585 
	`TRACE_MEM
("sg=%p, sg_couÁ=%d", 
sg
, 
sg_couÁ
);

587 
i
 = 0; i < 
sg_couÁ
; i++) {

588 
·ge
 *
p
 = 
	`sg_·ge
(&
sg
[
i
]);

589 
Ën
 = 
sg
[
i
].
Ëngth
;

590 
·ges
 = 
	`PAGE_ALIGN
(
Ën
è>> 
PAGE_SHIFT
;

592 
	`TRACE_MEM
("page %lx,†en %d,…ages %d",

593 ()
p
, 
Ën
, 
·ges
);

595 
·ges
 > 0) {

596 
Üd”
 = 0;

598 
	`TRACE_MEM
("free_pages(): order %d,…age %lx",

599 
Üd”
, ()
p
);

601 
	`__ä“_·ges
(
p
, 
Üd”
);

603 
·ges
 -ð1 << 
Üd”
;

604 
p
 +ð1 << 
Üd”
;

607 
	}
}

609 
·ge
 *
	$sgv_®loc_sys_·ges
(
sÿ‰”li¡
 *
sg
,

610 
gå_t
 
gå_mask
, *
´iv
)

612 
·ge
 *·gð
	`®loc_·ges
(
gå_mask
, 0);

614 
	`sg_£t_·ge
(
sg
, 
·ge
, 
PAGE_SIZE
, 0);

615 
	`TRACE_MEM
("·ge=%p, sg=%p,…riv=%p", 
·ge
, 
sg
, 
´iv
);

616 ià(
·ge
 =ð
NULL
) {

617 
	`TRACE
(
TRACE_OUT_OF_MEM
, "%s", "Allocation of "

620  
·ge
;

621 
	}
}

623 
	$sgv_®loc_sg_’Œ›s
(
sÿ‰”li¡
 *
sg
, 
·ges
,

624 
gå_t
 
gå_mask
, 
sgv_þu¡”šg_ty³s
 
þu¡”šg_ty³
,

625 
Œªs_tbl_’t
 *
Œªs_tbl
,

626 cÚ¡ 
sgv_poÞ_®loc_âs
 *
®loc_âs
, *
´iv
)

628 
sg_couÁ
 = 0;

629 
pg
, 
i
, 
j
;

630 
m”ged
 = -1;

632 
	`TRACE_MEM
("·ges=%d, clu¡”šg_ty³=%d", 
·ges
, 
þu¡”šg_ty³
);

635 
gå_mask
 |ð
__GFP_COLD
;

637 #ifdeà
CONFIG_SCST_STRICT_SECURITY


638 
gå_mask
 |ð
__GFP_ZERO
;

641 
pg
 = 0;…g < 
·ges
;…g++) {

642 *
rc
;

643 #ifdeà
CONFIG_SCST_DEBUG_OOM


644 ià(((
gå_mask
 & 
__GFP_NOFAIL
) != __GFP_NOFAIL) &&

645 ((
	`sc¡_¿ndom
() % 10000) == 55))

646 
rc
 = 
NULL
;

649 
rc
 = 
®loc_âs
->
	`®loc_·ges_â
(&
sg
[
sg_couÁ
], 
gå_mask
,

650 
´iv
);

651 ià(
rc
 =ð
NULL
)

652 
out_no_mem
;

660 ià(
þu¡”šg_ty³
 =ð
sgv_fuÎ_þu¡”šg
)

661 
m”ged
 = 
	`sgv_check_fuÎ_þu¡”šg
(
sg
, 
sg_couÁ
, merged);

662 ià(
þu¡”šg_ty³
 =ð
sgv_ž_þu¡”šg
)

663 
m”ged
 = 
	`sgv_check_ž_þu¡”šg
(
sg
, 
sg_couÁ
, merged);

665 
m”ged
 = -1;

667 ià(
m”ged
 == -1)

668 
sg_couÁ
++;

670 
	`TRACE_MEM
("pg=%d, m”ged=%d, sg_couÁ=%d", 
pg
, 
m”ged
,

671 
sg_couÁ
);

674 ià((
þu¡”šg_ty³
 !ð
sgv_no_þu¡”šg
è&& (
Œªs_tbl
 !ð
NULL
)) {

675 
pg
 = 0;

676 
i
 = 0; i < 
·ges
; i++) {

677 
n
 = 
	`PAGE_ALIGN
(
sg
[
i
].
Ëngth
è>> 
PAGE_SHIFT
;

679 
Œªs_tbl
[
i
].
pg_couÁ
 = 
pg
;

680 
j
 = 0; j < 
n
; j++)

681 
Œªs_tbl
[
pg
++].
sg_num
 = 
i
+1;

682 
	`TRACE_MEM
("i=%d,‚=%d,…g_couÁ=%d", 
i
, 
n
,

683 
Œªs_tbl
[
i
].
pg_couÁ
);

687 
out
:

688 
	`TRACE_MEM
("sg_couÁ=%d", 
sg_couÁ
);

689  
sg_couÁ
;

691 
out_no_mem
:

692 
®loc_âs
->
	`ä“_·ges_â
(
sg
, 
sg_couÁ
, 
´iv
);

693 
sg_couÁ
 = 0;

694 
out
;

695 
	}
}

697 
	$sgv_®loc_¬¿ys
(
sgv_poÞ_obj
 *
obj
,

698 
·ges_to_®loc
, 
gå_t
 
gå_mask
)

700 
sz
, 
tsz
 = 0;

701 
»s
 = 0;

703 
	`TRACE_ENTRY
();

705 
sz
 = 
·ges_to_®loc
 * (
obj
->
sg_’Œ›s
[0]);

707 
obj
->
sg_’Œ›s
 = 
	`km®loc
(
sz
, 
gå_mask
);

708 ià(
	`uÆik–y
(
obj
->
sg_’Œ›s
 =ð
NULL
)) {

709 
	`TRACE
(
TRACE_OUT_OF_MEM
, "Allocation of sgv_pool_obj "

710 "SG veùÜ fažed (siz%d)", 
sz
);

711 
»s
 = -
ENOMEM
;

712 
out
;

715 
	`sg_š™_bË
(
obj
->
sg_’Œ›s
, 
·ges_to_®loc
);

717 ià(
	`sgv_poÞ_þu¡”ed
(
obj
->
owÃr_poÞ
)) {

718 ià(
·ges_to_®loc
 <ð
sgv_max_Œªs_·ges
) {

719 
obj
->
Œªs_tbl
 =

720 (
Œªs_tbl_’t
 *)
obj
->
sg_’Œ›s_d©a
;

726 
tsz
 = 
·ges_to_®loc
 * (
obj
->
Œªs_tbl
[0]);

727 
obj
->
Œªs_tbl
 = 
	`kz®loc
(
tsz
, 
gå_mask
);

728 ià(
	`uÆik–y
(
obj
->
Œªs_tbl
 =ð
NULL
)) {

729 
	`TRACE
(
TRACE_OUT_OF_MEM
, "Allocation of "

730 "Œªs_tbÈçžed (siz%d)", 
tsz
);

731 
»s
 = -
ENOMEM
;

732 
out_ä“
;

737 
	`TRACE_MEM
("pages_to_alloc %d, sz %d,sz %d, obj %p, sg_entries %p, "

738 "Œªs_tbÈ%p", 
·ges_to_®loc
, 
sz
, 
tsz
, 
obj
, obj->
sg_’Œ›s
,

739 
obj
->
Œªs_tbl
);

741 
out
:

742 
	`TRACE_EXIT_RES
(
»s
);

743  
»s
;

745 
out_ä“
:

746 
	`kä“
(
obj
->
sg_’Œ›s
);

747 
obj
->
sg_’Œ›s
 = 
NULL
;

748 
out
;

749 
	}
}

751 
sgv_poÞ_obj
 *
	$sgv_g‘_obj
(
sgv_poÞ
 *
poÞ
, 
ÿche_num
,

752 
·ges
, 
gå_t
 
gå_mask
, 
boÞ
 
g‘_Ãw
)

754 
sgv_poÞ_obj
 *
obj
;

756 
	`¥š_lock_bh
(&
poÞ
->
sgv_poÞ_lock
);

758 ià(
	`uÆik–y
(
g‘_Ãw
)) {

760 
g‘_Ãw
;

763 ià(
	`lik–y
(!
	`li¡_em±y
(&
poÞ
->
»cyþšg_li¡s
[
ÿche_num
]))) {

764 
obj
 = 
	`li¡_fœ¡_’Œy
(&
poÞ
->
»cyþšg_li¡s
[
ÿche_num
],

765 
sgv_poÞ_obj
, 
»cyþšg_li¡_’Œy
);

767 
	`li¡_d–
(&
obj
->
sÜ‹d_»cyþšg_li¡_’Œy
);

768 
	`li¡_d–
(&
obj
->
»cyþšg_li¡_’Œy
);

770 
poÞ
->
šaùive_ÿched_·ges
 -ð
·ges
;

772 
	`¥š_uÆock_bh
(&
poÞ
->
sgv_poÞ_lock
);

773 
out
;

776 
g‘_Ãw
:

777 ià(
poÞ
->
ÿched_’Œ›s
 == 0) {

778 
	`TRACE_MEM
("Addšg…oÞ %°tØthaùivli¡", 
poÞ
);

779 
	`¥š_lock_bh
(&
sgv_poÞs_lock
);

780 
	`li¡_add_ž
(&
poÞ
->
sgv_aùive_poÞs_li¡_’Œy
,

781 &
sgv_aùive_poÞs_li¡
);

782 
	`¥š_uÆock_bh
(&
sgv_poÞs_lock
);

785 
poÞ
->
ÿched_’Œ›s
++;

786 
poÞ
->
ÿched_·ges
 +ð
·ges
;

788 
	`¥š_uÆock_bh
(&
poÞ
->
sgv_poÞ_lock
);

790 
	`TRACE_MEM
("New cachedƒÁr› %d (poÞ %p)", 
poÞ
->
ÿched_’Œ›s
,

791 
poÞ
);

793 
obj
 = 
	`kmem_ÿche_®loc
(
poÞ
->
ÿches
[
ÿche_num
],

794 
gå_mask
 & ~(
__GFP_HIGHMEM
|
GFP_DMA
));

795 ià(
	`lik–y
(
obj
)) {

796 
	`mem£t
(
obj
, 0, (*obj));

797 
obj
->
ÿche_num
 = cache_num;

798 
obj
->
·ges
 =…ages;

799 
obj
->
owÃr_poÞ
 = 
poÞ
;

801 
	`¥š_lock_bh
(&
poÞ
->
sgv_poÞ_lock
);

802 
	`sgv_dec_ÿched_’Œ›s
(
poÞ
, 
·ges
);

803 
	`¥š_uÆock_bh
(&
poÞ
->
sgv_poÞ_lock
);

806 
out
:

807  
obj
;

808 
	}
}

810 
	$sgv_put_obj
(
sgv_poÞ_obj
 *
obj
)

812 
sgv_poÞ
 *
poÞ
 = 
obj
->
owÃr_poÞ
;

813 
li¡_h—d
 *
’Œy
;

814 
li¡_h—d
 *
li¡
 = &
poÞ
->
»cyþšg_li¡s
[
obj
->
ÿche_num
];

815 
·ges
 = 
obj
->pages;

817 
	`¥š_lock_bh
(&
poÞ
->
sgv_poÞ_lock
);

819 
	`TRACE_MEM
("sgv %p, cachnum %d,…age %d, sg_couÁ %d", 
obj
,

820 
obj
->
ÿche_num
, 
·ges
, obj->
sg_couÁ
);

822 ià(
	`sgv_poÞ_þu¡”ed
(
poÞ
)) {

824 
	`__li¡_fÜ_—ch
(
’Œy
, 
li¡
) {

825 
sgv_poÞ_obj
 *
tmp
 = 
	`li¡_’Œy
(
’Œy
,

826 
sgv_poÞ_obj
, 
»cyþšg_li¡_’Œy
);

828 
	`TRACE_MEM
("tmp %p, cache‚um %d,…ages %d, sg_count %d",

829 
tmp
,mp->
ÿche_num
,mp->
·ges
,mp->
sg_couÁ
);

831 ià(
obj
->
sg_couÁ
 <ð
tmp
->sg_count)

834 
’Œy
 =ƒÁry->
´ev
;

836 
’Œy
 = 
li¡
;

838 
	`TRACE_MEM
("Addšg iÀ%°Öi¡ %p)", 
’Œy
, 
li¡
);

839 
	`li¡_add
(&
obj
->
»cyþšg_li¡_’Œy
, 
’Œy
);

841 
	`li¡_add_ž
(&
obj
->
sÜ‹d_»cyþšg_li¡_’Œy
,

842 &
poÞ
->
sÜ‹d_»cyþšg_li¡
);

844 
obj
->
time_¡amp
 = 
jiff›s
;

846 
poÞ
->
šaùive_ÿched_·ges
 +ð
·ges
;

848 ià(!
poÞ
->
purge_wÜk_scheduËd
) {

849 
	`TRACE_MEM
("Schedulšg…urgwÜk fÜ…oÞ %p", 
poÞ
);

850 
poÞ
->
purge_wÜk_scheduËd
 = 
Œue
;

851 
	`scheduË_d–ayed_wÜk
(&
poÞ
->
sgv_purge_wÜk
,

852 
poÞ
->
purge_š‹rv®
);

855 
	`¥š_uÆock_bh
(&
poÞ
->
sgv_poÞ_lock
);

857 
	}
}

860 
	$sgv_hiwmk_check
(
·ges_to_®loc
)

862 
»s
 = 0;

863 
·ges
 = 
·ges_to_®loc
;

865 
·ges
 +ð
	`©omic_»ad
(&
sgv_·ges_tÙ®
);

867 ià(
	`uÆik–y
(
·ges
 > 
sgv_hi_wmk
)) {

868 
ä“d
 = 0;

870 
·ges
 -ð
sgv_hi_wmk
;

871 
	`©omic_šc
(&
sgv_»Ëa£s_Ú_hiwmk
);

873 
·ges
 = 
	`__sgv_shršk
Õages, 0, &
ä“d
);

874 ià(
·ges
 > 0) {

875 
	`TRACE
(
TRACE_OUT_OF_MEM
, "Requested‡mount of "

880 "sc¡_max_cmd_mem?", 
·ges_to_®loc
,

881 
sgv_hi_wmk
);

882 
	`©omic_šc
(&
sgv_»Ëa£s_Ú_hiwmk_çžed
);

883 
»s
 = -
ENOMEM
;

884 
out_uÆock
;

888 
	`©omic_add
(
·ges_to_®loc
, &
sgv_·ges_tÙ®
);

890 
out_uÆock
:

891 
	`TRACE_MEM
("·ges_to_®loø%d,‚ewÙ® %d", 
·ges_to_®loc
,

892 
	`©omic_»ad
(&
sgv_·ges_tÙ®
));

894  
»s
;

895 
	}
}

898 
	$sgv_hiwmk_uncheck
(
·ges
)

900 
	`©omic_sub
(
·ges
, &
sgv_·ges_tÙ®
);

901 
	`TRACE_MEM
("·ge %d,‚ewÙ® %d", 
·ges
,

902 
	`©omic_»ad
(&
sgv_·ges_tÙ®
));

904 
	}
}

907 
boÞ
 
	$sgv_check_®lowed_mem
(
sc¡_mem_lim
 *
mem_lim
, 
·ges
)

909 
®loûd
;

910 
boÞ
 
»s
 = 
Œue
;

912 
®loûd
 = 
	`©omic_add_»tuº
(
·ges
, &
mem_lim
->
®loûd_·ges
);

913 ià(
	`uÆik–y
(
®loûd
 > 
mem_lim
->
max_®lowed_·ges
)) {

914 
	`TRACE
(
TRACE_OUT_OF_MEM
, "Requested‡mount of memory "

918 "sc¡_max_dev_cmd_mem?", 
·ges
,

919 
mem_lim
->
max_®lowed_·ges
);

920 
	`©omic_sub
(
·ges
, &
mem_lim
->
®loûd_·ges
);

921 
»s
 = 
çl£
;

924 
	`TRACE_MEM
("mem_lim %p,…age %d,„e %d,‚ew‡Îoûd %d", 
mem_lim
,

925 
·ges
, 
»s
, 
	`©omic_»ad
(&
mem_lim
->
®loûd_·ges
));

927  
»s
;

928 
	}
}

931 
	$sgv_uncheck_®lowed_mem
(
sc¡_mem_lim
 *
mem_lim
, 
·ges
)

933 
	`©omic_sub
(
·ges
, &
mem_lim
->
®loûd_·ges
);

935 
	`TRACE_MEM
("mem_lim %p,…age %d,‚ew‡Îoûd %d", 
mem_lim
,

936 
·ges
, 
	`©omic_»ad
(&
mem_lim
->
®loûd_·ges
));

938 
	}
}

955 
sÿ‰”li¡
 *
	$sgv_poÞ_®loc
(
sgv_poÞ
 *
poÞ
, 
size
,

956 
gå_t
 
gå_mask
, 
æags
, *
couÁ
,

957 
sgv_poÞ_obj
 **
sgv
, 
sc¡_mem_lim
 *
mem_lim
, *
´iv
)

959 
sgv_poÞ_obj
 *
obj
;

960 
ÿche_num
, 
·ges
, 
út
;

961 
sÿ‰”li¡
 *
»s
 = 
NULL
;

962 
·ges_to_®loc
;

963 
no_ÿched
 = 
æags
 & 
SGV_POOL_ALLOC_NO_CACHED
;

964 
boÞ
 
®lowed_mem_checked
 = 
çl£
, 
hiwmk_checked
 = false;

966 
	`TRACE_ENTRY
();

968 ià(
	`uÆik–y
(
size
 == 0))

969 
out
;

971 
	`EXTRACHECKS_BUG_ON
((
gå_mask
 & 
__GFP_NOFAIL
) == __GFP_NOFAIL);

973 
·ges
 = 
	`PAGE_ALIGN
(
size
è>> 
PAGE_SHIFT
;

974 ià(
poÞ
->
sšgË_®loc_·ges
 == 0) {

975 
·ges_Üd”
 = 
	`g‘_Üd”
(
size
);

977 
ÿche_num
 = 
·ges_Üd”
;

978 
·ges_to_®loc
 = (1 << 
·ges_Üd”
);

980 
ÿche_num
 = 0;

981 
·ges_to_®loc
 = 
	`max
(
poÞ
->
sšgË_®loc_·ges
, 
·ges
);

984 
	`TRACE_MEM
("size=%d,…ages=%d,…ages_to_alloc=%d, cache‚um=%d, "

985 "æags=%x,‚o_ÿched=%d, *sgv=%p", 
size
, 
·ges
,

986 
·ges_to_®loc
, 
ÿche_num
, 
æags
, 
no_ÿched
, *
sgv
);

988 ià(*
sgv
 !ð
NULL
) {

989 
obj
 = *
sgv
;

991 
	`TRACE_MEM
("Suµl›d obj %p, cachnum %d", 
obj
, obj->
ÿche_num
);

993 
	`EXTRACHECKS_BUG_ON
(
obj
->
sg_couÁ
 != 0);

995 ià(
	`uÆik–y
(!
	`sgv_check_®lowed_mem
(
mem_lim
, 
·ges_to_®loc
)))

996 
out_çž_ä“_sg_’Œ›s
;

997 
®lowed_mem_checked
 = 
Œue
;

999 ià(
	`uÆik–y
(
	`sgv_hiwmk_check
(
·ges_to_®loc
) != 0))

1000 
out_çž_ä“_sg_’Œ›s
;

1001 
hiwmk_checked
 = 
Œue
;

1002 } ià((
·ges_to_®loc
 <ð
poÞ
->
max_ÿched_·ges
è&& !
no_ÿched
) {

1003 ià(
	`uÆik–y
(!
	`sgv_check_®lowed_mem
(
mem_lim
, 
·ges_to_®loc
)))

1004 
out_çž
;

1005 
®lowed_mem_checked
 = 
Œue
;

1007 
obj
 = 
	`sgv_g‘_obj
(
poÞ
, 
ÿche_num
, 
·ges_to_®loc
, 
gå_mask
,

1008 
æags
 & 
SGV_POOL_ALLOC_GET_NEW
);

1009 ià(
	`uÆik–y
(
obj
 =ð
NULL
)) {

1010 
	`TRACE
(
TRACE_OUT_OF_MEM
, "Allocation of "

1011 "sgv_poÞ_obj fažed (siz%d)", 
size
);

1012 
out_çž
;

1015 ià(
obj
->
sg_couÁ
 != 0) {

1016 
	`TRACE_MEM
("Cached obj %p", 
obj
);

1017 
	`©omic_šc
(&
poÞ
->
ÿche_acc
[
ÿche_num
].
h™_®loc
);

1018 
sucûss
;

1021 ià(
æags
 & 
SGV_POOL_NO_ALLOC_ON_CACHE_MISS
) {

1022 ià(!(
æags
 & 
SGV_POOL_RETURN_OBJ_ON_ALLOC_FAIL
))

1023 
out_çž_ä“
;

1026 ià(
	`lik–y
(!
obj
->
»cyþšg_li¡_’Œy
.
Ãxt
)) {

1027 
	`TRACE_MEM
("B¿nd‚ew obj %p", 
obj
);

1028 } ià(
	`uÆik–y
(
obj
->
sg_’Œ›s
 !ðobj->
sg_’Œ›s_d©a
)) {

1029 
	`TRACE_MEM
("Cached obj %°w™h sg_couÁ =ð0", 
obj
);

1030 
	`kä“
(
obj
->
sg_’Œ›s
);

1031 
obj
->
sg_’Œ›s
 = 
NULL
;

1034 ià(
·ges_to_®loc
 <ð
sgv_max_loÿl_·ges
) {

1035 
obj
->
sg_’Œ›s
 = obj->
sg_’Œ›s_d©a
;

1036 
	`sg_š™_bË
(
obj
->
sg_’Œ›s
, 
·ges_to_®loc
);

1037 
	`TRACE_MEM
("sg_’Œ› %p", 
obj
->
sg_’Œ›s
);

1038 ià(
	`sgv_poÞ_þu¡”ed
(
poÞ
)) {

1039 
obj
->
Œªs_tbl
 = (
Œªs_tbl_’t
 *)

1040 (
obj
->
sg_’Œ›s
 + 
·ges_to_®loc
);

1041 
	`TRACE_MEM
("Œªs_tbÈ%p", 
obj
->
Œªs_tbl
);

1049 ià(
	`uÆik–y
(
	`sgv_®loc_¬¿ys
(
obj
, 
·ges_to_®loc
,

1050 
gå_mask
) != 0))

1051 
out_çž_ä“
;

1054 ià((
æags
 & 
SGV_POOL_NO_ALLOC_ON_CACHE_MISS
) &&

1055 (
æags
 & 
SGV_POOL_RETURN_OBJ_ON_ALLOC_FAIL
))

1056 
out_»tuº
;

1058 
obj
->
®loÿtÜ_´iv
 = 
´iv
;

1060 ià(
	`uÆik–y
(
	`sgv_hiwmk_check
(
·ges_to_®loc
) != 0))

1061 
out_çž_ä“_sg_’Œ›s
;

1062 
hiwmk_checked
 = 
Œue
;

1064 
sz
;

1066 
·ges_to_®loc
 = 
·ges
;

1068 ià(
	`uÆik–y
(!
	`sgv_check_®lowed_mem
(
mem_lim
, 
·ges_to_®loc
)))

1069 
out_çž
;

1070 
®lowed_mem_checked
 = 
Œue
;

1072 ià(
æags
 & 
SGV_POOL_NO_ALLOC_ON_CACHE_MISS
)

1073 
out_»tuº2
;

1075 
sz
 = (*
obj
è+ 
·ges
 * (obj->
sg_’Œ›s
[0]);

1077 
obj
 = 
	`km®loc
(
sz
, 
gå_mask
);

1078 ià(
	`uÆik–y
(
obj
 =ð
NULL
)) {

1079 
	`TRACE
(
TRACE_OUT_OF_MEM
, "Allocation of "

1080 "sgv_poÞ_obj fažed (siz%d)", 
size
);

1081 
out_çž
;

1083 
	`mem£t
(
obj
, 0, (*obj));

1085 
obj
->
owÃr_poÞ
 = 
poÞ
;

1086 
ÿche_num
 = -1;

1087 
obj
->
ÿche_num
 = cache_num;

1088 
obj
->
·ges
 = 
·ges_to_®loc
;

1089 
obj
->
®loÿtÜ_´iv
 = 
´iv
;

1091 
obj
->
sg_’Œ›s
 = obj->
sg_’Œ›s_d©a
;

1092 
	`sg_š™_bË
(
obj
->
sg_’Œ›s
, 
·ges
);

1094 ià(
	`uÆik–y
(
	`sgv_hiwmk_check
(
·ges_to_®loc
) != 0))

1095 
out_çž_ä“_sg_’Œ›s
;

1096 
hiwmk_checked
 = 
Œue
;

1098 
	`TRACE_MEM
("Big o¸no_ÿched obj %°(siz%d)", 
obj
, 
sz
);

1101 
obj
->
sg_couÁ
 = 
	`sgv_®loc_sg_’Œ›s
(obj->
sg_’Œ›s
,

1102 
·ges_to_®loc
, 
gå_mask
, 
poÞ
->
þu¡”šg_ty³
,

1103 
obj
->
Œªs_tbl
, &
poÞ
->
®loc_âs
, 
´iv
);

1104 ià(
	`uÆik–y
(
obj
->
sg_couÁ
 <= 0)) {

1105 
obj
->
sg_couÁ
 = 0;

1106 ià((
æags
 & 
SGV_POOL_RETURN_OBJ_ON_ALLOC_FAIL
) &&

1107 (
ÿche_num
 >= 0))

1108 
out_»tuº1
;

1110 
out_çž_ä“_sg_’Œ›s
;

1113 ià(
ÿche_num
 >= 0) {

1114 
	`©omic_add
(
·ges_to_®loc
 - 
obj
->
sg_couÁ
,

1115 &
poÞ
->
ÿche_acc
[
ÿche_num
].
m”ged
);

1117 ià(
no_ÿched
) {

1118 
	`©omic_add
(
·ges_to_®loc
,

1119 &
poÞ
->
Ùh”_·ges
);

1120 
	`©omic_add
(
·ges_to_®loc
 - 
obj
->
sg_couÁ
,

1121 &
poÞ
->
Ùh”_m”ged
);

1123 
	`©omic_add
(
·ges_to_®loc
,

1124 &
poÞ
->
big_·ges
);

1125 
	`©omic_add
(
·ges_to_®loc
 - 
obj
->
sg_couÁ
,

1126 &
poÞ
->
big_m”ged
);

1130 
sucûss
:

1131 ià(
ÿche_num
 >= 0) {

1132 
sg
;

1134 
	`©omic_šc
(&
poÞ
->
ÿche_acc
[
ÿche_num
].
tÙ®_®loc
);

1135 ià(
	`sgv_poÞ_þu¡”ed
(
poÞ
))

1136 
út
 = 
obj
->
Œªs_tbl
[
·ges
-1].
sg_num
;

1138 
út
 = 
·ges
;

1139 
sg
 = 
út
-1;

1140 
obj
->
Üig_sg
 = 
sg
;

1141 
obj
->
Üig_Ëngth
 = obj->
sg_’Œ›s
[
sg
].
Ëngth
;

1142 ià(
	`sgv_poÞ_þu¡”ed
(
poÞ
)) {

1143 
obj
->
sg_’Œ›s
[
sg
].
Ëngth
 =

1144 (
·ges
 - 
obj
->
Œªs_tbl
[
sg
].
pg_couÁ
è<< 
PAGE_SHIFT
;

1147 
út
 = 
obj
->
sg_couÁ
;

1148 ià(
no_ÿched
)

1149 
	`©omic_šc
(&
poÞ
->
Ùh”_®loc
);

1151 
	`©omic_šc
(&
poÞ
->
big_®loc
);

1154 *
couÁ
 = 
út
;

1155 
»s
 = 
obj
->
sg_’Œ›s
;

1156 *
sgv
 = 
obj
;

1158 
obj
->
sg_’Œ›s
[
út
-1].
Ëngth
 -ð
	`PAGE_ALIGN
(
size
) - size;

1160 
	`TRACE_MEM
("obj=%p, sg_entries %p (size=%d,…ages=%d, sg_count=%d, "

1161 "couÁ=%d,†a¡_Ën=%d)", 
obj
, obj->
sg_’Œ›s
, 
size
, 
·ges
,

1162 
obj
->
sg_couÁ
, *
couÁ
, obj->
sg_’Œ›s
[obj->
Üig_sg
].
Ëngth
);

1164 
out
:

1165 
	`TRACE_EXIT_HRES
(
»s
);

1166  
»s
;

1168 
out_»tuº
:

1169 
obj
->
®loÿtÜ_´iv
 = 
´iv
;

1170 
obj
->
owÃr_poÞ
 = 
poÞ
;

1172 
out_»tuº1
:

1173 *
sgv
 = 
obj
;

1174 
	`TRACE_MEM
("R‘uºšg fažed obj %p", 
obj
);

1176 
out_»tuº2
:

1177 *
couÁ
 = 
·ges_to_®loc
;

1178 
»s
 = 
NULL
;

1179 
out_uncheck
;

1181 
out_çž_ä“_sg_’Œ›s
:

1182 ià(
obj
->
sg_’Œ›s
 !ðobj->
sg_’Œ›s_d©a
) {

1183 ià(
obj
->
Œªs_tbl
 !=

1184 (
Œªs_tbl_’t
 *)
obj
->
sg_’Œ›s_d©a
) {

1186 
	`kä“
(
obj
->
Œªs_tbl
);

1187 
obj
->
Œªs_tbl
 = 
NULL
;

1189 
	`kä“
(
obj
->
sg_’Œ›s
);

1190 
obj
->
sg_’Œ›s
 = 
NULL
;

1193 
out_çž_ä“
:

1194 ià(
ÿche_num
 >= 0) {

1195 
	`¥š_lock_bh
(&
poÞ
->
sgv_poÞ_lock
);

1196 
	`sgv_dec_ÿched_’Œ›s
(
poÞ
, 
·ges_to_®loc
);

1197 
	`¥š_uÆock_bh
(&
poÞ
->
sgv_poÞ_lock
);

1199 
	`kmem_ÿche_ä“
(
poÞ
->
ÿches
[
obj
->
ÿche_num
], obj);

1201 
	`kä“
(
obj
);

1203 
out_çž
:

1204 
»s
 = 
NULL
;

1205 *
couÁ
 = 0;

1206 *
sgv
 = 
NULL
;

1207 
	`TRACE_MEM
("%s", "Allocation failed");

1209 
out_uncheck
:

1210 ià(
hiwmk_checked
)

1211 
	`sgv_hiwmk_uncheck
(
·ges_to_®loc
);

1212 ià(
®lowed_mem_checked
)

1213 
	`sgv_uncheck_®lowed_mem
(
mem_lim
, 
·ges_to_®loc
);

1214 
out
;

1215 
	}
}

1216 
EXPORT_SYMBOL_GPL
(
sgv_poÞ_®loc
);

1224 *
	$sgv_g‘_´iv
(
sgv_poÞ_obj
 *
obj
)

1226  
obj
->
®loÿtÜ_´iv
;

1227 
	}
}

1228 
EXPORT_SYMBOL_GPL
(
sgv_g‘_´iv
);

1238 
	$sgv_poÞ_ä“
(
sgv_poÞ_obj
 *
obj
, 
sc¡_mem_lim
 *
mem_lim
)

1240 
·ges
 = (
obj
->
sg_couÁ
 != 0) ? obj->pages : 0;

1242 
	`TRACE_MEM
("Freeing obj %p, cache‚um %d,…ages %d, sg_entries %p, "

1243 "sg_couÁ %d,‡ÎoÿtÜ_´iv %p", 
obj
, obj->
ÿche_num
, 
·ges
,

1244 
obj
->
sg_’Œ›s
, obj->
sg_couÁ
, obj->
®loÿtÜ_´iv
);

1259 
sÿ‰”li¡
 *
sg
 = 
obj
->
sg_’Œ›s
;

1260 
i
;

1262 
i
 = 0; i < 
obj
->
sg_couÁ
; i++) {

1263 
·ge
 *
p
 = 
	`sg_·ge
(&
sg
[
i
]);

1264 
Ën
 = 
sg
[
i
].
Ëngth
;

1265 
·ges
 = 
	`PAGE_ALIGN
(
Ën
è>> 
PAGE_SHIFT
;

1267 
·ges
 > 0) {

1268 ià(
	`·ge_couÁ
(
p
) != 1) {

1269 
	`PRINT_WARNING
("Freeing…age %p with "

1272 
p
, 
	`·ge_couÁ
(p));

1273 
	`WARN_ON
(1);

1275 
·ges
--;

1276 
p
++;

1282 ià(
obj
->
ÿche_num
 >= 0) {

1283 
obj
->
sg_’Œ›s
[obj->
Üig_sg
].
Ëngth
 = obj->
Üig_Ëngth
;

1284 
	`sgv_put_obj
(
obj
);

1286 
obj
->
owÃr_poÞ
->
®loc_âs
.
	`ä“_·ges_â
(obj->
sg_’Œ›s
,

1287 
obj
->
sg_couÁ
, obj->
®loÿtÜ_´iv
);

1288 
	`kä“
(
obj
);

1289 
	`sgv_hiwmk_uncheck
(
·ges
);

1292 
	`sgv_uncheck_®lowed_mem
(
mem_lim
, 
·ges
);

1294 
	}
}

1295 
EXPORT_SYMBOL_GPL
(
sgv_poÞ_ä“
);

1308 
sÿ‰”li¡
 *
	$sc¡_®loc_sg
(
size
, 
gå_t
 
gå_mask
, *
couÁ
)

1310 
sÿ‰”li¡
 *
»s
;

1311 
·ges
 = 
	`PAGE_ALIGN
(
size
è>> 
PAGE_SHIFT
;

1312 
sgv_poÞ_®loc_âs
 
sys_®loc_âs
 = {

1313 
sgv_®loc_sys_·ges
, 
sgv_ä“_sys_sg_’Œ›s
 };

1314 
no_çž
 = ((
gå_mask
 & 
__GFP_NOFAIL
) == __GFP_NOFAIL);

1315 
út
;

1317 
	`TRACE_ENTRY
();

1319 
	`©omic_šc
(&
sgv_Ùh”_tÙ®_®loc
);

1321 ià(
	`uÆik–y
(
	`sgv_hiwmk_check
(
·ges
) != 0)) {

1322 ià(!
no_çž
) {

1323 
»s
 = 
NULL
;

1324 
out
;

1331 
	`sgv_hiwmk_uncheck
(-
·ges
);

1335 
»s
 = 
	`km®loc_¬¿y
(
·ges
, (*»s), 
gå_mask
);

1336 ià(
»s
 =ð
NULL
) {

1337 
	`TRACE
(
TRACE_OUT_OF_MEM
, "Unableo‡llocate sg for %d…ages",

1338 
·ges
);

1339 
out_uncheck
;

1342 
	`sg_š™_bË
(
»s
, 
·ges
);

1349 
út
 = 
	`sgv_®loc_sg_’Œ›s
(
»s
, 
·ges
, 
gå_mask
, 
sgv_no_þu¡”šg
,

1350 
NULL
, &
sys_®loc_âs
, NULL);

1351 ià(
út
 <= 0)

1352 
out_ä“
;

1354 
»s
[
út
-1].
Ëngth
 -ð
	`PAGE_ALIGN
(
size
) - size;

1356 *
couÁ
 = 
út
;

1358 
out
:

1359 
	`TRACE_MEM
("AÎoûd sg %°(couÁ %d,‚o_çž %d)", 
»s
, *
couÁ
, 
no_çž
);

1361 
	`TRACE_EXIT_HRES
(
»s
);

1362  
»s
;

1364 
out_ä“
:

1365 
	`kä“
(
»s
);

1366 
»s
 = 
NULL
;

1368 
out_uncheck
:

1369 ià(!
no_çž
)

1370 
	`sgv_hiwmk_uncheck
(
·ges
);

1371 
out
;

1372 
	}
}

1373 
EXPORT_SYMBOL_GPL
(
sc¡_®loc_sg
);

1380 
	$sc¡_ä“_sg
(
sÿ‰”li¡
 *
sg
, 
couÁ
)

1382 
	`TRACE_MEM
("F»ešg sg=%p", 
sg
);

1384 
	`sgv_hiwmk_uncheck
(
couÁ
);

1386 
	`sgv_ä“_sys_sg_’Œ›s
(
sg
, 
couÁ
, 
NULL
);

1387 
	`kä“
(
sg
);

1389 
	}
}

1390 
EXPORT_SYMBOL_GPL
(
sc¡_ä“_sg
);

1393 
	$sgv_poÞ_š™_ÿche
(
sgv_poÞ
 *
poÞ
, 
ÿche_num
)

1395 
size
;

1396 
·ges
;

1397 
sgv_poÞ_obj
 *
obj
;

1399 
	`©omic_£t
(&
poÞ
->
ÿche_acc
[
ÿche_num
].
tÙ®_®loc
, 0);

1400 
	`©omic_£t
(&
poÞ
->
ÿche_acc
[
ÿche_num
].
h™_®loc
, 0);

1401 
	`©omic_£t
(&
poÞ
->
ÿche_acc
[
ÿche_num
].
m”ged
, 0);

1403 ià(
poÞ
->
sšgË_®loc_·ges
 == 0)

1404 
·ges
 = 1 << 
ÿche_num
;

1406 
·ges
 = 
poÞ
->
sšgË_®loc_·ges
;

1408 ià(
·ges
 <ð
sgv_max_loÿl_·ges
) {

1409 
size
 = (*
obj
è+ 
·ges
 *

1410 ((
obj
->
sg_’Œ›s
[0]) +

1411 ((
poÞ
->
þu¡”šg_ty³
 !ð
sgv_no_þu¡”šg
) ?

1412 (
obj
->
Œªs_tbl
[0]) : 0));

1413 } ià(
·ges
 <ð
sgv_max_Œªs_·ges
) {

1418 
size
 = (*
obj
è+ 
·ges
 *

1419 (((
poÞ
->
þu¡”šg_ty³
 !ð
sgv_no_þu¡”šg
) ?

1420 (
obj
->
Œªs_tbl
[0]) : 0));

1422 
size
 = (*
obj
);

1426 
	`TRACE_MEM
("·ges=%d, size=%d", 
·ges
, 
size
);

1428 
	`sú´štf
(
poÞ
->
ÿche_Çmes
[
ÿche_num
],

1429 (
poÞ
->
ÿche_Çmes
[
ÿche_num
]),

1430 "%s-%uK", 
poÞ
->
Çme
, (
·ges
 << 
PAGE_SHIFT
) >> 10);

1431 
poÞ
->
ÿches
[
ÿche_num
] = 
	`kmem_ÿche_ü—‹
(

1432 
poÞ
->
ÿche_Çmes
[
ÿche_num
], 
size
,

1433 0, 
SCST_SLAB_FLAGS
|
SLAB_HWCACHE_ALIGN
, 
NULL


1434 #ià(
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 23))

1435 , 
NULL
);

1440 
	}
}

1443 
	$sgv_poÞ_š™
(
sgv_poÞ
 *
poÞ
, cÚ¡ *
Çme
,

1444 
sgv_þu¡”šg_ty³s
 
þu¡”šg_ty³
, 
sšgË_®loc_·ges
,

1445 
purge_š‹rv®
)

1447 
»s
 = -
ENOMEM
;

1448 
i
;

1450 
	`TRACE_ENTRY
();

1452 ià(
sšgË_®loc_·ges
 < 0) {

1453 
	`PRINT_ERROR
("Wrong single_alloc_pages value %d",

1454 
sšgË_®loc_·ges
);

1455 
»s
 = -
EINVAL
;

1456 
out
;

1459 
	`mem£t
(
poÞ
, 0, (*pool));

1461 
	`©omic_£t
(&
poÞ
->
big_®loc
, 0);

1462 
	`©omic_£t
(&
poÞ
->
big_·ges
, 0);

1463 
	`©omic_£t
(&
poÞ
->
big_m”ged
, 0);

1464 
	`©omic_£t
(&
poÞ
->
Ùh”_®loc
, 0);

1465 
	`©omic_£t
(&
poÞ
->
Ùh”_·ges
, 0);

1466 
	`©omic_£t
(&
poÞ
->
Ùh”_m”ged
, 0);

1468 
poÞ
->
þu¡”šg_ty³
 = clustering_type;

1469 
poÞ
->
sšgË_®loc_·ges
 = single_alloc_pages;

1470 ià(
purge_š‹rv®
 != 0) {

1471 
poÞ
->
purge_š‹rv®
 =…urge_interval;

1472 ià(
purge_š‹rv®
 < 0) {

1474 
poÞ
->
purge_wÜk_scheduËd
 = 1;

1477 
poÞ
->
purge_š‹rv®
 = 
SGV_DEFAULT_PURGE_INTERVAL
;

1478 ià(
sšgË_®loc_·ges
 == 0) {

1479 
poÞ
->
max_ÿches
 = 
SGV_POOL_ELEMENTS
;

1480 
poÞ
->
max_ÿched_·ges
 = 1 << (
SGV_POOL_ELEMENTS
 - 1);

1482 
poÞ
->
max_ÿches
 = 1;

1483 
poÞ
->
max_ÿched_·ges
 = 
sšgË_®loc_·ges
;

1485 
poÞ
->
®loc_âs
.
®loc_·ges_â
 = 
sgv_®loc_sys_·ges
;

1486 
poÞ
->
®loc_âs
.
ä“_·ges_â
 = 
sgv_ä“_sys_sg_’Œ›s
;

1488 
	`TRACE_MEM
("name %s, sizeof(*obj)=%zd, clustering_type=%d, "

1490 
Çme
, (
sgv_poÞ_obj
), 
þu¡”šg_ty³
,

1491 
sšgË_®loc_·ges
, 
poÞ
->
max_ÿches
,…oÞ->
max_ÿched_·ges
);

1493 
	`¡¾ýy
(
poÞ
->
Çme
,‚ame, (pool->name)-1);

1495 
poÞ
->
owÃr_mm
 = 
cu¼’t
->
mm
;

1497 
i
 = 0; i < 
poÞ
->
max_ÿches
; i++) {

1498 
	`sgv_poÞ_š™_ÿche
(
poÞ
, 
i
);

1499 ià(
poÞ
->
ÿches
[
i
] =ð
NULL
) {

1500 
	`PRINT_ERROR
("Allocation of sgv_pool "

1501 "ÿch%s(%dèçžed", 
Çme
, 
i
);

1502 
out_ä“
;

1506 
	`©omic_£t
(&
poÞ
->
sgv_poÞ_»f
, 1);

1507 
	`¥š_lock_š™
(&
poÞ
->
sgv_poÞ_lock
);

1508 
	`INIT_LIST_HEAD
(&
poÞ
->
sÜ‹d_»cyþšg_li¡
);

1509 
i
 = 0; i < 
poÞ
->
max_ÿches
; i++)

1510 
	`INIT_LIST_HEAD
(&
poÞ
->
»cyþšg_li¡s
[
i
]);

1512 #ià(
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 20))

1513 
	`INIT_DELAYED_WORK
(&
poÞ
->
sgv_purge_wÜk
, 
sgv_purge_wÜk_â
);

1515 
	`INIT_WORK
(&
poÞ
->
sgv_purge_wÜk
, 
sgv_purge_wÜk_â
,…ool);

1518 
	`¥š_lock_bh
(&
sgv_poÞs_lock
);

1519 
	`li¡_add_ž
(&
poÞ
->
sgv_poÞs_li¡_’Œy
, &
sgv_poÞs_li¡
);

1520 
	`¥š_uÆock_bh
(&
sgv_poÞs_lock
);

1522 #iâdeà
CONFIG_SCST_PROC


1523 
»s
 = 
	`sc¡_sgv_sysfs_ü—‹
(
poÞ
);

1524 ià(
»s
 != 0)

1525 
out_d–
;

1528 
»s
 = 0;

1530 
out
:

1531 
	`TRACE_EXIT_RES
(
»s
);

1532  
»s
;

1534 #iâdeà
CONFIG_SCST_PROC


1535 
out_d–
:

1536 
	`¥š_lock_bh
(&
sgv_poÞs_lock
);

1537 
	`li¡_d–
(&
poÞ
->
sgv_poÞs_li¡_’Œy
);

1538 
	`¥š_uÆock_bh
(&
sgv_poÞs_lock
);

1541 
out_ä“
:

1542 
i
 = 0; i < 
poÞ
->
max_ÿches
; i++) {

1543 ià(
poÞ
->
ÿches
[
i
]) {

1544 
	`kmem_ÿche_de¡roy
(
poÞ
->
ÿches
[
i
]);

1545 
poÞ
->
ÿches
[
i
] = 
NULL
;

1549 
out
;

1550 
	}
}

1552 
	$sgv_ev®u©e_loÿl_max_·ges
()

1554 
¥aû4sgv_‰bl
 = 
PAGE_SIZE
 - (
sgv_poÞ_obj
);

1556 
sgv_max_loÿl_·ges
 = 
¥aû4sgv_‰bl
 /

1557 ((
Œªs_tbl_’t
è+ (
sÿ‰”li¡
));

1559 
sgv_max_Œªs_·ges
 = 
¥aû4sgv_‰bl
 / (
Œªs_tbl_’t
);

1561 
	`TRACE_MEM
("sgv_max_local_pages %d, sgv_max_trans_pages %d",

1562 
sgv_max_loÿl_·ges
, 
sgv_max_Œªs_·ges
);

1564 
	}
}

1571 
	$sgv_poÞ_æush
(
sgv_poÞ
 *
poÞ
)

1573 
i
;

1575 
	`TRACE_ENTRY
();

1577 
i
 = 0; i < 
poÞ
->
max_ÿches
; i++) {

1578 
sgv_poÞ_obj
 *
obj
;

1580 
	`¥š_lock_bh
(&
poÞ
->
sgv_poÞ_lock
);

1582 !
	`li¡_em±y
(&
poÞ
->
»cyþšg_li¡s
[
i
])) {

1583 
obj
 = 
	`li¡_fœ¡_’Œy
(&
poÞ
->
»cyþšg_li¡s
[
i
],

1584 
sgv_poÞ_obj
, 
»cyþšg_li¡_’Œy
);

1586 
	`__sgv_purge_äom_ÿche
(
obj
);

1588 
	`¥š_uÆock_bh
(&
poÞ
->
sgv_poÞ_lock
);

1590 
	`EXTRACHECKS_BUG_ON
(
obj
->
owÃr_poÞ
 !ð
poÞ
);

1591 
	`sgv_dtÜ_ªd_ä“
(
obj
);

1593 
	`¥š_lock_bh
(&
poÞ
->
sgv_poÞ_lock
);

1595 
	`¥š_uÆock_bh
(&
poÞ
->
sgv_poÞ_lock
);

1598 
	`TRACE_EXIT
();

1600 
	}
}

1601 
EXPORT_SYMBOL_GPL
(
sgv_poÞ_æush
);

1603 
	$sgv_poÞ_de¡roy
(
sgv_poÞ
 *
poÞ
)

1605 
i
;

1607 
	`TRACE_ENTRY
();

1609 
	`sgv_poÞ_æush
(
poÞ
);

1611 
	`mu‹x_lock
(&
sgv_poÞs_mu‹x
);

1612 
	`¥š_lock_bh
(&
sgv_poÞs_lock
);

1613 
	`li¡_d–
(&
poÞ
->
sgv_poÞs_li¡_’Œy
);

1614 
	`¥š_uÆock_bh
(&
sgv_poÞs_lock
);

1615 
	`mu‹x_uÆock
(&
sgv_poÞs_mu‹x
);

1617 #iâdeà
CONFIG_SCST_PROC


1618 
	`sc¡_sgv_sysfs_d–
(
poÞ
);

1621 
	`ÿnûl_d–ayed_wÜk_sync
(&
poÞ
->
sgv_purge_wÜk
);

1623 
i
 = 0; i < 
poÞ
->
max_ÿches
; i++) {

1624 ià(
poÞ
->
ÿches
[
i
])

1625 
	`kmem_ÿche_de¡roy
(
poÞ
->
ÿches
[
i
]);

1626 
poÞ
->
ÿches
[
i
] = 
NULL
;

1629 
	`kmem_ÿche_ä“
(
sgv_poÞ_ÿch•
, 
poÞ
);

1631 
	`TRACE_EXIT
();

1633 
	}
}

1645 
sgv_poÞ_£t_®loÿtÜ
(
sgv_poÞ
 *
poÞ
,

1646 
·ge
 *(*
®loc_·ges_â
)(
sÿ‰”li¡
 *, 
gå_t
, *),

1647 (*
ä“_·ges_â
)(
sÿ‰”li¡
 *, , *))

1649 
poÞ
->
®loc_âs
.
®loc_·ges_â
 =‡lloc_pages_fn;

1650 
poÞ
->
®loc_âs
.
ä“_·ges_â
 = free_pages_fn;

1652 
	}
}

1653 
EXPORT_SYMBOL_GPL
(
sgv_poÞ_£t_®loÿtÜ
);

1679 
sgv_poÞ
 *
	$sgv_poÞ_ü—‹
(cÚ¡ *
Çme
,

1680 
sgv_þu¡”šg_ty³s
 
þu¡”šg_ty³
,

1681 
sšgË_®loc_·ges
, 
boÞ
 
sh¬ed
, 
purge_š‹rv®
)

1683 
sgv_poÞ
 *
poÞ
;

1684 
rc
;

1686 
	`TRACE_ENTRY
();

1688 
	`mu‹x_lock
(&
sgv_poÞs_mu‹x
);

1690 
	`li¡_fÜ_—ch_’Œy
(
poÞ
, &
sgv_poÞs_li¡
, 
sgv_poÞs_li¡_’Œy
) {

1691 ià(
	`¡rcmp
(
poÞ
->
Çme
,‚ame) == 0) {

1692 ià(
sh¬ed
) {

1693 ià(
poÞ
->
owÃr_mm
 !ð
cu¼’t
->
mm
) {

1694 
	`PRINT_ERROR
("Attempt of‡ shared use "

1696 "difã»Á MM", 
Çme
);

1697 
out_uÆock
;

1699 
	`sgv_poÞ_g‘
(
poÞ
);

1700 
out_uÆock
;

1702 
	`PRINT_ERROR
("SGV…oÞ % ®»adyƒxi¡s", 
Çme
);

1703 
poÞ
 = 
NULL
;

1704 
out_uÆock
;

1709 
poÞ
 = 
	`kmem_ÿche_z®loc
(
sgv_poÞ_ÿch•
, 
GFP_KERNEL
);

1710 ià(
poÞ
 =ð
NULL
) {

1711 
	`PRINT_ERROR
("Allocation of sgv_pool failed (size %zd)",

1712 (*
poÞ
));

1713 
out_uÆock
;

1716 
rc
 = 
	`sgv_poÞ_š™
(
poÞ
, 
Çme
, 
þu¡”šg_ty³
, 
sšgË_®loc_·ges
,

1717 
purge_š‹rv®
);

1718 ià(
rc
 != 0)

1719 
out_ä“
;

1721 
out_uÆock
:

1722 
	`mu‹x_uÆock
(&
sgv_poÞs_mu‹x
);

1724 
	`TRACE_EXIT_RES
(
poÞ
 !ð
NULL
);

1725  
poÞ
;

1727 
out_ä“
:

1728 
	`kmem_ÿche_ä“
(
sgv_poÞ_ÿch•
, 
poÞ
);

1729 
poÞ
 = 
NULL
;

1730 
out_uÆock
;

1731 
	}
}

1732 
EXPORT_SYMBOL_GPL
(
sgv_poÞ_ü—‹
);

1739 
	$sgv_poÞ_g‘
(
sgv_poÞ
 *
poÞ
)

1741 
	`©omic_šc
(&
poÞ
->
sgv_poÞ_»f
);

1742 
	`TRACE_MEM
("Incrementing sgv…ool %p„ef (new value %d)",

1743 
poÞ
, 
	`©omic_»ad
(&poÞ->
sgv_poÞ_»f
));

1745 
	}
}

1746 
EXPORT_SYMBOL_GPL
(
sgv_poÞ_g‘
);

1754 
	$sgv_poÞ_put
(
sgv_poÞ
 *
poÞ
)

1756 
	`TRACE_MEM
("Decrementing sgv…ool %p„ef (new value %d)",

1757 
poÞ
, 
	`©omic_»ad
(&poÞ->
sgv_poÞ_»f
)-1);

1758 ià(
	`©omic_dec_ªd_‹¡
(&
poÞ
->
sgv_poÞ_»f
))

1759 
	`sgv_poÞ_de¡roy
(
poÞ
);

1761 
	}
}

1762 
EXPORT_SYMBOL_GPL
(
sgv_poÞ_put
);

1772 
	$sgv_poÞ_d–
(
sgv_poÞ
 *
poÞ
)

1774 
	`TRACE_ENTRY
();

1776 
	`sgv_poÞ_put
(
poÞ
);

1778 
	`TRACE_EXIT
();

1780 
	}
}

1781 
EXPORT_SYMBOL_GPL
(
sgv_poÞ_d–
);

1784 
	$sc¡_sgv_poÞs_š™
(
mem_hwm¬k
, 
mem_lwm¬k
)

1786 
»s
 = 0;

1788 
	`TRACE_ENTRY
();

1790 
sgv_poÞ_ÿch•
 = 
	`KMEM_CACHE
(
sgv_poÞ
, 
SCST_SLAB_FLAGS
|
SLAB_HWCACHE_ALIGN
);

1791 ià(
sgv_poÞ_ÿch•
 =ð
NULL
)

1792 
out_”r
;

1794 
sgv_hi_wmk
 = 
mem_hwm¬k
;

1795 
sgv_lo_wmk
 = 
mem_lwm¬k
;

1797 
	`sgv_ev®u©e_loÿl_max_·ges
();

1799 
sgv_nÜm_poÞ
 = 
	`sgv_poÞ_ü—‹
("sgv", 
sgv_no_þu¡”šg
, 0, 
çl£
, 0);

1800 ià(
sgv_nÜm_poÞ
 =ð
NULL
)

1801 
out_ä“_poÞ
;

1803 
sgv_nÜm_þu¡_poÞ
 = 
	`sgv_poÞ_ü—‹
("sgv-clust",

1804 
sgv_fuÎ_þu¡”šg
, 0, 
çl£
, 0);

1805 ià(
sgv_nÜm_þu¡_poÞ
 =ð
NULL
)

1806 
out_ä“_nÜm
;

1808 
sgv_dma_poÞ
 = 
	`sgv_poÞ_ü—‹
("sgv-dma", 
sgv_no_þu¡”šg
, 0,

1809 
çl£
, 0);

1810 ià(
sgv_dma_poÞ
 =ð
NULL
)

1811 
out_ä“_þu¡
;

1813 #ià(
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 23))

1814 
sgv_shršk”
 = 
	`£t_shršk”
(
DEFAULT_SEEKS
, 
sgv_shršk
);

1816 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(3, 12, 0)

1817 
sgv_shršk”
.
couÁ_objeùs
 = 
sgv_ÿn_be_shrunk
;

1818 
sgv_shršk”
.
sÿn_objeùs
 = 
sgv_sÿn_shršk
;

1820 
sgv_shršk”
.
shršk
 = 
sgv_shršk
;

1822 
sgv_shršk”
.
£eks
 = 
DEFAULT_SEEKS
;

1823 
	`»gi¡”_shršk”
(&
sgv_shršk”
);

1826 
out
:

1827 
	`TRACE_EXIT_RES
(
»s
);

1828  
»s
;

1830 
out_ä“_þu¡
:

1831 
	`sgv_poÞ_de¡roy
(
sgv_nÜm_þu¡_poÞ
);

1833 
out_ä“_nÜm
:

1834 
	`sgv_poÞ_de¡roy
(
sgv_nÜm_poÞ
);

1836 
out_ä“_poÞ
:

1837 
	`kmem_ÿche_de¡roy
(
sgv_poÞ_ÿch•
);

1839 
out_”r
:

1840 
»s
 = -
ENOMEM
;

1841 
out
;

1842 
	}
}

1844 
	$sc¡_sgv_poÞs_deš™
()

1846 
	`TRACE_ENTRY
();

1848 #ià(
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 23))

1849 
	`»move_shršk”
(
sgv_shršk”
);

1851 
	`uÄegi¡”_shršk”
(&
sgv_shršk”
);

1854 
	`sgv_poÞ_de¡roy
(
sgv_dma_poÞ
);

1855 
	`sgv_poÞ_de¡roy
(
sgv_nÜm_poÞ
);

1856 
	`sgv_poÞ_de¡roy
(
sgv_nÜm_þu¡_poÞ
);

1858 
	`kmem_ÿche_de¡roy
(
sgv_poÞ_ÿch•
);

1860 
	`TRACE_EXIT
();

1862 
	}
}

1864 #ifdeà
CONFIG_SCST_PROC


1866 
	$sgv_do_´oc_»ad
(
£q_fže
 *
£q
, cÚ¡ 
sgv_poÞ
 *
poÞ
)

1868 
i
, 
tÙ®
 = 0, 
h™
 = 0, 
m”ged
 = 0, 
®loÿ‹d
 = 0;

1869 
ß
, 
om
;

1871 
i
 = 0; i < 
poÞ
->
max_ÿches
; i++) {

1872 
t
;

1874 
h™
 +ð
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
h™_®loc
);

1875 
tÙ®
 +ð
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
tÙ®_®loc
);

1877 
t
 = 
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
tÙ®_®loc
) -

1878 
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
h™_®loc
);

1879 ià(
poÞ
->
sšgË_®loc_·ges
 == 0)

1880 
®loÿ‹d
 +ð
t
 * (1 << 
i
);

1882 
®loÿ‹d
 +ð
t
 * 
poÞ
->
sšgË_®loc_·ges
;

1883 
m”ged
 +ð
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].merged);

1886 
	`£q_´štf
(
£q
, "\n%-30 %-11d %-11d %-11d %d/%d/%d\n", 
poÞ
->
Çme
,

1887 
h™
, 
tÙ®
, (
®loÿ‹d
 !ð0è? 
m”ged
*100/allocated : 0,

1888 
poÞ
->
ÿched_·ges
,…oÞ->
šaùive_ÿched_·ges
,

1889 
poÞ
->
ÿched_’Œ›s
);

1891 
i
 = 0; i < 
poÞ
->
max_ÿches
; i++) {

1892 
t
 = 
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
tÙ®_®loc
) -

1893 
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
h™_®loc
);

1894 ià(
poÞ
->
sšgË_®loc_·ges
 == 0)

1895 
®loÿ‹d
 = 
t
 * (1 << 
i
);

1897 
®loÿ‹d
 = 
t
 * 
poÞ
->
sšgË_®loc_·ges
;

1898 
m”ged
 = 
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].merged);

1900 
	`£q_´štf
(
£q
, " %-28s %-11d %-11d %d\n",

1901 
poÞ
->
ÿche_Çmes
[
i
],

1902 
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
h™_®loc
),

1903 
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
tÙ®_®loc
),

1904 (
®loÿ‹d
 !ð0è? 
m”ged
*100/allocated : 0);

1907 
®loÿ‹d
 = 
	`©omic_»ad
(&
poÞ
->
big_·ges
);

1908 
m”ged
 = 
	`©omic_»ad
(&
poÞ
->
big_m”ged
);

1909 
ß
 = 
	`©omic_»ad
(&
poÞ
->
Ùh”_·ges
);

1910 
om
 = 
	`©omic_»ad
(&
poÞ
->
Ùh”_m”ged
);

1912 
	`£q_´štf
(
£q
, " %-40s %d/%-9d %d/%d\n", "big/other",

1913 
	`©omic_»ad
(&
poÞ
->
big_®loc
),‡tomic_»ad(&poÞ->
Ùh”_®loc
),

1914 (
®loÿ‹d
 !ð0è? 
m”ged
*100/allocated : 0,

1915 (
ß
 !ð0è? 
om
/oa : 0);

1918 
	}
}

1920 
	$sgv_´ocšfo_show
(
£q_fže
 *
£q
, *
v
)

1922 
sgv_poÞ
 *
poÞ
;

1923 
šaùive_·ges
 = 0;

1925 
	`TRACE_ENTRY
();

1927 
	`¥š_lock_bh
(&
sgv_poÞs_lock
);

1928 
	`li¡_fÜ_—ch_’Œy
(
poÞ
, &
sgv_aùive_poÞs_li¡
,

1929 
sgv_aùive_poÞs_li¡_’Œy
) {

1930 
šaùive_·ges
 +ð
poÞ
->
šaùive_ÿched_·ges
;

1932 
	`¥š_uÆock_bh
(&
sgv_poÞs_lock
);

1934 
	`£q_´štf
(
£q
, "%-42s %d/%d\n%-42s %d/%d\n%-42s %d/%d\n\n",

1935 "IÇùive/aùiv·ges", 
šaùive_·ges
,

1936 
	`©omic_»ad
(&
sgv_·ges_tÙ®
è- 
šaùive_·ges
,

1937 "Hi/lØw©”m¬k [·ges]", 
sgv_hi_wmk
, 
sgv_lo_wmk
,

1939 
	`©omic_»ad
(&
sgv_»Ëa£s_Ú_hiwmk
),

1940 
	`©omic_»ad
(&
sgv_»Ëa£s_Ú_hiwmk_çžed
));

1942 
	`£q_´štf
(
£q
, "%-30s %-11s %-11s %-11s %-11s", "Name", "Hit", "Total",

1945 
	`mu‹x_lock
(&
sgv_poÞs_mu‹x
);

1946 
	`li¡_fÜ_—ch_’Œy
(
poÞ
, &
sgv_poÞs_li¡
, 
sgv_poÞs_li¡_’Œy
) {

1947 
	`sgv_do_´oc_»ad
(
£q
, 
poÞ
);

1949 
	`mu‹x_uÆock
(&
sgv_poÞs_mu‹x
);

1951 
	`£q_´štf
(
£q
, "\n%-42s %-11d\n", "other",

1952 
	`©omic_»ad
(&
sgv_Ùh”_tÙ®_®loc
));

1954 
	`TRACE_EXIT
();

1956 
	}
}

1960 
ssize_t
 
	$sgv_sysfs_¡©_show
(
kobjeù
 *
kobj
,

1961 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

1963 
sgv_poÞ
 *
poÞ
;

1964 
i
, 
tÙ®
 = 0, 
h™
 = 0, 
m”ged
 = 0, 
®loÿ‹d
 = 0;

1965 
ß
, 
om
, 
»s
;

1967 
poÞ
 = 
	`cÚš”_of
(
kobj
, 
sgv_poÞ
, 
sgv_kobj
);

1969 
i
 = 0; i < 
SGV_POOL_ELEMENTS
; i++) {

1970 
t
;

1972 
h™
 +ð
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
h™_®loc
);

1973 
tÙ®
 +ð
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
tÙ®_®loc
);

1975 
t
 = 
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
tÙ®_®loc
) -

1976 
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
h™_®loc
);

1977 
®loÿ‹d
 +ð
t
 * (1 << 
i
);

1978 
m”ged
 +ð
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].merged);

1981 
»s
 = 
	`¥rštf
(
buf
, "%-30s %-11s %-11s %-11s %-11s", "Name", "Hit", "Total",

1984 
»s
 +ð
	`¥rštf
(&
buf
[res], "\n%-30s %-11d %-11d %-11d %d/%d/%d\n",

1985 
poÞ
->
Çme
, 
h™
, 
tÙ®
,

1986 (
®loÿ‹d
 !ð0è? 
m”ged
*100/allocated : 0,

1987 
poÞ
->
ÿched_·ges
,…oÞ->
šaùive_ÿched_·ges
,

1988 
poÞ
->
ÿched_’Œ›s
);

1990 
i
 = 0; i < 
SGV_POOL_ELEMENTS
; i++) {

1991 
t
 = 
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
tÙ®_®loc
) -

1992 
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
h™_®loc
);

1993 
®loÿ‹d
 = 
t
 * (1 << 
i
);

1994 
m”ged
 = 
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].merged);

1996 
»s
 +ð
	`¥rštf
(&
buf
[res], " %-28s %-11d %-11d %d\n",

1997 
poÞ
->
ÿche_Çmes
[
i
],

1998 
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
h™_®loc
),

1999 
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
tÙ®_®loc
),

2000 (
®loÿ‹d
 !ð0è? 
m”ged
*100/allocated : 0);

2003 
®loÿ‹d
 = 
	`©omic_»ad
(&
poÞ
->
big_·ges
);

2004 
m”ged
 = 
	`©omic_»ad
(&
poÞ
->
big_m”ged
);

2005 
ß
 = 
	`©omic_»ad
(&
poÞ
->
Ùh”_·ges
);

2006 
om
 = 
	`©omic_»ad
(&
poÞ
->
Ùh”_m”ged
);

2008 
»s
 +ð
	`¥rštf
(&
buf
[res], " %-40s %d/%-9d %d/%d\n", "big/other",

2009 
	`©omic_»ad
(&
poÞ
->
big_®loc
),‡tomic_»ad(&poÞ->
Ùh”_®loc
),

2010 (
®loÿ‹d
 !ð0è? 
m”ged
*100/allocated : 0,

2011 (
ß
 !ð0è? 
om
/oa : 0);

2013  
»s
;

2014 
	}
}

2016 
ssize_t
 
	$sgv_sysfs_¡©_»£t
(
kobjeù
 *
kobj
,

2017 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

2019 
sgv_poÞ
 *
poÞ
;

2020 
i
;

2022 
	`TRACE_ENTRY
();

2024 
poÞ
 = 
	`cÚš”_of
(
kobj
, 
sgv_poÞ
, 
sgv_kobj
);

2026 
i
 = 0; i < 
SGV_POOL_ELEMENTS
; i++) {

2027 
	`©omic_£t
(&
poÞ
->
ÿche_acc
[
i
].
h™_®loc
, 0);

2028 
	`©omic_£t
(&
poÞ
->
ÿche_acc
[
i
].
tÙ®_®loc
, 0);

2029 
	`©omic_£t
(&
poÞ
->
ÿche_acc
[
i
].
m”ged
, 0);

2032 
	`©omic_£t
(&
poÞ
->
big_·ges
, 0);

2033 
	`©omic_£t
(&
poÞ
->
big_m”ged
, 0);

2034 
	`©omic_£t
(&
poÞ
->
big_®loc
, 0);

2035 
	`©omic_£t
(&
poÞ
->
Ùh”_·ges
, 0);

2036 
	`©omic_£t
(&
poÞ
->
Ùh”_m”ged
, 0);

2037 
	`©omic_£t
(&
poÞ
->
Ùh”_®loc
, 0);

2039 
	`PRINT_INFO
("Sti¡ic fÜ SGV…oÞ % »£t", 
poÞ
->
Çme
);

2041 
	`TRACE_EXIT_RES
(
couÁ
);

2042  
couÁ
;

2043 
	}
}

2045 
ssize_t
 
	$sgv_sysfs_glob®_¡©_show
(
kobjeù
 *
kobj
,

2046 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

2048 
sgv_poÞ
 *
poÞ
;

2049 
šaùive_·ges
 = 0, 
»s
;

2051 
	`TRACE_ENTRY
();

2053 
	`¥š_lock_bh
(&
sgv_poÞs_lock
);

2054 
	`li¡_fÜ_—ch_’Œy
(
poÞ
, &
sgv_aùive_poÞs_li¡
,

2055 
sgv_aùive_poÞs_li¡_’Œy
) {

2056 
šaùive_·ges
 +ð
poÞ
->
šaùive_ÿched_·ges
;

2058 
	`¥š_uÆock_bh
(&
sgv_poÞs_lock
);

2060 
»s
 = 
	`¥rštf
(
buf
, "%-42s %d/%d\n%-42s %d/%d\n%-42s %d/%d\n"

2062 "IÇùive/aùiv·ges", 
šaùive_·ges
,

2063 
	`©omic_»ad
(&
sgv_·ges_tÙ®
è- 
šaùive_·ges
,

2064 "Hi/lØw©”m¬k [·ges]", 
sgv_hi_wmk
, 
sgv_lo_wmk
,

2066 
	`©omic_»ad
(&
sgv_»Ëa£s_Ú_hiwmk
),

2067 
	`©omic_»ad
(&
sgv_»Ëa£s_Ú_hiwmk_çžed
),

2068 "Oth”‡Îocs", 
	`©omic_»ad
(&
sgv_Ùh”_tÙ®_®loc
));

2070 
	`TRACE_EXIT
();

2071  
»s
;

2072 
	}
}

2074 
ssize_t
 
	$sgv_sysfs_glob®_¡©_»£t
(
kobjeù
 *
kobj
,

2075 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

2077 
	`TRACE_ENTRY
();

2079 
	`©omic_£t
(&
sgv_»Ëa£s_Ú_hiwmk
, 0);

2080 
	`©omic_£t
(&
sgv_»Ëa£s_Ú_hiwmk_çžed
, 0);

2081 
	`©omic_£t
(&
sgv_Ùh”_tÙ®_®loc
, 0);

2083 
	`PRINT_INFO
("%s", "Global SGV…ool statistics„eset");

2085 
	`TRACE_EXIT_RES
(
couÁ
);

2086  
couÁ
;

2087 
	}
}

2089 
kobj_©Œibu‹
 
	gsgv_¡©_©Œ
 =

2090 
__ATTR
(
¡©s
, 
S_IRUGO
 | 
S_IWUSR
, 
sgv_sysfs_¡©_show
,

2091 
sgv_sysfs_¡©_»£t
);

2093 
©Œibu‹
 *
	gsgv_©Œs
[] = {

2094 &
sgv_¡©_©Œ
.
©Œ
,

2095 
NULL
,

2098 
	$sgv_kobj_»Ëa£
(
kobjeù
 *
kobj
)

2100 
sgv_poÞ
 *
poÞ
;

2102 
	`TRACE_ENTRY
();

2104 
poÞ
 = 
	`cÚš”_of
(
kobj
, 
sgv_poÞ
, 
sgv_kobj
);

2105 ià(
poÞ
->
sgv_kobj_»Ëa£_cm¶
 !ð
NULL
)

2106 
	`com¶‘e_®l
(
poÞ
->
sgv_kobj_»Ëa£_cm¶
);

2108 
	`TRACE_EXIT
();

2110 
	}
}

2112 
kobj_ty³
 
	gsgv_poÞ_kty³
 = {

2113 .
sysfs_Ýs
 = &
sc¡_sysfs_Ýs
,

2114 .
	g»Ëa£
 = 
sgv_kobj_»Ëa£
,

2115 .
	gdeçuÉ_©Œs
 = 
sgv_©Œs
,

2118 
	$sc¡_sgv_sysfs_ü—‹
(
sgv_poÞ
 *
poÞ
)

2120 
»s
;

2122 
	`TRACE_ENTRY
();

2124 
»s
 = 
	`kobjeù_š™_ªd_add
(&
poÞ
->
sgv_kobj
, &
sgv_poÞ_kty³
,

2125 
sc¡_sgv_kobj
, 
poÞ
->
Çme
);

2126 ià(
»s
 != 0) {

2127 
	`PRINT_ERROR
("Cª'ˆadd sgv…oÞ % tØsysfs", 
poÞ
->
Çme
);

2128 
out
;

2131 
out
:

2132 
	`TRACE_EXIT_RES
(
»s
);

2133  
»s
;

2134 
	}
}

2136 
	$sc¡_sgv_sysfs_d–
(
sgv_poÞ
 *
poÞ
)

2138 
	`DECLARE_COMPLETION_ONSTACK
(
c
);

2140 
	`TRACE_ENTRY
();

2142 
poÞ
->
sgv_kobj_»Ëa£_cm¶
 = &
c
;

2144 
	`kobjeù_d–
(&
poÞ
->
sgv_kobj
);

2146 
	`SCST_KOBJECT_PUT_AND_WAIT
(&
poÞ
->
sgv_kobj
, "SGV…oÞ", &
c
,

2147 &
sc¡_poÞ_d•_m­
);

2149 
	`TRACE_EXIT
();

2150 
	}
}

2152 
kobj_©Œibu‹
 
	gsgv_glob®_¡©_©Œ
 =

2153 
__ATTR
(
glob®_¡©s
, 
S_IRUGO
 | 
S_IWUSR
, 
sgv_sysfs_glob®_¡©_show
,

2154 
sgv_sysfs_glob®_¡©_»£t
);

2156 
©Œibu‹
 *
	gsgv_deçuÉ_©Œs
[] = {

2157 &
sgv_glob®_¡©_©Œ
.
©Œ
,

2158 
NULL
,

2161 
	$sc¡_sysfs_»Ëa£
(
kobjeù
 *
kobj
)

2163 
	`kä“
(
kobj
);

2164 
	}
}

2166 
kobj_ty³
 
	gsgv_kty³
 = {

2167 .
sysfs_Ýs
 = &
sc¡_sysfs_Ýs
,

2168 .
	g»Ëa£
 = 
sc¡_sysfs_»Ëa£
,

2169 .
	gdeçuÉ_©Œs
 = 
sgv_deçuÉ_©Œs
,

2175 
	$sc¡_add_sgv_kobj
(
kobjeù
 *
·»Á
, cÚ¡ *
Çme
)

2177 
»s
;

2179 
	`WARN_ON
(
sc¡_sgv_kobj
);

2180 
»s
 = -
ENOMEM
;

2181 
sc¡_sgv_kobj
 = 
	`kz®loc
((*sc¡_sgv_kobj), 
GFP_KERNEL
);

2182 ià(!
sc¡_sgv_kobj
)

2183 
out
;

2184 
»s
 = 
	`kobjeù_š™_ªd_add
(
sc¡_sgv_kobj
, &
sgv_kty³
, 
·»Á
, 
Çme
);

2185 ià(
»s
 != 0)

2186 
out_ä“
;

2187 
out
:

2188  
»s
;

2189 
out_ä“
:

2190 
	`kobjeù_put
(
sc¡_sgv_kobj
);

2191 
sc¡_sgv_kobj
 = 
NULL
;

2192 
out
;

2193 
	}
}

2198 
	$sc¡_d–_put_sgv_kobj
()

2200 
	`WARN_ON
(!
sc¡_sgv_kobj
);

2201 
	`kobjeù_d–
(
sc¡_sgv_kobj
);

2202 
	`kobjeù_put
(
sc¡_sgv_kobj
);

2203 
sc¡_sgv_kobj
 = 
NULL
;

2204 
	}
}

	@scst/src/scst_mem.h

18 
	~<lšux/sÿ‰”li¡.h
>

19 
	~<lšux/wÜkqueue.h
>

21 
	#SGV_POOL_ELEMENTS
 11

	)

28 
	sŒªs_tbl_’t
 {

29 
	msg_num
;

30 
	mpg_couÁ
;

36 
	ssgv_poÞ_obj
 {

37 
	mÿche_num
;

38 
	m·ges
;

41 
	mtime_¡amp
;

43 
li¡_h—d
 
	m»cyþšg_li¡_’Œy
;

44 
li¡_h—d
 
	msÜ‹d_»cyþšg_li¡_’Œy
;

46 
sgv_poÞ
 *
	mowÃr_poÞ
;

47 
	mÜig_sg
;

48 
	mÜig_Ëngth
;

49 
	msg_couÁ
;

50 *
	m®loÿtÜ_´iv
;

51 
Œªs_tbl_’t
 *
	mŒªs_tbl
;

52 
sÿ‰”li¡
 *
	msg_’Œ›s
;

53 
sÿ‰”li¡
 
	msg_’Œ›s_d©a
[0];

59 
	ssgv_poÞ_ÿche_acc
 {

60 
©omic_t
 
	mtÙ®_®loc
, 
	mh™_®loc
;

61 
©omic_t
 
	mm”ged
;

67 
	ssgv_poÞ_®loc_âs
 {

68 
	m·ge
 *(*
	m®loc_·ges_â
)(
sÿ‰”li¡
 *
	msg
, 
gå_t
 
	mgå_mask
,

69 *
	m´iv
);

70 (*
	mä“_·ges_â
)(
sÿ‰”li¡
 *
	msg
, 
	msg_couÁ
,

71 *
	m´iv
);

73 #ifdeà
CONSTIFY_PLUGIN


75 
__©Œibu‹__
((
no_cÚ¡
))

82 
	ssgv_poÞ
 {

83 
sgv_þu¡”šg_ty³s
 
	mþu¡”šg_ty³
;

84 
	msšgË_®loc_·ges
;

85 
	mmax_ÿched_·ges
;

87 
sgv_poÞ_®loc_âs
 
	m®loc_âs
;

90 
kmem_ÿche
 *
	mÿches
[
SGV_POOL_ELEMENTS
];

92 
¥šlock_t
 
	msgv_poÞ_lock
;

94 
	mpurge_š‹rv®
;

97 
	mpurge_wÜk_scheduËd
:1;

100 
li¡_h—d
 
	msÜ‹d_»cyþšg_li¡
;

102 
	mšaùive_ÿched_·ges
;

105 
li¡_h—d
 
	m»cyþšg_li¡s
[
SGV_POOL_ELEMENTS
];

107 
	mÿched_·ges
, 
	mÿched_’Œ›s
;

109 
sgv_poÞ_ÿche_acc
 
	mÿche_acc
[
SGV_POOL_ELEMENTS
];

111 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 20))

112 
d–ayed_wÜk
 
	msgv_purge_wÜk
;

114 
wÜk_¡ruù
 
	msgv_purge_wÜk
;

117 
li¡_h—d
 
	msgv_aùive_poÞs_li¡_’Œy
;

119 
©omic_t
 
	mbig_®loc
, 
	mbig_·ges
, 
	mbig_m”ged
;

120 
©omic_t
 
	mÙh”_®loc
, 
	mÙh”_·ges
, 
	mÙh”_m”ged
;

122 
©omic_t
 
	msgv_poÞ_»f
;

124 
	mmax_ÿches
;

127 
	mÿche_Çmes
[
SGV_POOL_ELEMENTS
][
SCST_MAX_NAME
 + 10];

128 
	mÇme
[
SCST_MAX_NAME
 + 10];

130 
mm_¡ruù
 *
	mowÃr_mm
;

132 
li¡_h—d
 
	msgv_poÞs_li¡_’Œy
;

134 
kobjeù
 
	msgv_kobj
;

137 
com¶‘iÚ
 *
	msgv_kobj_»Ëa£_cm¶
;

140 
šlše
 
sÿ‰”li¡
 *
	$sgv_poÞ_sg
(
sgv_poÞ_obj
 *
obj
)

142  
obj
->
sg_’Œ›s
;

143 
	}
}

145 
sc¡_sgv_poÞs_š™
(
mem_hwm¬k
, 
mem_lwm¬k
);

146 
sc¡_sgv_poÞs_deš™
();

148 #ifdeà
CONFIG_SCST_PROC


149 
sgv_´ocšfo_show
(
£q_fže
 *
£q
, *
v
);

152 
sc¡_sgv_poÞ_u£_nÜm
(
sc¡_tgt_dev
 *
tgt_dev
);

153 
sc¡_sgv_poÞ_u£_nÜm_þu¡
(
sc¡_tgt_dev
 *
tgt_dev
);

154 
sc¡_sgv_poÞ_u£_dma
(
sc¡_tgt_dev
 *
tgt_dev
);

	@scst/src/scst_module.c

21 
	~<lšux/moduË.h
>

22 
	~<lšux/š™.h
>

24 
	~<sc¡.h
>

26 
__š™
 
	$š™_this_sc¡_driv”
()

28 
»s
;

30 
	`TRACE_ENTRY
();

32 
»s
 = 
	`sc¡_»gi¡”_rg‘_‹m¶©e
(&
driv”_rg‘_‹m¶©e
);

33 
	`TRACE_DBG
("sc¡_»gi¡”_rg‘_‹m¶©e(è»tuºed %d", 
»s
);

34 ià(
»s
 < 0)

35 
out
;

37 #ifdeà
SCST_REGISTER_INITIATOR_DRIVER


38 
driv”_‹m¶©e
.
moduË
 = 
THIS_MODULE
;

39 
	`scsi_»gi¡”_moduË
(
MODULE_SCSI_HA
, &
driv”_‹m¶©e
);

40 
	`TRACE_DBG
("driver_template.present=%d",

41 
driv”_‹m¶©e
.
´e£Á
);

42 ià(
driv”_‹m¶©e
.
´e£Á
 == 0) {

43 
»s
 = -
ENODEV
;

44 
MOD_DEC_USE_COUNT
;

45 
out
;

49 
out
:

50 
	`TRACE_EXIT_RES
(
»s
);

51  
»s
;

52 
	}
}

54 
__ex™
 
	$ex™_this_sc¡_driv”
()

56 
	`TRACE_ENTRY
();

58 #ifdeà
SCST_REGISTER_INITIATOR_DRIVER


59 
	`scsi_uÄegi¡”_moduË
(
MODULE_SCSI_HA
, &
driv”_‹m¶©e
);

62 
	`sc¡_uÄegi¡”_rg‘_‹m¶©e
(&
driv”_rg‘_‹m¶©e
);

64 
	`TRACE_EXIT
();

66 
	}
}

68 
moduË_š™
(
š™_this_sc¡_driv”
);

69 
moduË_ex™
(
ex™_this_sc¡_driv”
);

	@scst/src/scst_no_dlm.c

18 #ifdeà
INSIDE_KERNEL_TREE


19 
	~<sc¡/sc¡.h
>

20 
	~<sc¡/sc¡_cÚ¡.h
>

22 
	~"sc¡.h
"

23 
	~"sc¡_cÚ¡.h
"

25 
	~"sc¡_´iv.h
"

26 
	~"sc¡_´es.h
"

28 
	$sc¡_no_dlm_´_š™
(
sc¡_deviû
 *
dev
, cÚ¡ *
þ_dev_id
)

31 
	}
}

33 
	$sc¡_no_dlm_´_þ—nup
(
sc¡_deviû
 *
dev
)

35 
	}
}

37 
boÞ
 
	$sc¡_no_dlm_´_is_£t
(
sc¡_deviû
 *
dev
)

39  
dev
->
´_is_£t
;

40 
	}
}

42 
	$sc¡_no_dlm_´_š™_»g
(
sc¡_deviû
 *
dev
,

43 
sc¡_dev_»gi¡¿Á
 *
»g
)

45 
	}
}

47 
	$sc¡_no_dlm_´_rm_»g
(
sc¡_deviû
 *
dev
,

48 
sc¡_dev_»gi¡¿Á
 *
»g
)

50 
	}
}

52 
	$sc¡_no_dlm_´_wr™e_lock
(
sc¡_deviû
 *
dev
,

53 
sc¡_lksb
 *
´_lksb
)

55 
	`sc¡_´_wr™e_lock
(
dev
);

56 
	}
}

58 
	$sc¡_no_dlm_´_wr™e_uÆock
(
sc¡_deviû
 *
dev
,

59 
sc¡_lksb
 *
´_lksb
)

61 
	`sc¡_´_wr™e_uÆock
(
dev
);

62 
	}
}

64 
boÞ
 
	$sc¡_no_dlm_»£rved
(
sc¡_deviû
 *
dev
)

66  
dev
->
»£rved_by
;

67 
	}
}

69 
	$sc¡_no_dlm_»s_lock
(
sc¡_deviû
 *
dev
,

70 
sc¡_lksb
 *
´_lksb
)

71 
	`__acquœes
(&
dev
->
dev_lock
)

73 
	`EXTRACHECKS_BUG_ON
(
	`š_œq
(è|| 
	`œqs_di§bËd
());

74 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

75 
	}
}

77 
	$sc¡_no_dlm_»s_uÆock
(
sc¡_deviû
 *
dev
,

78 
sc¡_lksb
 *
´_lksb
)

79 
	`__»Ëa£s
(&
dev
->
dev_lock
)

81 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

82 
	}
}

84 
boÞ
 
	$sc¡_no_dlm_is_rsv_hÞd”
(
sc¡_deviû
 *
dev
,

85 
sc¡_£ssiÚ
 *
£ss
)

87 
	`EXTRACHECKS_BUG_ON
(
£ss
 =ð
NULL
);

88  
dev
->
»£rved_by
 =ð
£ss
;

89 
	}
}

91 
boÞ
 
	$sc¡_no_dlm_is_nÙ_rsv_hÞd”
(
sc¡_deviû
 *
dev
,

92 
sc¡_£ssiÚ
 *
£ss
)

94 
	`EXTRACHECKS_BUG_ON
(
£ss
 =ð
NULL
);

95  
dev
->
»£rved_by
 && dev->»£rved_by !ð
£ss
;

96 
	}
}

98 
	$sc¡_no_dlm_»£rve
(
sc¡_deviû
 *
dev
,

99 
sc¡_£ssiÚ
 *
£ss
)

101 
dev
->
»£rved_by
 = 
£ss
;

102 
	}
}

104 cÚ¡ 
sc¡_þ_Ýs
 
	gsc¡_no_dlm_þ_Ýs
 = {

105 .
´_š™
 = 
sc¡_no_dlm_´_š™
,

106 .
	g´_þ—nup
 = 
sc¡_no_dlm_´_þ—nup
,

107 .
	g´_is_£t
 = 
sc¡_no_dlm_´_is_£t
,

108 .
	g´_š™_»g
 = 
sc¡_no_dlm_´_š™_»g
,

109 .
	g´_rm_»g
 = 
sc¡_no_dlm_´_rm_»g
,

110 .
	g´_wr™e_lock
 = 
sc¡_no_dlm_´_wr™e_lock
,

111 .
	g´_wr™e_uÆock
 = 
sc¡_no_dlm_´_wr™e_uÆock
,

112 .
	g»£rved
 = 
sc¡_no_dlm_»£rved
,

113 .
	g»s_lock
 = 
sc¡_no_dlm_»s_lock
,

114 .
	g»s_uÆock
 = 
sc¡_no_dlm_»s_uÆock
,

115 .
	gis_rsv_hÞd”
 = 
sc¡_no_dlm_is_rsv_hÞd”
,

116 .
	gis_nÙ_rsv_hÞd”
 = 
sc¡_no_dlm_is_nÙ_rsv_hÞd”
,

117 .
	g»£rve
 = 
sc¡_no_dlm_»£rve
,

	@scst/src/scst_pres.c

19 
	~<lšux/š™.h
>

20 
	~<lšux/k”Ãl.h
>

21 
	~<lšux/”ºo.h
>

22 
	~<lšux/li¡.h
>

23 
	~<lšux/¥šlock.h
>

24 
	~<lšux/¦ab.h
>

25 
	~<lšux/sched.h
>

26 
	~<lšux/uni¡d.h
>

27 
	~<lšux/¡ršg.h
>

28 
	~<lšux/kth»ad.h
>

29 
	~<lšux/d–ay.h
>

30 #ifdeà
CONFIG_SCST_PROC


31 
	~<lšux/´oc_fs.h
>

32 
	~<lšux/£q_fže.h
>

34 
	~<lšux/time.h
>

35 
	~<lšux/ùy³.h
>

36 
	~<asm/by‹Üd”.h
>

37 
	~<lšux/sysÿÎs.h
>

38 
	~<lšux/fže.h
>

39 
	~<lšux/fs.h
>

40 
	~<lšux/fúŽ.h
>

41 
	~<lšux/uacûss.h
>

42 
	~<lšux/Çmei.h
>

43 #iâdeà
INSIDE_KERNEL_TREE


44 
	~<lšux/v”siÚ.h
>

46 
	~<lšux/vm®loc.h
>

47 
	~<asm/uÇligÃd.h
>

48 
	~<¡d¬g.h
>

50 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2,6,25)

51 
	~<lšux/mouÁ.h
>

54 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 29)

55 
	~<lšux/wr™eback.h
>

58 #ifdeà
INSIDE_KERNEL_TREE


59 
	~<sc¡/sc¡.h
>

60 
	~<sc¡/sc¡_cÚ¡.h
>

62 
	~"sc¡.h
"

63 
	~"sc¡_cÚ¡.h
"

65 
	~"sc¡_´iv.h
"

66 
	~"sc¡_´es.h
"

68 
	#SCST_PR_ROOT_ENTRY
 "´"

	)

69 
	#SCST_PR_FILE_SIGN
 0xBBEEEEAAEEBBDD77LLU

	)

70 
	#SCST_PR_FILE_VERSION
 1LLU

	)

72 
	#FILE_BUFFER_SIZE
 512

	)

74 #iâdeà
isbÏnk


75 
	#isbÏnk
(
c
è((cè=ð' ' || (cè=ð'\t')

	)

78 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 32è&& 
defšed
(
CONFIG_LOCKDEP
)

79 
	#sc¡_as£¹_´_mu‹x_h–d
(
dev
) \

81 ià(
dev
->
dev_li¡_’Œy
.
Ãxt
 && \

82 !
	`li¡_em±y
(&
dev
->
dev_li¡_’Œy
)) \

83 
	`lockd•_as£¹_h–d
(&
dev
->
dev_´_mu‹x
); \

84 } 0)

	)

86 
šlše
 
	$sc¡_as£¹_´_mu‹x_h–d
(
sc¡_deviû
 *
dev
)

88 
	}
}

91 
	$sc¡_tid_size
(cÚ¡ 
ušt8_t
 *
tid
)

93 
	`sBUG_ON
(
tid
 =ð
NULL
);

95 ià((
tid
[0] & 0x0fè=ð
SCSI_TRANSPORTID_PROTOCOLID_ISCSI
)

96  
	`g‘_uÇligÃd_be16
(&
tid
[2]) + 4;

98  
TID_COMMON_SIZE
;

99 
	}
}

102 
šlše
 
	$tid_£cu»
(
ušt8_t
 *
tid
)

104 ià((
tid
[0] & 0x0fè=ð
SCSI_TRANSPORTID_PROTOCOLID_ISCSI
) {

105 
size
 = 
	`sc¡_tid_size
(
tid
);

107 
tid
[
size
 - 1] = '\0';

111 
	}
}

114 
boÞ
 
	$tid_equ®
(cÚ¡ 
ušt8_t
 *
tid_a
, cÚ¡ ušt8_ˆ*
tid_b
)

116 
Ën
;

118 ià(
tid_a
 =ð
NULL
 || 
tid_b
 == NULL)

119  
çl£
;

121 ià((
tid_a
[0] & 0x0fè!ð(
tid_b
[0] & 0x0f)) {

122 
	`TRACE_DBG
("%s", "Different…rotocol IDs");

123  
çl£
;

126 ià((
tid_a
[0] & 0x0fè=ð
SCSI_TRANSPORTID_PROTOCOLID_ISCSI
) {

127 cÚ¡ 
ušt8_t
 
tid_a_fmt
 = 
tid_a
[0] & 0xc0;

128 cÚ¡ 
ušt8_t
 
tid_b_fmt
 = 
tid_b
[0] & 0xc0;

129 
tid_a_Ën
, 
tid_a_max
 = 
	`sc¡_tid_size
(
tid_a
) - 4;

130 
tid_b_Ën
, 
tid_b_max
 = 
	`sc¡_tid_size
(
tid_b
) - 4;

131 
i
;

133 
tid_a
 += 4;

134 
tid_b
 += 4;

136 ià(
tid_a_fmt
 == 0x00)

137 
tid_a_Ën
 = 
	`¡ºËn
(
tid_a
, 
tid_a_max
);

138 ià(
tid_a_fmt
 == 0x40) {

139 ià(
tid_a_fmt
 !ð
tid_b_fmt
) {

140 
ušt8_t
 *
p
 = 
	`¡ºchr
(
tid_a
, 
tid_a_max
, ',');

142 ià(
p
 =ð
NULL
)

143 
out_”rÜ
;

144 
tid_a_Ën
 = 
p
 - 
tid_a
;

146 
	`sBUG_ON
(
tid_a_Ën
 > 
tid_a_max
);

147 
	`sBUG_ON
(
tid_a_Ën
 < 0);

149 
tid_a_Ën
 = 
	`¡ºËn
(
tid_a
, 
tid_a_max
);

151 
out_”rÜ
;

153 ià(
tid_b_fmt
 == 0x00)

154 
tid_b_Ën
 = 
	`¡ºËn
(
tid_b
, 
tid_b_max
);

155 ià(
tid_b_fmt
 == 0x40) {

156 ià(
tid_a_fmt
 !ð
tid_b_fmt
) {

157 
ušt8_t
 *
p
 = 
	`¡ºchr
(
tid_b
, 
tid_b_max
, ',');

159 ià(
p
 =ð
NULL
)

160 
out_”rÜ
;

161 
tid_b_Ën
 = 
p
 - 
tid_b
;

163 
	`sBUG_ON
(
tid_b_Ën
 > 
tid_b_max
);

164 
	`sBUG_ON
(
tid_b_Ën
 < 0);

166 
tid_b_Ën
 = 
	`¡ºËn
(
tid_b
, 
tid_b_max
);

168 
out_”rÜ
;

170 ià(
tid_a_Ën
 !ð
tid_b_Ën
)

171  
çl£
;

173 
Ën
 = 
tid_a_Ën
;

176 
i
 = 0; i < 
Ën
; i++)

177 ià(
	`tÞow”
(
tid_a
[
i
]è!ðtÞow”(
tid_b
[i]))

178  
çl£
;

179  
Œue
;

181 
Ën
 = 
TID_COMMON_SIZE
;

183  
	`memcmp
(
tid_a
, 
tid_b
, 
Ën
) == 0;

185 
out_”rÜ
:

186 
	`PRINT_ERROR
("%s", "Invalid initiator…ortransport id");

187  
çl£
;

188 
	}
}

191 
	$sc¡_´_£t_hÞd”
(
sc¡_deviû
 *
dev
,

192 
sc¡_dev_»gi¡¿Á
 *
hÞd”
, 
ušt8_t
 
scÝe
, ušt8_ˆ
ty³
)

194 
	`sc¡_as£¹_´_mu‹x_h–d
(
dev
);

196 
dev
->
´_is_£t
 = 1;

197 
dev
->
´_scÝe
 = 
scÝe
;

198 
dev
->
´_ty³
 = 
ty³
;

199 ià(
dev
->
´_ty³
 !ð
TYPE_EXCLUSIVE_ACCESS_ALL_REG
 &&

200 
dev
->
´_ty³
 !ð
TYPE_WRITE_EXCLUSIVE_ALL_REG
)

201 
dev
->
´_hÞd”
 = 
hÞd”
;

202 
	}
}

205 
boÞ
 
	$sc¡_´_is_hÞd”
(
sc¡_deviû
 *
dev
,

206 
sc¡_dev_»gi¡¿Á
 *
»g
)

208 
boÞ
 
»s
 = 
çl£
;

210 
	`TRACE_ENTRY
();

212 
	`sc¡_as£¹_´_mu‹x_h–d
(
dev
);

214 ià(!
dev
->
´_is_£t
)

215 
out
;

217 ià(
dev
->
´_ty³
 =ð
TYPE_EXCLUSIVE_ACCESS_ALL_REG
 ||

218 
dev
->
´_ty³
 =ð
TYPE_WRITE_EXCLUSIVE_ALL_REG
) {

219 
»s
 = (
»g
 !ð
NULL
);

221 
»s
 = (
dev
->
´_hÞd”
 =ð
»g
);

223 
out
:

224 
	`TRACE_EXIT_RES
(
»s
);

225  
»s
;

226 
	}
}

228 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

231 
	$sc¡_´_dump_´s
(
sc¡_deviû
 *
dev
, 
boÞ
 
fÜû
)

233 
	`sc¡_as£¹_´_mu‹x_h–d
(
dev
);

235 ià(!
fÜû
) {

236 #ià
	`defšed
(
CONFIG_SCST_DEBUG
)

237 ià((
Œaû_æag
 & 
TRACE_PRES
) == 0)

239 
out
;

242 
	`PRINT_INFO
("P”si¡’ˆ»£rv©iÚ fÜ deviû %s:", 
dev
->
vœt_Çme
);

244 ià(
	`li¡_em±y
(&
dev
->
dev_»gi¡¿Ás_li¡
))

245 
	`PRINT_INFO
("%s", " No„egistrants");

247 
sc¡_dev_»gi¡¿Á
 *
»g
;

248 
i
 = 0;

250 
	`li¡_fÜ_—ch_’Œy
(
»g
, &
dev
->
dev_»gi¡¿Ás_li¡
,

251 
dev_»gi¡¿Ás_li¡_’Œy
) {

252 
	`PRINT_INFO
(" [%d]„egistrant %s/%d, key %016llx "

253 "Ôeg %p,gt_dev %p)", 
i
++,

254 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(

255 
»g
->
Œª¥Üt_id
),

256 
»g
->
»l_tgt_id
, 
	`be64_to_ýu
Ôeg->
key
),„eg,

257 
»g
->
tgt_dev
);

261 ià(
dev
->
´_is_£t
) {

262 
sc¡_dev_»gi¡¿Á
 *
hÞd”
 = 
dev
->
´_hÞd”
;

264 ià(
hÞd”
 !ð
NULL
)

265 
	`PRINT_INFO
("Reservation holder is %s/%d (key %016llx, "

267 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(

268 
hÞd”
->
Œª¥Üt_id
),

269 
hÞd”
->
»l_tgt_id
, 
	`be64_to_ýu
(hÞd”->
key
),

270 
dev
->
´_scÝe
, dev->
´_ty³
, 
hÞd”
,

271 
hÞd”
->
tgt_dev
);

273 
	`PRINT_INFO
("All„egistrants‡re„eservation holders "

274 "(scÝ%x,y³ %x)", 
dev
->
´_scÝe
,

275 
dev
->
´_ty³
);

277 
	`PRINT_INFO
("%s", "Not„eserved");

279 
out
:

281 
	}
}

286 
	$sc¡_´_fšd_»gi¡¿Ás_li¡_®l
(
sc¡_deviû
 *
dev
,

287 
sc¡_dev_»gi¡¿Á
 *
exþude_»g
, 
li¡_h—d
 *
li¡
)

289 
sc¡_dev_»gi¡¿Á
 *
»g
;

291 
	`TRACE_ENTRY
();

293 
	`sc¡_as£¹_´_mu‹x_h–d
(
dev
);

295 
	`TRACE_PR
("Finding‡ll„egistered„ecords for device '%s' "

297 
dev
->
vœt_Çme
, 
	`be64_to_ýu
(
exþude_»g
->
key
));

299 
	`li¡_fÜ_—ch_’Œy
(
»g
, &
dev
->
dev_»gi¡¿Ás_li¡
,

300 
dev_»gi¡¿Ás_li¡_’Œy
) {

301 ià(
»g
 =ð
exþude_»g
)

303 
	`TRACE_PR
("Adding„egistrant %s/%d (%p)o find†ist (key %016llx)",

304 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
»g
->
Œª¥Üt_id
),

305 
»g
->
»l_tgt_id
,„eg, 
	`be64_to_ýu
Ôeg->
key
));

306 
	`li¡_add_ž
(&
»g
->
aux_li¡_’Œy
, 
li¡
);

309 
	`TRACE_EXIT
();

311 
	}
}

314 
	$sc¡_´_fšd_»gi¡¿Ás_li¡_key
(
sc¡_deviû
 *
dev
,

315 
__be64
 
key
, 
li¡_h—d
 *
li¡
)

317 
sc¡_dev_»gi¡¿Á
 *
»g
;

319 
	`TRACE_ENTRY
();

321 
	`sc¡_as£¹_´_mu‹x_h–d
(
dev
);

323 
	`TRACE_PR
("Finding„egistrants for device '%s' with key %016llx",

324 
dev
->
vœt_Çme
, 
	`be64_to_ýu
(
key
));

326 
	`li¡_fÜ_—ch_’Œy
(
»g
, &
dev
->
dev_»gi¡¿Ás_li¡
,

327 
dev_»gi¡¿Ás_li¡_’Œy
) {

328 ià(
»g
->
key
 == key) {

329 
	`TRACE_PR
("Adding„egistrant %s/%d (%p)ohe find "

331 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(

332 
»g
->
Œª¥Üt_id
),

333 
»g
->
»l_tgt_id
,„eg->
tgt_dev
,

334 
	`be64_to_ýu
(
key
));

335 
	`li¡_add_ž
(&
»g
->
aux_li¡_’Œy
, 
li¡
);

339 
	`TRACE_EXIT
();

341 
	}
}

344 
sc¡_dev_»gi¡¿Á
 *
	$sc¡_´_fšd_»g
(

345 
sc¡_deviû
 *
dev
, cÚ¡ 
ušt8_t
 *
Œª¥Üt_id
,

346 cÚ¡ 
ušt16_t
 
»l_tgt_id
)

348 
sc¡_dev_»gi¡¿Á
 *
»g
, *
»s
 = 
NULL
;

350 
	`TRACE_ENTRY
();

352 
	`sc¡_as£¹_´_mu‹x_h–d
(
dev
);

354 
	`li¡_fÜ_—ch_’Œy
(
»g
, &
dev
->
dev_»gi¡¿Ás_li¡
,

355 
dev_»gi¡¿Ás_li¡_’Œy
) {

356 ià((
»g
->
»l_tgt_id
 ==„el_tgt_id) &&

357 
	`tid_equ®
(
»g
->
Œª¥Üt_id
,ransport_id)) {

358 
»s
 = 
»g
;

363 
	`TRACE_EXIT_HRES
(
»s
);

364  
»s
;

365 
	}
}

368 
	$sc¡_´_þ—r_»£rv©iÚ
(
sc¡_deviû
 *
dev
)

370 
	`TRACE_ENTRY
();

372 
	`sc¡_as£¹_´_mu‹x_h–d
(
dev
);

374 
	`WARN_ON
(!
dev
->
´_is_£t
);

376 
dev
->
´_is_£t
 = 0;

377 
dev
->
´_scÝe
 = 
SCOPE_LU
;

378 
dev
->
´_ty³
 = 
TYPE_UNSPECIFIED
;

380 
dev
->
´_hÞd”
 = 
NULL
;

382 
	`TRACE_EXIT
();

384 
	}
}

387 
	$sc¡_´_þ—r_hÞd”
(
sc¡_deviû
 *
dev
)

389 
	`TRACE_ENTRY
();

391 
	`sc¡_as£¹_´_mu‹x_h–d
(
dev
);

393 
	`WARN_ON
(!
dev
->
´_is_£t
);

395 ià(
dev
->
´_ty³
 =ð
TYPE_WRITE_EXCLUSIVE_ALL_REG
 ||

396 
dev
->
´_ty³
 =ð
TYPE_EXCLUSIVE_ACCESS_ALL_REG
) {

397 ià(
	`li¡_em±y
(&
dev
->
dev_»gi¡¿Ás_li¡
))

398 
	`sc¡_´_þ—r_»£rv©iÚ
(
dev
);

400 
	`sc¡_´_þ—r_»£rv©iÚ
(
dev
);

402 
dev
->
´_hÞd”
 = 
NULL
;

404 
	`TRACE_EXIT
();

406 
	}
}

409 
sc¡_dev_»gi¡¿Á
 *
	$sc¡_´_add_»gi¡¿Á
(

410 
sc¡_deviû
 *
dev
, cÚ¡ 
ušt8_t
 *
Œª¥Üt_id
,

411 cÚ¡ 
ušt16_t
 
»l_tgt_id
, 
__be64
 
key
,

412 
boÞ
 
dev_lock_locked
)

414 
sc¡_dev_»gi¡¿Á
 *
»g
;

415 
sc¡_tgt_dev
 *
t
;

416 
gå_t
 
gå_æags
 = 
dev_lock_locked
 ? 
GFP_ATOMIC
 : 
GFP_KERNEL
;

418 
	`TRACE_ENTRY
();

420 
	`sc¡_as£¹_´_mu‹x_h–d
(
dev
);

422 
	`sBUG_ON
(
dev
 =ð
NULL
);

423 
	`sBUG_ON
(
Œª¥Üt_id
 =ð
NULL
);

425 
	`TRACE_PR
("Registering %s/%d (dev %s)",

426 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
Œª¥Üt_id
),

427 
»l_tgt_id
, 
dev
->
vœt_Çme
);

429 
»g
 = 
	`sc¡_´_fšd_»g
(
dev
, 
Œª¥Üt_id
, 
»l_tgt_id
);

430 ià(
»g
 !ð
NULL
) {

435 
	`PRINT_ERROR
("Regi¡¿Á %p/%d (dev %sè®»adyƒxi¡s!", 
»g
,

436 
»l_tgt_id
, 
dev
->
vœt_Çme
);

437 
	`PRINT_BUFFER
("T¿n¥ÜtID", 
Œª¥Üt_id
, 24);

438 
	`WARN_ON
(1);

439 
»g
 = 
NULL
;

440 
out
;

443 
»g
 = 
	`kz®loc
((*»g), 
gå_æags
);

444 ià(
»g
 =ð
NULL
) {

445 
	`PRINT_ERROR
("%s", "Unableo‡llocate„egistration„ecord");

446 
out
;

449 
dev
->
þ_Ýs
->
	`´_š™_»g
(dev, 
»g
);

451 
»g
->
Œª¥Üt_id
 = 
	`kmemdup
Ñ¿n¥Üt_id, 
	`sc¡_tid_size
(transport_id),

452 
gå_æags
);

453 ià(
»g
->
Œª¥Üt_id
 =ð
NULL
) {

454 
	`PRINT_ERROR
("%s", "Unableo‡llocate initiator…ort "

456 
out_ä“
;

459 
»g
->
»l_tgt_id
 =„el_tgt_id;

460 
»g
->
key
 = key;

466 #ià!
	`defšed
(
__CHECKER__
)

467 ià(!
dev_lock_locked
)

468 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

470 
	`li¡_fÜ_—ch_’Œy
(
t
, &
dev
->
dev_tgt_dev_li¡
, 
dev_tgt_dev_li¡_’Œy
) {

471 ià(
	`tid_equ®
(
t
->
£ss
->
Œª¥Üt_id
,ransport_id) &&

472 (
t
->
£ss
->
tgt
->
»l_tgt_id
 ==„el_tgt_id) &&

473 (
t
->
»gi¡¿Á
 =ð
NULL
)) {

478 
	`TRACE_PR
("Foundgt_dev %p", 
t
);

479 
»g
->
tgt_dev
 = 
t
;

480 
t
->
»gi¡¿Á
 = 
»g
;

484 #ià!
	`defšed
(
__CHECKER__
)

485 ià(!
dev_lock_locked
)

486 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

489 
	`li¡_add_ž
(&
»g
->
dev_»gi¡¿Ás_li¡_’Œy
,

490 &
dev
->
dev_»gi¡¿Ás_li¡
);

492 
	`TRACE_PR
("Reg %°»gi¡”ed (dev %s,gt_dev %p)", 
»g
,

493 
dev
->
vœt_Çme
, 
»g
->
tgt_dev
);

495 
out
:

496 
	`TRACE_EXIT_HRES
(()
»g
);

497  
»g
;

499 
out_ä“
:

500 
	`kä“
(
»g
);

501 
»g
 = 
NULL
;

502 
out
;

503 
	}
}

506 
	$sc¡_´_»move_»gi¡¿Á
(
sc¡_deviû
 *
dev
,

507 
sc¡_dev_»gi¡¿Á
 *
»g
)

509 
	`TRACE_ENTRY
();

511 
	`sc¡_as£¹_´_mu‹x_h–d
(
dev
);

513 
	`TRACE_PR
("Removing„egistrant %s/%d (reg %p,gt_dev %p, key %016llx, "

514 "dev %s)", 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
»g
->
Œª¥Üt_id
),

515 
»g
->
»l_tgt_id
,„eg,„eg->
tgt_dev
, 
	`be64_to_ýu
Ôeg->
key
),

516 
dev
->
vœt_Çme
);

518 
	`li¡_d–
(&
»g
->
dev_»gi¡¿Ás_li¡_’Œy
);

520 
dev
->
þ_Ýs
->
	`´_rm_»g
(dev, 
»g
);

522 ià(
	`sc¡_´_is_hÞd”
(
dev
, 
»g
))

523 
	`sc¡_´_þ—r_hÞd”
(
dev
);

525 ià(
»g
->
tgt_dev
)

526 
»g
->
tgt_dev
->
»gi¡¿Á
 = 
NULL
;

528 
	`kä“
(
»g
->
Œª¥Üt_id
);

529 
	`kä“
(
»g
);

531 
	`TRACE_EXIT
();

533 
	}
}

535 
	$sc¡_´_»move_»gi¡¿Ás
(
sc¡_deviû
 *
dev
)

537 
sc¡_dev_»gi¡¿Á
 *
»g
, *
tmp_»g
;

539 
	`li¡_fÜ_—ch_’Œy_§ã
(
»g
, 
tmp_»g
, &
dev
->
dev_»gi¡¿Ás_li¡
,

540 
dev_»gi¡¿Ás_li¡_’Œy
) {

541 
	`sc¡_´_»move_»gi¡¿Á
(
dev
, 
»g
);

543 
	}
}

546 
	$sc¡_´_£nd_ua_»g
(
sc¡_deviû
 *
dev
,

547 
sc¡_dev_»gi¡¿Á
 *
»g
,

548 
key
, 
asc
, 
ascq
)

550 
ušt8_t
 
ua
[
SCST_STANDARD_SENSE_LEN
];

552 
	`TRACE_ENTRY
();

554 
	`sc¡_as£¹_´_mu‹x_h–d
(
dev
);

556 
	`sc¡_£t_£n£
(
ua
, (ua), 
dev
->
d_£n£
, 
key
, 
asc
, 
ascq
);

558 
	`TRACE_PR
("Queueing UA [%x %x %x]:„egistrant %s/%d (%p),gt_dev %p, "

559 "key %016Îx", 
ua
[2], ua[12], ua[13],

560 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
»g
->
Œª¥Üt_id
),

561 
»g
->
»l_tgt_id
,„eg,„eg->
tgt_dev
, 
	`be64_to_ýu
Ôeg->
key
));

563 ià(
»g
->
tgt_dev
)

564 
	`sc¡_check_£t_UA
(
»g
->
tgt_dev
, 
ua
, (ua), 0);

566 
	`TRACE_EXIT
();

568 
	}
}

571 
	$sc¡_´_£nd_ua_®l
(
sc¡_deviû
 *
dev
,

572 
sc¡_dev_»gi¡¿Á
 *
exþude_»g
,

573 
key
, 
asc
, 
ascq
)

575 
sc¡_dev_»gi¡¿Á
 *
»g
;

577 
	`TRACE_ENTRY
();

579 
	`sc¡_as£¹_´_mu‹x_h–d
(
dev
);

581 
	`li¡_fÜ_—ch_’Œy
(
»g
, &
dev
->
dev_»gi¡¿Ás_li¡
,

582 
dev_»gi¡¿Ás_li¡_’Œy
) {

583 ià(
»g
 !ð
exþude_»g
)

584 
	`sc¡_´_£nd_ua_»g
(
dev
, 
»g
, 
key
, 
asc
, 
ascq
);

587 
	`TRACE_EXIT
();

589 
	}
}

592 
	$sc¡_´_abÜt_»g
(
sc¡_deviû
 *
dev
,

593 
sc¡_cmd
 *
´_cmd
, 
sc¡_dev_»gi¡¿Á
 *
»g
)

595 
sc¡_£ssiÚ
 *
£ss
;

596 
__be64
 
·cked_lun
;

597 
rc
;

599 
	`TRACE_ENTRY
();

601 
	`sc¡_as£¹_´_mu‹x_h–d
(
dev
);

603 ià(
»g
->
tgt_dev
 =ð
NULL
) {

604 
	`TRACE_PR
("Registrant %s/%d (%p, key 0x%016llx) has‚o session",

605 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
»g
->
Œª¥Üt_id
),

606 
»g
->
»l_tgt_id
,„eg, 
	`be64_to_ýu
Ôeg->
key
));

607 
out
;

610 
£ss
 = 
»g
->
tgt_dev
->sess;

612 
	`TRACE_PR
("Aborting %d commands for %s/%d (reg %p, key 0x%016llx, "

614 
	`©omic_»ad
(&
»g
->
tgt_dev
->
tgt_dev_cmd_couÁ
),

615 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
»g
->
Œª¥Üt_id
),

616 
»g
->
»l_tgt_id
,„eg, 
	`be64_to_ýu
Ôeg->
key
),„eg->
tgt_dev
,

617 
£ss
);

619 
·cked_lun
 = 
	`sc¡_·ck_lun
(
»g
->
tgt_dev
->
lun
, 
£ss
->
acg
->
addr_m‘hod
);

621 
rc
 = 
	`sc¡_rx_mgmt_â_lun
(
£ss
, 
SCST_PR_ABORT_ALL
,

622 &
·cked_lun
, Õacked_lun), 
SCST_NON_ATOMIC
,

623 
´_cmd
);

624 ià(
rc
 != 0) {

629 
	`PRINT_ERROR
("SCST_PR_ABORT_ALL failed %d (sess %p)",

630 
rc
, 
£ss
);

631 
out
;

634 ià((
»g
->
tgt_dev
 !ð
´_cmd
->tgt_devè&& !
dev
->
s
) {

635 
ušt8_t
 
£n£_bufãr
[
SCST_STANDARD_SENSE_LEN
];

636 
¦
;

638 
¦
 = 
	`sc¡_£t_£n£
(
£n£_bufãr
, (sense_buffer),

639 
dev
->
d_£n£
,

640 
	`SCST_LOAD_SENSE
(
sc¡_£n£_þ—»d_by_ªÙh”_ši_UA
));

652 
	`sc¡_check_£t_UA
(
»g
->
tgt_dev
, 
£n£_bufãr
, 
¦
, 0);

655 
out
:

656 
	`TRACE_EXIT
();

658 
	}
}

660 #iâdeà
CONFIG_SCST_PROC


663 
	$sc¡_´_do_lßd_deviû_fže
(
sc¡_deviû
 *
dev
,

664 cÚ¡ *
fže_Çme
)

666 
»s
 = 0, 
rc
;

667 
fže
 *fžð
NULL
;

668 
šode
 *inode;

669 *
buf
 = 
NULL
;

670 
loff_t
 
fže_size
, 
pos
, 
d©a_size
;

671 
ušt64_t
 
sign
, 
v”siÚ
;

672 
mm_£gm’t_t
 
Þd_fs
;

673 
ušt8_t
 
´_is_£t
, 
­l
;

674 
__be64
 
key
;

675 
ušt16_t
 
»l_tgt_id
;

677 
	`TRACE_ENTRY
();

679 
	`sc¡_as£¹_´_mu‹x_h–d
(
dev
);

681 
	`sc¡_´_»move_»gi¡¿Ás
(
dev
);

683 
Þd_fs
 = 
	`g‘_fs
();

684 
	`£t_fs
(
KERNEL_DS
);

686 
	`TRACE_PR
("Lßdšg…”si¡’ˆfž'%s'", 
fže_Çme
);

688 
fže
 = 
	`fžp_Ý’
(
fže_Çme
, 
O_RDONLY
, 0);

689 ià(
	`IS_ERR
(
fže
)) {

690 
»s
 = 
	`PTR_ERR
(
fže
);

691 
	`TRACE_PR
("UÇbËØÝ’ fž'%s' -ƒ¼Ü %d", 
fže_Çme
, 
»s
);

692 
out
;

695 
šode
 = 
	`fže_šode
(
fže
);

697 ià(
	`S_ISREG
(
šode
->
i_mode
)) {

699 } ià(
	`S_ISBLK
(
šode
->
i_mode
)) {

700 
šode
 = inode->
i_bdev
->
bd_šode
;

702 
	`PRINT_ERROR
("Inv®id fžmod0x%x", 
šode
->
i_mode
);

703 
out_þo£
;

706 
fže_size
 = 
šode
->
i_size
;

709 ià((
fže_size
 == 0) || (file_size >= 15*1024*1024)) {

710 
	`PRINT_ERROR
("Inv®id PR fžsiz%d", ()
fže_size
);

711 
»s
 = -
EINVAL
;

712 
out_þo£
;

715 
buf
 = 
	`vm®loc
(
fže_size
);

716 ià(
buf
 =ð
NULL
) {

717 
»s
 = -
ENOMEM
;

718 
	`PRINT_ERROR
("%s", "Unableo‡llocate buffer");

719 
out_þo£
;

722 
pos
 = 0;

723 
rc
 = 
	`vfs_»ad
(
fže
, (
__fÜû
 
__u£r
 *)
buf
, 
fže_size
, &
pos
);

724 ià(
rc
 !ð
fže_size
) {

725 
	`PRINT_ERROR
("UÇbËØ»ad fž'%s' -ƒ¼Ü %d", 
fže_Çme
,

726 
rc
);

727 
»s
 = 
rc
;

728 
out_þo£
;

731 
d©a_size
 = 0;

732 
d©a_size
 +ð(
sign
);

733 
d©a_size
 +ð(
v”siÚ
);

734 
d©a_size
 +ð(
­l
);

735 
d©a_size
 +ð(
´_is_£t
);

736 
d©a_size
 +ð(
dev
->
´_ty³
);

737 
d©a_size
 +ð(
dev
->
´_scÝe
);

739 ià(
fže_size
 < 
d©a_size
) {

740 
»s
 = -
EINVAL
;

741 
	`PRINT_ERROR
("Inv®id fž'%s' - siztoØsm®l", 
fže_Çme
);

742 
out_þo£
;

745 
pos
 = 0;

747 
sign
 = 
	`g‘_uÇligÃd
((
ušt64_t
 *)&
buf
[
pos
]);

748 ià(
sign
 !ð
SCST_PR_FILE_SIGN
) {

749 
»s
 = -
EINVAL
;

750 
	`PRINT_ERROR
("Invalid…ersistent file signature %016llx "

751 "Óx³ùed %016Îx)", 
sign
, 
SCST_PR_FILE_SIGN
);

752 
out_þo£
;

754 
pos
 +ð(
sign
);

756 
v”siÚ
 = 
	`g‘_uÇligÃd
((
ušt64_t
 *)&
buf
[
pos
]);

757 ià(
v”siÚ
 !ð
SCST_PR_FILE_VERSION
) {

758 
»s
 = -
EINVAL
;

759 
	`PRINT_ERROR
("Invalid…ersistent file version %016llx "

760 "Óx³ùed %016Îx)", 
v”siÚ
, 
SCST_PR_FILE_VERSION
);

761 
out_þo£
;

763 
pos
 +ð(
v”siÚ
);

765 
d©a_size
 < 
fže_size
) {

766 
ušt8_t
 *
tid
;

768 
d©a_size
++;

769 
tid
 = &
buf
[
d©a_size
];

770 
d©a_size
 +ð
	`sc¡_tid_size
(
tid
);

771 
d©a_size
 +ð(
key
);

772 
d©a_size
 +ð(
»l_tgt_id
);

774 ià(
d©a_size
 > 
fže_size
) {

775 
»s
 = -
EINVAL
;

776 
	`PRINT_ERROR
("Invalid file '%s' - size mismatch have "

777 "%Îdƒx³ùed %Îd", 
fže_Çme
, 
fže_size
,

778 
d©a_size
);

779 
out_þo£
;

783 
­l
 = 
buf
[
pos
];

784 
dev
->
´_­l
 = 
­l
 ? 1 : 0;

785 
pos
 +ð(
­l
);

787 
´_is_£t
 = 
buf
[
pos
];

788 
dev
->
´_is_£t
 =…r_is_set ? 1 : 0;

789 
pos
 +ð(
´_is_£t
);

791 
dev
->
´_ty³
 = 
buf
[
pos
];

792 
pos
 +ð(
dev
->
´_ty³
);

794 
dev
->
´_scÝe
 = 
buf
[
pos
];

795 
pos
 +ð(
dev
->
´_scÝe
);

797 
pos
 < 
fže_size
) {

798 
ušt8_t
 
is_hÞd”
;

799 
ušt8_t
 *
tid
;

800 
sc¡_dev_»gi¡¿Á
 *
»g
 = 
NULL
;

802 
is_hÞd”
 = 
buf
[
pos
++];

804 
tid
 = &
buf
[
pos
];

805 
pos
 +ð
	`sc¡_tid_size
(
tid
);

807 
key
 = 
	`g‘_uÇligÃd
((
__be64
 *)&
buf
[
pos
]);

808 
pos
 +ð(
key
);

810 
»l_tgt_id
 = 
	`g‘_uÇligÃd
((
ušt16_t
 *)&
buf
[
pos
]);

811 
pos
 +ð(
»l_tgt_id
);

813 
»g
 = 
	`sc¡_´_add_»gi¡¿Á
(
dev
, 
tid
, 
»l_tgt_id
, 
key
, 
çl£
);

814 ià(
»g
 =ð
NULL
) {

815 
»s
 = -
ENOMEM
;

816 
out_þo£
;

819 ià(
is_hÞd”
)

820 
dev
->
´_hÞd”
 = 
»g
;

823 
out_þo£
:

824 
	`fžp_þo£
(
fže
, 
NULL
);

826 
out
:

827 ià(
buf
 !ð
NULL
)

828 
	`vä“
(
buf
);

830 
	`£t_fs
(
Þd_fs
);

832 
	`TRACE_EXIT_RES
(
»s
);

833  
»s
;

834 
	}
}

836 
	$sc¡_´_lßd_deviû_fže
(
sc¡_deviû
 *
dev
)

838 
»s
, 
rc
;

840 
	`TRACE_ENTRY
();

842 
	`sc¡_as£¹_´_mu‹x_h–d
(
dev
);

844 ià(
dev
->
´_fže_Çme
 =ð
NULL
 || dev->
´_fže_Çme1
 == NULL) {

845 
	`PRINT_ERROR
("Inv®id fž·th fÜ '%s'", 
dev
->
vœt_Çme
);

846 
»s
 = -
EINVAL
;

847 
out
;

850 
»s
 = 
	`sc¡_´_do_lßd_deviû_fže
(
dev
, dev->
´_fže_Çme
);

851 ià(
»s
 == 0)

852 
out_dump
;

853 ià(
»s
 =ð-
ENOMEM
)

854 
out
;

856 
rc
 = 
»s
;

858 
»s
 = 
	`sc¡_´_do_lßd_deviû_fže
(
dev
, dev->
´_fže_Çme1
);

859 ià(
»s
 != 0) {

860 ià(
»s
 =ð-
ENOENT
)

861 
»s
 = 
rc
;

862 
out
;

865 
out_dump
:

866 
	`sc¡_´_dump_´s
(
dev
, 
çl£
);

868 
out
:

869 
	`TRACE_EXIT_RES
(
»s
);

870  
»s
;

871 
	}
}

873 
	$sc¡_´_»move_deviû_fžes
(
sc¡_tgt_dev
 *
tgt_dev
)

875 
sc¡_deviû
 *
dev
 = 
tgt_dev
->dev;

877 
	`TRACE_ENTRY
();

879 
	`sc¡_as£¹_´_mu‹x_h–d
(
dev
);

881 ià(
dev
->
´_fže_Çme
)

882 
	`sc¡_»move_fže
(
dev
->
´_fže_Çme
);

883 ià(
dev
->
´_fže_Çme1
)

884 
	`sc¡_»move_fže
(
dev
->
´_fže_Çme1
);

886 
	`TRACE_EXIT
();

888 
	}
}

891 
	$sc¡_´_sync_deviû_fže
(
sc¡_tgt_dev
 *
tgt_dev
, 
sc¡_cmd
 *
cmd
)

893 
»s
 = 0;

894 
sc¡_deviû
 *
dev
 = 
tgt_dev
->dev;

895 
fže
 *file;

896 
mm_£gm’t_t
 
Þd_fs
 = 
	`g‘_fs
();

897 
loff_t
 
pos
 = 0;

898 
ušt64_t
 
sign
;

899 
ušt64_t
 
v”siÚ
;

900 
ušt8_t
 
´_is_£t
, 
­l
;

901 
sc¡_dev_»gi¡¿Á
 *
»g
;

903 
	`TRACE_ENTRY
();

905 
	`sc¡_as£¹_´_mu‹x_h–d
(
dev
);

907 ià((
dev
->
´_­l
 =ð0è|| 
	`li¡_em±y
(&dev->
dev_»gi¡¿Ás_li¡
)) {

908 
	`sc¡_´_»move_deviû_fžes
(
tgt_dev
);

909 
out
;

912 
	`sc¡_cÝy_fže
(
dev
->
´_fže_Çme
, dev->
´_fže_Çme1
);

914 
	`£t_fs
(
KERNEL_DS
);

916 
fže
 = 
	`fžp_Ý’
(
dev
->
´_fže_Çme
, 
O_WRONLY
 | 
O_CREAT
 | 
O_TRUNC
, 0644);

917 ià(
	`IS_ERR
(
fže
)) {

918 
»s
 = 
	`PTR_ERR
(
fže
);

919 
	`PRINT_ERROR
("Unableo (re)create PR file '%s' -ƒrror %d",

920 
dev
->
´_fže_Çme
, 
»s
);

921 
out_£t_fs
;

924 
	`TRACE_PR
("Upd©šg…¸fž'%s'", 
dev
->
´_fže_Çme
);

929 
sign
 = 0;

930 
pos
 = 0;

931 
»s
 = 
	`vfs_wr™e
(
fže
, (
__fÜû
 
__u£r
 *)&
sign
, (sign), &
pos
);

932 ià(
»s
 !ð(
sign
))

933 
wr™e_”rÜ
;

938 
v”siÚ
 = 
SCST_PR_FILE_VERSION
;

939 
»s
 = 
	`vfs_wr™e
(
fže
, (
__fÜû
 
__u£r
 *)&
v”siÚ
, (v”siÚ), &
pos
);

940 ià(
»s
 !ð(
v”siÚ
))

941 
wr™e_”rÜ
;

946 
­l
 = 
dev
->
´_­l
;

947 
»s
 = 
	`vfs_wr™e
(
fže
, (
__fÜû
 
__u£r
 *)&
­l
, ×±¶), &
pos
);

948 ià(
»s
 !ð(
­l
))

949 
wr™e_”rÜ
;

954 
´_is_£t
 = 
dev
->pr_is_set;

955 
»s
 = 
	`vfs_wr™e
(
fže
, (
__fÜû
 
__u£r
 *)&
´_is_£t
, Õr_is_£t), &
pos
);

956 ià(
»s
 !ð(
´_is_£t
))

957 
wr™e_”rÜ
;

959 
»s
 = 
	`vfs_wr™e
(
fže
, (
__fÜû
 
__u£r
 *)&
dev
->
´_ty³
, (dev->´_ty³), &
pos
);

960 ià(
»s
 !ð(
dev
->
´_ty³
))

961 
wr™e_”rÜ
;

963 
»s
 = 
	`vfs_wr™e
(
fže
, (
__fÜû
 
__u£r
 *)&
dev
->
´_scÝe
, (dev->´_scÝe), &
pos
);

964 ià(
»s
 !ð(
dev
->
´_scÝe
))

965 
wr™e_”rÜ
;

970 
	`li¡_fÜ_—ch_’Œy
(
»g
, &
dev
->
dev_»gi¡¿Ás_li¡
,

971 
dev_»gi¡¿Ás_li¡_’Œy
) {

972 
ušt8_t
 
is_hÞd”
 = 0;

973 
size
;

975 
is_hÞd”
 = (
dev
->
´_hÞd”
 =ð
»g
);

977 
»s
 = 
	`vfs_wr™e
(
fže
, (
__fÜû
 
__u£r
 *)&
is_hÞd”
,

978 (
is_hÞd”
), &
pos
);

979 ià(
»s
 !ð(
is_hÞd”
))

980 
wr™e_”rÜ
;

982 
size
 = 
	`sc¡_tid_size
(
»g
->
Œª¥Üt_id
);

983 
»s
 = 
	`vfs_wr™e
(
fže
, (
__fÜû
 
__u£r
 *)
»g
->
Œª¥Üt_id
,

984 
size
, &
pos
);

985 ià(
»s
 !ð
size
)

986 
wr™e_”rÜ
;

988 
»s
 = 
	`vfs_wr™e
(
fže
, (
__fÜû
 
__u£r
 *)&
»g
->
key
,

989 (
»g
->
key
), &
pos
);

990 ià(
»s
 !ð(
»g
->
key
))

991 
wr™e_”rÜ
;

993 
»s
 = 
	`vfs_wr™e
(
fže
, (
__fÜû
 
__u£r
 *)&
»g
->
»l_tgt_id
,

994 (
»g
->
»l_tgt_id
), &
pos
);

995 ià(
»s
 !ð(
»g
->
»l_tgt_id
))

996 
wr™e_”rÜ
;

999 
»s
 = 
	`vfs_fsync
(
fže
, 1);

1000 ià(
»s
 != 0) {

1001 
	`PRINT_ERROR
("fsync(èoàthPR fžçžed: %d", 
»s
);

1002 
wr™e_”rÜ_þo£
;

1005 
sign
 = 
SCST_PR_FILE_SIGN
;

1006 
pos
 = 0;

1007 
»s
 = 
	`vfs_wr™e
(
fže
, (
__fÜû
 
__u£r
 *)&
sign
, (sign), &
pos
);

1008 ià(
»s
 !ð(
sign
))

1009 
wr™e_”rÜ
;

1011 
»s
 = 
	`vfs_fsync
(
fže
, 1);

1012 ià(
»s
 != 0) {

1013 
	`PRINT_ERROR
("fsync(èoàthPR fžçžed: %d", 
»s
);

1014 
wr™e_”rÜ_þo£
;

1017 
»s
 = 0;

1019 
	`fžp_þo£
(
fže
, 
NULL
);

1021 
out_£t_fs
:

1022 
	`£t_fs
(
Þd_fs
);

1024 
out
:

1025 ià(
»s
 != 0) {

1026 
	`PRINT_CRIT_ERROR
("Unableo save…ersistent information "

1028 
tgt_dev
->
£ss
->
tgt
->
tgt_Çme
,

1029 
tgt_dev
->
£ss
->
š™ŸtÜ_Çme
, 
dev
->
vœt_Çme
);

1036 ià(
cmd
 !ð
NULL
)

1037 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_š‹º®_çžu»
));

1041 
	`TRACE_EXIT_RES
(
»s
);

1044 
wr™e_”rÜ
:

1045 
	`PRINT_ERROR
("E¼Ü wr™šgØ'%s' -ƒ¼Ü %d", 
dev
->
´_fže_Çme
, 
»s
);

1047 
wr™e_”rÜ_þo£
:

1048 
	`fžp_þo£
(
fže
, 
NULL
);

1049 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 39)

1051 
Çmeid©a
 
nd
;

1052 
rc
;

1054 
rc
 = 
	`·th_lookup
(
dev
->
´_fže_Çme
, 0, &
nd
);

1055 ià(!
rc
)

1056 
	`sc¡_vfs_uÆšk_ªd_put
(&
nd
);

1058 
	`TRACE_PR
("Unableo†ookup '%s' -ƒrror %d",

1059 
dev
->
´_fže_Çme
, 
rc
);

1063 
·th
…ath;

1064 
rc
;

1066 
rc
 = 
	`k”n_·th
(
dev
->
´_fže_Çme
, 0, &
·th
);

1067 ià(!
rc
)

1068 
	`sc¡_vfs_uÆšk_ªd_put
(&
·th
);

1070 
	`TRACE_PR
("Unableo†ookup '%s' -ƒrror %d",

1071 
dev
->
´_fže_Çme
, 
rc
);

1074 
out_£t_fs
;

1075 
	}
}

1090 
	$sc¡_´_£t_fže_Çme
(
sc¡_deviû
 *
dev
, **
´ev
,

1091 cÚ¡ *
fmt
, ...)

1093 
va_li¡
 
¬gs
;

1094 *
´_fže_Çme
 = 
NULL
, *
bkp
 = NULL;

1095 
fže_mode
, 
»s
 = -
EINVAL
;

1097 
	`sc¡_as£¹_´_mu‹x_h–d
(
dev
);

1099 
	`sBUG_ON
(!
fmt
);

1101 
»s
 = -
ENOMEM
;

1102 
	`va_¡¬t
(
¬gs
, 
fmt
);

1103 
´_fže_Çme
 = 
	`kva¥rštf
(
GFP_KERNEL
, 
fmt
, 
¬gs
);

1104 
	`va_’d
(
¬gs
);

1105 ià(!
´_fže_Çme
) {

1106 
	`PRINT_ERROR
("Unableo kvasprintf()‚ew PR file‚ame");

1107 
out
;

1110 
»s
 = -
EINVAL
;

1111 ià(
´_fže_Çme
[0] != '/') {

1112 
	`PRINT_ERROR
("PR fžÇm% mu¡ babsÞu‹!", 
´_fže_Çme
);

1113 
out
;

1116 
fže_mode
 = 
	`sc¡_g‘_fže_mode
(
´_fže_Çme
);

1117 ià(
fže_mode
 >ð0 && !
	`S_ISREG
(fže_modeè&& !
	`S_ISBLK
(file_mode)) {

1118 
	`PRINT_ERROR
("PR file‚ame %s must be file or block device!",

1119 
´_fže_Çme
);

1120 
out
;

1123 
»s
 = -
ENOENT
;

1124 ià(!
	`sc¡_·»Á_dœ_exi¡s
(
´_fže_Çme
)) {

1125 
	`PRINT_ERROR
("PR file‚ame %s…arent directory doesn'tƒxist",

1126 
´_fže_Çme
);

1127 
out
;

1130 
»s
 = -
ENOMEM
;

1131 
bkp
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%s.1", 
´_fže_Çme
);

1132 ià(!
bkp
) {

1133 
	`PRINT_ERROR
("Unableo kasprintf() backup PR file‚ame");

1134 
out
;

1136 ià(
´ev
) {

1137 *
´ev
 = 
dev
->
´_fže_Çme
;

1138 
dev
->
´_fže_Çme
 =…r_file_name;

1139 
´_fže_Çme
 = 
NULL
;

1141 
	`sw­
(
dev
->
´_fže_Çme
,…r_file_name);

1142 
	`sw­
(
dev
->
´_fže_Çme1
, 
bkp
);

1143 
»s
 = 0;

1145 
out
:

1146 
	`kä“
(
´_fže_Çme
);

1147 
	`kä“
(
bkp
);

1148  
»s
;

1149 
	}
}

1152 
	$sc¡_´_š™
(
sc¡_deviû
 *
dev
)

1154 
	`mu‹x_š™
(&
dev
->
dev_´_mu‹x
);

1155 
dev
->
þ_Ýs
 = &
sc¡_no_dlm_þ_Ýs
;

1156 
dev
->
´_g’”©iÚ
 = 0;

1157 
dev
->
´_is_£t
 = 0;

1158 
dev
->
´_hÞd”
 = 
NULL
;

1159 
dev
->
´_scÝe
 = 
SCOPE_LU
;

1160 
dev
->
´_ty³
 = 
TYPE_UNSPECIFIED
;

1161 
	`INIT_LIST_HEAD
(&
dev
->
dev_»gi¡¿Ás_li¡
);

1164 
	}
}

1167 
	$sc¡_´_þ—nup
(
sc¡_deviû
 *
dev
)

1169 
dev
->
þ_Ýs
->
	`´_þ—nup
(dev);

1170 
	}
}

1173 
	$sc¡_´_£t_þu¡”_mode
(
sc¡_deviû
 *
dev
, 
boÞ
 
þu¡”_mode
,

1174 cÚ¡ *
þ_dev_id
)

1176 
»s
 = 0;

1178 #ià
	`defšed
(
CONFIG_DLM
è|| defšed(
CONFIG_DLM_MODULE
) && \

1179 !
	`defšed
(
CONFIG_SCST_NO_DLM
)

1180 
boÞ
 
þu¡”_mode_’abËd
 = 
çl£
;

1182 
þu¡”_mode_’abËd
 = 
dev
->
þ_Ýs
 =ð&
sc¡_dlm_þ_Ýs
;

1184 ià(
þu¡”_mode_’abËd
 =ð
þu¡”_mode
)

1185 
out
;

1187 
	`PRINT_INFO
("%s: chªgšg clu¡”_modäom %d iÁØ%d", 
dev
->
vœt_Çme
,

1188 
þu¡”_mode_’abËd
, 
þu¡”_mode
);

1189 
dev
->
þ_Ýs
->
	`´_þ—nup
(dev);

1190 
dev
->
þ_Ýs
 = 
þu¡”_mode
 ? &
sc¡_dlm_þ_Ýs
 : &
sc¡_no_dlm_þ_Ýs
;

1191 
»s
 = 
dev
->
þ_Ýs
->
	`´_š™
(dev, 
þ_dev_id
);

1192 ià(
»s
) {

1193 
	`PRINT_ERROR
("%s: changing cluster_mode into %d failed: %d",

1194 
dev
->
vœt_Çme
, 
þu¡”_mode
, 
»s
);

1195 
dev
->
þ_Ýs
 = &
sc¡_no_dlm_þ_Ýs
;

1198 
out
:

1200 
»s
 = 
þu¡”_mode
 ? -
ENOTSUPP
 : 0;

1203  
»s
;

1204 
	}
}

1205 
EXPORT_SYMBOL
(
sc¡_´_£t_þu¡”_mode
);

1208 
	$sc¡_´_š™_dev
(
sc¡_deviû
 *
dev
)

1210 
»s
 = 0;

1212 
	`TRACE_ENTRY
();

1214 
	`sc¡_as£¹_´_mu‹x_h–d
(
dev
);

1216 
	`sBUG_ON
(!
dev
->
´_fže_Çme
 || !dev->
´_fže_Çme1
);

1218 #iâdeà
CONFIG_SCST_PROC


1219 
»s
 = 
	`sc¡_´_lßd_deviû_fže
(
dev
);

1220 ià(
»s
 =ð-
ENOENT
)

1221 
»s
 = 0;

1224 
	`TRACE_EXIT_RES
(
»s
);

1225  
»s
;

1226 
	}
}

1229 
	$sc¡_´_þ—r_dev
(
sc¡_deviû
 *
dev
)

1231 
	`TRACE_ENTRY
();

1233 
	`sc¡_´_»move_»gi¡¿Ás
(
dev
);

1235 
	`kä“
(
dev
->
´_fže_Çme
);

1236 
	`kä“
(
dev
->
´_fže_Çme1
);

1238 
	`TRACE_EXIT
();

1240 
	}
}

1243 
	$sc¡_´_š™_tgt_dev
(
sc¡_tgt_dev
 *
tgt_dev
)

1245 
»s
 = 0;

1246 
sc¡_dev_»gi¡¿Á
 *
»g
;

1247 
sc¡_deviû
 *
dev
 = 
tgt_dev
->dev;

1248 cÚ¡ 
ušt8_t
 *
Œª¥Üt_id
 = 
tgt_dev
->
£ss
->transport_id;

1249 cÚ¡ 
ušt16_t
 
»l_tgt_id
 = 
tgt_dev
->
£ss
->
tgt
->rel_tgt_id;

1251 
	`TRACE_ENTRY
();

1253 ià(
tgt_dev
->
£ss
->
Œª¥Üt_id
 =ð
NULL
)

1254 
out
;

1256 
	`sc¡_´_wr™e_lock
(
dev
);

1258 
»g
 = 
	`sc¡_´_fšd_»g
(
dev
, 
Œª¥Üt_id
, 
»l_tgt_id
);

1259 ià((
»g
 !ð
NULL
è&& (»g->
tgt_dev
 == NULL)) {

1260 
	`TRACE_PR
("Assigning„eg %s/%d (%p)ogt_dev %p (dev %s)",

1261 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
Œª¥Üt_id
),

1262 
»l_tgt_id
, 
»g
, 
tgt_dev
, 
dev
->
vœt_Çme
);

1263 
tgt_dev
->
»gi¡¿Á
 = 
»g
;

1264 
»g
->
tgt_dev
 =gt_dev;

1267 
	`sc¡_´_wr™e_uÆock
(
dev
);

1269 
out
:

1270 
	`TRACE_EXIT_RES
(
»s
);

1271  
»s
;

1272 
	}
}

1275 
	$sc¡_´_þ—r_tgt_dev
(
sc¡_tgt_dev
 *
tgt_dev
)

1277 
sc¡_deviû
 *
dev
 = 
tgt_dev
->dev;

1278 
sc¡_dev_»gi¡¿Á
 *
»g
;

1279 
sc¡_tgt_dev
 *
t
;

1281 
	`TRACE_ENTRY
();

1283 
	`sc¡_´_wr™e_lock
(
dev
);

1285 
»g
 = 
tgt_dev
->
»gi¡¿Á
;

1286 ià(
»g
) {

1287 
tgt_dev
->
»gi¡¿Á
 = 
NULL
;

1288 
»g
->
tgt_dev
 = 
NULL
;

1291 
	`li¡_fÜ_—ch_’Œy
(
t
, &
dev
->
dev_tgt_dev_li¡
,

1292 
dev_tgt_dev_li¡_’Œy
) {

1293 ià(
t
 =ð
tgt_dev
)

1295 ià((
t
->
£ss
->
tgt
->
»l_tgt_id
 =ð
»g
->rel_tgt_id) &&

1296 
	`tid_equ®
(
t
->
£ss
->
Œª¥Üt_id
, 
»g
->transport_id)) {

1297 
	`TRACE_PR
("Reassigning„eg %s/%d (%p)ogt_dev "

1299 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(

1300 
»g
->
Œª¥Üt_id
),

1301 
»g
->
»l_tgt_id
,„eg, 
t
, 
tgt_dev
);

1302 
t
->
»gi¡¿Á
 = 
»g
;

1303 
»g
->
tgt_dev
 = 
t
;

1309 
	`sc¡_´_wr™e_uÆock
(
dev
);

1311 
	`TRACE_EXIT
();

1313 
	}
}

1316 
	$sc¡_´_»gi¡”_w™h_¥ec_i_±
(
sc¡_cmd
 *
cmd
,

1317 cÚ¡ 
ušt16_t
 
»l_tgt_id
, 
ušt8_t
 *
bufãr
, 
bufãr_size
,

1318 
li¡_h—d
 *
rÞlback_li¡
)

1320 
»s
 = 0;

1321 
off£t
;

1322 
ext_size
;

1323 
__be64
 
aùiÚ_key
;

1324 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

1325 
sc¡_dev_»gi¡¿Á
 *
»g
;

1326 
ušt8_t
 *
Œª¥Üt_id
;

1328 
	`sc¡_as£¹_´_mu‹x_h–d
(
cmd
->
dev
);

1330 
aùiÚ_key
 = 
	`g‘_uÇligÃd
((
__be64
 *)&
bufãr
[8]);

1332 
ext_size
 = 
	`g‘_uÇligÃd_be32
(&
bufãr
[24]);

1333 ià((
ext_size
 + 28è> 
bufãr_size
) {

1334 
	`TRACE_PR
("Inv®id bufã¸siz%d (max %d)", 
bufãr_size
,

1335 
ext_size
 + 28);

1336 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1337 
	`SCST_LOAD_SENSE
(
sc¡_£n£_·¿m‘”_li¡_Ëngth_šv®id
));

1338 
»s
 = -
EINVAL
;

1339 
out
;

1342 
off£t
 = 0;

1343 
off£t
 < 
ext_size
) {

1344 
Œª¥Üt_id
 = &
bufãr
[28 + 
off£t
];

1346 ià((
off£t
 + 
	`sc¡_tid_size
(
Œª¥Üt_id
)è> 
ext_size
) {

1347 
	`TRACE_PR
("Invalidransport_id size %d (max %d)",

1348 
	`sc¡_tid_size
(
Œª¥Üt_id
), 
ext_size
 - 
off£t
);

1349 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 24, 0);

1350 
»s
 = -
EINVAL
;

1351 
out
;

1353 
	`tid_£cu»
(
Œª¥Üt_id
);

1354 
off£t
 +ð
	`sc¡_tid_size
(
Œª¥Üt_id
);

1357 
off£t
 = 0;

1358 
off£t
 < 
ext_size
) {

1359 
sc¡_tgt_dev
 *
t
;

1361 
Œª¥Üt_id
 = &
bufãr
[28 + 
off£t
];

1363 
	`TRACE_PR
("»l_tgt_id %d,¿n¥Üt_id %s", 
»l_tgt_id
,

1364 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
Œª¥Üt_id
));

1366 ià((
Œª¥Üt_id
[0] & 0x0fè=ð
SCSI_TRANSPORTID_PROTOCOLID_ISCSI
 &&

1367 (
Œª¥Üt_id
[0] & 0xc0) == 0) {

1368 
	`TRACE_PR
("Wildcard iSCSI TransportID %s",

1369 &
Œª¥Üt_id
[4]);

1374 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

1375 
	`li¡_fÜ_—ch_’Œy
(
t
, &
dev
->
dev_tgt_dev_li¡
,

1376 
dev_tgt_dev_li¡_’Œy
) {

1381 ià(!
	`tid_equ®
(
t
->
£ss
->
Œª¥Üt_id
,

1382 
Œª¥Üt_id
))

1385 
»g
 = 
	`sc¡_´_fšd_»g
(
dev
,

1386 
t
->
£ss
->
Œª¥Üt_id
, 
»l_tgt_id
);

1387 ià(
»g
 =ð
NULL
) {

1388 
»g
 = 
	`sc¡_´_add_»gi¡¿Á
(
dev
,

1389 
t
->
£ss
->
Œª¥Üt_id
,

1390 
»l_tgt_id
, 
aùiÚ_key
, 
Œue
);

1391 ià(
»g
 =ð
NULL
) {

1392 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

1393 
	`sc¡_£t_busy
(
cmd
);

1394 
»s
 = -
ENOMEM
;

1395 
out
;

1397 } ià(
»g
->
key
 !ð
aùiÚ_key
) {

1398 
	`TRACE_PR
("Changing key of„eg %p "

1399 "Ñgt_dev %p)", 
»g
, 
t
);

1400 
»g
->
rÞlback_key
 =„eg->
key
;

1401 
»g
->
key
 = 
aùiÚ_key
;

1405 
	`li¡_add_ž
(&
»g
->
aux_li¡_’Œy
,

1406 
rÞlback_li¡
);

1408 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

1410 
»g
 = 
	`sc¡_´_fšd_»g
(
dev
, 
Œª¥Üt_id
, 
»l_tgt_id
);

1411 ià(
»g
 !ð
NULL
) {

1412 ià(
»g
->
key
 =ð
aùiÚ_key
)

1413 
Ãxt
;

1414 
	`TRACE_PR
("Changing key of„eg %p (tgt_dev %p)",

1415 
»g
,„eg->
tgt_dev
);

1416 
»g
->
rÞlback_key
 =„eg->
key
;

1417 
»g
->
key
 = 
aùiÚ_key
;

1419 
»g
 = 
	`sc¡_´_add_»gi¡¿Á
(
dev
, 
Œª¥Üt_id
,

1420 
»l_tgt_id
, 
aùiÚ_key
, 
çl£
);

1421 ià(
»g
 =ð
NULL
) {

1422 
	`sc¡_£t_busy
(
cmd
);

1423 
»s
 = -
ENOMEM
;

1424 
out
;

1428 
	`li¡_add_ž
(&
»g
->
aux_li¡_’Œy
,

1429 
rÞlback_li¡
);

1431 
Ãxt
:

1432 
off£t
 +ð
	`sc¡_tid_size
(
Œª¥Üt_id
);

1434 
out
:

1435  
»s
;

1436 
	}
}

1439 
	$sc¡_´_uÄegi¡”
(
sc¡_deviû
 *
dev
,

1440 
sc¡_dev_»gi¡¿Á
 *
»g
)

1442 
boÞ
 
is_hÞd”
;

1443 
ušt8_t
 
´_ty³
;

1445 
	`TRACE_ENTRY
();

1447 
	`sc¡_as£¹_´_mu‹x_h–d
(
dev
);

1449 
	`TRACE_PR
("UÄegi¡”šg key %0Îx", 
»g
->
key
);

1451 
is_hÞd”
 = 
	`sc¡_´_is_hÞd”
(
dev
, 
»g
);

1452 
´_ty³
 = 
dev
->pr_type;

1454 
	`sc¡_´_»move_»gi¡¿Á
(
dev
, 
»g
);

1456 ià(
is_hÞd”
 && !
dev
->
´_is_£t
) {

1458 
´_ty³
) {

1459 
TYPE_WRITE_EXCLUSIVE_REGONLY
:

1460 
TYPE_EXCLUSIVE_ACCESS_REGONLY
:

1461 
	`sc¡_´_£nd_ua_®l
(
dev
, 
NULL
,

1462 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»£rv©iÚ_»Ëa£d
));

1467 
	`TRACE_EXIT
();

1469 
	}
}

1472 
	$sc¡_´_uÄegi¡”_®l_tg_±
(
sc¡_deviû
 *
dev
,

1473 cÚ¡ 
ušt8_t
 *
Œª¥Üt_id
)

1475 
sc¡_tgt_‹m¶©e
 *
tg‰
;

1476 
ušt8_t
 
´Ùo_id
 = 
Œª¥Üt_id
[0] & 0x0f;

1478 
	`TRACE_ENTRY
();

1480 
	`sc¡_as£¹_´_mu‹x_h–d
(
dev
);

1486 
	`mu‹x_lock
(&
sc¡_mu‹x2
);

1488 
	`li¡_fÜ_—ch_’Œy
(
tg‰
, &
sc¡_‹m¶©e_li¡
, 
sc¡_‹m¶©e_li¡_’Œy
) {

1489 
sc¡_tgt
 *
tgt
;

1491 ià(
tg‰
->
g‘_š™ŸtÜ_pÜt_Œª¥Üt_id
 =ð
NULL
)

1494 
	`li¡_fÜ_—ch_’Œy
(
tgt
, &
tg‰
->
tgt_li¡
, 
tgt_li¡_’Œy
) {

1495 
sc¡_dev_»gi¡¿Á
 *
»g
;

1497 ià(
tg‰
->
	`g‘_š™ŸtÜ_pÜt_Œª¥Üt_id
(
tgt
, 
NULL
, NULLè!ð
´Ùo_id
)

1500 
»g
 = 
	`sc¡_´_fšd_»g
(
dev
, 
Œª¥Üt_id
,

1501 
tgt
->
»l_tgt_id
);

1502 ià(
»g
 =ð
NULL
)

1505 
	`sc¡_´_uÄegi¡”
(
dev
, 
»g
);

1509 
	`mu‹x_uÆock
(&
sc¡_mu‹x2
);

1511 
	`TRACE_EXIT
();

1513 
	}
}

1516 
	$sc¡_´_»gi¡”_Ú_tgt_id
(
sc¡_cmd
 *
cmd
,

1517 cÚ¡ 
ušt16_t
 
»l_tgt_id
, 
ušt8_t
 *
bufãr
, 
bufãr_size
,

1518 
boÞ
 
¥ec_i_±
, 
li¡_h—d
 *
rÞlback_li¡
)

1520 
»s
;

1522 
	`TRACE_ENTRY
();

1524 
	`sc¡_as£¹_´_mu‹x_h–d
(
cmd
->
dev
);

1526 
	`TRACE_PR
("»l_tgt_id %d, s³c_i_± %d", 
»l_tgt_id
, 
¥ec_i_±
);

1528 ià(
¥ec_i_±
) {

1529 
»s
 = 
	`sc¡_´_»gi¡”_w™h_¥ec_i_±
(
cmd
, 
»l_tgt_id
, 
bufãr
,

1530 
bufãr_size
, 
rÞlback_li¡
);

1531 ià(
»s
 != 0)

1532 
out
;

1537 ià(
	`sc¡_´_fšd_»g
(
cmd
->
dev
, cmd->
£ss
->
Œª¥Üt_id
, 
»l_tgt_id
è=ð
NULL
) {

1538 
__be64
 
aùiÚ_key
;

1539 
sc¡_dev_»gi¡¿Á
 *
»g
;

1541 
aùiÚ_key
 = 
	`g‘_uÇligÃd
((
__be64
 *)&
bufãr
[8]);

1543 
»g
 = 
	`sc¡_´_add_»gi¡¿Á
(
cmd
->
dev
, cmd->
£ss
->
Œª¥Üt_id
,

1544 
»l_tgt_id
, 
aùiÚ_key
, 
çl£
);

1545 ià(
»g
 =ð
NULL
) {

1546 
»s
 = -
ENOMEM
;

1547 
	`sc¡_£t_busy
(
cmd
);

1548 
out
;

1551 
	`li¡_add_ž
(&
»g
->
aux_li¡_’Œy
, 
rÞlback_li¡
);

1554 
»s
 = 0;

1556 
out
:

1557 
	`TRACE_EXIT_RES
(
»s
);

1558  
»s
;

1559 
	}
}

1562 
	$sc¡_´_»gi¡”_®l_tg_±
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
,

1563 
bufãr_size
, 
boÞ
 
¥ec_i_±
, 
li¡_h—d
 *
rÞlback_li¡
)

1565 
»s
 = 0;

1566 
sc¡_tgt_‹m¶©e
 *
tg‰
;

1567 
ušt8_t
 
´Ùo_id
 = 
cmd
->
£ss
->
Œª¥Üt_id
[0] & 0x0f;

1569 
	`TRACE_ENTRY
();

1571 
	`sc¡_as£¹_´_mu‹x_h–d
(
cmd
->
dev
);

1577 
	`mu‹x_lock
(&
sc¡_mu‹x2
);

1579 
	`li¡_fÜ_—ch_’Œy
(
tg‰
, &
sc¡_‹m¶©e_li¡
, 
sc¡_‹m¶©e_li¡_’Œy
) {

1580 
sc¡_tgt
 *
tgt
;

1582 ià(
tg‰
->
g‘_š™ŸtÜ_pÜt_Œª¥Üt_id
 =ð
NULL
)

1585 
	`TRACE_PR
("tg‰ %s, s³c_i_± %d", 
tg‰
->
Çme
, 
¥ec_i_±
);

1587 
	`li¡_fÜ_—ch_’Œy
(
tgt
, &
tg‰
->
tgt_li¡
, 
tgt_li¡_’Œy
) {

1588 ià(
tg‰
->
	`g‘_š™ŸtÜ_pÜt_Œª¥Üt_id
(
tgt
, 
NULL
, NULLè!ð
´Ùo_id
)

1590 ià(
tgt
->
»l_tgt_id
 == 0)

1592 ià(
tgt
->
tgt_fÜw¬dšg
) {

1593 
	`TRACE_PR
("ALL_TG_PT: skipping forwarding "

1594 "rg‘ %s", 
tgt
->
tgt_Çme
);

1597 
	`TRACE_PR
("tgˆ%s,„–_tgt_id %d", 
tgt
->
tgt_Çme
,

1598 
tgt
->
»l_tgt_id
);

1599 
»s
 = 
	`sc¡_´_»gi¡”_Ú_tgt_id
(
cmd
, 
tgt
->
»l_tgt_id
,

1600 
bufãr
, 
bufãr_size
, 
¥ec_i_±
, 
rÞlback_li¡
);

1601 ià(
»s
 != 0)

1602 
out_uÆock
;

1606 
out_uÆock
:

1607 
	`mu‹x_uÆock
(&
sc¡_mu‹x2
);

1609 
	`TRACE_EXIT_RES
(
»s
);

1610  
»s
;

1611 
	}
}

1614 
	$__sc¡_´_»gi¡”
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
,

1615 
bufãr_size
, 
boÞ
 
¥ec_i_±
, boÞ 
®l_tg_±
)

1617 
»s
;

1618 
sc¡_dev_»gi¡¿Á
 *
»g
, *
Œeg
;

1619 
	`LIST_HEAD
(
rÞlback_li¡
);

1621 
	`TRACE_ENTRY
();

1623 
	`sc¡_as£¹_´_mu‹x_h–d
(
cmd
->
dev
);

1625 ià(
®l_tg_±
) {

1626 
»s
 = 
	`sc¡_´_»gi¡”_®l_tg_±
(
cmd
, 
bufãr
, 
bufãr_size
,

1627 
¥ec_i_±
, &
rÞlback_li¡
);

1628 ià(
»s
 != 0)

1629 
out_rÞlback
;

1631 
»s
 = 
	`sc¡_´_»gi¡”_Ú_tgt_id
(
cmd
,

1632 
cmd
->
£ss
->
tgt
->
»l_tgt_id
, 
bufãr
, 
bufãr_size
,

1633 
¥ec_i_±
, &
rÞlback_li¡
);

1634 ià(
»s
 != 0)

1635 
out_rÞlback
;

1638 
	`li¡_fÜ_—ch_’Œy
(
»g
, &
rÞlback_li¡
, 
aux_li¡_’Œy
) {

1639 
»g
->
rÞlback_key
 = 0;

1642 
out
:

1643 
	`TRACE_EXIT_RES
(
»s
);

1644  
»s
;

1646 
out_rÞlback
:

1647 
	`li¡_fÜ_—ch_’Œy_§ã
(
»g
, 
Œeg
, &
rÞlback_li¡
, 
aux_li¡_’Œy
) {

1648 
	`li¡_d–
(&
»g
->
aux_li¡_’Œy
);

1649 ià(
»g
->
rÞlback_key
 == 0)

1650 
	`sc¡_´_»move_»gi¡¿Á
(
cmd
->
dev
, 
»g
);

1652 
»g
->
key
 =„eg->
rÞlback_key
;

1653 
»g
->
rÞlback_key
 = 0;

1656 
out
;

1657 
	}
}

1660 
	$sc¡_´_»gi¡”
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
, 
bufãr_size
)

1662 
­l
, 
¥ec_i_±
, 
®l_tg_±
;

1663 
__be64
 
key
, 
aùiÚ_key
;

1664 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

1665 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

1666 
sc¡_£ssiÚ
 *
£ss
 = 
cmd
->sess;

1667 
sc¡_dev_»gi¡¿Á
 *
»g
;

1669 
	`TRACE_ENTRY
();

1671 
	`sc¡_as£¹_´_mu‹x_h–d
(
cmd
->
dev
);

1673 
­l
 = 
bufãr
[20] & 0x01;

1674 
¥ec_i_±
 = (
bufãr
[20] >> 3) & 0x01;

1675 
®l_tg_±
 = (
bufãr
[20] >> 2) & 0x01;

1676 
key
 = 
	`g‘_uÇligÃd
((
__be64
 *)&
bufãr
[0]);

1677 
aùiÚ_key
 = 
	`g‘_uÇligÃd
((
__be64
 *)&
bufãr
[8]);

1679 ià(
¥ec_i_±
 =ð0 && 
bufãr_size
 != 24) {

1680 
	`TRACE_PR
("Inv®id bufã¸siz%d", 
bufãr_size
);

1681 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1682 
	`SCST_LOAD_SENSE
(
sc¡_£n£_·¿m‘”_li¡_Ëngth_šv®id
));

1683 
out
;

1686 #ifdeà
CONFIG_SCST_PROC


1687 ià(
­l
) {

1688 
	`TRACE_PR
("%s", "APTPL‚ot supported");

1689 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 20,

1690 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 0);

1691 
out
;

1695 
»g
 = 
tgt_dev
->
»gi¡¿Á
;

1697 
	`TRACE_PR
("Register: initiator %s/%d (%p), key %0llx,‡ction_key %0llx "

1699 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
£ss
->
Œª¥Üt_id
),

1700 
£ss
->
tgt
->
»l_tgt_id
, 
»g
, 
	`be64_to_ýu
(
key
),

1701 
	`be64_to_ýu
(
aùiÚ_key
), 
tgt_dev
);

1703 ià(
»g
 =ð
NULL
) {

1704 
	`TRACE_PR
("tgt_dev %p is‚ot„egistered yet -„egistering",

1705 
tgt_dev
);

1706 ià(
key
) {

1707 
	`TRACE_PR
("%s", "Key must be zero on‚ew„egistration");

1708 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_RESERVATION_CONFLICT
);

1709 
out
;

1711 ià(
aùiÚ_key
) {

1712 
rc
 = 
	`__sc¡_´_»gi¡”
(
cmd
, 
bufãr
, 
bufãr_size
,

1713 
¥ec_i_±
, 
®l_tg_±
);

1714 ià(
rc
 != 0)

1715 
out
;

1717 
	`TRACE_PR
("%s", "Doing‚othing -‡ction_key is zero");

1719 ià(
»g
->
key
 != key) {

1720 
	`TRACE_PR
("tgt_dev %p‡lready„egistered -„eservation "

1721 "key %0Îx mism©ch", 
tgt_dev
,

1722 
	`be64_to_ýu
(
»g
->
key
));

1723 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
,

1724 
SAM_STAT_RESERVATION_CONFLICT
);

1725 
out
;

1727 ià(
¥ec_i_±
) {

1728 
	`TRACE_PR
("%s", "spec_i_pt must be zero inhis case");

1729 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 20,

1730 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 3);

1731 
out
;

1733 ià(
aùiÚ_key
 == 0) {

1734 ià(
®l_tg_±
)

1735 
	`sc¡_´_uÄegi¡”_®l_tg_±
(
dev
,

1736 
£ss
->
Œª¥Üt_id
);

1738 
	`sc¡_´_uÄegi¡”
(
dev
, 
»g
);

1740 
»g
->
key
 = 
aùiÚ_key
;

1743 
dev
->
´_g’”©iÚ
++;

1745 
dev
->
´_­l
 = 
­l
;

1747 
	`sc¡_´_dump_´s
(
dev
, 
çl£
);

1749 
out
:

1750 
	`TRACE_EXIT
();

1752 
	}
}

1755 
	$sc¡_´_»gi¡”_ªd_ignÜe
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
,

1756 
bufãr_size
)

1758 
­l
, 
®l_tg_±
;

1759 
__be64
 
aùiÚ_key
;

1760 
sc¡_dev_»gi¡¿Á
 *
»g
 = 
NULL
;

1761 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

1762 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

1763 
sc¡_£ssiÚ
 *
£ss
 = 
cmd
->sess;

1765 
	`TRACE_ENTRY
();

1767 
	`sc¡_as£¹_´_mu‹x_h–d
(
cmd
->
dev
);

1769 
­l
 = 
bufãr
[20] & 0x01;

1770 
®l_tg_±
 = (
bufãr
[20] >> 2) & 0x01;

1771 
aùiÚ_key
 = 
	`g‘_uÇligÃd
((
__be64
 *)&
bufãr
[8]);

1773 ià(
bufãr_size
 != 24) {

1774 
	`TRACE_PR
("Inv®id bufã¸siz%d", 
bufãr_size
);

1775 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1776 
	`SCST_LOAD_SENSE
(
sc¡_£n£_·¿m‘”_li¡_Ëngth_šv®id
));

1777 
out
;

1780 #ifdeà
CONFIG_SCST_PROC


1781 ià(
­l
) {

1782 
	`TRACE_PR
("%s", "APTPL‚ot supported");

1783 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 20,

1784 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 0);

1785 
out
;

1789 
»g
 = 
tgt_dev
->
»gi¡¿Á
;

1791 
	`TRACE_PR
("Register‡nd ignore: initiator %s/%d (%p),‡ction_key "

1793 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
£ss
->
Œª¥Üt_id
),

1794 
£ss
->
tgt
->
»l_tgt_id
, 
»g
, 
	`be64_to_ýu
(
aùiÚ_key
),

1795 
tgt_dev
);

1797 ià(
»g
 =ð
NULL
) {

1798 
	`TRACE_PR
("Tgt_dev %p is‚ot„egistered yet -ryingo "

1799 "»gi¡”", 
tgt_dev
);

1800 ià(
aùiÚ_key
) {

1801 
rc
 = 
	`__sc¡_´_»gi¡”
(
cmd
, 
bufãr
, 
bufãr_size
,

1802 
çl£
, 
®l_tg_±
);

1803 ià(
rc
 != 0)

1804 
out
;

1806 
	`TRACE_PR
("%s", "Doing‚othing,‡ction_key is zero");

1808 ià(
aùiÚ_key
 == 0) {

1809 ià(
®l_tg_±
)

1810 
	`sc¡_´_uÄegi¡”_®l_tg_±
(
dev
,

1811 
£ss
->
Œª¥Üt_id
);

1813 
	`sc¡_´_uÄegi¡”
(
dev
, 
»g
);

1815 
»g
->
key
 = 
aùiÚ_key
;

1818 
dev
->
´_g’”©iÚ
++;

1820 
dev
->
´_­l
 = 
­l
;

1822 
	`sc¡_´_dump_´s
(
dev
, 
çl£
);

1824 
out
:

1825 
	`TRACE_EXIT
();

1827 
	}
}

1830 
	$sc¡_´_»gi¡”_ªd_move
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
,

1831 
bufãr_size
)

1833 
­l
;

1834 
uÄeg
;

1835 
tid_bufãr_size
;

1836 
__be64
 
key
, 
aùiÚ_key
;

1837 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

1838 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

1839 
sc¡_£ssiÚ
 *
£ss
 = 
cmd
->sess;

1840 
sc¡_dev_»gi¡¿Á
 *
»g
, *
»g_move
;

1841 cÚ¡ 
ušt8_t
 *
Œª¥Üt_id
 = 
NULL
;

1842 
ušt8_t
 *
Œª¥Üt_id_move
 = 
NULL
;

1843 
ušt16_t
 
»l_tgt_id_move
;

1845 
	`TRACE_ENTRY
();

1847 
	`sc¡_as£¹_´_mu‹x_h–d
(
cmd
->
dev
);

1849 
­l
 = 
bufãr
[17] & 0x01;

1850 
key
 = 
	`g‘_uÇligÃd
((
__be64
 *)&
bufãr
[0]);

1851 
aùiÚ_key
 = 
	`g‘_uÇligÃd
((
__be64
 *)&
bufãr
[8]);

1852 
uÄeg
 = (
bufãr
[17] >> 1) & 0x01;

1853 
tid_bufãr_size
 = 
	`g‘_uÇligÃd_be32
(&
bufãr
[20]);

1855 #ifdeà
CONFIG_SCST_PROC


1856 ià(
­l
) {

1857 
	`TRACE_PR
("%s", "APTPL‚ot supported");

1858 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 17,

1859 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 0);

1860 
out
;

1864 ià((
tid_bufãr_size
 + 24è> 
bufãr_size
) {

1865 
	`TRACE_PR
("Invalid buffer size %d (%d)",

1866 
bufãr_size
, 
tid_bufãr_size
 + 24);

1867 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1868 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_·rm_li¡
));

1869 
out
;

1872 ià(
tid_bufãr_size
 < 24) {

1873 
	`TRACE_PR
("%s", "Transport id bufferoo small");

1874 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 20, 0);

1875 
out
;

1878 
»g
 = 
tgt_dev
->
»gi¡¿Á
;

1880 ià(
»g
->
key
 != key) {

1881 
	`TRACE_PR
("Registrant's %s/%d (%p) key %016llx mismatch with "

1883 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
»g
->
Œª¥Üt_id
),

1884 
»g
->
»l_tgt_id
,„eg, 
	`be64_to_ýu
Ôeg->
key
),

1885 
	`be64_to_ýu
(
key
), 
tgt_dev
);

1886 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_RESERVATION_CONFLICT
);

1887 
out
;

1890 ià(!
dev
->
´_is_£t
) {

1891 
	`TRACE_PR
("%s", "There must be‡ PR");

1892 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1893 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

1894 
out
;

1901 ià(!
	`sc¡_´_is_hÞd”
(
dev
, 
»g
)) {

1902 
	`TRACE_PR
("Registrant %s/%d (%p) is‚ot‡ holder (tgt_dev %p)",

1903 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
»g
->
Œª¥Üt_id
),

1904 
»g
->
»l_tgt_id
,„eg, 
tgt_dev
);

1905 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_RESERVATION_CONFLICT
);

1906 
out
;

1909 ià(
aùiÚ_key
 == 0) {

1910 
	`TRACE_PR
("%s", "Action key must be‚on-zero");

1911 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 8, 0);

1912 
out
;

1915 
Œª¥Üt_id
 = 
£ss
->transport_id;

1916 
Œª¥Üt_id_move
 = (
ušt8_t
 *)&
bufãr
[24];

1917 
»l_tgt_id_move
 = 
	`g‘_uÇligÃd_be16
(&
bufãr
[18]);

1919 ià((
	`sc¡_tid_size
(
Œª¥Üt_id_move
è+ 24è> 
bufãr_size
) {

1920 
	`TRACE_PR
("Invalid buffer size %d (%d)",

1921 
bufãr_size
, 
	`sc¡_tid_size
(
Œª¥Üt_id_move
) + 24);

1922 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1923 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_·rm_li¡
));

1924 
out
;

1927 
	`tid_£cu»
(
Œª¥Üt_id_move
);

1929 ià(
dev
->
´_ty³
 =ð
TYPE_WRITE_EXCLUSIVE_ALL_REG
 ||

1930 
dev
->
´_ty³
 =ð
TYPE_EXCLUSIVE_ACCESS_ALL_REG
) {

1931 
	`TRACE_PR
("Unableo finish operation dueo wrong„eservation "

1932 "ty³ %02x", 
dev
->
´_ty³
);

1933 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_RESERVATION_CONFLICT
);

1934 
out
;

1937 ià(
	`tid_equ®
(
Œª¥Üt_id
, 
Œª¥Üt_id_move
)) {

1938 
	`TRACE_PR
("%s", "Equalransport id's");

1939 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 24, 0);

1940 
out
;

1943 
»g_move
 = 
	`sc¡_´_fšd_»g
(
dev
, 
Œª¥Üt_id_move
, 
»l_tgt_id_move
);

1944 ià(
»g_move
 =ð
NULL
) {

1945 
»g_move
 = 
	`sc¡_´_add_»gi¡¿Á
(
dev
, 
Œª¥Üt_id_move
,

1946 
»l_tgt_id_move
, 
aùiÚ_key
, 
çl£
);

1947 ià(
»g_move
 =ð
NULL
) {

1948 
	`sc¡_£t_busy
(
cmd
);

1949 
out
;

1951 } ià(
»g_move
->
key
 !ð
aùiÚ_key
) {

1952 
	`TRACE_PR
("Chªgšg key fÜ„eg %p", 
»g
);

1953 
»g_move
->
key
 = 
aùiÚ_key
;

1956 
	`TRACE_PR
("Register‡nd move: from initiator %s/%d (%p,gt_dev %p)o "

1958 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
»g
->
Œª¥Üt_id
),

1959 
»g
->
»l_tgt_id
,„eg,„eg->
tgt_dev
,

1960 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
Œª¥Üt_id_move
),

1961 
»l_tgt_id_move
, 
»g_move
,„eg_move->
tgt_dev
,

1962 
	`be64_to_ýu
(
aùiÚ_key
), 
uÄeg
);

1965 
	`sc¡_´_£t_hÞd”
(
dev
, 
»g_move
, dev->
´_scÝe
, dev->
´_ty³
);

1967 ià(
uÄeg
)

1968 
	`sc¡_´_»move_»gi¡¿Á
(
dev
, 
»g
);

1970 
dev
->
´_g’”©iÚ
++;

1972 
dev
->
´_­l
 = 
­l
;

1974 
	`sc¡_´_dump_´s
(
dev
, 
çl£
);

1976 
out
:

1977 
	`TRACE_EXIT
();

1979 
	}
}

1982 
	$sc¡_´_»£rve
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
, 
bufãr_size
)

1984 
ušt8_t
 
scÝe
, 
ty³
;

1985 
__be64
 
key
;

1986 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

1987 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

1988 
sc¡_dev_»gi¡¿Á
 *
»g
;

1990 
	`TRACE_ENTRY
();

1992 
	`sc¡_as£¹_´_mu‹x_h–d
(
dev
);

1994 
key
 = 
	`g‘_uÇligÃd
((
__be64
 *)&
bufãr
[0]);

1995 
scÝe
 = 
cmd
->
cdb
[2] >> 4;

1996 
ty³
 = 
cmd
->
cdb
[2] & 0x0f;

1998 ià(
bufãr_size
 != 24) {

1999 
	`TRACE_PR
("Inv®id bufã¸siz%d", 
bufãr_size
);

2000 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2001 
	`SCST_LOAD_SENSE
(
sc¡_£n£_·¿m‘”_li¡_Ëngth_šv®id
));

2002 
out
;

2005 ià(!
	`sc¡_´_ty³_v®id
(
ty³
)) {

2006 
	`TRACE_PR
("Inv®id„e£rv©iÚy³ %d", 
ty³
);

2007 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 2,

2008 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 0);

2009 
out
;

2012 ià(
scÝe
 !ð
SCOPE_LU
) {

2013 
	`TRACE_PR
("Inv®id„e£rv©iÚ scÝ%d", 
scÝe
);

2014 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 2,

2015 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 4);

2016 
out
;

2019 
»g
 = 
tgt_dev
->
»gi¡¿Á
;

2021 
	`TRACE_PR
("Reserve: initiator %s/%d (%p), key %016llx, scope %d, "

2023 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
cmd
->
£ss
->
Œª¥Üt_id
),

2024 
cmd
->
£ss
->
tgt
->
»l_tgt_id
, 
»g
, 
	`be64_to_ýu
(
key
), 
scÝe
,

2025 
ty³
, 
tgt_dev
);

2028 ià(
»g
->
key
 != key) {

2029 
	`TRACE_PR
("Registrant's %p key %016llx mismatch with %016llx",

2030 
»g
, 
	`be64_to_ýu
Ôeg->
key
), be64_to_cpu(key));

2031 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_RESERVATION_CONFLICT
);

2032 
out
;

2035 ià(!
dev
->
´_is_£t
)

2036 
	`sc¡_´_£t_hÞd”
(
dev
, 
»g
, 
scÝe
, 
ty³
);

2038 ià(!
	`sc¡_´_is_hÞd”
(
dev
, 
»g
)) {

2044 
	`TRACE_PR
("Only holder can override -„eg %p is‚ot‡ "

2045 "hÞd”", 
»g
);

2046 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
,

2047 
SAM_STAT_RESERVATION_CONFLICT
);

2048 
out
;

2050 ià(
dev
->
´_scÝe
 !ð
scÝe
 || dev->
´_ty³
 !ð
ty³
) {

2051 
	`TRACE_PR
("Error overriding scope orype for "

2052 "»g %p", 
»g
);

2053 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
,

2054 
SAM_STAT_RESERVATION_CONFLICT
);

2055 
out
;

2057 
	`TRACE_PR
("Do‚othing:„eservation of„eg %p "

2058 "i th§me", 
»g
);

2062 
	`sc¡_´_dump_´s
(
dev
, 
çl£
);

2064 
out
:

2065 
	`TRACE_EXIT
();

2067 
	}
}

2070 
	$sc¡_´_»Ëa£
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
, 
bufãr_size
)

2072 
scÝe
, 
ty³
;

2073 
__be64
 
key
;

2074 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

2075 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

2076 
sc¡_dev_»gi¡¿Á
 *
»g
;

2077 
ušt8_t
 
cur_´_ty³
;

2079 
	`TRACE_ENTRY
();

2081 
	`sc¡_as£¹_´_mu‹x_h–d
(
dev
);

2083 
key
 = 
	`g‘_uÇligÃd
((
__be64
 *)&
bufãr
[0]);

2084 
scÝe
 = 
cmd
->
cdb
[2] >> 4;

2085 
ty³
 = 
cmd
->
cdb
[2] & 0x0f;

2087 ià(
bufãr_size
 != 24) {

2088 
	`TRACE_PR
("Inv®id bufã¸siz%d", 
bufãr_size
);

2089 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2090 
	`SCST_LOAD_SENSE
(
sc¡_£n£_·¿m‘”_li¡_Ëngth_šv®id
));

2091 
out
;

2094 ià(!
dev
->
´_is_£t
) {

2095 
	`TRACE_PR
("%s", "There is‚o PR - do‚othing");

2096 
out
;

2099 
»g
 = 
tgt_dev
->
»gi¡¿Á
;

2101 
	`TRACE_PR
("Release: initiator %s/%d (%p), key %016llx, scope %d,ype "

2102 "%d (tgt_dev %p)", 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(

2103 
cmd
->
£ss
->
Œª¥Üt_id
),

2104 
cmd
->
£ss
->
tgt
->
»l_tgt_id
, 
»g
, 
	`be64_to_ýu
(
key
), 
scÝe
,

2105 
ty³
, 
tgt_dev
);

2108 ià(
»g
->
key
 != key) {

2109 
	`TRACE_PR
("Registrant's %p key %016llx mismatch with %016llx",

2110 
»g
, 
	`be64_to_ýu
Ôeg->
key
), be64_to_cpu(key));

2111 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_RESERVATION_CONFLICT
);

2112 
out
;

2115 ià(!
	`sc¡_´_is_hÞd”
(
dev
, 
»g
)) {

2116 
	`TRACE_PR
("Regi¡¿Á %°i nÙ‡ hÞd” - dØnÙhšg", 
»g
);

2117 
out
;

2120 ià(
dev
->
´_scÝe
 !ð
scÝe
 || dev->
´_ty³
 !ð
ty³
) {

2121 
	`TRACE_PR
("%s", "Released scope orype do‚ot match with "

2123 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2124 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_»Ëa£
));

2125 
out
;

2128 
cur_´_ty³
 = 
dev
->
´_ty³
;

2130 
	`sc¡_´_þ—r_»£rv©iÚ
(
dev
);

2132 
cur_´_ty³
) {

2133 
TYPE_WRITE_EXCLUSIVE_REGONLY
:

2134 
TYPE_EXCLUSIVE_ACCESS_REGONLY
:

2135 
TYPE_WRITE_EXCLUSIVE_ALL_REG
:

2136 
TYPE_EXCLUSIVE_ACCESS_ALL_REG
:

2137 
	`sc¡_´_£nd_ua_®l
(
dev
, 
»g
,

2138 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»£rv©iÚ_»Ëa£d
));

2141 
	`sc¡_´_dump_´s
(
dev
, 
çl£
);

2143 
out
:

2144 
	`TRACE_EXIT
();

2146 
	}
}

2149 
	$sc¡_´_þ—r
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
, 
bufãr_size
)

2151 
__be64
 
key
;

2152 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

2153 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

2154 
sc¡_dev_»gi¡¿Á
 *
»g
, *
r
, *
t
;

2156 
	`TRACE_ENTRY
();

2158 
	`sc¡_as£¹_´_mu‹x_h–d
(
dev
);

2160 
key
 = 
	`g‘_uÇligÃd
((
__be64
 *)&
bufãr
[0]);

2162 ià(
bufãr_size
 != 24) {

2163 
	`TRACE_PR
("Inv®id bufã¸siz%d", 
bufãr_size
);

2164 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2165 
	`SCST_LOAD_SENSE
(
sc¡_£n£_·¿m‘”_li¡_Ëngth_šv®id
));

2166 
out
;

2169 
»g
 = 
tgt_dev
->
»gi¡¿Á
;

2171 
	`TRACE_PR
("Clear: initiator %s/%d (%p), key %016llx (tgt_dev %p)",

2172 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
cmd
->
£ss
->
Œª¥Üt_id
),

2173 
cmd
->
£ss
->
tgt
->
»l_tgt_id
, 
»g
, 
	`be64_to_ýu
(
key
), 
tgt_dev
);

2176 ià(
»g
->
key
 != key) {

2177 
	`TRACE_PR
("Registrant's %p key %016llx mismatch with %016llx",

2178 
»g
, 
	`be64_to_ýu
Ôeg->
key
), be64_to_cpu(key));

2179 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_RESERVATION_CONFLICT
);

2180 
out
;

2183 
	`sc¡_´_£nd_ua_®l
(
dev
, 
»g
,

2184 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»£rv©iÚ_´“m±ed
));

2186 
	`li¡_fÜ_—ch_’Œy_§ã
(
r
, 
t
, &
dev
->
dev_»gi¡¿Ás_li¡
,

2187 
dev_»gi¡¿Ás_li¡_’Œy
) {

2188 
	`sc¡_´_»move_»gi¡¿Á
(
dev
, 
r
);

2191 
dev
->
´_g’”©iÚ
++;

2193 
	`sc¡_´_dump_´s
(
dev
, 
çl£
);

2195 
out
:

2196 
	`TRACE_EXIT
();

2198 
	}
}

2200 
	$sc¡_´_do_´“m±
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
,

2201 
bufãr_size
, 
boÞ
 
abÜt
)

2203 
__be64
 
key
, 
aùiÚ_key
;

2204 
scÝe
, 
ty³
;

2205 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

2206 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

2207 
sc¡_dev_»gi¡¿Á
 *
»g
, *
r
, *
¹
;

2208 
exi¡šg_´_ty³
 = 
dev
->
´_ty³
;

2209 
exi¡šg_´_scÝe
 = 
dev
->
´_scÝe
;

2210 
	`LIST_HEAD
(
´“m±_li¡
);

2212 
	`TRACE_ENTRY
();

2214 ià(
bufãr_size
 != 24) {

2215 
	`TRACE_PR
("Inv®id bufã¸siz%d", 
bufãr_size
);

2216 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2217 
	`SCST_LOAD_SENSE
(
sc¡_£n£_·¿m‘”_li¡_Ëngth_šv®id
));

2218 
out
;

2221 
key
 = 
	`g‘_uÇligÃd
((
__be64
 *)&
bufãr
[0]);

2222 
aùiÚ_key
 = 
	`g‘_uÇligÃd
((
__be64
 *)&
bufãr
[8]);

2223 
scÝe
 = 
cmd
->
cdb
[2] >> 4;

2224 
ty³
 = 
cmd
->
cdb
[2] & 0x0f;

2226 ià(!
	`sc¡_´_ty³_v®id
(
ty³
)) {

2227 
	`TRACE_PR
("Inv®id„e£rv©iÚy³ %d", 
ty³
);

2228 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 1,

2229 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 0);

2230 
out
;

2233 
»g
 = 
tgt_dev
->
»gi¡¿Á
;

2235 
	`TRACE_PR
("Preempt%s: initiator %s/%d (%p), key %016llx,‡ction_key "

2237 
abÜt
 ? "‡nd‡bort" : "",

2238 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
cmd
->
£ss
->
Œª¥Üt_id
),

2239 
cmd
->
£ss
->
tgt
->
»l_tgt_id
, 
»g
, 
	`be64_to_ýu
(
key
),

2240 
	`be64_to_ýu
(
aùiÚ_key
), 
scÝe
, 
ty³
, 
tgt_dev
);

2243 ià(
»g
->
key
 != key) {

2244 
	`TRACE_PR
("Registrant's %p key %016llx mismatch with %016llx",

2245 
»g
, 
	`be64_to_ýu
Ôeg->
key
), be64_to_cpu(key));

2246 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_RESERVATION_CONFLICT
);

2247 
out
;

2250 ià(!
dev
->
´_is_£t
) {

2251 
	`sc¡_´_fšd_»gi¡¿Ás_li¡_key
(
dev
, 
aùiÚ_key
,

2252 &
´“m±_li¡
);

2253 ià(
	`li¡_em±y
(&
´“m±_li¡
))

2254 
out_”rÜ
;

2255 
	`li¡_fÜ_—ch_’Œy_§ã
(
r
, 
¹
, &
´“m±_li¡
, 
aux_li¡_’Œy
) {

2256 ià(
abÜt
)

2257 
	`sc¡_´_abÜt_»g
(
dev
, 
cmd
, 
r
);

2258 ià(
r
 !ð
»g
) {

2259 
	`sc¡_´_£nd_ua_»g
(
dev
, 
r
, 
	`SCST_LOAD_SENSE
(

2260 
sc¡_£n£_»gi¡¿tiÚs_´“m±ed
));

2261 
	`sc¡_´_»move_»gi¡¿Á
(
dev
, 
r
);

2264 
dÚe
;

2267 ià(
dev
->
´_ty³
 =ð
TYPE_WRITE_EXCLUSIVE_ALL_REG
 ||

2268 
dev
->
´_ty³
 =ð
TYPE_EXCLUSIVE_ACCESS_ALL_REG
) {

2269 ià(
aùiÚ_key
 == 0) {

2270 
	`sc¡_´_fšd_»gi¡¿Ás_li¡_®l
(
dev
, 
»g
,

2271 &
´“m±_li¡
);

2272 
	`li¡_fÜ_—ch_’Œy_§ã
(
r
, 
¹
, &
´“m±_li¡
,

2273 
aux_li¡_’Œy
) {

2274 
	`sBUG_ON
(
r
 =ð
»g
);

2275 ià(
abÜt
)

2276 
	`sc¡_´_abÜt_»g
(
dev
, 
cmd
, 
r
);

2277 
	`sc¡_´_£nd_ua_»g
(
dev
, 
r
,

2278 
	`SCST_LOAD_SENSE
(

2279 
sc¡_£n£_»gi¡¿tiÚs_´“m±ed
));

2280 
	`sc¡_´_»move_»gi¡¿Á
(
dev
, 
r
);

2282 
	`sc¡_´_£t_hÞd”
(
dev
, 
»g
, 
scÝe
, 
ty³
);

2284 
	`sc¡_´_fšd_»gi¡¿Ás_li¡_key
(
dev
, 
aùiÚ_key
,

2285 &
´“m±_li¡
);

2286 ià(
	`li¡_em±y
(&
´“m±_li¡
))

2287 
out_”rÜ
;

2288 
	`li¡_fÜ_—ch_’Œy_§ã
(
r
, 
¹
, &
´“m±_li¡
,

2289 
aux_li¡_’Œy
) {

2290 ià(
abÜt
)

2291 
	`sc¡_´_abÜt_»g
(
dev
, 
cmd
, 
r
);

2292 ià(
r
 !ð
»g
) {

2293 
	`sc¡_´_£nd_ua_»g
(
dev
, 
r
,

2294 
	`SCST_LOAD_SENSE
(

2295 
sc¡_£n£_»gi¡¿tiÚs_´“m±ed
));

2296 
	`sc¡_´_»move_»gi¡¿Á
(
dev
, 
r
);

2300 
dÚe
;

2303 ià(
dev
->
´_hÞd”
->
key
 !ð
aùiÚ_key
) {

2304 ià(
aùiÚ_key
 == 0) {

2305 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 8, 0);

2306 
out
;

2308 
	`sc¡_´_fšd_»gi¡¿Ás_li¡_key
(
dev
, 
aùiÚ_key
,

2309 &
´“m±_li¡
);

2310 ià(
	`li¡_em±y
(&
´“m±_li¡
))

2311 
out_”rÜ
;

2312 
	`li¡_fÜ_—ch_’Œy_§ã
(
r
, 
¹
, &
´“m±_li¡
,

2313 
aux_li¡_’Œy
) {

2314 ià(
abÜt
)

2315 
	`sc¡_´_abÜt_»g
(
dev
, 
cmd
, 
r
);

2316 ià(
r
 !ð
»g
)

2317 
	`sc¡_´_£nd_ua_»g
(
dev
, 
r
,

2318 
	`SCST_LOAD_SENSE
(

2319 
sc¡_£n£_»gi¡¿tiÚs_´“m±ed
));

2320 
	`sc¡_´_»move_»gi¡¿Á
(
dev
, 
r
);

2322 
dÚe
;

2326 
	`sc¡_´_fšd_»gi¡¿Ás_li¡_key
(
dev
, 
aùiÚ_key
,

2327 &
´“m±_li¡
);

2329 
	`li¡_fÜ_—ch_’Œy_§ã
(
r
, 
¹
, &
´“m±_li¡
, 
aux_li¡_’Œy
) {

2330 ià(
abÜt
)

2331 
	`sc¡_´_abÜt_»g
(
dev
, 
cmd
, 
r
);

2332 ià(
r
 !ð
»g
) {

2333 
	`sc¡_´_£nd_ua_»g
(
dev
, 
r
, 
	`SCST_LOAD_SENSE
(

2334 
sc¡_£n£_»gi¡¿tiÚs_´“m±ed
));

2335 
	`sc¡_´_»move_»gi¡¿Á
(
dev
, 
r
);

2339 
	`sc¡_´_£t_hÞd”
(
dev
, 
»g
, 
scÝe
, 
ty³
);

2341 ià(
exi¡šg_´_ty³
 !ð
ty³
 || 
exi¡šg_´_scÝe
 !ð
scÝe
) {

2342 
	`li¡_fÜ_—ch_’Œy
(
r
, &
dev
->
dev_»gi¡¿Ás_li¡
,

2343 
dev_»gi¡¿Ás_li¡_’Œy
) {

2344 ià(
r
 !ð
»g
)

2345 
	`sc¡_´_£nd_ua_»g
(
dev
, 
r
, 
	`SCST_LOAD_SENSE
(

2346 
sc¡_£n£_»£rv©iÚ_»Ëa£d
));

2350 
dÚe
:

2351 
dev
->
´_g’”©iÚ
++;

2353 
	`sc¡_´_dump_´s
(
dev
, 
çl£
);

2355 
out
:

2356 
	`TRACE_EXIT
();

2359 
out_”rÜ
:

2360 
	`TRACE_PR
("Inv®id key %016Îx", 
	`be64_to_ýu
(
aùiÚ_key
));

2361 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_RESERVATION_CONFLICT
);

2362 
out
;

2363 
	}
}

2366 
	$sc¡_´_´“m±
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
, 
bufãr_size
)

2368 
	`TRACE_ENTRY
();

2370 
	`sc¡_as£¹_´_mu‹x_h–d
(
cmd
->
dev
);

2372 
	`sc¡_´_do_´“m±
(
cmd
, 
bufãr
, 
bufãr_size
, 
çl£
);

2374 
	`TRACE_EXIT
();

2376 
	}
}

2378 
	$sc¡_cmd_dÚe_´_´“m±
(
sc¡_cmd
 *
cmd
, 
Ãxt_¡©e
,

2379 
sc¡_exec_cÚ‹xt
 
´ef_cÚ‹xt
)

2381 (*
§ved_cmd_dÚe
)(
sc¡_cmd
 *
cmd
, 
Ãxt_¡©e
,

2382 
sc¡_exec_cÚ‹xt
 
´ef_cÚ‹xt
);

2384 
	`TRACE_ENTRY
();

2386 ià(!
	`©omic_dec_ªd_‹¡
(&
cmd
->
´_abÜt_couÁ”
->
´_abÜt_³ndšg_út
))

2387 
out
;

2389 
§ved_cmd_dÚe
 = 
cmd
->
´_abÜt_couÁ”
->saved_cmd_done;

2390 
	`kä“
(
cmd
->
´_abÜt_couÁ”
);

2391 
cmd
->
´_abÜt_couÁ”
 = 
NULL
;

2393 
	`§ved_cmd_dÚe
(
cmd
, 
Ãxt_¡©e
, 
´ef_cÚ‹xt
);

2395 
out
:

2396 
	`TRACE_EXIT
();

2398 
	}
}

2404 
	$sc¡_´_´“m±_ªd_abÜt
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
,

2405 
bufãr_size
)

2407 
	`TRACE_ENTRY
();

2409 
	`sc¡_as£¹_´_mu‹x_h–d
(
cmd
->
dev
);

2411 
cmd
->
´_abÜt_couÁ”
 = 
	`kz®loc
((*cmd->pr_abort_counter),

2412 
GFP_KERNEL
);

2413 ià(
cmd
->
´_abÜt_couÁ”
 =ð
NULL
) {

2414 
	`PRINT_ERROR
("Unableo‡llocate PR‡bort counter (size %zd)",

2415 (*
cmd
->
´_abÜt_couÁ”
));

2416 
	`sc¡_£t_busy
(
cmd
);

2417 
out
;

2421 
	`©omic_£t
(&
cmd
->
´_abÜt_couÁ”
->
´_abÜt_³ndšg_út
, 1);

2422 
	`©omic_£t
(&
cmd
->
´_abÜt_couÁ”
->
´_abÜtšg_út
, 1);

2423 
	`š™_com¶‘iÚ
(&
cmd
->
´_abÜt_couÁ”
->
´_abÜtšg_cm¶
);

2425 
cmd
->
´_abÜt_couÁ”
->
§ved_cmd_dÚe
 = cmd->
sc¡_cmd_dÚe
;

2426 
cmd
->
sc¡_cmd_dÚe
 = 
sc¡_cmd_dÚe_´_´“m±
;

2428 
	`sc¡_´_do_´“m±
(
cmd
, 
bufãr
, 
bufãr_size
, 
Œue
);

2430 ià(!
	`©omic_dec_ªd_‹¡
(&
cmd
->
´_abÜt_couÁ”
->
´_abÜtšg_út
))

2431 
	`wa™_fÜ_com¶‘iÚ
(&
cmd
->
´_abÜt_couÁ”
->
´_abÜtšg_cm¶
);

2433 
out
:

2434 
	`TRACE_EXIT
();

2436 
	}
}

2439 
boÞ
 
	$sc¡_´_üh_ÿ£
(
sc¡_cmd
 *
cmd
)

2441 
boÞ
 
®lowed
;

2442 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

2443 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

2444 
sc¡_dev_»gi¡¿Á
 *
»g
;

2445 
ušt8_t
 
ty³
;

2447 
	`TRACE_ENTRY
();

2449 
	`TRACE_DBG
("Test ifhere is‡ CRH case for command %s (%s) from "

2450 "%s", 
cmd
->
Ý_Çme
, 
	`sc¡_g‘_Ýcode_Çme
(cmd),

2451 
cmd
->
£ss
->
š™ŸtÜ_Çme
);

2453 ià(!
dev
->
´_is_£t
) {

2454 
	`TRACE_PR
("%s", "PR‚ot set");

2455 
®lowed
 = 
çl£
;

2456 
out
;

2459 
»g
 = 
tgt_dev
->
»gi¡¿Á
;

2460 
ty³
 = 
dev
->
´_ty³
;

2462 
ty³
) {

2463 
TYPE_WRITE_EXCLUSIVE
:

2464 
TYPE_EXCLUSIVE_ACCESS
:

2465 
	`WARN_ON
(
dev
->
´_hÞd”
 =ð
NULL
);

2466 ià(
»g
 =ð
dev
->
´_hÞd”
)

2467 
®lowed
 = 
Œue
;

2469 
®lowed
 = 
çl£
;

2472 
TYPE_WRITE_EXCLUSIVE_REGONLY
:

2473 
TYPE_EXCLUSIVE_ACCESS_REGONLY
:

2474 
TYPE_WRITE_EXCLUSIVE_ALL_REG
:

2475 
TYPE_EXCLUSIVE_ACCESS_ALL_REG
:

2476 
®lowed
 = (
»g
 !ð
NULL
);

2480 
	`PRINT_ERROR
("Inv®id PRy³ %x", 
ty³
);

2481 
®lowed
 = 
çl£
;

2485 ià(!
®lowed
)

2486 
	`TRACE_PR
("Command %s (%s) from %s„ejected dueo‚ot CRH "

2487 "»£rv©iÚ", 
cmd
->
Ý_Çme
, 
	`sc¡_g‘_Ýcode_Çme
(cmd),

2488 
cmd
->
£ss
->
š™ŸtÜ_Çme
);

2490 
	`TRACE_DBG
("Command %s (%s) from %s is‡llowedoƒxecute "

2491 "dutØCRH", 
cmd
->
Ý_Çme
, 
	`sc¡_g‘_Ýcode_Çme
(cmd),

2492 
cmd
->
£ss
->
š™ŸtÜ_Çme
);

2494 
out
:

2495 
	`TRACE_EXIT_RES
(
®lowed
);

2496  
®lowed
;

2498 
	}
}

2501 
boÞ
 
	$sc¡_´_is_cmd_®lowed
(
sc¡_cmd
 *
cmd
)

2503 
boÞ
 
®lowed
;

2504 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

2505 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

2506 
sc¡_dev_»gi¡¿Á
 *
»g
;

2507 
ušt8_t
 
ty³
;

2509 
	`TRACE_ENTRY
();

2511 
	`sc¡_´_»ad_lock
(
dev
);

2513 
	`TRACE_DBG
("Testing if command %s (%s) from %s‡llowedoƒxecute",

2514 
cmd
->
Ý_Çme
, 
	`sc¡_g‘_Ýcode_Çme
(cmd), cmd->
£ss
->
š™ŸtÜ_Çme
);

2517 ià(
	`uÆik–y
(!
dev
->
´_is_£t
)) {

2518 
®lowed
 = 
Œue
;

2519 
out_uÆock
;

2522 
»g
 = 
tgt_dev
->
»gi¡¿Á
;

2523 
ty³
 = 
dev
->
´_ty³
;

2525 
ty³
) {

2526 
TYPE_WRITE_EXCLUSIVE
:

2527 ià(
»g
 &&„eg =ð
dev
->
´_hÞd”
)

2528 
®lowed
 = 
Œue
;

2530 
®lowed
 = (
cmd
->
Ý_æags
 & 
SCST_WRITE_EXCL_ALLOWED
) != 0;

2533 
TYPE_EXCLUSIVE_ACCESS
:

2534 ià(
»g
 &&„eg =ð
dev
->
´_hÞd”
)

2535 
®lowed
 = 
Œue
;

2537 
®lowed
 = (
cmd
->
Ý_æags
 & 
SCST_EXCL_ACCESS_ALLOWED
) != 0;

2540 
TYPE_WRITE_EXCLUSIVE_REGONLY
:

2541 
TYPE_WRITE_EXCLUSIVE_ALL_REG
:

2542 ià(
»g
)

2543 
®lowed
 = 
Œue
;

2545 
®lowed
 = (
cmd
->
Ý_æags
 & 
SCST_WRITE_EXCL_ALLOWED
) != 0;

2548 
TYPE_EXCLUSIVE_ACCESS_REGONLY
:

2549 
TYPE_EXCLUSIVE_ACCESS_ALL_REG
:

2550 ià(
»g
)

2551 
®lowed
 = 
Œue
;

2553 
®lowed
 = (
cmd
->
Ý_æags
 & 
SCST_EXCL_ACCESS_ALLOWED
) != 0;

2557 
	`PRINT_ERROR
("Inv®id PRy³ %x", 
ty³
);

2558 
®lowed
 = 
çl£
;

2562 ià(!
®lowed
)

2563 
	`TRACE_PR
("Command %s (%s) from %s„ejected due "

2564 "tØPR", 
cmd
->
Ý_Çme
, 
	`sc¡_g‘_Ýcode_Çme
(cmd),

2565 
cmd
->
£ss
->
š™ŸtÜ_Çme
);

2567 
	`TRACE_DBG
("Command %s (%s) from %s is‡llowedoƒxecute",

2568 
cmd
->
Ý_Çme
, 
	`sc¡_g‘_Ýcode_Çme
(cmd),

2569 
cmd
->
£ss
->
š™ŸtÜ_Çme
);

2571 
out_uÆock
:

2572 
	`sc¡_´_»ad_uÆock
(
dev
);

2574 
	`TRACE_EXIT_RES
(
®lowed
);

2575  
®lowed
;

2576 
	}
}

2579 
	$sc¡_´_»ad_keys
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
, 
bufãr_size
)

2581 
i
, 
off£t
 = 0, 
size
, 
size_max
;

2582 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

2583 
sc¡_dev_»gi¡¿Á
 *
»g
;

2585 
	`TRACE_ENTRY
();

2587 
	`sc¡_as£¹_´_mu‹x_h–d
(
dev
);

2589 ià(
bufãr_size
 < 8) {

2590 
	`TRACE_PR
("buffer_sizeoo small: %d.ƒxpected >= 8 "

2591 "(bufã¸%p)", 
bufãr_size
, 
bufãr
);

2592 
sk
;

2595 
	`TRACE_PR
("R—d Key (dev %s): PRG’ %d", 
dev
->
vœt_Çme
,

2596 
dev
->
´_g’”©iÚ
);

2598 
	`put_uÇligÃd_be32
(
dev
->
´_g’”©iÚ
, &
bufãr
[0]);

2600 
off£t
 = 8;

2601 
size
 = 0;

2602 
size_max
 = 
bufãr_size
 - 8;

2604 
i
 = 0;

2605 
	`li¡_fÜ_—ch_’Œy
(
»g
, &
dev
->
dev_»gi¡¿Ás_li¡
,

2606 
dev_»gi¡¿Ás_li¡_’Œy
) {

2607 ià(
size_max
 - 
size
 >= 8) {

2608 
	`TRACE_PR
("Read Keys (dev %s): key 0x%llx",

2609 
dev
->
vœt_Çme
, 
»g
->
key
);

2611 
	`WARN_ON
(
»g
->
key
 == 0);

2613 
	`put_uÇligÃd
(
»g
->
key
,

2614 (
__be64
 *)&
bufãr
[
off£t
 + 8 * 
i
]);

2616 
off£t
 += 8;

2618 
size
 += 8;

2621 
	`put_uÇligÃd_be32
(
size
, &
bufãr
[4]);

2623 
sk
:

2624 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
off£t
);

2626 
	`TRACE_EXIT
();

2628 
	}
}

2631 
	$sc¡_´_»ad_»£rv©iÚ
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
,

2632 
bufãr_size
)

2634 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

2635 
ušt8_t
 
b
[24] = { };

2636 
size
 = 0;

2638 
	`TRACE_ENTRY
();

2640 
	`sc¡_as£¹_´_mu‹x_h–d
(
dev
);

2642 ià(
bufãr_size
 < 8) {

2643 
	`TRACE_PR
("buffer_sizeoo small: %d.ƒxpected >= 8 "

2644 "(bufã¸%p)", 
bufãr_size
, 
bufãr
);

2645 
out
;

2648 
	`put_uÇligÃd_be32
(
dev
->
´_g’”©iÚ
, &
b
[0]);

2650 ià(!
dev
->
´_is_£t
) {

2651 
	`TRACE_PR
("Read Reservation:‚o„eservations for dev %s",

2652 
dev
->
vœt_Çme
);

2653 
b
[4] =

2654 
b
[5] =

2655 
b
[6] =

2656 
b
[7] = 0;

2658 
size
 = 8;

2660 
__be64
 
key
 = 
dev
->
´_hÞd”
 ? dev->pr_holder->key : 0;

2662 
	`TRACE_PR
("Read Reservation: dev %s, holder %p, key 0x%llx, "

2663 "scÝ%d,y³ %d", 
dev
->
vœt_Çme
, dev->
´_hÞd”
,

2664 
	`be64_to_ýu
(
key
), 
dev
->
´_scÝe
, dev->
´_ty³
);

2666 
b
[4] =

2667 
b
[5] =

2668 
b
[6] = 0;

2669 
b
[7] = 0x10;

2671 
	`put_uÇligÃd
(
key
, (
__be64
 *)&
b
[8]);

2672 
b
[21] = 
dev
->
´_scÝe
 << 4 | dev->
´_ty³
;

2674 
size
 = 24;

2677 
out
:

2678 
size
 = 
	`mš
(size, 
bufãr_size
);

2679 
	`memýy
(
bufãr
, 
b
, 
size
);

2680 
	`mem£t
(
bufãr
 + 
size
, 0, 
bufãr_size
 - size);

2681 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
size
);

2683 
	`TRACE_EXIT
();

2685 
	}
}

2688 
	$sc¡_´_»pÜt_ÿps
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
, 
bufãr_size
)

2690 
off£t
 = 0;

2691 
üh
 = 1;

2692 
©p_c
 = 1;

2693 
s_c
 = 1;

2694 #ifdeà
CONFIG_SCST_PROC


2695 
±¶_c
 = 0;

2697 
±¶_c
 = 1;

2699 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

2701 
	`TRACE_ENTRY
();

2703 
	`sc¡_as£¹_´_mu‹x_h–d
(
dev
);

2705 ià(
bufãr_size
 < 8) {

2706 
	`TRACE_PR
("buffer_sizeoo small: %d.ƒxpected >= 8 "

2707 "(bufã¸%p)", 
bufãr_size
, 
bufãr
);

2708 
sk
;

2711 
	`TRACE_PR
("Reporting capabilities (dev %s): crh %x, sip_c %x, "

2712 "©p_ø%x,…l_ø%x,…r_­È%x", 
dev
->
vœt_Çme
,

2713 
üh
, 
s_c
, 
©p_c
, 
±¶_c
, 
dev
->
´_­l
);

2715 
bufãr
[0] = 0;

2716 
bufãr
[1] = 8;

2718 
bufãr
[2] = 
üh
 << 4 | 
s_c
 << 3 | 
©p_c
 << 2 | 
±¶_c
;

2719 
bufãr
[3] = (1 << 7è| (4 << 4è| (
dev
->
´_­l
 > 0 ? 1 : 0);

2722 
bufãr
[4] = 0xEA;

2723 
bufãr
[5] = 0x1;

2725 
off£t
 += 8;

2727 
sk
:

2728 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
off£t
);

2730 
	`TRACE_EXIT
();

2732 
	}
}

2735 
	$sc¡_´_»ad_fuÎ_¡©us
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
,

2736 
bufãr_size
)

2738 
off£t
 = 0, 
size
, 
size_max
;

2739 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

2740 
sc¡_dev_»gi¡¿Á
 *
»g
;

2742 
	`TRACE_ENTRY
();

2744 
	`sc¡_as£¹_´_mu‹x_h–d
(
cmd
->
dev
);

2746 ià(
bufãr_size
 < 8)

2747 
sk
;

2749 
	`put_uÇligÃd_be32
(
dev
->
´_g’”©iÚ
, &
bufãr
[0]);

2750 
off£t
 += 8;

2752 
size
 = 0;

2753 
size_max
 = 
bufãr_size
 - 8;

2755 
	`li¡_fÜ_—ch_’Œy
(
»g
, &
dev
->
dev_»gi¡¿Ás_li¡
,

2756 
dev_»gi¡¿Ás_li¡_’Œy
) {

2757 
ts
;

2758 
»c_Ën
;

2760 
ts
 = 
	`sc¡_tid_size
(
»g
->
Œª¥Üt_id
);

2761 
»c_Ën
 = 24 + 
ts
;

2763 ià(
size_max
 - 
size
 > 
»c_Ën
) {

2764 
	`mem£t
(&
bufãr
[
off£t
], 0, 
»c_Ën
);

2766 
	`put_uÇligÃd
(
»g
->
key
, (
__be64
 *)(&
bufãr
[
off£t
]));

2768 ià(
dev
->
´_is_£t
 && 
	`sc¡_´_is_hÞd”
(dev, 
»g
)) {

2769 
bufãr
[
off£t
 + 12] = 1;

2770 
bufãr
[
off£t
 + 13] = (
dev
->
´_scÝe
 << 4è| dev->
´_ty³
;

2773 
	`put_uÇligÃd_be16
(
»g
->
»l_tgt_id
,

2774 &
bufãr
[
off£t
 + 18]);

2775 
	`put_uÇligÃd_be32
(
ts
, &
bufãr
[
off£t
 + 20]);

2777 
	`memýy
(&
bufãr
[
off£t
 + 24], 
»g
->
Œª¥Üt_id
, 
ts
);

2779 
off£t
 +ð
»c_Ën
;

2781 
size
 +ð
»c_Ën
;

2784 
	`put_uÇligÃd_be32
(
size
, &
bufãr
[4]);

2786 
sk
:

2787 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
off£t
);

2789 
	`TRACE_EXIT
();

2791 
	}
}

	@scst/src/scst_pres.h

19 #iâdeà
SCST_PRES_H_


20 
	#SCST_PRES_H_


	)

22 
	~<lšux/d–ay.h
>

23 #ifdeà
INSIDE_KERNEL_TREE


24 
	~<sc¡/sc¡_debug.h
>

26 
	~"sc¡_debug.h
"

30 
	#PR_REGISTER
 0x00

	)

31 
	#PR_RESERVE
 0x01

	)

32 
	#PR_RELEASE
 0x02

	)

33 
	#PR_CLEAR
 0x03

	)

34 
	#PR_PREEMPT
 0x04

	)

35 
	#PR_PREEMPT_AND_ABORT
 0x05

	)

36 
	#PR_REGISTER_AND_IGNORE
 0x06

	)

37 
	#PR_REGISTER_AND_MOVE
 0x07

	)

40 
	#PR_READ_KEYS
 0x00

	)

41 
	#PR_READ_RESERVATION
 0x01

	)

42 
	#PR_REPORT_CAPS
 0x02

	)

43 
	#PR_READ_FULL_STATUS
 0x03

	)

46 
	#TYPE_UNSPECIFIED
 (-1)

	)

47 
	#TYPE_WRITE_EXCLUSIVE
 0x01

	)

48 
	#TYPE_EXCLUSIVE_ACCESS
 0x03

	)

49 
	#TYPE_WRITE_EXCLUSIVE_REGONLY
 0x05

	)

50 
	#TYPE_EXCLUSIVE_ACCESS_REGONLY
 0x06

	)

51 
	#TYPE_WRITE_EXCLUSIVE_ALL_REG
 0x07

	)

52 
	#TYPE_EXCLUSIVE_ACCESS_ALL_REG
 0x08

	)

55 
	#SCOPE_LU
 0x00

	)

57 
šlše
 
boÞ
 
	$sc¡_´_ty³_v®id
(
ušt8_t
 
ty³
)

59 
ty³
) {

60 
TYPE_WRITE_EXCLUSIVE
:

61 
TYPE_EXCLUSIVE_ACCESS
:

62 
TYPE_WRITE_EXCLUSIVE_REGONLY
:

63 
TYPE_EXCLUSIVE_ACCESS_REGONLY
:

64 
TYPE_WRITE_EXCLUSIVE_ALL_REG
:

65 
TYPE_EXCLUSIVE_ACCESS_ALL_REG
:

66  
Œue
;

68  
çl£
;

70 
	}
}

72 
šlše
 
	$sc¡_´_»ad_lock
(
sc¡_deviû
 *
dev
)

74 
	`mu‹x_lock
(&
dev
->
dev_´_mu‹x
);

75 
	}
}

77 
šlše
 
	$sc¡_´_»ad_uÆock
(
sc¡_deviû
 *
dev
)

79 
	`mu‹x_uÆock
(&
dev
->
dev_´_mu‹x
);

80 
	}
}

82 
šlše
 
	$lockd•_as£¹_´_»ad_lock_h–d
(
sc¡_deviû
 *
dev
)

84 
	`lockd•_as£¹_h–d
(&
dev
->
dev_´_mu‹x
);

85 
	}
}

87 
šlše
 
	$sc¡_´_wr™e_lock
(
sc¡_deviû
 *
dev
)

89 
	`mu‹x_lock
(&
dev
->
dev_´_mu‹x
);

90 
	}
}

92 
šlše
 
	$sc¡_´_wr™e_uÆock
(
sc¡_deviû
 *
dev
)

94 
	`mu‹x_uÆock
(&
dev
->
dev_´_mu‹x
);

95 
	}
}

97 
šlše
 
	$lockd•_as£¹_´_wr™e_lock_h–d
(
sc¡_deviû
 *
dev
)

99 
	`lockd•_as£¹_h–d
(&
dev
->
dev_´_mu‹x
);

100 
	}
}

102 
	$sc¡_´_£t_fže_Çme
(
sc¡_deviû
 *
dev
, **
´ev
,

103 cÚ¡ *
fmt
, ...è
	`__´štf
(3, 4);

105 
	`sc¡_´_š™_dev
(
sc¡_deviû
 *
dev
);

106 
	`sc¡_´_þ—r_dev
(
sc¡_deviû
 *
dev
);

108 
	`sc¡_´_š™_tgt_dev
(
sc¡_tgt_dev
 *
tgt_dev
);

109 
	`sc¡_´_þ—r_tgt_dev
(
sc¡_tgt_dev
 *
tgt_dev
);

111 
boÞ
 
	`sc¡_´_üh_ÿ£
(
sc¡_cmd
 *
cmd
);

112 
boÞ
 
	`sc¡_´_is_cmd_®lowed
(
sc¡_cmd
 *
cmd
);

114 
	`sc¡_´_»gi¡”
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
, 
bufãr_size
);

115 
	`sc¡_´_»gi¡”_ªd_ignÜe
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
,

116 
bufãr_size
);

117 
	`sc¡_´_»gi¡”_ªd_move
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
,

118 
bufãr_size
);

119 
	`sc¡_´_»£rve
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
, 
bufãr_size
);

120 
	`sc¡_´_»Ëa£
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
, 
bufãr_size
);

121 
	`sc¡_´_þ—r
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
, 
bufãr_size
);

122 
	`sc¡_´_´“m±
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
, 
bufãr_size
);

123 
	`sc¡_´_´“m±_ªd_abÜt
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
,

124 
bufãr_size
);

126 
	`sc¡_´_»ad_keys
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
, 
bufãr_size
);

127 
	`sc¡_´_»ad_»£rv©iÚ
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
,

128 
bufãr_size
);

129 
	`sc¡_´_»pÜt_ÿps
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
, 
bufãr_size
);

130 
	`sc¡_´_»ad_fuÎ_¡©us
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
,

131 
bufãr_size
);

133 
	`sc¡_tid_size
(cÚ¡ 
ušt8_t
 *
tid
);

134 
boÞ
 
	`tid_equ®
(cÚ¡ 
ušt8_t
 *
tid_a
, cÚ¡ ušt8_ˆ*
tid_b
);

136 
sc¡_dev_»gi¡¿Á
 *
	`sc¡_´_fšd_»g
(
sc¡_deviû
 *
dev
,

137 cÚ¡ 
ušt8_t
 *
Œª¥Üt_id
, cÚ¡ 
ušt16_t
 
»l_tgt_id
);

138 
sc¡_dev_»gi¡¿Á
 *
	`sc¡_´_add_»gi¡¿Á
(
sc¡_deviû
 *
dev
,

139 cÚ¡ 
ušt8_t
 *
Œª¥Üt_id
,

140 cÚ¡ 
ušt16_t
 
»l_tgt_id
,

141 
__be64
 
key
,

142 
boÞ
 
dev_lock_locked
);

143 
	`sc¡_´_»move_»gi¡¿Á
(
sc¡_deviû
 *
dev
,

144 
sc¡_dev_»gi¡¿Á
 *
»g
);

145 
	`sc¡_´_£t_hÞd”
(
sc¡_deviû
 *
dev
,

146 
sc¡_dev_»gi¡¿Á
 *
hÞd”
, 
ušt8_t
 
scÝe
,

147 
ušt8_t
 
ty³
);

148 
	`sc¡_´_þ—r_hÞd”
(
sc¡_deviû
 *
dev
);

150 #iâdeà
CONFIG_SCST_PROC


151 
	`sc¡_´_sync_deviû_fže
(
sc¡_tgt_dev
 *
tgt_dev
, 
sc¡_cmd
 *
cmd
);

154 #ià
	`defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

155 
	`sc¡_´_dump_´s
(
sc¡_deviû
 *
dev
, 
boÞ
 
fÜû
);

157 
šlše
 
	$sc¡_´_dump_´s
(
sc¡_deviû
 *
dev
, 
boÞ
 
fÜû
è{
	}
}

	@scst/src/scst_priv.h

19 #iâdeà
__SCST_PRIV_H


20 
	#__SCST_PRIV_H


	)

22 
	~<lšux/ty³s.h
>

23 
	~<lšux/¦ab.h
>

24 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(3, 2, 0)

25 
	~<lšux/expÜt.h
>

27 
	~<scsi/scsi.h
>

28 
	~<scsi/scsi_cmnd.h
>

29 
	~<scsi/scsi_driv”.h
>

30 
	~<scsi/scsi_deviû.h
>

31 
	~<scsi/scsi_ho¡.h
>

33 
	#LOG_PREFIX
 "sc¡"

	)

35 #ifdeà
INSIDE_KERNEL_TREE


36 
	~<sc¡/sc¡_debug.h
>

38 
	~"sc¡_debug.h
"

41 
	#TRACE_RTRY
 0x80000000

	)

42 
	#TRACE_SCSI_SERIALIZING
 0x40000000

	)

43 
	#TRACE_DATA_SEND
 0x20000000

	)

44 
	#TRACE_DATA_RECEIVED
 0x01000000

	)

46 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

47 
	#Œaû_æag
 
sc¡_Œaû_æag


	)

48 
sc¡_Œaû_æag
;

51 #ifdeà
CONFIG_SCST_DEBUG


53 
	#SCST_DEFAULT_LOG_FLAGS
 (
TRACE_OUT_OF_MEM
 | 
TRACE_MINOR
 | 
TRACE_PID
 | \

54 
TRACE_LINE
 | 
TRACE_FUNCTION
 | 
TRACE_SPECIAL
 | 
TRACE_MGMT
 | \

55 
TRACE_MGMT_DEBUG
 | 
TRACE_RTRY
)

	)

57 
	#TRACE_RETRY
(
¬gs
...è
	`TRACE_DBG_FLAG
(
TRACE_RTRY
,‡rgs)

	)

58 
	#TRACE_SN
(
¬gs
...è
	`TRACE_DBG_FLAG
(
TRACE_SCSI_SERIALIZING
,‡rgs)

	)

59 
	#TRACE_SN_SPECIAL
(
¬gs
...è
	`TRACE_DBG_FLAG
(
TRACE_SCSI_SERIALIZING
|
TRACE_SPECIAL
,‡rgs)

	)

63 #ifdeà
CONFIG_SCST_TRACING


64 
	#SCST_DEFAULT_LOG_FLAGS
 (
TRACE_OUT_OF_MEM
 | 
TRACE_MGMT
 | 
TRACE_PID
 | \

65 
TRACE_SPECIAL
)

	)

67 
	#SCST_DEFAULT_LOG_FLAGS
 0

	)

70 
	#TRACE_RETRY
(
¬gs
...)

	)

71 
	#TRACE_SN
(
¬gs
...)

	)

72 
	#TRACE_SN_SPECIAL
(
¬gs
...)

	)

85 
	#SCST_FLAG_SUSPENDING
 0

	)

88 
	#SCST_FLAG_SUSPENDED
 1

	)

94 
	#SCST_CMD_STATE_RES_CONT_NEXT
 
SCST_EXEC_COMPLETED


	)

95 
	#SCST_CMD_STATE_RES_CONT_SAME
 
SCST_EXEC_NOT_COMPLETED


	)

96 
	#SCST_CMD_STATE_RES_NEED_THREAD
 (
SCST_EXEC_NOT_COMPLETED
+1)

	)

102 
	#SCST_MAX_TGT_DEV_COMMANDS
 64

	)

104 #ifdeà
CONFIG_SCST_PER_DEVICE_CMD_COUNT_LIMIT


110 
	#SCST_MAX_DEV_COMMANDS
 256

	)

113 
	#SCST_TGT_RETRY_TIMEOUT
 1

	)

115 
	#SCST_DEF_LBA_DATA_LEN
 -1

	)

118 
	#SCST_MAX_VALID_BUFFLEN_MASK
 (~((1 << (32 - 12)è- 1))

	)

120 
	#SCST_MAX_EACH_INTERNAL_IO_SIZE
 (128*1024)

	)

121 
	#SCST_MAX_IN_FLIGHT_INTERNAL_COMMANDS
 32

	)

135 #iâdeà
loÿl_œq_’abË_nÜt


137 
	#loÿl_œq_’abË_nÜt
(è
	`loÿl_œq_’abË
()

	)

138 
	#loÿl_œq_di§bË_nÜt
(è
	`loÿl_œq_di§bË
()

	)

139 
	#loÿl_œq_§ve_nÜt
(
æags
è
	`loÿl_œq_§ve
(æags)

	)

140 
	#loÿl_œq_»¡Üe_nÜt
(
æags
è
	`loÿl_œq_»¡Üe
(æags)

	)

143 (*
	tsc¡_i_fšish_â_t
è(
	tsc¡_cmd
 *
	tcmd
);

145 
mu‹x
 
sc¡_mu‹x2
;

147 
sc¡_th»ads
;

149 
sc¡_max_dev_cmd_mem
;

151 
sc¡_fÜcibly_þo£_£ssiÚs
;

153 
mempoÞ_t
 *
sc¡_mgmt_mempoÞ
;

154 
mempoÞ_t
 *
sc¡_mgmt_¡ub_mempoÞ
;

155 
mempoÞ_t
 *
sc¡_ua_mempoÞ
;

156 
mempoÞ_t
 *
sc¡_£n£_mempoÞ
;

157 
mempoÞ_t
 *
sc¡_«n_mempoÞ
;

159 
kmem_ÿche
 *
sc¡_cmd_ÿch•
;

160 
kmem_ÿche
 *
sc¡_£ss_ÿch•
;

161 
kmem_ÿche
 *
sc¡_dev_ÿch•
;

162 
kmem_ÿche
 *
sc¡_tgt_ÿch•
;

163 
kmem_ÿche
 *
sc¡_tgtd_ÿch•
;

164 
kmem_ÿche
 *
sc¡_acgd_ÿch•
;

166 
sc¡_æags
;

167 
li¡_h—d
 
sc¡_‹m¶©e_li¡
;

168 
li¡_h—d
 
sc¡_dev_li¡
;

169 
li¡_h—d
 
sc¡_dev_ty³_li¡
;

170 
li¡_h—d
 
sc¡_vœtu®_dev_ty³_li¡
;

171 
wa™_queue_h—d_t
 
sc¡_dev_cmd_wa™Q
;

173 cÚ¡ 
sc¡_þ_Ýs
 
sc¡_no_dlm_þ_Ýs
;

174 cÚ¡ 
sc¡_þ_Ýs
 
sc¡_dlm_þ_Ýs
;

176 #ifdeà
CONFIG_SCST_PROC


177 
li¡_h—d
 
sc¡_acg_li¡
;

178 
sc¡_acg
 *
sc¡_deçuÉ_acg
;

180 
sc¡_£tup_id
;

183 
	#SCST_DEF_MAX_TASKLET_CMD
 10

	)

184 
sc¡_max_skËt_cmd
;

186 
¥šlock_t
 
sc¡_š™_lock
;

187 
li¡_h—d
 
sc¡_š™_cmd_li¡
;

188 
wa™_queue_h—d_t
 
sc¡_š™_cmd_li¡_wa™Q
;

189 
sc¡_š™_pÞl_út
;

191 
sc¡_cmd_th»ads
 
sc¡_maš_cmd_th»ads
;

193 
¥šlock_t
 
sc¡_mcmd_lock
;

195 
li¡_h—d
 
sc¡_aùive_mgmt_cmd_li¡
;

196 
li¡_h—d
 
sc¡_d–ayed_mgmt_cmd_li¡
;

197 
wa™_queue_h—d_t
 
sc¡_mgmt_cmd_li¡_wa™Q
;

199 
	ssc¡_³rýu_šfo
 {

200 
©omic_t
 
ýu_cmd_couÁ
;

201 
¥šlock_t
 
skËt_lock
;

202 
li¡_h—d
 
skËt_cmd_li¡
;

203 
skËt_¡ruù
 
skËt
;

204 } 
____ÿch–še_®igÃd_š_smp
;

205 
sc¡_³rýu_šfo
 
sc¡_³rýu_šfos
[
NR_CPUS
];

207 
wa™_queue_h—d_t
 
sc¡_mgmt_wa™Q
;

208 
¥šlock_t
 
sc¡_mgmt_lock
;

209 
li¡_h—d
 
sc¡_£ss_š™_li¡
;

210 
li¡_h—d
 
sc¡_£ss_shut_li¡
;

212 
ýumask_t
 
deçuÉ_ýu_mask
;

214 
	ssc¡_cmd_th»ad_t
 {

215 
sk_¡ruù
 *
cmd_th»ad
;

216 
li¡_h—d
 
th»ad_li¡_’Œy
;

217 
boÞ
 
bešg_¡Ý³d
;

220 
šlše
 
boÞ
 
	$sc¡_£t_io_cÚ‹xt
(
sc¡_cmd
 *
cmd
,

221 
io_cÚ‹xt
 **
Þd
)

223 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 25)

224  
çl£
;

226 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


227  
çl£
;

229 
boÞ
 
»s
;

231 
	`EXTRACHECKS_BUG_ON
(
Þd
 =ð
NULL
);

233 ià(
cmd
->
cmd_th»ads
 =ð&
sc¡_maš_cmd_th»ads
) {

234 
	`EXTRACHECKS_BUG_ON
(
	`š_š‹¼u±
());

239 *
Þd
 = 
cu¼’t
->
io_cÚ‹xt
;

240 
cu¼’t
->
io_cÚ‹xt
 = 
cmd
->
tgt_dev
->
async_io_cÚ‹xt
;

241 
»s
 = 
Œue
;

242 
	`TRACE_DBG
("io_cÚ‹xˆ%°Ñgt_dev %p)", 
cu¼’t
->
io_cÚ‹xt
,

243 
cmd
->
tgt_dev
);

244 
	`EXTRACHECKS_BUG_ON
(
cu¼’t
->
io_cÚ‹xt
 =ð
NULL
);

246 
»s
 = 
çl£
;

248  
»s
;

251 
	}
}

253 
šlše
 
	$sc¡_»£t_io_cÚ‹xt
(
sc¡_tgt_dev
 *
tgt_dev
,

254 
io_cÚ‹xt
 *
Þd
)

256 
cu¼’t
->
io_cÚ‹xt
 = 
Þd
;

257 
	`TRACE_DBG
("io_cÚ‹xˆ%°»£t", 
cu¼’t
->
io_cÚ‹xt
);

259 
	}
}

265 
sc¡_dev_ty³_th»ads_poÞ_ty³
 
sc¡_·r£_th»ads_poÞ_ty³
(

266 cÚ¡ *
p
, 
Ën
);

268 
sc¡_add_th»ads
(
sc¡_cmd_th»ads
 *
cmd_th»ads
,

269 
sc¡_deviû
 *
dev
, 
sc¡_tgt_dev
 *
tgt_dev
, 
num
);

270 
sc¡_d–_th»ads
(
sc¡_cmd_th»ads
 *
cmd_th»ads
, 
num
);

272 
sc¡_ü—‹_dev_th»ads
(
sc¡_deviû
 *
dev
);

273 
sc¡_¡Ý_dev_th»ads
(
sc¡_deviû
 *
dev
);

275 
sc¡_tgt_dev_£tup_th»ads
(
sc¡_tgt_dev
 *
tgt_dev
);

276 
sc¡_tgt_dev_¡Ý_th»ads
(
sc¡_tgt_dev
 *
tgt_dev
);

278 
sc¡_dev_ty³
 
sc¡_nuÎ_devty³
;

280 *
sc¡_g‘_cmd_¡©e_Çme
(*
Çme
, 
Ën
, 
¡©e
);

281 *
sc¡_g‘_mcmd_¡©e_Çme
(*
Çme
, 
Ën
, 
¡©e
);

282 *
sc¡_g‘_tm_â_Çme
(*
Çme
, 
Ën
, 
â
);

284 
sc¡_cmd
 *
__sc¡_check_deã¼ed_commªds_locked
(

285 
sc¡_Üd”_d©a
 *
Üd”_d©a
, 
boÞ
 
»tuº_fœ¡
);

286 
sc¡_cmd
 *
__sc¡_check_deã¼ed_commªds
(

287 
sc¡_Üd”_d©a
 *
Üd”_d©a
, 
boÞ
 
»tuº_fœ¡
);

290 
šlše
 
sc¡_cmd
 *
	$sc¡_check_deã¼ed_commªds
(

291 
sc¡_Üd”_d©a
 *
Üd”_d©a
, 
boÞ
 
»tuº_fœ¡
)

293 ià(
Üd”_d©a
->
def_cmd_couÁ
 == 0)

294  
NULL
;

296  
	`__sc¡_check_deã¼ed_commªds
(
Üd”_d©a
, 
»tuº_fœ¡
);

297 
	}
}

299 
šlše
 
	$sc¡_make_deã¼ed_commªds_aùive
(

300 
sc¡_Üd”_d©a
 *
Üd”_d©a
)

302 
	`sc¡_check_deã¼ed_commªds
(
Üd”_d©a
, 
çl£
);

304 
	}
}

310 
šlše
 
	$sc¡_make_deã¼ed_commªds_aùive_locked
(

311 
sc¡_Üd”_d©a
 *
Üd”_d©a
)

313 ià(
Üd”_d©a
->
def_cmd_couÁ
 != 0)

314 
	`__sc¡_check_deã¼ed_commªds_locked
(
Üd”_d©a
, 
çl£
);

316 
	}
}

318 
boÞ
 
sc¡_šc_ex³ùed_¢
(cÚ¡ 
sc¡_cmd
 *
cmd
);

319 
sc¡_check_hq_cmd
(
sc¡_cmd
 *
cmd
);

321 
sc¡_unblock_deã¼ed
(
sc¡_Üd”_d©a
 *
Üd”_d©a
,

322 
sc¡_cmd
 *
cmd_¢
);

324 
sc¡_Ú_hq_cmd_»¥Ú£
(
sc¡_cmd
 *
cmd
);

325 
sc¡_xm™_´oûss_abÜ‹d_cmd
(
sc¡_cmd
 *
cmd
);

327 
sc¡_´e_·r£
(
sc¡_cmd
 *
cmd
);

329 
sc¡_cmd_th»ad
(*
¬g
);

330 
sc¡_cmd_skËt
(
p
);

331 
sc¡_š™_th»ad
(*
¬g
);

332 
sc¡_tm_th»ad
(*
¬g
);

333 
sc¡_glob®_mgmt_th»ad
(*
¬g
);

335 
sc¡_cmd_£t_wr™e_no_d©a_»ûived
(
sc¡_cmd
 *
cmd
);

337 
sc¡_z”o_wr™e_»¡
(
sc¡_cmd
 *
cmd
);

338 
sc¡_lim™_sg_wr™e_Ën
(
sc¡_cmd
 *
cmd
);

339 
sc¡_adju¡_»¥_d©a_Ën
(
sc¡_cmd
 *
cmd
);

341 
sc¡_queue_»Œy_cmd
(
sc¡_cmd
 *
cmd
);

343 
sc¡_®loc_tgt
(
sc¡_tgt_‹m¶©e
 *
tg‰
, 
sc¡_tgt
 **
tgt
);

344 
sc¡_ä“_tgt
(
sc¡_tgt
 *
tgt
);

346 
sc¡_®loc_deviû
(
gå_t
 
gå_mask
, 
sc¡_deviû
 **
out_dev
);

347 
sc¡_ä“_deviû
(
sc¡_deviû
 *
dev
);

348 
boÞ
 
sc¡_deviû_is_expÜ‹d
(
sc¡_deviû
 *
dev
);

350 
sc¡_®loc_add_acg
(
sc¡_tgt
 *
tgt
, cÚ¡ *
acg_Çme
,

351 
boÞ
 
tgt_acg
, 
sc¡_acg
 **
out_acg
);

352 
sc¡_d–_ä“_acg
(
sc¡_acg
 *
acg
, 
boÞ
 
þo£_£ssiÚs
);

353 
sc¡_g‘_acg
(
sc¡_acg
 *
acg
);

354 
sc¡_put_acg
(
sc¡_acg
 *
acg
);

356 
sc¡_acg
 *
sc¡_tgt_fšd_acg
(
sc¡_tgt
 *
tgt
, cÚ¡ *
Çme
);

357 
sc¡_acg
 *
sc¡_fšd_acg
(cÚ¡ 
sc¡_£ssiÚ
 *
£ss
);

359 
sc¡_check_»assign_£ssiÚs
();

361 
sc¡_£ss_®loc_tgt_devs
(
sc¡_£ssiÚ
 *
£ss
);

362 
sc¡_£ss_ä“_tgt_devs
(
sc¡_£ssiÚ
 *
£ss
);

363 
sc¡_tgt_dev
 *
sc¡_lookup_tgt_dev
(
sc¡_£ssiÚ
 *
£ss
, 
u64
 
lun
);

364 
sc¡_Ãxus_loss
(
sc¡_tgt_dev
 *
tgt_dev
, 
boÞ
 
queue_UA
);

366 
	#SCST_ADD_LUN_READ_ONLY
 1

	)

367 
	#SCST_ADD_LUN_GEN_UA
 2

	)

368 
	#SCST_ADD_LUN_CM
 4

	)

369 
sc¡_acg_add_lun
(
sc¡_acg
 *
acg
, 
kobjeù
 *
·»Á
,

370 
sc¡_deviû
 *
dev
, 
ušt64_t
 
lun
, 
æags
,

371 
sc¡_acg_dev
 **
out_acg_dev
);

372 
sc¡_acg_d–_lun
(
sc¡_acg
 *
acg
, 
ušt64_t
 
lun
,

373 
boÞ
 
g’_»pÜt_luns_chªged
);

375 
sc¡_acg_add_aú
(
sc¡_acg
 *
acg
, cÚ¡ *
Çme
);

376 #ifdeà
CONFIG_SCST_PROC


377 
sc¡_acg_»move_Çme
(
sc¡_acg
 *
acg
, cÚ¡ *
Çme
, 
boÞ
 
»assign
);

379 
sc¡_d–_ä“_aú
(
sc¡_aú
 *
aú
, 
boÞ
 
»assign
);

380 
sc¡_aú
 *
sc¡_fšd_aú
(
sc¡_acg
 *
acg
, cÚ¡ *
Çme
);

383 
šlše
 
boÞ
 
	$sc¡_acg_£ss_is_em±y
(
sc¡_acg
 *
acg
)

385  
	`li¡_em±y
(&
acg
->
acg_£ss_li¡
);

386 
	}
}

388 
sc¡_´•¬e_»que¡_£n£
(
sc¡_cmd
 *
Üig_cmd
);

389 
sc¡_fšish_š‹º®_cmd
(
sc¡_cmd
 *
cmd
);

391 
sc¡_£t_cmd_”rÜ_£n£
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
£n£
,

392 
Ën
);

393 
sc¡_¡Üe_£n£
(
sc¡_cmd
 *
cmd
);

395 
sc¡_´oûss_check_cÚd™iÚ
(
sc¡_cmd
 *
cmd
);

397 
sc¡_assign_dev_hªdËr
(
sc¡_deviû
 *
dev
,

398 
sc¡_dev_ty³
 *
hªdËr
);

400 
sc¡_£ssiÚ
 *
sc¡_®loc_£ssiÚ
(
sc¡_tgt
 *
tgt
, 
gå_t
 
gå_mask
,

401 cÚ¡ *
š™ŸtÜ_Çme
);

402 
sc¡_ä“_£ssiÚ
(
sc¡_£ssiÚ
 *
£ss
);

403 
sc¡_ä“_£ssiÚ_ÿÎback
(
sc¡_£ssiÚ
 *
£ss
);

405 
sc¡_check_»Œ›s
(
sc¡_tgt
 *
tgt
);

407 
šlše
 
	$sc¡_dlm_Ãw_lock¥aû
(cÚ¡ *
Çme
, 
Çm–’
,

408 
dlm_lock¥aû_t
 **
lock¥aû
,

409 
ušt32_t
 
æags
,

410 
lvbËn
)

412 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 31)

413  
	`dlm_Ãw_lock¥aû
((*)
Çme
, 
Çm–’
, 
lock¥aû
, 
æags
,

414 
lvbËn
);

415 #–ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3, 3, 0)

416  
	`dlm_Ãw_lock¥aû
(
Çme
, 
Çm–’
, 
lock¥aû
, 
æags
, 
lvbËn
);

418  
	`dlm_Ãw_lock¥aû
(
Çme
, 
NULL
, 
æags
, 
lvbËn
, NULL, NULL, NULL,

419 
lock¥aû
);

421 
	}
}

423 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 30)

424 
šlše
 
sc¡_exec_»q
(
scsi_deviû
 *
sdev
,

425 cÚ¡ *
cmd
, 
cmd_Ën
, 
d©a_dœeùiÚ
,

426 
sÿ‰”li¡
 *
sgl
, 
bufæ’
, 
ÃÁs
,

427 
timeout
, 
»Œ›s
, *
´ivd©a
,

428 (*
dÚe
)(*, *, , ), 
gå_t
 
gå
)

430 #ià
	`defšed
(
CONFIG_SCST_STRICT_SERIALIZING
)

431  
	`scsi_execu‹_async
(
sdev
, 
cmd
, 
cmd_Ën
, 
d©a_dœeùiÚ
, (*)
sgl
,

432 
bufæ’
, 
ÃÁs
, 
timeout
, 
»Œ›s
, 
´ivd©a
, 
dÚe
, 
gå
);

433 #–ià!
	`defšed
(
SCSI_EXEC_REQ_FIFO_DEFINED
)

434 
	`WARN_ON
(1);

437  
	`scsi_execu‹_async_fifo
(
sdev
, 
cmd
, 
cmd_Ën
, 
d©a_dœeùiÚ
,

438 (*)
sgl
, 
bufæ’
, 
ÃÁs
, 
timeout
, 
»Œ›s
, 
´ivd©a
, 
dÚe
, 
gå
);

440 
	}
}

443 
sc¡_®loc_¥aû
(
sc¡_cmd
 *
cmd
);

445 
sc¡_lib_š™
();

446 
sc¡_lib_ex™
();

448 
sc¡_mgmt_cmd
 *
sc¡_®loc_mgmt_cmd
(
gå_t
 
gå_mask
);

449 
sc¡_ä“_mgmt_cmd
(
sc¡_mgmt_cmd
 *
mcmd
);

450 
sc¡_dÚe_cmd_mgmt
(
sc¡_cmd
 *
cmd
);

451 
sc¡_fšish_cmd_mgmt
(
sc¡_cmd
 *
cmd
);

453 
šlše
 
	$sc¡_devt_þ—nup
(
sc¡_dev_ty³
 *
devt
è{ 
	}
}

455 
sc¡_tg_š™
();

456 
sc¡_tg_þ—nup
();

457 
sc¡_dg_add
(
kobjeù
 *
·»Á
, cÚ¡ *
Çme
);

458 
sc¡_dg_»move
(cÚ¡ *
Çme
);

459 
sc¡_dev_group
 *
sc¡_lookup_dg_by_kobj
(
kobjeù
 *
kobj
);

460 
sc¡_dg_dev_add
(
sc¡_dev_group
 *
dg
, cÚ¡ *
Çme
);

461 
sc¡_dg_dev_»move_by_Çme
(
sc¡_dev_group
 *
dg
, cÚ¡ *
Çme
);

462 
sc¡_dg_dev_»move_by_dev
(
sc¡_deviû
 *
dev
);

463 
sc¡_tg_¡©e
 
sc¡_®ua_Çme_to_¡©e
(cÚ¡ *
n
);

464 
sc¡_tg_add
(
sc¡_dev_group
 *
dg
, cÚ¡ *
Çme
);

465 
sc¡_tg_»move_by_Çme
(
sc¡_dev_group
 *
dg
, cÚ¡ *
Çme
);

466 
sc¡_tg_š™_tgt_dev
(
sc¡_tgt_dev
 *
tgt_dev
);

467 
sc¡_tg_£t_¡©e
(
sc¡_rg‘_group
 *
tg
, 
sc¡_tg_¡©e
 
¡©e
);

468 
sc¡_tg_£t_´eã¼ed
(
sc¡_rg‘_group
 *
tg
, 
boÞ
 
´eã¼ed
);

469 
sc¡_tg_tgt_add
(
sc¡_rg‘_group
 *
tg
, cÚ¡ *
Çme
);

470 
sc¡_tg_tgt_»move_by_Çme
(
sc¡_rg‘_group
 *
tg
, cÚ¡ *
Çme
);

471 
sc¡_tg_tgt_»move_by_tgt
(
sc¡_tgt
 *
tgt
);

472 #iâdeà
CONFIG_SCST_PROC


473 
sc¡_dg_sysfs_add
(
kobjeù
 *
·»Á
, 
sc¡_dev_group
 *
dg
);

474 
sc¡_dg_sysfs_d–
(
sc¡_dev_group
 *
dg
);

475 
sc¡_tgt_sysfs_put
(
sc¡_tgt
 *
tgt
);

476 
sc¡_dg_dev_sysfs_add
(
sc¡_dev_group
 *
dg
, 
sc¡_dg_dev
 *
dgdev
);

477 
sc¡_dg_dev_sysfs_d–
(
sc¡_dev_group
 *
dg
,

478 
sc¡_dg_dev
 *
dgdev
);

479 
sc¡_tg_sysfs_add
(
sc¡_dev_group
 *
dg
,

480 
sc¡_rg‘_group
 *
tg
);

481 
sc¡_tg_sysfs_d–
(
sc¡_rg‘_group
 *
tg
);

482 
sc¡_tg_tgt_sysfs_add
(
sc¡_rg‘_group
 *
tg
,

483 
sc¡_tg_tgt
 *
tg_tgt
);

484 
sc¡_tg_tgt_sysfs_d–
(
sc¡_rg‘_group
 *
tg
,

485 
sc¡_tg_tgt
 *
tg_tgt
);

487 
šlše
 
	$sc¡_dg_sysfs_add
(
kobjeù
 *
·»Á
,

488 
sc¡_dev_group
 *
dg
)

491 
	}
}

492 
šlše
 
	$sc¡_dg_sysfs_d–
(
sc¡_dev_group
 *
dg
)

494 
	}
}

495 
šlše
 
	$sc¡_dg_dev_sysfs_add
(
sc¡_dev_group
 *
dg
,

496 
sc¡_dg_dev
 *
dgdev
)

499 
	}
}

500 
šlše
 
	$sc¡_dg_dev_sysfs_d–
(
sc¡_dev_group
 *
dg
,

501 
sc¡_dg_dev
 *
dgdev
)

503 
	}
}

504 
šlše
 
	$sc¡_tg_sysfs_add
(
sc¡_dev_group
 *
dg
,

505 
sc¡_rg‘_group
 *
tg
)

508 
	}
}

509 
šlše
 
	$sc¡_tg_sysfs_d–
(
sc¡_rg‘_group
 *
tg
)

511 
	}
}

512 
šlše
 
	$sc¡_tg_tgt_sysfs_add
(
sc¡_rg‘_group
 *
tg
,

513 
sc¡_tg_tgt
 *
tg_tgt
)

516 
	}
}

517 
šlše
 
	$sc¡_tg_tgt_sysfs_d–
(
sc¡_rg‘_group
 *
tg
,

518 
sc¡_tg_tgt
 *
tg_tgt
)

520 
	}
}

523 #ifdeà
CONFIG_SCST_PROC


525 
sc¡_´oc_š™_moduË
();

526 
sc¡_´oc_þ—nup_moduË
();

527 
sc¡_bužd_´oc_rg‘_dœ_’Œ›s
(
sc¡_tgt_‹m¶©e
 *
v‰
);

528 
sc¡_þ—nup_´oc_rg‘_dœ_’Œ›s
(
sc¡_tgt_‹m¶©e
 *
v‰
);

529 
sc¡_bužd_´oc_rg‘_’Œ›s
(
sc¡_tgt
 *
v‰
);

530 
sc¡_þ—nup_´oc_rg‘_’Œ›s
(
sc¡_tgt
 *
v‰
);

531 
sc¡_bužd_´oc_dev_hªdËr_dœ_’Œ›s
(
sc¡_dev_ty³
 *
dev_ty³
);

532 
sc¡_þ—nup_´oc_dev_hªdËr_dœ_’Œ›s
(
sc¡_dev_ty³
 *
dev_ty³
);

534 
šlše
 
	$sc¡_sysfs_š™
()

537 
	}
}

538 
šlše
 
	$sc¡_sysfs_þ—nup
(è{ 
	}
}

540 
šlše
 
	$sc¡_devt_dev_sysfs_ü—‹
(
sc¡_deviû
 *
dev
)

543 
	}
}

544 
šlše
 
	$sc¡_devt_dev_sysfs_d–
(
sc¡_deviû
 *
dev
è{ 
	}
}

546 
šlše
 
	$sc¡_dev_sysfs_d–
(
sc¡_deviû
 *
dev
è{ 
	}
}

548 
šlše
 
	$sc¡_dev_sysfs_dif_ü—‹
(
sc¡_deviû
 *
dev
)

551 
	}
}

553 
šlše
 
	$sc¡_tgt_dev_sysfs_ü—‹
(
sc¡_tgt_dev
 *
tgt_dev
)

556 
	}
}

557 
šlše
 
	$sc¡_tgt_dev_sysfs_d–
(
sc¡_tgt_dev
 *
tgt_dev
è{ 
	}
}

559 
šlše
 
	$sc¡_£ss_sysfs_ü—‹
(
sc¡_£ssiÚ
 *
£ss
)

562 
	}
}

564 
šlše
 
	$sc¡_acg_dev_sysfs_ü—‹
(
sc¡_acg_dev
 *
acg_dev
,

565 
kobjeù
 *
·»Á
)

568 
	}
}

570 
šlše
 
	$sc¡_acg_dev_sysfs_d–
(
sc¡_acg_dev
 *
acg_dev
è{ 
	}
}

572 
šlše
 
	$sc¡_aú_sysfs_ü—‹
(
sc¡_aú
 *
aú
)

575 
	}
}

576 
šlše
 
	$sc¡_aú_sysfs_d–
(
sc¡_aú
 *
aú
è{ 
	}
}

580 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 34)

581 cÚ¡ 
sysfs_Ýs
 
sc¡_sysfs_Ýs
;

583 
sysfs_Ýs
 
sc¡_sysfs_Ýs
;

585 
sc¡_sysfs_š™
();

586 
sc¡_sysfs_þ—nup
();

587 
sc¡_tg‰_sysfs_ü—‹
(
sc¡_tgt_‹m¶©e
 *
tg‰
);

588 
sc¡_tg‰_sysfs_d–
(
sc¡_tgt_‹m¶©e
 *
tg‰
);

589 
sc¡_tgt_sysfs_ü—‹
(
sc¡_tgt
 *
tgt
);

590 
sc¡_tgt_sysfs_´•¬e_put
(
sc¡_tgt
 *
tgt
);

591 
sc¡_tgt_sysfs_d–
(
sc¡_tgt
 *
tgt
);

592 
sc¡_£ss_sysfs_ü—‹
(
sc¡_£ssiÚ
 *
£ss
);

593 
sc¡_£ss_sysfs_d–
(
sc¡_£ssiÚ
 *
£ss
);

594 
sc¡_»ü—‹_£ss_luns_lšk
(
sc¡_£ssiÚ
 *
£ss
);

595 
sc¡_add_sgv_kobj
(
kobjeù
 *
·»Á
, cÚ¡ *
Çme
);

596 
sc¡_d–_put_sgv_kobj
();

597 
sc¡_devt_sysfs_ü—‹
(
sc¡_dev_ty³
 *
devt
);

598 
sc¡_devt_sysfs_d–
(
sc¡_dev_ty³
 *
devt
);

599 
sc¡_dev_sysfs_ü—‹
(
sc¡_deviû
 *
dev
);

600 
sc¡_dev_sysfs_d–
(
sc¡_deviû
 *
dev
);

601 
sc¡_dev_sysfs_dif_ü—‹
(
sc¡_deviû
 *
dev
);

602 
sc¡_tgt_dev_sysfs_ü—‹
(
sc¡_tgt_dev
 *
tgt_dev
);

603 
sc¡_tgt_dev_sysfs_d–
(
sc¡_tgt_dev
 *
tgt_dev
);

604 
sc¡_devt_dev_sysfs_ü—‹
(
sc¡_deviû
 *
dev
);

605 
sc¡_devt_dev_sysfs_d–
(
sc¡_deviû
 *
dev
);

606 
sc¡_acg_sysfs_ü—‹
(
sc¡_tgt
 *
tgt
,

607 
sc¡_acg
 *
acg
);

608 
sc¡_acg_sysfs_d–
(
sc¡_acg
 *
acg
);

609 
sc¡_acg_dev_sysfs_ü—‹
(
sc¡_acg_dev
 *
acg_dev
,

610 
kobjeù
 *
·»Á
);

611 
sc¡_acg_dev_sysfs_d–
(
sc¡_acg_dev
 *
acg_dev
);

612 
sc¡_aú_sysfs_ü—‹
(
sc¡_aú
 *
aú
);

613 
sc¡_aú_sysfs_d–
(
sc¡_aú
 *
aú
);

621 
šlše
 
boÞ
 
	$sc¡_dev_»£rved
(
sc¡_deviû
 *
dev
)

623  
dev
->
þ_Ýs
->
	`»£rved
(dev);

624 
	}
}

628 
šlše
 
	$sc¡_»s_lock
(
sc¡_deviû
 *
dev
,

629 
sc¡_lksb
 *
´_lksb
)

630 
	`__acquœes
(&
dev
->
dev_lock
)

632 
dev
->
þ_Ýs
->
	`»s_lock
(dev, 
´_lksb
);

633 
	}
}

635 
šlše
 
	$sc¡_»s_uÆock
(
sc¡_deviû
 *
dev
,

636 
sc¡_lksb
 *
´_lksb
)

637 
	`__»Ëa£s
(&
dev
->
dev_lock
)

639 
dev
->
þ_Ýs
->
	`»s_uÆock
(dev, 
´_lksb
);

640 
	}
}

646 
šlše
 
boÞ
 
	$sc¡_is_»£rv©iÚ_hÞd”
(
sc¡_deviû
 *
dev
,

647 
sc¡_£ssiÚ
 *
£ss
)

649 
	`EXTRACHECKS_BUG_ON
(
£ss
 =ð
NULL
);

650  
dev
->
þ_Ýs
->
	`is_rsv_hÞd”
(dev, 
£ss
);

651 
	}
}

657 
šlše
 
boÞ
 
	$sc¡_is_nÙ_»£rv©iÚ_hÞd”
(
sc¡_deviû
 *
dev
,

658 
sc¡_£ssiÚ
 *
£ss
)

660 
	`EXTRACHECKS_BUG_ON
(
£ss
 =ð
NULL
);

661  
dev
->
þ_Ýs
->
	`is_nÙ_rsv_hÞd”
(dev, 
£ss
);

662 
	}
}

664 
šlše
 
	$sc¡_»£rve_dev
(
sc¡_deviû
 *
dev
,

665 
sc¡_£ssiÚ
 *
£ss
)

667 
	`lockd•_as£¹_h–d
(&
dev
->
dev_lock
);

668 
	`EXTRACHECKS_BUG_ON
(
£ss
 =ð
NULL
);

669 
dev
->
þ_Ýs
->
	`»£rve
(dev, 
£ss
);

670 
	}
}

672 
šlše
 
	$sc¡_þ—r_dev_»£rv©iÚ
(
sc¡_deviû
 *
dev
)

674 
	`lockd•_as£¹_h–d
(&
dev
->
dev_lock
);

675 
dev
->
þ_Ýs
->
	`»£rve
(dev, 
NULL
);

676 
	}
}

678 
sc¡_tgt_dev_d–_ä“_UA
(
sc¡_tgt_dev
 *
tgt_dev
,

679 
sc¡_tgt_dev_UA
 *
ua
);

680 
sc¡_dev_check_£t_UA
(
sc¡_deviû
 *
dev
,

681 
sc¡_cmd
 *
exþude
, cÚ¡ 
ušt8_t
 *
£n£
, 
£n£_Ën
);

682 
sc¡_dev_check_£t_loÿl_UA
(
sc¡_deviû
 *
dev
,

683 
sc¡_cmd
 *
exþude
, cÚ¡ 
ušt8_t
 *
£n£
, 
£n£_Ën
);

685 
	#SCST_SET_UA_FLAG_AT_HEAD
 1

	)

686 
	#SCST_SET_UA_FLAG_GLOBAL
 2

	)

688 
sc¡_check_£t_UA
(
sc¡_tgt_dev
 *
tgt_dev
,

689 cÚ¡ 
ušt8_t
 *
£n£
, 
£n£_Ën
, 
æags
);

690 
sc¡_£t_³ndšg_UA
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
buf
, *
size
);

692 
sc¡_»pÜt_luns_chªged
(
sc¡_acg
 *
acg
);

694 
sc¡_abÜt_cmd
(
sc¡_cmd
 *
cmd
, 
sc¡_mgmt_cmd
 *
mcmd
,

695 
boÞ
 
Ùh”_ši
, boÞ 
ÿÎ_dev_sk_mgmt_â
);

696 
sc¡_´oûss_»£t
(
sc¡_deviû
 *
dev
,

697 
sc¡_£ssiÚ
 *
Üigš©Ü
, 
sc¡_cmd
 *
exþude_cmd
,

698 
sc¡_mgmt_cmd
 *
mcmd
, 
boÞ
 
£tUA
);

699 
sc¡_unblock_abÜ‹d_cmds
(cÚ¡ 
sc¡_tgt
 *
tgt
,

700 cÚ¡ 
sc¡_£ssiÚ
 *
£ss
, cÚ¡ 
sc¡_deviû
 *
deviû
,

701 
boÞ
 
sc¡_mu‹x_h–d
);

703 
boÞ
 
sc¡_is_ua_glob®
(cÚ¡ 
ušt8_t
 *
£n£
, 
Ën
);

704 
sc¡_»queue_ua
(
sc¡_cmd
 *
cmd
, cÚ¡ 
ušt8_t
 *
buf
, 
size
);

706 
sc¡_«n
 *
sc¡_®loc_«n
(
sc¡_£ssiÚ
 *
£ss
,

707 
ušt64_t
 
uÅacked_lun
);

708 
sc¡_ä“_«n
(
sc¡_«n
 *
«n
);

710 
sc¡_g’_«n_Ü_ua
(
sc¡_tgt_dev
 *
tgt_dev
,

711 
key
, 
asc
, 
ascq
);

720 
sc¡_block_dev
(
sc¡_deviû
 *
dev
);

721 
sc¡_unblock_dev
(
sc¡_deviû
 *
dev
);

722 
boÞ
 
sc¡_do_check_blocked_dev
(
sc¡_cmd
 *
cmd
);

723 
boÞ
 
__sc¡_check_blocked_dev
(
sc¡_cmd
 *
cmd
);

724 
__sc¡_check_unblock_dev
(
sc¡_cmd
 *
cmd
);

725 
sc¡_check_unblock_dev
(
sc¡_cmd
 *
cmd
);

727 
	#SCST_EXT_BLOCK_SYNC
 1

	)

728 
	#SCST_EXT_BLOCK_STPG
 2

	)

729 
sc¡_ext_block_dev
(
sc¡_deviû
 *
dev
, 
ext_block”_dÚe_â_t
 
dÚe_â
,

730 cÚ¡ 
ušt8_t
 *
´iv
, 
´iv_Ën
, 
æags
);

731 
sc¡_ext_unblock_dev
(
sc¡_deviû
 *
dev
, 
boÞ
 
¡pg
);

732 
__sc¡_ext_blockšg_dÚe
(
sc¡_deviû
 *
dev
);

733 
sc¡_ext_blockšg_dÚe
(
sc¡_deviû
 *
dev
);

735 
sc¡_g‘_su¥’d_couÁ
();

741 
šlše
 
©omic_t
 *
	$sc¡_g‘
()

743 
©omic_t
 *
a
;

748 
a
 = &
sc¡_³rýu_šfos
[
	`¿w_smp_´oûssÜ_id
()].
ýu_cmd_couÁ
;

749 
	`©omic_šc
(
a
);

750 
	`TRACE_DBG
("Incrementing cpu_cmd_count %p (new value %d)",

751 
a
, 
	`©omic_»ad
(a));

753 
	`smp_mb__aá”_©omic_šc
();

755  
a
;

756 
	}
}

763 
šlše
 
	$sc¡_put
(
©omic_t
 *
a
)

765 
f
;

767 
f
 = 
	`©omic_dec_ªd_‹¡
(
a
);

769 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_FLAG_SUSPENDED
, &
sc¡_æags
)è&& 
f
) {

770 
	`TRACE_MGMT_DBG
("%s", "Waking up scst_dev_cmd_waitQ");

771 
	`wake_up_®l
(&
sc¡_dev_cmd_wa™Q
);

773 
	`TRACE_DBG
("Decrementing cpu_cmd_count %p (new value %d)",

774 
a
, 
	`©omic_»ad
(a));

775 
	}
}

777 
sc¡_g‘_cmd_couÁ”
();

779 
sc¡_sched_£ssiÚ_ä“
(
sc¡_£ssiÚ
 *
£ss
);

781 
šlše
 
	$sc¡_£ss_g‘
(
sc¡_£ssiÚ
 *
£ss
)

783 
	`©omic_šc
(&
£ss
->
»fút
);

784 
	`TRACE_DBG
("Incrementing sess %p„efcnt (new value %d)",

785 
£ss
, 
	`©omic_»ad
(&£ss->
»fút
));

786 
	}
}

788 
šlše
 
	$sc¡_£ss_put
(
sc¡_£ssiÚ
 *
£ss
)

790 
	`TRACE_DBG
("Decrementing sess %p„efcnt (new value %d)",

791 
£ss
, 
	`©omic_»ad
(&£ss->
»fút
)-1);

792 ià(
	`©omic_dec_ªd_‹¡
(&
£ss
->
»fút
))

793 
	`sc¡_sched_£ssiÚ_ä“
(
£ss
);

794 
	}
}

796 
sc¡_cmd
 *
sc¡_®loc_cmd
(cÚ¡ 
ušt8_t
 *
cdb
,

797 
cdb_Ën
, 
gå_t
 
gå_mask
);

798 
sc¡_´e_š™_cmd
(
sc¡_cmd
 *
cmd
, cÚ¡ 
ušt8_t
 *
cdb
,

799 
cdb_Ën
, 
gå_t
 
gå_mask
);

800 
sc¡_ä“_cmd
(
sc¡_cmd
 *
cmd
);

802 
šlše
 
	$__sc¡_cmd_g‘
(
sc¡_cmd
 *
cmd
)

804 
	`©omic_šc
(&
cmd
->
cmd_»f
);

805 
	`smp_mb__aá”_©omic_šc
();

806 
	`TRACE_DBG
("Incrementing cmd %p„ef (new value %d)",

807 
cmd
, 
	`©omic_»ad
(&cmd->
cmd_»f
));

808 
	}
}

810 
šlše
 
	$__sc¡_cmd_put
(
sc¡_cmd
 *
cmd
)

812 
	`TRACE_DBG
("Decrementing cmd %p„ef (new value %d)",

813 
cmd
, 
	`©omic_»ad
(&cmd->
cmd_»f
)-1);

814 ià(
	`©omic_dec_ªd_‹¡
(&
cmd
->
cmd_»f
))

815 
	`sc¡_ä“_cmd
(
cmd
);

816 
	}
}

818 
sc¡_thrÙŽe_cmd
(
sc¡_cmd
 *
cmd
);

819 
sc¡_uÁhrÙŽe_cmd
(
sc¡_cmd
 *
cmd
);

821 
sc¡_do_š‹º®_·rsšg
(
sc¡_cmd
 *
cmd
);

822 
sc¡_·r£_desütÜs
(
sc¡_cmd
 *
cmd
);

824 
sc¡_cmp_wr_loÿl
(
sc¡_cmd
 *
cmd
);

826 
sc¡_´_š™
(
sc¡_deviû
 *
dev
);

827 
sc¡_´_þ—nup
(
sc¡_deviû
 *
dev
);

829 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 39)

830 
sc¡_vfs_uÆšk_ªd_put
(
Çmeid©a
 *
nd
);

832 
sc¡_vfs_uÆšk_ªd_put
(
·th
 *path);

835 
sc¡_cÝy_fže
(cÚ¡ *
¤c
, cÚ¡ *
de¡
);

837 
sc¡_cmd
 *
__sc¡_ü—‹_´•¬e_š‹º®_cmd
(cÚ¡ 
ušt8_t
 *
cdb
,

838 
cdb_Ën
, 
sc¡_cmd_queue_ty³
 
queue_ty³
,

839 
sc¡_tgt_dev
 *
tgt_dev
, 
gå_t
 
gå_mask
, 
boÞ
 
çÁom
);

841 
šlše
 
boÞ
 
	$sc¡_lba1_šside_lba2
(
št64_t
 
lba1
,

842 
št64_t
 
lba2
, iÁ64_ˆ
lba2_blocks
)

844 
boÞ
 
»s
;

846 
	`TRACE_DBG
("lba1 %Îd,†ba2 %Îd,†ba2_block %Îd", ()
lba1
,

847 ()
lba2
, ()
lba2_blocks
);

849 ià((
lba1
 >ð
lba2
è&& (lba1 < (lba2 + 
lba2_blocks
)))

850 
»s
 = 
Œue
;

852 
»s
 = 
çl£
;

854 
	`TRACE_EXIT_RES
(
»s
);

855  
»s
;

856 
	}
}

858 #iâdeà
CONFIG_SCST_PROC


860 
sc¡_cm_Ú_dev_»gi¡”
(
sc¡_deviû
 *
dev
);

861 
sc¡_cm_Ú_dev_uÄegi¡”
(
sc¡_deviû
 *
dev
);

863 
sc¡_cm_Ú_add_acg
(
sc¡_acg
 *
acg
);

864 
sc¡_cm_Ú_d–_acg
(
sc¡_acg
 *
acg
);

865 
sc¡_cm_Ú_add_lun
(
sc¡_acg_dev
 *
acg_dev
, 
ušt64_t
 
lun
,

866 *
æags
);

867 
boÞ
 
sc¡_cm_Ú_d–_lun
(
sc¡_acg_dev
 *
acg_dev
,

868 
boÞ
 
g’_»pÜt_luns_chªged
);

870 
sc¡_cm_·r£_desütÜs
(
sc¡_cmd
 *
cmd
);

871 
sc¡_cm_ä“_desütÜs
(
sc¡_cmd
 *
cmd
);

873 
sc¡_cm_ext_cÝy_exec
(
sc¡_cmd
 *
cmd
);

874 
sc¡_cm_rcv_cÝy_»s_exec
(
sc¡_cmd
 *
cmd
);

876 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 20)

877 
£ss_cm_li¡_id_þ—nup_wÜk_â
(*
p
);

879 
£ss_cm_li¡_id_þ—nup_wÜk_â
(
wÜk_¡ruù
 *
wÜk
);

881 
sc¡_cm_ä“_³ndšg_li¡_ids
(
sc¡_£ssiÚ
 *
£ss
);

883 
boÞ
 
sc¡_cm_check_block_®l_devs
(
sc¡_cmd
 *
cmd
);

884 
sc¡_cm_abÜt_ec_cmd
(
sc¡_cmd
 *
ec_cmd
);

886 
boÞ
 
sc¡_cm_ec_cmd_ov”Ïp
(
sc¡_cmd
 *
ec_cmd
, sc¡_cmd *
cmd
);

888 
sc¡_cm_š™
();

889 
sc¡_cm_ex™
();

893 
šlše
 
	$sc¡_cm_Ú_dev_»gi¡”
(
sc¡_deviû
 *
dev
è{  0; 
	}
}

894 
šlše
 
	$sc¡_cm_Ú_dev_uÄegi¡”
(
sc¡_deviû
 *
dev
è{
	}
}

896 
šlše
 
	$sc¡_cm_Ú_add_acg
(
sc¡_acg
 *
acg
)

899 
	}
}

901 
šlše
 
	$sc¡_cm_Ú_d–_acg
(
sc¡_acg
 *
acg
)

903 
	}
}

905 
šlše
 
	$sc¡_cm_Ú_add_lun
(
sc¡_acg_dev
 *
acg_dev
, 
ušt64_t
 
lun
,

906 *
æags
)

909 
	}
}

911 
šlše
 
boÞ
 
	$sc¡_cm_Ú_d–_lun
(
sc¡_acg_dev
 *
acg_dev
,

912 
boÞ
 
g’_»pÜt_luns_chªged
)

914  
g’_»pÜt_luns_chªged
;

915 
	}
}

917 
šlše
 
	$sc¡_cm_·r£_desütÜs
(
sc¡_cmd
 *
cmd
)

919 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

920 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

922 
	}
}

923 
šlše
 
	$sc¡_cm_ä“_desütÜs
(
sc¡_cmd
 *
cmd
è{
	}
}

925 
šlše
 
	$sc¡_cm_ext_cÝy_exec
(
sc¡_cmd
 *
cmd
)

927  
SCST_EXEC_NOT_COMPLETED
;

928 
	}
}

929 
šlše
 
	$sc¡_cm_rcv_cÝy_»s_exec
(
sc¡_cmd
 *
cmd
)

931  
SCST_EXEC_NOT_COMPLETED
;

932 
	}
}

934 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 20)

935 
šlše
 
	$£ss_cm_li¡_id_þ—nup_wÜk_â
(*
p
è{
	}
}

937 
šlše
 
	$£ss_cm_li¡_id_þ—nup_wÜk_â
(
wÜk_¡ruù
 *
wÜk
è{
	}
}

939 
šlše
 
	$sc¡_cm_ä“_³ndšg_li¡_ids
(
sc¡_£ssiÚ
 *
£ss
è{
	}
}

941 
šlše
 
boÞ
 
	$sc¡_cm_check_block_®l_devs
(
sc¡_cmd
 *
cmd
è{  
çl£
; 
	}
}

942 
šlše
 
	$sc¡_cm_abÜt_ec_cmd
(
sc¡_cmd
 *
ec_cmd
è{
	}
}

944 
šlše
 
boÞ
 
	$sc¡_cm_ec_cmd_ov”Ïp
(
sc¡_cmd
 *
ec_cmd
, sc¡_cmd *
cmd
)

946  
çl£
;

947 
	}
}

949 
šlše
 
	$sc¡_cm_š™
(è{  0; 
	}
}

950 
šlše
 
	$sc¡_cm_ex™
(è{
	}
}

954 #ifdeà
CONFIG_SCST_DEBUG_TM


955 
tm_dbg_check_»Ëa£d_cmds
();

956 
tm_dbg_check_cmd
(
sc¡_cmd
 *
cmd
);

957 
tm_dbg_»Ëa£_cmd
(
sc¡_cmd
 *
cmd
);

958 
tm_dbg_sk_mgmt
(
sc¡_deviû
 *
dev
, cÚ¡ *
â
,

959 
fÜû
);

960 
tm_dbg_is_»Ëa£
();

962 
šlše
 
	$tm_dbg_check_»Ëa£d_cmds
(è{
	}
}

963 
šlše
 
	$tm_dbg_check_cmd
(
sc¡_cmd
 *
cmd
)

966 
	}
}

967 
šlše
 
	$tm_dbg_»Ëa£_cmd
(
sc¡_cmd
 *
cmd
è{
	}
}

968 
šlše
 
	$tm_dbg_sk_mgmt
(
sc¡_deviû
 *
dev
, cÚ¡ *
â
,

969 
fÜû
è{
	}
}

970 
šlše
 
	$tm_dbg_is_»Ëa£
()

973 
	}
}

976 #ifdeà
CONFIG_SCST_DEBUG_SN


977 
sc¡_check_debug_¢
(
sc¡_cmd
 *
cmd
);

979 
šlše
 
	$sc¡_check_debug_¢
(
sc¡_cmd
 *
cmd
è{
	}
}

982 
šlše
 
	$sc¡_¢_befÜe
(
ušt32_t
 
£q1
, ušt32_ˆ
£q2
)

984  (
št32_t
)(
£q1
-
£q2
) < 0;

985 
	}
}

987 
g’_»Ïtive_rg‘_pÜt_id
(
ušt16_t
 *
id
);

988 
boÞ
 
sc¡_is_»Ïtive_rg‘_pÜt_id_unique
(
ušt16_t
 
id
,

989 cÚ¡ 
sc¡_tgt
 *
t
);

991 
sc¡_ev’t_š™
();

992 
sc¡_ev’t_ex™
();

994 
sc¡_ev’t_queue_lun_nÙ_found
(cÚ¡ 
sc¡_cmd
 *
cmd
);

995 
sc¡_ev’t_queue_Ãg©ive_luns_šquœy
(cÚ¡ 
sc¡_tgt
 *
tgt
,

996 cÚ¡ *
š™ŸtÜ_Çme
);

997 
sc¡_ev’t_queue_ext_blockšg_dÚe
(
sc¡_deviû
 *
dev
, *
d©a
, 
Ën
);

998 
sc¡_ev’t_queue_tm_â_»ûived
(
sc¡_mgmt_cmd
 *
mcmd
);

1000 
	t__´štf
(2, 3è(*
	tsc¡_show_â
)(*
	t¬g
, cÚ¡ *
	tfmt
, ...);

1001 
sc¡_Œaû_cmds
(
sc¡_show_â
 
show
, *
¬g
);

1002 
sc¡_Œaû_mcmds
(
sc¡_show_â
 
show
, *
¬g
);

1004 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


1006 
sc¡_£t_¡¬t_time
(
sc¡_cmd
 *
cmd
);

1007 
sc¡_£t_cur_¡¬t
(
sc¡_cmd
 *
cmd
);

1008 
sc¡_£t_·r£_time
(
sc¡_cmd
 *
cmd
);

1009 
sc¡_£t_®loc_buf_time
(
sc¡_cmd
 *
cmd
);

1010 
sc¡_£t_»¡¬t_wa™šg_time
(
sc¡_cmd
 *
cmd
);

1011 
sc¡_£t_rdy_to_xãr_time
(
sc¡_cmd
 *
cmd
);

1012 
sc¡_£t_´e_exec_time
(
sc¡_cmd
 *
cmd
);

1013 
sc¡_£t_exec_¡¬t
(
sc¡_cmd
 *
cmd
);

1014 
sc¡_£t_exec_time
(
sc¡_cmd
 *
cmd
);

1015 
sc¡_£t_dev_dÚe_time
(
sc¡_cmd
 *
cmd
);

1016 
sc¡_£t_xm™_time
(
sc¡_cmd
 *
cmd
);

1017 
sc¡_upd©e_Ït_¡©s
(
sc¡_cmd
 *
cmd
);

1021 
šlše
 
	$sc¡_£t_¡¬t_time
(
sc¡_cmd
 *
cmd
è{
	}
}

1022 
šlše
 
	$sc¡_£t_cur_¡¬t
(
sc¡_cmd
 *
cmd
è{
	}
}

1023 
šlše
 
	$sc¡_£t_·r£_time
(
sc¡_cmd
 *
cmd
è{
	}
}

1024 
šlše
 
	$sc¡_£t_®loc_buf_time
(
sc¡_cmd
 *
cmd
è{
	}
}

1025 
šlše
 
	$sc¡_£t_»¡¬t_wa™šg_time
(
sc¡_cmd
 *
cmd
è{
	}
}

1026 
šlše
 
	$sc¡_£t_rdy_to_xãr_time
(
sc¡_cmd
 *
cmd
è{
	}
}

1027 
šlše
 
	$sc¡_£t_´e_exec_time
(
sc¡_cmd
 *
cmd
è{
	}
}

1028 
šlše
 
	$sc¡_£t_exec_¡¬t
(
sc¡_cmd
 *
cmd
è{
	}
}

1029 
šlše
 
	$sc¡_£t_exec_time
(
sc¡_cmd
 *
cmd
è{
	}
}

1030 
šlše
 
	$sc¡_£t_dev_dÚe_time
(
sc¡_cmd
 *
cmd
è{
	}
}

1031 
šlše
 
	$sc¡_£t_xm™_time
(
sc¡_cmd
 *
cmd
è{
	}
}

1032 
šlše
 
	$sc¡_upd©e_Ït_¡©s
(
sc¡_cmd
 *
cmd
è{
	}
}

	@scst/src/scst_proc.c

19 
	~<lšux/moduË.h
>

21 
	~<lšux/š™.h
>

22 
	~<lšux/k”Ãl.h
>

23 
	~<lšux/”ºo.h
>

24 
	~<lšux/li¡.h
>

25 
	~<lšux/¥šlock.h
>

26 
	~<lšux/¦ab.h
>

27 
	~<lšux/sched.h
>

28 
	~<lšux/uni¡d.h
>

29 
	~<lšux/¡ršg.h
>

30 
	~<lšux/´oc_fs.h
>

31 
	~<lšux/£q_fže.h
>

33 #ifdeà
INSIDE_KERNEL_TREE


34 
	~<sc¡/sc¡.h
>

36 
	~"sc¡.h
"

38 
	~"sc¡_´iv.h
"

39 
	~"sc¡_mem.h
"

40 
	~"sc¡_´es.h
"

42 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(3, 10, 0)

43 
	~<../fs/´oc/š‹º®.h
>

44 #–ià!
defšed
(
RHEL_MAJOR
è|| RHEL_MAJOR -0 < 6 || 
RHEL_MINOR
 -0 < 5

51 
šlše
 *
	$PDE_DATA
(cÚ¡ 
šode
 *inode)

53  
	`PROC_I
(
šode
)->
pde
->
d©a
;

54 
	}
}

57 
sc¡_´oc_š™_groups
();

58 
sc¡_´oc_þ—nup_groups
();

59 
sc¡_´oc_assign_hªdËr
(*
buf
);

60 
sc¡_´oc_group_add
(cÚ¡ *
p
, 
addr_m‘hod
);

61 
sc¡_´oc_d–_ä“_acg
(
sc¡_acg
 *
acg
, 
»move_´oc
);

63 
sc¡_´oc_d©a
 
	gsc¡_v”siÚ_´oc_d©a
;

64 
sc¡_´oc_d©a
 
	gsc¡_h–p_´oc_d©a
;

65 
sc¡_´oc_d©a
 
	gsc¡_sgv_´oc_d©a
;

66 
sc¡_´oc_d©a
 
	gsc¡_groups_Çmes_´oc_d©a
;

67 
sc¡_´oc_d©a
 
	gsc¡_groups_deviûs_´oc_d©a
;

68 
sc¡_´oc_d©a
 
	gsc¡_groups_addr_m‘hod_´oc_d©a
;

69 
sc¡_´oc_d©a
 
	gsc¡_£ssiÚs_´oc_d©a
;

70 
sc¡_´oc_d©a
 
	gsc¡_dev_hªdËr_ty³_´oc_d©a
;

71 
sc¡_´oc_d©a
 
	gsc¡_tgt_´oc_d©a
;

72 
sc¡_´oc_d©a
 
	gsc¡_th»ads_´oc_d©a
;

73 
sc¡_´oc_d©a
 
	gsc¡_scsi_tgt_´oc_d©a
;

74 
sc¡_´oc_d©a
 
	gsc¡_dev_hªdËr_´oc_d©a
;

80 
	#SCST_PROC_BLOCK_SIZE
 (
PAGE_SIZE
 - 512)

	)

82 
	#SCST_PROC_LOG_ENTRY_NAME
 "Œaû_Ëv–"

	)

83 
	#SCST_PROC_DEV_HANDLER_TYPE_ENTRY_NAME
 "ty³"

	)

84 
	#SCST_PROC_VERSION_NAME
 "v”siÚ"

	)

85 
	#SCST_PROC_SESSIONS_NAME
 "£ssiÚs"

	)

86 
	#SCST_PROC_HELP_NAME
 "h–p"

	)

87 
	#SCST_PROC_THREADS_NAME
 "th»ads"

	)

88 
	#SCST_PROC_GROUPS_ENTRY_NAME
 "groups"

	)

89 
	#SCST_PROC_GROUPS_DEVICES_ENTRY_NAME
 "deviûs"

	)

90 
	#SCST_PROC_GROUPS_USERS_ENTRY_NAME
 "Çmes"

	)

91 
	#SCST_PROC_GROUPS_ADDR_METHOD_ENTRY_NAME
 "addr_m‘hod"

	)

93 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


94 
	#SCST_PROC_LAT_ENTRY_NAME
 "Ï‹ncy"

	)

97 
	#SCST_PROC_ACTION_ALL
 1

	)

98 
	#SCST_PROC_ACTION_NONE
 2

	)

99 
	#SCST_PROC_ACTION_DEFAULT
 3

	)

100 
	#SCST_PROC_ACTION_ADD
 4

	)

101 
	#SCST_PROC_ACTION_CLEAR
 5

	)

102 
	#SCST_PROC_ACTION_MOVE
 6

	)

103 
	#SCST_PROC_ACTION_DEL
 7

	)

104 
	#SCST_PROC_ACTION_REPLACE
 8

	)

105 
	#SCST_PROC_ACTION_VALUE
 9

	)

106 
	#SCST_PROC_ACTION_ASSIGN
 10

	)

107 
	#SCST_PROC_ACTION_ADD_GROUP
 11

	)

108 
	#SCST_PROC_ACTION_DEL_GROUP
 12

	)

109 
	#SCST_PROC_ACTION_RENAME_GROUP
 13

	)

110 
	#SCST_PROC_ACTION_DUMP_PRS
 14

	)

112 
´oc_dœ_’Œy
 *
	gsc¡_´oc_scsi_tgt
;

113 
´oc_dœ_’Œy
 *
	gsc¡_´oc_groups_roÙ
;

115 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

116 
sc¡_´oc_d©a
 
	gsc¡_log_´oc_d©a
;

118 
sc¡_Œaû_log
 
	gsc¡_´oc_Œaû_tbl
[] = {

119 { 
TRACE_OUT_OF_MEM
, "out_of_mem" },

120 { 
TRACE_MINOR
, "minor" },

121 { 
TRACE_SG_OP
, "sg" },

122 { 
TRACE_MEMORY
, "mem" },

123 { 
TRACE_BUFF
, "buff" },

124 #iâdeà
GENERATING_UPSTREAM_PATCH


125 { 
TRACE_ENTRYEXIT
, "entryexit" },

127 { 
TRACE_PID
, "pid" },

128 { 
TRACE_LINE
, "line" },

129 { 
TRACE_FUNCTION
, "function" },

130 { 
TRACE_DEBUG
, "debug" },

131 { 
TRACE_SPECIAL
, "special" },

132 { 
TRACE_SCSI
, "scsi" },

133 { 
TRACE_MGMT
, "mgmt" },

134 { 
TRACE_MGMT_DEBUG
, "mgmt_dbg" },

135 { 
TRACE_FLOW_CONTROL
, "flow_control" },

136 { 
TRACE_PRES
, "pr" },

137 { 0, 
NULL
 }

140 
sc¡_Œaû_log
 
	gsc¡_´oc_loÿl_Œaû_tbl
[] = {

141 { 
TRACE_RTRY
, "retry" },

142 { 
TRACE_SCSI_SERIALIZING
, "scsi_serializing" },

143 { 
TRACE_DATA_SEND
, "data_send" },

144 { 
TRACE_DATA_RECEIVED
, "data_received" },

145 { 
TRACE_BLOCKING
, "block" },

146 { 0, 
NULL
 }

150 *
	gsc¡_´oc_h–p_¡ršg
 =

173 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

189 *
	gsc¡_´oc_dev_hªdËr_ty³
[] = {

208 
DEFINE_MUTEX
(
sc¡_´oc_mu‹x
);

210 
	~<lšux/ùy³.h
>

212 #ià(
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 22)è&& (!
defšed
(
RHEL_RELEASE_CODE
) || RHEL_RELEASE_CODE -0 < 5 * 256 + 3)

213 #ià!
defšed
(
CONFIG_PPC
)

234 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

235 
	$¡rÿ£cmp
(cÚ¡ *
s1
, cÚ¡ *
s2
)

237 
c1
, 
c2
;

239 
c1
 = 
	`tÞow”
(*
s1
++);

240 
c2
 = 
	`tÞow”
(*
s2
++);

241 } 
c1
 =ð
c2
 && c1 != 0);

242  
c1
 - 
c2
;

243 
	}
}

246 
	$¡ºÿ£cmp
(cÚ¡ *
s1
, cÚ¡ *
s2
, 
size_t
 
n
)

248 
c1
, 
c2
;

250 
c1
 = 
	`tÞow”
(*
s1
++);

251 
c2
 = 
	`tÞow”
(*
s2
++);

252 } (--
n
 > 0è&& 
c1
 =ð
c2
 && c1 != 0);

253  
c1
 - 
c2
;

254 
	}
}

259 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

261 
DEFINE_MUTEX
(
sc¡_log_mu‹x
);

263 
	$sc¡_´oc_log_’Œy_wr™e
(
fže
 *fže, cÚ¡ 
__u£r
 *
buf
,

264 
Ëngth
, *
log_Ëv–
,

265 
deçuÉ_Ëv–
, cÚ¡ 
sc¡_Œaû_log
 *
tbl
)

267 
»s
 = 
Ëngth
;

268 
aùiÚ
;

269 
Ëv–
 = 0, 
ÞdËv–
;

270 *
bufãr
, *
p
, *
e
;

271 cÚ¡ 
sc¡_Œaû_log
 *
t
;

272 *
d©a
 = 
	`PDE_DATA
(
	`fže_šode
(
fže
));

274 
	`TRACE_ENTRY
();

276 ià(
Ëngth
 > 
SCST_PROC_BLOCK_SIZE
) {

277 
»s
 = -
EOVERFLOW
;

278 
out
;

280 ià(!
buf
) {

281 
»s
 = -
EINVAL
;

282 
out
;

284 
bufãr
 = (*)
	`__g‘_ä“_·ge
(
GFP_KERNEL
);

285 ià(!
bufãr
) {

286 
»s
 = -
ENOMEM
;

287 
out
;

289 ià(
	`cÝy_äom_u£r
(
bufãr
, 
buf
, 
Ëngth
)) {

290 
»s
 = -
EFAULT
;

291 
out_ä“
;

293 ià(
Ëngth
 < 
PAGE_SIZE
) {

294 
bufãr
[
Ëngth
] = '\0';

295 } ià(
bufãr
[
PAGE_SIZE
-1]) {

296 
»s
 = -
EINVAL
;

297 
out_ä“
;

306 
p
 = 
bufãr
;

307 ià(!
	`¡ºÿ£cmp
("®l", 
p
, 3)) {

308 
aùiÚ
 = 
SCST_PROC_ACTION_ALL
;

309 } ià(!
	`¡ºÿ£cmp
("nÚe", 
p
, 4) || !strncasecmp("null",…, 4)) {

310 
aùiÚ
 = 
SCST_PROC_ACTION_NONE
;

311 } ià(!
	`¡ºÿ£cmp
("deçuÉ", 
p
, 7)) {

312 
aùiÚ
 = 
SCST_PROC_ACTION_DEFAULT
;

313 } ià(!
	`¡ºÿ£cmp
("add ", 
p
, 4)) {

314 
p
 += 4;

315 
aùiÚ
 = 
SCST_PROC_ACTION_ADD
;

316 } ià(!
	`¡ºÿ£cmp
("d– ", 
p
, 4)) {

317 
p
 += 4;

318 
aùiÚ
 = 
SCST_PROC_ACTION_DEL
;

319 } ià(!
	`¡ºÿ£cmp
("v®u", 
p
, 6)) {

320 
p
 += 6;

321 
aùiÚ
 = 
SCST_PROC_ACTION_VALUE
;

322 } ià(!
	`¡ºÿ£cmp
("dump_´ ", 
p
, 9)) {

323 
p
 += 9;

324 
aùiÚ
 = 
SCST_PROC_ACTION_DUMP_PRS
;

326 ià(
p
[
	`¡¾’
(p) - 1] == '\n')

327 
p
[
	`¡¾’
(p) - 1] = '\0';

328 
	`PRINT_ERROR
("UnknowÀaùiÚ \"%s\"", 
p
);

329 
»s
 = -
EINVAL
;

330 
out_ä“
;

333 
aùiÚ
) {

334 
SCST_PROC_ACTION_ALL
:

335 
Ëv–
 = 
TRACE_ALL
;

337 
SCST_PROC_ACTION_DEFAULT
:

338 
Ëv–
 = 
deçuÉ_Ëv–
;

340 
SCST_PROC_ACTION_NONE
:

341 
Ëv–
 = 
TRACE_NULL
;

343 
SCST_PROC_ACTION_ADD
:

344 
SCST_PROC_ACTION_DEL
:

345 
	`is¥aû
(*
p
) && *p != '\0')

346 
p
++;

347 
e
 = 
p
;

348 !
	`is¥aû
(*
e
) && *e != '\0')

349 
e
++;

350 *
e
 = 0;

351 ià(
tbl
) {

352 
t
 = 
tbl
;

353 
t
->
tok’
) {

354 ià(!
	`¡rÿ£cmp
(
p
, 
t
->
tok’
)) {

355 
Ëv–
 = 
t
->
v®
;

358 
t
++;

361 ià(
Ëv–
 == 0) {

362 
t
 = 
sc¡_´oc_Œaû_tbl
;

363 
t
->
tok’
) {

364 ià(!
	`¡rÿ£cmp
(
p
, 
t
->
tok’
)) {

365 
Ëv–
 = 
t
->
v®
;

368 
t
++;

371 ià(
Ëv–
 == 0) {

372 
	`PRINT_ERROR
("UnknowÀtok’ \"%s\"", 
p
);

373 
»s
 = -
EINVAL
;

374 
out_ä“
;

377 
SCST_PROC_ACTION_VALUE
:

378 
	`is¥aû
(*
p
) && *p != '\0')

379 
p
++;

380 
Ëv–
 = 
	`sim¶e_¡¹oul
(
p
, 
NULL
, 0);

382 
SCST_PROC_ACTION_DUMP_PRS
:

384 
sc¡_deviû
 *
dev
;

386 
	`is¥aû
(*
p
) && *p != '\0')

387 
p
++;

388 
e
 = 
p
;

389 !
	`is¥aû
(*
e
) && *e != '\0')

390 
e
++;

391 *
e
 = '\0';

393 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
) != 0) {

394 
»s
 = -
EINTR
;

395 
out_ä“
;

398 
	`li¡_fÜ_—ch_’Œy
(
dev
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

399 ià(
	`¡rcmp
(
dev
->
vœt_Çme
, 
p
) == 0) {

400 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
dev
->
dev_´_mu‹x
) == 0) {

401 
	`sc¡_´_dump_´s
(
dev
, 
Œue
);

402 
	`mu‹x_uÆock
(&
dev
->
dev_´_mu‹x
);

404 
»s
 = -
EINTR
;

406 
out_up
;

410 
	`PRINT_ERROR
("Deviû % nÙ found", 
p
);

411 
»s
 = -
ENOENT
;

412 
out_up
:

413 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

414 
out_ä“
;

418 
ÞdËv–
 = *
log_Ëv–
;

420 
aùiÚ
) {

421 
SCST_PROC_ACTION_ADD
:

422 *
log_Ëv–
 |ð
Ëv–
;

424 
SCST_PROC_ACTION_DEL
:

425 *
log_Ëv–
 &ð~
Ëv–
;

428 *
log_Ëv–
 = 
Ëv–
;

432 
	`PRINT_INFO
("Changedrace†evel for \"%s\": "

434 (*)
d©a
, 
ÞdËv–
, *
log_Ëv–
);

436 
out_ä“
:

437 
	`ä“_·ge
(()
bufãr
);

438 
out
:

439 
	`TRACE_EXIT_RES
(
»s
);

440  
»s
;

441 
	}
}

442 
EXPORT_SYMBOL_GPL
(
sc¡_´oc_log_’Œy_wr™e
);

444 
ssize_t
 
	$sc¡_´oc_scsi_tgt_g’_wr™e_log
(
fže
 *file,

445 cÚ¡ 
__u£r
 *
buf
,

446 
size_t
 
Ëngth
, 
loff_t
 *
off
)

448 
»s
;

450 
	`TRACE_ENTRY
();

452 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_log_mu‹x
) != 0) {

453 
»s
 = -
EINTR
;

454 
out
;

457 
»s
 = 
	`sc¡_´oc_log_’Œy_wr™e
(
fže
, 
buf
, 
Ëngth
,

458 &
Œaû_æag
, 
SCST_DEFAULT_LOG_FLAGS
,

459 
sc¡_´oc_loÿl_Œaû_tbl
);

461 
	`mu‹x_uÆock
(&
sc¡_log_mu‹x
);

463 
out
:

464 
	`TRACE_EXIT_RES
(
»s
);

465  
»s
;

466 
	}
}

470 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


472 *
	gsc¡_io_size_Çmes
[] = {

480 
	$Ït_šfo_show
(
£q_fže
 *
£q
, *
v
)

482 
»s
 = 0;

483 
sc¡_acg
 *
acg
;

484 
sc¡_£ssiÚ
 *
£ss
;

485 
buf
[50];

487 
	`TRACE_ENTRY
();

489 
	`BUILD_BUG_ON
(
SCST_LATENCY_STATS_NUM
 !ð
	`ARRAY_SIZE
(
sc¡_io_size_Çmes
));

490 
	`BUILD_BUG_ON
(
SCST_LATENCY_STATS_NUM
 !ð
	`ARRAY_SIZE
(
£ss
->
£ss_Ï‹ncy_¡©
));

492 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
) != 0) {

493 
»s
 = -
EINTR
;

494 
out
;

497 
	`li¡_fÜ_—ch_’Œy
(
acg
, &
sc¡_acg_li¡
, 
acg_li¡_’Œy
) {

498 
boÞ
 
h—d”_´š‹d
 = 
çl£
;

500 
	`li¡_fÜ_—ch_’Œy
(
£ss
, &
acg
->
acg_£ss_li¡
,

501 
acg_£ss_li¡_’Œy
) {

502 
i
;

503 
t
;

504 
ušt64_t
 
sc¡_time
, 
tgt_time
, 
dev_time
;

505 
ušt64_t
 
´oûs£d_cmds
;

507 ià(!
h—d”_´š‹d
) {

508 
	`£q_´štf
(
£q
, "%-15s %-15s %-46s %-46s %-46s\n",

511 
h—d”_´š‹d
 = 
Œue
;

514 
	`£q_´štf
(
£q
, "Target‚ame: %s\nInitiator‚ame: %s\n",

515 
£ss
->
tgt
->
tg‰
->
Çme
,

516 
£ss
->
š™ŸtÜ_Çme
);

518 
	`¥š_lock_bh
(&
£ss
->
Ït_lock
);

520 
i
 = 0; i < 
SCST_LATENCY_STATS_NUM
 ; i++) {

521 
ušt64_t
 
sc¡_time_wr
, 
tgt_time_wr
, 
dev_time_wr
;

522 
ušt64_t
 
´oûs£d_cmds_wr
;

523 
ušt64_t
 
sc¡_time_rd
, 
tgt_time_rd
, 
dev_time_rd
;

524 
ušt64_t
 
´oûs£d_cmds_rd
;

525 
sc¡_ext_Ï‹ncy_¡©
 *
Ï‹ncy_¡©
;

527 
Ï‹ncy_¡©
 = &
£ss
->
£ss_Ï‹ncy_¡©
[
i
];

528 
sc¡_time_wr
 = 
Ï‹ncy_¡©
->scst_time_wr;

529 
sc¡_time_rd
 = 
Ï‹ncy_¡©
->scst_time_rd;

530 
tgt_time_wr
 = 
Ï‹ncy_¡©
->tgt_time_wr;

531 
tgt_time_rd
 = 
Ï‹ncy_¡©
->tgt_time_rd;

532 
dev_time_wr
 = 
Ï‹ncy_¡©
->dev_time_wr;

533 
dev_time_rd
 = 
Ï‹ncy_¡©
->dev_time_rd;

534 
´oûs£d_cmds_wr
 = 
Ï‹ncy_¡©
->processed_cmds_wr;

535 
´oûs£d_cmds_rd
 = 
Ï‹ncy_¡©
->processed_cmds_rd;

537 
	`£q_´štf
(
£q
, "%-5s %-9s %-15llu ",

538 "Wr™e", 
sc¡_io_size_Çmes
[
i
],

539 
´oûs£d_cmds_wr
);

541 
	`sc¡_time_³r_cmd
(
sc¡_time_wr
, 
´oûs£d_cmds_wr
);

542 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

543 ()
Ï‹ncy_¡©
->
mš_sc¡_time_wr
,

544 ()
sc¡_time_wr
,

545 ()
Ï‹ncy_¡©
->
max_sc¡_time_wr
,

546 ()
Ï‹ncy_¡©
->
sc¡_time_wr
);

547 
	`£q_´štf
(
£q
, "%-46 ", 
buf
);

549 
	`sc¡_time_³r_cmd
(
tgt_time_wr
, 
´oûs£d_cmds_wr
);

550 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

551 ()
Ï‹ncy_¡©
->
mš_tgt_time_wr
,

552 ()
tgt_time_wr
,

553 ()
Ï‹ncy_¡©
->
max_tgt_time_wr
,

554 ()
Ï‹ncy_¡©
->
tgt_time_wr
);

555 
	`£q_´štf
(
£q
, "%-46 ", 
buf
);

557 
	`sc¡_time_³r_cmd
(
dev_time_wr
, 
´oûs£d_cmds_wr
);

558 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

559 ()
Ï‹ncy_¡©
->
mš_dev_time_wr
,

560 ()
dev_time_wr
,

561 ()
Ï‹ncy_¡©
->
max_dev_time_wr
,

562 ()
Ï‹ncy_¡©
->
dev_time_wr
);

563 
	`£q_´štf
(
£q
, "%-46s\n", 
buf
);

565 
	`£q_´štf
(
£q
, "%-5s %-9s %-15llu ",

566 "R—d", 
sc¡_io_size_Çmes
[
i
],

567 
´oûs£d_cmds_rd
);

569 
	`sc¡_time_³r_cmd
(
sc¡_time_rd
, 
´oûs£d_cmds_rd
);

570 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

571 ()
Ï‹ncy_¡©
->
mš_sc¡_time_rd
,

572 ()
sc¡_time_rd
,

573 ()
Ï‹ncy_¡©
->
max_sc¡_time_rd
,

574 ()
Ï‹ncy_¡©
->
sc¡_time_rd
);

575 
	`£q_´štf
(
£q
, "%-46 ", 
buf
);

577 
	`sc¡_time_³r_cmd
(
tgt_time_rd
, 
´oûs£d_cmds_rd
);

578 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

579 ()
Ï‹ncy_¡©
->
mš_tgt_time_rd
,

580 ()
tgt_time_rd
,

581 ()
Ï‹ncy_¡©
->
max_tgt_time_rd
,

582 ()
Ï‹ncy_¡©
->
tgt_time_rd
);

583 
	`£q_´štf
(
£q
, "%-46 ", 
buf
);

585 
	`sc¡_time_³r_cmd
(
dev_time_rd
, 
´oûs£d_cmds_rd
);

586 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

587 ()
Ï‹ncy_¡©
->
mš_dev_time_rd
,

588 ()
dev_time_rd
,

589 ()
Ï‹ncy_¡©
->
max_dev_time_rd
,

590 ()
Ï‹ncy_¡©
->
dev_time_rd
);

591 
	`£q_´štf
(
£q
, "%-46s\n", 
buf
);

594 
t
 = 
SESS_TGT_DEV_LIST_HASH_SIZE
-1; >= 0;--) {

595 
li¡_h—d
 *
h—d
 =

596 &
£ss
->
£ss_tgt_dev_li¡
[
t
];

597 
sc¡_tgt_dev
 *
tgt_dev
;

598 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
,

599 
£ss_tgt_dev_li¡_’Œy
) {

601 
	`£q_´štf
(
£q
, "\nLUN: %Îu\n", 
tgt_dev
->
lun
);

603 
i
 = 0; i < 
SCST_LATENCY_STATS_NUM
 ; i++) {

604 
ušt64_t
 
sc¡_time_wr
, 
tgt_time_wr
, 
dev_time_wr
;

605 
ušt64_t
 
´oûs£d_cmds_wr
;

606 
ušt64_t
 
sc¡_time_rd
, 
tgt_time_rd
, 
dev_time_rd
;

607 
ušt64_t
 
´oûs£d_cmds_rd
;

608 
sc¡_ext_Ï‹ncy_¡©
 *
Ï‹ncy_¡©
;

610 
Ï‹ncy_¡©
 = &
tgt_dev
->
dev_Ï‹ncy_¡©
[
i
];

611 
sc¡_time_wr
 = 
Ï‹ncy_¡©
->scst_time_wr;

612 
sc¡_time_rd
 = 
Ï‹ncy_¡©
->scst_time_rd;

613 
tgt_time_wr
 = 
Ï‹ncy_¡©
->tgt_time_wr;

614 
tgt_time_rd
 = 
Ï‹ncy_¡©
->tgt_time_rd;

615 
dev_time_wr
 = 
Ï‹ncy_¡©
->dev_time_wr;

616 
dev_time_rd
 = 
Ï‹ncy_¡©
->dev_time_rd;

617 
´oûs£d_cmds_wr
 = 
Ï‹ncy_¡©
->processed_cmds_wr;

618 
´oûs£d_cmds_rd
 = 
Ï‹ncy_¡©
->processed_cmds_rd;

620 
	`£q_´štf
(
£q
, "%-5s %-9s %-15llu ",

621 "Wr™e", 
sc¡_io_size_Çmes
[
i
],

622 
´oûs£d_cmds_wr
);

624 
	`sc¡_time_³r_cmd
(
sc¡_time_wr
, 
´oûs£d_cmds_wr
);

625 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

626 ()
Ï‹ncy_¡©
->
mš_sc¡_time_wr
,

627 ()
sc¡_time_wr
,

628 ()
Ï‹ncy_¡©
->
max_sc¡_time_wr
,

629 ()
Ï‹ncy_¡©
->
sc¡_time_wr
);

630 
	`£q_´štf
(
£q
, "%-46 ", 
buf
);

632 
	`sc¡_time_³r_cmd
(
tgt_time_wr
, 
´oûs£d_cmds_wr
);

633 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

634 ()
Ï‹ncy_¡©
->
mš_tgt_time_wr
,

635 ()
tgt_time_wr
,

636 ()
Ï‹ncy_¡©
->
max_tgt_time_wr
,

637 ()
Ï‹ncy_¡©
->
tgt_time_wr
);

638 
	`£q_´štf
(
£q
, "%-46 ", 
buf
);

640 
	`sc¡_time_³r_cmd
(
dev_time_wr
, 
´oûs£d_cmds_wr
);

641 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

642 ()
Ï‹ncy_¡©
->
mš_dev_time_wr
,

643 ()
dev_time_wr
,

644 ()
Ï‹ncy_¡©
->
max_dev_time_wr
,

645 ()
Ï‹ncy_¡©
->
dev_time_wr
);

646 
	`£q_´štf
(
£q
, "%-46s\n", 
buf
);

648 
	`£q_´štf
(
£q
, "%-5s %-9s %-15llu ",

649 "R—d", 
sc¡_io_size_Çmes
[
i
],

650 
´oûs£d_cmds_rd
);

651 ià(
´oûs£d_cmds_rd
 == 0)

652 
´oûs£d_cmds_rd
 = 1;

654 
	`sc¡_time_³r_cmd
(
sc¡_time_rd
, 
´oûs£d_cmds_rd
);

655 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

656 ()
Ï‹ncy_¡©
->
mš_sc¡_time_rd
,

657 ()
sc¡_time_rd
,

658 ()
Ï‹ncy_¡©
->
max_sc¡_time_rd
,

659 ()
Ï‹ncy_¡©
->
sc¡_time_rd
);

660 
	`£q_´štf
(
£q
, "%-46 ", 
buf
);

662 
	`sc¡_time_³r_cmd
(
tgt_time_rd
, 
´oûs£d_cmds_rd
);

663 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

664 ()
Ï‹ncy_¡©
->
mš_tgt_time_rd
,

665 ()
tgt_time_rd
,

666 ()
Ï‹ncy_¡©
->
max_tgt_time_rd
,

667 ()
Ï‹ncy_¡©
->
tgt_time_rd
);

668 
	`£q_´štf
(
£q
, "%-46 ", 
buf
);

670 
	`sc¡_time_³r_cmd
(
dev_time_rd
, 
´oûs£d_cmds_rd
);

671 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

672 ()
Ï‹ncy_¡©
->
mš_dev_time_rd
,

673 ()
dev_time_rd
,

674 ()
Ï‹ncy_¡©
->
max_dev_time_rd
,

675 ()
Ï‹ncy_¡©
->
dev_time_rd
);

676 
	`£q_´štf
(
£q
, "%-46s\n", 
buf
);

681 
sc¡_time
 = 
£ss
->scst_time;

682 
tgt_time
 = 
£ss
->tgt_time;

683 
dev_time
 = 
£ss
->dev_time;

684 
´oûs£d_cmds
 = 
£ss
->processed_cmds;

686 
	`£q_´štf
(
£q
, "\n%-15s %-16llu", "Overall ",

687 
´oûs£d_cmds
);

689 ià(
´oûs£d_cmds
 == 0)

690 
´oûs£d_cmds
 = 1;

692 
	`sc¡_time_³r_cmd
(
sc¡_time
, 
´oûs£d_cmds
);

693 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

694 ()
£ss
->
mš_sc¡_time
,

695 ()
sc¡_time
,

696 ()
£ss
->
max_sc¡_time
,

697 ()
£ss
->
sc¡_time
);

698 
	`£q_´štf
(
£q
, "%-46 ", 
buf
);

700 
	`sc¡_time_³r_cmd
(
tgt_time
, 
´oûs£d_cmds
);

701 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

702 ()
£ss
->
mš_tgt_time
,

703 ()
tgt_time
,

704 ()
£ss
->
max_tgt_time
,

705 ()
£ss
->
tgt_time
);

706 
	`£q_´štf
(
£q
, "%-46 ", 
buf
);

708 
	`sc¡_time_³r_cmd
(
dev_time
, 
´oûs£d_cmds
);

709 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

710 ()
£ss
->
mš_dev_time
,

711 ()
dev_time
,

712 ()
£ss
->
max_dev_time
,

713 ()
£ss
->
dev_time
);

714 
	`£q_´štf
(
£q
, "%-46s\n\n", 
buf
);

716 
	`¥š_uÆock_bh
(&
£ss
->
Ït_lock
);

720 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

722 
out
:

723 
	`TRACE_EXIT_RES
(
»s
);

724  
»s
;

725 
	}
}

727 
ssize_t
 
	$sc¡_´oc_scsi_tgt_g’_wr™e_Ït
(
fže
 *file,

728 cÚ¡ 
__u£r
 *
buf
,

729 
size_t
 
Ëngth
, 
loff_t
 *
off
)

731 
»s
 = 
Ëngth
, 
t
;

732 
sc¡_acg
 *
acg
;

733 
sc¡_£ssiÚ
 *
£ss
;

735 
	`TRACE_ENTRY
();

737 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
) != 0) {

738 
»s
 = -
EINTR
;

739 
out
;

742 
	`li¡_fÜ_—ch_’Œy
(
acg
, &
sc¡_acg_li¡
, 
acg_li¡_’Œy
) {

743 
	`li¡_fÜ_—ch_’Œy
(
£ss
, &
acg
->
acg_£ss_li¡
,

744 
acg_£ss_li¡_’Œy
) {

745 
	`PRINT_INFO
("Zeroing†atency statistics for initiator "

746 "%s", 
£ss
->
š™ŸtÜ_Çme
);

747 
	`¥š_lock_bh
(&
£ss
->
Ït_lock
);

749 
£ss
->
sc¡_time
 = 0;

750 
£ss
->
tgt_time
 = 0;

751 
£ss
->
dev_time
 = 0;

752 
£ss
->
mš_sc¡_time
 = 0;

753 
£ss
->
mš_tgt_time
 = 0;

754 
£ss
->
mš_dev_time
 = 0;

755 
£ss
->
max_sc¡_time
 = 0;

756 
£ss
->
max_tgt_time
 = 0;

757 
£ss
->
max_dev_time
 = 0;

758 
£ss
->
´oûs£d_cmds
 = 0;

759 
	`mem£t
(
£ss
->
£ss_Ï‹ncy_¡©
, 0,

760 (
£ss
->
£ss_Ï‹ncy_¡©
));

762 
t
 = 
SESS_TGT_DEV_LIST_HASH_SIZE
-1; >= 0;--) {

763 
li¡_h—d
 *
h—d
 =

764 &
£ss
->
£ss_tgt_dev_li¡
[
t
];

765 
sc¡_tgt_dev
 *
tgt_dev
;

766 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
,

767 
£ss_tgt_dev_li¡_’Œy
) {

768 
tgt_dev
->
sc¡_time
 = 0;

769 
tgt_dev
->
tgt_time
 = 0;

770 
tgt_dev
->
dev_time
 = 0;

771 
tgt_dev
->
´oûs£d_cmds
 = 0;

772 
	`mem£t
(
tgt_dev
->
dev_Ï‹ncy_¡©
, 0,

773 (
tgt_dev
->
dev_Ï‹ncy_¡©
));

777 
	`¥š_uÆock_bh
(&
£ss
->
Ït_lock
);

781 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

783 
out
:

784 
	`TRACE_EXIT_RES
(
»s
);

785  
»s
;

786 
	}
}

788 
sc¡_´oc_d©a
 
	gsc¡_Ït_´oc_d©a
 = {

789 
SCST_DEF_RW_SEQ_OP
(
sc¡_´oc_scsi_tgt_g’_wr™e_Ït
)

790 .
show
 = 
Ït_šfo_show
,

791 .
	gd©a
 = "scsi_tgt",

796 
__š™
 
	$sc¡_´oc_š™_moduË_log
()

798 
»s
 = 0;

799 #ià
	`defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
) || \

800 
	`defšed
(
CONFIG_SCST_MEASURE_LATENCY
)

801 
´oc_dœ_’Œy
 *
g’”ic
;

804 
	`TRACE_ENTRY
();

806 #ià
	`defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

807 
g’”ic
 = 
	`sc¡_ü—‹_´oc_’Œy
(
sc¡_´oc_scsi_tgt
,

808 
SCST_PROC_LOG_ENTRY_NAME
,

809 &
sc¡_log_´oc_d©a
);

810 ià(!
g’”ic
) {

811 
	`PRINT_ERROR
("cannot init /proc/%s/%s",

812 
SCST_PROC_ENTRY_NAME
, 
SCST_PROC_LOG_ENTRY_NAME
);

813 
»s
 = -
ENOMEM
;

817 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


818 ià(
»s
 == 0) {

819 
g’”ic
 = 
	`sc¡_ü—‹_´oc_’Œy
(
sc¡_´oc_scsi_tgt
,

820 
SCST_PROC_LAT_ENTRY_NAME
,

821 &
sc¡_Ït_´oc_d©a
);

822 ià(!
g’”ic
) {

823 
	`PRINT_ERROR
("cannot init /proc/%s/%s",

824 
SCST_PROC_ENTRY_NAME
,

825 
SCST_PROC_LAT_ENTRY_NAME
);

826 
»s
 = -
ENOMEM
;

831 
	`TRACE_EXIT_RES
(
»s
);

832  
»s
;

833 
	}
}

835 
	$sc¡_´oc_þ—nup_moduË_log
()

837 
	`TRACE_ENTRY
();

839 #ià
	`defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

840 
	`»move_´oc_’Œy
(
SCST_PROC_LOG_ENTRY_NAME
, 
sc¡_´oc_scsi_tgt
);

843 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


844 
	`»move_´oc_’Œy
(
SCST_PROC_LAT_ENTRY_NAME
, 
sc¡_´oc_scsi_tgt
);

847 
	`TRACE_EXIT
();

849 
	}
}

851 
	$sc¡_´oc_group_add_Œ“
(
sc¡_acg
 *
acg
, cÚ¡ *
Çme
)

853 
»s
 = 0;

854 
´oc_dœ_’Œy
 *
g’”ic
;

856 
	`TRACE_ENTRY
();

858 
acg
->
acg_´oc_roÙ
 = 
	`´oc_mkdœ
(
Çme
, 
sc¡_´oc_groups_roÙ
);

859 ià(
acg
->
acg_´oc_roÙ
 =ð
NULL
) {

860 
	`PRINT_ERROR
("Notƒnough memoryo„egister %sƒntry in "

861 "/´oc/%s/%s", 
Çme
, 
SCST_PROC_ENTRY_NAME
,

862 
SCST_PROC_GROUPS_ENTRY_NAME
);

863 
out
;

866 
sc¡_groups_addr_m‘hod_´oc_d©a
.
d©a
 = 
acg
;

867 
g’”ic
 = 
	`sc¡_ü—‹_´oc_’Œy
(
acg
->
acg_´oc_roÙ
,

868 
SCST_PROC_GROUPS_ADDR_METHOD_ENTRY_NAME
,

869 &
sc¡_groups_addr_m‘hod_´oc_d©a
);

870 ià(!
g’”ic
) {

871 
	`PRINT_ERROR
("Cannot init /proc/%s/%s/%s/%s",

872 
SCST_PROC_ENTRY_NAME
,

873 
SCST_PROC_GROUPS_ENTRY_NAME
,

874 
Çme
, 
SCST_PROC_GROUPS_ADDR_METHOD_ENTRY_NAME
);

875 
»s
 = -
ENOMEM
;

876 
out_»move
;

879 
sc¡_groups_deviûs_´oc_d©a
.
d©a
 = 
acg
;

880 
g’”ic
 = 
	`sc¡_ü—‹_´oc_’Œy
(
acg
->
acg_´oc_roÙ
,

881 
SCST_PROC_GROUPS_DEVICES_ENTRY_NAME
,

882 &
sc¡_groups_deviûs_´oc_d©a
);

883 ià(!
g’”ic
) {

884 
	`PRINT_ERROR
("Cannot init /proc/%s/%s/%s/%s",

885 
SCST_PROC_ENTRY_NAME
,

886 
SCST_PROC_GROUPS_ENTRY_NAME
,

887 
Çme
, 
SCST_PROC_GROUPS_DEVICES_ENTRY_NAME
);

888 
»s
 = -
ENOMEM
;

889 
out_»move0
;

892 
sc¡_groups_Çmes_´oc_d©a
.
d©a
 = 
acg
;

893 
g’”ic
 = 
	`sc¡_ü—‹_´oc_’Œy
(
acg
->
acg_´oc_roÙ
,

894 
SCST_PROC_GROUPS_USERS_ENTRY_NAME
,

895 &
sc¡_groups_Çmes_´oc_d©a
);

896 ià(!
g’”ic
) {

897 
	`PRINT_ERROR
("Cannot init /proc/%s/%s/%s/%s",

898 
SCST_PROC_ENTRY_NAME
,

899 
SCST_PROC_GROUPS_ENTRY_NAME
,

900 
Çme
, 
SCST_PROC_GROUPS_USERS_ENTRY_NAME
);

901 
»s
 = -
ENOMEM
;

902 
out_»move1
;

905 
out
:

906 
	`TRACE_EXIT_RES
(
»s
);

907  
»s
;

909 
out_»move1
:

910 
	`»move_´oc_’Œy
(
SCST_PROC_GROUPS_DEVICES_ENTRY_NAME
,

911 
acg
->
acg_´oc_roÙ
);

913 
out_»move0
:

914 
	`»move_´oc_’Œy
(
SCST_PROC_GROUPS_ADDR_METHOD_ENTRY_NAME
,

915 
acg
->
acg_´oc_roÙ
);

916 
out_»move
:

917 
	`»move_´oc_’Œy
(
Çme
, 
sc¡_´oc_groups_roÙ
);

918 
out
;

919 
	}
}

921 
	$sc¡_´oc_d–_acg_Œ“
(
´oc_dœ_’Œy
 *
acg_´oc_roÙ
,

922 cÚ¡ *
Çme
)

924 
	`TRACE_ENTRY
();

926 
	`»move_´oc_’Œy
(
SCST_PROC_GROUPS_ADDR_METHOD_ENTRY_NAME
, 
acg_´oc_roÙ
);

927 
	`»move_´oc_’Œy
(
SCST_PROC_GROUPS_USERS_ENTRY_NAME
, 
acg_´oc_roÙ
);

928 
	`»move_´oc_’Œy
(
SCST_PROC_GROUPS_DEVICES_ENTRY_NAME
, 
acg_´oc_roÙ
);

929 
	`»move_´oc_’Œy
(
Çme
, 
sc¡_´oc_groups_roÙ
);

931 
	`TRACE_EXIT
();

933 
	}
}

936 
	$sc¡_´oc_group_add
(cÚ¡ *
p
, 
addr_m‘hod
)

938 
»s
 = 0, 
Ën
 = 
	`¡¾’
(
p
) + 1;

939 
sc¡_acg
 *
acg
;

940 *
Çme
 = 
NULL
;

942 
	`TRACE_ENTRY
();

944 
Çme
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

945 ià(
Çme
 =ð
NULL
) {

946 
	`PRINT_ERROR
("AÎoÿtiÚ oàÃw‚am(siz%dèçžed", 
Ën
);

947 
out_nomem
;

949 
	`¡¾ýy
(
Çme
, 
p
, 
Ën
);

951 
»s
 = 
	`sc¡_®loc_add_acg
(
NULL
, 
Çme
, 
çl£
, &
acg
);

952 ià(
»s
 != 0) {

953 
	`PRINT_ERROR
("sc¡_®loc_add_acg(èÒam%sèçžed", 
Çme
);

954 
out_ä“
;

957 
acg
->
addr_m‘hod
 =‡ddr_method;

959 
»s
 = 
	`sc¡_´oc_group_add_Œ“
(
acg
, 
p
);

960 ià(
»s
 != 0)

961 
out_ä“_acg
;

963 
out
:

964 
	`TRACE_EXIT_RES
(
»s
);

965  
»s
;

967 
out_ä“_acg
:

968 
	`sc¡_´oc_d–_ä“_acg
(
acg
, 0);

970 
out_ä“
:

971 
	`kä“
(
Çme
);

972 
out
;

974 
out_nomem
:

975 
»s
 = -
ENOMEM
;

976 
out
;

977 
	}
}

980 
	$sc¡_´oc_d–_ä“_acg
(
sc¡_acg
 *
acg
, 
»move_´oc
)

982 
´oc_dœ_’Œy
 *
acg_´oc_roÙ
 = 
acg
->acg_proc_root;

983 
»s
 = 0;

985 
	`TRACE_ENTRY
();

987 ià(
acg
 !ð
sc¡_deçuÉ_acg
) {

988 ià(!
	`sc¡_acg_£ss_is_em±y
(
acg
)) {

989 
	`PRINT_ERROR
("%s", "Session is‚otƒmpty");

990 
»s
 = -
EBUSY
;

991 
out
;

993 ià(
»move_´oc
)

994 
	`sc¡_´oc_d–_acg_Œ“
(
acg_´oc_roÙ
, 
acg
->
acg_Çme
);

995 
	`sc¡_d–_ä“_acg
(
acg
, 
çl£
);

997 
out
:

998 
	`TRACE_EXIT_RES
(
»s
);

999  
»s
;

1000 
	}
}

1003 
	$sc¡_´oc_»Çme_acg
(
sc¡_acg
 *
acg
, cÚ¡ *
Ãw_Çme
)

1005 
»s
 = 0, 
Ën
 = 
	`¡¾’
(
Ãw_Çme
) + 1;

1006 *
Çme
;

1007 
´oc_dœ_’Œy
 *
Þd_acg_´oc_roÙ
 = 
acg
->
acg_´oc_roÙ
;

1009 
	`TRACE_ENTRY
();

1011 
Çme
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

1012 ià(
Çme
 =ð
NULL
) {

1013 
	`PRINT_ERROR
("AÎoÿtiÚ oàÃw‚am(siz%dèçžed", 
Ën
);

1014 
out_nomem
;

1016 
	`¡¾ýy
(
Çme
, 
Ãw_Çme
, 
Ën
);

1018 
»s
 = 
	`sc¡_´oc_group_add_Œ“
(
acg
, 
Ãw_Çme
);

1019 ià(
»s
 != 0)

1020 
out_ä“
;

1022 
	`sc¡_´oc_d–_acg_Œ“
(
Þd_acg_´oc_roÙ
, 
acg
->
acg_Çme
);

1024 
	`kä“
(
acg
->
acg_Çme
);

1025 
acg
->
acg_Çme
 = 
Çme
;

1027 
	`sc¡_check_»assign_£ssiÚs
();

1029 
out
:

1030 
	`TRACE_EXIT_RES
(
»s
);

1031  
»s
;

1033 
out_ä“
:

1034 
	`kä“
(
Çme
);

1036 
out_nomem
:

1037 
»s
 = -
ENOMEM
;

1038 
out
;

1039 
	}
}

1041 
__š™
 
	$sc¡_´oc_š™_groups
()

1043 
»s
 = 0;

1045 
	`TRACE_ENTRY
();

1048 
sc¡_´oc_groups_roÙ
 = 
	`´oc_mkdœ
(
SCST_PROC_GROUPS_ENTRY_NAME
,

1049 
sc¡_´oc_scsi_tgt
);

1050 ià(
sc¡_´oc_groups_roÙ
 =ð
NULL
) {

1051 
	`PRINT_ERROR
("Notƒnough memoryo„egister %sƒntry in "

1052 "/´oc/%s", 
SCST_PROC_GROUPS_ENTRY_NAME
,

1053 
SCST_PROC_ENTRY_NAME
);

1054 
out_nomem
;

1057 
»s
 = 
	`sc¡_´oc_group_add_Œ“
(
sc¡_deçuÉ_acg
,

1058 
SCST_DEFAULT_ACG_NAME
);

1059 ià(
»s
 != 0)

1060 
out_»move
;

1062 
out
:

1063 
	`TRACE_EXIT_RES
(
»s
);

1064  
»s
;

1066 
out_»move
:

1067 
	`»move_´oc_’Œy
(
SCST_PROC_GROUPS_ENTRY_NAME
, 
sc¡_´oc_scsi_tgt
);

1069 
out_nomem
:

1070 
»s
 = -
ENOMEM
;

1071 
out
;

1072 
	}
}

1074 
	$sc¡_´oc_þ—nup_groups
()

1076 
sc¡_acg
 *
acg_tmp
, *
acg
;

1078 
	`TRACE_ENTRY
();

1081 
	`li¡_fÜ_—ch_’Œy_§ã
(
acg
, 
acg_tmp
, &
sc¡_acg_li¡
,

1082 
acg_li¡_’Œy
) {

1083 
	`sc¡_´oc_d–_ä“_acg
(
acg
, 1);

1086 
	`sc¡_´oc_d–_acg_Œ“
(
sc¡_deçuÉ_acg
->
acg_´oc_roÙ
,

1087 
SCST_DEFAULT_ACG_NAME
);

1088 
	`TRACE_DBG
("remove_proc_entry(%s, %p)",

1089 
SCST_PROC_GROUPS_ENTRY_NAME
, 
sc¡_´oc_scsi_tgt
);

1090 
	`»move_´oc_’Œy
(
SCST_PROC_GROUPS_ENTRY_NAME
, 
sc¡_´oc_scsi_tgt
);

1092 
	`TRACE_EXIT
();

1093 
	}
}

1095 
__š™
 
	$sc¡_´oc_š™_sgv
()

1097 
»s
 = 0;

1098 
´oc_dœ_’Œy
 *
´
;

1100 
	`TRACE_ENTRY
();

1102 
´
 = 
	`sc¡_ü—‹_´oc_’Œy
(
sc¡_´oc_scsi_tgt
, "sgv",

1103 &
sc¡_sgv_´oc_d©a
);

1104 ià(
´
 =ð
NULL
) {

1105 
	`PRINT_ERROR
("%s", "cannot create sgv /procƒntry");

1106 
»s
 = -
ENOMEM
;

1109 
	`TRACE_EXIT_RES
(
»s
);

1110  
»s
;

1111 
	}
}

1113 
	$sc¡_´oc_þ—nup_sgv
()

1115 
	`TRACE_ENTRY
();

1116 
	`»move_´oc_’Œy
("sgv", 
sc¡_´oc_scsi_tgt
);

1117 
	`TRACE_EXIT
();

1118 
	}
}

1120 
__š™
 
	$sc¡_´oc_š™_moduË
()

1122 
»s
 = 0;

1123 
´oc_dœ_’Œy
 *
g’”ic
;

1125 
	`TRACE_ENTRY
();

1127 
sc¡_´oc_scsi_tgt
 = 
	`´oc_mkdœ
(
SCST_PROC_ENTRY_NAME
, 
NULL
);

1128 ià(!
sc¡_´oc_scsi_tgt
) {

1129 
	`PRINT_ERROR
("ÿÂÙ in™ /´oc/%s", 
SCST_PROC_ENTRY_NAME
);

1130 
out_nomem
;

1133 
g’”ic
 = 
	`sc¡_ü—‹_´oc_’Œy
(
sc¡_´oc_scsi_tgt
,

1134 
SCST_PROC_ENTRY_NAME
,

1135 &
sc¡_tgt_´oc_d©a
);

1136 ià(!
g’”ic
) {

1137 
	`PRINT_ERROR
("cannot init /proc/%s/%s",

1138 
SCST_PROC_ENTRY_NAME
, SCST_PROC_ENTRY_NAME);

1139 
out_»move
;

1142 
g’”ic
 = 
	`sc¡_ü—‹_´oc_’Œy
(
sc¡_´oc_scsi_tgt
,

1143 
SCST_PROC_VERSION_NAME
,

1144 &
sc¡_v”siÚ_´oc_d©a
);

1145 ià(!
g’”ic
) {

1146 
	`PRINT_ERROR
("cannot init /proc/%s/%s",

1147 
SCST_PROC_ENTRY_NAME
, 
SCST_PROC_VERSION_NAME
);

1148 
out_»move1
;

1151 
g’”ic
 = 
	`sc¡_ü—‹_´oc_’Œy
(
sc¡_´oc_scsi_tgt
,

1152 
SCST_PROC_SESSIONS_NAME
,

1153 &
sc¡_£ssiÚs_´oc_d©a
);

1154 ià(!
g’”ic
) {

1155 
	`PRINT_ERROR
("cannot init /proc/%s/%s",

1156 
SCST_PROC_ENTRY_NAME
, 
SCST_PROC_SESSIONS_NAME
);

1157 
out_»move2
;

1160 
g’”ic
 = 
	`sc¡_ü—‹_´oc_’Œy
(
sc¡_´oc_scsi_tgt
,

1161 
SCST_PROC_HELP_NAME
,

1162 &
sc¡_h–p_´oc_d©a
);

1163 ià(!
g’”ic
) {

1164 
	`PRINT_ERROR
("cannot init /proc/%s/%s",

1165 
SCST_PROC_ENTRY_NAME
, 
SCST_PROC_HELP_NAME
);

1166 
out_»move3
;

1169 
g’”ic
 = 
	`sc¡_ü—‹_´oc_’Œy
(
sc¡_´oc_scsi_tgt
,

1170 
SCST_PROC_THREADS_NAME
,

1171 &
sc¡_th»ads_´oc_d©a
);

1172 ià(!
g’”ic
) {

1173 
	`PRINT_ERROR
("cannot init /proc/%s/%s",

1174 
SCST_PROC_ENTRY_NAME
, 
SCST_PROC_THREADS_NAME
);

1175 
out_»move4
;

1178 ià(
	`sc¡_´oc_š™_moduË_log
() < 0)

1179 
out_»move5
;

1181 ià(
	`sc¡_´oc_š™_groups
() < 0)

1182 
out_»move6
;

1184 ià(
	`sc¡_´oc_š™_sgv
() < 0)

1185 
out_»move7
;

1187 
out
:

1188 
	`TRACE_EXIT_RES
(
»s
);

1189  
»s
;

1191 
out_»move7
:

1192 
	`sc¡_´oc_þ—nup_groups
();

1194 
out_»move6
:

1195 
	`sc¡_´oc_þ—nup_moduË_log
();

1197 
out_»move5
:

1198 
	`»move_´oc_’Œy
(
SCST_PROC_THREADS_NAME
, 
sc¡_´oc_scsi_tgt
);

1200 
out_»move4
:

1201 
	`»move_´oc_’Œy
(
SCST_PROC_HELP_NAME
, 
sc¡_´oc_scsi_tgt
);

1203 
out_»move3
:

1204 
	`»move_´oc_’Œy
(
SCST_PROC_SESSIONS_NAME
, 
sc¡_´oc_scsi_tgt
);

1206 
out_»move2
:

1207 
	`»move_´oc_’Œy
(
SCST_PROC_VERSION_NAME
, 
sc¡_´oc_scsi_tgt
);

1209 
out_»move1
:

1210 
	`»move_´oc_’Œy
(
SCST_PROC_ENTRY_NAME
, 
sc¡_´oc_scsi_tgt
);

1212 
out_»move
:

1213 
	`»move_´oc_’Œy
(
SCST_PROC_ENTRY_NAME
, 
NULL
);

1215 
out_nomem
:

1216 
»s
 = -
ENOMEM
;

1217 
out
;

1218 
	}
}

1220 
	$sc¡_´oc_þ—nup_moduË
()

1222 
	`TRACE_ENTRY
();

1225 
	`sc¡_´oc_þ—nup_sgv
();

1226 
	`sc¡_´oc_þ—nup_groups
();

1227 
	`sc¡_´oc_þ—nup_moduË_log
();

1228 
	`»move_´oc_’Œy
(
SCST_PROC_THREADS_NAME
, 
sc¡_´oc_scsi_tgt
);

1229 
	`»move_´oc_’Œy
(
SCST_PROC_HELP_NAME
, 
sc¡_´oc_scsi_tgt
);

1230 
	`»move_´oc_’Œy
(
SCST_PROC_SESSIONS_NAME
, 
sc¡_´oc_scsi_tgt
);

1231 
	`»move_´oc_’Œy
(
SCST_PROC_VERSION_NAME
, 
sc¡_´oc_scsi_tgt
);

1232 
	`»move_´oc_’Œy
(
SCST_PROC_ENTRY_NAME
, 
sc¡_´oc_scsi_tgt
);

1233 
	`»move_´oc_’Œy
(
SCST_PROC_ENTRY_NAME
, 
NULL
);

1235 
	`TRACE_EXIT
();

1236 
	}
}

1238 
ssize_t
 
	$sc¡_´oc_th»ads_wr™e
(
fže
 *file,

1239 cÚ¡ 
__u£r
 *
buf
,

1240 
size_t
 
Ëngth
, 
loff_t
 *
off
)

1242 
»s
 = 
Ëngth
;

1243 
ÞdŠ
, 
ÃwŠ
, 
d–
;

1244 *
bufãr
;

1246 
	`TRACE_ENTRY
();

1248 ià(
Ëngth
 > 
SCST_PROC_BLOCK_SIZE
) {

1249 
»s
 = -
EOVERFLOW
;

1250 
out
;

1252 ià(!
buf
) {

1253 
»s
 = -
EINVAL
;

1254 
out
;

1256 
bufãr
 = (*)
	`__g‘_ä“_·ge
(
GFP_KERNEL
);

1257 ià(!
bufãr
) {

1258 
»s
 = -
ENOMEM
;

1259 
out
;

1261 ià(
	`cÝy_äom_u£r
(
bufãr
, 
buf
, 
Ëngth
)) {

1262 
»s
 = -
EFAULT
;

1263 
out_ä“
;

1265 ià(
Ëngth
 < 
PAGE_SIZE
) {

1266 
bufãr
[
Ëngth
] = '\0';

1267 } ià(
bufãr
[
PAGE_SIZE
-1]) {

1268 
»s
 = -
EINVAL
;

1269 
out_ä“
;

1272 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_´oc_mu‹x
) != 0) {

1273 
»s
 = -
EINTR
;

1274 
out_ä“
;

1277 
	`mu‹x_lock
(&
sc¡_mu‹x
);

1279 
ÞdŠ
 = 
sc¡_maš_cmd_th»ads
.
Ä_th»ads
;

1280 
ÃwŠ
 = 
	`sim¶e_¡¹oul
(
bufãr
, 
NULL
, 0);

1281 ià(
ÃwŠ
 <= 0) {

1282 
	`PRINT_ERROR
("IÎeg®h»ad num v®u%d", 
ÃwŠ
);

1283 
»s
 = -
EINVAL
;

1284 
out_up_thr_ä“
;

1286 
d–
 = 
ÃwŠ
 - 
ÞdŠ
;

1287 ià(
d–
 < 0)

1288 
	`sc¡_d–_th»ads
(&
sc¡_maš_cmd_th»ads
, -
d–
);

1290 
rc
 = 
	`sc¡_add_th»ads
(&
sc¡_maš_cmd_th»ads
, 
NULL
, NULL,

1291 
d–
);

1292 ià(
rc
 != 0)

1293 
»s
 = 
rc
;

1296 
	`PRINT_INFO
("Chªged cmdh»ad num: old %d,‚ew %d", 
ÞdŠ
, 
ÃwŠ
);

1298 
out_up_thr_ä“
:

1299 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1301 
	`mu‹x_uÆock
(&
sc¡_´oc_mu‹x
);

1303 
out_ä“
:

1304 
	`ä“_·ge
(()
bufãr
);

1305 
out
:

1306 
	`TRACE_EXIT_RES
(
»s
);

1307  
»s
;

1308 
	}
}

1310 
	$sc¡_bužd_´oc_rg‘_dœ_’Œ›s
(
sc¡_tgt_‹m¶©e
 *
v‰
)

1312 
»s
 = 0;

1314 
	`TRACE_ENTRY
();

1317 
v‰
->
´oc_tgt_roÙ
 = 
	`´oc_mkdœ
(v‰->
Çme
, 
sc¡_´oc_scsi_tgt
);

1318 ià(
v‰
->
´oc_tgt_roÙ
 =ð
NULL
) {

1319 
	`PRINT_ERROR
("Notƒnough memoryo„egister SCSIarget %s "

1320 "š /´oc/%s", 
v‰
->
Çme
, 
SCST_PROC_ENTRY_NAME
);

1321 
out_nomem
;

1324 
out
:

1325 
	`TRACE_EXIT_RES
(
»s
);

1326  
»s
;

1328 
out_nomem
:

1329 
»s
 = -
ENOMEM
;

1330 
out
;

1331 
	}
}

1333 
	$sc¡_þ—nup_´oc_rg‘_dœ_’Œ›s
(
sc¡_tgt_‹m¶©e
 *
v‰
)

1335 
	`TRACE_ENTRY
();

1337 
	`»move_´oc_’Œy
(
v‰
->
Çme
, 
sc¡_´oc_scsi_tgt
);

1339 
	`TRACE_EXIT
();

1341 
	}
}

1344 
	$sc¡_bužd_´oc_rg‘_’Œ›s
(
sc¡_tgt
 *
v‰
)

1346 
»s
 = 0;

1347 
´oc_dœ_’Œy
 *
p
;

1348 
Çme
[20];

1350 
	`TRACE_ENTRY
();

1352 ià(
v‰
->
tg‰
->
»ad_´oc
 || v‰->tg‰->
wr™e_´oc
) {

1354 
	`sú´štf
(
Çme
, Òame), "%d", 
v‰
->
tg‰
->
´oc_dev_num
);

1355 
sc¡_scsi_tgt_´oc_d©a
.
d©a
 = (*)
v‰
;

1356 
p
 = 
	`sc¡_ü—‹_´oc_’Œy
(
v‰
->
tg‰
->
´oc_tgt_roÙ
,

1357 
Çme
,

1358 &
sc¡_scsi_tgt_´oc_d©a
);

1359 ià(
p
 =ð
NULL
) {

1360 
	`PRINT_ERROR
("Notƒnough memoryo„egister SCSI "

1361 "rg‘ƒÁry % š /´oc/%s/%s", 
Çme
,

1362 
SCST_PROC_ENTRY_NAME
, 
v‰
->
tg‰
->
Çme
);

1363 
»s
 = -
ENOMEM
;

1364 
out
;

1366 
v‰
->
´oc_num
 = v‰->
tg‰
->
´oc_dev_num
;

1367 
v‰
->
tg‰
->
´oc_dev_num
++;

1370 
out
:

1371 
	`TRACE_EXIT_RES
(
»s
);

1372  
»s
;

1373 
	}
}

1375 
	$sc¡_þ—nup_´oc_rg‘_’Œ›s
(
sc¡_tgt
 *
v‰
)

1377 
Çme
[20];

1379 
	`TRACE_ENTRY
();

1381 ià(
v‰
->
tg‰
->
»ad_´oc
 || v‰->tg‰->
wr™e_´oc
) {

1382 
	`sú´štf
(
Çme
, Òame), "%d", 
v‰
->
´oc_num
);

1383 
	`»move_´oc_’Œy
(
Çme
, 
v‰
->
tg‰
->
´oc_tgt_roÙ
);

1386 
	`TRACE_EXIT
();

1388 
	}
}

1390 
ssize_t
 
	$sc¡_´oc_scsi_tgt_wr™e
(
fže
 *file,

1391 cÚ¡ 
__u£r
 *
buf
,

1392 
size_t
 
Ëngth
, 
loff_t
 *
off
)

1394 
sc¡_tgt
 *
v‰
 = 
	`PDE_DATA
(
	`fže_šode
(
fže
));

1395 
ssize_t
 
»s
 = 0;

1396 *
bufãr
;

1397 *
¡¬t
;

1398 
eof
 = 0;

1400 
	`TRACE_ENTRY
();

1402 ià(
v‰
->
tg‰
->
wr™e_´oc
 =ð
NULL
) {

1403 
»s
 = -
ENOTSUPP
;

1404 
out
;

1407 ià(
Ëngth
 > 
SCST_PROC_BLOCK_SIZE
) {

1408 
»s
 = -
EOVERFLOW
;

1409 
out
;

1411 ià(!
buf
) {

1412 
»s
 = -
EINVAL
;

1413 
out
;

1415 
bufãr
 = (*)
	`__g‘_ä“_·ge
(
GFP_KERNEL
);

1416 ià(!
bufãr
) {

1417 
»s
 = -
ENOMEM
;

1418 
out
;

1420 ià(
	`cÝy_äom_u£r
(
bufãr
, 
buf
, 
Ëngth
)) {

1421 
»s
 = -
EFAULT
;

1422 
out_ä“
;

1424 ià(
Ëngth
 < 
PAGE_SIZE
) {

1425 
bufãr
[
Ëngth
] = '\0';

1426 } ià(
bufãr
[
PAGE_SIZE
-1]) {

1427 
»s
 = -
EINVAL
;

1428 
out_ä“
;

1431 
	`TRACE_BUFFER
("Bufãr", 
bufãr
, 
Ëngth
);

1433 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_´oc_mu‹x
) != 0) {

1434 
»s
 = -
EINTR
;

1435 
out_ä“
;

1438 
»s
 = 
v‰
->
tg‰
->
	`wr™e_´oc
(
bufãr
, &
¡¬t
, 0, 
Ëngth
, &
eof
, vtt);

1440 
	`mu‹x_uÆock
(&
sc¡_´oc_mu‹x
);

1442 
out_ä“
:

1443 
	`ä“_·ge
(()
bufãr
);

1444 
out
:

1445 
	`TRACE_EXIT_RES
(
»s
);

1446  
»s
;

1447 
	}
}

1449 
	$sc¡_bužd_´oc_dev_hªdËr_dœ_’Œ›s
(
sc¡_dev_ty³
 *
dev_ty³
)

1451 
»s
 = 0;

1452 
´oc_dœ_’Œy
 *
p
;

1453 cÚ¡ *
Çme
;

1455 
	`TRACE_ENTRY
();

1457 
	`sBUG_ON
(
dev_ty³
->
´oc_dev_ty³_roÙ
);

1459 ià(
	`¡rcmp
(
dev_ty³
->
Çme
, "vdisk_fileio") == 0)

1460 
Çme
 = "vdisk";

1462 
Çme
 = 
dev_ty³
->name;

1465 
dev_ty³
->
´oc_dev_ty³_roÙ
 = 
	`´oc_mkdœ
(
Çme
,

1466 
sc¡_´oc_scsi_tgt
);

1467 ià(
dev_ty³
->
´oc_dev_ty³_roÙ
 =ð
NULL
) {

1468 
	`PRINT_ERROR
("Notƒnough memoryo„egister dev handler dir "

1469 "% š /´oc/%s", 
Çme
, 
SCST_PROC_ENTRY_NAME
);

1470 
out_nomem
;

1473 
sc¡_dev_hªdËr_ty³_´oc_d©a
.
d©a
 = 
dev_ty³
;

1474 ià(
dev_ty³
->
ty³
 >= 0) {

1475 
p
 = 
	`sc¡_ü—‹_´oc_’Œy
(
dev_ty³
->
´oc_dev_ty³_roÙ
,

1476 
SCST_PROC_DEV_HANDLER_TYPE_ENTRY_NAME
,

1477 &
sc¡_dev_hªdËr_ty³_´oc_d©a
);

1478 ià(
p
 =ð
NULL
) {

1479 
	`PRINT_ERROR
("Notƒnough memoryo„egister dev "

1481 
SCST_PROC_DEV_HANDLER_TYPE_ENTRY_NAME
,

1482 
SCST_PROC_ENTRY_NAME
, 
Çme
);

1483 
out_»move
;

1487 ià(
dev_ty³
->
»ad_´oc
 || dev_ty³->
wr™e_´oc
) {

1489 
sc¡_dev_hªdËr_´oc_d©a
.
d©a
 = (*)
dev_ty³
;

1490 
p
 = 
	`sc¡_ü—‹_´oc_’Œy
(
dev_ty³
->
´oc_dev_ty³_roÙ
,

1491 
Çme
,

1492 &
sc¡_dev_hªdËr_´oc_d©a
);

1493 ià(
p
 =ð
NULL
) {

1494 
	`PRINT_ERROR
("Notƒnough memoryo„egister dev "

1495 "hªdË¸’Œy % š /´oc/%s/%s", 
Çme
,

1496 
SCST_PROC_ENTRY_NAME
, 
Çme
);

1497 
out_»move1
;

1501 
out
:

1502 
	`TRACE_EXIT_RES
(
»s
);

1503  
»s
;

1505 
out_»move1
:

1506 ià(
dev_ty³
->
ty³
 >= 0)

1507 
	`»move_´oc_’Œy
(
SCST_PROC_DEV_HANDLER_TYPE_ENTRY_NAME
,

1508 
dev_ty³
->
´oc_dev_ty³_roÙ
);

1510 
out_»move
:

1511 
	`»move_´oc_’Œy
(
Çme
, 
sc¡_´oc_scsi_tgt
);

1513 
out_nomem
:

1514 
»s
 = -
ENOMEM
;

1515 
out
;

1516 
	}
}

1518 
	$sc¡_þ—nup_´oc_dev_hªdËr_dœ_’Œ›s
(
sc¡_dev_ty³
 *
dev_ty³
)

1521 cÚ¡ *
Çme
;

1523 
	`TRACE_ENTRY
();

1525 
	`sBUG_ON
(
dev_ty³
->
´oc_dev_ty³_roÙ
 =ð
NULL
);

1527 ià(
	`¡rcmp
(
dev_ty³
->
Çme
, "vdisk_fileio") == 0)

1528 
Çme
 = "vdisk";

1530 
Çme
 = 
dev_ty³
->name;

1532 ià(
dev_ty³
->
ty³
 >= 0) {

1533 
	`»move_´oc_’Œy
(
SCST_PROC_DEV_HANDLER_TYPE_ENTRY_NAME
,

1534 
dev_ty³
->
´oc_dev_ty³_roÙ
);

1536 ià(
dev_ty³
->
»ad_´oc
 || dev_ty³->
wr™e_´oc
)

1537 
	`»move_´oc_’Œy
(
Çme
, 
dev_ty³
->
´oc_dev_ty³_roÙ
);

1538 
	`»move_´oc_’Œy
(
Çme
, 
sc¡_´oc_scsi_tgt
);

1539 
dev_ty³
->
´oc_dev_ty³_roÙ
 = 
NULL
;

1541 
	`TRACE_EXIT
();

1543 
	}
}

1545 
ssize_t
 
	$sc¡_´oc_scsi_dev_hªdËr_wr™e
(
fže
 *file,

1546 cÚ¡ 
__u£r
 *
buf
,

1547 
size_t
 
Ëngth
, 
loff_t
 *
off
)

1549 
sc¡_dev_ty³
 *
dev_ty³
 = 
	`PDE_DATA
(
	`fže_šode
(
fže
));

1550 
ssize_t
 
»s
 = 0;

1551 *
bufãr
;

1552 *
¡¬t
;

1553 
eof
 = 0;

1555 
	`TRACE_ENTRY
();

1557 ià(
dev_ty³
->
wr™e_´oc
 =ð
NULL
) {

1558 
»s
 = -
ENOTSUPP
;

1559 
out
;

1562 ià(
Ëngth
 > 
SCST_PROC_BLOCK_SIZE
) {

1563 
»s
 = -
EOVERFLOW
;

1564 
out
;

1566 ià(!
buf
) {

1567 
»s
 = -
EINVAL
;

1568 
out
;

1571 
bufãr
 = (*)
	`__g‘_ä“_·ge
(
GFP_KERNEL
);

1572 ià(!
bufãr
) {

1573 
»s
 = -
ENOMEM
;

1574 
out
;

1577 ià(
	`cÝy_äom_u£r
(
bufãr
, 
buf
, 
Ëngth
)) {

1578 
»s
 = -
EFAULT
;

1579 
out_ä“
;

1581 ià(
Ëngth
 < 
PAGE_SIZE
) {

1582 
bufãr
[
Ëngth
] = '\0';

1583 } ià(
bufãr
[
PAGE_SIZE
-1]) {

1584 
»s
 = -
EINVAL
;

1585 
out_ä“
;

1588 
	`TRACE_BUFFER
("Bufãr", 
bufãr
, 
Ëngth
);

1590 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_´oc_mu‹x
) != 0) {

1591 
»s
 = -
EINTR
;

1592 
out_ä“
;

1595 
»s
 = 
dev_ty³
->
	`wr™e_´oc
(
bufãr
, &
¡¬t
, 0, 
Ëngth
, &
eof
, dev_type);

1597 
	`mu‹x_uÆock
(&
sc¡_´oc_mu‹x
);

1599 
out_ä“
:

1600 
	`ä“_·ge
(()
bufãr
);

1602 
out
:

1603 
	`TRACE_EXIT_RES
(
»s
);

1604  
»s
;

1605 
	}
}

1607 
ssize_t
 
	$sc¡_´oc_scsi_tgt_g’_wr™e
(
fže
 *file,

1608 cÚ¡ 
__u£r
 *
buf
,

1609 
size_t
 
Ëngth
, 
loff_t
 *
off
)

1611 
»s
, 
rc
 = 0, 
aùiÚ
;

1612 *
bufãr
, *
p
, *
µ
, *
µp
;

1613 
sc¡_acg
 *
a
, *
acg
 = 
NULL
;

1614 
addr_m‘hod
 = 
SCST_LUN_ADDR_METHOD_PERIPHERAL
;

1616 
	`TRACE_ENTRY
();

1618 ià(
Ëngth
 > 
SCST_PROC_BLOCK_SIZE
) {

1619 
»s
 = -
EOVERFLOW
;

1620 
out
;

1622 ià(!
buf
) {

1623 
»s
 = -
EINVAL
;

1624 
out
;

1626 
bufãr
 = (*)
	`__g‘_ä“_·ge
(
GFP_KERNEL
);

1627 ià(!
bufãr
) {

1628 
»s
 = -
ENOMEM
;

1629 
out
;

1631 ià(
	`cÝy_äom_u£r
(
bufãr
, 
buf
, 
Ëngth
)) {

1632 
»s
 = -
EFAULT
;

1633 
out_ä“
;

1635 ià(
Ëngth
 < 
PAGE_SIZE
) {

1636 
bufãr
[
Ëngth
] = '\0';

1637 } ià(
bufãr
[
PAGE_SIZE
-1]) {

1638 
»s
 = -
EINVAL
;

1639 
out_ä“
;

1649 
p
 = 
bufãr
;

1650 ià(
p
[
	`¡¾’
(p) - 1] == '\n')

1651 
p
[
	`¡¾’
(p) - 1] = '\0';

1652 ià(!
	`¡ºÿ£cmp
("assigÀ", 
p
, 7)) {

1653 
p
 += 7;

1654 
aùiÚ
 = 
SCST_PROC_ACTION_ASSIGN
;

1655 } ià(!
	`¡ºÿ£cmp
("add_grou°", 
p
, 10)) {

1656 
p
 += 10;

1657 
aùiÚ
 = 
SCST_PROC_ACTION_ADD_GROUP
;

1658 } ià(!
	`¡ºÿ£cmp
("d–_grou°", 
p
, 10)) {

1659 
p
 += 10;

1660 
aùiÚ
 = 
SCST_PROC_ACTION_DEL_GROUP
;

1661 } ià(!
	`¡ºÿ£cmp
("»Çme_grou°", 
p
, 13)) {

1662 
p
 += 13;

1663 
aùiÚ
 = 
SCST_PROC_ACTION_RENAME_GROUP
;

1665 
	`PRINT_ERROR
("UnknowÀaùiÚ \"%s\"", 
p
);

1666 
»s
 = -
EINVAL
;

1667 
out_ä“
;

1670 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
SCST_SUSPEND_TIMEOUT_USER
);

1671 ià(
»s
 != 0)

1672 
out_ä“
;

1674 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
) != 0) {

1675 
»s
 = -
EINTR
;

1676 
out_ä“_»sume
;

1679 
»s
 = 
Ëngth
;

1681 
	`is¥aû
(*
p
) && *p != '\0')

1682 
p
++;

1684 
aùiÚ
) {

1685 
SCST_PROC_ACTION_ADD_GROUP
:

1686 
SCST_PROC_ACTION_DEL_GROUP
:

1687 
SCST_PROC_ACTION_RENAME_GROUP
:

1688 
µ
 = 
p
;

1689 !
	`is¥aû
(*
µ
) && *pp != '\0')

1690 
µ
++;

1691 ià(*
µ
 != '\0') {

1692 *
µ
 = '\0';

1693 
µ
++;

1694 
	`is¥aû
(*
µ
) && *pp != '\0')

1695 
µ
++;

1696 ià(*
µ
 != '\0') {

1697 
aùiÚ
) {

1698 
SCST_PROC_ACTION_ADD_GROUP
:

1699 
µp
 = 
µ
;

1700 !
	`is¥aû
(*
µp
) && *ppp != '\0')

1701 
µp
++;

1702 ià(*
µp
 != '\0') {

1703 *
µp
 = '\0';

1704 
µp
++;

1705 
	`is¥aû
(*
µp
) && *ppp != '\0')

1706 
µp
++;

1707 ià(*
µp
 != '\0') {

1708 
	`PRINT_ERROR
("%s", "Too many "

1710 
»s
 = -
EINVAL
;

1711 
out_up_ä“
;

1714 ià(
	`¡rÿ£cmp
(
µ
, "FLAT") == 0)

1715 
addr_m‘hod
 = 
SCST_LUN_ADDR_METHOD_FLAT
;

1716 ià(
	`¡rÿ£cmp
(
µ
, "LUN") == 0)

1717 
addr_m‘hod
 = 
SCST_LUN_ADDR_METHOD_LUN
;

1719 
	`PRINT_ERROR
("Unexpected "

1720 "¬gum’ˆ%s", 
µ
);

1721 
»s
 = -
EINVAL
;

1722 
out_up_ä“
;

1725 
SCST_PROC_ACTION_DEL_GROUP
:

1726 
	`PRINT_ERROR
("%s", "Too many "

1728 
»s
 = -
EINVAL
;

1729 
out_up_ä“
;

1734 ià(
	`¡rcmp
(
p
, 
SCST_DEFAULT_ACG_NAME
) == 0) {

1735 
	`PRINT_ERROR
("Attempto‡dd/delete/rename…redefined "

1736 "grou°\"%s\"", 
p
);

1737 
»s
 = -
EINVAL
;

1738 
out_up_ä“
;

1741 
	`li¡_fÜ_—ch_’Œy
(
a
, &
sc¡_acg_li¡
, 
acg_li¡_’Œy
) {

1742 ià(
	`¡rcmp
(
a
->
acg_Çme
, 
p
) == 0) {

1743 
	`TRACE_DBG
("group (acg) %p %s found",

1744 
a
,‡->
acg_Çme
);

1745 
acg
 = 
a
;

1750 
aùiÚ
) {

1751 
SCST_PROC_ACTION_ADD_GROUP
:

1752 ià(
acg
) {

1753 
	`PRINT_ERROR
("acg‚am% exi¡", 
p
);

1754 
»s
 = -
EINVAL
;

1755 
out_up_ä“
;

1757 
rc
 = 
	`sc¡_´oc_group_add
(
p
, 
addr_m‘hod
);

1759 
SCST_PROC_ACTION_DEL_GROUP
:

1760 ià(
acg
 =ð
NULL
) {

1761 
	`PRINT_ERROR
("acg‚am% nÙ found", 
p
);

1762 
»s
 = -
EINVAL
;

1763 
out_up_ä“
;

1765 
rc
 = 
	`sc¡_´oc_d–_ä“_acg
(
acg
, 1);

1767 
SCST_PROC_ACTION_RENAME_GROUP
:

1768 ià(
acg
 =ð
NULL
) {

1769 
	`PRINT_ERROR
("acg‚am% nÙ found", 
p
);

1770 
»s
 = -
EINVAL
;

1771 
out_up_ä“
;

1774 
p
 = 
µ
;

1775 !
	`is¥aû
(*
µ
) && *pp != '\0')

1776 
µ
++;

1777 ià(*
µ
 != '\0') {

1778 *
µ
 = '\0';

1779 
µ
++;

1780 
	`is¥aû
(*
µ
) && *pp != '\0')

1781 
µ
++;

1782 ià(*
µ
 != '\0') {

1783 
	`PRINT_ERROR
("%s", "Too many‡rguments");

1784 
»s
 = -
EINVAL
;

1785 
out_up_ä“
;

1788 
rc
 = 
	`sc¡_´oc_»Çme_acg
(
acg
, 
p
);

1792 
SCST_PROC_ACTION_ASSIGN
:

1793 
rc
 = 
	`sc¡_´oc_assign_hªdËr
(
p
);

1797 ià(
rc
 != 0)

1798 
»s
 = 
rc
;

1800 
out_up_ä“
:

1801 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1803 
out_ä“_»sume
:

1804 
	`sc¡_»sume_aùiv™y
();

1806 
out_ä“
:

1807 
	`ä“_·ge
(()
bufãr
);

1809 
out
:

1810 
	`TRACE_EXIT_RES
(
»s
);

1811  
»s
;

1812 
	}
}

1815 
	$sc¡_´oc_assign_hªdËr
(*
buf
)

1817 
»s
 = 0;

1818 *
p
 = 
buf
, *
e
, *
“
;

1819 
ho¡
, 
chªÃl
 = 0, 
id
 = 0, 
lun
 = 0;

1820 
sc¡_deviû
 *
d
, *
dev
 = 
NULL
;

1821 
sc¡_dev_ty³
 *
dt
, *
hªdËr
 = 
NULL
;

1823 
	`TRACE_ENTRY
();

1825 
	`is¥aû
(*
p
) && *p != '\0')

1826 
p
++;

1828 
ho¡
 = 
	`sim¶e_¡¹oul
(
p
, &p, 0);

1829 ià((
ho¡
 =ð
ULONG_MAX
è|| (*
p
 != ':'))

1830 
out_syÁ_”r
;

1831 
p
++;

1832 
chªÃl
 = 
	`sim¶e_¡¹oul
(
p
, &p, 0);

1833 ià((
chªÃl
 =ð
ULONG_MAX
è|| (*
p
 != ':'))

1834 
out_syÁ_”r
;

1835 
p
++;

1836 
id
 = 
	`sim¶e_¡¹oul
(
p
, &p, 0);

1837 ià((
chªÃl
 =ð
ULONG_MAX
è|| (*
p
 != ':'))

1838 
out_syÁ_”r
;

1839 
p
++;

1840 
lun
 = 
	`sim¶e_¡¹oul
(
p
, &p, 0);

1841 ià(
lun
 =ð
ULONG_MAX
)

1842 
out_syÁ_”r
;

1844 
e
 = 
p
;

1845 
e
++;

1846 
	`is¥aû
(*
e
) && *e != '\0')

1847 
e
++;

1848 
“
 = 
e
;

1849 !
	`is¥aû
(*
“
) && *ee != '\0')

1850 
“
++;

1851 *
“
 = '\0';

1853 
	`TRACE_DBG
("Dev %ld:%ld:%ld:%ld, hªdË¸%s", 
ho¡
, 
chªÃl
, 
id
, 
lun
, 
e
);

1855 
	`li¡_fÜ_—ch_’Œy
(
d
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

1856 ià((
d
->
vœt_id
 == 0) &&

1857 
d
->
scsi_dev
->
ho¡
->
ho¡_no
 == host &&

1858 
d
->
scsi_dev
->
chªÃl
 == channel &&

1859 
d
->
scsi_dev
->
id
 == id &&

1860 
d
->
scsi_dev
->
lun
 ==†un) {

1861 
dev
 = 
d
;

1862 
	`TRACE_DBG
("Dev %p (%ld:%ld:%ld:%ld) found",

1863 
dev
, 
ho¡
, 
chªÃl
, 
id
, 
lun
);

1868 ià(
dev
 =ð
NULL
) {

1869 
	`PRINT_ERROR
("Device %ld:%ld:%ld:%ld‚ot found",

1870 
ho¡
, 
chªÃl
, 
id
, 
lun
);

1871 
»s
 = -
EINVAL
;

1872 
out
;

1875 
	`li¡_fÜ_—ch_’Œy
(
dt
, &
sc¡_dev_ty³_li¡
, 
dev_ty³_li¡_’Œy
) {

1876 ià(!
	`¡rcmp
(
dt
->
Çme
, 
e
)) {

1877 
hªdËr
 = 
dt
;

1878 
	`TRACE_DBG
("Dev handler %p with‚ame %s found",

1879 
dt
, dt->
Çme
);

1884 ià(
hªdËr
 =ð
NULL
) {

1885 
	`PRINT_ERROR
("HªdË¸% nÙ found", 
e
);

1886 
»s
 = -
EINVAL
;

1887 
out
;

1890 ià(
dev
->
scsi_dev
->
ty³
 !ð
hªdËr
->type) {

1891 
	`PRINT_ERROR
("Type %d of device %s differs fromype "

1892 "%d oàdev hªdË¸%s", 
dev
->
ty³
,

1893 
dev
->
hªdËr
->
Çme
, hªdËr->
ty³
, handler->name);

1894 
»s
 = -
EINVAL
;

1895 
out
;

1898 
»s
 = 
	`sc¡_assign_dev_hªdËr
(
dev
, 
hªdËr
);

1900 
out
:

1901 
	`TRACE_EXIT_RES
(
»s
);

1902  
»s
;

1904 
out_syÁ_”r
:

1905 
	`PRINT_ERROR
("SyÁaxƒ¼Ü oÀ%s", 
p
);

1906 
»s
 = -
EINVAL
;

1907 
out
;

1908 
	}
}

1910 
ssize_t
 
	$sc¡_´oc_groups_deviûs_wr™e
(
fže
 *file,

1911 cÚ¡ 
__u£r
 *
buf
,

1912 
size_t
 
Ëngth
, 
loff_t
 *
off
)

1914 
»s
, 
aùiÚ
, 
rc
, 
»ad_Úly
 = 0;

1915 *
bufãr
, *
p
, *
e
 = 
NULL
;

1916 
vœt_lun
;

1917 
sc¡_acg
 *
acg
 = 
	`PDE_DATA
(
	`fže_šode
(
fže
));

1918 
sc¡_acg_dev
 *
acg_dev
 = 
NULL
, *
acg_dev_tmp
;

1919 
sc¡_deviû
 *
d
, *
dev
 = 
NULL
;

1921 
	`TRACE_ENTRY
();

1923 ià(
Ëngth
 > 
SCST_PROC_BLOCK_SIZE
) {

1924 
»s
 = -
EOVERFLOW
;

1925 
out
;

1927 ià(!
buf
) {

1928 
»s
 = -
EINVAL
;

1929 
out
;

1931 
bufãr
 = (*)
	`__g‘_ä“_·ge
(
GFP_KERNEL
);

1932 ià(!
bufãr
) {

1933 
»s
 = -
ENOMEM
;

1934 
out
;

1936 ià(
	`cÝy_äom_u£r
(
bufãr
, 
buf
, 
Ëngth
)) {

1937 
»s
 = -
EFAULT
;

1938 
out_ä“
;

1940 ià(
Ëngth
 < 
PAGE_SIZE
) {

1941 
bufãr
[
Ëngth
] = '\0';

1942 } ià(
bufãr
[
PAGE_SIZE
-1]) {

1943 
»s
 = -
EINVAL
;

1944 
out_ä“
;

1958 
p
 = 
bufãr
;

1959 ià(
p
[
	`¡¾’
(p) - 1] == '\n')

1960 
p
[
	`¡¾’
(p) - 1] = '\0';

1961 ià(!
	`¡ºÿ£cmp
("þ—r", 
p
, 5)) {

1962 
aùiÚ
 = 
SCST_PROC_ACTION_CLEAR
;

1963 } ià(!
	`¡ºÿ£cmp
("add ", 
p
, 4)) {

1964 
p
 += 4;

1965 
aùiÚ
 = 
SCST_PROC_ACTION_ADD
;

1966 } ià(!
	`¡ºÿ£cmp
("d– ", 
p
, 4)) {

1967 
p
 += 4;

1968 
aùiÚ
 = 
SCST_PROC_ACTION_DEL
;

1969 } ià(!
	`¡ºÿ£cmp
("»¶aû ", 
p
, 8)) {

1970 
p
 += 8;

1971 
aùiÚ
 = 
SCST_PROC_ACTION_REPLACE
;

1973 
	`PRINT_ERROR
("UnknowÀaùiÚ \"%s\"", 
p
);

1974 
»s
 = -
EINVAL
;

1975 
out_ä“
;

1978 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
SCST_SUSPEND_TIMEOUT_USER
);

1979 ià(
»s
 != 0)

1980 
out_ä“
;

1982 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
) != 0) {

1983 
»s
 = -
EINTR
;

1984 
out_ä“_»sume
;

1987 
»s
 = 
Ëngth
;

1989 
aùiÚ
) {

1990 
SCST_PROC_ACTION_ADD
:

1991 
SCST_PROC_ACTION_DEL
:

1992 
SCST_PROC_ACTION_REPLACE
:

1993 
	`is¥aû
(*
p
) && *p != '\0')

1994 
p
++;

1995 
e
 = 
p
;

1996 !
	`is¥aû
(*
e
) && *e != '\0')

1997 
e
++;

1998 *
e
 = 0;

2000 
	`li¡_fÜ_—ch_’Œy
(
d
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

2001 ià(!
	`¡rcmp
(
d
->
vœt_Çme
, 
p
)) {

2002 
dev
 = 
d
;

2003 
	`TRACE_DBG
("Deviû %°(%sèfound", 
dev
, 
p
);

2007 ià(
dev
 =ð
NULL
) {

2008 
	`PRINT_ERROR
("Deviû % nÙ found", 
p
);

2009 
»s
 = -
EINVAL
;

2010 
out_ä“_up
;

2017 
aùiÚ
) {

2018 
SCST_PROC_ACTION_ADD
:

2019 
SCST_PROC_ACTION_REPLACE
:

2021 
boÞ
 
dev_»¶aûd
 = 
çl£
;

2023 
e
++;

2024 
	`is¥aû
(*
e
) && *e != '\0')

2025 
e
++;

2027 
vœt_lun
 = 
	`sim¶e_¡¹oul
(
e
, &e, 0);

2028 ià(
vœt_lun
 > 
SCST_MAX_LUN
) {

2029 
	`PRINT_ERROR
("ToØbig LUN %d (max %d)", 
vœt_lun
,

2030 
SCST_MAX_LUN
);

2031 
»s
 = -
EINVAL
;

2032 
out_ä“_up
;

2035 
	`is¥aû
(*
e
) && *e != '\0')

2036 
e
++;

2038 ià(*
e
 != '\0') {

2039 ià(!
	`¡ºÿ£cmp
("READ_ONLY", 
e
, 9))

2040 
»ad_Úly
 = 1;

2042 
	`PRINT_ERROR
("UnknowÀÝtiÚ \"%s\"", 
e
);

2043 
»s
 = -
EINVAL
;

2044 
out_ä“_up
;

2048 
	`li¡_fÜ_—ch_’Œy
(
acg_dev_tmp
, &
acg
->
acg_dev_li¡
,

2049 
acg_dev_li¡_’Œy
) {

2050 ià(
acg_dev_tmp
->
lun
 =ð
vœt_lun
) {

2051 
acg_dev
 = 
acg_dev_tmp
;

2055 ià(
acg_dev
 !ð
NULL
) {

2056 ià(
aùiÚ
 =ð
SCST_PROC_ACTION_ADD
) {

2057 
	`PRINT_ERROR
("virt†un %d‡lreadyƒxists in "

2058 "grou°%s", 
vœt_lun
, 
acg
->
acg_Çme
);

2059 
»s
 = -
EEXIST
;

2060 
out_ä“_up
;

2063 
rc
 = 
	`sc¡_acg_d–_lun
(
acg
, 
acg_dev
->
lun
,

2064 
çl£
);

2065 ià(
rc
) {

2066 
»s
 = 
rc
;

2067 
out_ä“_up
;

2069 
dev_»¶aûd
 = 
Œue
;

2073 
rc
 = 
	`sc¡_acg_add_lun
(
acg
, 
NULL
, 
dev
, 
vœt_lun
,

2074 
»ad_Úly
 ? 
SCST_ADD_LUN_READ_ONLY
 : 0,

2075 
NULL
);

2076 ià(
rc
) {

2077 
»s
 = 
rc
;

2078 
out_ä“_up
;

2081 ià(
aùiÚ
 =ð
SCST_PROC_ACTION_ADD
)

2082 
	`sc¡_»pÜt_luns_chªged
(
acg
);

2084 ià(
dev_»¶aûd
) {

2085 
sc¡_tgt_dev
 *
tgt_dev
;

2087 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

2088 
dev_tgt_dev_li¡_’Œy
) {

2089 ià((
tgt_dev
->
acg_dev
->
acg
 ==‡cg) &&

2090 (
tgt_dev
->
lun
 =ð
vœt_lun
)) {

2091 
	`TRACE_MGMT_DBG
("INQUIRY DATA HAS CHANGED"

2092 " oÀtgt_dev %p", 
tgt_dev
);

2093 
	`sc¡_g’_«n_Ü_ua
(
tgt_dev
,

2094 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šquœy_d©a_chªged
));

2100 
SCST_PROC_ACTION_DEL
:

2108 
sc¡_acg_dev
 *
a
;

2109 
	`li¡_fÜ_—ch_’Œy
(
a
, &
acg
->
acg_dev_li¡
, 
acg_dev_li¡_’Œy
) {

2110 ià(
a
->
dev
 == dev) {

2111 
rc
 = 
	`sc¡_acg_d–_lun
(
acg
, 
a
->
lun
, 
Œue
);

2112 ià(
rc
)

2113 
»s
 = 
rc
;

2114 
out_ä“_up
;

2117 
	`PRINT_ERROR
("Deviû i nÙ found iÀgrou°%s", 
acg
->
acg_Çme
);

2120 
SCST_PROC_ACTION_CLEAR
:

2121 
	`li¡_fÜ_—ch_’Œy_§ã
(
acg_dev
, 
acg_dev_tmp
,

2122 &
acg
->
acg_dev_li¡
,

2123 
acg_dev_li¡_’Œy
) {

2124 
rc
 = 
	`sc¡_acg_d–_lun
(
acg
, 
acg_dev
->
lun
,

2125 
	`li¡_is_Ï¡
(&
acg_dev
->
acg_dev_li¡_’Œy
,

2126 &
acg
->
acg_dev_li¡
));

2127 ià(
rc
) {

2128 
»s
 = 
rc
;

2129 
out_ä“_up
;

2135 
out_ä“_up
:

2136 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

2138 
out_ä“_»sume
:

2139 
	`sc¡_»sume_aùiv™y
();

2141 
out_ä“
:

2142 
	`ä“_·ge
(()
bufãr
);

2144 
out
:

2145 
	`TRACE_EXIT_RES
(
»s
);

2146  
»s
;

2147 
	}
}

2149 
ssize_t
 
	$sc¡_´oc_groups_Çmes_wr™e
(
fže
 *file,

2150 cÚ¡ 
__u£r
 *
buf
,

2151 
size_t
 
Ëngth
, 
loff_t
 *
off
)

2153 
»s
 = 
Ëngth
, 
rc
 = 0, 
aùiÚ
;

2154 *
bufãr
, *
p
, *
µ
 = 
NULL
;

2155 
sc¡_acg
 *
acg
 = 
	`PDE_DATA
(
	`fže_šode
(
fže
));

2156 
sc¡_aú
 *
n
, *
Â
;

2158 
	`TRACE_ENTRY
();

2160 ià(
Ëngth
 > 
SCST_PROC_BLOCK_SIZE
) {

2161 
»s
 = -
EOVERFLOW
;

2162 
out
;

2164 ià(!
buf
) {

2165 
»s
 = -
EINVAL
;

2166 
out
;

2168 
bufãr
 = (*)
	`__g‘_ä“_·ge
(
GFP_KERNEL
);

2169 ià(!
bufãr
) {

2170 
»s
 = -
ENOMEM
;

2171 
out
;

2173 ià(
	`cÝy_äom_u£r
(
bufãr
, 
buf
, 
Ëngth
)) {

2174 
»s
 = -
EFAULT
;

2175 
out_ä“
;

2177 ià(
Ëngth
 < 
PAGE_SIZE
) {

2178 
bufãr
[
Ëngth
] = '\0';

2179 } ià(
bufãr
[
PAGE_SIZE
-1]) {

2180 
»s
 = -
EINVAL
;

2181 
out_ä“
;

2189 
p
 = 
bufãr
;

2190 ià(
p
[
	`¡¾’
(p) - 1] == '\n')

2191 
p
[
	`¡¾’
(p) - 1] = '\0';

2192 ià(!
	`¡ºÿ£cmp
("þ—r", 
p
, 5)) {

2193 
aùiÚ
 = 
SCST_PROC_ACTION_CLEAR
;

2194 } ià(!
	`¡ºÿ£cmp
("add ", 
p
, 4)) {

2195 
p
 += 4;

2196 
aùiÚ
 = 
SCST_PROC_ACTION_ADD
;

2197 } ià(!
	`¡ºÿ£cmp
("d– ", 
p
, 4)) {

2198 
p
 += 4;

2199 
aùiÚ
 = 
SCST_PROC_ACTION_DEL
;

2200 } ià(!
	`¡ºÿ£cmp
("mov", 
p
, 5)) {

2201 
p
 += 5;

2202 
aùiÚ
 = 
SCST_PROC_ACTION_MOVE
;

2204 
	`PRINT_ERROR
("UnknowÀaùiÚ \"%s\"", 
p
);

2205 
»s
 = -
EINVAL
;

2206 
out_ä“
;

2209 
aùiÚ
) {

2210 
SCST_PROC_ACTION_ADD
:

2211 
SCST_PROC_ACTION_DEL
:

2212 
SCST_PROC_ACTION_MOVE
:

2213 
	`is¥aû
(*
p
) && *p != '\0')

2214 
p
++;

2215 
µ
 = 
p
;

2216 !
	`is¥aû
(*
µ
) && *pp != '\0')

2217 
µ
++;

2218 ià(*
µ
 != '\0') {

2219 *
µ
 = '\0';

2220 
µ
++;

2221 
	`is¥aû
(*
µ
) && *pp != '\0')

2222 
µ
++;

2223 ià(*
µ
 != '\0') {

2224 
aùiÚ
) {

2225 
SCST_PROC_ACTION_ADD
:

2226 
SCST_PROC_ACTION_DEL
:

2227 
	`PRINT_ERROR
("%s", "Too many "

2229 
»s
 = -
EINVAL
;

2230 
out_ä“
;

2237 
rc
 = 
	`sc¡_su¥’d_aùiv™y
(
SCST_SUSPEND_TIMEOUT_USER
);

2238 ià(
rc
 != 0)

2239 
out_ä“
;

2241 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
) != 0) {

2242 
»s
 = -
EINTR
;

2243 
out_ä“_»sume
;

2246 
aùiÚ
) {

2247 
SCST_PROC_ACTION_ADD
:

2248 
rc
 = 
	`sc¡_acg_add_aú
(
acg
, 
p
);

2250 
SCST_PROC_ACTION_DEL
:

2251 
rc
 = 
	`sc¡_acg_»move_Çme
(
acg
, 
p
, 
Œue
);

2253 
SCST_PROC_ACTION_MOVE
:

2255 
sc¡_acg
 *
a
, *
Ãw_acg
 = 
NULL
;

2256 *
Çme
 = 
p
;

2257 
p
 = 
µ
;

2258 !
	`is¥aû
(*
µ
) && *pp != '\0')

2259 
µ
++;

2260 ià(*
µ
 != '\0') {

2261 *
µ
 = '\0';

2262 
µ
++;

2263 
	`is¥aû
(*
µ
) && *pp != '\0')

2264 
µ
++;

2265 ià(*
µ
 != '\0') {

2266 
	`PRINT_ERROR
("%s", "Too many‡rguments");

2267 
»s
 = -
EINVAL
;

2268 
out_ä“_uÆock
;

2271 
	`li¡_fÜ_—ch_’Œy
(
a
, &
sc¡_acg_li¡
, 
acg_li¡_’Œy
) {

2272 ià(
	`¡rcmp
(
a
->
acg_Çme
, 
p
) == 0) {

2273 
	`TRACE_DBG
("group (acg) %p %s found",

2274 
a
,‡->
acg_Çme
);

2275 
Ãw_acg
 = 
a
;

2279 ià(
Ãw_acg
 =ð
NULL
) {

2280 
	`PRINT_ERROR
("Grou°% nÙ found", 
p
);

2281 
»s
 = -
EINVAL
;

2282 
out_ä“_uÆock
;

2284 
rc
 = 
	`sc¡_acg_»move_Çme
(
acg
, 
Çme
, 
çl£
);

2285 ià(
rc
 != 0)

2286 
out_ä“_uÆock
;

2287 
rc
 = 
	`sc¡_acg_add_aú
(
Ãw_acg
, 
Çme
);

2288 ià(
rc
 != 0)

2289 
	`sc¡_acg_add_aú
(
acg
, 
Çme
);

2292 
SCST_PROC_ACTION_CLEAR
:

2293 
	`li¡_fÜ_—ch_’Œy_§ã
(
n
, 
Â
, &
acg
->
aú_li¡
,

2294 
aú_li¡_’Œy
) {

2295 
	`sc¡_d–_ä“_aú
(
n
, 
çl£
);

2297 
	`sc¡_check_»assign_£ssiÚs
();

2301 
out_ä“_uÆock
:

2302 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

2304 
out_ä“_»sume
:

2305 
	`sc¡_»sume_aùiv™y
();

2307 
out_ä“
:

2308 
	`ä“_·ge
(()
bufãr
);

2310 
out
:

2311 ià(
rc
 < 0)

2312 
»s
 = 
rc
;

2314 
	`TRACE_EXIT_RES
(
»s
);

2315  
»s
;

2316 
	}
}

2318 
	$sc¡_v”siÚ_šfo_show
(
£q_fže
 *
£q
, *
v
)

2320 
	`TRACE_ENTRY
();

2322 
	`£q_´štf
(
£q
, "%s\n", 
SCST_VERSION_STRING
);

2324 #ifdeà
CONFIG_SCST_STRICT_SERIALIZING


2325 
	`£q_´štf
(
£q
, "STRICT_SERIALIZING\n");

2328 #ifdeà
CONFIG_SCST_EXTRACHECKS


2329 
	`£q_´štf
(
£q
, "EXTRACHECKS\n");

2332 #ifdeà
CONFIG_SCST_TRACING


2333 
	`£q_´štf
(
£q
, "TRACING\n");

2336 #ifdeà
CONFIG_SCST_DEBUG


2337 
	`£q_´štf
(
£q
, "DEBUG\n");

2340 #ifdeà
CONFIG_SCST_DEBUG_TM


2341 
	`£q_´štf
(
£q
, "DEBUG_TM\n");

2344 #ifdeà
CONFIG_SCST_DEBUG_RETRY


2345 
	`£q_´štf
(
£q
, "DEBUG_RETRY\n");

2348 #ifdeà
CONFIG_SCST_DEBUG_OOM


2349 
	`£q_´štf
(
£q
, "DEBUG_OOM\n");

2352 #ifdeà
CONFIG_SCST_DEBUG_SN


2353 
	`£q_´štf
(
£q
, "DEBUG_SN\n");

2356 #ifdeà
CONFIG_SCST_USE_EXPECTED_VALUES


2357 
	`£q_´štf
(
£q
, "USE_EXPECTED_VALUES\n");

2360 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


2361 
	`£q_´štf
(
£q
, "TEST_IO_IN_SIRQ\n");

2364 #ifdeà
CONFIG_SCST_STRICT_SECURITY


2365 
	`£q_´štf
(
£q
, "STRICT_SECURITY\n");

2368 
	`TRACE_EXIT
();

2370 
	}
}

2372 
sc¡_´oc_d©a
 
	gsc¡_v”siÚ_´oc_d©a
 = {

2373 
SCST_DEF_RW_SEQ_OP
(
NULL
)

2374 .
show
 = 
sc¡_v”siÚ_šfo_show
,

2377 
	$sc¡_h–p_šfo_show
(
£q_fže
 *
£q
, *
v
)

2379 
	`TRACE_ENTRY
();

2381 
	`£q_´štf
(
£q
, "%s\n", 
sc¡_´oc_h–p_¡ršg
);

2383 
	`TRACE_EXIT
();

2385 
	}
}

2387 
sc¡_´oc_d©a
 
	gsc¡_h–p_´oc_d©a
 = {

2388 
SCST_DEF_RW_SEQ_OP
(
NULL
)

2389 .
show
 = 
sc¡_h–p_šfo_show
,

2392 
	$sc¡_dev_hªdËr_ty³_šfo_show
(
£q_fže
 *
£q
, *
v
)

2394 
sc¡_dev_ty³
 *
dev_ty³
 = (sc¡_dev_ty³ *)
£q
->
´iv©e
;

2396 
	`TRACE_ENTRY
();

2398 
	`£q_´štf
(
£q
, "%d - %s\n", 
dev_ty³
->
ty³
,

2399 
dev_ty³
->
ty³
 >ð()
	`ARRAY_SIZE
(
sc¡_´oc_dev_hªdËr_ty³
)

2400 ? "unknown" : 
sc¡_´oc_dev_hªdËr_ty³
[
dev_ty³
->
ty³
]);

2402 
	`TRACE_EXIT
();

2404 
	}
}

2406 
sc¡_´oc_d©a
 
	gsc¡_dev_hªdËr_ty³_´oc_d©a
 = {

2407 
SCST_DEF_RW_SEQ_OP
(
NULL
)

2408 .
show
 = 
sc¡_dev_hªdËr_ty³_šfo_show
,

2411 
	$sc¡_£ssiÚs_šfo_show
(
£q_fže
 *
£q
, *
v
)

2413 
»s
 = 0;

2414 
sc¡_acg
 *
acg
;

2415 
sc¡_£ssiÚ
 *
£ss
;

2417 
	`TRACE_ENTRY
();

2419 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
) != 0) {

2420 
»s
 = -
EINTR
;

2421 
out
;

2424 
	`£q_´štf
(
£q
, "%-20s %-45s %-35s %-15s\n",

2428 
	`li¡_fÜ_—ch_’Œy
(
acg
, &
sc¡_acg_li¡
, 
acg_li¡_’Œy
) {

2429 
	`li¡_fÜ_—ch_’Œy
(
£ss
, &
acg
->
acg_£ss_li¡
,

2430 
acg_£ss_li¡_’Œy
) {

2431 
aùive_cmds
 = 0, 
t
;

2432 
t
 = 
SESS_TGT_DEV_LIST_HASH_SIZE
-1; >= 0;--) {

2433 
li¡_h—d
 *
h—d
 =

2434 &
£ss
->
£ss_tgt_dev_li¡
[
t
];

2435 
sc¡_tgt_dev
 *
tgt_dev
;

2436 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
,

2437 
£ss_tgt_dev_li¡_’Œy
) {

2438 
aùive_cmds
 +ð
	`©omic_»ad
(&
tgt_dev
->
tgt_dev_cmd_couÁ
);

2441 
	`£q_´štf
(
£q
, "%-20s %-45s %-35s %d/%d\n",

2442 
£ss
->
tgt
->
tg‰
->
Çme
,

2443 
£ss
->
š™ŸtÜ_Çme
,

2444 
acg
->
acg_Çme
, 
aùive_cmds
,

2445 
	`©omic_»ad
(&
£ss
->
£ss_cmd_couÁ
));

2449 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

2451 
out
:

2452 
	`TRACE_EXIT_RES
(
»s
);

2453  
»s
;

2454 
	}
}

2456 
sc¡_´oc_d©a
 
	gsc¡_£ssiÚs_´oc_d©a
 = {

2457 
SCST_DEF_RW_SEQ_OP
(
NULL
)

2458 .
show
 = 
sc¡_£ssiÚs_šfo_show
,

2461 
sc¡_´oc_d©a
 
	gsc¡_sgv_´oc_d©a
 = {

2462 
SCST_DEF_RW_SEQ_OP
(
NULL
)

2463 .
show
 = 
sgv_´ocšfo_show
,

2466 
	$sc¡_groups_Çmes_show
(
£q_fže
 *
£q
, *
v
)

2468 
»s
 = 0;

2469 
sc¡_acg
 *
acg
 = (sc¡_acg *)
£q
->
´iv©e
;

2470 
sc¡_aú
 *
Çme
;

2472 
	`TRACE_ENTRY
();

2474 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
) != 0) {

2475 
»s
 = -
EINTR
;

2476 
out
;

2479 
	`li¡_fÜ_—ch_’Œy
(
Çme
, &
acg
->
aú_li¡
, 
aú_li¡_’Œy
) {

2480 
	`£q_´štf
(
£q
, "%s\n", 
Çme
->name);

2483 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

2485 
out
:

2486 
	`TRACE_EXIT_RES
(
»s
);

2487  
»s
;

2488 
	}
}

2490 
sc¡_´oc_d©a
 
	gsc¡_groups_Çmes_´oc_d©a
 = {

2491 
SCST_DEF_RW_SEQ_OP
(
sc¡_´oc_groups_Çmes_wr™e
)

2492 .
show
 = 
sc¡_groups_Çmes_show
,

2495 
	$sc¡_groups_addr_m‘hod_show
(
£q_fže
 *
£q
, *
v
)

2497 
»s
 = 0;

2498 
sc¡_acg
 *
acg
 = (sc¡_acg *)
£q
->
´iv©e
;

2500 
	`TRACE_ENTRY
();

2502 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
) != 0) {

2503 
»s
 = -
EINTR
;

2504 
out
;

2507 
acg
->
addr_m‘hod
) {

2508 
SCST_LUN_ADDR_METHOD_FLAT
:

2509 
	`£q_´štf
(
£q
, "%s\n", "FLAT");

2511 
SCST_LUN_ADDR_METHOD_PERIPHERAL
:

2512 
	`£q_´štf
(
£q
, "%s\n", "PERIPHERAL");

2514 
SCST_LUN_ADDR_METHOD_LUN
:

2515 
	`£q_´štf
(
£q
, "%s\n", "LUN");

2518 
	`£q_´štf
(
£q
, "%s\n", "UNKNOWN");

2522 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

2524 
out
:

2525 
	`TRACE_EXIT_RES
(
»s
);

2526  
»s
;

2527 
	}
}

2528 
sc¡_´oc_d©a
 
	gsc¡_groups_addr_m‘hod_´oc_d©a
 = {

2529 
SCST_DEF_RW_SEQ_OP
(
NULL
)

2530 .
show
 = 
sc¡_groups_addr_m‘hod_show
,

2532 
	$sc¡_groups_deviûs_show
(
£q_fže
 *
£q
, *
v
)

2534 
»s
 = 0;

2535 
sc¡_acg
 *
acg
 = (sc¡_acg *)
£q
->
´iv©e
;

2536 
sc¡_acg_dev
 *
acg_dev
;

2538 
	`TRACE_ENTRY
();

2540 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
) != 0) {

2541 
»s
 = -
EINTR
;

2542 
out
;

2545 
	`£q_´štf
(
£q
, "%-60s%-13s%s\n", "Device (host:ch:id:lun or‚ame)",

2548 
	`li¡_fÜ_—ch_’Œy
(
acg_dev
, &
acg
->
acg_dev_li¡
, 
acg_dev_li¡_’Œy
) {

2549 
	`£q_´štf
(
£q
, "%-60s%-13lld%s\n",

2550 
acg_dev
->
dev
->
vœt_Çme
,

2551 ()
acg_dev
->
lun
,

2552 
acg_dev
->
acg_dev_rd_Úly
 ? "RO" : "");

2554 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

2556 
out
:

2557 
	`TRACE_EXIT_RES
(
»s
);

2558  
»s
;

2559 
	}
}

2561 
sc¡_´oc_d©a
 
	gsc¡_groups_deviûs_´oc_d©a
 = {

2562 
SCST_DEF_RW_SEQ_OP
(
sc¡_´oc_groups_deviûs_wr™e
)

2563 .
show
 = 
sc¡_groups_deviûs_show
,

2566 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

2568 
	$sc¡_´oc_»ad_tbl
(cÚ¡ 
sc¡_Œaû_log
 *
tbl
,

2569 
£q_fže
 *
£q
,

2570 
log_Ëv–
, *
fœ¡
)

2572 cÚ¡ 
sc¡_Œaû_log
 *
t
 = 
tbl
;

2573 
»s
 = 0;

2575 
t
->
tok’
) {

2576 ià(
log_Ëv–
 & 
t
->
v®
) {

2577 
	`£q_´štf
(
£q
, "%s%s", *
fœ¡
 ? "" : " | ", 
t
->
tok’
);

2578 *
fœ¡
 = 0;

2580 
t
++;

2582  
»s
;

2583 
	}
}

2585 
	$sc¡_´oc_log_’Œy_»ad
(
£q_fže
 *
£q
, 
log_Ëv–
,

2586 cÚ¡ 
sc¡_Œaû_log
 *
tbl
)

2588 
»s
 = 0, 
fœ¡
 = 1;

2590 
	`TRACE_ENTRY
();

2592 
	`sc¡_´oc_»ad_tbl
(
sc¡_´oc_Œaû_tbl
, 
£q
, 
log_Ëv–
, &
fœ¡
);

2594 ià(
tbl
)

2595 
	`sc¡_´oc_»ad_tbl
(
tbl
, 
£q
, 
log_Ëv–
, &
fœ¡
);

2597 
	`£q_´štf
(
£q
, "%s\n", 
fœ¡
 ? "none" : "");

2599 
	`TRACE_EXIT_RES
(
»s
);

2600  
»s
;

2601 
	}
}

2602 
EXPORT_SYMBOL_GPL
(
sc¡_´oc_log_’Œy_»ad
);

2604 
	$log_šfo_show
(
£q_fže
 *
£q
, *
v
)

2606 
»s
;

2608 
	`TRACE_ENTRY
();

2610 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_log_mu‹x
) != 0) {

2611 
»s
 = -
EINTR
;

2612 
out
;

2615 
»s
 = 
	`sc¡_´oc_log_’Œy_»ad
(
£q
, 
Œaû_æag
,

2616 
sc¡_´oc_loÿl_Œaû_tbl
);

2618 
	`mu‹x_uÆock
(&
sc¡_log_mu‹x
);

2620 
out
:

2621 
	`TRACE_EXIT_RES
(
»s
);

2622  
»s
;

2623 
	}
}

2625 
sc¡_´oc_d©a
 
	gsc¡_log_´oc_d©a
 = {

2626 
SCST_DEF_RW_SEQ_OP
(
sc¡_´oc_scsi_tgt_g’_wr™e_log
)

2627 .
show
 = 
log_šfo_show
,

2628 .
	gd©a
 = "scsi_tgt",

2633 
	$sc¡_tgt_šfo_show
(
£q_fže
 *
£q
, *
v
)

2635 
»s
 = 0;

2636 
sc¡_deviû
 *
dev
;

2638 
	`TRACE_ENTRY
();

2640 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
) != 0) {

2641 
»s
 = -
EINTR
;

2642 
out
;

2645 
	`£q_´štf
(
£q
, "%-60s%s\n", "Device (host:ch:id:lun or‚ame)",

2647 
	`li¡_fÜ_—ch_’Œy
(
dev
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

2648 
	`£q_´štf
(
£q
, "%-60s%s\n",

2649 
dev
->
vœt_Çme
, dev->
hªdËr
->
Çme
);

2652 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

2654 
out
:

2655 
	`TRACE_EXIT_RES
(
»s
);

2656  
»s
;

2657 
	}
}

2659 
sc¡_´oc_d©a
 
	gsc¡_tgt_´oc_d©a
 = {

2660 
SCST_DEF_RW_SEQ_OP
(
sc¡_´oc_scsi_tgt_g’_wr™e
)

2661 .
show
 = 
sc¡_tgt_šfo_show
,

2664 
	$sc¡_th»ads_šfo_show
(
£q_fže
 *
£q
, *
v
)

2666 
	`TRACE_ENTRY
();

2668 
	`£q_´štf
(
£q
, "%d\n", 
sc¡_maš_cmd_th»ads
.
Ä_th»ads
);

2670 
	`TRACE_EXIT
();

2672 
	}
}

2674 
sc¡_´oc_d©a
 
	gsc¡_th»ads_´oc_d©a
 = {

2675 
SCST_DEF_RW_SEQ_OP
(
sc¡_´oc_th»ads_wr™e
)

2676 .
show
 = 
sc¡_th»ads_šfo_show
,

2679 
	$sc¡_scsi_tgtšfo_show
(
£q_fže
 *
£q
, *
v
)

2681 
sc¡_tgt
 *
v‰
 = 
£q
->
´iv©e
;

2682 
»s
 = 0;

2684 
	`TRACE_ENTRY
();

2686 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_´oc_mu‹x
) != 0) {

2687 
»s
 = -
EINTR
;

2688 
out
;

2691 ià(
v‰
->
tg‰
->
»ad_´oc
)

2692 
»s
 = 
v‰
->
tg‰
->
	`»ad_´oc
(
£q
, vtt);

2694 
	`mu‹x_uÆock
(&
sc¡_´oc_mu‹x
);

2695 
out
:

2696 
	`TRACE_EXIT_RES
(
»s
);

2697  
»s
;

2698 
	}
}

2700 
sc¡_´oc_d©a
 
	gsc¡_scsi_tgt_´oc_d©a
 = {

2701 
SCST_DEF_RW_SEQ_OP
(
sc¡_´oc_scsi_tgt_wr™e
)

2702 .
show
 = 
sc¡_scsi_tgtšfo_show
,

2705 
	$sc¡_dev_hªdËr_šfo_show
(
£q_fže
 *
£q
, *
v
)

2707 
sc¡_dev_ty³
 *
dev_ty³
 = 
£q
->
´iv©e
;

2708 
»s
 = 0;

2710 
	`TRACE_ENTRY
();

2712 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_´oc_mu‹x
) != 0) {

2713 
»s
 = -
EINTR
;

2714 
out
;

2717 ià(
dev_ty³
->
»ad_´oc
)

2718 
»s
 = 
dev_ty³
->
	`»ad_´oc
(
£q
, dev_type);

2720 
	`mu‹x_uÆock
(&
sc¡_´oc_mu‹x
);

2722 
out
:

2723 
	`TRACE_EXIT_RES
(
»s
);

2724  
»s
;

2725 
	}
}

2727 
sc¡_´oc_d©a
 
	gsc¡_dev_hªdËr_´oc_d©a
 = {

2728 
SCST_DEF_RW_SEQ_OP
(
sc¡_´oc_scsi_dev_hªdËr_wr™e
)

2729 .
show
 = 
sc¡_dev_hªdËr_šfo_show
,

2732 
´oc_dœ_’Œy
 *
	$sc¡_ü—‹_´oc_’Œy
(
´oc_dœ_’Œy
 *
roÙ
,

2733 cÚ¡ *
Çme
, 
sc¡_´oc_d©a
 *
pd©a
)

2735 
´oc_dœ_’Œy
 *
p
 = 
NULL
;

2737 
	`TRACE_ENTRY
();

2739 ià(
roÙ
) {

2740 
mode_t
 
mode
;

2742 
mode
 = 
S_IFREG
 | 
S_IRUGO
 | (
pd©a
->
£q_Ý
.
wr™e
 ? 
S_IWUSR
 : 0);

2743 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 26)

2744 
p
 = 
	`´oc_ü—‹_d©a
(
Çme
, 
mode
, 
roÙ
, &
pd©a
->
£q_Ý
,

2745 
pd©a
->
d©a
);

2753 
p
 = 
	`ü—‹_´oc_’Œy
(
Çme
, 
mode
, 
roÙ
);

2754 ià(
p
) {

2755 
p
->
´oc_fÝs
 = &
pd©a
->
£q_Ý
;

2756 
p
->
d©a
 = 
pd©a
->data;

2759 ià(!
p
)

2760 
	`PRINT_ERROR
("FažØü—‹ƒÁry % š /´oc", 
Çme
);

2763 
	`TRACE_EXIT
();

2764  
p
;

2765 
	}
}

2766 
EXPORT_SYMBOL_GPL
(
sc¡_ü—‹_´oc_’Œy
);

2768 
	$sc¡_sšgË_£q_Ý’
(
šode
 *šode, 
fže
 *file)

2770 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 23) \

2771 || 
	`defšed
(
RHEL_MAJOR
è&& RHEL_MAJOR -0 >ð5 && 
RHEL_MINOR
 -0 >= 7

2772 
sc¡_´oc_d©a
 *
pd©a
 = 
	`cÚš”_of
(
	`PDE
(
šode
)->
´oc_fÝs
,

2773 
sc¡_´oc_d©a
, 
£q_Ý
);

2775 
sc¡_´oc_d©a
 *
pd©a
 = 
	`cÚš”_of
(
šode
->
i_fÝ
,

2776 
sc¡_´oc_d©a
, 
£q_Ý
);

2778  
	`sšgË_Ý’
(
fže
, 
pd©a
->
show
, 
	`PDE_DATA
(
šode
));

2779 
	}
}

2780 
EXPORT_SYMBOL_GPL
(
sc¡_sšgË_£q_Ý’
);

2782 
´oc_dœ_’Œy
 *
	$sc¡_´oc_g‘_tgt_roÙ
(

2783 
sc¡_tgt_‹m¶©e
 *
v‰
)

2785  
v‰
->
´oc_tgt_roÙ
;

2786 
	}
}

2787 
EXPORT_SYMBOL_GPL
(
sc¡_´oc_g‘_tgt_roÙ
);

2789 
´oc_dœ_’Œy
 *
	$sc¡_´oc_g‘_dev_ty³_roÙ
(

2790 
sc¡_dev_ty³
 *
d‰
)

2792  
d‰
->
´oc_dev_ty³_roÙ
;

2793 
	}
}

2794 
EXPORT_SYMBOL_GPL
(
sc¡_´oc_g‘_dev_ty³_roÙ
);

	@scst/src/scst_sysfs.c

19 
	~<lšux/kobjeù.h
>

20 
	~<lšux/¡ršg.h
>

21 
	~<lšux/sysfs.h
>

22 
	~<lšux/moduË.h
>

23 
	~<lšux/š™.h
>

24 
	~<lšux/ùy³.h
>

25 
	~<lšux/¦ab.h
>

26 
	~<lšux/kth»ad.h
>

28 #ifdeà
INSIDE_KERNEL_TREE


29 
	~<sc¡/sc¡.h
>

31 
	~"sc¡.h
"

33 
	~"sc¡_´iv.h
"

34 
	~"sc¡_´es.h
"

36 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 29)

37 #ifdeà
CONFIG_LOCKDEP


38 
lock_þass_key
 
	gsc¡_tg‰_key
;

39 
lockd•_m­
 
	gsc¡_tg‰_d•_m­
 =

40 
STATIC_LOCKDEP_MAP_INIT
("sc¡_tg‰_k»f", &
sc¡_tg‰_key
);

41 
lock_þass_key
 
	gsc¡_tgt_key
;

42 
lockd•_m­
 
	gsc¡_tgt_d•_m­
 =

43 
STATIC_LOCKDEP_MAP_INIT
("sc¡_tgt_k»f", &
sc¡_tgt_key
);

44 
lock_þass_key
 
	gsc¡_devt_key
;

45 
lockd•_m­
 
	gsc¡_devt_d•_m­
 =

46 
STATIC_LOCKDEP_MAP_INIT
("sc¡_devt_k»f", &
sc¡_devt_key
);

47 
lock_þass_key
 
	gsc¡_dev_key
;

48 
lockd•_m­
 
	gsc¡_dev_d•_m­
 =

49 
STATIC_LOCKDEP_MAP_INIT
("sc¡_dev_k»f", &
sc¡_dev_key
);

50 
EXPORT_SYMBOL
(
sc¡_dev_d•_m­
);

51 
lock_þass_key
 
	gsc¡_£ss_key
;

52 
lockd•_m­
 
	gsc¡_£ss_d•_m­
 =

53 
STATIC_LOCKDEP_MAP_INIT
("sc¡_£ss_k»f", &
sc¡_£ss_key
);

54 
lock_þass_key
 
	gsc¡_acg_dev_key
;

55 
lockd•_m­
 
	gsc¡_acg_dev_d•_m­
 =

56 
STATIC_LOCKDEP_MAP_INIT
("sc¡_acg_dev_k»f", &
sc¡_acg_dev_key
);

57 
lock_þass_key
 
	gsc¡_acg_key
;

58 
lockd•_m­
 
	gsc¡_acg_d•_m­
 =

59 
STATIC_LOCKDEP_MAP_INIT
("sc¡_acg_k»f", &
sc¡_acg_key
);

60 
lock_þass_key
 
	gsc¡_tgt_dev_key
;

61 
lockd•_m­
 
	gsc¡_tgt_dev_d•_m­
 =

62 
STATIC_LOCKDEP_MAP_INIT
("sc¡_tgt_dev_k»f", &
sc¡_tgt_dev_key
);

63 
lock_þass_key
 
	gsc¡_dg_key
;

64 
lockd•_m­
 
	gsc¡_dg_d•_m­
 =

65 
STATIC_LOCKDEP_MAP_INIT
("sc¡_dg_k»f", &
sc¡_dg_key
);

66 
lock_þass_key
 
	gsc¡_tg_key
;

67 
lockd•_m­
 
	gsc¡_tg_d•_m­
 =

68 
STATIC_LOCKDEP_MAP_INIT
("sc¡_tg_k»f", &
sc¡_tg_key
);

72 
DECLARE_COMPLETION
(
sc¡_sysfs_roÙ_»Ëa£_com¶‘iÚ
);

74 
kobjeù
 *
	gsc¡_rg‘s_kobj
;

75 
kobjeù
 *
	gsc¡_deviûs_kobj
;

76 
kobjeù
 *
	gsc¡_hªdËrs_kobj
;

77 
kobjeù
 *
	gsc¡_deviû_groups_kobj
;

79 cÚ¡ *cÚ¡ 
	gsc¡_dev_hªdËr_ty³s
[] = {

98 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

100 
DEFINE_MUTEX
(
sc¡_log_mu‹x
);

102 
sc¡_Œaû_log
 
	gsc¡_Œaû_tbl
[] = {

103 { 
TRACE_OUT_OF_MEM
, "out_of_mem" },

104 { 
TRACE_MINOR
, "minor" },

105 { 
TRACE_SG_OP
, "sg" },

106 { 
TRACE_MEMORY
, "mem" },

107 { 
TRACE_BUFF
, "buff" },

108 #iâdeà
GENERATING_UPSTREAM_PATCH


109 { 
TRACE_ENTRYEXIT
, "entryexit" },

111 { 
TRACE_PID
, "pid" },

112 { 
TRACE_LINE
, "line" },

113 { 
TRACE_FUNCTION
, "function" },

114 { 
TRACE_DEBUG
, "debug" },

115 { 
TRACE_SPECIAL
, "special" },

116 { 
TRACE_SCSI
, "scsi" },

117 { 
TRACE_MGMT
, "mgmt" },

118 { 
TRACE_MGMT_DEBUG
, "mgmt_dbg" },

119 { 
TRACE_FLOW_CONTROL
, "flow_control" },

120 { 
TRACE_PRES
, "pr" },

121 { 0, 
NULL
 }

124 
sc¡_Œaû_log
 
	gsc¡_loÿl_Œaû_tbl
[] = {

125 { 
TRACE_RTRY
, "retry" },

126 { 
TRACE_SCSI_SERIALIZING
, "scsi_serializing" },

127 { 
TRACE_DATA_SEND
, "data_send" },

128 { 
TRACE_DATA_RECEIVED
, "data_received" },

129 { 
TRACE_BLOCKING
, "block" },

130 { 0, 
NULL
 }

133 
	$sc¡_»ad_Œaû_tbl
(cÚ¡ 
sc¡_Œaû_log
 *
tbl
, *
buf
,

134 
log_Ëv–
, *
pos
)

136 cÚ¡ 
sc¡_Œaû_log
 *
t
 = 
tbl
;

138 ià(
t
 =ð
NULL
)

139 
out
;

141 
t
->
tok’
) {

142 ià(
log_Ëv–
 & 
t
->
v®
) {

143 *
pos
 +ð
	`¥rštf
(&
buf
[*pos], "%s%s",

144 (*
pos
 == 0) ? "" : " | ",

145 
t
->
tok’
);

147 
t
++;

149 
out
:

151 
	}
}

153 
ssize_t
 
	$sc¡_Œaû_Ëv–_show
(cÚ¡ 
sc¡_Œaû_log
 *
loÿl_tbl
,

154 
log_Ëv–
, *
buf
, cÚ¡ *
h–p
)

156 
pos
 = 0;

158 
	`sc¡_»ad_Œaû_tbl
(
sc¡_Œaû_tbl
, 
buf
, 
log_Ëv–
, &
pos
);

159 
	`sc¡_»ad_Œaû_tbl
(
loÿl_tbl
, 
buf
, 
log_Ëv–
, &
pos
);

161 
pos
 +ð
	`¥rštf
(&
buf
[pos], "\n\n\nUsage:\n"

166 #iâdeà
GENERATING_UPSTREAM_PATCH


174 " block, s’d_tÝ%s]\n", 
h–p
 !ð
NULL
 ? help : "");

176  
pos
;

177 
	}
}

179 
	$sc¡_wr™e_Œaû
(cÚ¡ *
buf
, 
size_t
 
Ëngth
,

180 *
log_Ëv–
, 
deçuÉ_Ëv–
,

181 cÚ¡ *
Çme
, cÚ¡ 
sc¡_Œaû_log
 *
tbl
)

183 
»s
;

184 
aùiÚ
;

185 
Ëv–
 = 0, 
ÞdËv–
;

186 *
bufãr
, *
p
, *
µ
;

187 cÚ¡ 
sc¡_Œaû_log
 *
t
;

189 
SCST_TRACE_ACTION_ALL
 = 1,

190 
SCST_TRACE_ACTION_NONE
 = 2,

191 
SCST_TRACE_ACTION_DEFAULT
 = 3,

192 
SCST_TRACE_ACTION_ADD
 = 4,

193 
SCST_TRACE_ACTION_DEL
 = 5,

194 
SCST_TRACE_ACTION_VALUE
 = 6,

197 
	`TRACE_ENTRY
();

199 ià((
buf
 =ð
NULL
è|| (
Ëngth
 == 0)) {

200 
»s
 = -
EINVAL
;

201 
out
;

204 
bufãr
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%.*s", ()
Ëngth
, 
buf
);

205 ià(
bufãr
 =ð
NULL
) {

206 
	`PRINT_ERROR
("Unableo‡lloc intermediate buffer (size %zd)",

207 
Ëngth
+1);

208 
»s
 = -
ENOMEM
;

209 
out
;

212 
	`TRACE_DBG
("bufã¸%s", 
bufãr
);

214 
µ
 = 
bufãr
;

215 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

216 ià(
	`¡rÿ£cmp
("®l", 
p
) == 0) {

217 
aùiÚ
 = 
SCST_TRACE_ACTION_ALL
;

218 } ià(
	`¡rÿ£cmp
("nÚe", 
p
) == 0 || strcasecmp("null",…) == 0) {

219 
aùiÚ
 = 
SCST_TRACE_ACTION_NONE
;

220 } ià(
	`¡rÿ£cmp
("deçuÉ", 
p
) == 0) {

221 
aùiÚ
 = 
SCST_TRACE_ACTION_DEFAULT
;

222 } ià(
	`¡rÿ£cmp
("add", 
p
) == 0) {

223 
aùiÚ
 = 
SCST_TRACE_ACTION_ADD
;

224 } ià(
	`¡rÿ£cmp
("d–", 
p
) == 0) {

225 
aùiÚ
 = 
SCST_TRACE_ACTION_DEL
;

226 } ià(
	`¡rÿ£cmp
("v®ue", 
p
) == 0) {

227 
aùiÚ
 = 
SCST_TRACE_ACTION_VALUE
;

229 
	`PRINT_ERROR
("UnknowÀaùiÚ \"%s\"", 
p
);

230 
»s
 = -
EINVAL
;

231 
out_ä“
;

234 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

236 
aùiÚ
) {

237 
SCST_TRACE_ACTION_ALL
:

238 
Ëv–
 = 
TRACE_ALL
;

240 
SCST_TRACE_ACTION_DEFAULT
:

241 
Ëv–
 = 
deçuÉ_Ëv–
;

243 
SCST_TRACE_ACTION_NONE
:

244 
Ëv–
 = 
TRACE_NULL
;

246 
SCST_TRACE_ACTION_ADD
:

247 
SCST_TRACE_ACTION_DEL
:

248 ià(
tbl
) {

249 
t
 = 
tbl
;

250 
t
->
tok’
) {

251 ià(!
	`¡rÿ£cmp
(
p
, 
t
->
tok’
)) {

252 
Ëv–
 = 
t
->
v®
;

255 
t
++;

258 ià(
Ëv–
 == 0) {

259 
t
 = 
sc¡_Œaû_tbl
;

260 
t
->
tok’
) {

261 ià(!
	`¡rÿ£cmp
(
p
, 
t
->
tok’
)) {

262 
Ëv–
 = 
t
->
v®
;

265 
t
++;

268 ià(
Ëv–
 == 0) {

269 
	`PRINT_ERROR
("UnknowÀtok’ \"%s\"", 
p
);

270 
»s
 = -
EINVAL
;

271 
out_ä“
;

274 
SCST_TRACE_ACTION_VALUE
:

275 
»s
 = 
	`k¡¹oul
(
p
, 0, &
Ëv–
);

276 ià(
»s
 != 0) {

277 
	`PRINT_ERROR
("Inv®id¿û v®u\"%s\"", 
p
);

278 
»s
 = -
EINVAL
;

279 
out_ä“
;

284 
ÞdËv–
 = *
log_Ëv–
;

286 
aùiÚ
) {

287 
SCST_TRACE_ACTION_ADD
:

288 *
log_Ëv–
 |ð
Ëv–
;

290 
SCST_TRACE_ACTION_DEL
:

291 *
log_Ëv–
 &ð~
Ëv–
;

294 *
log_Ëv–
 = 
Ëv–
;

298 
	`PRINT_INFO
("Changedrace†evel for \"%s\": old 0x%08lx,‚ew 0x%08lx",

299 
Çme
, 
ÞdËv–
, *
log_Ëv–
);

301 
»s
 = 
Ëngth
;

303 
out_ä“
:

304 
	`kä“
(
bufãr
);

305 
out
:

306 
	`TRACE_EXIT_RES
(
»s
);

307  
»s
;

308 
	}
}

312 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 34) && \

313 (!
defšed
(
RHEL_MAJOR
è|| 
	gRHEL_MAJOR
 -0 < 6 || \

314 (
	gRHEL_MAJOR
 -0 =ð6 && 
RHEL_MINOR
 -0 < 6))

319 
	$sysfs_ü—‹_fžes
(
kobjeù
 *
kobj
,

320 cÚ¡ 
©Œibu‹
 **
±r
)

322 
”r
 = 0;

323 
i
;

325 
i
 = 0; 
±r
[i] && !
”r
; i++)

326 
”r
 = 
	`sysfs_ü—‹_fže
(
kobj
, 
±r
[
i
]);

327 ià(
”r
)

328 --
i
 >= 0)

329 
	`sysfs_»move_fže
(
kobj
, 
±r
[
i
]);

330  
”r
;

331 
	}
}

333 
	$sysfs_»move_fžes
(
kobjeù
 *
kobj
,

334 cÚ¡ 
©Œibu‹
 **
±r
)

336 
i
;

338 
i
 = 0; 
±r
[i]; i++)

339 
	`sysfs_»move_fže
(
kobj
, 
±r
[
i
]);

340 
	}
}

347 
DEFINE_SPINLOCK
(
sysfs_wÜk_lock
);

348 
LIST_HEAD
(
sysfs_wÜk_li¡
);

349 
DECLARE_WAIT_QUEUE_HEAD
(
sysfs_wÜk_wa™Q
);

350 
	gaùive_sysfs_wÜks
;

351 
	gÏ¡_sysfs_wÜk_»s
;

352 
sk_¡ruù
 *
	gsysfs_wÜk_th»ad
;

357 
sc¡_®loc_sysfs_wÜk
((*
sysfs_wÜk_â
)(
sc¡_sysfs_wÜk_™em
 *),

358 
boÞ
 
»ad_Úly_aùiÚ
, 
sc¡_sysfs_wÜk_™em
 **
»s_wÜk
)

360 
»s
 = 0;

361 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

363 
	`TRACE_ENTRY
();

365 ià(
sysfs_wÜk_â
 =ð
NULL
) {

366 
	`PRINT_ERROR
("%s", "sysfs_work_fn is NULL");

367 
»s
 = -
EINVAL
;

368 
out
;

371 *
»s_wÜk
 = 
NULL
;

373 
wÜk
 = 
	`kz®loc
((*wÜk), 
GFP_KERNEL
);

374 ià(
wÜk
 =ð
NULL
) {

375 
	`PRINT_ERROR
("Unableo‡lloc sysfs work (size %zd)",

376 (*
wÜk
));

377 
»s
 = -
ENOMEM
;

378 
out
;

381 
wÜk
->
»ad_Úly_aùiÚ
 =„ead_only_action;

382 
	`k»f_š™
(&
wÜk
->
sysfs_wÜk_k»f
);

383 
	`š™_com¶‘iÚ
(&
wÜk
->
sysfs_wÜk_dÚe
);

384 
wÜk
->
sysfs_wÜk_â
 = sysfs_work_fn;

386 *
»s_wÜk
 = 
wÜk
;

388 
out
:

389 
	`TRACE_EXIT_RES
(
»s
);

390  
»s
;

391 
	}
}

392 
EXPORT_SYMBOL
(
sc¡_®loc_sysfs_wÜk
);

394 
	$sc¡_sysfs_wÜk_»Ëa£
(
k»f
 *kref)

396 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

398 
	`TRACE_ENTRY
();

400 
wÜk
 = 
	`cÚš”_of
(
k»f
, 
sc¡_sysfs_wÜk_™em
,

401 
sysfs_wÜk_k»f
);

403 
	`TRACE_DBG
("F»ešg sysf wÜk %°(buà%p)", 
wÜk
, wÜk->
buf
);

405 
	`kä“
(
wÜk
->
buf
);

406 
	`kä“
(
wÜk
->
»s_buf
);

407 
	`kä“
(
wÜk
);

409 
	`TRACE_EXIT
();

411 
	}
}

416 
	$sc¡_sysfs_wÜk_g‘
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

418 
	`k»f_g‘
(&
wÜk
->
sysfs_wÜk_k»f
);

419 
	}
}

420 
EXPORT_SYMBOL
(
sc¡_sysfs_wÜk_g‘
);

425 
	$sc¡_sysfs_wÜk_put
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

427 
	`k»f_put
(&
wÜk
->
sysfs_wÜk_k»f
, 
sc¡_sysfs_wÜk_»Ëa£
);

428 
	}
}

429 
EXPORT_SYMBOL
(
sc¡_sysfs_wÜk_put
);

432 
	$sc¡_´oûss_sysfs_wÜks
()

433 
	$__»Ëa£s
(&
sysfs_wÜk_lock
)

434 
	$__acquœes
(&
sysfs_wÜk_lock
)

436 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

438 
	`TRACE_ENTRY
();

440 !
	`li¡_em±y
(&
sysfs_wÜk_li¡
)) {

441 
wÜk
 = 
	`li¡_fœ¡_’Œy
(&
sysfs_wÜk_li¡
,

442 
sc¡_sysfs_wÜk_™em
, 
sysfs_wÜk_li¡_’Œy
);

443 
	`li¡_d–
(&
wÜk
->
sysfs_wÜk_li¡_’Œy
);

444 
	`¥š_uÆock
(&
sysfs_wÜk_lock
);

446 
	`TRACE_DBG
("Sysf wÜk %p", 
wÜk
);

448 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 29)

449 ià(
wÜk
->
d•_m­
) {

450 
	`mu‹x_acquœe
(
wÜk
->
d•_m­
, 0, 0, 
_RET_IP_
);

451 
	`lock_acquœed
(
wÜk
->
d•_m­
, 
_RET_IP_
);

455 
wÜk
->
wÜk_»s
 = wÜk->
	`sysfs_wÜk_â
(work);

457 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 29)

458 ià(
wÜk
->
d•_m­
)

459 
	`mu‹x_»Ëa£
(
wÜk
->
d•_m­
, 0, 
_RET_IP_
);

462 
	`¥š_lock
(&
sysfs_wÜk_lock
);

463 ià(!
wÜk
->
»ad_Úly_aùiÚ
)

464 
Ï¡_sysfs_wÜk_»s
 = 
wÜk
->
wÜk_»s
;

465 
aùive_sysfs_wÜks
--;

466 
	`¥š_uÆock
(&
sysfs_wÜk_lock
);

468 
	`com¶‘e_®l
(&
wÜk
->
sysfs_wÜk_dÚe
);

469 
	`k»f_put
(&
wÜk
->
sysfs_wÜk_k»f
, 
sc¡_sysfs_wÜk_»Ëa£
);

471 
	`¥š_lock
(&
sysfs_wÜk_lock
);

474 
	`TRACE_EXIT
();

476 
	}
}

478 
šlše
 
	$‹¡_sysfs_wÜk_li¡
()

480 
»s
 = !
	`li¡_em±y
(&
sysfs_wÜk_li¡
) ||

481 
	`uÆik–y
(
	`kth»ad_should_¡Ý
());

482  
»s
;

483 
	}
}

485 
	$sysfs_wÜk_th»ad_â
(*
¬g
)

487 
boÞ
 
Úe_time_Úly
 = (boÞ)
¬g
;

489 
	`TRACE_ENTRY
();

491 ià(!
Úe_time_Úly
)

492 
	`PRINT_INFO
("User interfacehread started");

494 
cu¼’t
->
æags
 |ð
PF_NOFREEZE
;

496 
	`£t_u£r_niû
(
cu¼’t
, -10);

498 
	`¥š_lock
(&
sysfs_wÜk_lock
);

499 !
	`kth»ad_should_¡Ý
()) {

500 ià(
Úe_time_Úly
 && !
	`‹¡_sysfs_wÜk_li¡
())

502 
	`wa™_ev’t_locked
(
sysfs_wÜk_wa™Q
, 
	`‹¡_sysfs_wÜk_li¡
(),

503 
lock
, 
sysfs_wÜk_lock
);

504 
	`sc¡_´oûss_sysfs_wÜks
();

506 
	`¥š_uÆock
(&
sysfs_wÜk_lock
);

508 ià(!
Úe_time_Úly
) {

513 
	`sBUG_ON
(!
	`li¡_em±y
(&
sysfs_wÜk_li¡
));

515 
	`PRINT_INFO
("User interfacehread finished");

518 
	`TRACE_EXIT
();

520 
	}
}

529 
	$sc¡_sysfs_queue_wa™_wÜk
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

531 
»s
 = 0, 
rc
;

532 
timeout
 = 15*
HZ
;

533 
sk_¡ruù
 *
t
;

534 
©omic_t
 
uid_th»ad_Çme
 = 
	`ATOMIC_INIT
(0);

536 
	`TRACE_ENTRY
();

538 
	`¥š_lock
(&
sysfs_wÜk_lock
);

540 
	`TRACE_DBG
("Addšg sysf wÜk %°tØthli¡", 
wÜk
);

541 
	`li¡_add_ž
(&
wÜk
->
sysfs_wÜk_li¡_’Œy
, &
sysfs_wÜk_li¡
);

543 
aùive_sysfs_wÜks
++;

545 
	`k»f_g‘
(&
wÜk
->
sysfs_wÜk_k»f
);

547 
	`¥š_uÆock
(&
sysfs_wÜk_lock
);

549 
	`wake_up
(&
sysfs_wÜk_wa™Q
);

565 
t
 = 
	`kth»ad_run
(
sysfs_wÜk_th»ad_â
, (*)
Œue
, "scst_uid%d",

566 
	`©omic_šc_»tuº
(&
uid_th»ad_Çme
));

567 ià(
	`IS_ERR
(
t
))

568 
	`PRINT_ERROR
("kthread_run() for user interfacehread %d "

569 "çžed: %d", 
	`©omic_»ad
(&
uid_th»ad_Çme
),

570 ()
	`PTR_ERR
(
t
));

572 #ifdeà
CONFIG_SCST_DEBUG_SYSFS_EAGAIN


574 
út
;

576 ià(!
wÜk
->
»ad_Úly_aùiÚ
 || 
út
++ % 4 < 3) {

581 
timeout
 = 0;

582 
rc
 = 0;

583 
»s
 = -
EAGAIN
;

584 
out_put
;

590 
rc
 = 
	`wa™_fÜ_com¶‘iÚ_š‹¼u±ibË_timeout
(

591 &
wÜk
->
sysfs_wÜk_dÚe
, 
timeout
);

592 ià(
rc
 == 0) {

593 ià(!
	`mu‹x_is_locked
(&
sc¡_mu‹x
)) {

594 
	`TRACE_DBG
("scst_mutex‚ot†ocked, continue "

595 "wa™šg (wÜk %p)", 
wÜk
);

596 
timeout
 = 5*
HZ
;

599 
	`TRACE_MGMT_DBG
("Timouˆwa™šg fÜ wÜk %p", 
wÜk
);

600 
»s
 = -
EAGAIN
;

601 
out_put
;

602 } ià(
rc
 < 0) {

603 
»s
 = 
rc
;

604 
out_put
;

609 
»s
 = 
wÜk
->
wÜk_»s
;

611 
out_put
:

612 
	`k»f_put
(&
wÜk
->
sysfs_wÜk_k»f
, 
sc¡_sysfs_wÜk_»Ëa£
);

614 
	`TRACE_EXIT_RES
(
»s
);

615  
»s
;

616 
	}
}

617 
EXPORT_SYMBOL
(
sc¡_sysfs_queue_wa™_wÜk
);

620 
	$sc¡_check_g¿b_tg‰_±r
(
sc¡_tgt_‹m¶©e
 *
tg‰
)

622 
»s
 = 0;

623 
sc¡_tgt_‹m¶©e
 *
‰
;

625 
	`TRACE_ENTRY
();

627 
	`mu‹x_lock
(&
sc¡_mu‹x
);

629 
	`li¡_fÜ_—ch_’Œy
(
‰
, &
sc¡_‹m¶©e_li¡
, 
sc¡_‹m¶©e_li¡_’Œy
) {

630 ià(
‰
 =ð
tg‰
) {

631 
tg‰
->
tg‰_aùive_sysfs_wÜks_couÁ
++;

632 
out_uÆock
;

636 
	`TRACE_DBG
("Tg‰ %°nÙ found", 
tg‰
);

637 
»s
 = -
ENOENT
;

639 
out_uÆock
:

640 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

642 
	`TRACE_EXIT_RES
(
»s
);

643  
»s
;

644 
	}
}

647 
	$sc¡_ung¿b_tg‰_±r
(
sc¡_tgt_‹m¶©e
 *
tg‰
)

649 
	`TRACE_ENTRY
();

651 
	`mu‹x_lock
(&
sc¡_mu‹x
);

652 
tg‰
->
tg‰_aùive_sysfs_wÜks_couÁ
--;

653 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

655 
	`TRACE_EXIT
();

657 
	}
}

660 
	$sc¡_check_tgt_acg_±rs
(
sc¡_tgt
 *
tgt
, 
sc¡_acg
 *
acg
)

662 
»s
 = 0;

663 
sc¡_tgt_‹m¶©e
 *
tg‰
;

665 
	`li¡_fÜ_—ch_’Œy
(
tg‰
, &
sc¡_‹m¶©e_li¡
, 
sc¡_‹m¶©e_li¡_’Œy
) {

666 
sc¡_tgt
 *
t
;

668 
	`li¡_fÜ_—ch_’Œy
(
t
, &
tg‰
->
tgt_li¡
, 
tgt_li¡_’Œy
) {

669 ià(
t
 =ð
tgt
) {

670 
sc¡_acg
 *
a
;

672 ià(
acg
 =ð
NULL
)

673 
out
;

674 ià(
acg
 =ð
tgt
->
deçuÉ_acg
)

675 
out
;

676 
	`li¡_fÜ_—ch_’Œy
(
a
, &
tgt
->
tgt_acg_li¡
,

677 
acg_li¡_’Œy
) {

678 ià(
a
 =ð
acg
)

679 
out
;

685 
	`TRACE_DBG
("Tgˆ%p/ACG %°nÙ found", 
tgt
, 
acg
);

686 
»s
 = -
ENOENT
;

688 
out
:

689 
	`TRACE_EXIT_RES
(
»s
);

690  
»s
;

691 
	}
}

694 
	$sc¡_check_devt_±r
(
sc¡_dev_ty³
 *
devt
,

695 
li¡_h—d
 *
li¡
)

697 
»s
 = 0;

698 
sc¡_dev_ty³
 *
dt
;

700 
	`TRACE_ENTRY
();

702 
	`li¡_fÜ_—ch_’Œy
(
dt
, 
li¡
, 
dev_ty³_li¡_’Œy
) {

703 ià(
dt
 =ð
devt
)

704 
out
;

707 
	`TRACE_DBG
("Devˆ%°nÙ found", 
devt
);

708 
»s
 = -
ENOENT
;

710 
out
:

711 
	`TRACE_EXIT_RES
(
»s
);

712  
»s
;

713 
	}
}

716 
	$sc¡_check_dev_±r
(
sc¡_deviû
 *
dev
)

718 
»s
 = 0;

719 
sc¡_deviû
 *
d
;

721 
	`TRACE_ENTRY
();

723 
	`li¡_fÜ_—ch_’Œy
(
d
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

724 ià(
d
 =ð
dev
)

725 
out
;

728 
	`TRACE_DBG
("Dev %°nÙ found", 
dev
);

729 
»s
 = -
ENOENT
;

731 
out
:

732 
	`TRACE_EXIT_RES
(
»s
);

733  
»s
;

734 
	}
}

737 
	$sc¡_check_g¿b_devt_±r
(
sc¡_dev_ty³
 *
devt
,

738 
li¡_h—d
 *
li¡
)

740 
»s
 = 0;

741 
sc¡_dev_ty³
 *
dt
;

743 
	`TRACE_ENTRY
();

745 
	`mu‹x_lock
(&
sc¡_mu‹x
);

747 
	`li¡_fÜ_—ch_’Œy
(
dt
, 
li¡
, 
dev_ty³_li¡_’Œy
) {

748 ià(
dt
 =ð
devt
) {

749 
devt
->
devt_aùive_sysfs_wÜks_couÁ
++;

750 
out_uÆock
;

754 
	`TRACE_DBG
("Devˆ%°nÙ found", 
devt
);

755 
»s
 = -
ENOENT
;

757 
out_uÆock
:

758 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

760 
	`TRACE_EXIT_RES
(
»s
);

761  
»s
;

762 
	}
}

765 
	$sc¡_ung¿b_devt_±r
(
sc¡_dev_ty³
 *
devt
)

767 
	`TRACE_ENTRY
();

769 
	`mu‹x_lock
(&
sc¡_mu‹x
);

770 
devt
->
devt_aùive_sysfs_wÜks_couÁ
--;

771 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

773 
	`TRACE_EXIT
();

775 
	}
}

780 
ssize_t
 
	$sc¡_show
(
kobjeù
 *
kobj
, 
©Œibu‹
 *
©Œ
,

781 *
buf
)

783 
kobj_©Œibu‹
 *
kobj_©Œ
;

785 
kobj_©Œ
 = 
	`cÚš”_of
(
©Œ
, 
kobj_©Œibu‹
,‡ttr);

786  
kobj_©Œ
->
	`show
(
kobj
, kobj_©Œ, 
buf
);

787 
	}
}

789 
ssize_t
 
	$sc¡_¡Üe
(
kobjeù
 *
kobj
, 
©Œibu‹
 *
©Œ
,

790 cÚ¡ *
buf
, 
size_t
 
couÁ
)

792 
kobj_©Œibu‹
 *
kobj_©Œ
;

794 
kobj_©Œ
 = 
	`cÚš”_of
(
©Œ
, 
kobj_©Œibu‹
,‡ttr);

795 ià(
kobj_©Œ
->
¡Üe
)

796  
kobj_©Œ
->
	`¡Üe
(
kobj
, kobj_©Œ, 
buf
, 
couÁ
);

798  -
EIO
;

799 
	}
}

801 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 34))

802 cÚ¡ 
sysfs_Ýs
 
	gsc¡_sysfs_Ýs
 = {

804 
sysfs_Ýs
 
sc¡_sysfs_Ýs
 = {

806 .
show
 = 
sc¡_show
,

807 .
	g¡Üe
 = 
sc¡_¡Üe
,

810 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 34))

811 cÚ¡ 
sysfs_Ýs
 *
	$sc¡_sysfs_g‘_sysfs_Ýs
()

813 
sysfs_Ýs
 *
	$sc¡_sysfs_g‘_sysfs_Ýs
()

816  &
sc¡_sysfs_Ýs
;

817 
	}
}

818 
EXPORT_SYMBOL_GPL
(
sc¡_sysfs_g‘_sysfs_Ýs
);

824 
	$sc¡_tg‰_»Ëa£
(
kobjeù
 *
kobj
)

826 
sc¡_tgt_‹m¶©e
 *
tg‰
;

828 
	`TRACE_ENTRY
();

830 
tg‰
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt_‹m¶©e
, 
tg‰_kobj
);

831 ià(
tg‰
->
tg‰_kobj_»Ëa£_cm¶
)

832 
	`com¶‘e_®l
(
tg‰
->
tg‰_kobj_»Ëa£_cm¶
);

834 
	`TRACE_EXIT
();

836 
	}
}

838 
kobj_ty³
 
	gtg‰_kty³
 = {

839 .
sysfs_Ýs
 = &
sc¡_sysfs_Ýs
,

840 .
	g»Ëa£
 = 
sc¡_tg‰_»Ëa£
,

843 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

845 
ssize_t
 
	$sc¡_tg‰_Œaû_Ëv–_show
(
kobjeù
 *
kobj
,

846 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

848 
sc¡_tgt_‹m¶©e
 *
tg‰
;

850 
tg‰
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt_‹m¶©e
, 
tg‰_kobj
);

852  
	`sc¡_Œaû_Ëv–_show
(
tg‰
->
Œaû_tbl
,

853 
tg‰
->
Œaû_æags
 ? *tg‰->Œaû_æag : 0, 
buf
,

854 
tg‰
->
Œaû_tbl_h–p
);

855 
	}
}

857 
ssize_t
 
	$sc¡_tg‰_Œaû_Ëv–_¡Üe
(
kobjeù
 *
kobj
,

858 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

860 
»s
;

861 
sc¡_tgt_‹m¶©e
 *
tg‰
;

863 
	`TRACE_ENTRY
();

865 
tg‰
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt_‹m¶©e
, 
tg‰_kobj
);

867 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_log_mu‹x
);

868 ià(
»s
 != 0)

869 
out
;

871 
»s
 = 
	`sc¡_wr™e_Œaû
(
buf
, 
couÁ
, 
tg‰
->
Œaû_æags
,

872 
tg‰
->
deçuÉ_Œaû_æags
,g‰->
Çme
,g‰->
Œaû_tbl
);

874 
	`mu‹x_uÆock
(&
sc¡_log_mu‹x
);

876 
out
:

877 
	`TRACE_EXIT_RES
(
»s
);

878  
»s
;

879 
	}
}

881 
kobj_©Œibu‹
 
	gtg‰_Œaû_©Œ
 =

882 
__ATTR
(
Œaû_Ëv–
, 
S_IRUGO
 | 
S_IWUSR
,

883 
sc¡_tg‰_Œaû_Ëv–_show
, 
sc¡_tg‰_Œaû_Ëv–_¡Üe
);

887 
ssize_t
 
	$sc¡_tg‰_mgmt_show
(
kobjeù
 *
kobj
,

888 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

890 cÚ¡ 
h–p
[] =

899 
sc¡_tgt_‹m¶©e
 *
tg‰
;

901 
tg‰
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt_‹m¶©e
, 
tg‰_kobj
);

903  
	`sú´štf
(
buf
, 
SCST_SYSFS_BLOCK_SIZE
, 
h–p
,

904 (
tg‰
->
tg‰_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ?

907 (
tg‰
->
tgt_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ?

910 (
tg‰
->
mgmt_cmd_h–p
) ?gtt->mgmt_cmd_help : "",

911 (
tg‰
->
add_rg‘_·¿m‘”s
 !ð
NULL
) ?

913 (
tg‰
->
add_rg‘_·¿m‘”s
 !ð
NULL
) ?

914 
tg‰
->
add_rg‘_·¿m‘”s
 : "",

915 (
tg‰
->
tg‰_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ?

917 (
tg‰
->
tg‰_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ?

918 
tg‰
->
tg‰_ÝtiÚ®_©Œibu‹s
 : "",

919 (
tg‰
->
tg‰_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ? "\n" : "",

920 (
tg‰
->
tgt_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ?

922 (
tg‰
->
tgt_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ?

923 
tg‰
->
tgt_ÝtiÚ®_©Œibu‹s
 : "",

924 (
tg‰
->
tgt_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ? "\n" : "");

925 
	}
}

927 
	$sc¡_´oûss_tg‰_mgmt_¡Üe
(*
bufãr
,

928 
sc¡_tgt_‹m¶©e
 *
tg‰
)

930 
»s
 = 0;

931 *
p
, *
µ
, *
rg‘_Çme
;

933 
	`TRACE_ENTRY
();

935 
	`TRACE_DBG
("bufã¸%s", 
bufãr
);

938 ià(
	`sc¡_check_g¿b_tg‰_±r
(
tg‰
) != 0)

939 
out
;

941 
µ
 = 
bufãr
;

942 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

944 ià(
	`¡rÿ£cmp
("add_rg‘", 
p
) == 0) {

945 
rg‘_Çme
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

946 ià(*
rg‘_Çme
 == '\0') {

947 
	`PRINT_ERROR
("%s", "Target‚ame„equired");

948 
»s
 = -
EINVAL
;

949 
out_ung¿b
;

951 
»s
 = 
tg‰
->
	`add_rg‘
(
rg‘_Çme
, 
µ
);

952 } ià(
	`¡rÿ£cmp
("d–_rg‘", 
p
) == 0) {

953 
rg‘_Çme
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

954 ià(*
rg‘_Çme
 == '\0') {

955 
	`PRINT_ERROR
("%s", "Target‚ame„equired");

956 
»s
 = -
EINVAL
;

957 
out_ung¿b
;

960 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

961 ià(*
p
 != '\0')

962 
out_syÁax_”r
;

964 
»s
 = 
tg‰
->
	`d–_rg‘
(
rg‘_Çme
);

965 } ià(
tg‰
->
mgmt_cmd
 !ð
NULL
) {

966 
	`sc¡_»¡Üe_tok’_¡r
(
p
, 
µ
);

967 
»s
 = 
tg‰
->
	`mgmt_cmd
(
bufãr
);

969 
	`PRINT_ERROR
("UnknowÀaùiÚ \"%s\"", 
p
);

970 
»s
 = -
EINVAL
;

971 
out_ung¿b
;

974 
out_ung¿b
:

975 
	`sc¡_ung¿b_tg‰_±r
(
tg‰
);

977 
out
:

978 
	`TRACE_EXIT_RES
(
»s
);

979  
»s
;

981 
out_syÁax_”r
:

982 
	`PRINT_ERROR
("SyÁaxƒ¼Ü oÀ\"%s\"", 
p
);

983 
»s
 = -
EINVAL
;

984 
out_ung¿b
;

985 
	}
}

987 
	$sc¡_tg‰_mgmt_¡Üe_wÜk_â
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

989  
	`sc¡_´oûss_tg‰_mgmt_¡Üe
(
wÜk
->
buf
, wÜk->
tg‰
);

990 
	}
}

992 
ssize_t
 
	$sc¡_tg‰_mgmt_¡Üe
(
kobjeù
 *
kobj
,

993 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

995 
»s
;

996 *
bufãr
;

997 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

998 
sc¡_tgt_‹m¶©e
 *
tg‰
;

1000 
	`TRACE_ENTRY
();

1002 
tg‰
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt_‹m¶©e
, 
tg‰_kobj
);

1004 
bufãr
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%.*s", ()
couÁ
, 
buf
);

1005 ià(
bufãr
 =ð
NULL
) {

1006 
»s
 = -
ENOMEM
;

1007 
out
;

1010 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_tg‰_mgmt_¡Üe_wÜk_â
, 
çl£
, &
wÜk
);

1011 ià(
»s
 != 0)

1012 
out_ä“
;

1014 
wÜk
->
buf
 = 
bufãr
;

1015 
wÜk
->
tg‰
 =gtt;

1017 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

1018 ià(
»s
 == 0)

1019 
»s
 = 
couÁ
;

1021 
out
:

1022 
	`TRACE_EXIT_RES
(
»s
);

1023  
»s
;

1025 
out_ä“
:

1026 
	`kä“
(
bufãr
);

1027 
out
;

1028 
	}
}

1030 
kobj_©Œibu‹
 
	gsc¡_tg‰_mgmt
 =

1031 
__ATTR
(
mgmt
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_tg‰_mgmt_show
,

1032 
sc¡_tg‰_mgmt_¡Üe
);

1034 
ssize_t
 
	$sc¡_tg‰_dif_ÿ·bË_show
(
kobjeù
 *
kobj
,

1035 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

1037 
pos
 = 0;

1038 
sc¡_tgt_‹m¶©e
 *
tg‰
;

1040 
	`TRACE_ENTRY
();

1042 
tg‰
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt_‹m¶©e
, 
tg‰_kobj
);

1044 
	`EXTRACHECKS_BUG_ON
(!
tg‰
->
dif_suµÜ‹d
);

1046 
pos
 +ð
	`sú´štf
(&
buf
[pos], 
SCST_SYSFS_BLOCK_SIZE
 -…os,

1049 ià(
tg‰
->
hw_dif_ty³1_suµÜ‹d
)

1050 
pos
 +ð
	`sú´štf
(&
buf
[pos], 
SCST_SYSFS_BLOCK_SIZE
 -…os,

1053 ià(
tg‰
->
hw_dif_ty³2_suµÜ‹d
)

1054 
pos
 +ð
	`sú´štf
(&
buf
[pos], 
SCST_SYSFS_BLOCK_SIZE
 -…os,

1057 ià(
tg‰
->
hw_dif_ty³3_suµÜ‹d
)

1058 
pos
 +ð
	`sú´štf
(&
buf
[pos], 
SCST_SYSFS_BLOCK_SIZE
 -…os,

1061 ià(
tg‰
->
hw_dif__suµÜ‹d
)

1062 
pos
 +ð
	`sú´štf
(&
buf
[pos], 
SCST_SYSFS_BLOCK_SIZE
 -…os,

1065 ià(
tg‰
->
hw_dif_§me_sg_Ïyout_»quœed
)

1066 
pos
 +ð
	`sú´štf
(&
buf
[pos], 
SCST_SYSFS_BLOCK_SIZE
 -…os,

1069 
pos
 +ð
	`sú´štf
(&
buf
[pos], 
SCST_SYSFS_BLOCK_SIZE
 -…os, "\n");

1071 ià(
tg‰
->
suµÜ‹d_dif_block_sizes
) {

1072 cÚ¡ *
p
 = 
tg‰
->
suµÜ‹d_dif_block_sizes
;

1073 
j
;

1075 
pos
 +ð
	`sú´štf
(&
buf
[pos], 
SCST_SYSFS_BLOCK_SIZE
 -…os,

1077 
j
 = 
pos
;

1078 *
p
 != 0) {

1079 
pos
 +ð
	`sú´štf
(&
buf
[pos], 
SCST_SYSFS_BLOCK_SIZE
 -…os,

1080 "%s%d", (
j
 =ð
pos
è? "" : ", ", *
p
);

1081 
p
++;

1085 
	`TRACE_EXIT_RES
(
pos
);

1086  
pos
;

1087 
	}
}

1089 
kobj_©Œibu‹
 
	gsc¡_tg‰_dif_ÿ·bË_©Œ
 =

1090 
__ATTR
(
dif_ÿ·bž™›s
, 
S_IRUGO
, 
sc¡_tg‰_dif_ÿ·bË_show
, 
NULL
);

1095 
	$sc¡_ü—‹_tg‰_©Œ
(
sc¡_tgt_‹m¶©e
 *
tg‰
,

1096 
kobj_©Œibu‹
 *
©Œibu‹
)

1098 
»s
;

1100 
»s
 = 
	`sysfs_ü—‹_fže
(&
tg‰
->
tg‰_kobj
, &
©Œibu‹
->
©Œ
);

1101 ià(
»s
 != 0) {

1102 
	`PRINT_ERROR
("Can't‡dd‡ttribute %s forarget driver %s",

1103 
©Œibu‹
->
©Œ
.
Çme
, 
tg‰
->name);

1104 
out
;

1107 
out
:

1108  
»s
;

1109 
	}
}

1110 
EXPORT_SYMBOL
(
sc¡_ü—‹_tg‰_©Œ
);

1112 
	$sc¡_tg‰_sysfs_ü—‹
(
sc¡_tgt_‹m¶©e
 *
tg‰
)

1114 
»s
 = 0;

1116 
	`TRACE_ENTRY
();

1118 
»s
 = 
	`kobjeù_š™_ªd_add
(&
tg‰
->
tg‰_kobj
, &
tg‰_kty³
,

1119 
sc¡_rg‘s_kobj
, 
tg‰
->
Çme
);

1120 ià(
»s
 != 0) {

1121 
	`PRINT_ERROR
("Cª'ˆaddg‰ % tØsysfs", 
tg‰
->
Çme
);

1122 
out
;

1125 ià(
tg‰
->
add_rg‘
 !ð
NULL
) {

1126 
»s
 = 
	`sysfs_ü—‹_fže
(&
tg‰
->
tg‰_kobj
,

1127 &
sc¡_tg‰_mgmt
.
©Œ
);

1128 ià(
»s
 != 0) {

1129 
	`PRINT_ERROR
("Can't‡dd mgmt‡ttr forarget driver %s",

1130 
tg‰
->
Çme
);

1131 
out_d–
;

1135 ià(
tg‰
->
tg‰_©Œs
) {

1136 
»s
 = 
	`sysfs_ü—‹_fžes
(&
tg‰
->
tg‰_kobj
,g‰->
tg‰_©Œs
);

1137 ià(
»s
 != 0) {

1138 
	`PRINT_ERROR
("Can't‡dd‡ttributes forarget "

1139 "driv” %s", 
tg‰
->
Çme
);

1140 
out_d–
;

1144 ià(
tg‰
->
dif_suµÜ‹d
) {

1145 
»s
 = 
	`sysfs_ü—‹_fže
(&
tg‰
->
tg‰_kobj
,

1146 &
sc¡_tg‰_dif_ÿ·bË_©Œ
.
©Œ
);

1147 ià(
»s
 != 0) {

1148 
	`PRINT_ERROR
("Can't‡dd‡ttribute %s forarget driver %s",

1149 
sc¡_tg‰_dif_ÿ·bË_©Œ
.
©Œ
.
Çme
, 
tg‰
->name);

1150 
out
;

1154 #ià
	`defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

1155 ià(
tg‰
->
Œaû_æags
 !ð
NULL
) {

1156 
»s
 = 
	`sysfs_ü—‹_fže
(&
tg‰
->
tg‰_kobj
,

1157 &
tg‰_Œaû_©Œ
.
©Œ
);

1158 ià(
»s
 != 0) {

1159 
	`PRINT_ERROR
("Can't‡ddrace_flag forarget "

1160 "driv” %s", 
tg‰
->
Çme
);

1161 
out_d–
;

1166 
out
:

1167 
	`TRACE_EXIT_RES
(
»s
);

1168  
»s
;

1170 
out_d–
:

1171 
	`sc¡_tg‰_sysfs_d–
(
tg‰
);

1172 
out
;

1173 
	}
}

1175 
sc¡_kobjeù_put_ªd_wa™
(
kobjeù
 *
kobj
, cÚ¡ *
ÿ‹gÜy
,

1176 
com¶‘iÚ
 *
c


1177 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 29è&& 
defšed
(
CONFIG_LOCKDEP
)

1178 , 
lockd•_m­
 *
d•_m­


1182 *
	gÇme
;

1184 
TRACE_ENTRY
();

1186 
	gÇme
 = 
k¡rdup
(
kobjeù_Çme
(
kobj
), 
GFP_KERNEL
);

1188 
kobjeù_put
(
kobj
);

1190 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 29)

1191 
mu‹x_acquœe
(
d•_m­
, 0, 0, 
_RET_IP_
);

1194 ià(
wa™_fÜ_com¶‘iÚ_timeout
(
c
, 
HZ
) > 0)

1195 
	gout_ä“
;

1197 
PRINT_INFO
("Waiting for„elease of sysfsƒntry for %s %s (%d„efs)",

1198 
ÿ‹gÜy
, 
Çme
 ? : "(?)", 
©omic_»ad
(&
kobj
->
k»f
.
»fcouÁ
));

1199 
wa™_fÜ_com¶‘iÚ
(
c
);

1200 
PRINT_INFO
("Finished waiting for„elease of %s %s sysfsƒntry",

1201 
ÿ‹gÜy
, 
Çme
 ? : "(?)");

1203 
	gout_ä“
:

1204 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 29)

1205 
lock_acquœed
(
d•_m­
, 
_RET_IP_
);

1206 
mu‹x_»Ëa£
(
d•_m­
, 0, 
_RET_IP_
);

1209 
kä“
(
Çme
);

1211 
TRACE_EXIT
();

1214 
EXPORT_SYMBOL
(
sc¡_kobjeù_put_ªd_wa™
);

1221 
	$sc¡_tg‰_sysfs_d–
(
sc¡_tgt_‹m¶©e
 *
tg‰
)

1223 
	`DECLARE_COMPLETION_ONSTACK
(
c
);

1225 
	`TRACE_ENTRY
();

1227 
tg‰
->
tg‰_kobj_»Ëa£_cm¶
 = &
c
;

1229 
	`kobjeù_d–
(&
tg‰
->
tg‰_kobj
);

1231 
	`SCST_KOBJECT_PUT_AND_WAIT
(&
tg‰
->
tg‰_kobj
, "rg‘em¶©e", &
c
,

1232 &
sc¡_tg‰_d•_m­
);

1234 
	`TRACE_EXIT
();

1236 
	}
}

1242 
	$sc¡_tgt_»Ëa£
(
kobjeù
 *
kobj
)

1244 
sc¡_tgt
 *
tgt
;

1246 
	`TRACE_ENTRY
();

1248 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

1249 ià(
tgt
->
tgt_kobj_»Ëa£_cm¶
)

1250 
	`com¶‘e_®l
(
tgt
->
tgt_kobj_»Ëa£_cm¶
);

1252 
	`TRACE_EXIT
();

1254 
	}
}

1256 
	$sc¡_·r£_add_»¶_·¿m
(
sc¡_acg
 *
acg
,

1257 
sc¡_deviû
 *
dev
, *
µ
,

1258 *
vœt_lun
,

1259 
boÞ
 *
»ad_Úly
)

1261 
»s
;

1262 *
e
;

1264 *
»ad_Úly
 = 
çl£
;

1265 
e
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

1266 
»s
 = 
	`k¡¹oul
(
e
, 0, 
vœt_lun
);

1267 ià(
»s
 != 0) {

1268 
	`PRINT_ERROR
("Valid LUN„equired for dev %s (res %d)",

1269 
dev
->
vœt_Çme
, 
»s
);

1270 
out
;

1271 } ià(*
vœt_lun
 > 
SCST_MAX_LUN
) {

1272 
	`PRINT_ERROR
("ToØbig LUN %ld (max %d)", *
vœt_lun
, 
SCST_MAX_LUN
);

1273 
»s
 = -
EINVAL
;

1274 
out
;

1278 
v®
;

1279 *
·¿m
 = 
	`sc¡_g‘_Ãxt_tok’_¡r
(&
µ
);

1280 *
p
, *
µ
;

1282 ià(
·¿m
 =ð
NULL
)

1285 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
·¿m
);

1286 ià(*
p
 == '\0') {

1287 
	`PRINT_ERROR
("SyÁaxƒ¼Ü‡ˆ% (deviû %s)", 
·¿m
,

1288 
dev
->
vœt_Çme
);

1289 
»s
 = -
EINVAL
;

1290 
out
;

1293 
µ
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
·¿m
);

1294 ià(*
µ
 == '\0') {

1295 
	`PRINT_ERROR
("Parameter %s value missed for device %s",

1296 
p
, 
dev
->
vœt_Çme
);

1297 
»s
 = -
EINVAL
;

1298 
out
;

1301 ià(
	`sc¡_g‘_Ãxt_Ëxem
(&
·¿m
)[0] != '\0') {

1302 
	`PRINT_ERROR
("Too many…arameter %s values (device %s)",

1303 
p
, 
dev
->
vœt_Çme
);

1304 
»s
 = -
EINVAL
;

1305 
out
;

1308 
»s
 = 
	`k¡¹oul
(
µ
, 0, &
v®
);

1309 ià(
»s
 != 0) {

1310 
	`PRINT_ERROR
("kstrtoul() for %s failed: %d "

1311 "(deviû %s)", 
µ
, 
»s
, 
dev
->
vœt_Çme
);

1312 
out
;

1315 ià(
	`¡rÿ£cmp
("»ad_Úly", 
p
) == 0) {

1316 *
»ad_Úly
 = !!
v®
;

1317 
	`TRACE_DBG
("READ ONLY %d", *
»ad_Úly
);

1319 
	`PRINT_ERROR
("UnknowÀ·¿m‘” % (deviû %s)", 
p
,

1320 
dev
->
vœt_Çme
);

1321 
»s
 = -
EINVAL
;

1322 
out
;

1326 
»s
 = 0;

1328 
out
:

1329  
»s
;

1330 
	}
}

1332 
	$__sc¡_´oûss_luns_mgmt_¡Üe
(*
bufãr
,

1333 
sc¡_tgt
 *
tgt
, 
sc¡_acg
 *
acg
, 
boÞ
 
tgt_kobj
)

1335 
»s
, 
aùiÚ
;

1336 
boÞ
 
»ad_Úly
;

1337 *
p
, *
µ
;

1338 
vœt_lun
;

1339 
sc¡_acg_dev
 *
acg_dev
 = 
NULL
, *
acg_dev_tmp
;

1340 
sc¡_deviû
 *
d
, *
dev
 = 
NULL
;

1342 
SCST_LUN_ACTION_ADD
 = 1,

1343 
SCST_LUN_ACTION_DEL
 = 2,

1344 
SCST_LUN_ACTION_REPLACE
 = 3,

1345 
SCST_LUN_ACTION_CLEAR
 = 4,

1347 
boÞ
 
»¶aû_g’_ua
 = 
Œue
;

1349 
	`TRACE_ENTRY
();

1351 
	`TRACE_DBG
("bufã¸%s", 
bufãr
);

1353 
µ
 = 
bufãr
;

1354 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

1355 ià(
	`¡rÿ£cmp
("add", 
p
) == 0) {

1356 
aùiÚ
 = 
SCST_LUN_ACTION_ADD
;

1357 } ià(
	`¡rÿ£cmp
("d–", 
p
) == 0) {

1358 
aùiÚ
 = 
SCST_LUN_ACTION_DEL
;

1359 } ià(
	`¡rÿ£cmp
("»¶aû", 
p
) == 0) {

1360 
aùiÚ
 = 
SCST_LUN_ACTION_REPLACE
;

1361 
»¶aû_g’_ua
 = 
Œue
;

1362 } ià(
	`¡rÿ£cmp
("»¶aû_no_ua", 
p
) == 0) {

1363 
aùiÚ
 = 
SCST_LUN_ACTION_REPLACE
;

1364 
»¶aû_g’_ua
 = 
çl£
;

1365 } ià(
	`¡rÿ£cmp
("þ—r", 
p
) == 0) {

1366 
aùiÚ
 = 
SCST_LUN_ACTION_CLEAR
;

1368 
	`PRINT_ERROR
("UnknowÀaùiÚ \"%s\"", 
p
);

1369 
»s
 = -
EINVAL
;

1370 
out
;

1373 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
SCST_SUSPEND_TIMEOUT_USER
);

1374 ià(
»s
 != 0)

1375 
out
;

1377 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

1378 ià(
»s
 != 0)

1379 
out_»sume
;

1382 ià(
	`sc¡_check_tgt_acg_±rs
(
tgt
, 
acg
) != 0)

1383 
out_uÆock
;

1385 ià((
aùiÚ
 !ð
SCST_LUN_ACTION_CLEAR
) &&

1386 (
aùiÚ
 !ð
SCST_LUN_ACTION_DEL
)) {

1387 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

1388 
	`li¡_fÜ_—ch_’Œy
(
d
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

1389 ià(!
	`¡rcmp
(
d
->
vœt_Çme
, 
p
)) {

1390 
dev
 = 
d
;

1391 
	`TRACE_DBG
("Deviû %°(%sèfound", 
dev
, 
p
);

1395 ià(
dev
 =ð
NULL
) {

1396 
	`PRINT_ERROR
("Deviû '%s'‚Ù found", 
p
);

1397 
»s
 = -
EINVAL
;

1398 
out_uÆock
;

1402 
aùiÚ
) {

1403 
SCST_LUN_ACTION_ADD
:

1404 
SCST_LUN_ACTION_REPLACE
:

1406 
boÞ
 
dev_»¶aûd
 = 
çl£
;

1407 
æags
 = 0;

1409 
»s
 = 
	`sc¡_·r£_add_»¶_·¿m
(
acg
, 
dev
, 
µ
, &
vœt_lun
,

1410 &
»ad_Úly
);

1411 ià(
»s
 != 0)

1412 
out_uÆock
;

1414 
acg_dev
 = 
NULL
;

1415 
	`li¡_fÜ_—ch_’Œy
(
acg_dev_tmp
, &
acg
->
acg_dev_li¡
,

1416 
acg_dev_li¡_’Œy
) {

1417 ià(
acg_dev_tmp
->
lun
 =ð
vœt_lun
) {

1418 
acg_dev
 = 
acg_dev_tmp
;

1423 ià(
acg_dev
 !ð
NULL
) {

1424 ià(
aùiÚ
 =ð
SCST_LUN_ACTION_ADD
) {

1425 
	`PRINT_ERROR
("virt†un %ld‡lreadyƒxists in "

1426 "grou°%s", 
vœt_lun
, 
acg
->
acg_Çme
);

1427 
»s
 = -
EEXIST
;

1428 
out_uÆock
;

1431 
»s
 = 
	`sc¡_acg_d–_lun
(
acg
, 
acg_dev
->
lun
,

1432 
çl£
);

1433 ià(
»s
 != 0)

1434 
out_uÆock
;

1436 
dev_»¶aûd
 = 
Œue
;

1440 ià(
»ad_Úly
)

1441 
æags
 |ð
SCST_ADD_LUN_READ_ONLY
;

1442 ià(!
dev_»¶aûd
)

1443 
æags
 |ð
SCST_ADD_LUN_GEN_UA
;

1444 
»s
 = 
	`sc¡_acg_add_lun
(
acg
,

1445 
tgt_kobj
 ? 
tgt
->
tgt_luns_kobj
 : 
acg
->
luns_kobj
,

1446 
dev
, 
vœt_lun
, 
æags
, 
NULL
);

1447 ià(
»s
 != 0)

1448 
out_uÆock
;

1450 ià(
dev_»¶aûd
 && 
»¶aû_g’_ua
) {

1451 
sc¡_tgt_dev
 *
tgt_dev
;

1453 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

1454 
dev_tgt_dev_li¡_’Œy
) {

1455 ià((
tgt_dev
->
acg_dev
->
acg
 ==‡cg) &&

1456 (
tgt_dev
->
lun
 =ð
vœt_lun
)) {

1457 
	`TRACE_MGMT_DBG
("INQUIRY DATA HAS CHANGED"

1458 " oÀtgt_dev %p", 
tgt_dev
);

1459 
	`sc¡_g’_«n_Ü_ua
(
tgt_dev
,

1460 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šquœy_d©a_chªged
));

1467 
SCST_LUN_ACTION_DEL
:

1468 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

1469 
»s
 = 
	`k¡¹oul
(
p
, 0, &
vœt_lun
);

1470 ià(
»s
 != 0)

1471 
out_uÆock
;

1473 ià(
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
)[0] != '\0') {

1474 
	`PRINT_ERROR
("Too many…arameters for del LUN %ld: %s",

1475 
vœt_lun
, 
p
);

1476 
»s
 = -
EINVAL
;

1477 
out_uÆock
;

1480 
»s
 = 
	`sc¡_acg_d–_lun
(
acg
, 
vœt_lun
, 
Œue
);

1481 ià(
»s
 != 0)

1482 
out_uÆock
;

1484 
SCST_LUN_ACTION_CLEAR
:

1485 ià(
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
)[0] != '\0') {

1486 
	`PRINT_ERROR
("ToØmªy…¬am‘” fÜ cË¬: %s", 
p
);

1487 
»s
 = -
EINVAL
;

1488 
out_uÆock
;

1490 
	`PRINT_INFO
("Removed‡ll devices from group %s",

1491 
acg
->
acg_Çme
);

1492 
	`li¡_fÜ_—ch_’Œy_§ã
(
acg_dev
, 
acg_dev_tmp
,

1493 &
acg
->
acg_dev_li¡
,

1494 
acg_dev_li¡_’Œy
) {

1495 
»s
 = 
	`sc¡_acg_d–_lun
(
acg
, 
acg_dev
->
lun
,

1496 
	`li¡_is_Ï¡
(&
acg_dev
->
acg_dev_li¡_’Œy
,

1497 &
acg
->
acg_dev_li¡
));

1498 ià(
»s
 != 0)

1499 
out_uÆock
;

1504 
»s
 = 0;

1506 
out_uÆock
:

1507 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1509 
out_»sume
:

1510 
	`sc¡_»sume_aùiv™y
();

1512 
out
:

1513 
	`TRACE_EXIT_RES
(
»s
);

1514  
»s
;

1515 
	}
}

1517 
	$sc¡_luns_mgmt_¡Üe_wÜk_â
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

1519  
	`__sc¡_´oûss_luns_mgmt_¡Üe
(
wÜk
->
buf
, wÜk->
tgt
, wÜk->
acg
,

1520 
wÜk
->
is_tgt_kobj
);

1521 
	}
}

1523 
ssize_t
 
__sc¡_acg_mgmt_¡Üe
(
sc¡_acg
 *
acg
,

1524 cÚ¡ *
buf
, 
size_t
 
couÁ
, 
boÞ
 
is_tgt_kobj
,

1525 (*
sysfs_wÜk_â
)(
sc¡_sysfs_wÜk_™em
 *))

1527 
»s
;

1528 *
bufãr
;

1529 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

1531 
	`TRACE_ENTRY
();

1533 
bufãr
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%.*s", ()
couÁ
, 
buf
);

1534 ià(
bufãr
 =ð
NULL
) {

1535 
»s
 = -
ENOMEM
;

1536 
out
;

1539 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sysfs_wÜk_â
, 
çl£
, &
wÜk
);

1540 ià(
»s
 != 0)

1541 
out_ä“
;

1543 
wÜk
->
buf
 = 
bufãr
;

1544 
wÜk
->
tgt
 = 
acg
->tgt;

1545 
wÜk
->
acg
 =‡cg;

1546 
wÜk
->
is_tgt_kobj
 = is_tgt_kobj;

1548 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

1549 ià(
»s
 == 0)

1550 
»s
 = 
couÁ
;

1552 
out
:

1553 
	`TRACE_EXIT_RES
(
»s
);

1554  
»s
;

1556 
out_ä“
:

1557 
	`kä“
(
bufãr
);

1558 
out
;

1559 
	}
}

1561 
ssize_t
 
	$__sc¡_luns_mgmt_¡Üe
(
sc¡_acg
 *
acg
,

1562 
boÞ
 
tgt_kobj
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

1564  
	`__sc¡_acg_mgmt_¡Üe
(
acg
, 
buf
, 
couÁ
, 
tgt_kobj
,

1565 
sc¡_luns_mgmt_¡Üe_wÜk_â
);

1566 
	}
}

1568 
ssize_t
 
	$sc¡_luns_mgmt_show
(
kobjeù
 *
kobj
,

1569 
kobj_©Œibu‹
 *
©Œ
,

1570 *
buf
)

1572 cÚ¡ 
h–p
[] =

1586  
	`¥rštf
(
buf
, "%s", 
h–p
);

1587 
	}
}

1589 
ssize_t
 
	$sc¡_luns_mgmt_¡Üe
(
kobjeù
 *
kobj
,

1590 
kobj_©Œibu‹
 *
©Œ
,

1591 cÚ¡ *
buf
, 
size_t
 
couÁ
)

1593 
»s
;

1594 
sc¡_acg
 *
acg
;

1595 
sc¡_tgt
 *
tgt
;

1597 
tgt
 = 
	`cÚš”_of
(
kobj
->
·»Á
, 
sc¡_tgt
, 
tgt_kobj
);

1598 
acg
 = 
tgt
->
deçuÉ_acg
;

1600 
»s
 = 
	`__sc¡_luns_mgmt_¡Üe
(
acg
, 
Œue
, 
buf
, 
couÁ
);

1602 
	`TRACE_EXIT_RES
(
»s
);

1603  
»s
;

1604 
	}
}

1606 
kobj_©Œibu‹
 
	gsc¡_luns_mgmt
 =

1607 
__ATTR
(
mgmt
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_luns_mgmt_show
,

1608 
sc¡_luns_mgmt_¡Üe
);

1610 
ssize_t
 
	$__sc¡_acg_addr_m‘hod_show
(
sc¡_acg
 *
acg
, *
buf
)

1612 
»s
;

1614 
acg
->
addr_m‘hod
) {

1615 
SCST_LUN_ADDR_METHOD_FLAT
:

1616 
»s
 = 
	`¥rštf
(
buf
, "FLAT\n");

1618 
SCST_LUN_ADDR_METHOD_PERIPHERAL
:

1619 
»s
 = 
	`¥rštf
(
buf
, "PERIPHERAL\n");

1621 
SCST_LUN_ADDR_METHOD_LUN
:

1622 
»s
 = 
	`¥rštf
(
buf
, "LUN\n");

1625 
»s
 = 
	`¥rštf
(
buf
, "UNKNOWN\n");

1629 ià(
acg
->
addr_m‘hod
 !ðacg->
tgt
->
tg‰
->
´eã¼ed_addr_m‘hod
)

1630 
»s
 +ð
	`¥rštf
(&
buf
[»s], "%s\n", 
SCST_SYSFS_KEY_MARK
);

1632  
»s
;

1633 
	}
}

1635 
ssize_t
 
	$__sc¡_acg_addr_m‘hod_¡Üe
(
sc¡_acg
 *
acg
,

1636 cÚ¡ *
buf
, 
size_t
 
couÁ
)

1638 
»s
 = 
couÁ
;

1640 ià(
	`¡ºÿ£cmp
(
buf
, "FLAT", 
	`mš_t
(, 4, 
couÁ
)) == 0)

1641 
acg
->
addr_m‘hod
 = 
SCST_LUN_ADDR_METHOD_FLAT
;

1642 ià(
	`¡ºÿ£cmp
(
buf
, "PERIPHERAL", 
	`mš_t
(, 10, 
couÁ
)) == 0)

1643 
acg
->
addr_m‘hod
 = 
SCST_LUN_ADDR_METHOD_PERIPHERAL
;

1644 ià(
	`¡ºÿ£cmp
(
buf
, "LUN", 
	`mš_t
(, 3, 
couÁ
)) == 0)

1645 
acg
->
addr_m‘hod
 = 
SCST_LUN_ADDR_METHOD_LUN
;

1647 
	`PRINT_ERROR
("UnknowÀadd»s m‘hod %s", 
buf
);

1648 
»s
 = -
EINVAL
;

1651 
	`TRACE_DBG
("acg %p,‡ddr_m‘hod %d", 
acg
,‡cg->
addr_m‘hod
);

1653  
»s
;

1654 
	}
}

1656 
ssize_t
 
	$sc¡_tgt_addr_m‘hod_show
(
kobjeù
 *
kobj
,

1657 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

1659 
sc¡_acg
 *
acg
;

1660 
sc¡_tgt
 *
tgt
;

1662 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

1663 
acg
 = 
tgt
->
deçuÉ_acg
;

1665  
	`__sc¡_acg_addr_m‘hod_show
(
acg
, 
buf
);

1666 
	}
}

1668 
ssize_t
 
	$sc¡_tgt_addr_m‘hod_¡Üe
(
kobjeù
 *
kobj
,

1669 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

1671 
»s
;

1672 
sc¡_acg
 *
acg
;

1673 
sc¡_tgt
 *
tgt
;

1675 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

1676 
acg
 = 
tgt
->
deçuÉ_acg
;

1678 
»s
 = 
	`__sc¡_acg_addr_m‘hod_¡Üe
(
acg
, 
buf
, 
couÁ
);

1680 
	`TRACE_EXIT_RES
(
»s
);

1681  
»s
;

1682 
	}
}

1684 
kobj_©Œibu‹
 
	gsc¡_tgt_addr_m‘hod
 =

1685 
__ATTR
(
addr_m‘hod
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_tgt_addr_m‘hod_show
,

1686 
sc¡_tgt_addr_m‘hod_¡Üe
);

1688 
ssize_t
 
	$__sc¡_acg_io_groupšg_ty³_show
(
sc¡_acg
 *
acg
, *
buf
)

1690 
»s
;

1692 
acg
->
acg_io_groupšg_ty³
) {

1693 
SCST_IO_GROUPING_AUTO
:

1694 
»s
 = 
	`¥rštf
(
buf
, "%s\n", 
SCST_IO_GROUPING_AUTO_STR
);

1696 
SCST_IO_GROUPING_THIS_GROUP_ONLY
:

1697 
»s
 = 
	`¥rštf
(
buf
, "%s\n%s\n",

1698 
SCST_IO_GROUPING_THIS_GROUP_ONLY_STR
,

1699 
SCST_SYSFS_KEY_MARK
);

1701 
SCST_IO_GROUPING_NEVER
:

1702 
»s
 = 
	`¥rštf
(
buf
, "%s\n%s\n", 
SCST_IO_GROUPING_NEVER_STR
,

1703 
SCST_SYSFS_KEY_MARK
);

1706 
»s
 = 
	`¥rštf
(
buf
, "%d\n%s\n", 
acg
->
acg_io_groupšg_ty³
,

1707 
SCST_SYSFS_KEY_MARK
);

1711  
»s
;

1712 
	}
}

1714 
	$__sc¡_acg_´oûss_io_groupšg_ty³_¡Üe
(
sc¡_tgt
 *
tgt
,

1715 
sc¡_acg
 *
acg
, 
io_groupšg_ty³
)

1717 
»s
 = 0;

1718 
sc¡_acg_dev
 *
acg_dev
;

1720 
	`TRACE_DBG
("tgˆ%p,‡cg %p, io_groupšg_ty³ %d", 
tgt
, 
acg
,

1721 
io_groupšg_ty³
);

1723 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
SCST_SUSPEND_TIMEOUT_USER
);

1724 ià(
»s
 != 0)

1725 
out
;

1727 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

1728 ià(
»s
 != 0)

1729 
out_»sume
;

1732 ià(
	`sc¡_check_tgt_acg_±rs
(
tgt
, 
acg
) != 0)

1733 
out_uÆock
;

1735 
acg
->
acg_io_groupšg_ty³
 = 
io_groupšg_ty³
;

1737 
	`li¡_fÜ_—ch_’Œy
(
acg_dev
, &
acg
->
acg_dev_li¡
, 
acg_dev_li¡_’Œy
) {

1738 
rc
;

1740 
	`sc¡_¡Ý_dev_th»ads
(
acg_dev
->
dev
);

1742 
rc
 = 
	`sc¡_ü—‹_dev_th»ads
(
acg_dev
->
dev
);

1743 ià(
rc
 != 0)

1744 
»s
 = 
rc
;

1747 
out_uÆock
:

1748 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1750 
out_»sume
:

1751 
	`sc¡_»sume_aùiv™y
();

1753 
out
:

1754  
»s
;

1755 
	}
}

1757 
	$__sc¡_acg_io_groupšg_ty³_¡Üe_wÜk_â
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

1759  
	`__sc¡_acg_´oûss_io_groupšg_ty³_¡Üe
(
wÜk
->
tgt
, wÜk->
acg
,

1760 
wÜk
->
io_groupšg_ty³
);

1761 
	}
}

1763 
ssize_t
 
	$__sc¡_acg_io_groupšg_ty³_¡Üe
(
sc¡_acg
 *
acg
,

1764 cÚ¡ *
buf
, 
size_t
 
couÁ
)

1766 
»s
 = 0;

1767 
´ev
 = 
acg
->
acg_io_groupšg_ty³
;

1768 
io_groupšg_ty³
;

1769 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

1771 ià(
	`¡ºÿ£cmp
(
buf
, 
SCST_IO_GROUPING_AUTO_STR
,

1772 
	`mš_t
(, 
	`¡¾’
(
SCST_IO_GROUPING_AUTO_STR
), 
couÁ
)) == 0)

1773 
io_groupšg_ty³
 = 
SCST_IO_GROUPING_AUTO
;

1774 ià(
	`¡ºÿ£cmp
(
buf
, 
SCST_IO_GROUPING_THIS_GROUP_ONLY_STR
,

1775 
	`mš_t
(, 
	`¡¾’
(
SCST_IO_GROUPING_THIS_GROUP_ONLY_STR
), 
couÁ
)) == 0)

1776 
io_groupšg_ty³
 = 
SCST_IO_GROUPING_THIS_GROUP_ONLY
;

1777 ià(
	`¡ºÿ£cmp
(
buf
, 
SCST_IO_GROUPING_NEVER_STR
,

1778 
	`mš_t
(, 
	`¡¾’
(
SCST_IO_GROUPING_NEVER_STR
), 
couÁ
)) == 0)

1779 
io_groupšg_ty³
 = 
SCST_IO_GROUPING_NEVER
;

1781 
»s
 = 
	`k¡¹Þ
(
buf
, 0, &
io_groupšg_ty³
);

1782 ià((
»s
 !ð0è|| (
io_groupšg_ty³
 <= 0)) {

1783 
	`PRINT_ERROR
("Unknown or‚ot‡llowed I/O groupingype "

1784 "%s", 
buf
);

1785 
»s
 = -
EINVAL
;

1786 
out
;

1790 ià(
´ev
 =ð
io_groupšg_ty³
)

1791 
out
;

1793 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
__sc¡_acg_io_groupšg_ty³_¡Üe_wÜk_â
,

1794 
çl£
, &
wÜk
);

1795 ià(
»s
 != 0)

1796 
out
;

1798 
wÜk
->
tgt
 = 
acg
->tgt;

1799 
wÜk
->
acg
 =‡cg;

1800 
wÜk
->
io_groupšg_ty³
 = io_grouping_type;

1802 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

1804 
out
:

1805  
»s
;

1806 
	}
}

1808 
ssize_t
 
	$sc¡_tgt_io_groupšg_ty³_show
(
kobjeù
 *
kobj
,

1809 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

1811 
sc¡_acg
 *
acg
;

1812 
sc¡_tgt
 *
tgt
;

1814 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

1815 
acg
 = 
tgt
->
deçuÉ_acg
;

1817  
	`__sc¡_acg_io_groupšg_ty³_show
(
acg
, 
buf
);

1818 
	}
}

1820 
ssize_t
 
	$sc¡_tgt_io_groupšg_ty³_¡Üe
(
kobjeù
 *
kobj
,

1821 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

1823 
»s
;

1824 
sc¡_acg
 *
acg
;

1825 
sc¡_tgt
 *
tgt
;

1827 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

1828 
acg
 = 
tgt
->
deçuÉ_acg
;

1830 
»s
 = 
	`__sc¡_acg_io_groupšg_ty³_¡Üe
(
acg
, 
buf
, 
couÁ
);

1831 ià(
»s
 != 0)

1832 
out
;

1834 
»s
 = 
couÁ
;

1836 
out
:

1837 
	`TRACE_EXIT_RES
(
»s
);

1838  
»s
;

1839 
	}
}

1841 
kobj_©Œibu‹
 
	gsc¡_tgt_io_groupšg_ty³
 =

1842 
__ATTR
(
io_groupšg_ty³
, 
S_IRUGO
 | 
S_IWUSR
,

1843 
sc¡_tgt_io_groupšg_ty³_show
,

1844 
sc¡_tgt_io_groupšg_ty³_¡Üe
);

1846 
ssize_t
 
	$__sc¡_acg_bÏck_hÞe_show
(
sc¡_acg
 *
acg
, *
buf
)

1848 
»s
, 
t
 = 
acg
->
acg_bÏck_hÞe_ty³
;

1850 
»s
 = 
	`¥rštf
(
buf
, "%d\n", 
t
);

1852  
»s
;

1853 
	}
}

1855 
ssize_t
 
	$__sc¡_acg_bÏck_hÞe_¡Üe
(
sc¡_acg
 *
acg
,

1856 cÚ¡ *
buf
, 
size_t
 
couÁ
)

1858 
»s
 = 0;

1859 
´ev
, 
t
;

1860 
sc¡_£ssiÚ
 *
£ss
;

1862 
´ev
 = 
acg
->
acg_bÏck_hÞe_ty³
;

1864 ià((
buf
 =ð
NULL
è|| (
couÁ
 == 0)) {

1865 
»s
 = 0;

1866 
out
;

1869 
	`mu‹x_lock
(&
sc¡_mu‹x
);

1871 
	`BUILD_BUG_ON
((
SCST_ACG_BLACK_HOLE_NONE
 != 0) ||

1872 (
SCST_ACG_BLACK_HOLE_CMD
 != 1) ||

1873 (
SCST_ACG_BLACK_HOLE_ALL
 != 2) ||

1874 (
SCST_ACG_BLACK_HOLE_DATA_CMD
 != 3) ||

1875 (
SCST_ACG_BLACK_HOLE_DATA_MCMD
 != 4));

1876 
buf
[0]) {

1878 
acg
->
acg_bÏck_hÞe_ty³
 = 
SCST_ACG_BLACK_HOLE_NONE
;

1881 
acg
->
acg_bÏck_hÞe_ty³
 = 
SCST_ACG_BLACK_HOLE_CMD
;

1884 
acg
->
acg_bÏck_hÞe_ty³
 = 
SCST_ACG_BLACK_HOLE_ALL
;

1887 
acg
->
acg_bÏck_hÞe_ty³
 = 
SCST_ACG_BLACK_HOLE_DATA_CMD
;

1890 
acg
->
acg_bÏck_hÞe_ty³
 = 
SCST_ACG_BLACK_HOLE_DATA_MCMD
;

1893 
	`PRINT_ERROR
("%s: Requested‡ction‚ot understood: %s",

1894 
__func__
, 
buf
);

1895 
»s
 = -
EINVAL
;

1896 
out_uÆock
;

1899 
t
 = 
acg
->
acg_bÏck_hÞe_ty³
;

1901 ià(
´ev
 =ð
t
)

1902 
out_uÆock
;

1904 
	`li¡_fÜ_—ch_’Œy
(
£ss
, &
acg
->
acg_£ss_li¡
, 
acg_£ss_li¡_’Œy
) {

1905 
i
;

1907 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

1908 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

1909 
sc¡_tgt_dev
 *
tgt_dev
;

1911 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
, 
£ss_tgt_dev_li¡_’Œy
) {

1912 ià(
t
 !ð
SCST_ACG_BLACK_HOLE_NONE
)

1913 
	`£t_b™
(
SCST_TGT_DEV_BLACK_HOLE
, &
tgt_dev
->
tgt_dev_æags
);

1915 
	`þ—r_b™
(
SCST_TGT_DEV_BLACK_HOLE
, &
tgt_dev
->
tgt_dev_æags
);

1920 
	`PRINT_INFO
("BÏck hÞ£ˆtØ%d fÜ ACG %s", 
t
, 
acg
->
acg_Çme
);

1922 
out_uÆock
:

1923 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1925 
out
:

1926  
»s
;

1927 
	}
}

1929 
ssize_t
 
	$sc¡_tgt_bÏck_hÞe_show
(
kobjeù
 *
kobj
,

1930 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

1932 
sc¡_acg
 *
acg
;

1933 
sc¡_tgt
 *
tgt
;

1935 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

1936 
acg
 = 
tgt
->
deçuÉ_acg
;

1938  
	`__sc¡_acg_bÏck_hÞe_show
(
acg
, 
buf
);

1939 
	}
}

1941 
ssize_t
 
	$sc¡_tgt_bÏck_hÞe_¡Üe
(
kobjeù
 *
kobj
,

1942 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

1944 
»s
;

1945 
sc¡_acg
 *
acg
;

1946 
sc¡_tgt
 *
tgt
;

1948 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

1949 
acg
 = 
tgt
->
deçuÉ_acg
;

1951 
»s
 = 
	`__sc¡_acg_bÏck_hÞe_¡Üe
(
acg
, 
buf
, 
couÁ
);

1952 ià(
»s
 != 0)

1953 
out
;

1955 
»s
 = 
couÁ
;

1957 
out
:

1958 
	`TRACE_EXIT_RES
(
»s
);

1959  
»s
;

1960 
	}
}

1962 
kobj_©Œibu‹
 
	gsc¡_tgt_bÏck_hÞe
 =

1963 
__ATTR
(
bÏck_hÞe
, 
S_IRUGO
 | 
S_IWUSR
,

1964 
sc¡_tgt_bÏck_hÞe_show
, 
sc¡_tgt_bÏck_hÞe_¡Üe
);

1966 
ssize_t
 
	$__sc¡_acg_ýu_mask_show
(
sc¡_acg
 *
acg
, *
buf
)

1968 
»s
;

1970 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 28)

1971 
»s
 = 
	`ýumask_sú´štf
(
buf
, 
SCST_SYSFS_BLOCK_SIZE
,

1972 
acg
->
acg_ýu_mask
);

1973 #–ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 0, 0)

1974 
»s
 = 
	`ýumask_sú´štf
(
buf
, 
SCST_SYSFS_BLOCK_SIZE
,

1975 &
acg
->
acg_ýu_mask
);

1977 
»s
 = 
	`sú´štf
(
buf
, 
SCST_SYSFS_BLOCK_SIZE
, "%*pb",

1978 
	`ýumask_´_¬gs
(&
acg
->
acg_ýu_mask
));

1980 ià(!
	`ýumask_equ®
(&
acg
->
acg_ýu_mask
, &
deçuÉ_ýu_mask
))

1981 
»s
 +ð
	`¥rštf
(&
buf
[»s], "\n%s\n", 
SCST_SYSFS_KEY_MARK
);

1983  
»s
;

1984 
	}
}

1986 
	$__sc¡_acg_´oûss_ýu_mask_¡Üe
(
sc¡_tgt
 *
tgt
,

1987 
sc¡_acg
 *
acg
, 
ýumask_t
 *
ýu_mask
)

1989 
»s
 = 0;

1990 
sc¡_£ssiÚ
 *
£ss
;

1992 
	`TRACE_DBG
("tgˆ%p,‡cg %p", 
tgt
, 
acg
);

1994 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

1995 ià(
»s
 != 0)

1996 
out
;

1999 ià(
	`sc¡_check_tgt_acg_±rs
(
tgt
, 
acg
) != 0)

2000 
out_uÆock
;

2002 
	`ýumask_cÝy
(&
acg
->
acg_ýu_mask
, 
ýu_mask
);

2004 
	`li¡_fÜ_—ch_’Œy
(
£ss
, &
acg
->
acg_£ss_li¡
, 
acg_£ss_li¡_’Œy
) {

2005 
i
;

2007 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

2008 
sc¡_tgt_dev
 *
tgt_dev
;

2009 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

2011 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
,

2012 
£ss_tgt_dev_li¡_’Œy
) {

2013 
rc
;

2015 ià(
tgt_dev
->
aùive_cmd_th»ads
 !ð&tgt_dev->
tgt_dev_cmd_th»ads
)

2017 
rc
 = 
	`sc¡_£t_thr_ýu_mask
(
tgt_dev
->
aùive_cmd_th»ads
, 
ýu_mask
);

2018 ià(
rc
 != 0)

2019 
	`PRINT_ERROR
("Setting CPU‡ffinity"

2020 " fažed: %d", 
rc
);

2023 ià(
tgt
->
tg‰
->
»pÜt_«n
 !ð
NULL
) {

2024 
sc¡_«n
 *
«n
;

2025 
rc
;

2027 
«n
 = 
	`sc¡_®loc_«n
(
£ss
, 0);

2028 ià(
«n
 =ð
NULL
) {

2029 
	`PRINT_ERROR
("Unableo‚otifyarget driver %s "

2030 "abouˆýu_mask chªge", 
tgt
->
tgt_Çme
);

2034 
«n
->
ev’t_â
 = 
SCST_AEN_CPU_MASK_CHANGED
;

2036 
	`TRACE_DBG
("Callingarget's %s„eport_aen(%p)",

2037 
tgt
->
tg‰
->
Çme
, 
«n
);

2038 
rc
 = 
tgt
->
tg‰
->
	`»pÜt_«n
(
«n
);

2039 
	`TRACE_DBG
("Target's %s„eport_aen(%p)„eturned %d",

2040 
tgt
->
tg‰
->
Çme
, 
«n
, 
rc
);

2041 ià(
rc
 !ð
SCST_AEN_RES_SUCCESS
)

2042 
	`sc¡_ä“_«n
(
«n
);

2047 
out_uÆock
:

2048 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

2050 
out
:

2051  
»s
;

2052 
	}
}

2054 
	$__sc¡_acg_ýu_mask_¡Üe_wÜk_â
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

2056  
	`__sc¡_acg_´oûss_ýu_mask_¡Üe
(
wÜk
->
tgt
, wÜk->
acg
,

2057 &
wÜk
->
ýu_mask
);

2058 
	}
}

2060 
ssize_t
 
	$__sc¡_acg_ýu_mask_¡Üe
(
sc¡_acg
 *
acg
,

2061 cÚ¡ *
buf
, 
size_t
 
couÁ
)

2063 
»s
;

2064 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

2068 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
__sc¡_acg_ýu_mask_¡Üe_wÜk_â
,

2069 
çl£
, &
wÜk
);

2070 ià(
»s
 != 0)

2071 
out
;

2077 
»s
 = 
	`__b™m­_·r£
(
buf
, 
couÁ
, 0, 
	`ýumask_b™s
(&
wÜk
->
ýu_mask
),

2078 
Ä_ýumask_b™s
);

2079 ià(
»s
 != 0) {

2080 
	`PRINT_ERROR
("__b™m­_·r£(èçžed: %d", 
»s
);

2081 
out_»Ëa£
;

2084 ià(
	`ýumask_equ®
(&
acg
->
acg_ýu_mask
, &
wÜk
->
ýu_mask
))

2085 
out
;

2087 
wÜk
->
tgt
 = 
acg
->tgt;

2088 
wÜk
->
acg
 =‡cg;

2090 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

2092 
out
:

2093  
»s
;

2095 
out_»Ëa£
:

2096 
	`sc¡_sysfs_wÜk_»Ëa£
(&
wÜk
->
sysfs_wÜk_k»f
);

2097 
out
;

2098 
	}
}

2100 
ssize_t
 
	$sc¡_tgt_ýu_mask_show
(
kobjeù
 *
kobj
,

2101 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

2103 
sc¡_acg
 *
acg
;

2104 
sc¡_tgt
 *
tgt
;

2106 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

2107 
acg
 = 
tgt
->
deçuÉ_acg
;

2109  
	`__sc¡_acg_ýu_mask_show
(
acg
, 
buf
);

2110 
	}
}

2112 
ssize_t
 
	$sc¡_tgt_ýu_mask_¡Üe
(
kobjeù
 *
kobj
,

2113 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

2115 
»s
;

2116 
sc¡_acg
 *
acg
;

2117 
sc¡_tgt
 *
tgt
;

2119 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

2120 
acg
 = 
tgt
->
deçuÉ_acg
;

2122 
»s
 = 
	`__sc¡_acg_ýu_mask_¡Üe
(
acg
, 
buf
, 
couÁ
);

2123 ià(
»s
 != 0)

2124 
out
;

2126 
»s
 = 
couÁ
;

2128 
out
:

2129 
	`TRACE_EXIT_RES
(
»s
);

2130  
»s
;

2131 
	}
}

2133 
kobj_©Œibu‹
 
	gsc¡_tgt_ýu_mask
 =

2134 
__ATTR
(
ýu_mask
, 
S_IRUGO
 | 
S_IWUSR
,

2135 
sc¡_tgt_ýu_mask_show
,

2136 
sc¡_tgt_ýu_mask_¡Üe
);

2138 
ssize_t
 
	$sc¡_ši_group_mgmt_show
(
kobjeù
 *
kobj
,

2139 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

2141 cÚ¡ 
h–p
[] =

2145  
	`¥rštf
(
buf
, "%s", 
h–p
);

2146 
	}
}

2148 
	$sc¡_´oûss_ši_group_mgmt_¡Üe
(*
bufãr
,

2149 
sc¡_tgt
 *
tgt
)

2151 
»s
, 
aùiÚ
;

2152 *
p
, *
µ
;

2153 
sc¡_acg
 *
acg
;

2155 
SCST_INI_GROUP_ACTION_CREATE
 = 1,

2156 
SCST_INI_GROUP_ACTION_DEL
 = 2,

2159 
	`TRACE_ENTRY
();

2161 
	`TRACE_DBG
("tgˆ%p, bufã¸%s", 
tgt
, 
bufãr
);

2163 
µ
 = 
bufãr
;

2164 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

2165 ià(
	`¡rÿ£cmp
("ü—‹", 
p
) == 0) {

2166 
aùiÚ
 = 
SCST_INI_GROUP_ACTION_CREATE
;

2167 } ià(
	`¡rÿ£cmp
("d–", 
p
) == 0) {

2168 
aùiÚ
 = 
SCST_INI_GROUP_ACTION_DEL
;

2170 
	`PRINT_ERROR
("UnknowÀaùiÚ \"%s\"", 
p
);

2171 
»s
 = -
EINVAL
;

2172 
out
;

2175 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
SCST_SUSPEND_TIMEOUT_USER
);

2176 ià(
»s
 != 0)

2177 
out
;

2179 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

2180 ià(
»s
 != 0)

2181 
out_»sume
;

2184 ià(
	`sc¡_check_tgt_acg_±rs
(
tgt
, 
NULL
) != 0)

2185 
out_uÆock
;

2187 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

2188 ià(
p
[0] == '\0') {

2189 
	`PRINT_ERROR
("%s", "Group‚ame„equired");

2190 
»s
 = -
EINVAL
;

2191 
out_uÆock
;

2194 
acg
 = 
	`sc¡_tgt_fšd_acg
(
tgt
, 
p
);

2196 
aùiÚ
) {

2197 
SCST_INI_GROUP_ACTION_CREATE
:

2198 
	`TRACE_DBG
("C»©šg grou°'%s'", 
p
);

2199 ià(
acg
 !ð
NULL
) {

2200 
	`PRINT_ERROR
("acg‚am% exi¡", 
p
);

2201 
»s
 = -
EINVAL
;

2202 
out_uÆock
;

2204 
»s
 = 
	`sc¡_®loc_add_acg
(
tgt
, 
p
, 
Œue
, &
acg
);

2205 ià(
»s
 != 0)

2206 
out_uÆock
;

2208 
SCST_INI_GROUP_ACTION_DEL
:

2209 
	`TRACE_DBG
("D–‘šg grou°'%s'", 
p
);

2210 ià(
acg
 =ð
NULL
) {

2211 
	`PRINT_ERROR
("Grou°% nÙ found", 
p
);

2212 
»s
 = -
EINVAL
;

2213 
out_uÆock
;

2215 
»s
 = 
	`sc¡_d–_ä“_acg
(
acg
, 
sc¡_fÜcibly_þo£_£ssiÚs
);

2216 ià(
»s
) {

2217 ià(
sc¡_fÜcibly_þo£_£ssiÚs
)

2218 
	`PRINT_ERROR
("Removing group %s failed",

2219 
acg
->
acg_Çme
);

2221 
	`PRINT_ERROR
("Group %s is‚otƒmpty",

2222 
acg
->
acg_Çme
);

2223 
out_uÆock
;

2228 
»s
 = 0;

2230 
out_uÆock
:

2231 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

2233 
out_»sume
:

2234 
	`sc¡_»sume_aùiv™y
();

2236 
out
:

2237 
	`TRACE_EXIT_RES
(
»s
);

2238  
»s
;

2239 
	}
}

2241 
	$sc¡_ši_group_mgmt_¡Üe_wÜk_â
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

2243  
	`sc¡_´oûss_ši_group_mgmt_¡Üe
(
wÜk
->
buf
, wÜk->
tgt
);

2244 
	}
}

2246 
ssize_t
 
	$sc¡_ši_group_mgmt_¡Üe
(
kobjeù
 *
kobj
,

2247 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

2249 
»s
;

2250 *
bufãr
;

2251 
sc¡_tgt
 *
tgt
;

2252 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

2254 
	`TRACE_ENTRY
();

2256 
tgt
 = 
	`cÚš”_of
(
kobj
->
·»Á
, 
sc¡_tgt
, 
tgt_kobj
);

2258 
bufãr
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%.*s", ()
couÁ
, 
buf
);

2259 ià(
bufãr
 =ð
NULL
) {

2260 
»s
 = -
ENOMEM
;

2261 
out
;

2264 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_ši_group_mgmt_¡Üe_wÜk_â
, 
çl£
,

2265 &
wÜk
);

2266 ià(
»s
 != 0)

2267 
out_ä“
;

2269 
wÜk
->
buf
 = 
bufãr
;

2270 
wÜk
->
tgt
 =gt;

2272 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

2273 ià(
»s
 == 0)

2274 
»s
 = 
couÁ
;

2276 
out
:

2277 
	`TRACE_EXIT_RES
(
»s
);

2278  
»s
;

2280 
out_ä“
:

2281 
	`kä“
(
bufãr
);

2282 
out
;

2283 
	}
}

2285 
kobj_©Œibu‹
 
	gsc¡_ši_group_mgmt
 =

2286 
__ATTR
(
mgmt
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_ši_group_mgmt_show
,

2287 
sc¡_ši_group_mgmt_¡Üe
);

2289 
ssize_t
 
	$sc¡_tgt_’abË_show
(
kobjeù
 *
kobj
,

2290 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

2292 
sc¡_tgt
 *
tgt
;

2293 
»s
;

2294 
boÞ
 
’abËd
;

2296 
	`TRACE_ENTRY
();

2298 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

2300 
’abËd
 = 
tgt
->
tg‰
->
	`is_rg‘_’abËd
(tgt);

2302 
»s
 = 
	`¥rštf
(
buf
, "%d\n", 
’abËd
 ? 1 : 0);

2304 
	`TRACE_EXIT_RES
(
»s
);

2305  
»s
;

2306 
	}
}

2308 
	$sc¡_´oûss_tgt_’abË_¡Üe
(
sc¡_tgt
 *
tgt
, 
boÞ
 
’abË
)

2310 
»s
;

2312 
	`TRACE_ENTRY
();

2316 
	`TRACE_DBG
("tgˆ%s,ƒÇbË %d", 
tgt
->
tgt_Çme
, 
’abË
);

2318 ià(
’abË
) {

2319 ià(
tgt
->
»l_tgt_id
 == 0) {

2320 
»s
 = 
	`g’_»Ïtive_rg‘_pÜt_id
(&
tgt
->
»l_tgt_id
);

2321 ià(
»s
 != 0)

2322 
out_put
;

2323 
	`PRINT_INFO
("Using‡utogenerated„elativearget id %d "

2324 "fÜ¬g‘ %s", 
tgt
->
»l_tgt_id
,gt->
tgt_Çme
);

2326 ià(!
	`sc¡_is_»Ïtive_rg‘_pÜt_id_unique
(

2327 
tgt
->
»l_tgt_id
,gt)) {

2328 
	`PRINT_ERROR
("Relativearget id %d is‚ot "

2329 "unique", 
tgt
->
»l_tgt_id
);

2330 
»s
 = -
EBADSLT
;

2331 
out_put
;

2336 
»s
 = 
tgt
->
tg‰
->
	`’abË_rg‘
Ñgt, 
’abË
);

2338 
out_put
:

2339 
	`kobjeù_put
(&
tgt
->
tgt_kobj
);

2341 
	`TRACE_EXIT_RES
(
»s
);

2342  
»s
;

2343 
	}
}

2345 
	$sc¡_tgt_’abË_¡Üe_wÜk_â
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

2347  
	`sc¡_´oûss_tgt_’abË_¡Üe
(
wÜk
->
tgt
, wÜk->
’abË
);

2348 
	}
}

2350 
ssize_t
 
	$sc¡_tgt_’abË_¡Üe
(
kobjeù
 *
kobj
,

2351 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

2353 
»s
;

2354 
sc¡_tgt
 *
tgt
;

2355 
boÞ
 
’abË
;

2356 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

2358 
	`TRACE_ENTRY
();

2360 ià(
buf
 =ð
NULL
) {

2361 
	`PRINT_ERROR
("%s: NULL bufãr?", 
__func__
);

2362 
»s
 = -
EINVAL
;

2363 
out
;

2366 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

2368 
buf
[0]) {

2370 
’abË
 = 
çl£
;

2373 
’abË
 = 
Œue
;

2376 
	`PRINT_ERROR
("%s: Requested‡ction‚ot understood: %s",

2377 
__func__
, 
buf
);

2378 
»s
 = -
EINVAL
;

2379 
out
;

2382 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_tgt_’abË_¡Üe_wÜk_â
, 
çl£
,

2383 &
wÜk
);

2384 ià(
»s
 != 0)

2385 
out
;

2387 
wÜk
->
tgt
 =gt;

2388 
wÜk
->
’abË
 =ƒnable;

2390 
	`SCST_SET_DEP_MAP
(
wÜk
, &
sc¡_tgt_d•_m­
);

2391 
	`kobjeù_g‘
(&
tgt
->
tgt_kobj
);

2393 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

2394 ià(
»s
 == 0)

2395 
»s
 = 
couÁ
;

2397 
out
:

2398 
	`TRACE_EXIT_RES
(
»s
);

2399  
»s
;

2400 
	}
}

2402 
kobj_©Œibu‹
 
	gtgt_’abË_©Œ
 =

2403 
__ATTR
(
’abËd
, 
S_IRUGO
 | 
S_IWUSR
,

2404 
sc¡_tgt_’abË_show
, 
sc¡_tgt_’abË_¡Üe
);

2406 
ssize_t
 
	$sc¡_»l_tgt_id_show
(
kobjeù
 *
kobj
,

2407 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

2409 
sc¡_tgt
 *
tgt
;

2410 
»s
;

2412 
	`TRACE_ENTRY
();

2414 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

2416 
»s
 = 
	`¥rštf
(
buf
, "%d\n%s", 
tgt
->
»l_tgt_id
,

2417 (
tgt
->
»l_tgt_id
 !ð0è? 
SCST_SYSFS_KEY_MARK
 "\n" : "");

2419 
	`TRACE_EXIT_RES
(
»s
);

2420  
»s
;

2421 
	}
}

2423 
	$sc¡_´oûss_»l_tgt_id_¡Üe
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

2425 
»s
 = 0;

2426 
sc¡_tgt
 *
tgt
 = 
wÜk
->
tgt_r
;

2427 
»l_tgt_id
 = 
wÜk
->rel_tgt_id;

2428 
boÞ
 
’abËd
;

2430 
	`TRACE_ENTRY
();

2434 
	`TRACE_DBG
("Tryingo set„elativearget…ort id %d",

2435 (
ušt16_t
)
»l_tgt_id
);

2437 ià(
tgt
->
tg‰
->
is_rg‘_’abËd
 !ð
NULL
)

2438 
’abËd
 = 
tgt
->
tg‰
->
	`is_rg‘_’abËd
(tgt);

2440 
’abËd
 = 
Œue
;

2442 ià(
’abËd
 && 
»l_tgt_id
 !ð
tgt
->rel_tgt_id) {

2443 ià(!
	`sc¡_is_»Ïtive_rg‘_pÜt_id_unique
(
»l_tgt_id
, 
tgt
)) {

2444 
	`PRINT_ERROR
("Relative…ort id %d is‚ot unique",

2445 (
ušt16_t
)
»l_tgt_id
);

2446 
»s
 = -
EBADSLT
;

2447 
out_put
;

2451 ià(
»l_tgt_id
 < 
SCST_MIN_REL_TGT_ID
 ||

2452 
»l_tgt_id
 > 
SCST_MAX_REL_TGT_ID
) {

2453 ià((
»l_tgt_id
 =ð0è&& !
’abËd
)

2454 
£t
;

2456 
	`PRINT_ERROR
("Invalid„elative…ort id %d",

2457 (
ušt16_t
)
»l_tgt_id
);

2458 
»s
 = -
EINVAL
;

2459 
out_put
;

2462 
£t
:

2463 
tgt
->
»l_tgt_id
 = (
ušt16_t
)rel_tgt_id;

2465 
out_put
:

2466 
	`kobjeù_put
(&
tgt
->
tgt_kobj
);

2468 
	`TRACE_EXIT_RES
(
»s
);

2469  
»s
;

2470 
	}
}

2472 
ssize_t
 
	$sc¡_»l_tgt_id_¡Üe
(
kobjeù
 *
kobj
,

2473 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

2475 
»s
 = 0;

2476 
sc¡_tgt
 *
tgt
;

2477 
»l_tgt_id
;

2478 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

2480 
	`TRACE_ENTRY
();

2482 ià(
buf
 =ð
NULL
)

2483 
out
;

2485 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

2487 
»s
 = 
	`k¡¹oul
(
buf
, 0, &
»l_tgt_id
);

2488 ià(
»s
 != 0) {

2489 
	`PRINT_ERROR
("%s", "Wrong„el_tgt_id");

2490 
»s
 = -
EINVAL
;

2491 
out
;

2494 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_´oûss_»l_tgt_id_¡Üe
, 
çl£
,

2495 &
wÜk
);

2496 ià(
»s
 != 0)

2497 
out
;

2499 
wÜk
->
tgt_r
 = 
tgt
;

2500 
wÜk
->
»l_tgt_id
 =„el_tgt_id;

2502 
	`SCST_SET_DEP_MAP
(
wÜk
, &
sc¡_tgt_d•_m­
);

2503 
	`kobjeù_g‘
(&
tgt
->
tgt_kobj
);

2505 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

2506 ià(
»s
 == 0)

2507 
»s
 = 
couÁ
;

2509 
out
:

2510 
	`TRACE_EXIT_RES
(
»s
);

2511  
»s
;

2512 
	}
}

2514 
kobj_©Œibu‹
 
	gsc¡_»l_tgt_id
 =

2515 
__ATTR
(
»l_tgt_id
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_»l_tgt_id_show
,

2516 
sc¡_»l_tgt_id_¡Üe
);

2518 
ssize_t
 
	$sc¡_tgt_fÜw¬dšg_show
(
kobjeù
 *
kobj
,

2519 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

2521 
sc¡_tgt
 *
tgt
;

2522 
»s
;

2524 
	`TRACE_ENTRY
();

2526 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

2528 
»s
 = 
	`¥rštf
(
buf
, "%d\n%s", 
tgt
->
tgt_fÜw¬dšg
,

2529 
tgt
->
tgt_fÜw¬dšg
 ? 
SCST_SYSFS_KEY_MARK
 "\n" : "");

2531 
	`TRACE_EXIT_RES
(
»s
);

2532  
»s
;

2533 
	}
}

2535 
ssize_t
 
	$sc¡_tgt_fÜw¬dšg_¡Üe
(
kobjeù
 *
kobj
,

2536 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

2538 
»s
 = 0;

2539 
sc¡_tgt
 *
tgt
;

2540 
sc¡_£ssiÚ
 *
£ss
;

2541 
Þd
;

2543 
	`TRACE_ENTRY
();

2545 ià((
buf
 =ð
NULL
è|| (
couÁ
 == 0)) {

2546 
»s
 = 0;

2547 
out
;

2550 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

2552 
	`mu‹x_lock
(&
sc¡_mu‹x
);

2554 
Þd
 = 
tgt
->
tgt_fÜw¬dšg
;

2556 
buf
[0]) {

2558 
tgt
->
tgt_fÜw¬dšg
 = 0;

2561 
tgt
->
tgt_fÜw¬dšg
 = 1;

2564 
	`PRINT_ERROR
("%s: Requested‡ction‚ot understood: %s",

2565 
__func__
, 
buf
);

2566 
»s
 = -
EINVAL
;

2567 
out_uÆock
;

2570 ià(
tgt
->
tgt_fÜw¬dšg
 =ð
Þd
)

2571 
out_uÆock
;

2573 
	`li¡_fÜ_—ch_’Œy
(
£ss
, &
tgt
->
£ss_li¡
, 
£ss_li¡_’Œy
) {

2574 
i
;

2576 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

2577 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

2578 
sc¡_tgt_dev
 *
tgt_dev
;

2580 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
, 
£ss_tgt_dev_li¡_’Œy
) {

2581 ià(
tgt
->
tgt_fÜw¬dšg
)

2582 
	`£t_b™
(
SCST_TGT_DEV_FORWARDING
, &
tgt_dev
->
tgt_dev_æags
);

2584 
	`þ—r_b™
(
SCST_TGT_DEV_FORWARDING
, &
tgt_dev
->
tgt_dev_æags
);

2589 ià(
tgt
->
tgt_fÜw¬dšg
)

2590 
	`PRINT_INFO
("S‘¬g‘ % a fÜw¬dšg", 
tgt
->
tgt_Çme
);

2592 
	`PRINT_INFO
("CË¬¬g‘ % a fÜw¬dšg", 
tgt
->
tgt_Çme
);

2594 
out_uÆock
:

2595 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

2597 ià(
»s
 == 0)

2598 
»s
 = 
couÁ
;

2600 
out
:

2601 
	`TRACE_EXIT_RES
(
»s
);

2602  
»s
;

2603 
	}
}

2605 
kobj_©Œibu‹
 
	gsc¡_tgt_fÜw¬dšg
 =

2606 
__ATTR
(
fÜw¬dšg
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_tgt_fÜw¬dšg_show
,

2607 
sc¡_tgt_fÜw¬dšg_¡Üe
);

2609 
ssize_t
 
	$sc¡_tgt_comm’t_show
(
kobjeù
 *
kobj
,

2610 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

2612 
sc¡_tgt
 *
tgt
;

2613 
»s
;

2615 
	`TRACE_ENTRY
();

2617 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

2619 ià(
tgt
->
tgt_comm’t
 !ð
NULL
)

2620 
»s
 = 
	`¥rštf
(
buf
, "%s\n%s", 
tgt
->
tgt_comm’t
,

2621 
SCST_SYSFS_KEY_MARK
 "\n");

2623 
»s
 = 0;

2625 
	`TRACE_EXIT_RES
(
»s
);

2626  
»s
;

2627 
	}
}

2629 
ssize_t
 
	$sc¡_tgt_comm’t_¡Üe
(
kobjeù
 *
kobj
,

2630 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

2632 
»s
;

2633 
sc¡_tgt
 *
tgt
;

2634 *
p
;

2635 
Ën
;

2637 
	`TRACE_ENTRY
();

2639 ià((
buf
 =ð
NULL
è|| (
couÁ
 == 0)) {

2640 
»s
 = 0;

2641 
out
;

2644 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

2646 
Ën
 = 
	`¡ºËn
(
buf
, 
couÁ
);

2647 ià(
buf
[
couÁ
-1] == '\n')

2648 
Ën
--;

2650 ià(
Ën
 == 0) {

2651 
	`kä“
(
tgt
->
tgt_comm’t
);

2652 
tgt
->
tgt_comm’t
 = 
NULL
;

2653 
out_dÚe
;

2656 
p
 = 
	`km®loc
(
Ën
+1, 
GFP_KERNEL
);

2657 ià(
p
 =ð
NULL
) {

2658 
	`PRINT_ERROR
("Unableo‡llocgt_comment string (len %d)",

2659 
Ën
+1);

2660 
»s
 = -
ENOMEM
;

2661 
out
;

2664 
	`memýy
(
p
, 
buf
, 
Ën
);

2665 
p
[
Ën
] = '\0';

2667 
	`kä“
(
tgt
->
tgt_comm’t
);

2669 
tgt
->
tgt_comm’t
 = 
p
;

2671 
out_dÚe
:

2672 
»s
 = 
couÁ
;

2674 
out
:

2675 
	`TRACE_EXIT_RES
(
»s
);

2676  
»s
;

2677 
	}
}

2679 
kobj_©Œibu‹
 
	gsc¡_tgt_comm’t
 =

2680 
__ATTR
(
comm’t
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_tgt_comm’t_show
,

2681 
sc¡_tgt_comm’t_¡Üe
);

2686 
	$sc¡_ü—‹_tgt_©Œ
(
sc¡_tgt
 *
tgt
, 
kobj_©Œibu‹
 *
©Œibu‹
)

2688 
»s
;

2690 
»s
 = 
	`sysfs_ü—‹_fže
(&
tgt
->
tgt_kobj
, &
©Œibu‹
->
©Œ
);

2691 ià(
»s
 != 0) {

2692 
	`PRINT_ERROR
("Can't‡dd‡ttribute %s forgt %s",

2693 
©Œibu‹
->
©Œ
.
Çme
, 
tgt
->
tgt_Çme
);

2694 
out
;

2697 
out
:

2698  
»s
;

2699 
	}
}

2700 
EXPORT_SYMBOL
(
sc¡_ü—‹_tgt_©Œ
);

2702 
ssize_t
 
	$sc¡_tgt_dif_ÿ·bË_show
(
kobjeù
 *
kobj
,

2703 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

2705 
pos
 = 0;

2706 
sc¡_tgt
 *
tgt
;

2708 
	`TRACE_ENTRY
();

2710 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

2712 
	`EXTRACHECKS_BUG_ON
(!
tgt
->
tgt_dif_suµÜ‹d
);

2714 
pos
 +ð
	`sú´štf
(&
buf
[pos], 
SCST_SYSFS_BLOCK_SIZE
 -…os,

2717 ià(
tgt
->
tgt_hw_dif_ty³1_suµÜ‹d
)

2718 
pos
 +ð
	`sú´štf
(&
buf
[pos], 
SCST_SYSFS_BLOCK_SIZE
 -…os,

2721 ià(
tgt
->
tgt_hw_dif_ty³2_suµÜ‹d
)

2722 
pos
 +ð
	`sú´štf
(&
buf
[pos], 
SCST_SYSFS_BLOCK_SIZE
 -…os,

2725 ià(
tgt
->
tgt_hw_dif_ty³3_suµÜ‹d
)

2726 
pos
 +ð
	`sú´štf
(&
buf
[pos], 
SCST_SYSFS_BLOCK_SIZE
 -…os,

2729 ià(
tgt
->
tgt_hw_dif__suµÜ‹d
)

2730 
pos
 +ð
	`sú´štf
(&
buf
[pos], 
SCST_SYSFS_BLOCK_SIZE
 -…os,

2733 ià(
tgt
->
tgt_hw_dif_§me_sg_Ïyout_»quœed
)

2734 
pos
 +ð
	`sú´štf
(&
buf
[pos], 
SCST_SYSFS_BLOCK_SIZE
 -…os,

2737 
pos
 +ð
	`sú´štf
(&
buf
[pos], 
SCST_SYSFS_BLOCK_SIZE
 -…os, "\n");

2739 ià(
tgt
->
tgt_suµÜ‹d_dif_block_sizes
) {

2740 cÚ¡ *
p
 = 
tgt
->
tgt_suµÜ‹d_dif_block_sizes
;

2741 
j
;

2743 
pos
 +ð
	`sú´štf
(&
buf
[pos], 
SCST_SYSFS_BLOCK_SIZE
 -…os,

2745 
j
 = 
pos
;

2746 *
p
 != 0) {

2747 
pos
 +ð
	`sú´štf
(&
buf
[pos], 
SCST_SYSFS_BLOCK_SIZE
 -…os,

2748 "%s%d", (
j
 =ð
pos
è? "" : ", ", *
p
);

2749 
p
++;

2753 
	`TRACE_EXIT_RES
(
pos
);

2754  
pos
;

2755 
	}
}

2757 
kobj_©Œibu‹
 
	gsc¡_tgt_dif_ÿ·bË_©Œ
 =

2758 
__ATTR
(
dif_ÿ·bž™›s
, 
S_IRUGO
, 
sc¡_tgt_dif_ÿ·bË_show
, 
NULL
);

2760 
ssize_t
 
	$sc¡_tgt_dif_checks_çžed_show
(
kobjeù
 *
kobj
,

2761 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

2763 
pos
 = 0;

2764 
sc¡_tgt
 *
tgt
;

2766 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

2768 
pos
 = 
	`sú´štf
(
buf
, 
SCST_SYSFS_BLOCK_SIZE
, "\tapp\tref\tguard\n"

2770 
	`©omic_»ad
(&
tgt
->
tgt_dif_­p_çžed_tgt
),

2771 
	`©omic_»ad
(&
tgt
->
tgt_dif_»f_çžed_tgt
),

2772 
	`©omic_»ad
(&
tgt
->
tgt_dif_gu¬d_çžed_tgt
),

2773 
	`©omic_»ad
(&
tgt
->
tgt_dif_­p_çžed_sc¡
),

2774 
	`©omic_»ad
(&
tgt
->
tgt_dif_»f_çžed_sc¡
),

2775 
	`©omic_»ad
(&
tgt
->
tgt_dif_gu¬d_çžed_sc¡
),

2776 
	`©omic_»ad
(&
tgt
->
tgt_dif_­p_çžed_dev
),

2777 
	`©omic_»ad
(&
tgt
->
tgt_dif_»f_çžed_dev
),

2778 
	`©omic_»ad
(&
tgt
->
tgt_dif_gu¬d_çžed_dev
));

2780  
pos
;

2781 
	}
}

2783 
ssize_t
 
	$sc¡_tgt_dif_checks_çžed_¡Üe
(
kobjeù
 *
kobj
,

2784 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

2786 
sc¡_tgt
 *
tgt
;

2788 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

2790 
	`PRINT_INFO
("Zeroing DIF failures statistics forarget %s",

2791 
tgt
->
tgt_Çme
);

2793 
	`©omic_£t
(&
tgt
->
tgt_dif_­p_çžed_tgt
, 0);

2794 
	`©omic_£t
(&
tgt
->
tgt_dif_»f_çžed_tgt
, 0);

2795 
	`©omic_£t
(&
tgt
->
tgt_dif_gu¬d_çžed_tgt
, 0);

2796 
	`©omic_£t
(&
tgt
->
tgt_dif_­p_çžed_sc¡
, 0);

2797 
	`©omic_£t
(&
tgt
->
tgt_dif_»f_çžed_sc¡
, 0);

2798 
	`©omic_£t
(&
tgt
->
tgt_dif_gu¬d_çžed_sc¡
, 0);

2799 
	`©omic_£t
(&
tgt
->
tgt_dif_­p_çžed_dev
, 0);

2800 
	`©omic_£t
(&
tgt
->
tgt_dif_»f_çžed_dev
, 0);

2801 
	`©omic_£t
(&
tgt
->
tgt_dif_gu¬d_çžed_dev
, 0);

2803  
couÁ
;

2804 
	}
}

2806 
kobj_©Œibu‹
 
	gsc¡_tgt_dif_checks_çžed_©Œ
 =

2807 
__ATTR
(
dif_checks_çžed
, 
S_IRUGO
 | 
S_IWUSR
,

2808 
sc¡_tgt_dif_checks_çžed_show
,

2809 
sc¡_tgt_dif_checks_çžed_¡Üe
);

2811 
	#SCST_TGT_SYSFS_STAT_ATTR
(
memb”_Çme
, 
©Œ
, 
dœ
, 
»suÉ_Ý
) \

2812 
sc¡_tgt_sysfs_
##
©Œ
##
	`_show_wÜk_â
( \

2813 
sc¡_sysfs_wÜk_™em
 *
wÜk
) \

2815 
sc¡_tgt
 *
tgt
 = 
wÜk
->tgt; \

2816 
sc¡_£ssiÚ
 *
£ss
; \

2817 
»s
; \

2818 
ušt64_t
 
c
 = 0; \

2820 
	`BUILD_BUG_ON
(()(
dœ
è>ð
	`ARRAY_SIZE
(
£ss
->
io_¡©s
)); \

2822 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
); \

2823 ià(
»s
) \

2824 
out
; \

2825 
	`li¡_fÜ_—ch_’Œy
(
£ss
, &
tgt
->
£ss_li¡
, 
£ss_li¡_’Œy
) \

2826 
c
 +ð
£ss
->
io_¡©s
[(
dœ
)].
memb”_Çme
; \

2827 
	`mu‹x_uÆock
(&
sc¡_mu‹x
); \

2829 
wÜk
->
»s_buf
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%Îu\n", 
c
 
»suÉ_Ý
); \

2830 
»s
 = 
wÜk
->
»s_buf
 ? 0 : -
ENOMEM
; \

2832 
out
: \

2833 
	`kobjeù_put
(&
tgt
->
tgt_kobj
); \

2834  
»s
; \

2837 
ssize_t
 
sc¡_tgt_sysfs_
##
©Œ
##
	`_show
(
kobjeù
 *
kobj
, \

2838 
kobj_©Œibu‹
 *
©Œ
, \

2839 *
buf
) \

2841 
sc¡_tgt
 *
tgt
 = \

2842 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
); \

2843 
sc¡_sysfs_wÜk_™em
 *
wÜk
; \

2844 
»s
; \

2846 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_tgt_sysfs_
##
©Œ
##
_show_wÜk_â
, \

2847 
Œue
, &
wÜk
); \

2848 ià(
»s
) \

2849 
out
; \

2851 
wÜk
->
tgt
 =gt; \

2852 
	`SCST_SET_DEP_MAP
(
wÜk
, &
sc¡_tgt_d•_m­
); \

2853 
	`kobjeù_g‘
(&
tgt
->
tgt_kobj
); \

2854 
	`sc¡_sysfs_wÜk_g‘
(
wÜk
); \

2855 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
); \

2856 ià(
»s
 == 0) \

2857 
»s
 = 
	`sú´štf
(
buf
, 
PAGE_SIZE
, "%s", 
wÜk
->
»s_buf
); \

2858 
	`sc¡_sysfs_wÜk_put
(
wÜk
); \

2860 
out
: \

2861  
»s
; \

2864 
kobj_©Œibu‹
 
sc¡_tgt_
##
©Œ
##
_©Œ
 = \

2865 
	`__ATTR
(
©Œ
, 
S_IRUGO
, 
sc¡_tgt_sysfs_
##©Œ##
_show
, 
NULL
)

	)

2867 
SCST_TGT_SYSFS_STAT_ATTR
(
cmd_couÁ
, 
unknown_cmd_couÁ
, 
SCST_DATA_UNKNOWN
, >> 0);

2868 
SCST_TGT_SYSFS_STAT_ATTR
(
cmd_couÁ
, 
wr™e_cmd_couÁ
, 
SCST_DATA_WRITE
, >> 0);

2869 
SCST_TGT_SYSFS_STAT_ATTR
(
io_by‹_couÁ
, 
wr™e_io_couÁ_kb
, 
SCST_DATA_WRITE
, >> 10);

2870 
SCST_TGT_SYSFS_STAT_ATTR
(
uÇligÃd_cmd_couÁ
, 
wr™e_uÇligÃd_cmd_couÁ
, 
SCST_DATA_WRITE
, >> 0);

2871 
SCST_TGT_SYSFS_STAT_ATTR
(
cmd_couÁ
, 
»ad_cmd_couÁ
, 
SCST_DATA_READ
, >> 0);

2872 
SCST_TGT_SYSFS_STAT_ATTR
(
io_by‹_couÁ
, 
»ad_io_couÁ_kb
, 
SCST_DATA_READ
, >> 10);

2873 
SCST_TGT_SYSFS_STAT_ATTR
(
uÇligÃd_cmd_couÁ
, 
»ad_uÇligÃd_cmd_couÁ
, 
SCST_DATA_READ
, >> 0);

2874 
SCST_TGT_SYSFS_STAT_ATTR
(
cmd_couÁ
, 
bidi_cmd_couÁ
, 
SCST_DATA_BIDI
, >> 0);

2875 
SCST_TGT_SYSFS_STAT_ATTR
(
io_by‹_couÁ
, 
bidi_io_couÁ_kb
, 
SCST_DATA_BIDI
, >> 10);

2876 
SCST_TGT_SYSFS_STAT_ATTR
(
uÇligÃd_cmd_couÁ
, 
bidi_uÇligÃd_cmd_couÁ
, 
SCST_DATA_BIDI
, >> 0);

2877 
SCST_TGT_SYSFS_STAT_ATTR
(
cmd_couÁ
, 
nÚe_cmd_couÁ
, 
SCST_DATA_NONE
, >> 0);

2879 
©Œibu‹
 *
	gsc¡_tgt_©Œs
[] = {

2880 &
sc¡_»l_tgt_id
.
©Œ
,

2881 &
sc¡_tgt_fÜw¬dšg
.
©Œ
,

2882 &
sc¡_tgt_comm’t
.
©Œ
,

2883 &
sc¡_tgt_addr_m‘hod
.
©Œ
,

2884 &
sc¡_tgt_io_groupšg_ty³
.
©Œ
,

2885 &
sc¡_tgt_bÏck_hÞe
.
©Œ
,

2886 &
sc¡_tgt_ýu_mask
.
©Œ
,

2887 &
sc¡_tgt_unknown_cmd_couÁ_©Œ
.
©Œ
,

2888 &
sc¡_tgt_wr™e_cmd_couÁ_©Œ
.
©Œ
,

2889 &
sc¡_tgt_wr™e_io_couÁ_kb_©Œ
.
©Œ
,

2890 &
sc¡_tgt_wr™e_uÇligÃd_cmd_couÁ_©Œ
.
©Œ
,

2891 &
sc¡_tgt_»ad_cmd_couÁ_©Œ
.
©Œ
,

2892 &
sc¡_tgt_»ad_io_couÁ_kb_©Œ
.
©Œ
,

2893 &
sc¡_tgt_»ad_uÇligÃd_cmd_couÁ_©Œ
.
©Œ
,

2894 &
sc¡_tgt_bidi_cmd_couÁ_©Œ
.
©Œ
,

2895 &
sc¡_tgt_bidi_io_couÁ_kb_©Œ
.
©Œ
,

2896 &
sc¡_tgt_bidi_uÇligÃd_cmd_couÁ_©Œ
.
©Œ
,

2897 &
sc¡_tgt_nÚe_cmd_couÁ_©Œ
.
©Œ
,

2898 
NULL
,

2901 
kobj_ty³
 
	gtgt_kty³
 = {

2902 .
sysfs_Ýs
 = &
sc¡_sysfs_Ýs
,

2903 .
	g»Ëa£
 = 
sc¡_tgt_»Ëa£
,

2904 .
	gdeçuÉ_©Œs
 = 
sc¡_tgt_©Œs
,

2911 
	$sc¡_tgt_sysfs_ü—‹
(
sc¡_tgt
 *
tgt
)

2913 
»s
;

2915 
	`TRACE_ENTRY
();

2917 
»s
 = 
	`kobjeù_š™_ªd_add
(&
tgt
->
tgt_kobj
, &
tgt_kty³
,

2918 &
tgt
->
tg‰
->
tg‰_kobj
,gt->
tgt_Çme
);

2919 ià(
»s
 != 0) {

2920 
	`PRINT_ERROR
("Cª'ˆaddgˆ% tØsysfs", 
tgt
->
tgt_Çme
);

2921 
out
;

2924 ià((
tgt
->
tg‰
->
’abË_rg‘
 !ð
NULL
) &&

2925 (
tgt
->
tg‰
->
is_rg‘_’abËd
 !ð
NULL
)) {

2926 
»s
 = 
	`sysfs_ü—‹_fže
(&
tgt
->
tgt_kobj
,

2927 &
tgt_’abË_©Œ
.
©Œ
);

2928 ià(
»s
 != 0) {

2929 
	`PRINT_ERROR
("Can't‡dd‡ttr %so sysfs",

2930 
tgt_’abË_©Œ
.
©Œ
.
Çme
);

2931 
out_”r
;

2935 
tgt
->
tgt_£ss_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("£ssiÚs", &tgt->
tgt_kobj
);

2936 ià(
tgt
->
tgt_£ss_kobj
 =ð
NULL
) {

2937 
	`PRINT_ERROR
("Cª'ˆü—‹ ses kobj fÜgˆ%s", 
tgt
->
tgt_Çme
);

2938 
out_nomem
;

2941 
tgt
->
tgt_luns_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("luns", &tgt->
tgt_kobj
);

2942 ià(
tgt
->
tgt_luns_kobj
 =ð
NULL
) {

2943 
	`PRINT_ERROR
("Cª'ˆü—‹†un kobj fÜgˆ%s", 
tgt
->
tgt_Çme
);

2944 
out_nomem
;

2947 
»s
 = 
	`sysfs_ü—‹_fže
(
tgt
->
tgt_luns_kobj
, &
sc¡_luns_mgmt
.
©Œ
);

2948 ià(
»s
 != 0) {

2949 
	`PRINT_ERROR
("Can't‡dd‡ttribute %s forgt %s",

2950 
sc¡_luns_mgmt
.
©Œ
.
Çme
, 
tgt
->
tgt_Çme
);

2951 
out_”r
;

2954 
tgt
->
tgt_ši_g½_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("ini_groups",

2955 &
tgt
->
tgt_kobj
);

2956 ià(
tgt
->
tgt_ši_g½_kobj
 =ð
NULL
) {

2957 
	`PRINT_ERROR
("Can't create ini_grp kobj forgt %s",

2958 
tgt
->
tgt_Çme
);

2959 
out_nomem
;

2962 
»s
 = 
	`sysfs_ü—‹_fže
(
tgt
->
tgt_ši_g½_kobj
,

2963 &
sc¡_ši_group_mgmt
.
©Œ
);

2964 ià(
»s
 != 0) {

2965 
	`PRINT_ERROR
("Can't‡dd‡ttribute %s forgt %s",

2966 
sc¡_ši_group_mgmt
.
©Œ
.
Çme
, 
tgt
->
tgt_Çme
);

2967 
out_”r
;

2970 ià(
tgt
->
tgt_dif_suµÜ‹d
) {

2971 
»s
 = 
	`sysfs_ü—‹_fže
(&
tgt
->
tgt_kobj
,

2972 &
sc¡_tgt_dif_ÿ·bË_©Œ
.
©Œ
);

2973 ià(
»s
 != 0) {

2974 
	`PRINT_ERROR
("Can't‡dd‡ttribute %s forgt %s",

2975 
sc¡_tgt_dif_ÿ·bË_©Œ
.
©Œ
.
Çme
,

2976 
tgt
->
tgt_Çme
);

2977 
out_”r
;

2980 
»s
 = 
	`sysfs_ü—‹_fže
(&
tgt
->
tgt_kobj
,

2981 &
sc¡_tgt_dif_checks_çžed_©Œ
.
©Œ
);

2982 ià(
»s
 != 0) {

2983 
	`PRINT_ERROR
("Can't‡dd‡ttribute %s forgt %s",

2984 
sc¡_tgt_dif_checks_çžed_©Œ
.
©Œ
.
Çme
,

2985 
tgt
->
tgt_Çme
);

2986 
out_”r
;

2990 ià(
tgt
->
tg‰
->
tgt_©Œs
) {

2991 
»s
 = 
	`sysfs_ü—‹_fžes
(&
tgt
->
tgt_kobj
,gt->
tg‰
->
tgt_©Œs
);

2992 ià(
»s
 != 0) {

2993 
	`PRINT_ERROR
("Can't‡dd‡ttributes forgt %s",

2994 
tgt
->
tgt_Çme
);

2995 
out_”r
;

2999 
out
:

3000 
	`TRACE_EXIT_RES
(
»s
);

3001  
»s
;

3003 
out_nomem
:

3004 
»s
 = -
ENOMEM
;

3006 
out_”r
:

3007 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

3008 
	`sc¡_tgt_sysfs_d–
(
tgt
);

3009 
	`mu‹x_lock
(&
sc¡_mu‹x
);

3010 
out
;

3011 
	}
}

3018 
	$sc¡_tgt_sysfs_d–
(
sc¡_tgt
 *
tgt
)

3020 
	`TRACE_ENTRY
();

3022 
	`kobjeù_d–
(
tgt
->
tgt_£ss_kobj
);

3023 
	`kobjeù_d–
(
tgt
->
tgt_luns_kobj
);

3024 
	`kobjeù_d–
(
tgt
->
tgt_ši_g½_kobj
);

3025 
	`kobjeù_d–
(&
tgt
->
tgt_kobj
);

3027 
	`kobjeù_put
(
tgt
->
tgt_£ss_kobj
);

3028 
	`kobjeù_put
(
tgt
->
tgt_luns_kobj
);

3029 
	`kobjeù_put
(
tgt
->
tgt_ši_g½_kobj
);

3031 
	`TRACE_EXIT
();

3033 
	}
}

3035 
	$sc¡_tgt_sysfs_put
(
sc¡_tgt
 *
tgt
)

3037 
	`DECLARE_COMPLETION_ONSTACK
(
c
);

3039 
	`TRACE_ENTRY
();

3041 
tgt
->
tgt_kobj_»Ëa£_cm¶
 = &
c
;

3043 
	`SCST_KOBJECT_PUT_AND_WAIT
(&
tgt
->
tgt_kobj
, "rg‘", &
c
,

3044 &
sc¡_tgt_d•_m­
);

3046 
	`TRACE_EXIT
();

3048 
	}
}

3054 
ssize_t
 
	$sc¡_dev_sysfs_ty³_show
(
kobjeù
 *
kobj
,

3055 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

3057 
pos
 = 0;

3059 
sc¡_deviû
 *
dev
;

3061 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

3063 
pos
 = 
	`sú´štf
(
buf
, 
SCST_SYSFS_BLOCK_SIZE
, "%d - %s\n", 
dev
->
ty³
,

3064 ()
dev
->
ty³
 >ð
	`ARRAY_SIZE
(
sc¡_dev_hªdËr_ty³s
) ?

3065 "unknown" : 
sc¡_dev_hªdËr_ty³s
[
dev
->
ty³
]);

3067  
pos
;

3068 
	}
}

3070 
kobj_©Œibu‹
 
	gdev_ty³_©Œ
 =

3071 
__ATTR
(
ty³
, 
S_IRUGO
, 
sc¡_dev_sysfs_ty³_show
, 
NULL
);

3073 
ssize_t
 
	$sc¡_dev_sysfs_´_fže_Çme_show
(
kobjeù
 *
kobj
,

3074 
kobj_©Œibu‹
 *
©Œ
,

3075 *
buf
)

3077 
sc¡_deviû
 *
dev
;

3078 
»s
;

3080 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

3082 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
dev
->
dev_´_mu‹x
);

3083 ià(
»s
 != 0)

3084 
out
;

3086 
	`WARN_ON_ONCE
(!
dev
->
´_fže_Çme
);

3087 
»s
 = 
	`sú´štf
(
buf
, 
PAGE_SIZE
, "%s\n%s", 
dev
->
´_fže_Çme
 ? : "",

3088 
dev
->
´_fže_Çme_is_£t
 ? 
SCST_SYSFS_KEY_MARK
 "\n" :

3090 
	`mu‹x_uÆock
(&
dev
->
dev_´_mu‹x
);

3092 
out
:

3093  
»s
;

3094 
	}
}

3097 
	$sc¡_dev_sysfs_´_fže_Çme_´oûss_¡Üe
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

3099 
sc¡_deviû
 *
dev
 = 
wÜk
->dev;

3100 *
´_fže_Çme
 = 
wÜk
->
buf
, *
´ev
 = 
NULL
;

3101 
»s
;

3103 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

3104 ià(
»s
 != 0)

3105 
out
;

3107 
»s
 = -
EBUSY
;

3108 ià(
	`sc¡_deviû_is_expÜ‹d
(
dev
)) {

3109 
	`PRINT_ERROR
("%s:‚ot changing…r_file_name becausehe device"

3110 " ha ®»ady b“ÀexpÜ‹d", 
dev
->
vœt_Çme
);

3111 
uÆock_sc¡
;

3114 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
dev
->
dev_´_mu‹x
);

3115 ià(
»s
)

3116 
uÆock_sc¡
;

3118 ià(
	`¡rcmp
(
dev
->
´_fže_Çme
,…r_file_name) == 0)

3119 
uÆock_dev_´
;

3121 
»s
 = 
	`sc¡_´_£t_fže_Çme
(
dev
, &
´ev
, "%s", 
´_fže_Çme
);

3122 ià(
»s
 != 0)

3123 
uÆock_dev_´
;

3125 
»s
 = 
	`sc¡_´_š™_dev
(
dev
);

3126 ià(
»s
 != 0) {

3127 
	`PRINT_ERROR
("%s:†oading PR from %s failed (%d) -„estoring %s",

3128 
dev
->
vœt_Çme
, dev->
´_fže_Çme
, 
»s
,

3129 
´ev
 ? : "");

3130 
	`sc¡_´_£t_fže_Çme
(
dev
, 
NULL
, "%s", 
´ev
);

3131 
	`sc¡_´_š™_dev
(
dev
);

3132 
uÆock_dev_´
;

3135 
dev
->
´_fže_Çme_is_£t
 = !
wÜk
->
deçuÉ_v®
;

3137 
uÆock_dev_´
:

3138 
	`mu‹x_uÆock
(&
dev
->
dev_´_mu‹x
);

3140 
uÆock_sc¡
:

3141 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

3143 
out
:

3144 
	`kobjeù_put
(&
dev
->
dev_kobj
);

3145 
	`kä“
(
´ev
);

3147  
»s
;

3148 
	}
}

3150 
ssize_t
 
	$sc¡_dev_sysfs_´_fže_Çme_¡Üe
(
kobjeù
 *
kobj
,

3151 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

3153 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

3154 
sc¡_deviû
 *
dev
;

3155 *
´_fže_Çme
 = 
NULL
, *
p
;

3156 
»s
 = -
EPERM
;

3157 
boÞ
 
def
 = 
çl£
;

3159 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

3161 ià(
dev
->
þu¡”_mode
)

3162 
out
;

3164 
»s
 = -
ENOMEM
;

3165 
´_fže_Çme
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%.*s", ()
couÁ
, 
buf
);

3166 ià(!
´_fže_Çme
) {

3167 
	`PRINT_ERROR
("Unableo kasprintf() PR file‚ame");

3168 
out
;

3170 
p
 = 
´_fže_Çme
;

3171 
	`¡r£p
(&
p
, "\n");

3172 ià(
´_fže_Çme
[0] == '\0') {

3173 
	`kä“
(
´_fže_Çme
);

3174 
´_fže_Çme
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%s/%s", 
SCST_PR_DIR
,

3175 
dev
->
vœt_Çme
);

3176 ià(!
´_fže_Çme
) {

3177 
	`PRINT_ERROR
("Unableo kasprintf() PR file‚ame");

3178 
out
;

3180 
def
 = 
Œue
;

3183 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_dev_sysfs_´_fže_Çme_´oûss_¡Üe
,

3184 
çl£
, &
wÜk
);

3185 ià(
»s
 != 0)

3186 
out
;

3187 
	`kobjeù_g‘
(&
dev
->
dev_kobj
);

3188 
wÜk
->
dev
 = dev;

3189 
wÜk
->
deçuÉ_v®
 = 
def
;

3190 
	`sw­
(
wÜk
->
buf
, 
´_fže_Çme
);

3192 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

3193 ià(
»s
 == 0)

3194 
»s
 = 
couÁ
;

3196 
out
:

3197 
	`kä“
(
´_fže_Çme
);

3198  
»s
;

3199 
	}
}

3201 
kobj_©Œibu‹
 
	gdev_´_fže_Çme_©Œ
 =

3202 
__ATTR
(
´_fže_Çme
, 
S_IWUSR
|
S_IRUGO
,

3203 
sc¡_dev_sysfs_´_fže_Çme_show
,

3204 
sc¡_dev_sysfs_´_fže_Çme_¡Üe
);

3206 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

3208 
ssize_t
 
	$sc¡_dev_sysfs_dump_´s
(
kobjeù
 *
kobj
,

3209 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

3211 
sc¡_deviû
 *
dev
;

3212 
»s
;

3214 
	`TRACE_ENTRY
();

3216 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

3218 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
dev
->
dev_´_mu‹x
);

3219 ià(
»s
 != 0)

3220 
out
;

3221 
	`sc¡_´_dump_´s
(
dev
, 
Œue
);

3222 
	`mu‹x_uÆock
(&
dev
->
dev_´_mu‹x
);

3224 
»s
 = 
couÁ
;

3226 
out
:

3227 
	`TRACE_EXIT_RES
(
»s
);

3228  
»s
;

3229 
	}
}

3231 
kobj_©Œibu‹
 
	gdev_dump_´s_©Œ
 =

3232 
__ATTR
(
dump_´s
, 
S_IWUSR
, 
NULL
, 
sc¡_dev_sysfs_dump_´s
);

3236 
	$sc¡_´oûss_dev_sysfs_th»ads_d©a_¡Üe
(

3237 
sc¡_deviû
 *
dev
, 
th»ads_num
,

3238 
sc¡_dev_ty³_th»ads_poÞ_ty³
 
th»ads_poÞ_ty³
)

3240 
»s
 = 0;

3241 
ÞdŠ
 = 
dev
->
th»ads_num
;

3242 
sc¡_dev_ty³_th»ads_poÞ_ty³
 
Þd‰
 = 
dev
->
th»ads_poÞ_ty³
;

3244 
	`TRACE_ENTRY
();

3246 
	`TRACE_DBG
("dev %p,h»ads_num %d,h»ads_poÞ_ty³ %d", 
dev
,

3247 
th»ads_num
, 
th»ads_poÞ_ty³
);

3249 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
SCST_SUSPEND_TIMEOUT_USER
);

3250 ià(
»s
 != 0)

3251 
out
;

3253 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

3254 ià(
»s
 != 0)

3255 
out_»sume
;

3258 ià(
	`sc¡_check_dev_±r
(
dev
) != 0)

3259 
out_uÆock
;

3261 
	`sc¡_¡Ý_dev_th»ads
(
dev
);

3263 
dev
->
th»ads_num
 =hreads_num;

3264 
dev
->
th»ads_poÞ_ty³
 =hreads_pool_type;

3266 
»s
 = 
	`sc¡_ü—‹_dev_th»ads
(
dev
);

3267 ià(
»s
 != 0)

3268 
out_uÆock
;

3270 ià(
ÞdŠ
 !ð
dev
->
th»ads_num
)

3271 
	`PRINT_INFO
("Chªged cmdh»ad numØ%d", 
dev
->
th»ads_num
);

3272 ià(
Þd‰
 !ð
dev
->
th»ads_poÞ_ty³
)

3273 
	`PRINT_INFO
("Changed cmdhreads…oolypeo %d",

3274 
dev
->
th»ads_poÞ_ty³
);

3276 
out_uÆock
:

3277 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

3279 
out_»sume
:

3280 
	`sc¡_»sume_aùiv™y
();

3282 
out
:

3283 
	`TRACE_EXIT_RES
(
»s
);

3284  
»s
;

3285 
	}
}

3287 
	$sc¡_dev_sysfs_th»ads_d©a_¡Üe_wÜk_â
(

3288 
sc¡_sysfs_wÜk_™em
 *
wÜk
)

3290  
	`sc¡_´oûss_dev_sysfs_th»ads_d©a_¡Üe
(
wÜk
->
dev
,

3291 
wÜk
->
Ãw_th»ads_num
, wÜk->
Ãw_th»ads_poÞ_ty³
);

3292 
	}
}

3294 
ssize_t
 
	$sc¡_dev_sysfs_check_th»ads_d©a
(

3295 
sc¡_deviû
 *
dev
, 
th»ads_num
,

3296 
sc¡_dev_ty³_th»ads_poÞ_ty³
 
th»ads_poÞ_ty³
, 
boÞ
 *
¡Ý
)

3298 
»s
 = 0;

3300 
	`TRACE_ENTRY
();

3302 *
¡Ý
 = 
çl£
;

3304 ià(
dev
->
th»ads_num
 < 0) {

3305 
	`PRINT_ERROR
("Threads…ool disabled for device %s",

3306 
dev
->
vœt_Çme
);

3307 
»s
 = -
EPERM
;

3308 
out
;

3311 ià((
th»ads_num
 =ð
dev
->threads_num) &&

3312 (
th»ads_poÞ_ty³
 =ð
dev
->threads_pool_type)) {

3313 *
¡Ý
 = 
Œue
;

3314 
out
;

3317 
out
:

3318 
	`TRACE_EXIT_RES
(
»s
);

3319  
»s
;

3320 
	}
}

3322 
ssize_t
 
	$sc¡_dev_sysfs_th»ads_num_show
(
kobjeù
 *
kobj
,

3323 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

3325 
pos
 = 0;

3326 
sc¡_deviû
 *
dev
;

3328 
	`TRACE_ENTRY
();

3330 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

3332 
pos
 = 
	`¥rštf
(
buf
, "%d\n%s", 
dev
->
th»ads_num
,

3333 (
dev
->
th»ads_num
 !ðdev->
hªdËr
->threads_num) ?

3334 
SCST_SYSFS_KEY_MARK
 "\n" : "");

3336 
	`TRACE_EXIT_RES
(
pos
);

3337  
pos
;

3338 
	}
}

3340 
ssize_t
 
	$sc¡_dev_sysfs_th»ads_num_¡Üe
(
kobjeù
 *
kobj
,

3341 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

3343 
»s
;

3344 
sc¡_deviû
 *
dev
;

3345 
ÃwŠ
;

3346 
boÞ
 
¡Ý
;

3347 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

3349 
	`TRACE_ENTRY
();

3351 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

3353 
»s
 = 
	`k¡¹Þ
(
buf
, 0, &
ÃwŠ
);

3354 ià(
»s
 != 0) {

3355 
	`PRINT_ERROR
("k¡¹Þ(èfÜ % çžed: %d ", 
buf
, 
»s
);

3356 
out
;

3358 ià(
ÃwŠ
 < 0) {

3359 
	`PRINT_ERROR
("IÎeg®h»ad num v®u%ld", 
ÃwŠ
);

3360 
»s
 = -
EINVAL
;

3361 
out
;

3364 
»s
 = 
	`sc¡_dev_sysfs_check_th»ads_d©a
(
dev
, 
ÃwŠ
,

3365 
dev
->
th»ads_poÞ_ty³
, &
¡Ý
);

3366 ià((
»s
 !ð0è|| 
¡Ý
)

3367 
out
;

3369 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_dev_sysfs_th»ads_d©a_¡Üe_wÜk_â
,

3370 
çl£
, &
wÜk
);

3371 ià(
»s
 != 0)

3372 
out
;

3374 
wÜk
->
dev
 = dev;

3375 
wÜk
->
Ãw_th»ads_num
 = 
ÃwŠ
;

3376 
wÜk
->
Ãw_th»ads_poÞ_ty³
 = 
dev
->
th»ads_poÞ_ty³
;

3378 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

3380 
out
:

3381 ià(
»s
 == 0)

3382 
»s
 = 
couÁ
;

3384 
	`TRACE_EXIT_RES
(
»s
);

3385  
»s
;

3386 
	}
}

3388 
kobj_©Œibu‹
 
	gdev_th»ads_num_©Œ
 =

3389 
__ATTR
(
th»ads_num
, 
S_IRUGO
 | 
S_IWUSR
,

3390 
sc¡_dev_sysfs_th»ads_num_show
,

3391 
sc¡_dev_sysfs_th»ads_num_¡Üe
);

3393 
ssize_t
 
	$sc¡_dev_sysfs_th»ads_poÞ_ty³_show
(
kobjeù
 *
kobj
,

3394 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

3396 
pos
 = 0;

3397 
sc¡_deviû
 *
dev
;

3399 
	`TRACE_ENTRY
();

3401 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

3403 ià(
dev
->
th»ads_num
 == 0) {

3404 
pos
 = 
	`¥rštf
(
buf
, "Async\n");

3405 
out
;

3406 } ià(
dev
->
th»ads_num
 < 0) {

3407 
pos
 = 
	`¥rštf
(
buf
, "Not valid\n");

3408 
out
;

3411 
dev
->
th»ads_poÞ_ty³
) {

3412 
SCST_THREADS_POOL_PER_INITIATOR
:

3413 
pos
 = 
	`¥rštf
(
buf
, "%s\n%s", 
SCST_THREADS_POOL_PER_INITIATOR_STR
,

3414 (
dev
->
th»ads_poÞ_ty³
 !ðdev->
hªdËr
->threads_pool_type) ?

3415 
SCST_SYSFS_KEY_MARK
 "\n" : "");

3417 
SCST_THREADS_POOL_SHARED
:

3418 
pos
 = 
	`¥rštf
(
buf
, "%s\n%s", 
SCST_THREADS_POOL_SHARED_STR
,

3419 (
dev
->
th»ads_poÞ_ty³
 !ðdev->
hªdËr
->threads_pool_type) ?

3420 
SCST_SYSFS_KEY_MARK
 "\n" : "");

3423 
pos
 = 
	`¥rštf
(
buf
, "Unknown\n");

3427 
out
:

3428 
	`TRACE_EXIT_RES
(
pos
);

3429  
pos
;

3430 
	}
}

3432 
ssize_t
 
	$sc¡_dev_sysfs_th»ads_poÞ_ty³_¡Üe
(
kobjeù
 *
kobj
,

3433 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

3435 
»s
;

3436 
sc¡_deviû
 *
dev
;

3437 
sc¡_dev_ty³_th»ads_poÞ_ty³
 
Ãwt
;

3438 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

3439 
boÞ
 
¡Ý
;

3441 
	`TRACE_ENTRY
();

3443 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

3445 
Ãwt
 = 
	`sc¡_·r£_th»ads_poÞ_ty³
(
buf
, 
couÁ
);

3446 ià(
Ãwt
 =ð
SCST_THREADS_POOL_TYPE_INVALID
) {

3447 
	`PRINT_ERROR
("IÎeg®h»ad poÞy³ %s", 
buf
);

3448 
»s
 = -
EINVAL
;

3449 
out
;

3452 
	`TRACE_DBG
("buà%s, couÁ %zd,‚ewˆ%d", 
buf
, 
couÁ
, 
Ãwt
);

3454 
»s
 = 
	`sc¡_dev_sysfs_check_th»ads_d©a
(
dev
, dev->
th»ads_num
,

3455 
Ãwt
, &
¡Ý
);

3456 ià((
»s
 !ð0è|| 
¡Ý
)

3457 
out
;

3459 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_dev_sysfs_th»ads_d©a_¡Üe_wÜk_â
,

3460 
çl£
, &
wÜk
);

3461 ià(
»s
 != 0)

3462 
out
;

3464 
wÜk
->
dev
 = dev;

3465 
wÜk
->
Ãw_th»ads_num
 = 
dev
->
th»ads_num
;

3466 
wÜk
->
Ãw_th»ads_poÞ_ty³
 = 
Ãwt
;

3468 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

3470 
out
:

3471 ià(
»s
 == 0)

3472 
»s
 = 
couÁ
;

3474 
	`TRACE_EXIT_RES
(
»s
);

3475  
»s
;

3476 
	}
}

3478 
kobj_©Œibu‹
 
	gdev_th»ads_poÞ_ty³_©Œ
 =

3479 
__ATTR
(
th»ads_poÞ_ty³
, 
S_IRUGO
 | 
S_IWUSR
,

3480 
sc¡_dev_sysfs_th»ads_poÞ_ty³_show
,

3481 
sc¡_dev_sysfs_th»ads_poÞ_ty³_¡Üe
);

3483 
ssize_t
 
	$sc¡_dev_block_show
(
kobjeù
 *
kobj
,

3484 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

3486 
pos
 = 0;

3487 
sc¡_deviû
 *
dev
;

3489 
	`TRACE_ENTRY
();

3491 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

3493 
pos
 = 
	`¥rštf
(
buf
, "%d %d\n", 
	`ACCESS_ONCE
(
dev
->
ext_blocks_út
),

3494 
dev
->
ext_blockšg_³ndšg
);

3496 
	`TRACE_EXIT_RES
(
pos
);

3497  
pos
;

3498 
	}
}

3500 
	$sc¡_sysfs_ext_blockšg_dÚe
(
sc¡_deviû
 *
dev
,

3501 
ušt8_t
 *
d©a
, 
Ën
)

3503 
	`sc¡_ev’t_queue_ext_blockšg_dÚe
(
dev
, 
d©a
, 
Ën
);

3504 
	}
}

3506 
ssize_t
 
	$sc¡_dev_block_¡Üe
(
kobjeù
 *
kobj
,

3507 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

3509 
»s
, 
d©a_Ën
 = 0, 
pos
 = 0;

3510 
sc¡_deviû
 *
dev
;

3511 cÚ¡ *
p
 = 
buf
, *
d©a_¡¬t
 = 
NULL
;

3512 
boÞ
 
sync
;

3514 
	`TRACE_ENTRY
();

3516 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

3518 *
p
) {

3520 
p
++;

3521 
pos
++;

3522 (
pos
 < 
couÁ
è&& 
	`is¥aû
(*
p
) && (*p != '\0')) {

3523 
p
++;

3524 
pos
++;

3526 ià((
pos
 !ð
couÁ
è&& (*
p
 != '\0')) {

3527 
	`PRINT_ERROR
("P¬£ƒ¼Ü oÀ%c", *
p
);

3528 
»s
 = -
EINVAL
;

3529 
out
;

3532 
	`TRACE_MGMT_DBG
("Sysf unblockšg (dev %s)", 
dev
->
vœt_Çme
);

3534 
	`sc¡_ext_unblock_dev
(
dev
, 
çl£
);

3535 
»s
 = 0;

3536 
out
;

3538 
p
++;

3539 
pos
++;

3540 (
pos
 < 
couÁ
è&& 
	`is¥aû
(*
p
) && (*p != '\0')) {

3541 
p
++;

3542 
pos
++;

3544 ià((
pos
 =ð
couÁ
è|| (*
p
 == '\0')) {

3545 
d©a_Ën
 = (*);

3546 
sync
 = 
Œue
;

3548 } ià(*
p
 != '1') {

3549 
	`PRINT_ERROR
("P¬£ƒ¼Ü oÀ%c", *
p
);

3550 
»s
 = -
EINVAL
;

3551 
out
;

3554 
sync
 = 
çl£
;

3556 
p
++;

3557 
pos
++;

3558 ià((
pos
 =ð
couÁ
è|| (*
p
 == '\0'))

3561 (
pos
 < 
couÁ
è&& 
	`is¥aû
(*
p
) && (*p != '\0')) {

3562 
p
++;

3563 
pos
++;

3565 ià((
pos
 =ð
couÁ
è|| (*
p
 == '\0'))

3568 
d©a_¡¬t
 = 
p
;

3569 (
pos
 < 
couÁ
è&& (*
p
 != '\0')) {

3570 
p
++;

3571 
pos
++;

3572 
d©a_Ën
++;

3575 
	`is¥aû
(*(
p
-1))) {

3576 
p
--;

3577 
d©a_Ën
--;

3581 
	`PRINT_ERROR
("IÎeg® blockšg v®u%c", *
p
);

3582 
»s
 = -
EINVAL
;

3583 
out
;

3586 
	`TRACE_MGMT_DBG
("Sysfs blocking dev %s (sync %d, data_start %p, "

3587 "d©a_ËÀ%d)", 
dev
->
vœt_Çme
, 
sync
, 
d©a_¡¬t
, 
d©a_Ën
);

3589 ià(
sync
)

3590 
»s
 = 
	`sc¡_ext_block_dev
(
dev
, 
NULL
, NULL, 0, 
SCST_EXT_BLOCK_SYNC
);

3592 
»s
 = 
	`sc¡_ext_block_dev
(
dev
, 
sc¡_sysfs_ext_blockšg_dÚe
,

3593 
d©a_¡¬t
, 
d©a_Ën
, 0);

3594 ià(
»s
 != 0)

3595 
out
;

3597 
»s
 = 0;

3599 
out
:

3600 ià(
»s
 == 0)

3601 
»s
 = 
couÁ
;

3603 
	`TRACE_EXIT_RES
(
»s
);

3604  
»s
;

3605 
	}
}

3607 
kobj_©Œibu‹
 
	gdev_block_©Œ
 =

3608 
__ATTR
(
block
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_dev_block_show
,

3609 
sc¡_dev_block_¡Üe
);

3611 
©Œibu‹
 *
	gsc¡_dev_©Œs
[] = {

3612 &
dev_ty³_©Œ
.
©Œ
,

3613 &
dev_block_©Œ
.
©Œ
,

3614 
NULL
,

3617 
	$sc¡_sysfs_dev_»Ëa£
(
kobjeù
 *
kobj
)

3619 
sc¡_deviû
 *
dev
;

3621 
	`TRACE_ENTRY
();

3623 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

3624 ià(
dev
->
dev_kobj_»Ëa£_cm¶
)

3625 
	`com¶‘e_®l
(
dev
->
dev_kobj_»Ëa£_cm¶
);

3627 
	`TRACE_EXIT
();

3629 
	}
}

3635 
	$sc¡_ü—‹_dev_©Œ
(
sc¡_deviû
 *
dev
,

3636 
kobj_©Œibu‹
 *
©Œibu‹
)

3638 
»s
;

3640 
»s
 = 
	`sysfs_ü—‹_fže
(&
dev
->
dev_kobj
, &
©Œibu‹
->
©Œ
);

3641 ià(
»s
 != 0) {

3642 
	`PRINT_ERROR
("Can't‡dd‡ttribute %s for dev %s",

3643 
©Œibu‹
->
©Œ
.
Çme
, 
dev
->
vœt_Çme
);

3644 
out
;

3647 
out
:

3648  
»s
;

3649 
	}
}

3650 
EXPORT_SYMBOL
(
sc¡_ü—‹_dev_©Œ
);

3652 
	$sc¡_devt_dev_sysfs_ü—‹
(
sc¡_deviû
 *
dev
)

3654 
»s
 = 0;

3656 
	`TRACE_ENTRY
();

3658 ià(
dev
->
hªdËr
 =ð&
sc¡_nuÎ_devty³
)

3659 
out
;

3661 
»s
 = 
	`sysfs_ü—‹_lšk
(&
dev
->
dev_kobj
,

3662 &
dev
->
hªdËr
->
devt_kobj
, "handler");

3663 ià(
»s
 != 0) {

3664 
	`PRINT_ERROR
("Can't create handler†ink for dev %s",

3665 
dev
->
vœt_Çme
);

3666 
out
;

3669 
»s
 = 
	`sysfs_ü—‹_lšk
(&
dev
->
hªdËr
->
devt_kobj
,

3670 &
dev
->
dev_kobj
, dev->
vœt_Çme
);

3671 ià(
»s
 != 0) {

3672 
	`PRINT_ERROR
("Can't create handler†ink for dev %s",

3673 
dev
->
vœt_Çme
);

3674 
out_”r
;

3677 ià(
dev
->
hªdËr
->
th»ads_num
 >= 0) {

3678 
»s
 = 
	`sysfs_ü—‹_fže
(&
dev
->
dev_kobj
,

3679 &
dev_th»ads_num_©Œ
.
©Œ
);

3680 ià(
»s
 != 0) {

3681 
	`PRINT_ERROR
("Can't‡dd dev‡ttr %s for dev %s",

3682 
dev_th»ads_num_©Œ
.
©Œ
.
Çme
,

3683 
dev
->
vœt_Çme
);

3684 
out_”r
;

3686 
»s
 = 
	`sysfs_ü—‹_fže
(&
dev
->
dev_kobj
,

3687 &
dev_th»ads_poÞ_ty³_©Œ
.
©Œ
);

3688 ià(
»s
 != 0) {

3689 
	`PRINT_ERROR
("Can't‡dd dev‡ttr %s for dev %s",

3690 
dev_th»ads_poÞ_ty³_©Œ
.
©Œ
.
Çme
,

3691 
dev
->
vœt_Çme
);

3692 
out_”r
;

3696 ià(
dev
->
hªdËr
->
dev_©Œs
) {

3697 
»s
 = 
	`sysfs_ü—‹_fžes
(&
dev
->
dev_kobj
,

3698 
dev
->
hªdËr
->
dev_©Œs
);

3699 ià(
»s
 != 0) {

3700 
	`PRINT_ERROR
("Can't‡dd dev‡ttributes for dev %s",

3701 
dev
->
vœt_Çme
);

3702 
out_”r
;

3706 
out
:

3707 
	`TRACE_EXIT_RES
(
»s
);

3708  
»s
;

3710 
out_”r
:

3711 
	`sc¡_devt_dev_sysfs_d–
(
dev
);

3712 
out
;

3713 
	}
}

3715 
	$sc¡_devt_dev_sysfs_d–
(
sc¡_deviû
 *
dev
)

3717 
	`TRACE_ENTRY
();

3719 ià(
dev
->
hªdËr
 =ð&
sc¡_nuÎ_devty³
)

3720 
out
;

3722 ià(
dev
->
hªdËr
->
dev_©Œs
)

3723 
	`sysfs_»move_fžes
(&
dev
->
dev_kobj
, dev->
hªdËr
->
dev_©Œs
);

3725 
	`sysfs_»move_lšk
(&
dev
->
dev_kobj
, "handler");

3726 
	`sysfs_»move_lšk
(&
dev
->
hªdËr
->
devt_kobj
, dev->
vœt_Çme
);

3728 ià(
dev
->
hªdËr
->
th»ads_num
 >= 0) {

3729 
	`sysfs_»move_fže
(&
dev
->
dev_kobj
,

3730 &
dev_th»ads_num_©Œ
.
©Œ
);

3731 
	`sysfs_»move_fže
(&
dev
->
dev_kobj
,

3732 &
dev_th»ads_poÞ_ty³_©Œ
.
©Œ
);

3735 
out
:

3736 
	`TRACE_EXIT
();

3738 
	}
}

3740 
kobj_ty³
 
	gsc¡_dev_kty³
 = {

3741 .
sysfs_Ýs
 = &
sc¡_sysfs_Ýs
,

3742 .
	g»Ëa£
 = 
sc¡_sysfs_dev_»Ëa£
,

3743 .
	gdeçuÉ_©Œs
 = 
sc¡_dev_©Œs
,

3750 
	$sc¡_dev_sysfs_ü—‹
(
sc¡_deviû
 *
dev
)

3752 
»s
 = 0;

3754 
	`TRACE_ENTRY
();

3756 
»s
 = 
	`kobjeù_š™_ªd_add
(&
dev
->
dev_kobj
, &
sc¡_dev_kty³
,

3757 
sc¡_deviûs_kobj
, 
dev
->
vœt_Çme
);

3758 ià(
»s
 != 0) {

3759 
	`PRINT_ERROR
("Cª'ˆadd deviû % tØsysfs", 
dev
->
vœt_Çme
);

3760 
out
;

3763 
dev
->
dev_exp_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("exported",

3764 &
dev
->
dev_kobj
);

3765 ià(
dev
->
dev_exp_kobj
 =ð
NULL
) {

3766 
	`PRINT_ERROR
("Can't createƒxported†ink for device %s",

3767 
dev
->
vœt_Çme
);

3768 
»s
 = -
ENOMEM
;

3769 
out_d–
;

3772 ià(
dev
->
scsi_dev
 !ð
NULL
) {

3773 
»s
 = 
	`sysfs_ü—‹_lšk
(&
dev
->
dev_kobj
,

3774 &
dev
->
scsi_dev
->
sdev_dev
.
kobj
, "scsi_device");

3775 ià(
»s
 != 0) {

3776 
	`PRINT_ERROR
("Can't create scsi_device†ink for dev %s",

3777 
dev
->
vœt_Çme
);

3778 
out_d–
;

3781 
»s
 = 
	`sysfs_ü—‹_fže
(&
dev
->
dev_kobj
,

3782 &
dev_´_fže_Çme_©Œ
.
©Œ
);

3783 ià(
»s
 != 0) {

3784 
	`PRINT_ERROR
("Can't create‡ttr %s for dev %s",

3785 
dev_´_fže_Çme_©Œ
.
©Œ
.
Çme
,

3786 
dev
->
vœt_Çme
);

3787 
out_d–
;

3791 #ià
	`defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

3792 ià(
dev
->
scsi_dev
 =ð
NULL
) {

3793 
»s
 = 
	`sysfs_ü—‹_fže
(&
dev
->
dev_kobj
,

3794 &
dev_dump_´s_©Œ
.
©Œ
);

3795 ià(
»s
 != 0) {

3796 
	`PRINT_ERROR
("Can't create‡ttr %s for dev %s",

3797 
dev_dump_´s_©Œ
.
©Œ
.
Çme
, 
dev
->
vœt_Çme
);

3798 
out_d–
;

3803 
out
:

3804 
	`TRACE_EXIT_RES
(
»s
);

3805  
»s
;

3807 
out_d–
:

3808 
	`sc¡_dev_sysfs_d–
(
dev
);

3809 
out
;

3810 
	}
}

3817 
	$sc¡_dev_sysfs_d–
(
sc¡_deviû
 *
dev
)

3819 
	`DECLARE_COMPLETION_ONSTACK
(
c
);

3821 
	`TRACE_ENTRY
();

3823 
dev
->
dev_kobj_»Ëa£_cm¶
 = &
c
;

3825 
	`kobjeù_d–
(
dev
->
dev_exp_kobj
);

3826 
	`kobjeù_d–
(&
dev
->
dev_kobj
);

3828 
	`kobjeù_put
(
dev
->
dev_exp_kobj
);

3830 
	`SCST_KOBJECT_PUT_AND_WAIT
(&
dev
->
dev_kobj
, "deviû", &
c
,

3831 &
sc¡_dev_d•_m­
);

3833 
	`TRACE_EXIT
();

3835 
	}
}

3837 
ssize_t
 
	$sc¡_dev_dif_mode_show
(
kobjeù
 *
kobj
,

3838 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

3840 
pos
 = 0;

3841 
sc¡_deviû
 *
dev
;

3843 
	`TRACE_ENTRY
();

3845 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

3847 ià(
dev
->
dev_dif_mode
 =ð
SCST_DIF_MODE_NONE
)

3848 
pos
 = 
	`¥rštf
(
buf
, "None\n");

3850 
j
 = 
pos
;

3852 ià(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_TGT
)

3853 
pos
 +ð
	`sú´štf
(&
buf
[pos], 
SCST_SYSFS_BLOCK_SIZE
 -…os,

3854 "%s%s", (
j
 =ð
pos
è? "" : "|", 
SCST_DIF_MODE_TGT_STR
);

3856 ià(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_SCST
)

3857 
pos
 +ð
	`sú´štf
(&
buf
[pos], 
SCST_SYSFS_BLOCK_SIZE
 -…os,

3858 "%s%s", (
j
 =ð
pos
è? "" : "|", 
SCST_DIF_MODE_SCST_STR
);

3860 ià(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV_CHECK
)

3861 
pos
 +ð
	`sú´štf
(&
buf
[pos], 
SCST_SYSFS_BLOCK_SIZE
 -…os,

3862 "%s%s", (
j
 =ð
pos
è? "" : "|", 
SCST_DIF_MODE_DEV_CHECK_STR
);

3864 ià(
dev
->
dev_dif_mode
 & 
SCST_DIF_MODE_DEV_STORE
)

3865 
pos
 +ð
	`sú´štf
(&
buf
[pos], 
SCST_SYSFS_BLOCK_SIZE
 -…os,

3866 "%s%s", (
j
 =ð
pos
è? "" : "|", 
SCST_DIF_MODE_DEV_STORE_STR
);

3868 
pos
 +ð
	`sú´štf
(&
buf
[pos], 
SCST_SYSFS_BLOCK_SIZE
 -…os,

3869 "\n%s", 
SCST_SYSFS_KEY_MARK
 "\n");

3872 
	`TRACE_EXIT_RES
(
pos
);

3873  
pos
;

3874 
	}
}

3876 
kobj_©Œibu‹
 
	gsc¡_dev_dif_mode_©Œ
 =

3877 
__ATTR
(
dif_mode
, 
S_IRUGO
, 
sc¡_dev_dif_mode_show
, 
NULL
);

3879 
ssize_t
 
	$sc¡_dev_dif_ty³_show
(
kobjeù
 *
kobj
,

3880 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

3882 
pos
 = 0;

3883 
sc¡_deviû
 *
dev
;

3885 
	`TRACE_ENTRY
();

3887 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

3889 
pos
 = 
	`¥rštf
(
buf
, "%d\n%s", 
dev
->
dev_dif_ty³
,

3890 (
dev
->
dev_dif_ty³
 !ð0è? 
SCST_SYSFS_KEY_MARK
 "\n" : "");

3892 
	`TRACE_EXIT_RES
(
pos
);

3893  
pos
;

3894 
	}
}

3896 
kobj_©Œibu‹
 
	gsc¡_dev_dif_ty³_©Œ
 =

3897 
__ATTR
(
dif_ty³
, 
S_IRUGO
, 
sc¡_dev_dif_ty³_show
, 
NULL
);

3899 
ssize_t
 
	$sc¡_dev_sysfs_dif_¡©ic_­p_g_¡Üe
(
kobjeù
 *
kobj
,

3900 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

3902 
»s
;

3903 
sc¡_deviû
 *
dev
;

3904 
v®
;

3906 
	`TRACE_ENTRY
();

3908 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

3910 
»s
 = 
	`k¡¹ouÎ
(
buf
, 0, &
v®
);

3911 ià(
»s
 != 0) {

3912 
	`PRINT_ERROR
("strtoul() for %s failed: %d (device %s)",

3913 
buf
, 
»s
, 
dev
->
vœt_Çme
);

3914 
out
;

3917 
	`sc¡_dev_£t_dif_¡©ic_­p_g_combšed
(
dev
, 
	`ýu_to_be64
(
v®
));

3919 
»s
 = 
couÁ
;

3921 
	`PRINT_INFO
("APP TAG fÜ deviû % chªgedØ%Îx", 
dev
->
vœt_Çme
,

3922 ()
	`be64_to_ýu
(
	`sc¡_dev_g‘_dif_¡©ic_­p_g_combšed
(
dev
)));

3924 
out
:

3925 
	`TRACE_EXIT_RES
(
»s
);

3926  
»s
;

3927 
	}
}

3929 
ssize_t
 
	$sc¡_dev_sysfs_dif_¡©ic_­p_g_show
(
kobjeù
 *
kobj
,

3930 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

3932 
pos
 = 0;

3933 
sc¡_deviû
 *
dev
;

3934 
__be64
 
a
;

3936 
	`TRACE_ENTRY
();

3938 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

3940 
a
 = 
	`sc¡_dev_g‘_dif_¡©ic_­p_g_combšed
(
dev
);

3942 
pos
 = 
	`¥rštf
(
buf
, "0x%Îx\n%s", ()
	`be64_to_ýu
(
a
),

3943 (
a
 !ð
SCST_DIF_NO_CHECK_APP_TAG
è? 
SCST_SYSFS_KEY_MARK
 "\n" : "");

3945 
	`TRACE_EXIT_RES
(
pos
);

3946  
pos
;

3947 
	}
}

3949 
kobj_©Œibu‹
 
	gsc¡_dev_dif_¡©ic_­p_g_©Œ
 =

3950 
__ATTR
(
dif_¡©ic_­p_g
, 
S_IWUSR
|
S_IRUGO
,

3951 
sc¡_dev_sysfs_dif_¡©ic_­p_g_show
,

3952 
sc¡_dev_sysfs_dif_¡©ic_­p_g_¡Üe
);

3954 
	$sc¡_dev_sysfs_dif_ü—‹
(
sc¡_deviû
 *
dev
)

3956 
»s
;

3958 
	`TRACE_ENTRY
();

3965 
»s
 = 
	`sysfs_ü—‹_fže
(&
dev
->
dev_kobj
, &
sc¡_dev_dif_mode_©Œ
.
©Œ
);

3966 ià(
»s
 != 0) {

3967 
	`PRINT_ERROR
("Can't create‡ttr %s for dev %s",

3968 
sc¡_dev_dif_mode_©Œ
.
©Œ
.
Çme
, 
dev
->
vœt_Çme
);

3969 
out
;

3972 
»s
 = 
	`sysfs_ü—‹_fže
(&
dev
->
dev_kobj
, &
sc¡_dev_dif_ty³_©Œ
.
©Œ
);

3973 ià(
»s
 != 0) {

3974 
	`PRINT_ERROR
("Can't create‡ttr %s for dev %s",

3975 
sc¡_dev_dif_ty³_©Œ
.
©Œ
.
Çme
, 
dev
->
vœt_Çme
);

3976 
out
;

3979 
»s
 = 
	`sysfs_ü—‹_fže
(&
dev
->
dev_kobj
, &
sc¡_dev_dif_¡©ic_­p_g_©Œ
.
©Œ
);

3980 ià(
»s
 != 0) {

3981 
	`PRINT_ERROR
("Can't create‡ttr %s for dev %s",

3982 
sc¡_dev_dif_¡©ic_­p_g_©Œ
.
©Œ
.
Çme
, 
dev
->
vœt_Çme
);

3983 
out
;

3986 
out
:

3987 
	`TRACE_EXIT_RES
(
»s
);

3988  
»s
;

3989 
	}
}

3995 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


3997 *
	gsc¡_io_size_Çmes
[] = {

4005 
ssize_t
 
	$sc¡_tgt_dev_Ï‹ncy_show
(
kobjeù
 *
kobj
,

4006 
kobj_©Œibu‹
 *
©Œ
, *
bufãr
)

4008 
»s
 = 0, 
i
;

4009 
buf
[50];

4010 
sc¡_tgt_dev
 *
tgt_dev
;

4012 
	`TRACE_ENTRY
();

4014 
tgt_dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt_dev
, 
tgt_dev_kobj
);

4016 
i
 = 0; i < 
SCST_LATENCY_STATS_NUM
; i++) {

4017 
ušt64_t
 
sc¡_time_wr
, 
tgt_time_wr
, 
dev_time_wr
;

4018 
ušt64_t
 
´oûs£d_cmds_wr
;

4019 
ušt64_t
 
sc¡_time_rd
, 
tgt_time_rd
, 
dev_time_rd
;

4020 
ušt64_t
 
´oûs£d_cmds_rd
;

4021 
sc¡_ext_Ï‹ncy_¡©
 *
Ï‹ncy_¡©
;

4023 
Ï‹ncy_¡©
 = &
tgt_dev
->
dev_Ï‹ncy_¡©
[
i
];

4024 
sc¡_time_wr
 = 
Ï‹ncy_¡©
->scst_time_wr;

4025 
sc¡_time_rd
 = 
Ï‹ncy_¡©
->scst_time_rd;

4026 
tgt_time_wr
 = 
Ï‹ncy_¡©
->tgt_time_wr;

4027 
tgt_time_rd
 = 
Ï‹ncy_¡©
->tgt_time_rd;

4028 
dev_time_wr
 = 
Ï‹ncy_¡©
->dev_time_wr;

4029 
dev_time_rd
 = 
Ï‹ncy_¡©
->dev_time_rd;

4030 
´oûs£d_cmds_wr
 = 
Ï‹ncy_¡©
->processed_cmds_wr;

4031 
´oûs£d_cmds_rd
 = 
Ï‹ncy_¡©
->processed_cmds_rd;

4033 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

4034 "%-5 %-9 %-15Îu ", "Wr™e", 
sc¡_io_size_Çmes
[
i
],

4035 
´oûs£d_cmds_wr
);

4037 
	`sc¡_time_³r_cmd
(
sc¡_time_wr
, 
´oûs£d_cmds_wr
);

4038 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

4039 ()
Ï‹ncy_¡©
->
mš_sc¡_time_wr
,

4040 ()
sc¡_time_wr
,

4041 ()
Ï‹ncy_¡©
->
max_sc¡_time_wr
,

4042 ()
Ï‹ncy_¡©
->
sc¡_time_wr
);

4043 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

4044 "%-46 ", 
buf
);

4046 
	`sc¡_time_³r_cmd
(
tgt_time_wr
, 
´oûs£d_cmds_wr
);

4047 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

4048 ()
Ï‹ncy_¡©
->
mš_tgt_time_wr
,

4049 ()
tgt_time_wr
,

4050 ()
Ï‹ncy_¡©
->
max_tgt_time_wr
,

4051 ()
Ï‹ncy_¡©
->
tgt_time_wr
);

4052 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

4053 "%-46 ", 
buf
);

4055 
	`sc¡_time_³r_cmd
(
dev_time_wr
, 
´oûs£d_cmds_wr
);

4056 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

4057 ()
Ï‹ncy_¡©
->
mš_dev_time_wr
,

4058 ()
dev_time_wr
,

4059 ()
Ï‹ncy_¡©
->
max_dev_time_wr
,

4060 ()
Ï‹ncy_¡©
->
dev_time_wr
);

4061 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

4062 "%-46s\n", 
buf
);

4064 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

4065 "%-5 %-9 %-15Îu ", "R—d", 
sc¡_io_size_Çmes
[
i
],

4066 
´oûs£d_cmds_rd
);

4068 
	`sc¡_time_³r_cmd
(
sc¡_time_rd
, 
´oûs£d_cmds_rd
);

4069 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

4070 ()
Ï‹ncy_¡©
->
mš_sc¡_time_rd
,

4071 ()
sc¡_time_rd
,

4072 ()
Ï‹ncy_¡©
->
max_sc¡_time_rd
,

4073 ()
Ï‹ncy_¡©
->
sc¡_time_rd
);

4074 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

4075 "%-46 ", 
buf
);

4077 
	`sc¡_time_³r_cmd
(
tgt_time_rd
, 
´oûs£d_cmds_rd
);

4078 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

4079 ()
Ï‹ncy_¡©
->
mš_tgt_time_rd
,

4080 ()
tgt_time_rd
,

4081 ()
Ï‹ncy_¡©
->
max_tgt_time_rd
,

4082 ()
Ï‹ncy_¡©
->
tgt_time_rd
);

4083 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

4084 "%-46 ", 
buf
);

4086 
	`sc¡_time_³r_cmd
(
dev_time_rd
, 
´oûs£d_cmds_rd
);

4087 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

4088 ()
Ï‹ncy_¡©
->
mš_dev_time_rd
,

4089 ()
dev_time_rd
,

4090 ()
Ï‹ncy_¡©
->
max_dev_time_rd
,

4091 ()
Ï‹ncy_¡©
->
dev_time_rd
);

4092 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

4093 "%-46s\n", 
buf
);

4096 
	`TRACE_EXIT_RES
(
»s
);

4097  
»s
;

4098 
	}
}

4100 
kobj_©Œibu‹
 
	gtgt_dev_Ï‹ncy_©Œ
 =

4101 
__ATTR
(
Ï‹ncy
, 
S_IRUGO
,

4102 
sc¡_tgt_dev_Ï‹ncy_show
, 
NULL
);

4106 
ssize_t
 
	$sc¡_tgt_dev_th»ad_pid_show
(
kobjeù
 *
kobj
,

4107 
kobj_©Œibu‹
 *
©Œ
,

4108 *
bufãr
)

4110 
sc¡_tgt_dev
 *
tgt_dev
 =

4111 
	`cÚš”_of
(
kobj
, 
sc¡_tgt_dev
, 
tgt_dev_kobj
);

4112 
sc¡_cmd_th»ads
 *
cmd_th»ads
 = 
tgt_dev
->
aùive_cmd_th»ads
;

4113 
sc¡_cmd_th»ad_t
 *
t
;

4114 
»s
 = 0;

4116 
	`¥š_lock
(&
cmd_th»ads
->
thr_lock
);

4117 
	`li¡_fÜ_—ch_’Œy
(
t
, &
cmd_th»ads
->
th»ads_li¡
, 
th»ad_li¡_’Œy
)

4118 
»s
 +ð
	`sú´štf
(
bufãr
 +„es, 
PAGE_SIZE
 -„es, "%d%s",

4119 
	`sk_pid_vÄ
(
t
->
cmd_th»ad
),

4120 
	`li¡_is_Ï¡
(&
t
->
th»ad_li¡_’Œy
,

4121 &
cmd_th»ads
->
th»ads_li¡
) ?

4123 
	`¥š_uÆock
(&
cmd_th»ads
->
thr_lock
);

4125  
»s
;

4126 
	}
}

4128 
kobj_©Œibu‹
 
	gtgt_dev_th»ad_pid_©Œ
 =

4129 
__ATTR
(
th»ad_pid
, 
S_IRUGO
, 
sc¡_tgt_dev_th»ad_pid_show
, 
NULL
);

4131 
ssize_t
 
	$sc¡_tgt_dev_aùive_commªds_show
(
kobjeù
 *
kobj
,

4132 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

4134 
pos
 = 0;

4135 
sc¡_tgt_dev
 *
tgt_dev
;

4137 
tgt_dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt_dev
, 
tgt_dev_kobj
);

4139 
pos
 = 
	`¥rštf
(
buf
, "%d\n", 
	`©omic_»ad
(&
tgt_dev
->
tgt_dev_cmd_couÁ
));

4141  
pos
;

4142 
	}
}

4144 
kobj_©Œibu‹
 
	gtgt_dev_aùive_commªds_©Œ
 =

4145 
__ATTR
(
aùive_commªds
, 
S_IRUGO
,

4146 
sc¡_tgt_dev_aùive_commªds_show
, 
NULL
);

4148 
ssize_t
 
	$sc¡_tgt_dev_dif_checks_çžed_show
(
kobjeù
 *
kobj
,

4149 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

4151 
pos
 = 0;

4152 
sc¡_tgt_dev
 *
tgt_dev
;

4154 
tgt_dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt_dev
, 
tgt_dev_kobj
);

4156 
pos
 = 
	`sú´štf
(
buf
, 
SCST_SYSFS_BLOCK_SIZE
, "\tapp\tref\tguard\n"

4158 
	`©omic_»ad
(&
tgt_dev
->
tgt_dev_dif_­p_çžed_tgt
),

4159 
	`©omic_»ad
(&
tgt_dev
->
tgt_dev_dif_»f_çžed_tgt
),

4160 
	`©omic_»ad
(&
tgt_dev
->
tgt_dev_dif_gu¬d_çžed_tgt
),

4161 
	`©omic_»ad
(&
tgt_dev
->
tgt_dev_dif_­p_çžed_sc¡
),

4162 
	`©omic_»ad
(&
tgt_dev
->
tgt_dev_dif_»f_çžed_sc¡
),

4163 
	`©omic_»ad
(&
tgt_dev
->
tgt_dev_dif_gu¬d_çžed_sc¡
),

4164 
	`©omic_»ad
(&
tgt_dev
->
tgt_dev_dif_­p_çžed_dev
),

4165 
	`©omic_»ad
(&
tgt_dev
->
tgt_dev_dif_»f_çžed_dev
),

4166 
	`©omic_»ad
(&
tgt_dev
->
tgt_dev_dif_gu¬d_çžed_dev
));

4168  
pos
;

4169 
	}
}

4171 
ssize_t
 
	$sc¡_tgt_dev_dif_checks_çžed_¡Üe
(
kobjeù
 *
kobj
,

4172 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

4174 
sc¡_tgt_dev
 *
tgt_dev
;

4176 
tgt_dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt_dev
, 
tgt_dev_kobj
);

4178 
	`PRINT_INFO
("Zeroing DIF failures statistics for initiator "

4179 "%s,¬g‘ %s, LUN %Îd", 
tgt_dev
->
£ss
->
š™ŸtÜ_Çme
,

4180 
tgt_dev
->
£ss
->
tgt
->
tgt_Çme
, (égt_dev->
lun
);

4182 
	`©omic_£t
(&
tgt_dev
->
tgt_dev_dif_­p_çžed_tgt
, 0);

4183 
	`©omic_£t
(&
tgt_dev
->
tgt_dev_dif_»f_çžed_tgt
, 0);

4184 
	`©omic_£t
(&
tgt_dev
->
tgt_dev_dif_gu¬d_çžed_tgt
, 0);

4185 
	`©omic_£t
(&
tgt_dev
->
tgt_dev_dif_­p_çžed_sc¡
, 0);

4186 
	`©omic_£t
(&
tgt_dev
->
tgt_dev_dif_»f_çžed_sc¡
, 0);

4187 
	`©omic_£t
(&
tgt_dev
->
tgt_dev_dif_gu¬d_çžed_sc¡
, 0);

4188 
	`©omic_£t
(&
tgt_dev
->
tgt_dev_dif_­p_çžed_dev
, 0);

4189 
	`©omic_£t
(&
tgt_dev
->
tgt_dev_dif_»f_çžed_dev
, 0);

4190 
	`©omic_£t
(&
tgt_dev
->
tgt_dev_dif_gu¬d_çžed_dev
, 0);

4192  
couÁ
;

4193 
	}
}

4195 
kobj_©Œibu‹
 
	gtgt_dev_dif_checks_çžed_©Œ
 =

4196 
__ATTR
(
dif_checks_çžed
, 
S_IRUGO
 | 
S_IWUSR
,

4197 
sc¡_tgt_dev_dif_checks_çžed_show
,

4198 
sc¡_tgt_dev_dif_checks_çžed_¡Üe
);

4200 
©Œibu‹
 *
	gsc¡_tgt_dev_©Œs
[] = {

4201 &
tgt_dev_th»ad_pid_©Œ
.
©Œ
,

4202 &
tgt_dev_aùive_commªds_©Œ
.
©Œ
,

4203 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


4204 &
tgt_dev_Ï‹ncy_©Œ
.
©Œ
,

4206 
NULL
,

4209 
	$sc¡_sysfs_tgt_dev_»Ëa£
(
kobjeù
 *
kobj
)

4211 
sc¡_tgt_dev
 *
tgt_dev
;

4213 
	`TRACE_ENTRY
();

4215 
tgt_dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt_dev
, 
tgt_dev_kobj
);

4216 ià(
tgt_dev
->
tgt_dev_kobj_»Ëa£_cm¶
)

4217 
	`com¶‘e_®l
(
tgt_dev
->
tgt_dev_kobj_»Ëa£_cm¶
);

4219 
	`TRACE_EXIT
();

4221 
	}
}

4223 
kobj_ty³
 
	gsc¡_tgt_dev_kty³
 = {

4224 .
sysfs_Ýs
 = &
sc¡_sysfs_Ýs
,

4225 .
	g»Ëa£
 = 
sc¡_sysfs_tgt_dev_»Ëa£
,

4226 .
	gdeçuÉ_©Œs
 = 
sc¡_tgt_dev_©Œs
,

4229 
	$sc¡_tgt_dev_sysfs_ü—‹
(
sc¡_tgt_dev
 *
tgt_dev
)

4231 
»s
 = 0;

4233 
	`TRACE_ENTRY
();

4235 
»s
 = 
	`kobjeù_š™_ªd_add
(&
tgt_dev
->
tgt_dev_kobj
, &
sc¡_tgt_dev_kty³
,

4236 &
tgt_dev
->
£ss
->
£ss_kobj
, "lun%lld",

4237 ()
tgt_dev
->
lun
);

4238 ià(
»s
 != 0) {

4239 
	`PRINT_ERROR
("Can't‡ddgt_dev %lldo sysfs",

4240 ()
tgt_dev
->
lun
);

4241 
out
;

4244 ià(
tgt_dev
->
£ss
->
tgt
->
tgt_dif_suµÜ‹d
 && (tgt_dev->
dev
->
dev_dif_ty³
 != 0)) {

4245 
»s
 = 
	`sysfs_ü—‹_fže
(&
tgt_dev
->
tgt_dev_kobj
,

4246 &
tgt_dev_dif_checks_çžed_©Œ
.
©Œ
);

4247 ià(
»s
 != 0) {

4248 
	`PRINT_ERROR
("Adding %s sysfs‡ttributeogt_dev %lld "

4249 "çžed (%d)", 
tgt_dev_dif_checks_çžed_©Œ
.
©Œ
.
Çme
,

4250 ()
tgt_dev
->
lun
, 
»s
);

4251 
out_d–
;

4255 
out
:

4256 
	`TRACE_EXIT_RES
(
»s
);

4257  
»s
;

4259 
out_d–
:

4260 
	`kobjeù_d–
(&
tgt_dev
->
tgt_dev_kobj
);

4261 
	`kobjeù_put
(&
tgt_dev
->
tgt_dev_kobj
);

4262 
out
;

4263 
	}
}

4272 
	$sc¡_tgt_dev_sysfs_d–
(
sc¡_tgt_dev
 *
tgt_dev
)

4274 
	`DECLARE_COMPLETION_ONSTACK
(
c
);

4276 
	`TRACE_ENTRY
();

4278 
tgt_dev
->
tgt_dev_kobj_»Ëa£_cm¶
 = &
c
;

4280 
	`kobjeù_d–
(&
tgt_dev
->
tgt_dev_kobj
);

4282 
	`SCST_KOBJECT_PUT_AND_WAIT
(&
tgt_dev
->
tgt_dev_kobj
, "tgt_dev", &
c
,

4283 &
sc¡_tgt_dev_d•_m­
);

4285 
	`TRACE_EXIT
();

4287 
	}
}

4293 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


4295 
ssize_t
 
	$sc¡_£ss_Ï‹ncy_show
(
kobjeù
 *
kobj
,

4296 
kobj_©Œibu‹
 *
©Œ
, *
bufãr
)

4298 
ssize_t
 
»s
 = 0;

4299 
sc¡_£ssiÚ
 *
£ss
;

4300 
i
;

4301 
buf
[50];

4302 
ušt64_t
 
sc¡_time
, 
tgt_time
, 
dev_time
;

4303 
ušt64_t
 
´oûs£d_cmds
;

4305 
	`TRACE_ENTRY
();

4307 
£ss
 = 
	`cÚš”_of
(
kobj
, 
sc¡_£ssiÚ
, 
£ss_kobj
);

4309 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

4314 
	`¥š_lock_bh
(&
£ss
->
Ït_lock
);

4316 
i
 = 0; i < 
SCST_LATENCY_STATS_NUM
; i++) {

4317 
ušt64_t
 
sc¡_time_wr
, 
tgt_time_wr
, 
dev_time_wr
;

4318 
ušt64_t
 
´oûs£d_cmds_wr
;

4319 
ušt64_t
 
sc¡_time_rd
, 
tgt_time_rd
, 
dev_time_rd
;

4320 
ušt64_t
 
´oûs£d_cmds_rd
;

4321 
sc¡_ext_Ï‹ncy_¡©
 *
Ï‹ncy_¡©
;

4323 
Ï‹ncy_¡©
 = &
£ss
->
£ss_Ï‹ncy_¡©
[
i
];

4324 
sc¡_time_wr
 = 
Ï‹ncy_¡©
->scst_time_wr;

4325 
sc¡_time_rd
 = 
Ï‹ncy_¡©
->scst_time_rd;

4326 
tgt_time_wr
 = 
Ï‹ncy_¡©
->tgt_time_wr;

4327 
tgt_time_rd
 = 
Ï‹ncy_¡©
->tgt_time_rd;

4328 
dev_time_wr
 = 
Ï‹ncy_¡©
->dev_time_wr;

4329 
dev_time_rd
 = 
Ï‹ncy_¡©
->dev_time_rd;

4330 
´oûs£d_cmds_wr
 = 
Ï‹ncy_¡©
->processed_cmds_wr;

4331 
´oûs£d_cmds_rd
 = 
Ï‹ncy_¡©
->processed_cmds_rd;

4333 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

4335 "Wr™e", 
sc¡_io_size_Çmes
[
i
],

4336 
´oûs£d_cmds_wr
);

4338 
	`sc¡_time_³r_cmd
(
sc¡_time_wr
, 
´oûs£d_cmds_wr
);

4339 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

4340 ()
Ï‹ncy_¡©
->
mš_sc¡_time_wr
,

4341 ()
sc¡_time_wr
,

4342 ()
Ï‹ncy_¡©
->
max_sc¡_time_wr
,

4343 ()
Ï‹ncy_¡©
->
sc¡_time_wr
);

4344 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

4345 "%-46 ", 
buf
);

4347 
	`sc¡_time_³r_cmd
(
tgt_time_wr
, 
´oûs£d_cmds_wr
);

4348 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

4349 ()
Ï‹ncy_¡©
->
mš_tgt_time_wr
,

4350 ()
tgt_time_wr
,

4351 ()
Ï‹ncy_¡©
->
max_tgt_time_wr
,

4352 ()
Ï‹ncy_¡©
->
tgt_time_wr
);

4353 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

4354 "%-46 ", 
buf
);

4356 
	`sc¡_time_³r_cmd
(
dev_time_wr
, 
´oûs£d_cmds_wr
);

4357 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

4358 ()
Ï‹ncy_¡©
->
mš_dev_time_wr
,

4359 ()
dev_time_wr
,

4360 ()
Ï‹ncy_¡©
->
max_dev_time_wr
,

4361 ()
Ï‹ncy_¡©
->
dev_time_wr
);

4362 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

4363 "%-46s\n", 
buf
);

4365 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

4367 "R—d", 
sc¡_io_size_Çmes
[
i
],

4368 
´oûs£d_cmds_rd
);

4370 
	`sc¡_time_³r_cmd
(
sc¡_time_rd
, 
´oûs£d_cmds_rd
);

4371 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

4372 ()
Ï‹ncy_¡©
->
mš_sc¡_time_rd
,

4373 ()
sc¡_time_rd
,

4374 ()
Ï‹ncy_¡©
->
max_sc¡_time_rd
,

4375 ()
Ï‹ncy_¡©
->
sc¡_time_rd
);

4376 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

4377 "%-46 ", 
buf
);

4379 
	`sc¡_time_³r_cmd
(
tgt_time_rd
, 
´oûs£d_cmds_rd
);

4380 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

4381 ()
Ï‹ncy_¡©
->
mš_tgt_time_rd
,

4382 ()
tgt_time_rd
,

4383 ()
Ï‹ncy_¡©
->
max_tgt_time_rd
,

4384 ()
Ï‹ncy_¡©
->
tgt_time_rd
);

4385 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

4386 "%-46 ", 
buf
);

4388 
	`sc¡_time_³r_cmd
(
dev_time_rd
, 
´oûs£d_cmds_rd
);

4389 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

4390 ()
Ï‹ncy_¡©
->
mš_dev_time_rd
,

4391 ()
dev_time_rd
,

4392 ()
Ï‹ncy_¡©
->
max_dev_time_rd
,

4393 ()
Ï‹ncy_¡©
->
dev_time_rd
);

4394 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

4395 "%-46s\n", 
buf
);

4398 
sc¡_time
 = 
£ss
->scst_time;

4399 
tgt_time
 = 
£ss
->tgt_time;

4400 
dev_time
 = 
£ss
->dev_time;

4401 
´oûs£d_cmds
 = 
£ss
->processed_cmds;

4403 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

4404 "\n%-15 %-16Îu", "Ov”®È", 
´oûs£d_cmds
);

4406 
	`sc¡_time_³r_cmd
(
sc¡_time
, 
´oûs£d_cmds
);

4407 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

4408 ()
£ss
->
mš_sc¡_time
,

4409 ()
sc¡_time
,

4410 ()
£ss
->
max_sc¡_time
,

4411 ()
£ss
->
sc¡_time
);

4412 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

4413 "%-46 ", 
buf
);

4415 
	`sc¡_time_³r_cmd
(
tgt_time
, 
´oûs£d_cmds
);

4416 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

4417 ()
£ss
->
mš_tgt_time
,

4418 ()
tgt_time
,

4419 ()
£ss
->
max_tgt_time
,

4420 ()
£ss
->
tgt_time
);

4421 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

4422 "%-46 ", 
buf
);

4424 
	`sc¡_time_³r_cmd
(
dev_time
, 
´oûs£d_cmds
);

4425 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

4426 ()
£ss
->
mš_dev_time
,

4427 ()
dev_time
,

4428 ()
£ss
->
max_dev_time
,

4429 ()
£ss
->
dev_time
);

4430 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

4431 "%-46s\n\n", 
buf
);

4433 
	`¥š_uÆock_bh
(&
£ss
->
Ït_lock
);

4435 
	`TRACE_EXIT_RES
(
»s
);

4436  
»s
;

4437 
	}
}

4439 
	$sc¡_£ss_z”o_Ï‹ncy
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

4441 
»s
 = 0, 
t
;

4442 
sc¡_£ssiÚ
 *
£ss
 = 
wÜk
->sess;

4444 
	`TRACE_ENTRY
();

4446 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

4447 ià(
»s
 != 0)

4448 
out_put
;

4450 
	`PRINT_INFO
("Zeroing†atency statistics for initiator "

4451 "%s", 
£ss
->
š™ŸtÜ_Çme
);

4453 
	`¥š_lock_bh
(&
£ss
->
Ït_lock
);

4455 
£ss
->
sc¡_time
 = 0;

4456 
£ss
->
tgt_time
 = 0;

4457 
£ss
->
dev_time
 = 0;

4458 
£ss
->
mš_sc¡_time
 = 0;

4459 
£ss
->
mš_tgt_time
 = 0;

4460 
£ss
->
mš_dev_time
 = 0;

4461 
£ss
->
max_sc¡_time
 = 0;

4462 
£ss
->
max_tgt_time
 = 0;

4463 
£ss
->
max_dev_time
 = 0;

4464 
£ss
->
´oûs£d_cmds
 = 0;

4465 
	`mem£t
(
£ss
->
£ss_Ï‹ncy_¡©
, 0,

4466 (
£ss
->
£ss_Ï‹ncy_¡©
));

4468 
t
 = 
SESS_TGT_DEV_LIST_HASH_SIZE
-1; >= 0;--) {

4469 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
t
];

4470 
sc¡_tgt_dev
 *
tgt_dev
;

4472 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
, 
£ss_tgt_dev_li¡_’Œy
) {

4473 
tgt_dev
->
sc¡_time
 = 0;

4474 
tgt_dev
->
tgt_time
 = 0;

4475 
tgt_dev
->
dev_time
 = 0;

4476 
tgt_dev
->
´oûs£d_cmds
 = 0;

4477 
	`mem£t
(
tgt_dev
->
dev_Ï‹ncy_¡©
, 0,

4478 (
tgt_dev
->
dev_Ï‹ncy_¡©
));

4482 
	`¥š_uÆock_bh
(&
£ss
->
Ït_lock
);

4484 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

4486 
out_put
:

4487 
	`kobjeù_put
(&
£ss
->
£ss_kobj
);

4489 
	`TRACE_EXIT_RES
(
»s
);

4490  
»s
;

4491 
	}
}

4493 
ssize_t
 
	$sc¡_£ss_Ï‹ncy_¡Üe
(
kobjeù
 *
kobj
,

4494 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

4496 
»s
;

4497 
sc¡_£ssiÚ
 *
£ss
;

4498 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

4500 
	`TRACE_ENTRY
();

4502 
£ss
 = 
	`cÚš”_of
(
kobj
, 
sc¡_£ssiÚ
, 
£ss_kobj
);

4504 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_£ss_z”o_Ï‹ncy
, 
çl£
, &
wÜk
);

4505 ià(
»s
 != 0)

4506 
out
;

4508 
wÜk
->
£ss
 = sess;

4510 
	`SCST_SET_DEP_MAP
(
wÜk
, &
sc¡_£ss_d•_m­
);

4511 
	`kobjeù_g‘
(&
£ss
->
£ss_kobj
);

4513 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

4514 ià(
»s
 == 0)

4515 
»s
 = 
couÁ
;

4517 
out
:

4518 
	`TRACE_EXIT_RES
(
»s
);

4519  
»s
;

4520 
	}
}

4522 
kobj_©Œibu‹
 
	g£ssiÚ_Ï‹ncy_©Œ
 =

4523 
__ATTR
(
Ï‹ncy
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_£ss_Ï‹ncy_show
,

4524 
sc¡_£ss_Ï‹ncy_¡Üe
);

4528 
ssize_t
 
	$sc¡_£ss_sysfs_commªds_show
(
kobjeù
 *
kobj
,

4529 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

4531 
sc¡_£ssiÚ
 *
£ss
;

4533 
£ss
 = 
	`cÚš”_of
(
kobj
, 
sc¡_£ssiÚ
, 
£ss_kobj
);

4535  
	`¥rštf
(
buf
, "%i\n", 
	`©omic_»ad
(&
£ss
->
£ss_cmd_couÁ
));

4536 
	}
}

4538 
kobj_©Œibu‹
 
	g£ssiÚ_commªds_©Œ
 =

4539 
__ATTR
(
commªds
, 
S_IRUGO
, 
sc¡_£ss_sysfs_commªds_show
, 
NULL
);

4541 
	$sc¡_sysfs_£ss_g‘_aùive_commªds
(
sc¡_£ssiÚ
 *
£ss
)

4543 
»s
;

4544 
aùive_cmds
 = 0, 
t
;

4546 
	`TRACE_ENTRY
();

4548 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

4549 ià(
»s
 != 0)

4550 
out_put
;

4552 
t
 = 
SESS_TGT_DEV_LIST_HASH_SIZE
-1; >= 0;--) {

4553 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
t
];

4554 
sc¡_tgt_dev
 *
tgt_dev
;

4556 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
, 
£ss_tgt_dev_li¡_’Œy
) {

4557 
aùive_cmds
 +ð
	`©omic_»ad
(&
tgt_dev
->
tgt_dev_cmd_couÁ
);

4561 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

4563 
»s
 = 
aùive_cmds
;

4565 
out_put
:

4566 
	`kobjeù_put
(&
£ss
->
£ss_kobj
);

4568 
	`TRACE_EXIT_RES
(
»s
);

4569  
»s
;

4570 
	}
}

4572 
	$sc¡_sysfs_£ss_g‘_aùive_commªds_wÜk_â
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

4574  
	`sc¡_sysfs_£ss_g‘_aùive_commªds
(
wÜk
->
£ss
);

4575 
	}
}

4577 
ssize_t
 
	$sc¡_£ss_sysfs_aùive_commªds_show
(
kobjeù
 *
kobj
,

4578 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

4580 
»s
;

4581 
sc¡_£ssiÚ
 *
£ss
;

4582 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

4584 
£ss
 = 
	`cÚš”_of
(
kobj
, 
sc¡_£ssiÚ
, 
£ss_kobj
);

4586 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_sysfs_£ss_g‘_aùive_commªds_wÜk_â
,

4587 
Œue
, &
wÜk
);

4588 ià(
»s
 != 0)

4589 
out
;

4591 
wÜk
->
£ss
 = sess;

4593 
	`SCST_SET_DEP_MAP
(
wÜk
, &
sc¡_£ss_d•_m­
);

4594 
	`kobjeù_g‘
(&
£ss
->
£ss_kobj
);

4596 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

4597 ià(
»s
 !ð-
EAGAIN
)

4598 
»s
 = 
	`¥rštf
(
buf
, "%i\n",„es);

4600 
out
:

4601  
»s
;

4602 
	}
}

4604 
kobj_©Œibu‹
 
	g£ssiÚ_aùive_commªds_©Œ
 =

4605 
__ATTR
(
aùive_commªds
, 
S_IRUGO
, 
sc¡_£ss_sysfs_aùive_commªds_show
,

4606 
NULL
);

4608 
	$sc¡_sysfs_£ss_g‘_dif_checks_çžed_wÜk_â
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

4610 
»s
, 
t
;

4611 
sc¡_£ssiÚ
 *
£ss
 = 
wÜk
->sess;

4612 
­p_çžed_tgt
 = 0, 
»f_çžed_tgt
 = 0, 
gu¬d_çžed_tgt
 = 0;

4613 
­p_çžed_sc¡
 = 0, 
»f_çžed_sc¡
 = 0, 
gu¬d_çžed_sc¡
 = 0;

4614 
­p_çžed_dev
 = 0, 
»f_çžed_dev
 = 0, 
gu¬d_çžed_dev
 = 0;

4616 
	`TRACE_ENTRY
();

4618 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

4619 ià(
»s
 != 0)

4620 
out_put
;

4622 
t
 = 
SESS_TGT_DEV_LIST_HASH_SIZE
-1; >= 0;--) {

4623 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
t
];

4624 
sc¡_tgt_dev
 *
tgt_dev
;

4626 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
, 
£ss_tgt_dev_li¡_’Œy
) {

4627 
­p_çžed_tgt
 +ð
	`©omic_»ad
(&
tgt_dev
->
tgt_dev_dif_­p_çžed_tgt
);

4628 
»f_çžed_tgt
 +ð
	`©omic_»ad
(&
tgt_dev
->
tgt_dev_dif_»f_çžed_tgt
);

4629 
gu¬d_çžed_tgt
 +ð
	`©omic_»ad
(&
tgt_dev
->
tgt_dev_dif_gu¬d_çžed_tgt
);

4630 
­p_çžed_sc¡
 +ð
	`©omic_»ad
(&
tgt_dev
->
tgt_dev_dif_­p_çžed_sc¡
);

4631 
»f_çžed_sc¡
 +ð
	`©omic_»ad
(&
tgt_dev
->
tgt_dev_dif_»f_çžed_sc¡
);

4632 
gu¬d_çžed_sc¡
 +ð
	`©omic_»ad
(&
tgt_dev
->
tgt_dev_dif_gu¬d_çžed_sc¡
);

4633 
­p_çžed_dev
 +ð
	`©omic_»ad
(&
tgt_dev
->
tgt_dev_dif_­p_çžed_dev
);

4634 
»f_çžed_dev
 +ð
	`©omic_»ad
(&
tgt_dev
->
tgt_dev_dif_»f_çžed_dev
);

4635 
gu¬d_çžed_dev
 +ð
	`©omic_»ad
(&
tgt_dev
->
tgt_dev_dif_gu¬d_çžed_dev
);

4639 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

4641 
wÜk
->
»s_buf
 = 
	`ka¥rštf
(
GFP_KERNEL
, "\tapp\tref\tguard\n"

4643 
­p_çžed_tgt
, 
»f_çžed_tgt
, 
gu¬d_çžed_tgt
,

4644 
­p_çžed_sc¡
, 
»f_çžed_sc¡
, 
gu¬d_çžed_sc¡
,

4645 
­p_çžed_dev
, 
»f_çžed_dev
, 
gu¬d_çžed_dev
);

4646 
»s
 = 
wÜk
->
»s_buf
 ? 0 : -
ENOMEM
;

4648 
out_put
:

4649 
	`kobjeù_put
(&
£ss
->
£ss_kobj
);

4651 
	`TRACE_EXIT_RES
(
»s
);

4652  
»s
;

4653 
	}
}

4655 
ssize_t
 
	$sc¡_£ss_sysfs_dif_checks_çžed_show
(
kobjeù
 *
kobj
,

4656 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

4658 
»s
;

4659 
sc¡_£ssiÚ
 *
£ss
;

4660 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

4662 
£ss
 = 
	`cÚš”_of
(
kobj
, 
sc¡_£ssiÚ
, 
£ss_kobj
);

4664 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_sysfs_£ss_g‘_dif_checks_çžed_wÜk_â
,

4665 
Œue
, &
wÜk
);

4666 ià(
»s
 != 0)

4667 
out
;

4669 
wÜk
->
£ss
 = sess;

4671 
	`SCST_SET_DEP_MAP
(
wÜk
, &
sc¡_£ss_d•_m­
);

4672 
	`kobjeù_g‘
(&
£ss
->
£ss_kobj
);

4674 
	`sc¡_sysfs_wÜk_g‘
(
wÜk
);

4676 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

4677 ià(
»s
 != 0)

4678 
out_put
;

4680 
»s
 = 
	`¢´štf
(
buf
, 
SCST_SYSFS_BLOCK_SIZE
, "%s", 
wÜk
->
»s_buf
);

4682 
out_put
:

4683 
	`sc¡_sysfs_wÜk_put
(
wÜk
);

4685 
out
:

4686  
»s
;

4687 
	}
}

4689 
	$sc¡_£ss_z”o_dif_checks_çžed
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

4691 
»s
, 
t
;

4692 
sc¡_£ssiÚ
 *
£ss
 = 
wÜk
->sess;

4694 
	`TRACE_ENTRY
();

4696 
	`PRINT_INFO
("Zeroing DIF failures statistics for initiator "

4697 "%s,¬g‘ %s", 
£ss
->
š™ŸtÜ_Çme
, sess->
tgt
->
tgt_Çme
);

4699 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

4700 ià(
»s
 != 0)

4701 
out_put
;

4703 
t
 = 
SESS_TGT_DEV_LIST_HASH_SIZE
-1; >= 0;--) {

4704 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
t
];

4705 
sc¡_tgt_dev
 *
tgt_dev
;

4707 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
, 
£ss_tgt_dev_li¡_’Œy
) {

4708 
	`©omic_£t
(&
tgt_dev
->
tgt_dev_dif_­p_çžed_tgt
, 0);

4709 
	`©omic_£t
(&
tgt_dev
->
tgt_dev_dif_»f_çžed_tgt
, 0);

4710 
	`©omic_£t
(&
tgt_dev
->
tgt_dev_dif_gu¬d_çžed_tgt
, 0);

4711 
	`©omic_£t
(&
tgt_dev
->
tgt_dev_dif_­p_çžed_sc¡
, 0);

4712 
	`©omic_£t
(&
tgt_dev
->
tgt_dev_dif_»f_çžed_sc¡
, 0);

4713 
	`©omic_£t
(&
tgt_dev
->
tgt_dev_dif_gu¬d_çžed_sc¡
, 0);

4714 
	`©omic_£t
(&
tgt_dev
->
tgt_dev_dif_­p_çžed_dev
, 0);

4715 
	`©omic_£t
(&
tgt_dev
->
tgt_dev_dif_»f_çžed_dev
, 0);

4716 
	`©omic_£t
(&
tgt_dev
->
tgt_dev_dif_gu¬d_çžed_dev
, 0);

4720 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

4722 
»s
 = 0;

4724 
out_put
:

4725 
	`kobjeù_put
(&
£ss
->
£ss_kobj
);

4727 
	`TRACE_EXIT_RES
(
»s
);

4728  
»s
;

4729 
	}
}

4731 
ssize_t
 
	$sc¡_£ss_sysfs_dif_checks_çžed_¡Üe
(
kobjeù
 *
kobj
,

4732 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

4734 
»s
;

4735 
sc¡_£ssiÚ
 *
£ss
;

4736 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

4738 
	`TRACE_ENTRY
();

4740 
£ss
 = 
	`cÚš”_of
(
kobj
, 
sc¡_£ssiÚ
, 
£ss_kobj
);

4742 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_£ss_z”o_dif_checks_çžed
, 
çl£
, &
wÜk
);

4743 ià(
»s
 != 0)

4744 
out
;

4746 
wÜk
->
£ss
 = sess;

4748 
	`SCST_SET_DEP_MAP
(
wÜk
, &
sc¡_£ss_d•_m­
);

4749 
	`kobjeù_g‘
(&
£ss
->
£ss_kobj
);

4751 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

4752 ià(
»s
 == 0)

4753 
»s
 = 
couÁ
;

4755 
out
:

4756 
	`TRACE_EXIT_RES
(
»s
);

4757  
»s
;

4758 
	}
}

4760 
kobj_©Œibu‹
 
	g£ssiÚ_dif_checks_çžed_©Œ
 =

4761 
__ATTR
(
dif_checks_çžed
, 
S_IRUGO
 | 
S_IWUSR
,

4762 
sc¡_£ss_sysfs_dif_checks_çžed_show
,

4763 
sc¡_£ss_sysfs_dif_checks_çžed_¡Üe
);

4765 
ssize_t
 
	$sc¡_£ss_sysfs_š™ŸtÜ_Çme_show
(
kobjeù
 *
kobj
,

4766 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

4768 
sc¡_£ssiÚ
 *
£ss
;

4770 
£ss
 = 
	`cÚš”_of
(
kobj
, 
sc¡_£ssiÚ
, 
£ss_kobj
);

4772  
	`sú´štf
(
buf
, 
SCST_SYSFS_BLOCK_SIZE
, "%s\n",

4773 
£ss
->
š™ŸtÜ_Çme
);

4774 
	}
}

4776 
kobj_©Œibu‹
 
	g£ssiÚ_š™ŸtÜ_Çme_©Œ
 =

4777 
__ATTR
(
š™ŸtÜ_Çme
, 
S_IRUGO
, 
sc¡_£ss_sysfs_š™ŸtÜ_Çme_show
,

4778 
NULL
);

4780 
	#SCST_SESS_SYSFS_STAT_ATTR
(
Çme
, 
expÜ‹d_Çme
, 
dœ
, 
kb
) \

4781 
ssize_t
 
sc¡_£ss_sysfs_
##
expÜ‹d_Çme
##
	`_show
(
kobjeù
 *
kobj
, \

4782 
kobj_©Œibu‹
 *
©Œ
, *
buf
) \

4784 
sc¡_£ssiÚ
 *
£ss
; \

4785 
»s
; \

4786 
ušt64_t
 
v
; \

4788 
	`BUILD_BUG_ON
(
SCST_DATA_UNKNOWN
 != 0); \

4789 
	`BUILD_BUG_ON
(
SCST_DATA_WRITE
 != 1); \

4790 
	`BUILD_BUG_ON
(
SCST_DATA_READ
 != 2); \

4791 
	`BUILD_BUG_ON
(
SCST_DATA_BIDI
 != 3); \

4792 
	`BUILD_BUG_ON
(
SCST_DATA_NONE
 != 4); \

4794 
	`BUILD_BUG_ON
(
dœ
 >ð
SCST_DATA_DIR_MAX
); \

4796 
£ss
 = 
	`cÚš”_of
(
kobj
, 
sc¡_£ssiÚ
, 
£ss_kobj
); \

4797 
v
 = 
£ss
->
io_¡©s
[
dœ
].
Çme
; \

4798 ià(
kb
) \

4799 
v
 >>= 10; \

4800 
»s
 = 
	`¥rštf
(
buf
, "%Îu\n", ()
v
); \

4801  
»s
; \

4804 
ssize_t
 
sc¡_£ss_sysfs_
##
expÜ‹d_Çme
##
	`_¡Üe
(
kobjeù
 *
kobj
, \

4805 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
) \

4807 
sc¡_£ssiÚ
 *
£ss
; \

4808 
£ss
 = 
	`cÚš”_of
(
kobj
, 
sc¡_£ssiÚ
, 
£ss_kobj
); \

4809 
	`¥š_lock_œq
(&
£ss
->
£ss_li¡_lock
); \

4810 
	`BUILD_BUG_ON
(
dœ
 >ð
SCST_DATA_DIR_MAX
); \

4811 
£ss
->
io_¡©s
[
dœ
].
cmd_couÁ
 = 0; \

4812 
£ss
->
io_¡©s
[
dœ
].
io_by‹_couÁ
 = 0; \

4813 
£ss
->
io_¡©s
[
dœ
].
uÇligÃd_cmd_couÁ
 = 0; \

4814 
	`¥š_uÆock_œq
(&
£ss
->
£ss_li¡_lock
); \

4815  
couÁ
; \

4818 
kobj_©Œibu‹
 
£ssiÚ_
##
expÜ‹d_Çme
##
_©Œ
 = \

4819 
	`__ATTR
(
expÜ‹d_Çme
, 
S_IRUGO
 | 
S_IWUSR
, \

4820 
sc¡_£ss_sysfs_
##
expÜ‹d_Çme
##
_show
, \

4821 
sc¡_£ss_sysfs_
##
expÜ‹d_Çme
##
_¡Üe
)

	)

4823 
SCST_SESS_SYSFS_STAT_ATTR
(
cmd_couÁ
, 
unknown_cmd_couÁ
, 
SCST_DATA_UNKNOWN
, 0);

4824 
SCST_SESS_SYSFS_STAT_ATTR
(
cmd_couÁ
, 
wr™e_cmd_couÁ
, 
SCST_DATA_WRITE
, 0);

4825 
SCST_SESS_SYSFS_STAT_ATTR
(
io_by‹_couÁ
, 
wr™e_io_couÁ_kb
, 
SCST_DATA_WRITE
, 1);

4826 
SCST_SESS_SYSFS_STAT_ATTR
(
uÇligÃd_cmd_couÁ
, 
wr™e_uÇligÃd_cmd_couÁ
, 
SCST_DATA_WRITE
, 0);

4827 
SCST_SESS_SYSFS_STAT_ATTR
(
cmd_couÁ
, 
»ad_cmd_couÁ
, 
SCST_DATA_READ
, 0);

4828 
SCST_SESS_SYSFS_STAT_ATTR
(
io_by‹_couÁ
, 
»ad_io_couÁ_kb
, 
SCST_DATA_READ
, 1);

4829 
SCST_SESS_SYSFS_STAT_ATTR
(
uÇligÃd_cmd_couÁ
, 
»ad_uÇligÃd_cmd_couÁ
, 
SCST_DATA_READ
, 0);

4830 
SCST_SESS_SYSFS_STAT_ATTR
(
cmd_couÁ
, 
bidi_cmd_couÁ
, 
SCST_DATA_BIDI
, 0);

4831 
SCST_SESS_SYSFS_STAT_ATTR
(
io_by‹_couÁ
, 
bidi_io_couÁ_kb
, 
SCST_DATA_BIDI
, 1);

4832 
SCST_SESS_SYSFS_STAT_ATTR
(
uÇligÃd_cmd_couÁ
, 
bidi_uÇligÃd_cmd_couÁ
, 
SCST_DATA_BIDI
, 0);

4833 
SCST_SESS_SYSFS_STAT_ATTR
(
cmd_couÁ
, 
nÚe_cmd_couÁ
, 
SCST_DATA_NONE
, 0);

4835 
ssize_t
 
	$sc¡_£ss_fÜû_þo£_¡Üe
(
kobjeù
 *
kobj
,

4836 
kobj_©Œibu‹
 *
©Œ
,

4837 cÚ¡ *
buf
, 
size_t
 
couÁ
)

4839 
sc¡_£ssiÚ
 *
£ss
 = 
	`cÚš”_of
(
kobj
, scst_session,

4840 
£ss_kobj
);

4841 
»s
;

4843 
»s
 = 
£ss
->
tgt
->
tg‰
->
	`þo£_£ssiÚ
(sess);

4844 ià(
»s
 < 0)

4845 
out
;

4846 
»s
 = 
couÁ
;

4848 
out
:

4849  
»s
;

4850 
	}
}

4852 
kobj_©Œibu‹
 
	g£ssiÚ_fÜû_þo£_©Œ
 =

4853 
__ATTR
(
fÜû_þo£
, 
S_IWUSR
, 
NULL
, 
sc¡_£ss_fÜû_þo£_¡Üe
);

4856 
©Œibu‹
 *
	gsc¡_£ssiÚ_©Œs
[] = {

4857 &
£ssiÚ_commªds_©Œ
.
©Œ
,

4858 &
£ssiÚ_aùive_commªds_©Œ
.
©Œ
,

4859 &
£ssiÚ_š™ŸtÜ_Çme_©Œ
.
©Œ
,

4860 &
£ssiÚ_unknown_cmd_couÁ_©Œ
.
©Œ
,

4861 &
£ssiÚ_wr™e_cmd_couÁ_©Œ
.
©Œ
,

4862 &
£ssiÚ_wr™e_io_couÁ_kb_©Œ
.
©Œ
,

4863 &
£ssiÚ_wr™e_uÇligÃd_cmd_couÁ_©Œ
.
©Œ
,

4864 &
£ssiÚ_»ad_cmd_couÁ_©Œ
.
©Œ
,

4865 &
£ssiÚ_»ad_io_couÁ_kb_©Œ
.
©Œ
,

4866 &
£ssiÚ_»ad_uÇligÃd_cmd_couÁ_©Œ
.
©Œ
,

4867 &
£ssiÚ_bidi_cmd_couÁ_©Œ
.
©Œ
,

4868 &
£ssiÚ_bidi_io_couÁ_kb_©Œ
.
©Œ
,

4869 &
£ssiÚ_bidi_uÇligÃd_cmd_couÁ_©Œ
.
©Œ
,

4870 &
£ssiÚ_nÚe_cmd_couÁ_©Œ
.
©Œ
,

4871 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


4872 &
£ssiÚ_Ï‹ncy_©Œ
.
©Œ
,

4874 
NULL
,

4877 
	$sc¡_sysfs_£ssiÚ_»Ëa£
(
kobjeù
 *
kobj
)

4879 
sc¡_£ssiÚ
 *
£ss
;

4881 
	`TRACE_ENTRY
();

4883 
£ss
 = 
	`cÚš”_of
(
kobj
, 
sc¡_£ssiÚ
, 
£ss_kobj
);

4884 ià(
£ss
->
£ss_kobj_»Ëa£_cm¶
)

4885 
	`com¶‘e_®l
(
£ss
->
£ss_kobj_»Ëa£_cm¶
);

4887 
	`TRACE_EXIT
();

4889 
	}
}

4891 
kobj_ty³
 
	gsc¡_£ssiÚ_kty³
 = {

4892 .
sysfs_Ýs
 = &
sc¡_sysfs_Ýs
,

4893 .
	g»Ëa£
 = 
sc¡_sysfs_£ssiÚ_»Ëa£
,

4894 .
	gdeçuÉ_©Œs
 = 
sc¡_£ssiÚ_©Œs
,

4897 
	$sc¡_ü—‹_£ss_luns_lšk
(
sc¡_£ssiÚ
 *
£ss
)

4899 
»s
;

4906 ià(
£ss
->
acg
 =ð£ss->
tgt
->
deçuÉ_acg
)

4907 
»s
 = 
	`sysfs_ü—‹_lšk
(&
£ss
->
£ss_kobj
,

4908 
£ss
->
tgt
->
tgt_luns_kobj
, "luns");

4910 
»s
 = 
	`sysfs_ü—‹_lšk
(&
£ss
->
£ss_kobj
,

4911 
£ss
->
acg
->
luns_kobj
, "luns");

4913 ià(
»s
 != 0)

4914 
	`PRINT_ERROR
("Can't create†uns†ink for initiator %s",

4915 
£ss
->
š™ŸtÜ_Çme
);

4917  
»s
;

4918 
	}
}

4920 
	$sc¡_»ü—‹_£ss_luns_lšk
(
sc¡_£ssiÚ
 *
£ss
)

4922 
	`sysfs_»move_lšk
(&
£ss
->
£ss_kobj
, "luns");

4923  
	`sc¡_ü—‹_£ss_luns_lšk
(
£ss
);

4924 
	}
}

4927 
	$sc¡_£ss_sysfs_ü—‹
(
sc¡_£ssiÚ
 *
£ss
)

4929 
»s
 = 0;

4930 cÚ¡ *
Çme
;

4932 
	`TRACE_ENTRY
();

4934 
Çme
 = 
£ss
->
£ss_Çme
;

4935 
	`TRACE_DBG
("Addšg sessiÚ % tØsysfs", 
Çme
);

4937 
»s
 = 
	`kobjeù_š™_ªd_add
(&
£ss
->
£ss_kobj
, &
sc¡_£ssiÚ_kty³
,

4938 
£ss
->
tgt
->
tgt_£ss_kobj
, 
Çme
);

4939 ià(
»s
 != 0) {

4940 
	`PRINT_ERROR
("Cª'ˆadd sessiÚ % tØsysfs", 
Çme
);

4941 
out
;

4944 
£ss
->
£ss_kobj_»ady
 = 1;

4946 ià(
£ss
->
tgt
->
tg‰
->
þo£_£ssiÚ
) {

4947 
»s
 = 
	`sysfs_ü—‹_fže
(&
£ss
->
£ss_kobj
,

4948 &
£ssiÚ_fÜû_þo£_©Œ
.
©Œ
);

4949 ià(
»s
 != 0) {

4950 
	`PRINT_ERROR
("Adding force_close sysfs‡ttributeo session %s failed (%d)",

4951 
Çme
, 
»s
);

4952 
out_d–
;

4956 ià(
£ss
->
tgt
->
tgt_dif_suµÜ‹d
) {

4957 
»s
 = 
	`sysfs_ü—‹_fže
(&
£ss
->
£ss_kobj
,

4958 &
£ssiÚ_dif_checks_çžed_©Œ
.
©Œ
);

4959 ià(
»s
 != 0) {

4960 
	`PRINT_ERROR
("Adding %s sysfs‡ttributeo session %s "

4961 "çžed (%d)", 
£ssiÚ_dif_checks_çžed_©Œ
.
©Œ
.
Çme
,

4962 
Çme
, 
»s
);

4963 
out_d–
;

4967 ià(
£ss
->
tgt
->
tg‰
->
£ss_©Œs
) {

4968 
»s
 = 
	`sysfs_ü—‹_fžes
(&
£ss
->
£ss_kobj
,

4969 
£ss
->
tgt
->
tg‰
->
£ss_©Œs
);

4970 ià(
»s
 != 0) {

4971 
	`PRINT_ERROR
("Cª'ˆadd‡‰ribu‹ fÜ sessiÚ %s", 
Çme
);

4972 
out_d–
;

4976 
»s
 = 
	`sc¡_ü—‹_£ss_luns_lšk
(
£ss
);

4977 ià(
»s
 != 0) {

4978 
	`PRINT_ERROR
("Cª'ˆadd LUN†šk fÜ sessiÚ %s", 
Çme
);

4979 
out_d–
;

4982 
out
:

4983 
	`TRACE_EXIT_RES
(
»s
);

4984  
»s
;

4986 
out_d–
:

4987 
	`kobjeù_d–
(&
£ss
->
£ss_kobj
);

4988 
	`kobjeù_put
(&
£ss
->
£ss_kobj
);

4989 
£ss
->
£ss_kobj_»ady
 = 0;

4990 
out
;

4991 
	}
}

4998 
	$sc¡_£ss_sysfs_d–
(
sc¡_£ssiÚ
 *
£ss
)

5000 
	`DECLARE_COMPLETION_ONSTACK
(
c
);

5002 
	`TRACE_ENTRY
();

5004 ià(!
£ss
->
£ss_kobj_»ady
)

5005 
out
;

5007 
	`TRACE_DBG
("Deleting session %s from sysfs",

5008 
	`kobjeù_Çme
(&
£ss
->
£ss_kobj
));

5010 
£ss
->
£ss_kobj_»Ëa£_cm¶
 = &
c
;

5012 
	`kobjeù_d–
(&
£ss
->
£ss_kobj
);

5014 
	`SCST_KOBJECT_PUT_AND_WAIT
(&
£ss
->
£ss_kobj
, "£ssiÚ", &
c
,

5015 &
sc¡_£ss_d•_m­
);

5017 
out
:

5018 
	`TRACE_EXIT
();

5020 
	}
}

5026 
	$sc¡_acg_dev_»Ëa£
(
kobjeù
 *
kobj
)

5028 
sc¡_acg_dev
 *
acg_dev
;

5030 
	`TRACE_ENTRY
();

5032 
acg_dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_acg_dev
, 
acg_dev_kobj
);

5033 ià(
acg_dev
->
acg_dev_kobj_»Ëa£_cm¶
)

5034 
	`com¶‘e_®l
(
acg_dev
->
acg_dev_kobj_»Ëa£_cm¶
);

5036 
	`TRACE_EXIT
();

5038 
	}
}

5040 
ssize_t
 
	$sc¡_lun_rd_Úly_show
(
kobjeù
 *
kobj
,

5041 
kobj_©Œibu‹
 *
©Œ
,

5042 *
buf
)

5044 
sc¡_acg_dev
 *
acg_dev
;

5046 
acg_dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_acg_dev
, 
acg_dev_kobj
);

5048 ià(
acg_dev
->
acg_dev_rd_Úly
 ||‡cg_dev->
dev
->
dev_rd_Úly
)

5049  
	`¥rštf
(
buf
, "%d\n%s\n", 1, 
SCST_SYSFS_KEY_MARK
);

5051  
	`¥rštf
(
buf
, "%d\n", 0);

5052 
	}
}

5054 
kobj_©Œibu‹
 
	glun_ÝtiÚs_©Œ
 =

5055 
__ATTR
(
»ad_Úly
, 
S_IRUGO
, 
sc¡_lun_rd_Úly_show
, 
NULL
);

5057 
©Œibu‹
 *
	glun_©Œs
[] = {

5058 &
lun_ÝtiÚs_©Œ
.
©Œ
,

5059 
NULL
,

5062 
kobj_ty³
 
	gacg_dev_kty³
 = {

5063 .
sysfs_Ýs
 = &
sc¡_sysfs_Ýs
,

5064 .
	g»Ëa£
 = 
sc¡_acg_dev_»Ëa£
,

5065 .
	gdeçuÉ_©Œs
 = 
lun_©Œs
,

5075 
	$sc¡_acg_dev_sysfs_d–
(
sc¡_acg_dev
 *
acg_dev
)

5077 
	`DECLARE_COMPLETION_ONSTACK
(
c
);

5079 
	`TRACE_ENTRY
();

5081 
acg_dev
->
acg_dev_kobj_»Ëa£_cm¶
 = &
c
;

5083 ià(
acg_dev
->
dev
 !ð
NULL
) {

5084 
	`sysfs_»move_lšk
(
acg_dev
->
dev
->
dev_exp_kobj
,

5085 
acg_dev
->
acg_dev_lšk_Çme
);

5086 
	`kobjeù_put
(&
acg_dev
->
dev
->
dev_kobj
);

5089 
	`kobjeù_d–
(&
acg_dev
->
acg_dev_kobj
);

5091 
	`SCST_KOBJECT_PUT_AND_WAIT
(&
acg_dev
->
acg_dev_kobj
, "acg_dev", &
c
,

5092 &
sc¡_acg_dev_d•_m­
);

5094 
	`TRACE_EXIT
();

5096 
	}
}

5098 
	$sc¡_acg_dev_sysfs_ü—‹
(
sc¡_acg_dev
 *
acg_dev
,

5099 
kobjeù
 *
·»Á
)

5101 
»s
;

5103 
	`TRACE_ENTRY
();

5105 
»s
 = 
	`kobjeù_š™_ªd_add
(&
acg_dev
->
acg_dev_kobj
, &
acg_dev_kty³
,

5106 
·»Á
, "%Îu", 
acg_dev
->
lun
);

5107 ià(
»s
 != 0) {

5108 
	`PRINT_ERROR
("Cª'ˆadd‡cg_dev %°tØsysfs", 
acg_dev
);

5109 
out
;

5112 
	`kobjeù_g‘
(&
acg_dev
->
dev
->
dev_kobj
);

5114 
	`¢´štf
(
acg_dev
->
acg_dev_lšk_Çme
, (acg_dev->acg_dev_link_name),

5115 "expÜt%u", 
acg_dev
->
dev
->
dev_expÜ‹d_lun_num
++);

5117 
»s
 = 
	`sysfs_ü—‹_lšk
(
acg_dev
->
dev
->
dev_exp_kobj
,

5118 &
acg_dev
->
acg_dev_kobj
,‡cg_dev->
acg_dev_lšk_Çme
);

5119 ià(
»s
 != 0) {

5120 
	`PRINT_ERROR
("Can't create‡cg %s LUN†ink",

5121 
acg_dev
->
acg
->
acg_Çme
);

5122 
out_d–
;

5125 
»s
 = 
	`sysfs_ü—‹_lšk
(&
acg_dev
->
acg_dev_kobj
,

5126 &
acg_dev
->
dev
->
dev_kobj
, "device");

5127 ià(
»s
 != 0) {

5128 
	`PRINT_ERROR
("Can't create‡cg %s device†ink",

5129 
acg_dev
->
acg
->
acg_Çme
);

5130 
out_d–
;

5133 
out
:

5134  
»s
;

5136 
out_d–
:

5137 
	`sc¡_acg_dev_sysfs_d–
(
acg_dev
);

5138 
out
;

5139 
	}
}

5145 
	$sc¡_acg_»Ëa£
(
kobjeù
 *
kobj
)

5147 
sc¡_acg
 *
acg
;

5149 
	`TRACE_ENTRY
();

5151 
acg
 = 
	`cÚš”_of
(
kobj
, 
sc¡_acg
, 
acg_kobj
);

5152 ià(
acg
->
acg_kobj_»Ëa£_cm¶
)

5153 
	`com¶‘e_®l
(
acg
->
acg_kobj_»Ëa£_cm¶
);

5155 
	`TRACE_EXIT
();

5157 
	}
}

5159 
kobj_ty³
 
	gacg_kty³
 = {

5160 .
sysfs_Ýs
 = &
sc¡_sysfs_Ýs
,

5161 .
	g»Ëa£
 = 
sc¡_acg_»Ëa£
,

5164 
ssize_t
 
	$sc¡_acg_ši_mgmt_show
(
kobjeù
 *
kobj
,

5165 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

5167 cÚ¡ 
h–p
[] =

5173  
	`¥rštf
(
buf
, "%s", 
h–p
);

5174 
	}
}

5176 
	$sc¡_´oûss_acg_ši_mgmt_¡Üe
(*
bufãr
,

5177 
sc¡_tgt
 *
tgt
, 
sc¡_acg
 *
acg
)

5179 
»s
, 
aùiÚ
;

5180 *
p
, *
µ
, *
Çme
, *
group
;

5181 
sc¡_acg
 *
acg_de¡
 = 
NULL
;

5182 
sc¡_aú
 *
aú
 = 
NULL
, *
aú_tmp
;

5184 
SCST_ACG_ACTION_INI_ADD
 = 1,

5185 
SCST_ACG_ACTION_INI_DEL
 = 2,

5186 
SCST_ACG_ACTION_INI_CLEAR
 = 3,

5187 
SCST_ACG_ACTION_INI_MOVE
 = 4,

5190 
	`TRACE_ENTRY
();

5192 
	`TRACE_DBG
("tgˆ%p,‡cg %p, bufã¸%s", 
tgt
, 
acg
, 
bufãr
);

5194 
µ
 = 
bufãr
;

5195 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

5196 ià(
	`¡rÿ£cmp
("add", 
p
) == 0) {

5197 
aùiÚ
 = 
SCST_ACG_ACTION_INI_ADD
;

5198 } ià(
	`¡rÿ£cmp
("d–", 
p
) == 0) {

5199 
aùiÚ
 = 
SCST_ACG_ACTION_INI_DEL
;

5200 } ià(
	`¡rÿ£cmp
("þ—r", 
p
) == 0) {

5201 
aùiÚ
 = 
SCST_ACG_ACTION_INI_CLEAR
;

5202 } ià(
	`¡rÿ£cmp
("move", 
p
) == 0) {

5203 
aùiÚ
 = 
SCST_ACG_ACTION_INI_MOVE
;

5205 
	`PRINT_ERROR
("UnknowÀaùiÚ \"%s\"", 
p
);

5206 
»s
 = -
EINVAL
;

5207 
out
;

5210 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
SCST_SUSPEND_TIMEOUT_USER
);

5211 ià(
»s
 != 0)

5212 
out
;

5214 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

5215 ià(
»s
 != 0)

5216 
out_»sume
;

5219 ià(
	`sc¡_check_tgt_acg_±rs
(
tgt
, 
acg
) != 0)

5220 
out_uÆock
;

5222 
aùiÚ
) {

5223 
SCST_ACG_ACTION_INI_ADD
:

5224 
Çme
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

5225 ià(
Çme
[0] == '\0') {

5226 
	`PRINT_ERROR
("%s", "Invalid initiator‚ame");

5227 
»s
 = -
EINVAL
;

5228 
out_uÆock
;

5231 
»s
 = 
	`sc¡_acg_add_aú
(
acg
, 
Çme
);

5232 ià(
»s
 != 0)

5233 
out_uÆock
;

5235 
SCST_ACG_ACTION_INI_DEL
:

5236 
Çme
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

5237 ià(
Çme
[0] == '\0') {

5238 
	`PRINT_ERROR
("%s", "Invalid initiator‚ame");

5239 
»s
 = -
EINVAL
;

5240 
out_uÆock
;

5243 
aú
 = 
	`sc¡_fšd_aú
(
acg
, 
Çme
);

5244 ià(
aú
 =ð
NULL
) {

5245 
	`PRINT_ERROR
("Unableo find "

5247 
Çme
, 
acg
->
acg_Çme
);

5248 
»s
 = -
EINVAL
;

5249 
out_uÆock
;

5251 
	`sc¡_d–_ä“_aú
(
aú
, 
Œue
);

5253 
SCST_ACG_ACTION_INI_CLEAR
:

5254 
	`li¡_fÜ_—ch_’Œy_§ã
(
aú
, 
aú_tmp
, &
acg
->
aú_li¡
,

5255 
aú_li¡_’Œy
) {

5256 
	`sc¡_d–_ä“_aú
(
aú
, 
çl£
);

5258 
	`sc¡_check_»assign_£ssiÚs
();

5260 
SCST_ACG_ACTION_INI_MOVE
:

5261 
Çme
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

5262 ià(
Çme
[0] == '\0') {

5263 
	`PRINT_ERROR
("%s", "Invalid initiator‚ame");

5264 
»s
 = -
EINVAL
;

5265 
out_uÆock
;

5268 
group
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

5269 ià(
group
[0] == '\0') {

5270 
	`PRINT_ERROR
("%s", "Invalid group‚ame");

5271 
»s
 = -
EINVAL
;

5272 
out_uÆock
;

5275 
	`TRACE_DBG
("Move initiator '%s'o group '%s'",

5276 
Çme
, 
group
);

5278 
aú
 = 
	`sc¡_fšd_aú
(
acg
, 
Çme
);

5279 ià(
aú
 =ð
NULL
) {

5280 
	`PRINT_ERROR
("Unableo find "

5282 
Çme
, 
acg
->
acg_Çme
);

5283 
»s
 = -
EINVAL
;

5284 
out_uÆock
;

5286 
acg_de¡
 = 
	`sc¡_tgt_fšd_acg
(
tgt
, 
group
);

5287 ià(
acg_de¡
 =ð
NULL
) {

5288 
	`PRINT_ERROR
("Unableo find group '%s' inarget '%s'",

5289 
group
, 
tgt
->
tgt_Çme
);

5290 
»s
 = -
EINVAL
;

5291 
out_uÆock
;

5293 ià(
	`sc¡_fšd_aú
(
acg_de¡
, 
Çme
è!ð
NULL
) {

5294 
	`PRINT_ERROR
("Initiator '%s'‡lreadyƒxists in group '%s'",

5295 
Çme
, 
acg_de¡
->
acg_Çme
);

5296 
»s
 = -
EEXIST
;

5297 
out_uÆock
;

5299 
	`sc¡_d–_ä“_aú
(
aú
, 
çl£
);

5301 
»s
 = 
	`sc¡_acg_add_aú
(
acg_de¡
, 
Çme
);

5302 ià(
»s
 != 0)

5303 
out_uÆock
;

5307 
»s
 = 0;

5309 
out_uÆock
:

5310 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

5312 
out_»sume
:

5313 
	`sc¡_»sume_aùiv™y
();

5315 
out
:

5316 
	`TRACE_EXIT_RES
(
»s
);

5317  
»s
;

5318 
	}
}

5320 
	$sc¡_acg_ši_mgmt_¡Üe_wÜk_â
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

5322  
	`sc¡_´oûss_acg_ši_mgmt_¡Üe
(
wÜk
->
buf
, wÜk->
tgt
, wÜk->
acg
);

5323 
	}
}

5325 
ssize_t
 
	$sc¡_acg_ši_mgmt_¡Üe
(
kobjeù
 *
kobj
,

5326 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

5328 
sc¡_acg
 *
acg
;

5330 
acg
 = 
	`cÚš”_of
(
kobj
->
·»Á
, 
sc¡_acg
, 
acg_kobj
);

5332  
	`__sc¡_acg_mgmt_¡Üe
(
acg
, 
buf
, 
couÁ
, 
çl£
,

5333 
sc¡_acg_ši_mgmt_¡Üe_wÜk_â
);

5334 
	}
}

5336 
kobj_©Œibu‹
 
	gsc¡_acg_ši_mgmt
 =

5337 
__ATTR
(
mgmt
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_acg_ši_mgmt_show
,

5338 
sc¡_acg_ši_mgmt_¡Üe
);

5340 
ssize_t
 
	$sc¡_acg_luns_mgmt_¡Üe
(
kobjeù
 *
kobj
,

5341 
kobj_©Œibu‹
 *
©Œ
,

5342 cÚ¡ *
buf
, 
size_t
 
couÁ
)

5344 
»s
;

5345 
sc¡_acg
 *
acg
;

5347 
acg
 = 
	`cÚš”_of
(
kobj
->
·»Á
, 
sc¡_acg
, 
acg_kobj
);

5348 
»s
 = 
	`__sc¡_luns_mgmt_¡Üe
(
acg
, 
çl£
, 
buf
, 
couÁ
);

5350 
	`TRACE_EXIT_RES
(
»s
);

5351  
»s
;

5352 
	}
}

5354 
kobj_©Œibu‹
 
	gsc¡_acg_luns_mgmt
 =

5355 
__ATTR
(
mgmt
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_luns_mgmt_show
,

5356 
sc¡_acg_luns_mgmt_¡Üe
);

5358 
ssize_t
 
	$sc¡_acg_addr_m‘hod_show
(
kobjeù
 *
kobj
,

5359 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

5361 
sc¡_acg
 *
acg
;

5363 
acg
 = 
	`cÚš”_of
(
kobj
, 
sc¡_acg
, 
acg_kobj
);

5365  
	`__sc¡_acg_addr_m‘hod_show
(
acg
, 
buf
);

5366 
	}
}

5368 
ssize_t
 
	$sc¡_acg_addr_m‘hod_¡Üe
(
kobjeù
 *
kobj
,

5369 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

5371 
»s
;

5372 
sc¡_acg
 *
acg
;

5374 
acg
 = 
	`cÚš”_of
(
kobj
, 
sc¡_acg
, 
acg_kobj
);

5376 
»s
 = 
	`__sc¡_acg_addr_m‘hod_¡Üe
(
acg
, 
buf
, 
couÁ
);

5378 
	`TRACE_EXIT_RES
(
»s
);

5379  
»s
;

5380 
	}
}

5382 
kobj_©Œibu‹
 
	gsc¡_acg_addr_m‘hod
 =

5383 
__ATTR
(
addr_m‘hod
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_acg_addr_m‘hod_show
,

5384 
sc¡_acg_addr_m‘hod_¡Üe
);

5386 
ssize_t
 
	$sc¡_acg_io_groupšg_ty³_show
(
kobjeù
 *
kobj
,

5387 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

5389 
sc¡_acg
 *
acg
;

5391 
acg
 = 
	`cÚš”_of
(
kobj
, 
sc¡_acg
, 
acg_kobj
);

5393  
	`__sc¡_acg_io_groupšg_ty³_show
(
acg
, 
buf
);

5394 
	}
}

5396 
ssize_t
 
	$sc¡_acg_io_groupšg_ty³_¡Üe
(
kobjeù
 *
kobj
,

5397 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

5399 
»s
;

5400 
sc¡_acg
 *
acg
;

5402 
acg
 = 
	`cÚš”_of
(
kobj
, 
sc¡_acg
, 
acg_kobj
);

5404 
»s
 = 
	`__sc¡_acg_io_groupšg_ty³_¡Üe
(
acg
, 
buf
, 
couÁ
);

5405 ià(
»s
 != 0)

5406 
out
;

5408 
»s
 = 
couÁ
;

5410 
out
:

5411 
	`TRACE_EXIT_RES
(
»s
);

5412  
»s
;

5413 
	}
}

5415 
kobj_©Œibu‹
 
	gsc¡_acg_io_groupšg_ty³
 =

5416 
__ATTR
(
io_groupšg_ty³
, 
S_IRUGO
 | 
S_IWUSR
,

5417 
sc¡_acg_io_groupšg_ty³_show
,

5418 
sc¡_acg_io_groupšg_ty³_¡Üe
);

5420 
ssize_t
 
	$sc¡_acg_bÏck_hÞe_show
(
kobjeù
 *
kobj
,

5421 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

5423 
sc¡_acg
 *
acg
;

5425 
acg
 = 
	`cÚš”_of
(
kobj
, 
sc¡_acg
, 
acg_kobj
);

5427  
	`__sc¡_acg_bÏck_hÞe_show
(
acg
, 
buf
);

5428 
	}
}

5430 
ssize_t
 
	$sc¡_acg_bÏck_hÞe_¡Üe
(
kobjeù
 *
kobj
,

5431 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

5433 
»s
;

5434 
sc¡_acg
 *
acg
;

5436 
acg
 = 
	`cÚš”_of
(
kobj
, 
sc¡_acg
, 
acg_kobj
);

5438 
»s
 = 
	`__sc¡_acg_bÏck_hÞe_¡Üe
(
acg
, 
buf
, 
couÁ
);

5439 ià(
»s
 != 0)

5440 
out
;

5442 
»s
 = 
couÁ
;

5444 
out
:

5445 
	`TRACE_EXIT_RES
(
»s
);

5446  
»s
;

5447 
	}
}

5449 
kobj_©Œibu‹
 
	gsc¡_acg_bÏck_hÞe
 =

5450 
__ATTR
(
bÏck_hÞe
, 
S_IRUGO
 | 
S_IWUSR
,

5451 
sc¡_acg_bÏck_hÞe_show
, 
sc¡_acg_bÏck_hÞe_¡Üe
);

5453 
ssize_t
 
	$sc¡_acg_ýu_mask_show
(
kobjeù
 *
kobj
,

5454 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

5456 
sc¡_acg
 *
acg
;

5458 
acg
 = 
	`cÚš”_of
(
kobj
, 
sc¡_acg
, 
acg_kobj
);

5460  
	`__sc¡_acg_ýu_mask_show
(
acg
, 
buf
);

5461 
	}
}

5463 
ssize_t
 
	$sc¡_acg_ýu_mask_¡Üe
(
kobjeù
 *
kobj
,

5464 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

5466 
»s
;

5467 
sc¡_acg
 *
acg
;

5469 
acg
 = 
	`cÚš”_of
(
kobj
, 
sc¡_acg
, 
acg_kobj
);

5471 
»s
 = 
	`__sc¡_acg_ýu_mask_¡Üe
(
acg
, 
buf
, 
couÁ
);

5472 ià(
»s
 != 0)

5473 
out
;

5475 
»s
 = 
couÁ
;

5477 
out
:

5478 
	`TRACE_EXIT_RES
(
»s
);

5479  
»s
;

5480 
	}
}

5482 
kobj_©Œibu‹
 
	gsc¡_acg_ýu_mask
 =

5483 
__ATTR
(
ýu_mask
, 
S_IRUGO
 | 
S_IWUSR
,

5484 
sc¡_acg_ýu_mask_show
,

5485 
sc¡_acg_ýu_mask_¡Üe
);

5494 
	$sc¡_acg_sysfs_d–
(
sc¡_acg
 *
acg
)

5496 
	`DECLARE_COMPLETION_ONSTACK
(
c
);

5498 
	`TRACE_ENTRY
();

5500 
acg
->
acg_kobj_»Ëa£_cm¶
 = &
c
;

5502 
	`kobjeù_d–
(
acg
->
luns_kobj
);

5503 
	`kobjeù_d–
(
acg
->
š™ŸtÜs_kobj
);

5504 
	`kobjeù_d–
(&
acg
->
acg_kobj
);

5506 
	`kobjeù_put
(
acg
->
luns_kobj
);

5507 
	`kobjeù_put
(
acg
->
š™ŸtÜs_kobj
);

5509 
	`SCST_KOBJECT_PUT_AND_WAIT
(&
acg
->
acg_kobj
, "acg", &
c
,

5510 &
sc¡_acg_d•_m­
);

5512 
	`TRACE_EXIT
();

5514 
	}
}

5516 
	$sc¡_acg_sysfs_ü—‹
(
sc¡_tgt
 *
tgt
,

5517 
sc¡_acg
 *
acg
)

5519 
»s
 = 0;

5521 
	`TRACE_ENTRY
();

5523 
»s
 = 
	`kobjeù_š™_ªd_add
(&
acg
->
acg_kobj
, &
acg_kty³
,

5524 
tgt
->
tgt_ši_g½_kobj
, 
acg
->
acg_Çme
);

5525 ià(
»s
 != 0) {

5526 
	`PRINT_ERROR
("Cª'ˆadd‡cg '%s'Øsysfs", 
acg
->
acg_Çme
);

5527 
out
;

5530 
acg
->
luns_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("luns", &acg->
acg_kobj
);

5531 ià(
acg
->
luns_kobj
 =ð
NULL
) {

5532 
	`PRINT_ERROR
("Can't create†uns kobj forgt %s",

5533 
tgt
->
tgt_Çme
);

5534 
»s
 = -
ENOMEM
;

5535 
out_d–
;

5538 
»s
 = 
	`sysfs_ü—‹_fže
(
acg
->
luns_kobj
, &
sc¡_acg_luns_mgmt
.
©Œ
);

5539 ià(
»s
 != 0) {

5540 
	`PRINT_ERROR
("Can't‡ddgt‡ttr %s forgt %s",

5541 
sc¡_acg_luns_mgmt
.
©Œ
.
Çme
, 
tgt
->
tgt_Çme
);

5542 
out_d–
;

5545 
acg
->
š™ŸtÜs_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("initiators",

5546 &
acg
->
acg_kobj
);

5547 ià(
acg
->
š™ŸtÜs_kobj
 =ð
NULL
) {

5548 
	`PRINT_ERROR
("Can't create initiators kobj forgt %s",

5549 
tgt
->
tgt_Çme
);

5550 
»s
 = -
ENOMEM
;

5551 
out_d–
;

5554 
»s
 = 
	`sysfs_ü—‹_fže
(
acg
->
š™ŸtÜs_kobj
,

5555 &
sc¡_acg_ši_mgmt
.
©Œ
);

5556 ià(
»s
 != 0) {

5557 
	`PRINT_ERROR
("Can't‡ddgt‡ttr %s forgt %s",

5558 
sc¡_acg_ši_mgmt
.
©Œ
.
Çme
, 
tgt
->
tgt_Çme
);

5559 
out_d–
;

5562 
»s
 = 
	`sysfs_ü—‹_fže
(&
acg
->
acg_kobj
, &
sc¡_acg_addr_m‘hod
.
©Œ
);

5563 ià(
»s
 != 0) {

5564 
	`PRINT_ERROR
("Can't‡ddgt‡ttr %s forgt %s",

5565 
sc¡_acg_addr_m‘hod
.
©Œ
.
Çme
, 
tgt
->
tgt_Çme
);

5566 
out_d–
;

5569 
»s
 = 
	`sysfs_ü—‹_fže
(&
acg
->
acg_kobj
, &
sc¡_acg_io_groupšg_ty³
.
©Œ
);

5570 ià(
»s
 != 0) {

5571 
	`PRINT_ERROR
("Can't‡ddgt‡ttr %s forgt %s",

5572 
sc¡_acg_io_groupšg_ty³
.
©Œ
.
Çme
, 
tgt
->
tgt_Çme
);

5573 
out_d–
;

5576 
»s
 = 
	`sysfs_ü—‹_fže
(&
acg
->
acg_kobj
, &
sc¡_acg_bÏck_hÞe
.
©Œ
);

5577 ià(
»s
 != 0) {

5578 
	`PRINT_ERROR
("Can't‡ddgt‡ttr %s forgt %s",

5579 
sc¡_acg_bÏck_hÞe
.
©Œ
.
Çme
, 
tgt
->
tgt_Çme
);

5580 
out_d–
;

5583 
»s
 = 
	`sysfs_ü—‹_fže
(&
acg
->
acg_kobj
, &
sc¡_acg_ýu_mask
.
©Œ
);

5584 ià(
»s
 != 0) {

5585 
	`PRINT_ERROR
("Can't‡ddgt‡ttr %s forgt %s",

5586 
sc¡_acg_ýu_mask
.
©Œ
.
Çme
, 
tgt
->
tgt_Çme
);

5587 
out_d–
;

5590 
out
:

5591 
	`TRACE_EXIT_RES
(
»s
);

5592  
»s
;

5594 
out_d–
:

5595 
	`sc¡_acg_sysfs_d–
(
acg
);

5596 
out
;

5597 
	}
}

5603 
ssize_t
 
	$sc¡_aú_fže_show
(
kobjeù
 *
kobj
,

5604 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

5606  
	`sú´štf
(
buf
, 
SCST_SYSFS_BLOCK_SIZE
, "%s\n",

5607 
©Œ
->©Œ.
Çme
);

5608 
	}
}

5610 
	$sc¡_aú_sysfs_ü—‹
(
sc¡_aú
 *
aú
)

5612 
»s
 = 0;

5613 
sc¡_acg
 *
acg
 = 
aú
->acg;

5614 
kobj_©Œibu‹
 *
©Œ
 = 
NULL
;

5615 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 34)

5616 #ifdeà
CONFIG_DEBUG_LOCK_ALLOC


5617 
lock_þass_key
 
__key
;

5621 
	`TRACE_ENTRY
();

5623 
aú
->
aú_©Œ
 = 
NULL
;

5625 
©Œ
 = 
	`kz®loc
((
kobj_©Œibu‹
), 
GFP_KERNEL
);

5626 ià(
©Œ
 =ð
NULL
) {

5627 
	`PRINT_ERROR
("Unableo‡llocate‡ttributes for initiator '%s'",

5628 
aú
->
Çme
);

5629 
»s
 = -
ENOMEM
;

5630 
out
;

5633 
©Œ
->©Œ.
Çme
 = 
	`k¡rdup
(
aú
->Çme, 
GFP_KERNEL
);

5634 ià(
©Œ
->©Œ.
Çme
 =ð
NULL
) {

5635 
	`PRINT_ERROR
("Unableo‡llocate‡ttributes for initiator '%s'",

5636 
aú
->
Çme
);

5637 
»s
 = -
ENOMEM
;

5638 
out_ä“
;

5641 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 36)

5642 
©Œ
->©Œ.
owÃr
 = 
THIS_MODULE
;

5644 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 34)

5645 #ifdeà
CONFIG_DEBUG_LOCK_ALLOC


5646 
©Œ
->©Œ.
key
 = &
__key
;

5650 
©Œ
->©Œ.
mode
 = 
S_IRUGO
;

5651 
©Œ
->
show
 = 
sc¡_aú_fže_show
;

5652 
©Œ
->
¡Üe
 = 
NULL
;

5654 
»s
 = 
	`sysfs_ü—‹_fže
(
acg
->
š™ŸtÜs_kobj
, &
©Œ
->attr);

5655 ià(
»s
 != 0) {

5656 
	`PRINT_ERROR
("Unableo create‡cn '%s' for group '%s'",

5657 
aú
->
Çme
, 
acg
->
acg_Çme
);

5658 
	`kä“
(
©Œ
->©Œ.
Çme
);

5659 
out_ä“
;

5662 
aú
->
aú_©Œ
 = 
©Œ
;

5664 
out
:

5665 
	`TRACE_EXIT_RES
(
»s
);

5666  
»s
;

5668 
out_ä“
:

5669 
	`kä“
(
©Œ
);

5670 
out
;

5671 
	}
}

5673 
	$sc¡_aú_sysfs_d–
(
sc¡_aú
 *
aú
)

5675 
sc¡_acg
 *
acg
 = 
aú
->acg;

5677 
	`TRACE_ENTRY
();

5679 ià(
aú
->
aú_©Œ
 !ð
NULL
) {

5680 
	`sysfs_»move_fže
(
acg
->
š™ŸtÜs_kobj
,

5681 &
aú
->
aú_©Œ
->
©Œ
);

5682 
	`kä“
(
aú
->
aú_©Œ
->
©Œ
.
Çme
);

5683 
	`kä“
(
aú
->
aú_©Œ
);

5686 
	`TRACE_EXIT
();

5688 
	}
}

5695 
	$sc¡_devt_»Ëa£
(
kobjeù
 *
kobj
)

5697 
sc¡_dev_ty³
 *
devt
;

5699 
	`TRACE_ENTRY
();

5701 
devt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_dev_ty³
, 
devt_kobj
);

5702 ià(
devt
->
devt_kobj_»Ëa£_com¶
)

5703 
	`com¶‘e_®l
(
devt
->
devt_kobj_»Ëa£_com¶
);

5705 
	`TRACE_EXIT
();

5707 
	}
}

5709 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

5711 
ssize_t
 
	$sc¡_devt_Œaû_Ëv–_show
(
kobjeù
 *
kobj
,

5712 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

5714 
sc¡_dev_ty³
 *
devt
;

5716 
devt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_dev_ty³
, 
devt_kobj
);

5718  
	`sc¡_Œaû_Ëv–_show
(
devt
->
Œaû_tbl
,

5719 
devt
->
Œaû_æags
 ? *devt->Œaû_æag : 0, 
buf
,

5720 
devt
->
Œaû_tbl_h–p
);

5721 
	}
}

5723 
ssize_t
 
	$sc¡_devt_Œaû_Ëv–_¡Üe
(
kobjeù
 *
kobj
,

5724 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

5726 
»s
;

5727 
sc¡_dev_ty³
 *
devt
;

5729 
	`TRACE_ENTRY
();

5731 
devt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_dev_ty³
, 
devt_kobj
);

5733 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_log_mu‹x
);

5734 ià(
»s
 != 0)

5735 
out
;

5737 
»s
 = 
	`sc¡_wr™e_Œaû
(
buf
, 
couÁ
, 
devt
->
Œaû_æags
,

5738 
devt
->
deçuÉ_Œaû_æags
, devt->
Çme
, devt->
Œaû_tbl
);

5740 
	`mu‹x_uÆock
(&
sc¡_log_mu‹x
);

5742 
out
:

5743 
	`TRACE_EXIT_RES
(
»s
);

5744  
»s
;

5745 
	}
}

5747 
kobj_©Œibu‹
 
	gdevt_Œaû_©Œ
 =

5748 
__ATTR
(
Œaû_Ëv–
, 
S_IRUGO
 | 
S_IWUSR
,

5749 
sc¡_devt_Œaû_Ëv–_show
, 
sc¡_devt_Œaû_Ëv–_¡Üe
);

5753 
ssize_t
 
	$sc¡_devt_ty³_show
(
kobjeù
 *
kobj
,

5754 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

5756 
pos
;

5757 
sc¡_dev_ty³
 *
devt
;

5759 
devt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_dev_ty³
, 
devt_kobj
);

5761 
pos
 = 
	`¥rštf
(
buf
, "%d - %s\n", 
devt
->
ty³
,

5762 ()
devt
->
ty³
 >ð
	`ARRAY_SIZE
(
sc¡_dev_hªdËr_ty³s
) ?

5763 "unknown" : 
sc¡_dev_hªdËr_ty³s
[
devt
->
ty³
]);

5765  
pos
;

5766 
	}
}

5768 
kobj_©Œibu‹
 
	gsc¡_devt_ty³_©Œ
 =

5769 
__ATTR
(
ty³
, 
S_IRUGO
, 
sc¡_devt_ty³_show
, 
NULL
);

5771 
©Œibu‹
 *
	gsc¡_devt_deçuÉ_©Œs
[] = {

5772 &
sc¡_devt_ty³_©Œ
.
©Œ
,

5773 
NULL
,

5776 
kobj_ty³
 
	gsc¡_devt_kty³
 = {

5777 .
sysfs_Ýs
 = &
sc¡_sysfs_Ýs
,

5778 .
	g»Ëa£
 = 
sc¡_devt_»Ëa£
,

5779 .
	gdeçuÉ_©Œs
 = 
sc¡_devt_deçuÉ_©Œs
,

5782 
ssize_t
 
	$sc¡_devt_mgmt_show
(
kobjeù
 *
kobj
,

5783 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

5785 cÚ¡ 
h–p
[] =

5794 
sc¡_dev_ty³
 *
devt
;

5796 
devt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_dev_ty³
, 
devt_kobj
);

5798  
	`sú´štf
(
buf
, 
SCST_SYSFS_BLOCK_SIZE
, 
h–p
,

5799 (
devt
->
devt_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ?

5802 (
devt
->
dev_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ?

5805 (
devt
->
mgmt_cmd_h–p
) ? devt->mgmt_cmd_help : "",

5806 (
devt
->
add_deviû_·¿m‘”s
 !ð
NULL
) ?

5808 (
devt
->
add_deviû_·¿m‘”s
 !ð
NULL
) ?

5809 
devt
->
add_deviû_·¿m‘”s
 : "",

5810 (
devt
->
devt_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ?

5812 (
devt
->
devt_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ?

5813 
devt
->
devt_ÝtiÚ®_©Œibu‹s
 : "",

5814 (
devt
->
devt_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ? "\n" : "",

5815 (
devt
->
dev_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ?

5817 (
devt
->
dev_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ?

5818 
devt
->
dev_ÝtiÚ®_©Œibu‹s
 : "",

5819 (
devt
->
dev_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ? "\n" : "");

5820 
	}
}

5822 
	$sc¡_´oûss_devt_mgmt_¡Üe
(*
bufãr
,

5823 
sc¡_dev_ty³
 *
devt
)

5825 
»s
 = 0;

5826 *
p
, *
µ
, *
dev_Çme
;

5828 
	`TRACE_ENTRY
();

5831 ià(
	`sc¡_check_g¿b_devt_±r
(
devt
, &
sc¡_vœtu®_dev_ty³_li¡
) != 0)

5832 
out
;

5834 
	`TRACE_DBG
("devˆ%p, bufã¸%s", 
devt
, 
bufãr
);

5836 
µ
 = 
bufãr
;

5837 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

5839 ià(
	`¡rÿ£cmp
("add_deviû", 
p
) == 0) {

5840 
dev_Çme
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

5841 ià(*
dev_Çme
 == '\0') {

5842 
	`PRINT_ERROR
("%s", "Device‚ame„equired");

5843 
»s
 = -
EINVAL
;

5844 
out_ung¿b
;

5846 
»s
 = 
devt
->
	`add_deviû
(
dev_Çme
, 
µ
);

5847 } ià(
	`¡rÿ£cmp
("d–_deviû", 
p
) == 0) {

5848 
dev_Çme
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

5849 ià(*
dev_Çme
 == '\0') {

5850 
	`PRINT_ERROR
("%s", "Device‚ame„equired");

5851 
»s
 = -
EINVAL
;

5852 
out_ung¿b
;

5855 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

5856 ià(*
p
 != '\0')

5857 
out_syÁax_”r
;

5859 
»s
 = 
devt
->
	`d–_deviû
(
dev_Çme
);

5860 } ià(
devt
->
mgmt_cmd
 !ð
NULL
) {

5861 
	`sc¡_»¡Üe_tok’_¡r
(
p
, 
µ
);

5862 
»s
 = 
devt
->
	`mgmt_cmd
(
bufãr
);

5864 
	`PRINT_ERROR
("UnknowÀaùiÚ \"%s\"", 
p
);

5865 
»s
 = -
EINVAL
;

5866 
out_ung¿b
;

5869 
out_ung¿b
:

5870 
	`sc¡_ung¿b_devt_±r
(
devt
);

5872 
out
:

5873 
	`TRACE_EXIT_RES
(
»s
);

5874  
»s
;

5876 
out_syÁax_”r
:

5877 
	`PRINT_ERROR
("SyÁaxƒ¼Ü oÀ\"%s\"", 
p
);

5878 
»s
 = -
EINVAL
;

5879 
out_ung¿b
;

5880 
	}
}

5882 
	$sc¡_devt_mgmt_¡Üe_wÜk_â
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

5884  
	`sc¡_´oûss_devt_mgmt_¡Üe
(
wÜk
->
buf
, wÜk->
devt
);

5885 
	}
}

5887 
ssize_t
 
__sc¡_devt_mgmt_¡Üe
(
kobjeù
 *
kobj
,

5888 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
,

5889 (*
sysfs_wÜk_â
)(
sc¡_sysfs_wÜk_™em
 *
wÜk
))

5891 
»s
;

5892 *
bufãr
;

5893 
sc¡_dev_ty³
 *
devt
;

5894 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

5896 
	`TRACE_ENTRY
();

5898 
devt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_dev_ty³
, 
devt_kobj
);

5900 
bufãr
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%.*s", ()
couÁ
, 
buf
);

5901 ià(
bufãr
 =ð
NULL
) {

5902 
»s
 = -
ENOMEM
;

5903 
out
;

5906 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sysfs_wÜk_â
, 
çl£
, &
wÜk
);

5907 ià(
»s
 != 0)

5908 
out_ä“
;

5910 
wÜk
->
buf
 = 
bufãr
;

5911 
wÜk
->
devt
 = devt;

5913 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

5914 ià(
»s
 == 0)

5915 
»s
 = 
couÁ
;

5917 
out
:

5918 
	`TRACE_EXIT_RES
(
»s
);

5919  
»s
;

5921 
out_ä“
:

5922 
	`kä“
(
bufãr
);

5923 
out
;

5924 
	}
}

5926 
ssize_t
 
	$sc¡_devt_mgmt_¡Üe
(
kobjeù
 *
kobj
,

5927 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

5929  
	`__sc¡_devt_mgmt_¡Üe
(
kobj
, 
©Œ
, 
buf
, 
couÁ
,

5930 
sc¡_devt_mgmt_¡Üe_wÜk_â
);

5931 
	}
}

5933 
kobj_©Œibu‹
 
	gsc¡_devt_mgmt
 =

5934 
__ATTR
(
mgmt
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_devt_mgmt_show
,

5935 
sc¡_devt_mgmt_¡Üe
);

5937 
ssize_t
 
	$sc¡_devt_·ss_through_mgmt_show
(
kobjeù
 *
kobj
,

5938 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

5940 cÚ¡ 
h–p
[] =

5943  
	`¥rštf
(
buf
, "%s", 
h–p
);

5944 
	}
}

5946 
	$sc¡_´oûss_devt_·ss_through_mgmt_¡Üe
(*
bufãr
,

5947 
sc¡_dev_ty³
 *
devt
)

5949 
»s
 = 0;

5950 *
µ
, *
aùiÚ
, *
dev¡r
;

5951 
ho¡
, 
chªÃl
, 
id
;

5952 
u64
 
lun
;

5953 
sc¡_deviû
 *
d
, *
dev
 = 
NULL
;

5955 
	`TRACE_ENTRY
();

5957 
	`TRACE_DBG
("devˆ%p, bufã¸%s", 
devt
, 
bufãr
);

5959 
µ
 = 
bufãr
;

5960 
aùiÚ
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

5961 
dev¡r
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

5962 ià(*
dev¡r
 == '\0') {

5963 
	`PRINT_ERROR
("%s", "Device„equired");

5964 
»s
 = -
EINVAL
;

5965 
out
;

5968 ià(*
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
) != '\0') {

5969 
	`PRINT_ERROR
("%s", "Too many…arameters");

5970 
»s
 = -
EINVAL
;

5971 
out_syÁax_”r
;

5974 ià(
	`ssÿnf
(
dev¡r
, "%u:%u:%u:%Îu", &
ho¡
, &
chªÃl
, &
id
, &
lun
) != 4)

5975 
out_syÁax_”r
;

5977 
	`TRACE_DBG
("Dev %d:%d:%d:%Îd", 
ho¡
, 
chªÃl
, 
id
, 
lun
);

5979 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

5980 ià(
»s
 != 0)

5981 
out
;

5984 ià(
	`sc¡_check_devt_±r
(
devt
, &
sc¡_dev_ty³_li¡
) != 0)

5985 
out_uÆock
;

5987 
	`li¡_fÜ_—ch_’Œy
(
d
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

5988 ià((
d
->
vœt_id
 == 0) &&

5989 
d
->
scsi_dev
->
ho¡
->
ho¡_no
 == host &&

5990 
d
->
scsi_dev
->
chªÃl
 == channel &&

5991 
d
->
scsi_dev
->
id
 == id &&

5992 
d
->
scsi_dev
->
lun
 ==†un) {

5993 
dev
 = 
d
;

5994 
	`TRACE_DBG
("Dev %p (%d:%d:%d:%lld) found",

5995 
dev
, 
ho¡
, 
chªÃl
, 
id
, 
lun
);

5999 ià(
dev
 =ð
NULL
) {

6000 
	`PRINT_ERROR
("Device %d:%d:%d:%lld‚ot found",

6001 
ho¡
, 
chªÃl
, 
id
, 
lun
);

6002 
»s
 = -
EINVAL
;

6003 
out_uÆock
;

6006 ià(
dev
->
scsi_dev
->
ty³
 !ð
devt
->type) {

6007 
	`PRINT_ERROR
("Type %d of device %s differs fromype "

6008 "%d oàdev hªdË¸%s", 
dev
->
ty³
,

6009 
dev
->
vœt_Çme
, 
devt
->
ty³
, devt->
Çme
);

6010 
»s
 = -
EINVAL
;

6011 
out_uÆock
;

6014 ià(
	`¡rÿ£cmp
("add_deviû", 
aùiÚ
) == 0) {

6015 
»s
 = 
	`sc¡_assign_dev_hªdËr
(
dev
, 
devt
);

6016 ià(
»s
 == 0)

6017 
	`PRINT_INFO
("Device %s‡ssignedo dev handler %s",

6018 
dev
->
vœt_Çme
, 
devt
->
Çme
);

6019 } ià(
	`¡rÿ£cmp
("d–_deviû", 
aùiÚ
) == 0) {

6020 ià(
dev
->
hªdËr
 !ð
devt
) {

6021 
	`PRINT_ERROR
("Device %s is‚ot‡ssignedo handler %s",

6022 
dev
->
vœt_Çme
, 
devt
->
Çme
);

6023 
»s
 = -
EINVAL
;

6024 
out_uÆock
;

6026 
»s
 = 
	`sc¡_assign_dev_hªdËr
(
dev
, &
sc¡_nuÎ_devty³
);

6027 ià(
»s
 == 0)

6028 
	`PRINT_INFO
("Device %s unassigned from dev handler %s",

6029 
dev
->
vœt_Çme
, 
devt
->
Çme
);

6031 
	`PRINT_ERROR
("UnknowÀaùiÚ \"%s\"", 
aùiÚ
);

6032 
»s
 = -
EINVAL
;

6033 
out_uÆock
;

6036 
out_uÆock
:

6037 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

6039 
out
:

6040 
	`TRACE_EXIT_RES
(
»s
);

6041  
»s
;

6043 
out_syÁax_”r
:

6044 
	`PRINT_ERROR
("SyÁaxƒ¼Ü oÀ\"%s\"", 
bufãr
);

6045 
»s
 = -
EINVAL
;

6046 
out
;

6047 
	}
}

6049 
	$sc¡_devt_·ss_through_mgmt_¡Üe_wÜk_â
(

6050 
sc¡_sysfs_wÜk_™em
 *
wÜk
)

6052  
	`sc¡_´oûss_devt_·ss_through_mgmt_¡Üe
(
wÜk
->
buf
, wÜk->
devt
);

6053 
	}
}

6055 
ssize_t
 
	$sc¡_devt_·ss_through_mgmt_¡Üe
(
kobjeù
 *
kobj
,

6056 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

6058  
	`__sc¡_devt_mgmt_¡Üe
(
kobj
, 
©Œ
, 
buf
, 
couÁ
,

6059 
sc¡_devt_·ss_through_mgmt_¡Üe_wÜk_â
);

6060 
	}
}

6062 
kobj_©Œibu‹
 
	gsc¡_devt_·ss_through_mgmt
 =

6063 
__ATTR
(
mgmt
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_devt_·ss_through_mgmt_show
,

6064 
sc¡_devt_·ss_through_mgmt_¡Üe
);

6069 
	$sc¡_ü—‹_devt_©Œ
(
sc¡_dev_ty³
 *
devt
,

6070 
kobj_©Œibu‹
 *
©Œibu‹
)

6072 
»s
;

6074 
»s
 = 
	`sysfs_ü—‹_fže
(&
devt
->
devt_kobj
, &
©Œibu‹
->
©Œ
);

6075 ià(
»s
 != 0) {

6076 
	`PRINT_ERROR
("Can't‡dd‡ttribute %s for dev handler %s",

6077 
©Œibu‹
->
©Œ
.
Çme
, 
devt
->name);

6078 
out
;

6081 
out
:

6082  
»s
;

6083 
	}
}

6084 
EXPORT_SYMBOL
(
sc¡_ü—‹_devt_©Œ
);

6086 
	$sc¡_devt_sysfs_ü—‹
(
sc¡_dev_ty³
 *
devt
)

6088 
»s
;

6089 
kobjeù
 *
·»Á
;

6091 
	`TRACE_ENTRY
();

6093 ià(
devt
->
·»Á
 !ð
NULL
)

6094 
·»Á
 = &
devt
->·»Á->
devt_kobj
;

6096 
·»Á
 = 
sc¡_hªdËrs_kobj
;

6098 
»s
 = 
	`kobjeù_š™_ªd_add
(&
devt
->
devt_kobj
, &
sc¡_devt_kty³
,

6099 
·»Á
, 
devt
->
Çme
);

6100 ià(
»s
 != 0) {

6101 
	`PRINT_ERROR
("Cª'ˆadd devˆ% tØsysfs", 
devt
->
Çme
);

6102 
out
;

6105 ià(
devt
->
add_deviû
 !ð
NULL
) {

6106 
»s
 = 
	`sysfs_ü—‹_fže
(&
devt
->
devt_kobj
,

6107 &
sc¡_devt_mgmt
.
©Œ
);

6109 
»s
 = 
	`sysfs_ü—‹_fže
(&
devt
->
devt_kobj
,

6110 &
sc¡_devt_·ss_through_mgmt
.
©Œ
);

6112 ià(
»s
 != 0) {

6113 
	`PRINT_ERROR
("Can't‡dd mgmt‡ttr for dev handler %s",

6114 
devt
->
Çme
);

6115 
out_”r
;

6118 ià(
devt
->
devt_©Œs
) {

6119 
»s
 = 
	`sysfs_ü—‹_fžes
(&
devt
->
devt_kobj
, devt->
devt_©Œs
);

6120 ià(
»s
 != 0) {

6121 
	`PRINT_ERROR
("Can't‡dd‡ttributes for dev handler %s",

6122 
devt
->
Çme
);

6123 
out_”r
;

6127 #ià
	`defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

6128 ià(
devt
->
Œaû_æags
 !ð
NULL
) {

6129 
»s
 = 
	`sysfs_ü—‹_fže
(&
devt
->
devt_kobj
,

6130 &
devt_Œaû_©Œ
.
©Œ
);

6131 ià(
»s
 != 0) {

6132 
	`PRINT_ERROR
("Can't‡dd devtrace_flag for dev "

6133 "hªdË¸%s", 
devt
->
Çme
);

6134 
out_”r
;

6139 
out
:

6140 
	`TRACE_EXIT_RES
(
»s
);

6141  
»s
;

6143 
out_”r
:

6144 
	`sc¡_devt_sysfs_d–
(
devt
);

6145 
out
;

6146 
	}
}

6148 
	$sc¡_devt_sysfs_d–
(
sc¡_dev_ty³
 *
devt
)

6150 
	`DECLARE_COMPLETION_ONSTACK
(
c
);

6152 
	`TRACE_ENTRY
();

6154 
devt
->
devt_kobj_»Ëa£_com¶
 = &
c
;

6156 
	`kobjeù_d–
(&
devt
->
devt_kobj
);

6158 
	`SCST_KOBJECT_PUT_AND_WAIT
(&
devt
->
devt_kobj
, "dev hªdË¸‹m¶©e", &
c
,

6159 &
sc¡_devt_d•_m­
);

6161 
	`TRACE_EXIT
();

6163 
	}
}

6169 
	$sc¡_dg_dev_sysfs_add
(
sc¡_dev_group
 *
dg
, 
sc¡_dg_dev
 *
dgdev
)

6171 
»s
;

6173 
	`TRACE_ENTRY
();

6174 
»s
 = 
	`sysfs_ü—‹_lšk
(
dg
->
dev_kobj
, &
dgdev
->
dev
->dev_kobj,

6175 
dgdev
->
dev
->
vœt_Çme
);

6176 
	`TRACE_EXIT_RES
(
»s
);

6177  
»s
;

6178 
	}
}

6180 
	$sc¡_dg_dev_sysfs_d–
(
sc¡_dev_group
 *
dg
, 
sc¡_dg_dev
 *
dgdev
)

6182 
	`TRACE_ENTRY
();

6183 
	`sysfs_»move_lšk
(
dg
->
dev_kobj
, 
dgdev
->
dev
->
vœt_Çme
);

6184 
	`TRACE_EXIT
();

6185 
	}
}

6191 
ssize_t
 
	$sc¡_dg_devs_mgmt_show
(
kobjeù
 *
kobj
,

6192 
kobj_©Œibu‹
 *
©Œ
,

6193 *
buf
)

6195 cÚ¡ 
h–p
[] =

6199  
	`sú´štf
(
buf
, 
PAGE_SIZE
, 
h–p
);

6200 
	}
}

6202 
	$sc¡_dg_devs_mgmt_¡Üe_wÜk_â
(
sc¡_sysfs_wÜk_™em
 *
w
)

6204 
sc¡_dev_group
 *
dg
;

6205 *
cmd
, *
p
, *
µ
, *
dev_Çme
;

6206 
»s
;

6208 
	`TRACE_ENTRY
();

6210 
cmd
 = 
w
->
buf
;

6211 
dg
 = 
	`sc¡_lookup_dg_by_kobj
(
w
->
kobj
);

6212 
	`WARN_ON
(!
dg
);

6214 
p
 = 
	`¡rchr
(
cmd
, '\n');

6215 ià(
p
)

6216 *
p
 = '\0';

6218 
»s
 = -
EINVAL
;

6219 
µ
 = 
cmd
;

6220 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

6221 ià(
	`¡rÿ£cmp
(
p
, "add") == 0) {

6222 
dev_Çme
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

6223 ià(!*
dev_Çme
)

6224 
out
;

6225 
»s
 = 
	`sc¡_dg_dev_add
(
dg
, 
dev_Çme
);

6226 } ià(
	`¡rÿ£cmp
(
p
, "del") == 0) {

6227 
dev_Çme
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

6228 ià(!*
dev_Çme
)

6229 
out
;

6230 
»s
 = 
	`sc¡_dg_dev_»move_by_Çme
(
dg
, 
dev_Çme
);

6232 
out
:

6233 
	`kobjeù_put
(
w
->
kobj
);

6234 
	`TRACE_EXIT_RES
(
»s
);

6235  
»s
;

6236 
	}
}

6238 
ssize_t
 
	$sc¡_dg_devs_mgmt_¡Üe
(
kobjeù
 *
kobj
,

6239 
kobj_©Œibu‹
 *
©Œ
,

6240 cÚ¡ *
buf
, 
size_t
 
couÁ
)

6242 *
cmd
;

6243 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

6244 
»s
;

6246 
	`TRACE_ENTRY
();

6248 
»s
 = -
ENOMEM
;

6249 
cmd
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%.*s", ()
couÁ
, 
buf
);

6250 ià(!
cmd
)

6251 
out
;

6253 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_dg_devs_mgmt_¡Üe_wÜk_â
, 
çl£
,

6254 &
wÜk
);

6255 ià(
»s
)

6256 
out
;

6258 
	`sw­
(
wÜk
->
buf
, 
cmd
);

6259 
wÜk
->
kobj
 = kobj;

6260 
	`SCST_SET_DEP_MAP
(
wÜk
, &
sc¡_dg_d•_m­
);

6261 
	`kobjeù_g‘
(
kobj
);

6262 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

6263 ià(
»s
)

6264 
out
;

6265 
»s
 = 
couÁ
;

6267 
out
:

6268 
	`kä“
(
cmd
);

6269 
	`TRACE_EXIT_RES
(
»s
);

6270  
»s
;

6271 
	}
}

6273 
kobj_©Œibu‹
 
	gsc¡_dg_devs_mgmt
 =

6274 
__ATTR
(
mgmt
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_dg_devs_mgmt_show
,

6275 
sc¡_dg_devs_mgmt_¡Üe
);

6277 cÚ¡ 
©Œibu‹
 *
	gsc¡_dg_devs_©Œs
[] = {

6278 &
sc¡_dg_devs_mgmt
.
©Œ
,

6279 
NULL
,

6286 
ssize_t
 
	$sc¡_tg_tgt_»l_tgt_id_show
(
kobjeù
 *
kobj
,

6287 
kobj_©Œibu‹
 *
©Œ
,

6288 *
buf
)

6290 
sc¡_tg_tgt
 *
tg_tgt
;

6292 
tg_tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tg_tgt
, kobj);

6293  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "%u\n" 
SCST_SYSFS_KEY_MARK
 "\n",

6294 
tg_tgt
->
»l_tgt_id
);

6295 
	}
}

6297 
ssize_t
 
	$sc¡_tg_tgt_»l_tgt_id_¡Üe
(
kobjeù
 *
kobj
,

6298 
kobj_©Œibu‹
 *
©Œ
,

6299 cÚ¡ *
buf
, 
size_t
 
couÁ
)

6301 
sc¡_tg_tgt
 *
tg_tgt
;

6302 
»l_tgt_id
;

6303 
ch
[8];

6304 
»s
;

6306 
	`TRACE_ENTRY
();

6307 
tg_tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tg_tgt
, kobj);

6308 
	`¢´štf
(
ch
, (ch), "%.*s", 
	`mš_t
(, 
couÁ
, (ch)-1), 
buf
);

6309 
»s
 = 
	`k¡¹oul
(
ch
, 0, &
»l_tgt_id
);

6310 ià(
»s
)

6311 
out
;

6312 
»s
 = -
EINVAL
;

6313 ià(
»l_tgt_id
 == 0 ||„el_tgt_id > 0xffff)

6314 
out
;

6315 
tg_tgt
->
»l_tgt_id
 =„el_tgt_id;

6316 
»s
 = 
couÁ
;

6317 
out
:

6318 
	`TRACE_EXIT_RES
(
»s
);

6319  
»s
;

6320 
	}
}

6322 
kobj_©Œibu‹
 
	gsc¡_tg_tgt_»l_tgt_id
 =

6323 
__ATTR
(
»l_tgt_id
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_tg_tgt_»l_tgt_id_show
,

6324 
sc¡_tg_tgt_»l_tgt_id_¡Üe
);

6326 cÚ¡ 
©Œibu‹
 *
	gsc¡_tg_tgt_©Œs
[] = {

6327 &
sc¡_tg_tgt_»l_tgt_id
.
©Œ
,

6328 
NULL
,

6331 
	$sc¡_tg_tgt_sysfs_add
(
sc¡_rg‘_group
 *
tg
,

6332 
sc¡_tg_tgt
 *
tg_tgt
)

6334 
»s
;

6336 
	`TRACE_ENTRY
();

6337 
	`BUG_ON
(!
tg
);

6338 
	`BUG_ON
(!
tg_tgt
);

6339 
	`BUG_ON
(!
tg_tgt
->
Çme
);

6340 ià(
tg_tgt
->
tgt
)

6341 
»s
 = 
	`sysfs_ü—‹_lšk
(&
tg
->
kobj
, &
tg_tgt
->
tgt
->
tgt_kobj
,

6342 
tg_tgt
->
Çme
);

6344 
»s
 = 
	`kobjeù_add
(&
tg_tgt
->
kobj
, &
tg
->kobj, "%s",g_tgt->
Çme
);

6345 ià(
»s
)

6346 
”r
;

6347 
»s
 = 
	`sysfs_ü—‹_fžes
(&
tg_tgt
->
kobj
, 
sc¡_tg_tgt_©Œs
);

6348 ià(
»s
)

6349 
”r
;

6351 
out
:

6352 
	`TRACE_EXIT_RES
(
»s
);

6353  
»s
;

6354 
”r
:

6355 
	`sc¡_tg_tgt_sysfs_d–
(
tg
, 
tg_tgt
);

6356 
out
;

6357 
	}
}

6359 
	$sc¡_tg_tgt_sysfs_d–
(
sc¡_rg‘_group
 *
tg
,

6360 
sc¡_tg_tgt
 *
tg_tgt
)

6362 
	`TRACE_ENTRY
();

6363 ià(
tg_tgt
->
tgt
)

6364 
	`sysfs_»move_lšk
(&
tg
->
kobj
, 
tg_tgt
->
Çme
);

6366 
	`sysfs_»move_fžes
(&
tg_tgt
->
kobj
, 
sc¡_tg_tgt_©Œs
);

6367 
	`kobjeù_d–
(&
tg_tgt
->
kobj
);

6369 
	`TRACE_EXIT
();

6370 
	}
}

6376 
ssize_t
 
	$sc¡_tg_group_id_show
(
kobjeù
 *
kobj
,

6377 
kobj_©Œibu‹
 *
©Œ
,

6378 *
buf
)

6380 
sc¡_rg‘_group
 *
tg
;

6382 
tg
 = 
	`cÚš”_of
(
kobj
, 
sc¡_rg‘_group
, kobj);

6383  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "%u\n" 
SCST_SYSFS_KEY_MARK
 "\n",

6384 
tg
->
group_id
);

6385 
	}
}

6387 
ssize_t
 
	$sc¡_tg_group_id_¡Üe
(
kobjeù
 *
kobj
,

6388 
kobj_©Œibu‹
 *
©Œ
,

6389 cÚ¡ *
buf
, 
size_t
 
couÁ
)

6391 
sc¡_rg‘_group
 *
tg
;

6392 
group_id
;

6393 
ch
[8];

6394 
»s
;

6396 
	`TRACE_ENTRY
();

6397 
tg
 = 
	`cÚš”_of
(
kobj
, 
sc¡_rg‘_group
, kobj);

6398 
	`¢´štf
(
ch
, (ch), "%.*s", 
	`mš_t
(, 
couÁ
, (ch)-1), 
buf
);

6399 
»s
 = 
	`k¡¹oul
(
ch
, 0, &
group_id
);

6400 ià(
»s
)

6401 
out
;

6402 
»s
 = -
EINVAL
;

6403 ià(
group_id
 == 0 || group_id > 0xffff)

6404 
out
;

6405 
tg
->
group_id
 = group_id;

6406 
»s
 = 
couÁ
;

6407 
out
:

6408 
	`TRACE_EXIT_RES
(
»s
);

6409  
»s
;

6410 
	}
}

6412 
kobj_©Œibu‹
 
	gsc¡_tg_group_id
 =

6413 
__ATTR
(
group_id
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_tg_group_id_show
,

6414 
sc¡_tg_group_id_¡Üe
);

6416 
ssize_t
 
	$sc¡_tg_´eã¼ed_show
(
kobjeù
 *
kobj
,

6417 
kobj_©Œibu‹
 *
©Œ
,

6418 *
buf
)

6420 
sc¡_rg‘_group
 *
tg
;

6422 
tg
 = 
	`cÚš”_of
(
kobj
, 
sc¡_rg‘_group
, kobj);

6423  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "%u\n%s", 
tg
->
´eã¼ed
,

6424 
tg
->
´eã¼ed
 ? 
SCST_SYSFS_KEY_MARK
 "\n" : "");

6425 
	}
}

6427 
	$sc¡_tg_´eã¼ed_¡Üe_wÜk_â
(
sc¡_sysfs_wÜk_™em
 *
w
)

6429 
sc¡_rg‘_group
 *
tg
;

6430 
´eã¼ed
;

6431 *
cmd
;

6432 
»s
;

6434 
	`TRACE_ENTRY
();

6435 
cmd
 = 
w
->
buf
;

6436 
tg
 = 
	`cÚš”_of
(
w
->
kobj
, 
sc¡_rg‘_group
, kobj);

6437 
»s
 = 
	`k¡¹oul
(
cmd
, 0, &
´eã¼ed
);

6438 ià(
»s
)

6439 
out
;

6440 
»s
 = -
EINVAL
;

6441 ià(
´eã¼ed
 != 0 &&…referred != 1)

6442 
out
;

6443 
»s
 = 
	`sc¡_tg_£t_´eã¼ed
(
tg
, 
´eã¼ed
);

6445 
out
:

6446 
	`kobjeù_put
(
w
->
kobj
);

6447 
	`TRACE_EXIT_RES
(
»s
);

6448  
»s
;

6449 
	}
}

6451 
ssize_t
 
	$sc¡_tg_´eã¼ed_¡Üe
(
kobjeù
 *
kobj
,

6452 
kobj_©Œibu‹
 *
©Œ
,

6453 cÚ¡ *
buf
, 
size_t
 
couÁ
)

6455 *
cmd
;

6456 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

6457 
»s
;

6459 
»s
 = -
ENOMEM
;

6460 
cmd
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%.*s", ()
couÁ
, 
buf
);

6461 ià(!
cmd
)

6462 
out
;

6464 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_tg_´eã¼ed_¡Üe_wÜk_â
, 
çl£
,

6465 &
wÜk
);

6466 ià(
»s
)

6467 
out
;

6469 
	`sw­
(
wÜk
->
buf
, 
cmd
);

6470 
wÜk
->
kobj
 = kobj;

6471 
	`SCST_SET_DEP_MAP
(
wÜk
, &
sc¡_tg_d•_m­
);

6472 
	`kobjeù_g‘
(
kobj
);

6473 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

6474 ià(
»s
)

6475 
out
;

6476 
»s
 = 
couÁ
;

6478 
out
:

6479 
	`kä“
(
cmd
);

6480  
»s
;

6481 
	}
}

6483 
kobj_©Œibu‹
 
	gsc¡_tg_´eã¼ed
 =

6484 
__ATTR
(
´eã¼ed
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_tg_´eã¼ed_show
,

6485 
sc¡_tg_´eã¼ed_¡Üe
);

6487 
ssize_t
 
	$sc¡_tg_¡©e_show
(
kobjeù
 *
kobj
,

6488 
kobj_©Œibu‹
 *
©Œ
,

6489 *
buf
)

6491 
sc¡_rg‘_group
 *
tg
;

6492 cÚ¡ *
n
;

6494 
tg
 = 
	`cÚš”_of
(
kobj
, 
sc¡_rg‘_group
, kobj);

6495 
n
 = 
	`sc¡_®ua_¡©e_Çme
(
tg
->
¡©e
);

6497  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "%s\n" 
SCST_SYSFS_KEY_MARK
 "\n",

6498 
n
 ?‚ : "???");

6499 
	}
}

6501 
	$sc¡_tg_¡©e_¡Üe_wÜk_â
(
sc¡_sysfs_wÜk_™em
 *
w
)

6503 
sc¡_rg‘_group
 *
tg
;

6504 *
cmd
, *
p
;

6505 
»s
;

6506 
sc¡_tg_¡©e
 
s
;

6508 
	`TRACE_ENTRY
();

6510 
cmd
 = 
w
->
buf
;

6511 
tg
 = 
	`cÚš”_of
(
w
->
kobj
, 
sc¡_rg‘_group
, kobj);

6513 
p
 = 
	`¡rchr
(
cmd
, '\n');

6514 ià(
p
)

6515 *
p
 = '\0';

6517 
s
 = 
	`sc¡_®ua_Çme_to_¡©e
(
cmd
);

6519 
»s
 = -
EINVAL
;

6520 ià(
s
 =ð
SCST_TG_STATE_UNDEFINED
)

6521 
out
;

6522 
»s
 = 
	`sc¡_tg_£t_¡©e
(
tg
, 
s
);

6524 
out
:

6525 
	`kobjeù_put
(
w
->
kobj
);

6526 
	`TRACE_EXIT_RES
(
»s
);

6527  
»s
;

6528 
	}
}

6530 
ssize_t
 
	$sc¡_tg_¡©e_¡Üe
(
kobjeù
 *
kobj
,

6531 
kobj_©Œibu‹
 *
©Œ
,

6532 cÚ¡ *
buf
, 
size_t
 
couÁ
)

6534 *
cmd
;

6535 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

6536 
»s
;

6538 
	`TRACE_ENTRY
();

6540 
»s
 = -
ENOMEM
;

6541 
cmd
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%.*s", ()
couÁ
, 
buf
);

6542 ià(!
cmd
)

6543 
out
;

6545 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_tg_¡©e_¡Üe_wÜk_â
, 
çl£
,

6546 &
wÜk
);

6547 ià(
»s
)

6548 
out
;

6550 
	`sw­
(
wÜk
->
buf
, 
cmd
);

6551 
wÜk
->
kobj
 = kobj;

6552 
	`SCST_SET_DEP_MAP
(
wÜk
, &
sc¡_tg_d•_m­
);

6553 
	`kobjeù_g‘
(
kobj
);

6554 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

6555 ià(
»s
)

6556 
out
;

6557 
»s
 = 
couÁ
;

6559 
out
:

6560 
	`kä“
(
cmd
);

6561 
	`TRACE_EXIT_RES
(
»s
);

6562  
»s
;

6563 
	}
}

6565 
kobj_©Œibu‹
 
	gsc¡_tg_¡©e
 =

6566 
__ATTR
(
¡©e
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_tg_¡©e_show
,

6567 
sc¡_tg_¡©e_¡Üe
);

6569 
ssize_t
 
	$sc¡_tg_mgmt_show
(
kobjeù
 *
kobj
,

6570 
kobj_©Œibu‹
 *
©Œ
,

6571 *
buf
)

6573 cÚ¡ 
h–p
[] =

6577  
	`sú´štf
(
buf
, 
PAGE_SIZE
, 
h–p
);

6578 
	}
}

6580 
	$sc¡_tg_mgmt_¡Üe_wÜk_â
(
sc¡_sysfs_wÜk_™em
 *
w
)

6582 
sc¡_rg‘_group
 *
tg
;

6583 *
cmd
, *
p
, *
µ
, *
rg‘_Çme
;

6584 
»s
;

6586 
	`TRACE_ENTRY
();

6588 
cmd
 = 
w
->
buf
;

6589 
tg
 = 
	`cÚš”_of
(
w
->
kobj
, 
sc¡_rg‘_group
, kobj);

6591 
p
 = 
	`¡rchr
(
cmd
, '\n');

6592 ià(
p
)

6593 *
p
 = '\0';

6595 
»s
 = -
EINVAL
;

6596 
µ
 = 
cmd
;

6597 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

6598 ià(
	`¡rÿ£cmp
(
p
, "add") == 0) {

6599 
rg‘_Çme
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

6600 ià(!*
rg‘_Çme
)

6601 
out
;

6602 
»s
 = 
	`sc¡_tg_tgt_add
(
tg
, 
rg‘_Çme
);

6603 } ià(
	`¡rÿ£cmp
(
p
, "del") == 0) {

6604 
rg‘_Çme
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

6605 ià(!*
rg‘_Çme
)

6606 
out
;

6607 
»s
 = 
	`sc¡_tg_tgt_»move_by_Çme
(
tg
, 
rg‘_Çme
);

6609 
out
:

6610 
	`kobjeù_put
(
w
->
kobj
);

6611 
	`TRACE_EXIT_RES
(
»s
);

6612  
»s
;

6613 
	}
}

6615 
ssize_t
 
	$sc¡_tg_mgmt_¡Üe
(
kobjeù
 *
kobj
,

6616 
kobj_©Œibu‹
 *
©Œ
,

6617 cÚ¡ *
buf
, 
size_t
 
couÁ
)

6619 *
cmd
;

6620 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

6621 
»s
;

6623 
	`TRACE_ENTRY
();

6625 
»s
 = -
ENOMEM
;

6626 
cmd
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%.*s", ()
couÁ
, 
buf
);

6627 ià(!
cmd
)

6628 
out
;

6630 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_tg_mgmt_¡Üe_wÜk_â
, 
çl£
,

6631 &
wÜk
);

6632 ià(
»s
)

6633 
out
;

6635 
	`sw­
(
wÜk
->
buf
, 
cmd
);

6636 
wÜk
->
kobj
 = kobj;

6637 
	`SCST_SET_DEP_MAP
(
wÜk
, &
sc¡_tg_d•_m­
);

6638 
	`kobjeù_g‘
(
kobj
);

6639 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

6640 ià(
»s
)

6641 
out
;

6642 
»s
 = 
couÁ
;

6644 
out
:

6645 
	`kä“
(
cmd
);

6646 
	`TRACE_EXIT_RES
(
»s
);

6647  
»s
;

6648 
	}
}

6650 
kobj_©Œibu‹
 
	gsc¡_tg_mgmt
 =

6651 
__ATTR
(
mgmt
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_tg_mgmt_show
,

6652 
sc¡_tg_mgmt_¡Üe
);

6654 cÚ¡ 
©Œibu‹
 *
	gsc¡_tg_©Œs
[] = {

6655 &
sc¡_tg_mgmt
.
©Œ
,

6656 &
sc¡_tg_group_id
.
©Œ
,

6657 &
sc¡_tg_´eã¼ed
.
©Œ
,

6658 &
sc¡_tg_¡©e
.
©Œ
,

6659 
NULL
,

6662 
	$sc¡_tg_sysfs_add
(
sc¡_dev_group
 *
dg
, 
sc¡_rg‘_group
 *
tg
)

6664 
»s
;

6666 
	`TRACE_ENTRY
();

6667 
»s
 = 
	`kobjeù_add
(&
tg
->
kobj
, 
dg
->
tg_kobj
, "%s",g->
Çme
);

6668 ià(
»s
)

6669 
”r
;

6670 
»s
 = 
	`sysfs_ü—‹_fžes
(&
tg
->
kobj
, 
sc¡_tg_©Œs
);

6671 ià(
»s
)

6672 
”r
;

6673 
out
:

6674 
	`TRACE_EXIT_RES
(
»s
);

6675  
»s
;

6676 
”r
:

6677 
	`sc¡_tg_sysfs_d–
(
tg
);

6678 
out
;

6679 
	}
}

6681 
	$sc¡_tg_sysfs_d–
(
sc¡_rg‘_group
 *
tg
)

6683 
	`TRACE_ENTRY
();

6684 
	`sysfs_»move_fžes
(&
tg
->
kobj
, 
sc¡_tg_©Œs
);

6685 
	`kobjeù_d–
(&
tg
->
kobj
);

6686 
	`TRACE_EXIT
();

6687 
	}
}

6693 
ssize_t
 
	$sc¡_dg_tgs_mgmt_show
(
kobjeù
 *
kobj
,

6694 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

6696 cÚ¡ 
h–p
[] =

6700  
	`sú´štf
(
buf
, 
PAGE_SIZE
, 
h–p
);

6701 
	}
}

6703 
	$sc¡_dg_tgs_mgmt_¡Üe_wÜk_â
(
sc¡_sysfs_wÜk_™em
 *
w
)

6705 
sc¡_dev_group
 *
dg
;

6706 *
cmd
, *
p
, *
µ
, *
dev_Çme
;

6707 
»s
;

6709 
	`TRACE_ENTRY
();

6711 
cmd
 = 
w
->
buf
;

6712 
dg
 = 
	`sc¡_lookup_dg_by_kobj
(
w
->
kobj
);

6713 
	`WARN_ON
(!
dg
);

6715 
p
 = 
	`¡rchr
(
cmd
, '\n');

6716 ià(
p
)

6717 *
p
 = '\0';

6719 
»s
 = -
EINVAL
;

6720 
µ
 = 
cmd
;

6721 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

6722 ià(
	`¡rÿ£cmp
(
p
, "create") == 0 || strcasecmp(p, "add") == 0) {

6723 
dev_Çme
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

6724 ià(!*
dev_Çme
)

6725 
out
;

6726 
»s
 = 
	`sc¡_tg_add
(
dg
, 
dev_Çme
);

6727 } ià(
	`¡rÿ£cmp
(
p
, "del") == 0) {

6728 
dev_Çme
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

6729 ià(!*
dev_Çme
)

6730 
out
;

6731 
»s
 = 
	`sc¡_tg_»move_by_Çme
(
dg
, 
dev_Çme
);

6733 
out
:

6734 
	`kobjeù_put
(
w
->
kobj
);

6735 
	`TRACE_EXIT_RES
(
»s
);

6736  
»s
;

6737 
	}
}

6739 
ssize_t
 
	$sc¡_dg_tgs_mgmt_¡Üe
(
kobjeù
 *
kobj
,

6740 
kobj_©Œibu‹
 *
©Œ
,

6741 cÚ¡ *
buf
, 
size_t
 
couÁ
)

6743 *
cmd
;

6744 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

6745 
»s
;

6747 
	`TRACE_ENTRY
();

6749 
»s
 = -
ENOMEM
;

6750 
cmd
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%.*s", ()
couÁ
, 
buf
);

6751 ià(!
cmd
)

6752 
out
;

6754 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_dg_tgs_mgmt_¡Üe_wÜk_â
, 
çl£
,

6755 &
wÜk
);

6756 ià(
»s
)

6757 
out
;

6759 
	`sw­
(
wÜk
->
buf
, 
cmd
);

6760 
wÜk
->
kobj
 = kobj;

6761 
	`SCST_SET_DEP_MAP
(
wÜk
, &
sc¡_dg_d•_m­
);

6762 
	`kobjeù_g‘
(
kobj
);

6763 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

6764 ià(
»s
)

6765 
out
;

6766 
»s
 = 
couÁ
;

6768 
out
:

6769 
	`kä“
(
cmd
);

6770 
	`TRACE_EXIT_RES
(
»s
);

6771  
»s
;

6772 
	}
}

6774 
kobj_©Œibu‹
 
	gsc¡_dg_tgs_mgmt
 =

6775 
__ATTR
(
mgmt
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_dg_tgs_mgmt_show
,

6776 
sc¡_dg_tgs_mgmt_¡Üe
);

6778 cÚ¡ 
©Œibu‹
 *
	gsc¡_dg_tgs_©Œs
[] = {

6779 &
sc¡_dg_tgs_mgmt
.
©Œ
,

6780 
NULL
,

6787 
	$sc¡_dg_sysfs_add
(
kobjeù
 *
·»Á
, 
sc¡_dev_group
 *
dg
)

6789 
»s
;

6791 
dg
->
dev_kobj
 = 
NULL
;

6792 
dg
->
tg_kobj
 = 
NULL
;

6793 
»s
 = 
	`kobjeù_add
(&
dg
->
kobj
, 
·»Á
, "%s", dg->
Çme
);

6794 ià(
»s
)

6795 
”r
;

6796 
»s
 = -
EEXIST
;

6797 
dg
->
dev_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("deviûs", &dg->
kobj
);

6798 ià(!
dg
->
dev_kobj
)

6799 
”r
;

6800 
»s
 = 
	`sysfs_ü—‹_fžes
(
dg
->
dev_kobj
, 
sc¡_dg_devs_©Œs
);

6801 ià(
»s
)

6802 
”r
;

6803 
dg
->
tg_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("rg‘_groups", &dg->
kobj
);

6804 ià(!
dg
->
tg_kobj
)

6805 
”r
;

6806 
»s
 = 
	`sysfs_ü—‹_fžes
(
dg
->
tg_kobj
, 
sc¡_dg_tgs_©Œs
);

6807 ià(
»s
)

6808 
”r
;

6809 
out
:

6810  
»s
;

6811 
”r
:

6812 
	`sc¡_dg_sysfs_d–
(
dg
);

6813 
out
;

6814 
	}
}

6816 
	$sc¡_dg_sysfs_d–
(
sc¡_dev_group
 *
dg
)

6818 ià(
dg
->
tg_kobj
) {

6819 
	`sysfs_»move_fžes
(
dg
->
tg_kobj
, 
sc¡_dg_tgs_©Œs
);

6820 
	`kobjeù_d–
(
dg
->
tg_kobj
);

6821 
	`kobjeù_put
(
dg
->
tg_kobj
);

6822 
dg
->
tg_kobj
 = 
NULL
;

6824 ià(
dg
->
dev_kobj
) {

6825 
	`sysfs_»move_fžes
(
dg
->
dev_kobj
, 
sc¡_dg_devs_©Œs
);

6826 
	`kobjeù_d–
(
dg
->
dev_kobj
);

6827 
	`kobjeù_put
(
dg
->
dev_kobj
);

6828 
dg
->
dev_kobj
 = 
NULL
;

6830 
	`kobjeù_d–
(&
dg
->
kobj
);

6831 
	}
}

6833 
ssize_t
 
	$sc¡_deviû_groups_mgmt_show
(
kobjeù
 *
kobj
,

6834 
kobj_©Œibu‹
 *
©Œ
,

6835 *
buf
)

6837 cÚ¡ 
h–p
[] =

6841  
	`sú´štf
(
buf
, 
PAGE_SIZE
, 
h–p
);

6842 
	}
}

6844 
ssize_t
 
	$sc¡_deviû_groups_mgmt_¡Üe
(
kobjeù
 *
kobj
,

6845 
kobj_©Œibu‹
 *
©Œ
,

6846 cÚ¡ *
buf
, 
size_t
 
couÁ
)

6848 
»s
;

6849 *
p
, *
µ
, *
šput
, *
group_Çme
;

6851 
	`TRACE_ENTRY
();

6853 
šput
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%.*s", ()
couÁ
, 
buf
);

6854 
µ
 = 
šput
;

6855 
p
 = 
	`¡rchr
(
šput
, '\n');

6856 ià(
p
)

6857 *
p
 = '\0';

6859 
»s
 = -
EINVAL
;

6860 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

6861 ià(
	`¡rÿ£cmp
(
p
, "create") == 0 || strcasecmp(p, "add") == 0) {

6862 
group_Çme
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

6863 ià(!*
group_Çme
)

6864 
out
;

6865 
»s
 = 
	`sc¡_dg_add
(
sc¡_deviû_groups_kobj
, 
group_Çme
);

6866 } ià(
	`¡rÿ£cmp
(
p
, "del") == 0) {

6867 
group_Çme
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

6868 ià(!*
group_Çme
)

6869 
out
;

6870 
»s
 = 
	`sc¡_dg_»move
(
group_Çme
);

6872 
out
:

6873 
	`kä“
(
šput
);

6874 ià(
»s
 == 0)

6875 
»s
 = 
couÁ
;

6876 
	`TRACE_EXIT_RES
(
»s
);

6877  
»s
;

6878 
	}
}

6880 
kobj_©Œibu‹
 
	gsc¡_deviû_groups_mgmt
 =

6881 
__ATTR
(
mgmt
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_deviû_groups_mgmt_show
,

6882 
sc¡_deviû_groups_mgmt_¡Üe
);

6884 cÚ¡ 
©Œibu‹
 *
	gsc¡_deviû_groups_©Œs
[] = {

6885 &
sc¡_deviû_groups_mgmt
.
©Œ
,

6886 
NULL
,

6893 
kobjeù
 
	gsc¡_sysfs_roÙ_kobj
;

6895 
ssize_t
 
	$sc¡_th»ads_show
(
kobjeù
 *
kobj
,

6896 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

6898 
couÁ
;

6900 
	`TRACE_ENTRY
();

6902 
couÁ
 = 
	`¥rštf
(
buf
, "%d\n%s", 
sc¡_maš_cmd_th»ads
.
Ä_th»ads
,

6903 (
sc¡_maš_cmd_th»ads
.
Ä_th»ads
 !ð
sc¡_th»ads
) ?

6904 
SCST_SYSFS_KEY_MARK
 "\n" : "");

6906 
	`TRACE_EXIT
();

6907  
couÁ
;

6908 
	}
}

6910 
	$sc¡_´oûss_th»ads_¡Üe
(
ÃwŠ
)

6912 
»s
;

6913 
ÞdŠ
, 
d–
;

6915 
	`TRACE_ENTRY
();

6917 
	`TRACE_DBG
("ÃwŠ %d", 
ÃwŠ
);

6925 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
SCST_SUSPEND_TIMEOUT_USER
);

6926 ià(
»s
 != 0)

6927 
out
;

6929 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

6930 ià(
»s
 != 0)

6931 
out_»sume
;

6933 
ÞdŠ
 = 
sc¡_maš_cmd_th»ads
.
Ä_th»ads
;

6935 
d–
 = 
ÃwŠ
 - 
ÞdŠ
;

6936 ià(
d–
 < 0)

6937 
	`sc¡_d–_th»ads
(&
sc¡_maš_cmd_th»ads
, -
d–
);

6939 
»s
 = 
	`sc¡_add_th»ads
(&
sc¡_maš_cmd_th»ads
, 
NULL
, NULL, 
d–
);

6940 ià(
»s
 != 0)

6941 
out_up
;

6944 
	`PRINT_INFO
("Chªged cmdh»ad num: old %ld,‚ew %d", 
ÞdŠ
, 
ÃwŠ
);

6946 
out_up
:

6947 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

6949 
out_»sume
:

6950 
	`sc¡_»sume_aùiv™y
();

6952 
out
:

6953 
	`TRACE_EXIT_RES
(
»s
);

6954  
»s
;

6955 
	}
}

6957 
	$sc¡_th»ads_¡Üe_wÜk_â
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

6959  
	`sc¡_´oûss_th»ads_¡Üe
(
wÜk
->
Ãw_th»ads_num
);

6960 
	}
}

6962 
ssize_t
 
	$sc¡_th»ads_¡Üe
(
kobjeù
 *
kobj
,

6963 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

6965 
»s
;

6966 
ÃwŠ
;

6967 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

6969 
	`TRACE_ENTRY
();

6971 
»s
 = 
	`k¡¹Þ
(
buf
, 0, &
ÃwŠ
);

6972 ià(
»s
 != 0) {

6973 
	`PRINT_ERROR
("k¡¹Þ(èfÜ % çžed: %d ", 
buf
, 
»s
);

6974 
out
;

6976 ià(
ÃwŠ
 <= 0) {

6977 
	`PRINT_ERROR
("IÎeg®h»ad num v®u%ld", 
ÃwŠ
);

6978 
»s
 = -
EINVAL
;

6979 
out
;

6982 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_th»ads_¡Üe_wÜk_â
, 
çl£
, &
wÜk
);

6983 ià(
»s
 != 0)

6984 
out
;

6986 
wÜk
->
Ãw_th»ads_num
 = 
ÃwŠ
;

6988 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

6989 ià(
»s
 == 0)

6990 
»s
 = 
couÁ
;

6992 
out
:

6993 
	`TRACE_EXIT_RES
(
»s
);

6994  
»s
;

6995 
	}
}

6997 
kobj_©Œibu‹
 
	gsc¡_th»ads_©Œ
 =

6998 
__ATTR
(
th»ads
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_th»ads_show
,

6999 
sc¡_th»ads_¡Üe
);

7001 
ssize_t
 
	$sc¡_£tup_id_show
(
kobjeù
 *
kobj
,

7002 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

7004 
couÁ
;

7006 
	`TRACE_ENTRY
();

7008 
couÁ
 = 
	`¥rštf
(
buf
, "0x%x\n%s\n", 
sc¡_£tup_id
,

7009 (
sc¡_£tup_id
 =ð0è? "" : 
SCST_SYSFS_KEY_MARK
);

7011 
	`TRACE_EXIT
();

7012  
couÁ
;

7013 
	}
}

7015 
ssize_t
 
	$sc¡_£tup_id_¡Üe
(
kobjeù
 *
kobj
,

7016 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

7018 
»s
;

7019 
v®
;

7021 
	`TRACE_ENTRY
();

7023 
»s
 = 
	`k¡¹oul
(
buf
, 0, &
v®
);

7024 ià(
»s
 != 0) {

7025 
	`PRINT_ERROR
("k¡¹oul(èfÜ % çžed: %d ", 
buf
, 
»s
);

7026 
out
;

7029 
sc¡_£tup_id
 = 
v®
;

7030 
	`PRINT_INFO
("Chªged sc¡_£tup_idØ%x", 
sc¡_£tup_id
);

7032 
»s
 = 
couÁ
;

7034 
out
:

7035 
	`TRACE_EXIT_RES
(
»s
);

7036  
»s
;

7037 
	}
}

7039 
kobj_©Œibu‹
 
	gsc¡_£tup_id_©Œ
 =

7040 
__ATTR
(
£tup_id
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_£tup_id_show
,

7041 
sc¡_£tup_id_¡Üe
);

7043 
ssize_t
 
	$sc¡_max_skËt_cmd_show
(
kobjeù
 *
kobj
,

7044 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

7046 
couÁ
;

7048 
	`TRACE_ENTRY
();

7050 
couÁ
 = 
	`¥rštf
(
buf
, "%d\n%s\n", 
sc¡_max_skËt_cmd
,

7051 (
sc¡_max_skËt_cmd
 =ð
SCST_DEF_MAX_TASKLET_CMD
)

7052 ? "" : 
SCST_SYSFS_KEY_MARK
);

7054 
	`TRACE_EXIT
();

7055  
couÁ
;

7056 
	}
}

7058 
ssize_t
 
	$sc¡_max_skËt_cmd_¡Üe
(
kobjeù
 *
kobj
,

7059 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

7061 
»s
;

7062 
v®
;

7064 
	`TRACE_ENTRY
();

7066 
»s
 = 
	`k¡¹oul
(
buf
, 0, &
v®
);

7067 ià(
»s
 != 0) {

7068 
	`PRINT_ERROR
("k¡¹oul(èfÜ % çžed: %d ", 
buf
, 
»s
);

7069 
out
;

7072 
sc¡_max_skËt_cmd
 = 
v®
;

7073 
	`PRINT_INFO
("Chªged sc¡_max_skËt_cmdØ%d", 
sc¡_max_skËt_cmd
);

7075 
»s
 = 
couÁ
;

7077 
out
:

7078 
	`TRACE_EXIT_RES
(
»s
);

7079  
»s
;

7080 
	}
}

7082 
kobj_©Œibu‹
 
	gsc¡_max_skËt_cmd_©Œ
 =

7083 
__ATTR
(
max_skËt_cmd
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_max_skËt_cmd_show
,

7084 
sc¡_max_skËt_cmd_¡Üe
);

7086 
ssize_t
 
	$sc¡_su¥’d_show
(
kobjeù
 *
kobj
,

7087 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

7089 
couÁ
;

7091 
	`TRACE_ENTRY
();

7093 
couÁ
 = 
	`¥rštf
(
buf
, "%d\n", 
	`sc¡_g‘_su¥’d_couÁ
());

7095 
	`TRACE_EXIT
();

7096  
couÁ
;

7097 
	}
}

7099 
ssize_t
 
	$sc¡_su¥’d_¡Üe
(
kobjeù
 *
kobj
,

7100 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

7102 
»s
;

7103 
v®
;

7105 
	`TRACE_ENTRY
();

7107 
»s
 = 
	`k¡¹Þ
(
buf
, 0, &
v®
);

7108 ià(
»s
 != 0) {

7109 
	`PRINT_ERROR
("k¡¹oul(èfÜ % çžed: %d ", 
buf
, 
»s
);

7110 
out
;

7113 ià(
v®
 >= 0) {

7114 
	`PRINT_INFO
("SYSFS: su¥’dšg‡ùiv™› Ñimeouˆ%ld)...", 
v®
);

7115 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
v®
*
HZ
);

7116 ià(
»s
 == 0)

7117 
	`PRINT_INFO
("sysfs suspending done");

7119 
	`PRINT_INFO
("SYSFS:„esuming‡ctivities");

7120 
	`sc¡_»sume_aùiv™y
();

7123 ià(
»s
 == 0)

7124 
»s
 = 
couÁ
;

7126 
out
:

7127 
	`TRACE_EXIT_RES
(
»s
);

7128  
»s
;

7129 
	}
}

7131 
kobj_©Œibu‹
 
	gsc¡_su¥’d_©Œ
 =

7132 
__ATTR
(
su¥’d
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_su¥’d_show
,

7133 
sc¡_su¥’d_¡Üe
);

7135 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

7137 
ssize_t
 
	$sc¡_maš_Œaû_Ëv–_show
(
kobjeù
 *
kobj
,

7138 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

7140  
	`sc¡_Œaû_Ëv–_show
(
sc¡_loÿl_Œaû_tbl
, 
Œaû_æag
,

7141 
buf
, 
NULL
);

7142 
	}
}

7144 
ssize_t
 
	$sc¡_maš_Œaû_Ëv–_¡Üe
(
kobjeù
 *
kobj
,

7145 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

7147 
»s
;

7149 
	`TRACE_ENTRY
();

7151 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_log_mu‹x
);

7152 ià(
»s
 != 0)

7153 
out
;

7155 
»s
 = 
	`sc¡_wr™e_Œaû
(
buf
, 
couÁ
, &
Œaû_æag
,

7156 
SCST_DEFAULT_LOG_FLAGS
, "sc¡", 
sc¡_loÿl_Œaû_tbl
);

7158 
	`mu‹x_uÆock
(&
sc¡_log_mu‹x
);

7160 
out
:

7161 
	`TRACE_EXIT_RES
(
»s
);

7162  
»s
;

7163 
	}
}

7165 
kobj_©Œibu‹
 
	gsc¡_maš_Œaû_Ëv–_©Œ
 =

7166 
__ATTR
(
Œaû_Ëv–
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_maš_Œaû_Ëv–_show
,

7167 
sc¡_maš_Œaû_Ëv–_¡Üe
);

7171 
	$__´štf
(2, 3è
	$sc¡_­³nd
(*
¬g
, cÚ¡ *
fmt
, ...)

7173 *
buf
 = 
¬g
;

7174 
Ën
 = 
	`¡¾’
(
buf
);

7175 
va_li¡
 
¬gs
;

7177 
	`va_¡¬t
(
¬gs
, 
fmt
);

7178 
	`vsú´štf
(
buf
 + 
Ën
, 
SCST_SYSFS_BLOCK_SIZE
 -†’, 
fmt
, 
¬gs
);

7179 
	`va_’d
(
¬gs
);

7180 
	}
}

7182 
	$sc¡_´oûss_show_Œaû_cmds
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

7184 
»t
 = -
ENOMEM
;

7186 
wÜk
->
»s_buf
 = 
	`km®loc
(
SCST_SYSFS_BLOCK_SIZE
, 
GFP_KERNEL
);

7187 ià(!
wÜk
->
»s_buf
)

7188 
put
;

7189 
wÜk
->
»s_buf
[0] = '\0';

7190 
	`sc¡_Œaû_cmds
(
sc¡_­³nd
, 
wÜk
->
»s_buf
);

7191 
»t
 = 0;

7193 
put
:

7194 
	`kobjeù_put
(&
sc¡_sysfs_roÙ_kobj
);

7195  
»t
;

7196 
	}
}

7198 
ssize_t
 
	$sc¡_show_Œaû_cmds
(
kobjeù
 *
kobj
,

7199 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

7201 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

7202 
»s
;

7204 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_´oûss_show_Œaû_cmds
, 
Œue
,

7205 &
wÜk
);

7206 ià(
»s
 != 0)

7207 
out
;

7209 
	`kobjeù_g‘
(&
sc¡_sysfs_roÙ_kobj
);

7210 
	`sc¡_sysfs_wÜk_g‘
(
wÜk
);

7211 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

7212 ià(
»s
 != 0)

7213 
put
;

7215 
»s
 = 
	`sú´štf
(
buf
, 
SCST_SYSFS_BLOCK_SIZE
, "%s", 
wÜk
->
»s_buf
);

7217 
put
:

7218 
	`sc¡_sysfs_wÜk_put
(
wÜk
);

7220 
out
:

7221  
»s
;

7223 
	}
}

7225 
kobj_©Œibu‹
 
	gsc¡_Œaû_cmds_©Œ
 =

7226 
__ATTR
(
Œaû_cmds
, 
S_IRUGO
, 
sc¡_show_Œaû_cmds
, 
NULL
);

7228 
	$sc¡_´oûss_show_Œaû_mcmds
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

7230 
»t
 = -
ENOMEM
;

7232 
wÜk
->
»s_buf
 = 
	`km®loc
(
SCST_SYSFS_BLOCK_SIZE
, 
GFP_KERNEL
);

7233 ià(!
wÜk
->
»s_buf
)

7234 
put
;

7235 
wÜk
->
»s_buf
[0] = '\0';

7236 
	`sc¡_Œaû_mcmds
(
sc¡_­³nd
, 
wÜk
->
»s_buf
);

7237 
»t
 = 0;

7239 
put
:

7240 
	`kobjeù_put
(&
sc¡_sysfs_roÙ_kobj
);

7241  
»t
;

7242 
	}
}

7244 
ssize_t
 
	$sc¡_show_Œaû_mcmds
(
kobjeù
 *
kobj
,

7245 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

7247 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

7248 
»s
;

7250 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_´oûss_show_Œaû_mcmds
, 
Œue
,

7251 &
wÜk
);

7252 ià(
»s
 != 0)

7253 
out
;

7255 
	`kobjeù_g‘
(&
sc¡_sysfs_roÙ_kobj
);

7256 
	`sc¡_sysfs_wÜk_g‘
(
wÜk
);

7257 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

7258 ià(
»s
 != 0)

7259 
put
;

7261 
»s
 = 
	`sú´štf
(
buf
, 
SCST_SYSFS_BLOCK_SIZE
, "%s", 
wÜk
->
»s_buf
);

7263 
put
:

7264 
	`sc¡_sysfs_wÜk_put
(
wÜk
);

7266 
out
:

7267  
»s
;

7269 
	}
}

7271 
kobj_©Œibu‹
 
	gsc¡_Œaû_mcmds_©Œ
 =

7272 
__ATTR
(
Œaû_mcmds
, 
S_IRUGO
, 
sc¡_show_Œaû_mcmds
, 
NULL
);

7274 
ssize_t
 
	$sc¡_v”siÚ_show
(
kobjeù
 *
kobj
,

7275 
kobj_©Œibu‹
 *
©Œ
,

7276 *
buf
)

7278 
	`TRACE_ENTRY
();

7280 
	`¥rštf
(
buf
, "%s\n", 
SCST_VERSION_STRING
);

7282 #ifdeà
CONFIG_SCST_STRICT_SERIALIZING


7283 
	`¡rÿt
(
buf
, "STRICT_SERIALIZING\n");

7286 #ifdeà
CONFIG_SCST_EXTRACHECKS


7287 
	`¡rÿt
(
buf
, "EXTRACHECKS\n");

7290 #ifdeà
CONFIG_SCST_TRACING


7291 
	`¡rÿt
(
buf
, "TRACING\n");

7294 #ifdeà
CONFIG_SCST_DEBUG


7295 
	`¡rÿt
(
buf
, "DEBUG\n");

7298 #ifdeà
CONFIG_SCST_DEBUG_TM


7299 
	`¡rÿt
(
buf
, "DEBUG_TM\n");

7302 #ifdeà
CONFIG_SCST_DEBUG_RETRY


7303 
	`¡rÿt
(
buf
, "DEBUG_RETRY\n");

7306 #ifdeà
CONFIG_SCST_DEBUG_OOM


7307 
	`¡rÿt
(
buf
, "DEBUG_OOM\n");

7310 #ifdeà
CONFIG_SCST_DEBUG_SN


7311 
	`¡rÿt
(
buf
, "DEBUG_SN\n");

7314 #ifdeà
CONFIG_SCST_USE_EXPECTED_VALUES


7315 
	`¡rÿt
(
buf
, "USE_EXPECTED_VALUES\n");

7318 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


7319 
	`¡rÿt
(
buf
, "TEST_IO_IN_SIRQ\n");

7322 #ifdeà
CONFIG_SCST_STRICT_SECURITY


7323 
	`¡rÿt
(
buf
, "STRICT_SECURITY\n");

7326 
	`TRACE_EXIT
();

7327  
	`¡¾’
(
buf
);

7328 
	}
}

7330 
kobj_©Œibu‹
 
	gsc¡_v”siÚ_©Œ
 =

7331 
__ATTR
(
v”siÚ
, 
S_IRUGO
, 
sc¡_v”siÚ_show
, 
NULL
);

7333 
ssize_t
 
	$sc¡_Ï¡_sysfs_mgmt_»s_show
(
kobjeù
 *
kobj
,

7334 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

7336 
»s
;

7338 
	`TRACE_ENTRY
();

7340 
	`¥š_lock
(&
sysfs_wÜk_lock
);

7341 
	`TRACE_DBG
("aùive_sysfs_wÜk %d", 
aùive_sysfs_wÜks
);

7342 ià(
aùive_sysfs_wÜks
 > 0)

7343 
»s
 = -
EAGAIN
;

7345 
»s
 = 
	`¥rštf
(
buf
, "%d\n", 
Ï¡_sysfs_wÜk_»s
);

7346 
	`¥š_uÆock
(&
sysfs_wÜk_lock
);

7348 
	`TRACE_EXIT_RES
(
»s
);

7349  
»s
;

7350 
	}
}

7352 
kobj_©Œibu‹
 
	gsc¡_Ï¡_sysfs_mgmt_»s_©Œ
 =

7353 
__ATTR
(
Ï¡_sysfs_mgmt_»s
, 
S_IRUGO
,

7354 
sc¡_Ï¡_sysfs_mgmt_»s_show
, 
NULL
);

7356 
©Œibu‹
 *
	gsc¡_sysfs_roÙ_deçuÉ_©Œs
[] = {

7357 &
sc¡_th»ads_©Œ
.
©Œ
,

7358 &
sc¡_£tup_id_©Œ
.
©Œ
,

7359 &
sc¡_max_skËt_cmd_©Œ
.
©Œ
,

7360 &
sc¡_su¥’d_©Œ
.
©Œ
,

7361 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

7362 &
sc¡_maš_Œaû_Ëv–_©Œ
.
©Œ
,

7364 &
sc¡_Œaû_cmds_©Œ
.
©Œ
,

7365 &
sc¡_Œaû_mcmds_©Œ
.
©Œ
,

7366 &
sc¡_v”siÚ_©Œ
.
©Œ
,

7367 &
sc¡_Ï¡_sysfs_mgmt_»s_©Œ
.
©Œ
,

7368 
NULL
,

7371 
	$sc¡_sysfs_roÙ_»Ëa£
(
kobjeù
 *
kobj
)

7373 
	`com¶‘e_®l
(&
sc¡_sysfs_roÙ_»Ëa£_com¶‘iÚ
);

7374 
	}
}

7376 
kobj_ty³
 
	gsc¡_sysfs_roÙ_kty³
 = {

7377 .
sysfs_Ýs
 = &
sc¡_sysfs_Ýs
,

7378 .
	g»Ëa£
 = 
sc¡_sysfs_roÙ_»Ëa£
,

7379 .
	gdeçuÉ_©Œs
 = 
sc¡_sysfs_roÙ_deçuÉ_©Œs
,

7386 
DEFINE_MUTEX
(
sc¡_sysfs_u£r_šfo_mu‹x
);

7389 
LIST_HEAD
(
sc¡_sysfs_u£r_šfo_li¡
);

7390 
ušt32_t
 
	gsc¡_sysfs_šfo_cur_cook›
;

7393 
sc¡_sysfs_u£r_šfo
 *
	$sc¡_sysfs_u£r_fšd_šfo
(
ušt32_t
 
cook›
)

7395 
sc¡_sysfs_u£r_šfo
 *
šfo
, *
»s
 = 
NULL
;

7397 
	`TRACE_ENTRY
();

7399 
	`li¡_fÜ_—ch_’Œy
(
šfo
, &
sc¡_sysfs_u£r_šfo_li¡
,

7400 
šfo_li¡_’Œy
) {

7401 ià(
šfo
->
šfo_cook›
 =ð
cook›
) {

7402 
»s
 = 
šfo
;

7407 
	`TRACE_EXIT_HRES
(
»s
);

7408  
»s
;

7409 
	}
}

7419 
sc¡_sysfs_u£r_šfo
 *
	$sc¡_sysfs_u£r_g‘_šfo
(
ušt32_t
 
cook›
)

7421 
sc¡_sysfs_u£r_šfo
 *
»s
 = 
NULL
;

7423 
	`TRACE_ENTRY
();

7425 
	`mu‹x_lock
(&
sc¡_sysfs_u£r_šfo_mu‹x
);

7427 
»s
 = 
	`sc¡_sysfs_u£r_fšd_šfo
(
cook›
);

7428 ià(
»s
 !ð
NULL
) {

7429 ià(!
»s
->
šfo_bešg_execu‹d
)

7430 
»s
->
šfo_bešg_execu‹d
 = 1;

7433 
	`mu‹x_uÆock
(&
sc¡_sysfs_u£r_šfo_mu‹x
);

7435 
	`TRACE_EXIT_HRES
(
»s
);

7436  
»s
;

7437 
	}
}

7438 
EXPORT_SYMBOL_GPL
(
sc¡_sysfs_u£r_g‘_šfo
);

7452 
	$sc¡_sysfs_u£r_add_šfo
(
sc¡_sysfs_u£r_šfo
 **
out_šfo
)

7454 
»s
 = 0;

7455 
sc¡_sysfs_u£r_šfo
 *
šfo
;

7457 
	`TRACE_ENTRY
();

7459 
šfo
 = 
	`kz®loc
((*šfo), 
GFP_KERNEL
);

7460 ià(
šfo
 =ð
NULL
) {

7461 
	`PRINT_ERROR
("Unableo‡llocate sysfs user info (size %zd)",

7462 (*
šfo
));

7463 
»s
 = -
ENOMEM
;

7464 
out
;

7467 
	`mu‹x_lock
(&
sc¡_sysfs_u£r_šfo_mu‹x
);

7469 (
šfo
->
šfo_cook›
 == 0) ||

7470 (
	`sc¡_sysfs_u£r_fšd_šfo
(
šfo
->
šfo_cook›
è!ð
NULL
))

7471 
šfo
->
šfo_cook›
 = 
sc¡_sysfs_šfo_cur_cook›
++;

7473 
	`š™_com¶‘iÚ
(&
šfo
->
šfo_com¶‘iÚ
);

7475 
	`li¡_add_ž
(&
šfo
->
šfo_li¡_’Œy
, &
sc¡_sysfs_u£r_šfo_li¡
);

7476 
šfo
->
šfo_š_li¡
 = 1;

7478 *
out_šfo
 = 
šfo
;

7480 
	`mu‹x_uÆock
(&
sc¡_sysfs_u£r_šfo_mu‹x
);

7482 
out
:

7483 
	`TRACE_EXIT_RES
(
»s
);

7484  
»s
;

7485 
	}
}

7486 
EXPORT_SYMBOL_GPL
(
sc¡_sysfs_u£r_add_šfo
);

7491 
	$sc¡_sysfs_u£r_d–_šfo
(
sc¡_sysfs_u£r_šfo
 *
šfo
)

7493 
	`TRACE_ENTRY
();

7495 
	`mu‹x_lock
(&
sc¡_sysfs_u£r_šfo_mu‹x
);

7497 ià(
šfo
->
šfo_š_li¡
)

7498 
	`li¡_d–
(&
šfo
->
šfo_li¡_’Œy
);

7500 
	`mu‹x_uÆock
(&
sc¡_sysfs_u£r_šfo_mu‹x
);

7502 
	`kä“
(
šfo
);

7504 
	`TRACE_EXIT
();

7506 
	}
}

7507 
EXPORT_SYMBOL_GPL
(
sc¡_sysfs_u£r_d–_šfo
);

7514 
boÞ
 
	$sc¡_sysfs_u£r_šfo_executšg
(
sc¡_sysfs_u£r_šfo
 *
šfo
)

7516 
boÞ
 
»s
;

7518 
	`TRACE_ENTRY
();

7520 
	`mu‹x_lock
(&
sc¡_sysfs_u£r_šfo_mu‹x
);

7522 
»s
 = 
šfo
->
šfo_bešg_execu‹d
;

7524 ià(
šfo
->
šfo_š_li¡
) {

7525 
	`li¡_d–
(&
šfo
->
šfo_li¡_’Œy
);

7526 
šfo
->
šfo_š_li¡
 = 0;

7529 
	`mu‹x_uÆock
(&
sc¡_sysfs_u£r_šfo_mu‹x
);

7531 
	`TRACE_EXIT_RES
(
»s
);

7532  
»s
;

7533 
	}
}

7545 
	$sc¡_wa™_šfo_com¶‘iÚ
(
sc¡_sysfs_u£r_šfo
 *
šfo
,

7546 
timeout
)

7548 
»s
, 
rc
;

7550 
	`TRACE_ENTRY
();

7552 
	`TRACE_DBG
("Wa™šg fÜ infØ%°com¶‘iÚ", 
šfo
);

7555 
rc
 = 
	`wa™_fÜ_com¶‘iÚ_š‹¼u±ibË_timeout
(

7556 &
šfo
->
šfo_com¶‘iÚ
, 
timeout
);

7557 ià(
rc
 > 0) {

7558 
	`TRACE_DBG
("Waiting for info %p finished with %d",

7559 
šfo
, 
rc
);

7561 } ià(
rc
 == 0) {

7562 ià(!
	`sc¡_sysfs_u£r_šfo_executšg
(
šfo
)) {

7563 
	`PRINT_ERROR
("Timeout waiting for user "

7564 "¥aûƒv’ˆ%p", 
šfo
);

7565 
»s
 = -
EBUSY
;

7566 
out
;

7569 
	`TRACE_DBG
("Keep waiting for info %p completion",

7570 
šfo
);

7571 
	`wa™_fÜ_com¶‘iÚ
(&
šfo
->
šfo_com¶‘iÚ
);

7574 } ià(
rc
 !ð-
ERESTARTSYS
) {

7575 
»s
 = 
rc
;

7576 
	`PRINT_ERROR
("wa™_fÜ_com¶‘iÚ(èçžed: %d", 
»s
);

7577 
out
;

7579 
	`TRACE_DBG
("Waiting for info %p finished with %d, "

7580 "»Œyšg", 
šfo
, 
rc
);

7584 
	`TRACE_DBG
("šfØ%p, stu %d", 
šfo
, info->
šfo_¡©us
);

7585 
»s
 = 
šfo
->
šfo_¡©us
;

7587 
out
:

7588 
	`TRACE_EXIT_RES
(
»s
);

7589  
»s
;

7590 
	}
}

7591 
EXPORT_SYMBOL_GPL
(
sc¡_wa™_šfo_com¶‘iÚ
);

7593 
__š™
 
	$sc¡_sysfs_š™
()

7595 
»s
 = 0;

7597 
	`TRACE_ENTRY
();

7599 
sysfs_wÜk_th»ad
 = 
	`kth»ad_run
(
sysfs_wÜk_th»ad_â
,

7600 
NULL
, "scst_uid");

7601 ià(
	`IS_ERR
(
sysfs_wÜk_th»ad
)) {

7602 
»s
 = 
	`PTR_ERR
(
sysfs_wÜk_th»ad
);

7603 
	`PRINT_ERROR
("kthread_run() for user interfacehread "

7604 "çžed: %d", 
»s
);

7605 
sysfs_wÜk_th»ad
 = 
NULL
;

7606 
out
;

7609 
»s
 = 
	`kobjeù_š™_ªd_add
(&
sc¡_sysfs_roÙ_kobj
,

7610 &
sc¡_sysfs_roÙ_kty³
, 
k”Ãl_kobj
, "%s", "scst_tgt");

7611 ià(
»s
 != 0)

7612 
sysfs_roÙ_add_”rÜ
;

7614 
sc¡_rg‘s_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("targets",

7615 &
sc¡_sysfs_roÙ_kobj
);

7616 ià(
sc¡_rg‘s_kobj
 =ð
NULL
)

7617 
rg‘s_kobj_”rÜ
;

7619 
sc¡_deviûs_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("devices",

7620 &
sc¡_sysfs_roÙ_kobj
);

7621 ià(
sc¡_deviûs_kobj
 =ð
NULL
)

7622 
deviûs_kobj_”rÜ
;

7624 
»s
 = 
	`sc¡_add_sgv_kobj
(&
sc¡_sysfs_roÙ_kobj
, "sgv");

7625 ià(
»s
 != 0)

7626 
sgv_kobj_”rÜ
;

7628 
sc¡_hªdËrs_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("handlers",

7629 &
sc¡_sysfs_roÙ_kobj
);

7630 ià(
sc¡_hªdËrs_kobj
 =ð
NULL
)

7631 
hªdËrs_kobj_”rÜ
;

7633 
sc¡_deviû_groups_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("device_groups",

7634 &
sc¡_sysfs_roÙ_kobj
);

7635 ià(
sc¡_deviû_groups_kobj
 =ð
NULL
)

7636 
deviû_groups_kobj_”rÜ
;

7638 ià(
	`sysfs_ü—‹_fžes
(
sc¡_deviû_groups_kobj
,

7639 
sc¡_deviû_groups_©Œs
))

7640 
deviû_groups_©Œs_”rÜ
;

7642 
out
:

7643 
	`TRACE_EXIT_RES
(
»s
);

7644  
»s
;

7646 
deviû_groups_©Œs_”rÜ
:

7647 
	`kobjeù_d–
(
sc¡_deviû_groups_kobj
);

7648 
	`kobjeù_put
(
sc¡_deviû_groups_kobj
);

7650 
deviû_groups_kobj_”rÜ
:

7651 
	`kobjeù_d–
(
sc¡_hªdËrs_kobj
);

7652 
	`kobjeù_put
(
sc¡_hªdËrs_kobj
);

7654 
hªdËrs_kobj_”rÜ
:

7655 
	`sc¡_d–_put_sgv_kobj
();

7657 
sgv_kobj_”rÜ
:

7658 
	`kobjeù_d–
(
sc¡_deviûs_kobj
);

7659 
	`kobjeù_put
(
sc¡_deviûs_kobj
);

7661 
deviûs_kobj_”rÜ
:

7662 
	`kobjeù_d–
(
sc¡_rg‘s_kobj
);

7663 
	`kobjeù_put
(
sc¡_rg‘s_kobj
);

7665 
rg‘s_kobj_”rÜ
:

7666 
	`kobjeù_d–
(&
sc¡_sysfs_roÙ_kobj
);

7668 
sysfs_roÙ_add_”rÜ
:

7669 
	`kobjeù_put
(&
sc¡_sysfs_roÙ_kobj
);

7671 
	`kth»ad_¡Ý
(
sysfs_wÜk_th»ad
);

7673 ià(
»s
 == 0)

7674 
»s
 = -
EINVAL
;

7676 
out
;

7677 
	}
}

7679 
	$sc¡_sysfs_þ—nup
()

7681 
	`TRACE_ENTRY
();

7683 
	`PRINT_INFO
("%s", "Exiting SCST sysfs hierarchy...");

7685 
	`sc¡_d–_put_sgv_kobj
();

7687 
	`kobjeù_d–
(
sc¡_deviûs_kobj
);

7688 
	`kobjeù_put
(
sc¡_deviûs_kobj
);

7690 
	`kobjeù_d–
(
sc¡_rg‘s_kobj
);

7691 
	`kobjeù_put
(
sc¡_rg‘s_kobj
);

7693 
	`kobjeù_d–
(
sc¡_hªdËrs_kobj
);

7694 
	`kobjeù_put
(
sc¡_hªdËrs_kobj
);

7696 
	`sysfs_»move_fžes
(
sc¡_deviû_groups_kobj
, 
sc¡_deviû_groups_©Œs
);

7698 
	`kobjeù_d–
(
sc¡_deviû_groups_kobj
);

7699 
	`kobjeù_put
(
sc¡_deviû_groups_kobj
);

7701 
	`kobjeù_d–
(&
sc¡_sysfs_roÙ_kobj
);

7702 
	`kobjeù_put
(&
sc¡_sysfs_roÙ_kobj
);

7704 
	`wa™_fÜ_com¶‘iÚ
(&
sc¡_sysfs_roÙ_»Ëa£_com¶‘iÚ
);

7712 
	`m¦“p
(3000);

7714 ià(
sysfs_wÜk_th»ad
)

7715 
	`kth»ad_¡Ý
(
sysfs_wÜk_th»ad
);

7717 
	`PRINT_INFO
("%s", "Exiting SCST sysfs hierarchy done");

7719 
	`TRACE_EXIT
();

7721 
	}
}

	@scst/src/scst_targ.c

19 
	~<lšux/š™.h
>

20 
	~<lšux/k”Ãl.h
>

21 
	~<lšux/”ºo.h
>

22 
	~<lšux/li¡.h
>

23 
	~<lšux/¥šlock.h
>

24 
	~<lšux/¦ab.h
>

25 
	~<lšux/sched.h
>

26 
	~<lšux/uni¡d.h
>

27 
	~<lšux/¡ršg.h
>

28 
	~<lšux/ùy³.h
>

29 
	~<lšux/kth»ad.h
>

30 
	~<lšux/d–ay.h
>

31 
	~<lšux/ktime.h
>

32 
	~<lšux/vm®loc.h
>

33 
	~<scsi/sg.h
>

35 #ifdeà
INSIDE_KERNEL_TREE


36 
	~<sc¡/sc¡.h
>

38 
	~"sc¡.h
"

40 
	~"sc¡_´iv.h
"

41 
	~"sc¡_´es.h
"

43 
sc¡_cmd_£t_¢
(
sc¡_cmd
 *
cmd
);

44 
__sc¡_š™_cmd
(
sc¡_cmd
 *
cmd
);

45 
sc¡_cmd
 *
__sc¡_fšd_cmd_by_g
(
sc¡_£ssiÚ
 *
£ss
,

46 
ušt64_t
 
g
, 
boÞ
 
to_abÜt
);

47 
sc¡_´oûss_»dœeù_cmd
(
sc¡_cmd
 *
cmd
,

48 
sc¡_exec_cÚ‹xt
 
cÚ‹xt
, 
check_»Œ›s
);

56 
	$sc¡_po¡_·r£
(
sc¡_cmd
 *
cmd
)

58 
	`sc¡_£t_·r£_time
(
cmd
);

59 
	}
}

60 
EXPORT_SYMBOL_GPL
(
sc¡_po¡_·r£
);

69 
	$sc¡_po¡_®loc_d©a_buf
(
sc¡_cmd
 *
cmd
)

71 
	`sc¡_£t_®loc_buf_time
(
cmd
);

72 
	}
}

73 
EXPORT_SYMBOL_GPL
(
sc¡_po¡_®loc_d©a_buf
);

75 
šlše
 
	$sc¡_scheduË_skËt
(
sc¡_cmd
 *
cmd
)

77 
sc¡_³rýu_šfo
 *
i
;

78 
æags
;

80 
	`´“m±_di§bË
();

82 
i
 = &
sc¡_³rýu_šfos
[
	`smp_´oûssÜ_id
()];

84 ià(
	`©omic_»ad
(&
i
->
ýu_cmd_couÁ
è<ð
sc¡_max_skËt_cmd
) {

85 
	`¥š_lock_œq§ve
(&
i
->
skËt_lock
, 
æags
);

86 
	`TRACE_DBG
("Addšg cmd %°tØskËˆ%d cmd†i¡", 
cmd
,

87 
	`smp_´oûssÜ_id
());

88 
	`li¡_add_ž
(&
cmd
->
cmd_li¡_’Œy
, &
i
->
skËt_cmd_li¡
);

89 
	`¥š_uÆock_œq»¡Üe
(&
i
->
skËt_lock
, 
æags
);

91 
	`skËt_scheduË
(&
i
->
skËt
);

93 
	`¥š_lock_œq§ve
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
, 
æags
);

94 
	`TRACE_DBG
("Too manyasklet commands (%d),‡dding cmd %po "

95 "aùivcmd†i¡", 
	`©omic_»ad
(&
i
->
ýu_cmd_couÁ
), 
cmd
);

96 
	`li¡_add_ž
(&
cmd
->
cmd_li¡_’Œy
,

97 &
cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

98 
	`wake_up
(&
cmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

99 
	`¥š_uÆock_œq»¡Üe
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
, 
æags
);

102 
	`´“m±_’abË
();

104 
	}
}

106 
boÞ
 
	$sc¡_unm­_ov”Ïp
(
sc¡_cmd
 *
cmd
, 
št64_t
 
lba2
,

107 
št64_t
 
lba2_blocks
)

109 
boÞ
 
»s
 = 
çl£
;

110 
sc¡_d©a_desütÜ
 *
pd
 = 
cmd
->
cmd_d©a_desütÜs
;

111 
i
;

113 
	`TRACE_ENTRY
();

115 ià(
pd
 =ð
NULL
)

116 
out
;

118 
i
 = 0; 
pd
[i].
sdd_blocks
 != 0; i++) {

119 
sc¡_d©a_desütÜ
 *
d
 = &
pd
[
i
];

121 
	`TRACE_DBG
("˜%d,†b¨%Îd, block %Îd", 
i
,

122 ()
d
->
sdd_lba
, ()d->
sdd_blocks
);

123 
»s
 = 
	`sc¡_lba1_šside_lba2
(
d
->
sdd_lba
, 
lba2
, 
lba2_blocks
);

124 ià(
»s
)

125 
out
;

126 
»s
 = 
	`sc¡_lba1_šside_lba2
(
lba2
, 
d
->
sdd_lba
, d->
sdd_blocks
);

127 ià(
»s
)

128 
out
;

131 
out
:

132 
	`TRACE_EXIT_RES
(
»s
);

133  
»s
;

134 
	}
}

136 
boÞ
 
	$sc¡_cmd_ov”Ïp_cwr
(
sc¡_cmd
 *
cwr_cmd
, sc¡_cmd *
cmd
)

138 
boÞ
 
»s
;

140 
	`TRACE_ENTRY
();

142 
	`TRACE_DBG
("cwr_cmd %p, cmd %p (op %s, LBA valid %d,†ba %lld, "

143 "ËÀ%Îd)", 
cwr_cmd
, 
cmd
, 
	`sc¡_g‘_Ýcode_Çme
(cmd),

144 (
cmd
->
Ý_æags
 & 
SCST_LBA_NOT_VALID
) == 0,

145 ()
cmd
->
lba
, ()cmd->
d©a_Ën
);

147 
	`EXTRACHECKS_BUG_ON
(
cwr_cmd
->
cdb
[0] !ð
COMPARE_AND_WRITE
);

156 ià(
cmd
->
Ý_æags
 & 
SCST_LBA_NOT_VALID
) {

157 
cmd
->
cdb
[0]) {

158 
RESERVE
:

159 
RESERVE_10
:

160 
»s
 = 
Œue
;

162 
UNMAP
:

163 
»s
 = 
	`sc¡_unm­_ov”Ïp
(
cmd
, 
cwr_cmd
->
lba
,

164 
cwr_cmd
->
d©a_Ën
);

166 
EXTENDED_COPY
:

167 
»s
 = 
	`sc¡_cm_ec_cmd_ov”Ïp
(
cmd
, 
cwr_cmd
);

170 
»s
 = 
çl£
;

173 
out
;

177 
	`EXTRACHECKS_BUG_ON
(
cmd
->
dev
->
block_shiá
 <= 0);

179 
»s
 = 
	`sc¡_lba1_šside_lba2
(
cwr_cmd
->
lba
, 
cmd
->lba,

180 
cmd
->
d©a_Ën
 >> cmd->
dev
->
block_shiá
);

181 ià(
»s
)

182 
out
;

184 
»s
 = 
	`sc¡_lba1_šside_lba2
(
cmd
->
lba
, 
cwr_cmd
->lba,

185 
cwr_cmd
->
d©a_Ën
 >> cwr_cmd->
dev
->
block_shiá
);

187 
out
:

188 
	`TRACE_EXIT_RES
(
»s
);

189  
»s
;

190 
	}
}

192 
boÞ
 
	$sc¡_cmd_ov”Ïp_»£rve
(
sc¡_cmd
 *
»£rve_cmd
,

193 
sc¡_cmd
 *
cmd
)

195 
boÞ
 
»s
;

197 
	`TRACE_ENTRY
();

199 
	`TRACE_DBG
("reserve_cmd %p, cmd %p (op %s, LBA valid %d,†ba %lld, "

200 "ËÀ%Îd)", 
»£rve_cmd
, 
cmd
, 
	`sc¡_g‘_Ýcode_Çme
(cmd),

201 (
cmd
->
Ý_æags
 & 
SCST_LBA_NOT_VALID
) == 0,

202 ()
cmd
->
lba
, ()cmd->
d©a_Ën
);

204 
	`EXTRACHECKS_BUG_ON
((
»£rve_cmd
->
cdb
[0] !ð
RESERVE
) &&

205 (
»£rve_cmd
->
cdb
[0] !ð
RESERVE_10
));

214 ià(
cmd
->
cdb
[0] =ð
COMPARE_AND_WRITE
)

215 
»s
 = 
Œue
;

217 
»s
 = 
çl£
;

219 
	`TRACE_EXIT_RES
(
»s
);

220  
»s
;

221 
	}
}

223 
boÞ
 
	$sc¡_cmd_ov”Ïp_©omic
(
sc¡_cmd
 *
©omic_cmd
, sc¡_cmd *
cmd
)

225 
boÞ
 
»s
;

227 
	`TRACE_ENTRY
();

229 
	`TRACE_DBG
("©omic_cmd %°(Ý %s), cmd %°(Ý %s)", 
©omic_cmd
,

230 
	`sc¡_g‘_Ýcode_Çme
(
©omic_cmd
), 
cmd
, scst_get_opcode_name(cmd));

232 
	`EXTRACHECKS_BUG_ON
((
©omic_cmd
->
Ý_æags
 & 
SCST_SCSI_ATOMIC
) == 0);

234 
©omic_cmd
->
cdb
[0]) {

235 
COMPARE_AND_WRITE
:

236 
»s
 = 
	`sc¡_cmd_ov”Ïp_cwr
(
©omic_cmd
, 
cmd
);

238 
RESERVE
:

239 
RESERVE_10
:

240 
»s
 = 
	`sc¡_cmd_ov”Ïp_»£rve
(
©omic_cmd
, 
cmd
);

243 
»s
 = 
çl£
;

247 
	`TRACE_EXIT_RES
(
»s
);

248  
»s
;

249 
	}
}

251 
boÞ
 
	$sc¡_cmd_ov”Ïp
(
sc¡_cmd
 *
chk_cmd
, sc¡_cmd *
cmd
)

253 
boÞ
 
»s
 = 
çl£
;

255 
	`TRACE_ENTRY
();

257 
	`TRACE_DBG
("chk_cmd %p, cmd %p", 
chk_cmd
, 
cmd
);

259 ià((
chk_cmd
->
Ý_æags
 & 
SCST_SCSI_ATOMIC
) != 0)

260 
»s
 = 
	`sc¡_cmd_ov”Ïp_©omic
(
chk_cmd
, 
cmd
);

261 ià((
cmd
->
Ý_æags
 & 
SCST_SCSI_ATOMIC
) != 0)

262 
»s
 = 
	`sc¡_cmd_ov”Ïp_©omic
(
cmd
, 
chk_cmd
);

264 
»s
 = 
çl£
;

266 
	`TRACE_EXIT_RES
(
»s
);

267  
»s
;

268 
	}
}

274 
boÞ
 
	$sc¡_check_scsi_©omic™y
(
sc¡_cmd
 *
chk_cmd
)

276 
boÞ
 
»s
 = 
çl£
;

277 
sc¡_deviû
 *
dev
 = 
chk_cmd
->dev;

278 
sc¡_cmd
 *
cmd
;

280 
	`TRACE_ENTRY
();

287 
	`TRACE_DBG
("chk_cmd %p (op %s, internal %d,†ba %lld,†en %lld)",

288 
chk_cmd
, 
	`sc¡_g‘_Ýcode_Çme
(chk_cmd), chk_cmd->
š‹º®
,

289 ()
chk_cmd
->
lba
, ()chk_cmd->
d©a_Ën
);

291 
	`li¡_fÜ_—ch_’Œy
(
cmd
, &
dev
->
dev_exec_cmd_li¡
, 
dev_exec_cmd_li¡_’Œy
) {

292 ià(
chk_cmd
 =ð
cmd
)

294 ià(
	`sc¡_cmd_ov”Ïp
(
chk_cmd
, 
cmd
)) {

295 
sc¡_cmd
 **
p
 = 
cmd
->
scsi_©omic_blocked_cmds
;

302 
p
 = 
	`k»®loc
Õ, (*pè* (
cmd
->
scsi_©omic_blocked_cmds_couÁ
 + 1),

303 
GFP_ATOMIC
);

304 ià(
p
 =ð
NULL
)

305 
out_busy_undo
;

306 
p
[
cmd
->
scsi_©omic_blocked_cmds_couÁ
] = 
chk_cmd
;

307 
cmd
->
scsi_©omic_blocked_cmds
 = 
p
;

308 
cmd
->
scsi_©omic_blocked_cmds_couÁ
++;

310 
chk_cmd
->
scsi_©omic_block”s
++;

312 
	`TRACE_BLOCK
("Delaying cmd %p (op %s,†ba %lld, "

315 "cmd %d)", 
chk_cmd
, 
	`sc¡_g‘_Ýcode_Çme
(chk_cmd),

316 ()
chk_cmd
->
lba
,

317 ()
chk_cmd
->
d©a_Ën
,

318 
chk_cmd
->
scsi_©omic_block”s
, 
cmd
,

319 
	`sc¡_g‘_Ýcode_Çme
(
cmd
), ()cmd->
lba
,

320 ()
cmd
->
d©a_Ën
,

321 
cmd
->
scsi_©omic_blocked_cmds_couÁ
);

322 
»s
 = 
Œue
;

326 
out
:

327 
	`TRACE_EXIT_RES
(
»s
);

328  
»s
;

330 
out_busy_undo
:

331 
	`li¡_fÜ_—ch_’Œy
(
cmd
, &
dev
->
dev_exec_cmd_li¡
, 
dev_exec_cmd_li¡_’Œy
) {

332 
sc¡_cmd
 **
p
 = 
cmd
->
scsi_©omic_blocked_cmds
;

334 ià((
p
 !ð
NULL
è&& (p[
cmd
->
scsi_©omic_blocked_cmds_couÁ
-1] =ð
chk_cmd
)) {

335 
cmd
->
scsi_©omic_blocked_cmds_couÁ
--;

336 
chk_cmd
->
scsi_©omic_block”s
--;

339 
	`sBUG_ON
(
chk_cmd
->
scsi_©omic_block”s
 != 0);

341 
	`sc¡_£t_busy
(
chk_cmd
);

342 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
chk_cmd
);

344 
	`¥š_lock_œq
(&
chk_cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

345 
	`TRACE_MGMT_DBG
("Adding onƒrror chk_cmd %p backo head of‡ctive cmd "

346 "li¡", 
chk_cmd
);

347 
	`li¡_add
(&
chk_cmd
->
cmd_li¡_’Œy
, &chk_cmd->
cmd_th»ads
->
aùive_cmd_li¡
);

348 
	`wake_up
(&
chk_cmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

349 
	`¥š_uÆock_œq
(&
chk_cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

351 
»s
 = 
çl£
;

352 
out
;

353 
	}
}

359 
boÞ
 
	$sc¡_do_check_blocked_dev
(
sc¡_cmd
 *
cmd
)

361 
boÞ
 
»s
;

362 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

364 
	`TRACE_ENTRY
();

375 ià(
	`lik–y
(!
cmd
->
Ú_dev_exec_li¡
)) {

376 
	`li¡_add_ž
(&
cmd
->
dev_exec_cmd_li¡_’Œy
, &
dev
->
dev_exec_cmd_li¡
);

377 
cmd
->
Ú_dev_exec_li¡
 = 1;

386 ià(
	`uÆik–y
(((
cmd
->
Ý_æags
 & 
SCST_SCSI_ATOMIC
) != 0) ||

387 (
dev
->
dev_scsi_©omic_cmd_aùive
 != 0)) &&

388 !
cmd
->
scsi_©omic™y_checked
) {

389 
cmd
->
scsi_©omic™y_checked
 = 1;

390 ià((
cmd
->
Ý_æags
 & 
SCST_SCSI_ATOMIC
) != 0) {

391 
dev
->
dev_scsi_©omic_cmd_aùive
++;

392 
	`TRACE_DBG
("cmd %p (dev %p), scsi‡tomic_cmd_active %d",

393 
cmd
, 
dev
, dev->
dev_scsi_©omic_cmd_aùive
);

396 
»s
 = 
	`sc¡_check_scsi_©omic™y
(
cmd
);

397 ià(
»s
) {

398 
	`EXTRACHECKS_BUG_ON
(
dev
->
dev_scsi_©omic_cmd_aùive
 == 0);

399 
out
;

403 
dev
->
Ú_dev_cmd_couÁ
++;

404 
cmd
->
dec_Ú_dev_Ãeded
 = 1;

405 
	`TRACE_DBG
("New inøÚ_dev_couÁ %d (cmd %p)", 
dev
->
Ú_dev_cmd_couÁ
, 
cmd
);

407 ià(
	`uÆik–y
(
dev
->
block_couÁ
 > 0) ||

408 
	`uÆik–y
(
dev
->
dev_doubË_ua_possibË
) ||

409 
	`uÆik–y
((
cmd
->
Ý_æags
 & 
SCST_SERIALIZED
) != 0))

410 
»s
 = 
	`__sc¡_check_blocked_dev
(
cmd
);

412 
»s
 = 
çl£
;

414 ià(
	`uÆik–y
(
»s
)) {

416 
dev
->
Ú_dev_cmd_couÁ
--;

417 
cmd
->
dec_Ú_dev_Ãeded
 = 0;

418 
	`TRACE_DBG
("New dec on_dev_count %d (cmd %p)",

419 
dev
->
Ú_dev_cmd_couÁ
, 
cmd
);

420 
out
;

423 
out
:

424 
	`TRACE_EXIT_RES
(
»s
);

425  
»s
;

426 
	}
}

432 
boÞ
 
	$sc¡_check_blocked_dev
(
sc¡_cmd
 *
cmd
)

434 
boÞ
 
»s
;

435 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

437 
	`TRACE_ENTRY
();

439 ià(
	`uÆik–y
((
cmd
->
Ý_æags
 & 
SCST_CAN_GEN_3PARTY_COMMANDS
) != 0)) {

440 
	`EXTRACHECKS_BUG_ON
(
cmd
->
cdb
[0] !ð
EXTENDED_COPY
);

441 
»s
 = 
	`sc¡_cm_check_block_®l_devs
(
cmd
);

442 
out
;

445 ià(
	`uÆik–y
(
cmd
->
š‹º®
 || cmd->
by·ss_blockšg
)) {

452 
	`sBUG_ON
((
dev
->
Ú_dev_cmd_couÁ
 =ð0è&& (
cmd
->
cdb
[0] !ð
INQUIRY
));

454 
»s
 = 
çl£
;

455 
out
;

458 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

459 
»s
 = 
	`sc¡_do_check_blocked_dev
(
cmd
);

460 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

462 
out
:

463 
	`TRACE_EXIT_RES
(
»s
);

464  
»s
;

465 
	}
}

468 
	$sc¡_check_unblock_scsi_©omic_cmds
(
sc¡_cmd
 *
cmd
)

470 
i
;

472 
	`TRACE_ENTRY
();

474 
	`EXTRACHECKS_BUG_ON
(
cmd
->
scsi_©omic_blocked_cmds_couÁ
 == 0);

476 
i
 = 0; i < 
cmd
->
scsi_©omic_blocked_cmds_couÁ
; i++) {

477 
sc¡_cmd
 *
acmd
 = 
cmd
->
scsi_©omic_blocked_cmds
[
i
];

479 
acmd
->
scsi_©omic_block”s
--;

480 ià(
acmd
->
scsi_©omic_block”s
 == 0) {

481 
	`TRACE_BLOCK
("Unblocking blocked‡cmd %p (blocker "

482 "cmd %p)", 
acmd
, 
cmd
);

483 
	`¥š_lock_œq
(&
acmd
->
cmd_th»ads
->
cmd_li¡_lock
);

484 ià(
acmd
->
queue_ty³
 =ð
SCST_CMD_QUEUE_HEAD_OF_QUEUE
)

485 
	`li¡_add
(&
acmd
->
cmd_li¡_’Œy
,

486 &
acmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

488 
	`li¡_add_ž
(&
acmd
->
cmd_li¡_’Œy
,

489 &
acmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

490 
	`wake_up
(&
acmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

491 
	`¥š_uÆock_œq
(&
acmd
->
cmd_th»ads
->
cmd_li¡_lock
);

495 
	`kä“
(
cmd
->
scsi_©omic_blocked_cmds
);

496 
cmd
->
scsi_©omic_blocked_cmds
 = 
NULL
;

497 
cmd
->
scsi_©omic_blocked_cmds_couÁ
 = 0;

499 
	`TRACE_EXIT
();

501 
	}
}

504 
	$__sc¡_check_unblock_dev
(
sc¡_cmd
 *
cmd
)

506 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

508 
	`TRACE_ENTRY
();

516 ià(
	`lik–y
(
cmd
->
Ú_dev_exec_li¡
)) {

517 
	`li¡_d–
(&
cmd
->
dev_exec_cmd_li¡_’Œy
);

518 
cmd
->
Ú_dev_exec_li¡
 = 0;

521 ià(
	`uÆik–y
((
cmd
->
Ý_æags
 & 
SCST_SCSI_ATOMIC
) != 0)) {

522 ià(
	`lik–y
(
cmd
->
scsi_©omic™y_checked
)) {

523 
dev
->
dev_scsi_©omic_cmd_aùive
--;

524 
	`TRACE_DBG
("cmd %p, scsi‡tomic_cmd_active %d",

525 
cmd
, 
dev
->
dev_scsi_©omic_cmd_aùive
);

526 
cmd
->
scsi_©omic™y_checked
 = 0;

530 ià(
	`lik–y
(
cmd
->
dec_Ú_dev_Ãeded
)) {

531 
dev
->
Ú_dev_cmd_couÁ
--;

532 
cmd
->
dec_Ú_dev_Ãeded
 = 0;

533 
	`TRACE_DBG
("New dec on_dev_count %d (cmd %p)",

534 
dev
->
Ú_dev_cmd_couÁ
, 
cmd
);

537 ià(
	`uÆik–y
(
cmd
->
scsi_©omic_blocked_cmds
 !ð
NULL
))

538 
	`sc¡_check_unblock_scsi_©omic_cmds
(
cmd
);

540 ià(
	`uÆik–y
(
cmd
->
unblock_dev
)) {

541 
	`TRACE_BLOCK
("cmd %°Ñag %Îu): unblockšg dev %s", 
cmd
,

542 ()
cmd
->
g
, 
dev
->
vœt_Çme
);

543 
cmd
->
unblock_dev
 = 0;

544 
	`sc¡_unblock_dev
(
dev
);

545 } ià(
	`uÆik–y
(
dev
->
¡riùly_£rŸlized_cmd_wa™šg
)) {

546 ià(
dev
->
Ú_dev_cmd_couÁ
 == 0) {

547 
	`TRACE_BLOCK
("Strictly serialized cmd waiting: "

548 "unblockšg dev %s", 
dev
->
vœt_Çme
);

549 
	`sc¡_unblock_dev
(
dev
);

550 
dev
->
¡riùly_£rŸlized_cmd_wa™šg
 = 0;

554 ià(
	`uÆik–y
(
dev
->
ext_blockšg_³ndšg
)) {

555 ià(
dev
->
Ú_dev_cmd_couÁ
 == 0) {

556 
	`TRACE_MGMT_DBG
("Releasing…ending dev %sƒxtended "

557 "blocks", 
dev
->
vœt_Çme
);

558 
	`sc¡_ext_blockšg_dÚe
(
dev
);

562 
	`TRACE_EXIT
();

564 
	}
}

567 
	$sc¡_check_unblock_dev
(
sc¡_cmd
 *
cmd
)

569 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

571 
	`TRACE_ENTRY
();

573 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

574 
	`__sc¡_check_unblock_dev
(
cmd
);

575 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

577 
	`TRACE_EXIT
();

579 
	}
}

581 
	$__sc¡_rx_cmd
(
sc¡_cmd
 *
cmd
, 
sc¡_£ssiÚ
 *
£ss
,

582 cÚ¡ 
ušt8_t
 *
lun
, 
lun_Ën
, 
gå_t
 
gå_mask
)

584 
	`TRACE_ENTRY
();

586 
cmd
->
£ss
 = sess;

587 
	`sc¡_£ss_g‘
(
£ss
);

589 
cmd
->
tgt
 = 
£ss
->tgt;

590 
cmd
->
tg‰
 = 
£ss
->
tgt
->tgtt;

592 
cmd
->
lun
 = 
	`sc¡_uÅack_lun
Öun, 
lun_Ën
);

593 ià(
	`uÆik–y
(
cmd
->
lun
 =ð
NO_SUCH_LUN
))

594 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

595 
	`SCST_LOAD_SENSE
(
sc¡_£n£_lun_nÙ_suµÜ‹d
));

597 
	`TRACE_DBG
("cmd %p, ses %p", 
cmd
, 
£ss
);

599 
	`TRACE_EXIT
();

601 
	}
}

622 
	$sc¡_rx_cmd_´—Îoûd
(
sc¡_cmd
 *
cmd
, 
sc¡_£ssiÚ
 *
£ss
,

623 cÚ¡ 
ušt8_t
 *
lun
, 
lun_Ën
, cÚ¡ ušt8_ˆ*
cdb
,

624 
cdb_Ën
, 
boÞ
 
©omic
)

626 
»s
;

627 
gå_t
 
gå_mask
 = 
©omic
 ? 
GFP_ATOMIC
 : 
cmd
->
cmd_gå_mask
;

629 
	`TRACE_ENTRY
();

631 #ifdeà
CONFIG_SCST_EXTRACHECKS


632 ià(
	`uÆik–y
(
£ss
->
shut_pha£
 !ð
SCST_SESS_SPH_READY
)) {

633 
	`PRINT_CRIT_ERROR
("%s",

635 
	`sBUG
();

639 
»s
 = 
	`sc¡_´e_š™_cmd
(
cmd
, 
cdb
, 
cdb_Ën
, 
gå_mask
);

640 ià(
	`uÆik–y
(
»s
 != 0))

641 
out
;

643 
	`__sc¡_rx_cmd
(
cmd
, 
£ss
, 
lun
, 
lun_Ën
, 
gå_mask
);

645 
cmd
->
´e_®loûd
 = 1;

647 
out
:

648 
	`TRACE_EXIT_RES
(
»s
);

649  
»s
;

650 
	}
}

651 
EXPORT_SYMBOL
(
sc¡_rx_cmd_´—Îoûd
);

669 
sc¡_cmd
 *
	$sc¡_rx_cmd
(
sc¡_£ssiÚ
 *
£ss
,

670 cÚ¡ 
ušt8_t
 *
lun
, 
lun_Ën
, cÚ¡ ušt8_ˆ*
cdb
,

671 
cdb_Ën
, 
boÞ
 
©omic
)

673 
sc¡_cmd
 *
cmd
;

674 
gå_t
 
gå_mask
 = 
©omic
 ? 
GFP_ATOMIC
 : 
GFP_NOIO
;

676 
	`TRACE_ENTRY
();

678 #ifdeà
CONFIG_SCST_EXTRACHECKS


679 ià(
	`uÆik–y
(
£ss
->
shut_pha£
 !ð
SCST_SESS_SPH_READY
)) {

680 
	`PRINT_CRIT_ERROR
("%s",

682 
	`sBUG
();

686 
cmd
 = 
	`sc¡_®loc_cmd
(
cdb
, 
cdb_Ën
, 
gå_mask
);

687 ià(
cmd
 =ð
NULL
) {

688 
	`TRACE
(
TRACE_OUT_OF_MEM
, "%s", "Allocation of scst_cmd failed");

689 
out
;

692 
	`__sc¡_rx_cmd
(
cmd
, 
£ss
, 
lun
, 
lun_Ën
, 
gå_mask
);

694 
cmd
->
´e_®loûd
 = 0;

696 
out
:

697 
	`TRACE_EXIT
();

698  
cmd
;

699 
	}
}

700 
EXPORT_SYMBOL
(
sc¡_rx_cmd
);

707 
	$sc¡_š™_cmd
(
sc¡_cmd
 *
cmd
, 
sc¡_exec_cÚ‹xt
 *
cÚ‹xt
)

709 
rc
, 
»s
 = 0;

711 
	`TRACE_ENTRY
();

714 ià(
	`uÆik–y
(!
	`li¡_em±y
(&
sc¡_š™_cmd_li¡
))) {

715 
	`TRACE_DBG
("%s", "init cmd†ist busy");

716 
out_»dœeù
;

724 
rc
 = 
	`__sc¡_š™_cmd
(
cmd
);

725 ià(
	`uÆik–y
(
rc
 > 0))

726 
out_»dœeù
;

727 ià(
	`uÆik–y
(
rc
 != 0)) {

728 
»s
 = 1;

729 
out
;

732 
	`EXTRACHECKS_BUG_ON
(*
cÚ‹xt
 =ð
SCST_CONTEXT_SAME
);

734 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


735 ià(
cmd
->
Ý_æags
 & 
SCST_TEST_IO_IN_SIRQ_ALLOWED
)

736 
out
;

740 ià((*
cÚ‹xt
 =ð
SCST_CONTEXT_TASKLET
) ||

741 (*
cÚ‹xt
 =ð
SCST_CONTEXT_DIRECT_ATOMIC
)) {

746 
	`BUILD_BUG_ON
(
SCST_DATA_UNKNOWN
 != 0);

747 ià((
cmd
->
d©a_dœeùiÚ
 | cmd->
ex³ùed_d©a_dœeùiÚ
è& 
SCST_DATA_WRITE
) {

748 ià(!
cmd
->
tgt_dev
->
tgt_dev_aá”_š™_wr_©omic
)

749 *
cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

751 *
cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

754 
out
:

755 
	`TRACE_EXIT_RES
(
»s
);

756  
»s
;

758 
out_»dœeù
:

759 ià(
cmd
->
´•roûssšg_Úly
) {

766 
	`sBUG_ON
(*
cÚ‹xt
 !ð
SCST_CONTEXT_DIRECT
);

767 
	`sc¡_£t_busy
(
cmd
);

768 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

769 
»s
 = 1;

771 
	`m¦“p
(50);

773 
æags
;

775 
	`¥š_lock_œq§ve
(&
sc¡_š™_lock
, 
æags
);

776 
	`TRACE_DBG
("Addšg cmd %°tØš™ cmd†i¡", 
cmd
);

777 
	`li¡_add_ž
(&
cmd
->
cmd_li¡_’Œy
, &
sc¡_š™_cmd_li¡
);

778 ià(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
))

779 
sc¡_š™_pÞl_út
++;

780 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_š™_lock
, 
æags
);

781 
	`wake_up
(&
sc¡_š™_cmd_li¡_wa™Q
);

782 
»s
 = -1;

784 
out
;

785 
	}
}

812 
	$sc¡_cmd_š™_dÚe
(
sc¡_cmd
 *
cmd
,

813 
sc¡_exec_cÚ‹xt
 
´ef_cÚ‹xt
)

815 
æags
;

816 
sc¡_£ssiÚ
 *
£ss
 = 
cmd
->sess;

817 
rc
;

819 
	`TRACE_ENTRY
();

821 
	`sc¡_£t_¡¬t_time
(
cmd
);

823 
	`TRACE_DBG
("P»ã¼ed cÚ‹xt: %d (cmd %p)", 
´ef_cÚ‹xt
, 
cmd
);

824 
	`TRACE
(
TRACE_SCSI
, "NEW CDB:†en %d,†un %lld, initiator %s, "

826 
cmd
->
cdb_Ën
, ()cmd->
lun
,

827 
cmd
->
£ss
->
š™ŸtÜ_Çme
, cmd->
tgt
->
tgt_Çme
, cmd->
queue_ty³
,

828 ()
cmd
->
g
, cmd, 
£ss
);

829 
	`PRINT_BUFF_FLAG
(
TRACE_SCSI
, "CDB", 
cmd
->
cdb
, cmd->
cdb_Ën
);

831 #ifdeà
CONFIG_SCST_EXTRACHECKS


832 ià(
	`uÆik–y
((
	`š_œq
(è|| 
	`œqs_di§bËd
())) &&

833 ((
´ef_cÚ‹xt
 =ð
SCST_CONTEXT_DIRECT
) ||

834 (
´ef_cÚ‹xt
 =ð
SCST_CONTEXT_DIRECT_ATOMIC
))) {

835 
	`PRINT_ERROR
("Wrong context %d in IRQ fromarget %s, use "

836 "SCST_CONTEXT_THREAD in¡—d", 
´ef_cÚ‹xt
,

837 
cmd
->
tg‰
->
Çme
);

838 
	`dump_¡ack
();

839 
´ef_cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

843 
	`©omic_šc
(&
£ss
->
£ss_cmd_couÁ
);

845 
	`¥š_lock_œq§ve
(&
£ss
->
£ss_li¡_lock
, 
æags
);

847 ià(
	`uÆik–y
(
£ss
->
š™_pha£
 !ð
SCST_SESS_IPH_READY
)) {

854 ià(
cmd
->
£ss_cmd_li¡_’Œy
.
Ãxt
 =ð
NULL
)

855 
	`li¡_add_ž
(&
cmd
->
£ss_cmd_li¡_’Œy
,

856 &
£ss
->
£ss_cmd_li¡
);

857 
£ss
->
š™_pha£
) {

858 
SCST_SESS_IPH_SUCCESS
:

860 
SCST_SESS_IPH_INITING
:

861 
	`TRACE_DBG
("Adding cmd %po init deferred cmd†ist",

862 
cmd
);

863 
	`li¡_add_ž
(&
cmd
->
cmd_li¡_’Œy
,

864 &
£ss
->
š™_deã¼ed_cmd_li¡
);

865 
	`¥š_uÆock_œq»¡Üe
(&
£ss
->
£ss_li¡_lock
, 
æags
);

866 
out
;

867 
SCST_SESS_IPH_FAILED
:

868 
	`¥š_uÆock_œq»¡Üe
(&
£ss
->
£ss_li¡_lock
, 
æags
);

869 
	`sc¡_£t_busy
(
cmd
);

870 
£t_¡©e
;

872 
	`sBUG
();

875 
	`li¡_add_ž
(&
cmd
->
£ss_cmd_li¡_’Œy
,

876 &
£ss
->
£ss_cmd_li¡
);

878 
	`¥š_uÆock_œq»¡Üe
(&
£ss
->
£ss_li¡_lock
, 
æags
);

880 ià(
	`uÆik–y
(
cmd
->
queue_ty³
 >ð
SCST_CMD_QUEUE_ACA
)) {

881 
	`PRINT_ERROR
("UnsuµÜ‹d queuty³ %d", 
cmd
->
queue_ty³
);

882 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

883 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_mes§ge
));

886 
£t_¡©e
:

887 ià(
	`uÆik–y
(
cmd
->
¡©us
 !ð
SAM_STAT_GOOD
)) {

888 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

889 
aùive
;

897 
cmd
->
¡©e
 = 
SCST_CMD_STATE_INIT
;

898 
rc
 = 
	`sc¡_š™_cmd
(
cmd
, &
´ef_cÚ‹xt
);

899 ià(
	`uÆik–y
(
rc
 < 0))

900 
out
;

902 
aùive
:

904 
´ef_cÚ‹xt
) {

905 
SCST_CONTEXT_TASKLET
:

906 
	`sc¡_scheduË_skËt
(
cmd
);

910 
	`PRINT_ERROR
("Context %x is undefined, usinghehread one",

911 
´ef_cÚ‹xt
);

913 
SCST_CONTEXT_THREAD
:

914 
	`¥š_lock_œq§ve
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
, 
æags
);

915 
	`TRACE_DBG
("Addšg cmd %°tØaùivcmd†i¡", 
cmd
);

916 ià(
	`uÆik–y
(
cmd
->
queue_ty³
 =ð
SCST_CMD_QUEUE_HEAD_OF_QUEUE
))

917 
	`li¡_add
(&
cmd
->
cmd_li¡_’Œy
,

918 &
cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

920 
	`li¡_add_ž
(&
cmd
->
cmd_li¡_’Œy
,

921 &
cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

922 
	`wake_up
(&
cmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

923 
	`¥š_uÆock_œq»¡Üe
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
, 
æags
);

926 
SCST_CONTEXT_DIRECT
:

927 
	`sc¡_´oûss_aùive_cmd
(
cmd
, 
çl£
);

930 
SCST_CONTEXT_DIRECT_ATOMIC
:

931 
	`sc¡_´oûss_aùive_cmd
(
cmd
, 
Œue
);

935 
out
:

936 
	`TRACE_EXIT
();

938 
	}
}

939 
EXPORT_SYMBOL
(
sc¡_cmd_š™_dÚe
);

941 
	$sc¡_´e_·r£
(
sc¡_cmd
 *
cmd
)

943 
»s
;

944 #iâdeà
CONFIG_SCST_STRICT_SERIALIZING


945 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

947 
sc¡_dev_ty³
 *
devt
 = 
cmd
->devt;

948 
rc
;

950 
	`TRACE_ENTRY
();

959 
rc
 = 
	`sc¡_g‘_cdb_šfo
(
cmd
);

960 ià(
	`uÆik–y
(
rc
 != 0)) {

961 ià(
rc
 > 0) {

962 
	`PRINT_BUFFER
("Fažed CDB", 
cmd
->
cdb
, cmd->
cdb_Ën
);

963 
out_”r
;

966 
	`EXTRACHECKS_BUG_ON
(
cmd
->
Ý_æags
 & 
SCST_INFO_VALID
);

968 
	`TRACE
(
TRACE_MINOR
, "Unknown opcode 0x%02x for %s. "

970 
cmd
->
cdb
[0], 
devt
->
Çme
);

971 
	`PRINT_BUFF_FLAG
(
TRACE_MINOR
, "Fažed CDB", 
cmd
->
cdb
,

972 
cmd
->
cdb_Ën
);

974 
	`EXTRACHECKS_BUG_ON
(!(
cmd
->
Ý_æags
 & 
SCST_INFO_VALID
));

976 #ifdeà
CONFIG_SCST_STRICT_SERIALIZING


977 
cmd
->
šc_ex³ùed_¢_Ú_dÚe
 = 1;

979 
cmd
->
šc_ex³ùed_¢_Ú_dÚe
 = 
devt
->
exec_sync
 ||

980 (!
dev
->
has_own_Üd”_mgmt
 &&

981 (
dev
->
queue_®g
 =ð
SCST_QUEUE_ALG_0_RESTRICTED_REORDER
 ||

982 
cmd
->
queue_ty³
 =ð
SCST_CMD_QUEUE_ORDERED
));

985 
	`TRACE_DBG
("op_name <%s> (cmd %p), direction=%d "

989 
cmd
->
Ý_Çme
, cmd, cmd->
d©a_dœeùiÚ
,

990 
cmd
->
ex³ùed_d©a_dœeùiÚ
,

991 
	`sc¡_cmd_is_ex³ùed_£t
(
cmd
) ? "yes" : "no",

992 ()
cmd
->
lba
, cmd->
bufæ’
, ()cmd->
d©a_Ën
,

993 
cmd
->
out_bufæ’
, 
	`sc¡_cmd_g‘_ex³ùed_Œªsãr_Ën_d©a
(cmd),

994 
	`sc¡_cmd_g‘_ex³ùed_Œªsãr_Ën_dif
(
cmd
),

995 
cmd
->
ex³ùed_out_Œªsãr_Ën
, cmd->
Ý_æags
, cmd->
cmd_Çÿ
);

997 
»s
 = 0;

999 
out
:

1000 
	`TRACE_EXIT_RES
(
»s
);

1001  
»s
;

1003 
out_”r
:

1004 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

1005 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

1006 
»s
 = -1;

1007 
out
;

1008 
	}
}

1010 #iâdeà
CONFIG_SCST_USE_EXPECTED_VALUES


1011 
boÞ
 
	$sc¡_is_®lowed_to_mism©ch_cmd
(
sc¡_cmd
 *
cmd
)

1013 
boÞ
 
»s
 = 
çl£
;

1015 
cmd
->
cdb
[0]) {

1016 
TEST_UNIT_READY
:

1018 ià((
cmd
->
ex³ùed_d©a_dœeùiÚ
 =ð
SCST_DATA_READ
) ||

1019 (
cmd
->
ex³ùed_d©a_dœeùiÚ
 =ð
SCST_DATA_NONE
))

1020 
»s
 = 
Œue
;

1024  
»s
;

1025 
	}
}

1028 
boÞ
 
	$sc¡_bufæ’_eq_ex³ù’_Ën
(
sc¡_cmd
 *
cmd
)

1030 
b
 = 
cmd
->
bufæ’
;

1032 ià(
cmd
->
tgt_dif_d©a_ex³ùed
)

1033 
b
 +ð(b >> 
cmd
->
dev
->
block_shiá
è<< 
SCST_DIF_TAG_SHIFT
;

1035  
b
 =ð
cmd
->
ex³ùed_Œªsãr_Ën_fuÎ
;

1036 
	}
}

1038 
	$sc¡_·r£_cmd
(
sc¡_cmd
 *
cmd
)

1040 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
;

1041 
¡©e
;

1042 
sc¡_dev_ty³
 *
devt
 = 
cmd
->devt;

1043 
Üig_bufæ’
 = 
cmd
->
bufæ’
;

1045 
	`TRACE_ENTRY
();

1047 ià(
	`lik–y
((
cmd
->
Ý_æags
 & 
SCST_FULLY_LOCAL_CMD
) == 0)) {

1048 ià(
	`uÆik–y
(!
devt
->
·r£_©omic
 &&

1049 
	`sc¡_cmd_©omic
(
cmd
))) {

1054 
	`TRACE_MGMT_DBG
("Dev handler %s…arse()‚eedshread "

1055 "cÚ‹xt,„eschedulšg", 
devt
->
Çme
);

1056 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

1057 
out
;

1060 
	`TRACE_DBG
("Calling dev handler %s…arse(%p)",

1061 
devt
->
Çme
, 
cmd
);

1062 
	`sc¡_£t_cur_¡¬t
(
cmd
);

1063 
¡©e
 = 
devt
->
	`·r£
(
cmd
);

1065 
	`TRACE_DBG
("Dev handler %s…arse()„eturned %d",

1066 
devt
->
Çme
, 
¡©e
);

1068 
¡©e
) {

1069 
SCST_CMD_STATE_NEED_THREAD_CTX
:

1070 
	`sc¡_£t_·r£_time
(
cmd
);

1071 
	`TRACE_DBG
("Dev handler %s…arse()„equestedhread "

1072 "cÚ‹xt,„eschedulšg", 
devt
->
Çme
);

1073 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

1074 
out
;

1076 
SCST_CMD_STATE_STOP
:

1080 
	`TRACE_DBG
("Dev handler %s…arse()„equested stop "

1081 "´oûssšg", 
devt
->
Çme
);

1082 
»s
 = 
SCST_CMD_STATE_RES_CONT_NEXT
;

1083 
out
;

1086 
	`sc¡_£t_·r£_time
(
cmd
);

1088 
¡©e
 = 
	`sc¡_do_š‹º®_·rsšg
(
cmd
);

1090 ià(
¡©e
 =ð
SCST_CMD_STATE_DEFAULT
)

1091 
¡©e
 = 
SCST_CMD_STATE_PREPARE_SPACE
;

1093 ià(
	`uÆik–y
(
cmd
->
¡©us
 != 0))

1094 
£t_»s
;

1096 ià(
	`uÆik–y
(!(
cmd
->
Ý_æags
 & 
SCST_INFO_VALID
))) {

1097 #ifdeà
CONFIG_SCST_USE_EXPECTED_VALUES


1098 ià(
	`sc¡_cmd_is_ex³ùed_£t
(
cmd
)) {

1099 
	`TRACE
(
TRACE_MINOR
, "Using initiator supplied values: "

1101 
cmd
->
ex³ùed_d©a_dœeùiÚ
,

1102 
	`sc¡_cmd_g‘_ex³ùed_Œªsãr_Ën_d©a
(
cmd
),

1103 
	`sc¡_cmd_g‘_ex³ùed_Œªsãr_Ën_dif
(
cmd
),

1104 
cmd
->
ex³ùed_out_Œªsãr_Ën
);

1105 
cmd
->
d©a_dœeùiÚ
 = cmd->
ex³ùed_d©a_dœeùiÚ
;

1106 
cmd
->
bufæ’
 = 
	`sc¡_cmd_g‘_ex³ùed_Œªsãr_Ën_d©a
(cmd);

1107 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

1108 
cmd
->
out_bufæ’
 = cmd->
ex³ùed_out_Œªsãr_Ën
;

1110 
	`PRINT_WARNING
("Unknown opcode 0x%02x for %s‡nd "

1112 
cmd
->
cdb
[0], 
devt
->
Çme
, cmd->
tg‰
->name);

1113 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1114 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

1115 
out_dÚe
;

1118 
	`PRINT_WARNING
("Refusšg unknowÀÝcod%x", 
cmd
->
cdb
[0]);

1119 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1120 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

1121 
out_dÚe
;

1125 ià(
	`uÆik–y
(
cmd
->
cdb_Ën
 == 0)) {

1126 
	`PRINT_ERROR
("Unableo get CDB†ength for "

1128 "OPCODE", 
	`sc¡_g‘_Ýcode_Çme
(
cmd
));

1129 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1130 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

1131 
out_dÚe
;

1134 ià(
	`uÆik–y
((
cmd
->
Ý_æags
 & 
SCST_UNKNOWN_LENGTH
) != 0)) {

1135 ià(
	`sc¡_cmd_is_ex³ùed_£t
(
cmd
)) {

1144 
cmd
->
bufæ’
 = 
	`mš
(
	`sc¡_cmd_g‘_ex³ùed_Œªsãr_Ën_d©a
(cmd),

1146 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

1147 ià(
cmd
->
d©a_dœeùiÚ
 =ð
SCST_DATA_BIDI
)

1148 
cmd
->
out_bufæ’
 = 
	`mš
(cmd->
ex³ùed_out_Œªsãr_Ën
,

1151 ià(
cmd
->
bufæ’
 == 0) {

1152 
	`PRINT_ERROR
("Unknown dataransfer†ength for opcode "

1154 
	`sc¡_g‘_Ýcode_Çme
(
cmd
), 
devt
->
Çme
,

1155 
cmd
->
tg‰
->
Çme
);

1156 
	`PRINT_BUFFER
("Fažed CDB", 
cmd
->
cdb
, cmd->
cdb_Ën
);

1157 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1158 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_mes§ge
));

1159 
out_dÚe
;

1162 
cmd
->
Ý_æags
 &ð~
SCST_UNKNOWN_LENGTH
;

1165 ià(
	`uÆik–y
(
cmd
->
cmd_Çÿ
)) {

1166 
	`PRINT_ERROR
("NACA bit in control byte CDB is‚ot supported "

1167 "(Ýcod0x%02x)", 
cmd
->
cdb
[0]);

1168 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1169 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_mes§ge
));

1170 
out_dÚe
;

1173 ià(
	`uÆik–y
(
cmd
->
cmd_lšked
)) {

1174 
	`PRINT_ERROR
("Linked commands‡re‚ot supported "

1175 "(Ýcod%s)", 
	`sc¡_g‘_Ýcode_Çme
(
cmd
));

1176 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, cmd->
cdb_Ën
-1,

1177 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 0);

1178 
out_dÚe
;

1181 ià(
cmd
->
dh_d©a_buf_®loûd
 &&

1182 
	`uÆik–y
((
Üig_bufæ’
 > 
cmd
->
bufæ’
))) {

1183 
	`PRINT_ERROR
("Dev handler supplied data buffer (size %d), "

1184 "i Ëss,hª„equœed (siz%d)", 
cmd
->
bufæ’
,

1185 
Üig_bufæ’
);

1186 
	`PRINT_BUFFER
("Fažed CDB", 
cmd
->
cdb
, cmd->
cdb_Ën
);

1187 
out_hw_”rÜ
;

1190 #ifdeà
CONFIG_SCST_EXTRACHECKS


1191 ià((
cmd
->
bufæ’
 != 0) &&

1192 ((
cmd
->
d©a_dœeùiÚ
 =ð
SCST_DATA_NONE
) ||

1193 ((
cmd
->
sg
 =ð
NULL
è&& (
¡©e
 > 
SCST_CMD_STATE_PREPARE_SPACE
)))) {

1194 
	`PRINT_ERROR
("Dev handler %s…arse()„eturned "

1196 "Ü sg %°(Ýcod%s)", 
devt
->
Çme
,

1197 
cmd
->
d©a_dœeùiÚ
, cmd->
bufæ’
, 
¡©e
, cmd->
sg
,

1198 
	`sc¡_g‘_Ýcode_Çme
(
cmd
));

1199 
	`PRINT_BUFFER
("Fažed CDB", 
cmd
->
cdb
, cmd->
cdb_Ën
);

1200 
out_hw_”rÜ
;

1204 ià(
	`sc¡_cmd_is_ex³ùed_£t
(
cmd
)) {

1205 #ifdeà
CONFIG_SCST_USE_EXPECTED_VALUES


1206 ià(
	`uÆik–y
((
cmd
->
d©a_dœeùiÚ
 !ðcmd->
ex³ùed_d©a_dœeùiÚ
) ||

1207 !
	`sc¡_bufæ’_eq_ex³ù’_Ën
(
cmd
) ||

1208 (
cmd
->
out_bufæ’
 !ðcmd->
ex³ùed_out_Œªsãr_Ën
))) {

1209 
	`TRACE
(
TRACE_MINOR
, "Expected values don't match "

1214 
cmd
->
d©a_dœeùiÚ
,

1215 
cmd
->
ex³ùed_d©a_dœeùiÚ
,

1216 
cmd
->
bufæ’
, 
	`sc¡_cmd_g‘_ex³ùed_Œªsãr_Ën_d©a
(cmd),

1217 
	`sc¡_cmd_g‘_ex³ùed_Œªsãr_Ën_dif
(
cmd
),

1218 
cmd
->
out_bufæ’
, cmd->
ex³ùed_out_Œªsãr_Ën
);

1219 
	`PRINT_BUFF_FLAG
(
TRACE_MINOR
, "Suspicious CDB",

1220 
cmd
->
cdb
, cmd->
cdb_Ën
);

1221 
cmd
->
d©a_dœeùiÚ
 = cmd->
ex³ùed_d©a_dœeùiÚ
;

1222 
cmd
->
bufæ’
 = 
	`sc¡_cmd_g‘_ex³ùed_Œªsãr_Ën_d©a
(cmd);

1223 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

1224 
cmd
->
out_bufæ’
 = cmd->
ex³ùed_out_Œªsãr_Ën
;

1225 
cmd
->
»sid_possibË
 = 1;

1228 ià(
	`uÆik–y
(
cmd
->
d©a_dœeùiÚ
 !=

1229 
cmd
->
ex³ùed_d©a_dœeùiÚ
)) {

1230 ià(((
cmd
->
ex³ùed_d©a_dœeùiÚ
 !ð
SCST_DATA_NONE
) ||

1231 (
cmd
->
bufæ’
 != 0)) &&

1232 !
	`sc¡_is_®lowed_to_mism©ch_cmd
(
cmd
)) {

1233 
	`PRINT_ERROR
("Expected data direction %d for "

1236 
cmd
->
ex³ùed_d©a_dœeùiÚ
,

1237 
	`sc¡_g‘_Ýcode_Çme
(
cmd
), 
devt
->
Çme
,

1238 
cmd
->
tg‰
->
Çme
, cmd->
d©a_dœeùiÚ
);

1239 
	`PRINT_BUFFER
("Fažed CDB", 
cmd
->
cdb
,

1240 
cmd
->
cdb_Ën
);

1241 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1242 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_mes§ge
));

1243 
out_dÚe
;

1246 ià(
	`uÆik–y
(!
	`sc¡_bufæ’_eq_ex³ù’_Ën
(
cmd
))) {

1247 
	`TRACE
(
TRACE_MINOR
, "Warning:ƒxpected "

1251 
	`sc¡_cmd_g‘_ex³ùed_Œªsãr_Ën_d©a
(
cmd
),

1252 
	`sc¡_cmd_g‘_ex³ùed_Œªsãr_Ën_dif
(
cmd
),

1253 
	`sc¡_g‘_Ýcode_Çme
(
cmd
), 
devt
->
Çme
,

1254 
cmd
->
tg‰
->
Çme
, cmd->
bufæ’
);

1255 
	`PRINT_BUFF_FLAG
(
TRACE_MINOR
, "Suspicious CDB",

1256 
cmd
->
cdb
, cmd->
cdb_Ën
);

1257 ià((
cmd
->
ex³ùed_d©a_dœeùiÚ
 & 
SCST_DATA_READ
) ||

1258 (
cmd
->
ex³ùed_d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
))

1259 
cmd
->
»sid_possibË
 = 1;

1261 ià(
	`uÆik–y
(
cmd
->
out_bufæ’
 !ðcmd->
ex³ùed_out_Œªsãr_Ën
)) {

1262 
	`TRACE
(
TRACE_MINOR
, "Warning:ƒxpected bidirectional OUT "

1266 
cmd
->
ex³ùed_out_Œªsãr_Ën
,

1267 
	`sc¡_g‘_Ýcode_Çme
(
cmd
), 
devt
->
Çme
,

1268 
cmd
->
tg‰
->
Çme
, cmd->
out_bufæ’
);

1269 
	`PRINT_BUFF_FLAG
(
TRACE_MINOR
, "Suspicious CDB",

1270 
cmd
->
cdb
, cmd->
cdb_Ën
);

1271 
cmd
->
»sid_possibË
 = 1;

1276 ià(
	`uÆik–y
(
cmd
->
d©a_dœeùiÚ
 =ð
SCST_DATA_UNKNOWN
)) {

1277 
	`PRINT_ERROR
("Unknown data direction (opcode %s, handler %s, "

1278 "rg‘ %s)", 
	`sc¡_g‘_Ýcode_Çme
(
cmd
), 
devt
->
Çme
,

1279 
cmd
->
tg‰
->
Çme
);

1280 
	`PRINT_BUFFER
("Fažed CDB", 
cmd
->
cdb
, cmd->
cdb_Ën
);

1281 
out_hw_”rÜ
;

1284 ià(
	`uÆik–y
(
cmd
->
Ý_æags
 & 
SCST_UNKNOWN_LBA
)) {

1285 
	`PRINT_ERROR
("Unknown LBA (opcode %s, handler %s, "

1286 "rg‘ %s)", 
	`sc¡_g‘_Ýcode_Çme
(
cmd
), 
devt
->
Çme
,

1287 
cmd
->
tg‰
->
Çme
);

1288 
	`PRINT_BUFFER
("Fažed CDB", 
cmd
->
cdb
, cmd->
cdb_Ën
);

1289 
out_hw_”rÜ
;

1292 
£t_»s
:

1293 ià(
cmd
->
bufæ’
 == 0) {

1298 
cmd
->
d©a_dœeùiÚ
 = 
SCST_DATA_NONE
;

1301 
	`TRACE
(
TRACE_SCSI
, "op_name <%s> (cmd %p), direction=%d "

1305 
cmd
->
Ý_Çme
, cmd, cmd->
d©a_dœeùiÚ
, cmd->
ex³ùed_d©a_dœeùiÚ
,

1306 
	`sc¡_cmd_is_ex³ùed_£t
(
cmd
) ? "yes" : "no",

1307 ()
cmd
->
lba
,

1308 
cmd
->
bufæ’
, ()cmd->
d©a_Ën
, cmd->
out_bufæ’
,

1309 
	`sc¡_cmd_g‘_ex³ùed_Œªsãr_Ën_d©a
(
cmd
),

1310 
	`sc¡_cmd_g‘_ex³ùed_Œªsãr_Ën_dif
(
cmd
),

1311 
cmd
->
ex³ùed_out_Œªsãr_Ën
, cmd->
Ý_æags
, cmd->
š‹º®
,

1312 
cmd
->
cmd_Çÿ
);

1314 #ifdeà
CONFIG_SCST_EXTRACHECKS


1315 
¡©e
) {

1316 
SCST_CMD_STATE_PREPARE_SPACE
:

1317 
SCST_CMD_STATE_PARSE
:

1318 
SCST_CMD_STATE_RDY_TO_XFER
:

1319 
SCST_CMD_STATE_PREPROCESSING_DONE
:

1320 
SCST_CMD_STATE_TGT_PRE_EXEC
:

1321 
SCST_CMD_STATE_EXEC_CHECK_SN
:

1322 
SCST_CMD_STATE_EXEC_CHECK_BLOCKING
:

1323 
SCST_CMD_STATE_LOCAL_EXEC
:

1324 
SCST_CMD_STATE_REAL_EXEC
:

1325 
SCST_CMD_STATE_PRE_DEV_DONE
:

1326 
SCST_CMD_STATE_DEV_DONE
:

1327 
SCST_CMD_STATE_PRE_XMIT_RESP1
:

1328 
SCST_CMD_STATE_PRE_XMIT_RESP2
:

1329 
SCST_CMD_STATE_XMIT_RESP
:

1330 
SCST_CMD_STATE_FINISHED
:

1331 
SCST_CMD_STATE_FINISHED_INTERNAL
:

1333 
cmd
->
¡©e
 = state;

1334 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
;

1335 #ifdeà
CONFIG_SCST_EXTRACHECKS


1339 ià(
¡©e
 >= 0) {

1340 
	`PRINT_ERROR
("Dev handler %s…arse()„eturned "

1342 
devt
->
Çme
, 
¡©e
, 
	`sc¡_g‘_Ýcode_Çme
(
cmd
));

1344 
	`PRINT_ERROR
("Dev handler %s…arse()„eturned "

1345 "”rÜ %d (Ýcod%s)", 
devt
->
Çme
,

1346 
¡©e
, 
	`sc¡_g‘_Ýcode_Çme
(
cmd
));

1348 
out_hw_”rÜ
;

1352 ià(
cmd
->
»¥_d©a_Ën
 == -1) {

1353 ià(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_READ
)

1354 
cmd
->
»¥_d©a_Ën
 = cmd->
bufæ’
;

1356 
cmd
->
»¥_d©a_Ën
 = 0;

1359 #iâdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


1365 ià(
	`uÆik–y
(
	`sc¡_cmd_©omic
(
cmd
) &&

1366 !(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
))) {

1367 
	`TRACE_DBG_FLAG
(
TRACE_DEBUG
|
TRACE_MINOR
, "Atomic context‡nd "

1368 "nÚ-WRITE d©¨dœeùiÚ,„eschedulšg (cmd %p)", 
cmd
);

1369 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

1374 
out_check_com¶
:

1375 #ifdeà
CONFIG_SCST_EXTRACHECKS


1376 ià(
	`uÆik–y
(
cmd
->
com¶‘ed
)) {

1378 
boÞ
 
v®id_¡©e
 = (
cmd
->
¡©e
 =ð
SCST_CMD_STATE_PREPROCESSING_DONE
) ||

1379 ((
cmd
->
¡©e
 >ð
SCST_CMD_STATE_PRE_XMIT_RESP
) &&

1380 (
cmd
->
¡©e
 < 
SCST_CMD_STATE_LAST_ACTIVE
));

1382 ià(!
v®id_¡©e
) {

1383 
	`PRINT_CRIT_ERROR
("Bad state for completed cmd "

1384 "(cmd %p, s‹ %d)", 
cmd
, cmd->
¡©e
);

1385 
	`sBUG
();

1387 } ià(
cmd
->
¡©e
 !ð
SCST_CMD_STATE_PARSE
) {

1392 
boÞ
 
bad_lba
 = (
cmd
->
lba
 =ð
SCST_DEF_LBA_DATA_LEN
) &&

1393 !(
cmd
->
Ý_æags
 & 
SCST_LBA_NOT_VALID
);

1394 
boÞ
 
bad_d©a_Ën
 = (
cmd
->
d©a_Ën
 =ð
SCST_DEF_LBA_DATA_LEN
);

1396 ià(
	`uÆik–y
(
bad_lba
 || 
bad_d©a_Ën
)) {

1397 
	`PRINT_CRIT_ERROR
("Uninitialized†ba or data_len for "

1399 "d©a_ËÀ%Îd, s‹ %d)", 
cmd
,

1400 ()
cmd
->
lba
, ()cmd->
d©a_Ën
,

1401 
cmd
->
¡©e
);

1402 
	`sBUG
();

1407 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_TGT_DEV_BLACK_HOLE
, &
cmd
->
tgt_dev
->
tgt_dev_æags
))) {

1408 
sc¡_£ssiÚ
 *
£ss
 = 
cmd
->sess;

1409 
boÞ
 
abÜt
 = 
çl£
;

1411 
£ss
->
acg
->
acg_bÏck_hÞe_ty³
) {

1412 
SCST_ACG_BLACK_HOLE_CMD
:

1413 
SCST_ACG_BLACK_HOLE_ALL
:

1414 
abÜt
 = 
Œue
;

1416 
SCST_ACG_BLACK_HOLE_DATA_CMD
:

1417 
SCST_ACG_BLACK_HOLE_DATA_MCMD
:

1418 ià(
cmd
->
d©a_dœeùiÚ
 !ð
SCST_DATA_NONE
)

1419 
abÜt
 = 
Œue
;

1424 ià(
abÜt
) {

1425 
	`TRACE_MGMT_DBG
("Black hole:‡borting cmd %p (op %s, "

1426 "š™ŸtÜ %s)", 
cmd
, 
	`sc¡_g‘_Ýcode_Çme
(cmd),

1427 
£ss
->
š™ŸtÜ_Çme
);

1428 
	`sc¡_abÜt_cmd
(
cmd
, 
NULL
, 
çl£
, false);

1432 
out
:

1433 
	`TRACE_EXIT_HRES
(
»s
);

1434  
»s
;

1436 
out_hw_”rÜ
:

1438 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1440 
out_dÚe
:

1441 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

1442 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
;

1443 
out_check_com¶
;

1444 
	}
}

1446 
	$sc¡_£t_wr™e_Ën
(
sc¡_cmd
 *
cmd
)

1448 
	`TRACE_ENTRY
();

1450 
	`EXTRACHECKS_BUG_ON
(!(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
));

1452 ià(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_READ
) {

1453 
cmd
->
wr™e_Ën
 = cmd->
out_bufæ’
;

1454 
cmd
->
wr™e_sg
 = &cmd->
out_sg
;

1455 
cmd
->
wr™e_sg_út
 = &cmd->
out_sg_út
;

1457 
cmd
->
wr™e_Ën
 = cmd->
bufæ’
;

1461 
	`TRACE_MEM
("cmd %p, write_len %d, write_sg %p, write_sg_cnt %d, "

1462 "»sid_possibË %d", 
cmd
, cmd->
wr™e_Ën
, *cmd->
wr™e_sg
,

1463 *
cmd
->
wr™e_sg_út
, cmd->
»sid_possibË
);

1465 ià(
	`uÆik–y
(
cmd
->
»sid_possibË
)) {

1466 ià(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_READ
) {

1467 
cmd
->
wr™e_Ën
 = 
	`mš
(cmd->
out_bufæ’
,

1468 
cmd
->
ex³ùed_out_Œªsãr_Ën
);

1469 ià(
cmd
->
wr™e_Ën
 =ðcmd->
out_bufæ’
)

1470 
out
;

1472 
cmd
->
wr™e_Ën
 = 
	`mš
(cmd->
bufæ’
,

1473 
	`sc¡_cmd_g‘_ex³ùed_Œªsãr_Ën_d©a
(
cmd
));

1474 ià(
cmd
->
wr™e_Ën
 =ðcmd->
bufæ’
)

1475 
out
;

1477 
	`sc¡_lim™_sg_wr™e_Ën
(
cmd
);

1480 
out
:

1481 
	`TRACE_EXIT
();

1483 
	}
}

1485 
	$sc¡_´•¬e_¥aû
(
sc¡_cmd
 *
cmd
)

1487 
r
 = 0, 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
;

1488 
sc¡_dev_ty³
 *
devt
 = 
cmd
->devt;

1490 
	`TRACE_ENTRY
();

1492 ià(
cmd
->
d©a_dœeùiÚ
 =ð
SCST_DATA_NONE
)

1493 
dÚe
;

1495 ià(
	`lik–y
((
cmd
->
Ý_æags
 & 
SCST_FULLY_LOCAL_CMD
) == 0) &&

1496 (
devt
->
dev_®loc_d©a_buf
 !ð
NULL
)) {

1497 
¡©e
;

1499 ià(
	`uÆik–y
(!
devt
->
dev_®loc_d©a_buf_©omic
 &&

1500 
	`sc¡_cmd_©omic
(
cmd
))) {

1505 
	`TRACE_MGMT_DBG
("Dev handler %s dev_alloc_data_buf() "

1507 
devt
->
Çme
);

1508 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

1509 
out
;

1512 
	`TRACE_DBG
("Calling dev handler's %s dev_alloc_data_buf(%p)",

1513 
devt
->
Çme
, 
cmd
);

1514 
	`sc¡_£t_cur_¡¬t
(
cmd
);

1515 
¡©e
 = 
devt
->
	`dev_®loc_d©a_buf
(
cmd
);

1521 
	`TRACE_DBG
("Dev handler %p dev_alloc_data_buf()„eturned %d",

1522 
devt
, 
¡©e
);

1524 
¡©e
) {

1525 
SCST_CMD_STATE_NEED_THREAD_CTX
:

1526 
	`sc¡_£t_®loc_buf_time
(
cmd
);

1527 
	`TRACE_DBG
("Dev handler %s dev_alloc_data_buf()„equested "

1528 "th»ad cÚ‹xt,„eschedulšg", 
devt
->
Çme
);

1529 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

1530 
out
;

1532 
SCST_CMD_STATE_STOP
:

1534 
	`TRACE_DBG
("Dev handler %p dev_alloc_data_buf() "

1535 "»que¡ed stÝ…roûssšg", 
devt
);

1536 
»s
 = 
SCST_CMD_STATE_RES_CONT_NEXT
;

1537 
out
;

1540 
	`sc¡_£t_®loc_buf_time
(
cmd
);

1542 ià(
	`uÆik–y
(
¡©e
 !ð
SCST_CMD_STATE_DEFAULT
)) {

1543 
cmd
->
¡©e
 = state;

1544 
out
;

1548 ià(
cmd
->
tgt_Ãed_®loc_d©a_buf
) {

1549 
Üig_bufæ’
 = 
cmd
->
bufæ’
;

1551 
	`TRACE_MEM
("Callinggt %sgt_alloc_data_buf(cmd %p)",

1552 
cmd
->
tgt
->
tgt_Çme
, cmd);

1554 
	`sc¡_£t_cur_¡¬t
(
cmd
);

1555 
r
 = 
cmd
->
tg‰
->
	`tgt_®loc_d©a_buf
(cmd);

1556 
	`sc¡_£t_®loc_buf_time
(
cmd
);

1558 ià(
r
 > 0)

1559 
®loc
;

1560 ià(
r
 == 0) {

1561 ià(
	`uÆik–y
(
cmd
->
bufæ’
 == 0)) {

1563 ià(
cmd
->
sg
 =ð
NULL
)

1564 
®loc
;

1567 
cmd
->
tgt_i_d©a_buf_®loûd
 = 1;

1569 ià(
	`uÆik–y
(
Üig_bufæ’
 < 
cmd
->
bufæ’
)) {

1570 
	`PRINT_ERROR
("Target driver‡llocated data "

1572 "»quœed (siz%d)", 
Üig_bufæ’
,

1573 
cmd
->
bufæ’
);

1574 
out_”rÜ
;

1576 
	`TRACE_MEM
("tgt_i_d©a_buf_®loûd (cmd %p)", 
cmd
);

1578 
check
;

1581 
®loc
:

1582 ià(!
cmd
->
tgt_i_d©a_buf_®loûd
 && !cmd->
dh_d©a_buf_®loûd
) {

1583 
r
 = 
	`sc¡_®loc_¥aû
(
cmd
);

1584 } ià(
cmd
->
dh_d©a_buf_®loûd
 && !cmd->
tgt_i_d©a_buf_®loûd
) {

1585 
	`TRACE_MEM
("dh_d©a_buf_®loûd s‘ (cmd %p)", 
cmd
);

1586 
r
 = 0;

1587 } ià(
cmd
->
tgt_i_d©a_buf_®loûd
 && !cmd->
dh_d©a_buf_®loûd
) {

1588 
	`TRACE_MEM
("tgt_i_d©a_buf_®loûd s‘ (cmd %p)", 
cmd
);

1589 
cmd
->
sg
 = cmd->
tgt_i_sg
;

1590 
cmd
->
sg_út
 = cmd->
tgt_i_sg_út
;

1591 
cmd
->
dif_sg
 = cmd->
tgt_i_dif_sg
;

1592 
cmd
->
dif_sg_út
 = cmd->
tgt_i_dif_sg_út
;

1593 
cmd
->
out_sg
 = cmd->
tgt_out_sg
;

1594 
cmd
->
out_sg_út
 = cmd->
tgt_out_sg_út
;

1595 
r
 = 0;

1597 
	`TRACE_MEM
("Both *_data_buf_alloced set (cmd %p, sg %p, "

1600 
cmd
, cmd->
sg
, cmd->
sg_út
, cmd->
dif_sg
, cmd->
dif_sg_út
,

1601 
cmd
->
tgt_i_sg
, cmd->
tgt_i_sg_út
, cmd->
tgt_i_dif_sg
,

1602 
cmd
->
tgt_i_dif_sg_út
);

1603 
r
 = 0;

1606 
check
:

1607 ià(
r
 != 0) {

1608 ià(
	`sc¡_cmd_©omic
(
cmd
)) {

1609 
	`TRACE_MEM
("%s", "Atomic memory‡llocation failed, "

1611 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

1612 
out
;

1614 
out_no_¥aû
;

1617 
dÚe
:

1618 ià(
cmd
->
´•roûssšg_Úly
) {

1619 
cmd
->
¡©e
 = 
SCST_CMD_STATE_PREPROCESSING_DONE
;

1620 ià(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
)

1621 
	`sc¡_£t_wr™e_Ën
(
cmd
);

1622 } ià(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
) {

1623 
cmd
->
¡©e
 = 
SCST_CMD_STATE_RDY_TO_XFER
;

1624 
	`sc¡_£t_wr™e_Ën
(
cmd
);

1626 
cmd
->
¡©e
 = 
SCST_CMD_STATE_TGT_PRE_EXEC
;

1628 
out
:

1629 
	`TRACE_EXIT_HRES
(
»s
);

1630  
»s
;

1632 
out_no_¥aû
:

1633 
	`TRACE
(
TRACE_OUT_OF_MEM
, "Unableo‡llocate or build„equested buffer "

1634 "(siz%d), s’dšg BUSY o¸QUEUE FULL stus", 
cmd
->
bufæ’
);

1635 
	`sc¡_£t_busy
(
cmd
);

1636 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

1637 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
;

1638 
out
;

1640 
out_”rÜ
:

1641 ià(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
)

1642 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_wr™e_”rÜ
));

1644 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»ad_”rÜ
));

1645 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

1646 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
;

1647 
out
;

1648 
	}
}

1650 
	$sc¡_´•roûssšg_dÚe
(
sc¡_cmd
 *
cmd
)

1652 
»s
;

1654 
	`TRACE_ENTRY
();

1656 
	`EXTRACHECKS_BUG_ON
(!
cmd
->
´•roûssšg_Úly
);

1658 
cmd
->
´•roûssšg_Úly
 = 0;

1660 
»s
 = 
SCST_CMD_STATE_RES_CONT_NEXT
;

1661 
cmd
->
¡©e
 = 
SCST_CMD_STATE_PREPROCESSING_DONE_CALLED
;

1663 
	`TRACE_DBG
("C®lšg…»´oûssšg_dÚe(cmd %p)", 
cmd
);

1664 
	`sc¡_£t_cur_¡¬t
(
cmd
);

1665 
cmd
->
tg‰
->
	`´•roûssšg_dÚe
(cmd);

1666 
	`TRACE_DBG
("%s", "preprocessing_done()„eturned");

1668 
	`TRACE_EXIT_HRES
(
»s
);

1669  
»s
;

1670 
	}
}

1688 
	$sc¡_»¡¬t_cmd
(
sc¡_cmd
 *
cmd
, 
¡©us
,

1689 
sc¡_exec_cÚ‹xt
 
´ef_cÚ‹xt
)

1691 
	`TRACE_ENTRY
();

1693 
	`sc¡_£t_»¡¬t_wa™šg_time
(
cmd
);

1695 
	`TRACE_DBG
("P»ã¼ed cÚ‹xt: %d", 
´ef_cÚ‹xt
);

1696 
	`TRACE_DBG
("tag=%llu, status=%#x",

1697 ()
	`sc¡_cmd_g‘_g
(
cmd
),

1698 
¡©us
);

1700 #ifdeà
CONFIG_SCST_EXTRACHECKS


1701 ià((
	`š_œq
(è|| 
	`œqs_di§bËd
()) &&

1702 ((
´ef_cÚ‹xt
 =ð
SCST_CONTEXT_DIRECT
) ||

1703 (
´ef_cÚ‹xt
 =ð
SCST_CONTEXT_DIRECT_ATOMIC
))) {

1704 
	`PRINT_ERROR
("Wrong context %d in IRQ fromarget %s, use "

1705 "SCST_CONTEXT_THREAD in¡—d", 
´ef_cÚ‹xt
,

1706 
cmd
->
tg‰
->
Çme
);

1707 
	`dump_¡ack
();

1708 
´ef_cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

1712 
¡©us
) {

1713 
SCST_PREPROCESS_STATUS_SUCCESS
:

1714 ià(
	`uÆik–y
(
cmd
->
tgt_dev
 =ð
NULL
)) {

1715 
cmd
->
¡©e
 = 
SCST_CMD_STATE_PRE_XMIT_RESP
;

1716 
´ef_cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

1718 } ià(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
)

1719 
cmd
->
¡©e
 = 
SCST_CMD_STATE_RDY_TO_XFER
;

1721 
cmd
->
¡©e
 = 
SCST_CMD_STATE_TGT_PRE_EXEC
;

1722 ià(
cmd
->
£t_¢_Ú_»¡¬t_cmd
) {

1723 
	`EXTRACHECKS_BUG_ON
(
cmd
->
tg‰
->
muÉ™h»aded_š™_dÚe
);

1724 
	`sc¡_cmd_£t_¢
(
cmd
);

1726 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


1727 ià(
cmd
->
Ý_æags
 & 
SCST_TEST_IO_IN_SIRQ_ALLOWED
)

1731 ià((
´ef_cÚ‹xt
 =ð
SCST_CONTEXT_TASKLET
) ||

1732 (
´ef_cÚ‹xt
 =ð
SCST_CONTEXT_DIRECT_ATOMIC
) ||

1733 ((
´ef_cÚ‹xt
 =ð
SCST_CONTEXT_SAME
) &&

1734 
	`sc¡_cmd_©omic
(
cmd
)))

1735 
´ef_cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

1738 
SCST_PREPROCESS_STATUS_ERROR_SENSE_SET
:

1739 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

1740 
´ef_cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

1743 
SCST_PREPROCESS_STATUS_ERROR_FATAL
:

1744 
	`£t_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
);

1745 
	`£t_b™
(
SCST_CMD_NO_RESP
, &
cmd
->
cmd_æags
);

1746 
cmd
->
d–iv”y_¡©us
 = 
SCST_CMD_DELIVERY_FAILED
;

1748 
SCST_PREPROCESS_STATUS_ERROR
:

1749 ià(
cmd
->
£n£
 !ð
NULL
)

1750 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1751 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1752 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

1753 
´ef_cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

1757 
	`PRINT_ERROR
("%s(è»ûived unknowÀ¡©u %x", 
__func__
,

1758 
¡©us
);

1759 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

1760 
´ef_cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

1764 
	`sc¡_´oûss_»dœeù_cmd
(
cmd
, 
´ef_cÚ‹xt
, 1);

1766 
	`TRACE_EXIT
();

1768 
	}
}

1769 
EXPORT_SYMBOL
(
sc¡_»¡¬t_cmd
);

1771 
	$sc¡_rdy_to_xãr
(
sc¡_cmd
 *
cmd
)

1773 
»s
, 
rc
;

1774 
sc¡_tgt_‹m¶©e
 *
tg‰
 = 
cmd
->tgtt;

1776 
	`TRACE_ENTRY
();

1778 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
))) {

1779 
	`TRACE_MGMT_DBG
("ABORTED s‘,‡bÜtšg cmd %p", 
cmd
);

1780 
out_dev_dÚe
;

1783 ià((
tg‰
->
rdy_to_xãr
 =ð
NULL
è|| 
	`uÆik–y
(
cmd
->
š‹º®
)) {

1784 
cmd
->
¡©e
 = 
SCST_CMD_STATE_TGT_PRE_EXEC
;

1785 #iâdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


1787 ià(
	`sc¡_cmd_©omic
(
cmd
)) {

1788 
	`TRACE_DBG
("NULL„dy_to_xfer()‡nd‡tomic context, "

1789 "»schedulšg (cmd %p)", 
cmd
);

1790 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

1793 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
;

1794 
out
;

1797 ià(
	`uÆik–y
(!
tg‰
->
rdy_to_xãr_©omic
 && 
	`sc¡_cmd_©omic
(
cmd
))) {

1802 
	`TRACE_MGMT_DBG
("Target driver %s„dy_to_xfer()‚eedshread "

1803 "cÚ‹xt,„eschedulšg", 
tg‰
->
Çme
);

1804 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

1805 
out
;

1808 
»s
 = 
SCST_CMD_STATE_RES_CONT_NEXT
;

1809 
cmd
->
¡©e
 = 
SCST_CMD_STATE_DATA_WAIT
;

1811 ià(
tg‰
->
Ú_hw_³ndšg_cmd_timeout
 !ð
NULL
) {

1812 
sc¡_£ssiÚ
 *
£ss
 = 
cmd
->sess;

1814 
cmd
->
hw_³ndšg_¡¬t
 = 
jiff›s
;

1815 
cmd
->
cmd_hw_³ndšg
 = 1;

1816 ià(!
	`‹¡_b™
(
SCST_SESS_HW_PENDING_WORK_SCHEDULED
, &
£ss
->
£ss_aæags
)) {

1817 
	`TRACE_DBG
("Sched HW…ending work for sess %p "

1818 "(maxim%d)", 
£ss
,

1819 
tg‰
->
max_hw_³ndšg_time
);

1820 
	`£t_b™
(
SCST_SESS_HW_PENDING_WORK_SCHEDULED
,

1821 &
£ss
->
£ss_aæags
);

1822 
	`scheduË_d–ayed_wÜk
(&
£ss
->
hw_³ndšg_wÜk
,

1823 
tg‰
->
max_hw_³ndšg_time
 * 
HZ
);

1827 
	`sc¡_£t_cur_¡¬t
(
cmd
);

1829 
	`TRACE_DBG
("C®lšg„dy_to_xãr(%p)", 
cmd
);

1830 #ifdeà
CONFIG_SCST_DEBUG_RETRY


1831 ià(((
	`sc¡_¿ndom
() % 100) == 75))

1832 
rc
 = 
SCST_TGT_RES_QUEUE_FULL
;

1835 
rc
 = 
tg‰
->
	`rdy_to_xãr
(
cmd
);

1836 
	`TRACE_DBG
("rdy_to_xãr(è»tuºed %d", 
rc
);

1838 ià(
	`lik–y
(
rc
 =ð
SCST_TGT_RES_SUCCESS
))

1839 
out
;

1841 
	`sc¡_£t_rdy_to_xãr_time
(
cmd
);

1843 
cmd
->
cmd_hw_³ndšg
 = 0;

1846 
cmd
->
¡©e
 = 
SCST_CMD_STATE_RDY_TO_XFER
;

1848 
rc
) {

1849 
SCST_TGT_RES_QUEUE_FULL
:

1850 
	`sc¡_queue_»Œy_cmd
(
cmd
);

1851 
out
;

1853 
SCST_TGT_RES_NEED_THREAD_CTX
:

1854 
	`TRACE_DBG
("Target driver %s "

1856 "cÚ‹xt,„eschedulšg", 
tg‰
->
Çme
);

1857 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

1858 
out
;

1861 
out_”rÜ_rc
;

1864 
out
:

1865 
	`TRACE_EXIT_HRES
(
»s
);

1866  
»s
;

1868 
out_”rÜ_rc
:

1869 ià(
rc
 =ð
SCST_TGT_RES_FATAL_ERROR
) {

1870 
	`PRINT_ERROR
("Target driver %s„dy_to_xfer()„eturned "

1871 "çÈ”rÜ", 
tg‰
->
Çme
);

1873 
	`PRINT_ERROR
("Target driver %s„dy_to_xfer()„eturned invalid "

1874 "v®u%d", 
tg‰
->
Çme
, 
rc
);

1876 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_wr™e_”rÜ
));

1878 
out_dev_dÚe
:

1879 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

1880 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
;

1881 
out
;

1882 
	}
}

1885 
	$sc¡_´oûss_»dœeù_cmd
(
sc¡_cmd
 *
cmd
,

1886 
sc¡_exec_cÚ‹xt
 
cÚ‹xt
, 
check_»Œ›s
)

1888 
sc¡_tgt
 *
tgt
 = 
cmd
->tgt;

1889 
æags
;

1891 
	`TRACE_ENTRY
();

1893 
	`TRACE_DBG
("CÚ‹xt: %x", 
cÚ‹xt
);

1895 ià(
check_»Œ›s
)

1896 
	`sc¡_check_»Œ›s
(
tgt
);

1898 ià(
cÚ‹xt
 =ð
SCST_CONTEXT_SAME
)

1899 
cÚ‹xt
 = 
	`sc¡_cmd_©omic
(
cmd
è? 
SCST_CONTEXT_DIRECT_ATOMIC
 :

1900 
SCST_CONTEXT_DIRECT
;

1902 
cÚ‹xt
) {

1903 
SCST_CONTEXT_DIRECT_ATOMIC
:

1904 
	`sc¡_´oûss_aùive_cmd
(
cmd
, 
Œue
);

1907 
SCST_CONTEXT_DIRECT
:

1908 
	`sc¡_´oûss_aùive_cmd
(
cmd
, 
çl£
);

1911 
SCST_CONTEXT_TASKLET
:

1912 
	`sc¡_scheduË_skËt
(
cmd
);

1916 
	`PRINT_ERROR
("Context %x is unknown, usinghehread one",

1917 
cÚ‹xt
);

1919 
SCST_CONTEXT_THREAD
:

1920 
	`¥š_lock_œq§ve
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
, 
æags
);

1921 
	`TRACE_DBG
("Addšg cmd %°tØaùivcmd†i¡", 
cmd
);

1922 ià(
	`uÆik–y
(
cmd
->
queue_ty³
 =ð
SCST_CMD_QUEUE_HEAD_OF_QUEUE
))

1923 
	`li¡_add
(&
cmd
->
cmd_li¡_’Œy
,

1924 &
cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

1926 
	`li¡_add_ž
(&
cmd
->
cmd_li¡_’Œy
,

1927 &
cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

1928 
	`wake_up
(&
cmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

1929 
	`¥š_uÆock_œq»¡Üe
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
, 
æags
);

1933 
	`TRACE_EXIT
();

1935 
	}
}

1950 
	$sc¡_rx_d©a
(
sc¡_cmd
 *
cmd
, 
¡©us
,

1951 
sc¡_exec_cÚ‹xt
 
´ef_cÚ‹xt
)

1953 
	`TRACE_ENTRY
();

1955 
	`sc¡_£t_rdy_to_xãr_time
(
cmd
);

1957 
	`TRACE_DBG
("P»ã¼ed cÚ‹xt: %d", 
´ef_cÚ‹xt
);

1959 
cmd
->
cmd_hw_³ndšg
 = 0;

1961 #ifdeà
CONFIG_SCST_EXTRACHECKS


1962 ià((
	`š_œq
(è|| 
	`œqs_di§bËd
()) &&

1963 ((
´ef_cÚ‹xt
 =ð
SCST_CONTEXT_DIRECT
) ||

1964 (
´ef_cÚ‹xt
 =ð
SCST_CONTEXT_DIRECT_ATOMIC
))) {

1965 
	`PRINT_ERROR
("Wrong context %d in IRQ fromarget %s, use "

1966 "SCST_CONTEXT_THREAD in¡—d", 
´ef_cÚ‹xt
,

1967 
cmd
->
tg‰
->
Çme
);

1968 
	`dump_¡ack
();

1969 
´ef_cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

1973 
¡©us
) {

1974 
SCST_RX_STATUS_SUCCESS
:

1975 
cmd
->
¡©e
 = 
SCST_CMD_STATE_TGT_PRE_EXEC
;

1977 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


1978 ià(
cmd
->
Ý_æags
 & 
SCST_TEST_IO_IN_SIRQ_ALLOWED
)

1986 ià((
´ef_cÚ‹xt
 =ð
SCST_CONTEXT_TASKLET
) ||

1987 (
´ef_cÚ‹xt
 =ð
SCST_CONTEXT_DIRECT_ATOMIC
) ||

1988 ((
´ef_cÚ‹xt
 =ð
SCST_CONTEXT_SAME
) &&

1989 
	`sc¡_cmd_©omic
(
cmd
)))

1990 
´ef_cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

1993 
SCST_RX_STATUS_ERROR_SENSE_SET
:

1994 
	`TRACE
(
TRACE_SCSI
, "cmd %p, RX d©¨”rÜ stu %#x", 
cmd
, 
¡©us
);

1995 ià(!
cmd
->
wr™e_nÙ_»ûived_£t
)

1996 
	`sc¡_cmd_£t_wr™e_no_d©a_»ûived
(
cmd
);

1997 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

1998 
´ef_cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

2001 
SCST_RX_STATUS_ERROR_FATAL
:

2002 
	`£t_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
);

2003 
	`£t_b™
(
SCST_CMD_NO_RESP
, &
cmd
->
cmd_æags
);

2004 
cmd
->
d–iv”y_¡©us
 = 
SCST_CMD_DELIVERY_FAILED
;

2006 
SCST_RX_STATUS_ERROR
:

2007 
	`TRACE
(
TRACE_SCSI
, "cmd %p, RX d©¨”rÜ stu %#x", 
cmd
, 
¡©us
);

2008 ià(!
cmd
->
wr™e_nÙ_»ûived_£t
)

2009 
	`sc¡_cmd_£t_wr™e_no_d©a_»ûived
(
cmd
);

2010 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2011 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

2012 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

2013 
´ef_cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

2017 
	`PRINT_ERROR
("scst_rx_data()„eceived unknown status %x",

2018 
¡©us
);

2019 ià(!
cmd
->
wr™e_nÙ_»ûived_£t
)

2020 
	`sc¡_cmd_£t_wr™e_no_d©a_»ûived
(
cmd
);

2021 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

2022 
´ef_cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

2026 
	`sc¡_´oûss_»dœeù_cmd
(
cmd
, 
´ef_cÚ‹xt
, 1);

2028 
	`TRACE_EXIT
();

2030 
	}
}

2031 
EXPORT_SYMBOL
(
sc¡_rx_d©a
);

2033 
	$sc¡_tgt_´e_exec
(
sc¡_cmd
 *
cmd
)

2035 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
, 
rc
;

2037 
	`TRACE_ENTRY
();

2039 #ià
	`defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

2040 ià(
	`uÆik–y
(
Œaû_æag
 & 
TRACE_DATA_RECEIVED
) &&

2041 (
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
)) {

2042 
i
, 
sg_út
;

2043 
sÿ‰”li¡
 *
sg
, *
sgi
;

2045 ià(
cmd
->
out_sg
 !ð
NULL
) {

2046 
sg
 = 
cmd
->
out_sg
;

2047 
sg_út
 = 
cmd
->
out_sg_út
;

2048 } ià(
cmd
->
tgt_out_sg
 !ð
NULL
) {

2049 
sg
 = 
cmd
->
tgt_out_sg
;

2050 
sg_út
 = 
cmd
->
tgt_out_sg_út
;

2051 } ià(
cmd
->
tgt_i_sg
 !ð
NULL
) {

2052 
sg
 = 
cmd
->
tgt_i_sg
;

2053 
sg_út
 = 
cmd
->
tgt_i_sg_út
;

2055 
sg
 = 
cmd
->sg;

2056 
sg_út
 = 
cmd
->sg_cnt;

2058 ià(
sg
 !ð
NULL
) {

2059 
	`PRINT_INFO
("Received data for cmd %p (sg_cnt %d, "

2060 "sg %p, sg[0].·g%p)", 
cmd
, 
sg_út
, 
sg
,

2061 (*)
	`sg_·ge
(&
sg
[0]));

2062 
	`fÜ_—ch_sg
(
sg
, 
sgi
, 
sg_út
, 
i
) {

2063 
	`PRINT_INFO
("sg %d", 
i
);

2064 
	`PRINT_BUFFER
("d©a", 
	`sg_vœt
(
sgi
), sgi->
Ëngth
);

2070 ià(
	`uÆik–y
(
cmd
->
»sid_possibË
)) {

2071 ià(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
) {

2072 
boÞ
 
»mašd”
 = 
çl£
;

2074 ià(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_READ
) {

2075 ià(
cmd
->
wr™e_Ën
 !ðcmd->
out_bufæ’
)

2076 
»mašd”
 = 
Œue
;

2078 ià(
cmd
->
wr™e_Ën
 !ðcmd->
bufæ’
)

2079 
»mašd”
 = 
Œue
;

2081 ià(
»mašd”
) {

2082 ià(!(
cmd
->
Ý_æags
 & 
SCST_TRANSFER_LEN_TYPE_FIXED
) ||

2083 (
cmd
->
wr™e_Ën
 & ((1 << cmd->
dev
->
block_shiá
) - 1)) == 0) {

2085 
	`sc¡_check_»¡Üe_sg_buff
(
cmd
);

2086 
	`sc¡_z”o_wr™e_»¡
(
cmd
);

2100 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2101 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_commªd_šfÜm©iÚ_un™
));

2102 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

2103 
out
;

2109 
cmd
->
¡©e
 = 
SCST_CMD_STATE_EXEC_CHECK_SN
;

2111 ià(
	`uÆik–y
(
cmd
->
š‹º®
)) {

2112 ià(
cmd
->
dh_d©a_buf_®loûd
 && cmd->
tgt_i_d©a_buf_®loûd
 &&

2113 (
	`sc¡_cmd_g‘_d©a_dœeùiÚ
(
cmd
è& 
SCST_DATA_WRITE
)) {

2114 
	`TRACE_DBG
("Internal WRITE cmd %p with DH‡lloced data",

2115 
cmd
);

2116 
	`sc¡_cÝy_sg
(
cmd
, 
SCST_SG_COPY_FROM_TARGET
);

2118 
out_desü
;

2121 ià(
cmd
->
tg‰
->
´e_exec
 =ð
NULL
)

2122 
out_desü
;

2124 
	`TRACE_DBG
("C®lšg…»_exec(%p)", 
cmd
);

2125 
	`sc¡_£t_cur_¡¬t
(
cmd
);

2126 
rc
 = 
cmd
->
tg‰
->
	`´e_exec
(cmd);

2127 
	`sc¡_£t_´e_exec_time
(
cmd
);

2128 
	`TRACE_DBG
("´e_exec(è»tuºed %d", 
rc
);

2130 ià(
	`uÆik–y
(
rc
 !ð
SCST_PREPROCESS_STATUS_SUCCESS
)) {

2131 
rc
) {

2132 
SCST_PREPROCESS_STATUS_ERROR_SENSE_SET
:

2133 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

2134 
out
;

2135 
SCST_PREPROCESS_STATUS_ERROR_FATAL
:

2136 
	`£t_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
);

2137 
	`£t_b™
(
SCST_CMD_NO_RESP
, &
cmd
->
cmd_æags
);

2138 
cmd
->
d–iv”y_¡©us
 = 
SCST_CMD_DELIVERY_FAILED
;

2140 
SCST_PREPROCESS_STATUS_ERROR
:

2141 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2142 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

2143 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

2144 
out
;

2146 
	`sBUG
();

2150 
out_desü
:

2151 ià(
	`uÆik–y
(
cmd
->
Ý_æags
 & 
SCST_DESCRIPTORS_BASED
)) {

2152 
r
 = 
	`sc¡_·r£_desütÜs
(
cmd
);

2154 ià(
	`uÆik–y
(
r
 != 0))

2155 
out
;

2158 
out
:

2159 
	`TRACE_EXIT_RES
(
»s
);

2160  
»s
;

2161 
	}
}

2163 
	$sc¡_do_cmd_dÚe
(
sc¡_cmd
 *
cmd
, 
»suÉ
,

2164 cÚ¡ 
ušt8_t
 *
rq_£n£
, 
rq_£n£_Ën
, 
»sid
)

2166 
	`TRACE_ENTRY
();

2168 
	`sc¡_£t_exec_time
(
cmd
);

2170 
cmd
->
¡©us
 = 
»suÉ
 & 0xff;

2171 
cmd
->
msg_¡©us
 = 
	`msg_by‹
(
»suÉ
);

2172 
cmd
->
ho¡_¡©us
 = 
	`ho¡_by‹
(
»suÉ
);

2173 
cmd
->
driv”_¡©us
 = 
	`driv”_by‹
(
»suÉ
);

2174 ià(
	`uÆik–y
(
»sid
 != 0)) {

2175 ià((
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_READ
) &&

2176 (
»sid
 > 0è&& (»sid < 
cmd
->
»¥_d©a_Ën
))

2177 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, cmd->
»¥_d©a_Ën
 - 
»sid
);

2184 ià(
	`uÆik–y
(
cmd
->
¡©us
 =ð
SAM_STAT_CHECK_CONDITION
)) {

2186 
cmd
->
dbl_ua_Üig_»¥_d©a_Ën
 = cmd->
»¥_d©a_Ën
;

2187 
cmd
->
dbl_ua_Üig_d©a_dœeùiÚ
 = cmd->
d©a_dœeùiÚ
;

2189 
	`sc¡_®loc_£t_£n£
(
cmd
, 1, 
rq_£n£
, 
rq_£n£_Ën
);

2192 
	`TRACE
(
TRACE_SCSI
, "cmd %p,„esult %x, cmd->status %x,„esid %d, "

2194 "cmd->driv”_¡©u %x", 
cmd
, 
»suÉ
, cmd->
¡©us
, 
»sid
,

2195 
cmd
->
msg_¡©us
, cmd->
ho¡_¡©us
, cmd->
driv”_¡©us
);

2197 
cmd
->
com¶‘ed
 = 1;

2199 
	`TRACE_EXIT
();

2201 
	}
}

2204 
šlše
 
sc¡_exec_cÚ‹xt
 
	$sc¡_Ýtimize_po¡_exec_cÚ‹xt
(

2205 
sc¡_cmd
 *
cmd
, 
sc¡_exec_cÚ‹xt
 
cÚ‹xt
)

2207 ià(((
cÚ‹xt
 =ð
SCST_CONTEXT_SAME
è&& 
	`sc¡_cmd_©omic
(
cmd
)) ||

2208 (
cÚ‹xt
 =ð
SCST_CONTEXT_TASKLET
) ||

2209 (
cÚ‹xt
 =ð
SCST_CONTEXT_DIRECT_ATOMIC
)) {

2210 ià(!
cmd
->
tgt_dev
->
tgt_dev_aá”_exec_©omic
)

2211 
cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

2213  
cÚ‹xt
;

2214 
	}
}

2223 
	$sc¡_·ss_through_cmd_dÚe
(*
d©a
, *
£n£
, 
»suÉ
, 
»sid
)

2225 
sc¡_cmd
 *
cmd
 = 
d©a
;

2227 
	`TRACE_ENTRY
();

2229 ià(
cmd
 =ð
NULL
)

2230 
out
;

2232 
	`TRACE_DBG
("cmd %p; CDB[0/%d] %#x:„esuÉ %d;„esid %d", 
cmd
,

2233 
cmd
->
cdb_Ën
, cmd->
cdb
[0], 
»suÉ
, 
»sid
);

2235 
	`sc¡_do_cmd_dÚe
(
cmd
, 
»suÉ
, 
£n£
, 
SCSI_SENSE_BUFFERSIZE
, 
»sid
);

2237 
cmd
->
¡©e
 = 
SCST_CMD_STATE_PRE_DEV_DONE
;

2239 
	`sc¡_´oûss_»dœeù_cmd
(
cmd
,

2240 
	`sc¡_Ýtimize_po¡_exec_cÚ‹xt
(
cmd
, 
	`sc¡_e¡im©e_cÚ‹xt
()), 0);

2242 
out
:

2243 
	`TRACE_EXIT
();

2245 
	}
}

2246 
EXPORT_SYMBOL_GPL
(
sc¡_·ss_through_cmd_dÚe
);

2248 
	$sc¡_cmd_dÚe_loÿl
(
sc¡_cmd
 *
cmd
, 
Ãxt_¡©e
,

2249 
sc¡_exec_cÚ‹xt
 
´ef_cÚ‹xt
)

2251 
	`TRACE_ENTRY
();

2253 
	`sc¡_£t_exec_time
(
cmd
);

2255 
	`TRACE
(
TRACE_SCSI
, "cmd %p, status %x, msg_status %x, host_status %x, "

2256 "driv”_¡©u %x,„e¥_d©a_ËÀ%d", 
cmd
, cmd->
¡©us
,

2257 
cmd
->
msg_¡©us
, cmd->
ho¡_¡©us
, cmd->
driv”_¡©us
,

2258 
cmd
->
»¥_d©a_Ën
);

2260 ià(
Ãxt_¡©e
 =ð
SCST_CMD_STATE_DEFAULT
)

2261 
Ãxt_¡©e
 = 
SCST_CMD_STATE_PRE_DEV_DONE
;

2263 
cmd
->
¡©e
 = 
Ãxt_¡©e
;

2265 #ifdeà
CONFIG_SCST_EXTRACHECKS


2266 ià((
Ãxt_¡©e
 !ð
SCST_CMD_STATE_PRE_DEV_DONE
) &&

2267 (
Ãxt_¡©e
 !ð
SCST_CMD_STATE_PRE_XMIT_RESP1
) &&

2268 (
Ãxt_¡©e
 !ð
SCST_CMD_STATE_PRE_XMIT_RESP2
) &&

2269 (
Ãxt_¡©e
 !ð
SCST_CMD_STATE_FINISHED
) &&

2270 (
Ãxt_¡©e
 !ð
SCST_CMD_STATE_FINISHED_INTERNAL
)) {

2271 
	`PRINT_ERROR
("%s()„eceived invalid cmd state %d (opcode %s)",

2272 
__func__
, 
Ãxt_¡©e
, 
	`sc¡_g‘_Ýcode_Çme
(
cmd
));

2273 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2274 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

2275 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

2278 
´ef_cÚ‹xt
 = 
	`sc¡_Ýtimize_po¡_exec_cÚ‹xt
(
cmd
,…ref_context);

2279 
	`sc¡_´oûss_»dœeù_cmd
(
cmd
, 
´ef_cÚ‹xt
, 0);

2281 
	`TRACE_EXIT
();

2283 
	}
}

2285 
	$sc¡_»pÜt_luns_loÿl
(
sc¡_cmd
 *
cmd
)

2287 
»s
 = 
SCST_EXEC_COMPLETED
;

2288 
dev_út
 = 0;

2289 
bufãr_size
;

2290 
i
;

2291 
sc¡_tgt_dev
 *
tgt_dev
 = 
NULL
;

2292 
ušt8_t
 *
bufãr
;

2293 
offs
, 
ov”æow
 = 0;

2295 
	`TRACE_ENTRY
();

2297 
cmd
->
¡©us
 = 0;

2298 
cmd
->
msg_¡©us
 = 0;

2299 
cmd
->
ho¡_¡©us
 = 
DID_OK
;

2300 
cmd
->
driv”_¡©us
 = 0;

2302 ià((
cmd
->
cdb
[2] != 0) && (cmd->cdb[2] != 2)) {

2303 
	`TRACE
(
TRACE_MINOR
, "Unsupported SELECT REPORT value %#x in "

2304 "REPORT LUNS commªd", 
cmd
->
cdb
[2]);

2305 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 2, 0);

2306 
out_com¶
;

2309 
bufãr_size
 = 
	`sc¡_g‘_buf_fuÎ_£n£
(
cmd
, &
bufãr
);

2310 ià(
	`uÆik–y
(
bufãr_size
 <= 0))

2311 
out_com¶
;

2313 ià(
bufãr_size
 < 16) {

2314 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 6, 0);

2315 
out_put_”r
;

2318 
	`mem£t
(
bufãr
, 0, 
bufãr_size
);

2319 
offs
 = 8;

2325 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

2326 
li¡_h—d
 *
h—d
 = &
cmd
->
£ss
->
£ss_tgt_dev_li¡
[
i
];

2328 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
, 
£ss_tgt_dev_li¡_’Œy
) {

2329 ià(!
ov”æow
) {

2330 ià((
bufãr_size
 - 
offs
) < 8) {

2331 
ov”æow
 = 1;

2332 
šc_dev_út
;

2334 *(
__fÜû
 
__be64
 *)&
bufãr
[
offs
]

2335 ð
	`sc¡_·ck_lun
(
tgt_dev
->
lun
,

2336 
cmd
->
£ss
->
acg
->
addr_m‘hod
);

2337 
offs
 += 8;

2339 
šc_dev_út
:

2340 
dev_út
++;

2345 
dev_út
 *= 8;

2346 
	`put_uÇligÃd_be32
(
dev_út
, 
bufãr
);

2348 
	`sc¡_put_buf_fuÎ
(
cmd
, 
bufãr
);

2350 
dev_út
 += 8;

2351 ià(
dev_út
 < 
cmd
->
»¥_d©a_Ën
)

2352 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
dev_út
);

2354 
out_com¶
:

2355 
cmd
->
com¶‘ed
 = 1;

2363 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

2364 
li¡_h—d
 *
h—d
 = &
cmd
->
£ss
->
£ss_tgt_dev_li¡
[
i
];

2366 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
, 
£ss_tgt_dev_li¡_’Œy
) {

2367 
sc¡_tgt_dev_UA
 *
ua
;

2369 
	`¥š_lock_bh
(&
tgt_dev
->
tgt_dev_lock
);

2370 
	`li¡_fÜ_—ch_’Œy
(
ua
, &
tgt_dev
->
UA_li¡
,

2371 
UA_li¡_’Œy
) {

2372 ià(
	`sc¡_ª®yze_£n£
(
ua
->
UA_£n£_bufãr
,

2373 
ua
->
UA_v®id_£n£_Ën
,

2374 
SCST_SENSE_ALL_VALID
,

2375 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»pÜ‹d_luns_d©a_chªged
))) {

2376 
	`TRACE_DBG
("Freeing‚ot‚eeded "

2378 "%p", 
ua
);

2379 
	`sc¡_tgt_dev_d–_ä“_UA
(
tgt_dev
, 
ua
);

2383 
	`¥š_uÆock_bh
(&
tgt_dev
->
tgt_dev_lock
);

2388 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

2390 
	`TRACE_EXIT_RES
(
»s
);

2391  
»s
;

2393 
out_put_”r
:

2394 
	`sc¡_put_buf_fuÎ
(
cmd
, 
bufãr
);

2395 
out_com¶
;

2396 
	}
}

2398 
	$sc¡_»que¡_£n£_loÿl
(
sc¡_cmd
 *
cmd
)

2400 
»s
 = 
SCST_EXEC_COMPLETED
;

2401 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

2402 
ušt8_t
 *
bufãr
;

2403 
bufãr_size
 = 0, 
¦
 = 0;

2405 
	`TRACE_ENTRY
();

2407 
cmd
->
¡©us
 = 0;

2408 
cmd
->
msg_¡©us
 = 0;

2409 
cmd
->
ho¡_¡©us
 = 
DID_OK
;

2410 
cmd
->
driv”_¡©us
 = 0;

2412 
bufãr_size
 = 
	`sc¡_g‘_buf_fuÎ_£n£
(
cmd
, &
bufãr
);

2413 ià(
	`uÆik–y
(
bufãr_size
 <= 0))

2414 
out_com¶
;

2416 
	`mem£t
(
bufãr
, 0, 
bufãr_size
);

2418 
	`¥š_lock_bh
(&
tgt_dev
->
tgt_dev_lock
);

2420 ià(
tgt_dev
->
tgt_dev_v®id_£n£_Ën
 == 0) {

2421 ià(
	`‹¡_b™
(
SCST_TGT_DEV_UA_PENDING
, &
cmd
->
tgt_dev
->
tgt_dev_æags
)) {

2422 
rc
, 
size
 = (
tgt_dev
->
tgt_dev_£n£
);

2423 
ušt8_t
 *
buf
;

2425 
	`¥š_uÆock_bh
(&
tgt_dev
->
tgt_dev_lock
);

2427 
buf
 = 
	`kz®loc
(
size
, 
GFP_KERNEL
);

2428 ià(
buf
 =ð
NULL
)

2429 
out_put_busy
;

2431 
rc
 = 
	`sc¡_£t_³ndšg_UA
(
cmd
, 
buf
, &
size
);

2433 
	`¥š_lock_bh
(&
tgt_dev
->
tgt_dev_lock
);

2435 ià(
rc
 == 0) {

2436 ià(
tgt_dev
->
tgt_dev_v®id_£n£_Ën
 == 0) {

2437 
tgt_dev
->
tgt_dev_v®id_£n£_Ën
 = 
size
;

2438 
	`memýy
(
tgt_dev
->
tgt_dev_£n£
, 
buf
, 
size
);

2445 
	`sc¡_»queue_ua
(
cmd
, 
buf
, 
size
);

2449 
	`kä“
(
buf
);

2451 ià(
tgt_dev
->
tgt_dev_v®id_£n£_Ën
 == 0)

2452 
out_uÆock_put_nÙ_com¶‘ed
;

2455 
	`TRACE
(
TRACE_SCSI
, "%s: R‘uºšg stÜed/UA s’£", 
cmd
->
Ý_Çme
);

2457 ià(((
	`sc¡_£n£_»¥Ú£_code
(
tgt_dev
->
tgt_dev_£n£
) == 0x70) ||

2458 (
	`sc¡_£n£_»¥Ú£_code
(
tgt_dev
->
tgt_dev_£n£
) == 0x71)) &&

2459 (
cmd
->
cdb
[1] & 1)) {

2460 
	`PRINT_WARNING
("%s: Fixed format ofhe saved sense, but "

2462 "Œunÿ‹d d©a", 
cmd
->
Ý_Çme
);

2463 
	`PRINT_BUFFER
("Origš® s’£", 
tgt_dev
->
tgt_dev_£n£
,

2464 
tgt_dev
->
tgt_dev_v®id_£n£_Ën
);

2466 
bufãr_size
 = 
	`mš
(
SCST_STANDARD_SENSE_LEN
, buffer_size);

2467 
¦
 = 
	`sc¡_£t_£n£
(
bufãr
, 
bufãr_size
, 
Œue
,

2468 
tgt_dev
->
tgt_dev_£n£
[2],gt_dev->tgt_dev_sense[12],

2469 
tgt_dev
->
tgt_dev_£n£
[13]);

2470 } ià(((
	`sc¡_£n£_»¥Ú£_code
(
tgt_dev
->
tgt_dev_£n£
) == 0x72) ||

2471 (
	`sc¡_£n£_»¥Ú£_code
(
tgt_dev
->
tgt_dev_£n£
) == 0x73)) &&

2472 !(
cmd
->
cdb
[1] & 1)) {

2473 
	`PRINT_WARNING
("%s: Descriptor format ofhe "

2475 "wžÈŒunÿ‹ d©a", 
cmd
->
Ý_Çme
);

2476 
	`PRINT_BUFFER
("Origš® s’£", 
tgt_dev
->
tgt_dev_£n£
,

2477 
tgt_dev
->
tgt_dev_v®id_£n£_Ën
);

2479 
bufãr_size
 = 
	`mš
(
SCST_STANDARD_SENSE_LEN
, buffer_size);

2480 
¦
 = 
	`sc¡_£t_£n£
(
bufãr
, 
bufãr_size
, 
çl£
,

2481 
tgt_dev
->
tgt_dev_£n£
[1],gt_dev->tgt_dev_sense[2],

2482 
tgt_dev
->
tgt_dev_£n£
[3]);

2484 ià(
bufãr_size
 >ð
tgt_dev
->
tgt_dev_v®id_£n£_Ën
)

2485 
¦
 = 
tgt_dev
->
tgt_dev_v®id_£n£_Ën
;

2487 
¦
 = 
bufãr_size
;

2488 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
, "%s: Being„eturned sense "

2489 "Œunÿ‹dØsiz%d (Ãeded %d)", 
cmd
->
Ý_Çme
,

2490 
bufãr_size
, 
tgt_dev
->
tgt_dev_v®id_£n£_Ën
);

2492 
	`memýy
(
bufãr
, 
tgt_dev
->
tgt_dev_£n£
, 
¦
);

2495 
tgt_dev
->
tgt_dev_v®id_£n£_Ën
 = 0;

2497 
	`¥š_uÆock_bh
(&
tgt_dev
->
tgt_dev_lock
);

2499 
	`sc¡_put_buf_fuÎ
(
cmd
, 
bufãr
);

2501 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
¦
);

2503 
out_com¶
:

2504 
cmd
->
com¶‘ed
 = 1;

2507 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

2509 
out
:

2510 
	`TRACE_EXIT_RES
(
»s
);

2511  
»s
;

2513 
out_put_busy
:

2514 
	`sc¡_put_buf_fuÎ
(
cmd
, 
bufãr
);

2515 
	`sc¡_£t_busy
(
cmd
);

2516 
out_com¶
;

2518 
out_uÆock_put_nÙ_com¶‘ed
:

2519 
	`¥š_uÆock_bh
(&
tgt_dev
->
tgt_dev_lock
);

2520 
	`sc¡_put_buf_fuÎ
(
cmd
, 
bufãr
);

2521 
»s
 = 
SCST_EXEC_NOT_COMPLETED
;

2522 
out
;

2523 
	}
}

2525 
	$sc¡_»pÜt_suµÜ‹d_tm_âs
(
sc¡_cmd
 *
cmd
)

2527 
»s
 = 
SCST_EXEC_COMPLETED
;

2528 
Ëngth
, 
»¥_Ën
 = 0;

2529 
ušt8_t
 *
add»ss
;

2530 
ušt8_t
 
buf
[16];

2532 
	`TRACE_ENTRY
();

2534 
Ëngth
 = 
	`sc¡_g‘_buf_fuÎ_£n£
(
cmd
, &
add»ss
);

2535 
	`TRACE_DBG
("Ëngth %d", 
Ëngth
);

2536 ià(
	`uÆik–y
(
Ëngth
 <= 0))

2537 
out_com¶
;

2539 
	`mem£t
(
buf
, 0, (buf));

2541 
buf
[0] = 0xD8;

2542 
buf
[1] = 0;

2543 ià((
cmd
->
cdb
[2] & 0x80) == 0)

2544 
»¥_Ën
 = 4;

2546 
buf
[3] = 0x0C;

2548 
buf
[4] = 1;

2549 
buf
[6] = 0x80;

2550 
	`put_uÇligÃd_be32
(300, &
buf
[8]);

2551 
	`put_uÇligÃd_be32
(150, &
buf
[12]);

2553 
»¥_Ën
 = 16;

2556 ià(
Ëngth
 > 
»¥_Ën
)

2557 
Ëngth
 = 
»¥_Ën
;

2558 
	`memýy
(
add»ss
, 
buf
, 
Ëngth
);

2560 
	`sc¡_put_buf_fuÎ
(
cmd
, 
add»ss
);

2561 ià(
Ëngth
 < 
cmd
->
»¥_d©a_Ën
)

2562 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
Ëngth
);

2564 
out_com¶
:

2565 
cmd
->
com¶‘ed
 = 1;

2568 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

2570 
	`TRACE_EXIT_RES
(
»s
);

2571  
»s
;

2572 
	}
}

2574 
	$sc¡_»pÜt_suµÜ‹d_Ýcodes
(
sc¡_cmd
 *
cmd
)

2576 
»s
 = 
SCST_EXEC_COMPLETED
;

2577 
Ëngth
, 
buf_Ën
, 
i
, 
offs
;

2578 
ušt8_t
 *
add»ss
;

2579 
ušt8_t
 *
buf
;

2580 
boÞ
 
šlše_buf
;

2581 
boÞ
 
rùd
 = 
cmd
->
cdb
[2] >> 7;

2582 
ÝtiÚs
 = 
cmd
->
cdb
[2] & 7;

2583 
»q_Ýcode
 = 
cmd
->
cdb
[3];

2584 
»q_§
 = 
	`g‘_uÇligÃd_be16
(&
cmd
->
cdb
[4]);

2585 cÚ¡ 
sc¡_Ýcode_desütÜ
 *
Ý
 = 
NULL
;

2586 cÚ¡ 
sc¡_Ýcode_desütÜ
 **
suµ_Ýcodes
 = 
NULL
;

2587 
suµ_Ýcodes_út
, 
rc
;

2589 
	`TRACE_ENTRY
();

2593 
rc
 = 
cmd
->
devt
->
	`g‘_suµÜ‹d_Ýcodes
(cmd, &
suµ_Ýcodes
, &
suµ_Ýcodes_út
);

2594 ià(
rc
 != 0)

2595 
out_com¶
;

2597 
	`TRACE_DBG
("cmd %p, options %d,„eq_opcode %x,„eq_sa %x,„ctd %d",

2598 
cmd
, 
ÝtiÚs
, 
»q_Ýcode
, 
»q_§
, 
rùd
);

2600 
ÝtiÚs
) {

2602 
buf_Ën
 = 4;

2603 
i
 = 0; i < 
suµ_Ýcodes_út
; i++) {

2604 
buf_Ën
 += 8;

2605 ià(
rùd
)

2606 
buf_Ën
 += 12;

2610 
buf_Ën
 = 0;

2611 
i
 = 0; i < 
suµ_Ýcodes_út
; i++) {

2612 ià(
»q_Ýcode
 =ð
suµ_Ýcodes
[
i
]->
od_Ýcode
) {

2613 
Ý
 = 
suµ_Ýcodes
[
i
];

2614 ià(
Ý
->
od_£rv_aùiÚ_v®id
) {

2615 
	`TRACE
(
TRACE_MINOR
, "Requested opcode %x "

2618 
»q_Ýcode
, 
cmd
->
dev
->
vœt_Çme
,

2619 
cmd
->
£ss
->
š™ŸtÜ_Çme
);

2620 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 2,

2621 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 0);

2622 
out_com¶
;

2624 
buf_Ën
 = 4 + 
Ý
->
od_cdb_size
;

2625 ià(
rùd
)

2626 
buf_Ën
 += 12;

2630 ià(
Ý
 =ð
NULL
) {

2631 
	`TRACE
(
TRACE_MINOR
, "Requested opcode %x‚ot found "

2632 "(dev %s, in™ŸtÜ %s)", 
»q_Ýcode
,

2633 
cmd
->
dev
->
vœt_Çme
, cmd->
£ss
->
š™ŸtÜ_Çme
);

2634 
buf_Ën
 = 4;

2638 
buf_Ën
 = 0;

2639 
i
 = 0; i < 
suµ_Ýcodes_út
; i++) {

2640 ià(
»q_Ýcode
 =ð
suµ_Ýcodes
[
i
]->
od_Ýcode
) {

2641 
Ý
 = 
suµ_Ýcodes
[
i
];

2642 ià(!
Ý
->
od_£rv_aùiÚ_v®id
) {

2643 
	`TRACE
(
TRACE_MINOR
, "Requested opcode %x "

2646 
»q_Ýcode
, 
cmd
->
dev
->
vœt_Çme
,

2647 
cmd
->
£ss
->
š™ŸtÜ_Çme
);

2648 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 2,

2649 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 0);

2650 
out_com¶
;

2652 ià(
»q_§
 !ð
Ý
->
od_£rv_aùiÚ
) {

2653 
Ý
 = 
NULL
;

2656 
buf_Ën
 = 4 + 
Ý
->
od_cdb_size
;

2657 ià(
rùd
)

2658 
buf_Ën
 += 12;

2662 ià(
Ý
 =ð
NULL
) {

2663 
	`TRACE
(
TRACE_MINOR
, "Requested opcode %x/%x‚ot found "

2664 "(dev %s, in™ŸtÜ %s)", 
»q_Ýcode
, 
»q_§
,

2665 
cmd
->
dev
->
vœt_Çme
, cmd->
£ss
->
š™ŸtÜ_Çme
);

2666 
buf_Ën
 = 4;

2670 
	`PRINT_ERROR
("REPORT SUPPORTED OPERATION CODES: REPORTING OPTIONS "

2671 "%x‚Ù suµÜ‹d (dev %s, in™ŸtÜ %s)", 
ÝtiÚs
,

2672 
cmd
->
dev
->
vœt_Çme
, cmd->
£ss
->
š™ŸtÜ_Çme
);

2673 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 2,

2674 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 0);

2675 
out_com¶
;

2678 
Ëngth
 = 
	`sc¡_g‘_buf_fuÎ_£n£
(
cmd
, &
add»ss
);

2679 
	`TRACE_DBG
("Ëngth %d, buf_ËÀ%d, o°%p", 
Ëngth
, 
buf_Ën
, 
Ý
);

2680 ià(
	`uÆik–y
(
Ëngth
 <= 0))

2681 
out_com¶
;

2683 ià(
Ëngth
 >ð
buf_Ën
) {

2684 
buf
 = 
add»ss
;

2685 
šlše_buf
 = 
Œue
;

2687 
buf
 = 
	`vm®loc
(
buf_Ën
);

2688 ià(
buf
 =ð
NULL
) {

2689 
	`PRINT_ERROR
("Unableo‡llocate REPORT SUPPORTED "

2690 "OPERATION CODES bufã¸w™h siz%d", 
buf_Ën
);

2691 
	`sc¡_£t_busy
(
cmd
);

2692 
out_”r_put
;

2694 
šlše_buf
 = 
çl£
;

2697 
	`mem£t
(
buf
, 0, 
buf_Ën
);

2699 
ÝtiÚs
) {

2701 
	`put_uÇligÃd_be32
(
buf_Ën
 - 4, &
buf
[0]);

2702 
offs
 = 4;

2703 
i
 = 0; i < 
suµ_Ýcodes_út
; i++) {

2704 
Ý
 = 
suµ_Ýcodes
[
i
];

2705 
buf
[
offs
] = 
Ý
->
od_Ýcode
;

2706 ià(
Ý
->
od_£rv_aùiÚ_v®id
) {

2707 
	`put_uÇligÃd_be16
(
Ý
->
od_£rv_aùiÚ
, &
buf
[
offs
 + 2]);

2708 
buf
[
offs
 + 5] |= 1;

2710 
	`put_uÇligÃd_be16
(
Ý
->
od_cdb_size
, &
buf
[
offs
 + 6]);

2711 
offs
 += 8;

2712 ià(
rùd
) {

2713 
buf
[(
offs
 - 8) + 5] |= 2;

2714 
buf
[
offs
 + 1] = 0xA;

2715 
buf
[
offs
 + 3] = 
Ý
->
od_comm_¥ecific_timeout
;

2716 
	`put_uÇligÃd_be32
(
Ý
->
od_nomš®_timeout
, &
buf
[
offs
 + 4]);

2717 
	`put_uÇligÃd_be32
(
Ý
->
od_»comm’ded_timeout
, &
buf
[
offs
 + 8]);

2718 
offs
 += 12;

2724 ià(
Ý
 !ð
NULL
) {

2725 
buf
[1] |ð
Ý
->
od_suµÜt
;

2726 
	`put_uÇligÃd_be16
(
Ý
->
od_cdb_size
, &
buf
[2]);

2727 
	`memýy
(&
buf
[4], 
Ý
->
od_cdb_u§ge_b™s
, op->
od_cdb_size
);

2728 ià(
rùd
) {

2729 
buf
[1] |= 0x80;

2730 
offs
 = 4 + 
Ý
->
od_cdb_size
;

2731 
buf
[
offs
 + 1] = 0xA;

2732 
buf
[
offs
 + 3] = 
Ý
->
od_comm_¥ecific_timeout
;

2733 
	`put_uÇligÃd_be32
(
Ý
->
od_nomš®_timeout
, &
buf
[
offs
 + 4]);

2734 
	`put_uÇligÃd_be32
(
Ý
->
od_»comm’ded_timeout
, &
buf
[
offs
 + 8]);

2739 
	`sBUG
();

2742 ià(
Ëngth
 > 
buf_Ën
)

2743 
Ëngth
 = 
buf_Ën
;

2744 ià(!
šlše_buf
) {

2745 
	`memýy
(
add»ss
, 
buf
, 
Ëngth
);

2746 
	`vä“
(
buf
);

2749 
	`sc¡_put_buf_fuÎ
(
cmd
, 
add»ss
);

2750 ià(
Ëngth
 < 
cmd
->
»¥_d©a_Ën
)

2751 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
Ëngth
);

2753 
out_com¶
:

2754 ià((
suµ_Ýcodes
 !ð
NULL
è&& (
cmd
->
devt
->
put_suµÜ‹d_Ýcodes
 != NULL))

2755 
cmd
->
devt
->
	`put_suµÜ‹d_Ýcodes
(cmd, 
suµ_Ýcodes
, 
suµ_Ýcodes_út
);

2757 
cmd
->
com¶‘ed
 = 1;

2760 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

2762 
	`TRACE_EXIT_RES
(
»s
);

2763  
»s
;

2765 
out_”r_put
:

2766 
	`sc¡_put_buf_fuÎ
(
cmd
, 
add»ss
);

2767 
out_com¶
;

2768 
	}
}

2770 
	$sc¡_maš‹Çnû_š
(
sc¡_cmd
 *
cmd
)

2772 
»s
;

2774 
	`TRACE_ENTRY
();

2776 
cmd
->
cdb
[1] & 0x1f) {

2777 
MI_REPORT_SUPPORTED_TASK_MANAGEMENT_FUNCTIONS
:

2778 
»s
 = 
	`sc¡_»pÜt_suµÜ‹d_tm_âs
(
cmd
);

2780 
MI_REPORT_SUPPORTED_OPERATION_CODES
:

2781 
»s
 = 
	`sc¡_»pÜt_suµÜ‹d_Ýcodes
(
cmd
);

2784 
»s
 = 
SCST_EXEC_NOT_COMPLETED
;

2788 
	`TRACE_EXIT_RES
(
»s
);

2789  
»s
;

2790 
	}
}

2792 
	$sc¡_»£rve_loÿl
(
sc¡_cmd
 *
cmd
)

2794 
»s
 = 
SCST_EXEC_NOT_COMPLETED
;

2795 
sc¡_deviû
 *
dev
;

2796 
sc¡_lksb
 
´_lksb
;

2798 
	`TRACE_ENTRY
();

2800 ià((
cmd
->
cdb
[0] =ð
RESERVE_10
è&& (cmd->cdb[2] & 
SCST_RES_3RDPTY
)) {

2801 
	`PRINT_ERROR
("RESERVE_10: 3rdPty RESERVE‚ot implemented "

2802 "Öun=%Îd)", ()
cmd
->
lun
);

2803 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 2,

2804 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 4);

2805 
out_dÚe
;

2808 
dev
 = 
cmd
->dev;

2827 ià(!
	`li¡_em±y
(&
dev
->
dev_»gi¡¿Ás_li¡
)) {

2828 ià(
	`sc¡_´_üh_ÿ£
(
cmd
))

2829 
out_com¶‘ed
;

2831 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
,

2832 
SAM_STAT_RESERVATION_CONFLICT
);

2833 
out_dÚe
;

2837 
	`sc¡_»s_lock
(
dev
, &
´_lksb
);

2838 ià(
	`sc¡_is_nÙ_»£rv©iÚ_hÞd”
(
dev
, 
cmd
->
£ss
)) {

2839 
	`sc¡_»s_uÆock
(
dev
, &
´_lksb
);

2840 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_RESERVATION_CONFLICT
);

2841 
out_dÚe
;

2843 
	`sc¡_»£rve_dev
(
dev
, 
cmd
->
£ss
);

2844 
	`sc¡_»s_uÆock
(
dev
, &
´_lksb
);

2846 
out
:

2847 
	`TRACE_EXIT_RES
(
»s
);

2848  
»s
;

2850 
out_com¶‘ed
:

2851 
cmd
->
com¶‘ed
 = 1;

2853 
out_dÚe
:

2855 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

2856 
»s
 = 
SCST_EXEC_COMPLETED
;

2857 
out
;

2858 
	}
}

2860 
	$sc¡_»Ëa£_loÿl
(
sc¡_cmd
 *
cmd
)

2862 
»s
 = 
SCST_EXEC_NOT_COMPLETED
;

2863 
sc¡_deviû
 *
dev
;

2864 
sc¡_lksb
 
´_lksb
;

2866 
	`TRACE_ENTRY
();

2868 
dev
 = 
cmd
->dev;

2875 ià(!
	`li¡_em±y
(&
dev
->
dev_»gi¡¿Ás_li¡
)) {

2876 ià(
	`sc¡_´_üh_ÿ£
(
cmd
))

2877 
out_com¶‘ed
;

2879 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
,

2880 
SAM_STAT_RESERVATION_CONFLICT
);

2881 
out_dÚe
;

2885 
	`sc¡_»s_lock
(
dev
, &
´_lksb
);

2892 ià(
	`sc¡_is_nÙ_»£rv©iÚ_hÞd”
(
dev
, 
cmd
->
£ss
)) {

2898 
»s
 = 
SCST_EXEC_COMPLETED
;

2899 
cmd
->
¡©us
 = 0;

2900 
cmd
->
msg_¡©us
 = 0;

2901 
cmd
->
ho¡_¡©us
 = 
DID_OK
;

2902 
cmd
->
driv”_¡©us
 = 0;

2903 
cmd
->
com¶‘ed
 = 1;

2905 
	`sc¡_þ—r_dev_»£rv©iÚ
(
dev
);

2908 
	`sc¡_»s_uÆock
(
dev
, &
´_lksb
);

2910 ià(
»s
 =ð
SCST_EXEC_COMPLETED
)

2911 
out_dÚe
;

2913 
out
:

2914 
	`TRACE_EXIT_RES
(
»s
);

2915  
»s
;

2917 
out_com¶‘ed
:

2918 
cmd
->
com¶‘ed
 = 1;

2920 
out_dÚe
:

2921 
»s
 = 
SCST_EXEC_COMPLETED
;

2923 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

2924 
out
;

2925 
	}
}

2928 
	$sc¡_³rsi¡’t_»£rve_š_loÿl
(
sc¡_cmd
 *
cmd
)

2930 
sc¡_deviû
 *
dev
;

2931 
sc¡_tgt_dev
 *
tgt_dev
;

2932 
sc¡_£ssiÚ
 *
£ssiÚ
;

2933 
aùiÚ
;

2934 
ušt8_t
 *
bufãr
;

2935 
bufãr_size
;

2937 
	`TRACE_ENTRY
();

2939 
	`EXTRACHECKS_BUG_ON
(
	`sc¡_cmd_©omic
(
cmd
));

2941 
dev
 = 
cmd
->dev;

2942 
tgt_dev
 = 
cmd
->tgt_dev;

2943 
£ssiÚ
 = 
cmd
->
£ss
;

2945 ià(
	`uÆik–y
(
dev
->
nÙ_´_suµÜtšg_tgt_devs_num
 != 0)) {

2946 
	`PRINT_WARNING
("Persistent Reservation command %s„efused for "

2948 "Œª¥Üt cÚÃùed", 
	`sc¡_g‘_Ýcode_Çme
(
cmd
),

2949 
dev
->
vœt_Çme
);

2950 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2951 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

2952 
out_dÚe
;

2955 ià(
	`sc¡_dev_»£rved
(
dev
)) {

2956 
	`TRACE_PR
("PR command„ejected, because device %s holds„egular "

2957 "»£rv©iÚ", 
dev
->
vœt_Çme
);

2958 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_RESERVATION_CONFLICT
);

2959 
out_dÚe
;

2962 ià(
dev
->
scsi_dev
 !ð
NULL
) {

2963 
	`PRINT_WARNING
("PR commands for…ass-through devices‚ot "

2964 "suµÜ‹d (deviû %s)", 
dev
->
vœt_Çme
);

2965 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2966 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

2967 
out_dÚe
;

2970 
bufãr_size
 = 
	`sc¡_g‘_buf_fuÎ_£n£
(
cmd
, &
bufãr
);

2971 ià(
	`uÆik–y
(
bufãr_size
 <= 0))

2972 
out_dÚe
;

2974 
	`sc¡_´_»ad_lock
(
dev
);

2977 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
))) {

2978 
	`TRACE_MGMT_DBG
("ABORTED s‘,‡bÜtšg cmd %p", 
cmd
);

2979 
out_uÆock
;

2982 
aùiÚ
 = 
cmd
->
cdb
[1] & 0x1f;

2984 
	`TRACE
(
TRACE_SCSI
, "PR IN‡ction %x for '%s' (LUN %llx) from '%s'",

2985 
aùiÚ
, 
dev
->
vœt_Çme
, 
tgt_dev
->
lun
, 
£ssiÚ
->
š™ŸtÜ_Çme
);

2987 
aùiÚ
) {

2988 
PR_READ_KEYS
:

2989 
	`sc¡_´_»ad_keys
(
cmd
, 
bufãr
, 
bufãr_size
);

2991 
PR_READ_RESERVATION
:

2992 
	`sc¡_´_»ad_»£rv©iÚ
(
cmd
, 
bufãr
, 
bufãr_size
);

2994 
PR_REPORT_CAPS
:

2995 
	`sc¡_´_»pÜt_ÿps
(
cmd
, 
bufãr
, 
bufãr_size
);

2997 
PR_READ_FULL_STATUS
:

2998 
	`sc¡_´_»ad_fuÎ_¡©us
(
cmd
, 
bufãr
, 
bufãr_size
);

3001 
	`PRINT_ERROR
("UnsuµÜ‹d‡ùiÚ %x", 
aùiÚ
);

3002 
out_unsup_aù
;

3005 
out_com¶‘e
:

3006 
cmd
->
com¶‘ed
 = 1;

3008 
out_uÆock
:

3009 
	`sc¡_´_»ad_uÆock
(
dev
);

3011 
	`sc¡_put_buf_fuÎ
(
cmd
, 
bufãr
);

3013 
out_dÚe
:

3014 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

3016 
	`TRACE_EXIT_RES
(
SCST_EXEC_COMPLETED
);

3017  
SCST_EXEC_COMPLETED
;

3019 
out_unsup_aù
:

3020 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 1,

3021 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 0);

3022 
out_com¶‘e
;

3023 
	}
}

3026 
	$sc¡_³rsi¡’t_»£rve_out_loÿl
(
sc¡_cmd
 *
cmd
)

3028 
»s
 = 
SCST_EXEC_COMPLETED
;

3029 
sc¡_deviû
 *
dev
;

3030 
sc¡_tgt_dev
 *
tgt_dev
;

3031 
sc¡_£ssiÚ
 *
£ssiÚ
;

3032 
aùiÚ
;

3033 
ušt8_t
 *
bufãr
;

3034 
bufãr_size
;

3035 
sc¡_lksb
 
´_lksb
;

3036 
boÞ
 
abÜ‹d
 = 
çl£
;

3038 
	`TRACE_ENTRY
();

3040 
	`EXTRACHECKS_BUG_ON
(
	`sc¡_cmd_©omic
(
cmd
));

3042 
dev
 = 
cmd
->dev;

3043 
tgt_dev
 = 
cmd
->tgt_dev;

3044 
£ssiÚ
 = 
cmd
->
£ss
;

3046 ià(
	`uÆik–y
(
dev
->
nÙ_´_suµÜtšg_tgt_devs_num
 != 0)) {

3047 
	`PRINT_WARNING
("Persistent Reservation command %s„efused for "

3049 "Œª¥Üt cÚÃùed", 
	`sc¡_g‘_Ýcode_Çme
(
cmd
),

3050 
dev
->
vœt_Çme
);

3051 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

3052 
out_dÚe
;

3055 
aùiÚ
 = 
cmd
->
cdb
[1] & 0x1f;

3057 
	`TRACE
(
TRACE_SCSI
, "PR OUT‡ction %x for '%s' (LUN %llx) from '%s'",

3058 
aùiÚ
, 
dev
->
vœt_Çme
, 
tgt_dev
->
lun
, 
£ssiÚ
->
š™ŸtÜ_Çme
);

3060 ià(
	`sc¡_dev_»£rved
(
dev
)) {

3061 
	`TRACE_PR
("PR command„ejected, because device %s holds„egular "

3062 "»£rv©iÚ", 
dev
->
vœt_Çme
);

3063 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_RESERVATION_CONFLICT
);

3064 
out_dÚe
;

3067 
bufãr_size
 = 
	`sc¡_g‘_buf_fuÎ_£n£
(
cmd
, &
bufãr
);

3068 ià(
	`uÆik–y
(
bufãr_size
 <= 0))

3069 
out_dÚe
;

3071 
dev
->
þ_Ýs
->
	`´_wr™e_lock
(dev, &
´_lksb
);

3080 ià((
aùiÚ
 !ð
PR_REGISTER
è&& (aùiÚ !ð
PR_REGISTER_AND_IGNORE
) &&

3081 (
tgt_dev
->
»gi¡¿Á
 =ð
NULL
)) {

3082 
	`TRACE_PR
("'%s'‚Ù„egi¡”ed", 
cmd
->
£ss
->
š™ŸtÜ_Çme
);

3083 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_RESERVATION_CONFLICT
);

3084 
out_uÆock
;

3088 ià((
aùiÚ
 !ð
PR_REGISTER
è&& (aùiÚ !ð
PR_REGISTER_AND_IGNORE
) &&

3089 (
aùiÚ
 !ð
PR_CLEAR
è&& (
cmd
->
cdb
[2] >> 4è!ð
SCOPE_LU
) {

3090 
	`TRACE_PR
("ScÝmu¡ bSCOPE_LU fÜ‡ùiÚ %x", 
aùiÚ
);

3091 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 2,

3092 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 4);

3093 
out_uÆock
;

3097 ià((
aùiÚ
 !ð
PR_REGISTER
è&& (aùiÚ !ð
PR_REGISTER_AND_MOVE
) &&

3098 ((
bufãr
[20] >> 3) & 0x01)) {

3099 
	`TRACE_PR
("SPEC_I_PT mu¡ bz”ØfÜ‡ùiÚ %x", 
aùiÚ
);

3100 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 20,

3101 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 3);

3102 
out_uÆock
;

3106 ià((
aùiÚ
 !ð
PR_REGISTER
è&& (aùiÚ !ð
PR_REGISTER_AND_IGNORE
) &&

3107 (
aùiÚ
 !ð
PR_REGISTER_AND_MOVE
è&& ((
bufãr
[20] >> 2) & 0x01)) {

3108 
	`TRACE_PR
("ALL_TG_PT mu¡ bz”ØfÜ‡ùiÚ %x", 
aùiÚ
);

3109 
	`sc¡_£t_šv®id_f›ld_š_·rm_li¡
(
cmd
, 20,

3110 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 2);

3111 
out_uÆock
;

3115 
abÜ‹d
 = 
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
);

3116 ià(
	`uÆik–y
(
abÜ‹d
)) {

3117 
	`TRACE_MGMT_DBG
("ABORTED s‘,‡bÜtšg cmd %p", 
cmd
);

3118 
out_uÆock
;

3121 
aùiÚ
) {

3122 
PR_REGISTER
:

3123 
	`sc¡_´_»gi¡”
(
cmd
, 
bufãr
, 
bufãr_size
);

3125 
PR_RESERVE
:

3126 
	`sc¡_´_»£rve
(
cmd
, 
bufãr
, 
bufãr_size
);

3128 
PR_RELEASE
:

3129 
	`sc¡_´_»Ëa£
(
cmd
, 
bufãr
, 
bufãr_size
);

3131 
PR_CLEAR
:

3132 
	`sc¡_´_þ—r
(
cmd
, 
bufãr
, 
bufãr_size
);

3134 
PR_PREEMPT
:

3135 
	`sc¡_´_´“m±
(
cmd
, 
bufãr
, 
bufãr_size
);

3137 
PR_PREEMPT_AND_ABORT
:

3138 
	`sc¡_´_´“m±_ªd_abÜt
(
cmd
, 
bufãr
, 
bufãr_size
);

3140 
PR_REGISTER_AND_IGNORE
:

3141 
	`sc¡_´_»gi¡”_ªd_ignÜe
(
cmd
, 
bufãr
, 
bufãr_size
);

3143 
PR_REGISTER_AND_MOVE
:

3144 
	`sc¡_´_»gi¡”_ªd_move
(
cmd
, 
bufãr
, 
bufãr_size
);

3147 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 1,

3148 
SCST_INVAL_FIELD_BIT_OFFS_VALID
 | 0);

3149 
out_uÆock
;

3152 #iâdeà
CONFIG_SCST_PROC


3153 ià(
cmd
->
¡©us
 =ð
SAM_STAT_GOOD
)

3154 
	`sc¡_´_sync_deviû_fže
(
tgt_dev
, 
cmd
);

3157 ià((
cmd
->
devt
->
´_cmds_nÙifiÿtiÚs
) &&

3158 (
cmd
->
¡©us
 =ð
SAM_STAT_GOOD
))

3159 
»s
 = 
SCST_EXEC_NOT_COMPLETED
;

3161 
out_uÆock
:

3162 
dev
->
þ_Ýs
->
	`´_wr™e_uÆock
(dev, &
´_lksb
);

3164 
	`sc¡_put_buf_fuÎ
(
cmd
, 
bufãr
);

3166 
out_dÚe
:

3167 ià(
»s
 =ð
SCST_EXEC_COMPLETED
) {

3168 ià(!
abÜ‹d
)

3169 
cmd
->
com¶‘ed
 = 1;

3170 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
,

3171 
SCST_CONTEXT_SAME
);

3174 
	`TRACE_EXIT_RES
(
»s
);

3175  
»s
;

3176 
	}
}

3189 
	$__sc¡_check_loÿl_ev’ts
(
sc¡_cmd
 *
cmd
, 
boÞ
 
´“m±_‹¡s_Úly
)

3191 
»s
, 
rc
;

3192 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

3193 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

3195 
	`TRACE_ENTRY
();

3197 ià(
	`uÆik–y
(
cmd
->
š‹º®
 && !cmd->
š‹º®_check_loÿl_ev’ts
)) {

3198 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
))) {

3199 
	`TRACE_MGMT_DBG
("ABORTED set,‡borting internal "

3200 "cmd %p", 
cmd
);

3201 
out_uncom¶‘e
;

3206 
»s
 = 0;

3207 
out
;

3210 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_TGT_DEV_FORWARDING
, &
cmd
->
tgt_dev
->
tgt_dev_æags
))) {

3215 
»s
 = 0;

3216 
out
;

3223 ià(
	`uÆik–y
(
dev
->
dev_doubË_ua_possibË
))

3224 
cmd
->
doubË_ua_possibË
 = 1;

3227 ià(
	`uÆik–y
(
	`sc¡_is_nÙ_»£rv©iÚ_hÞd”
(
dev
, 
tgt_dev
->
£ss
))) {

3228 ià((
cmd
->
Ý_æags
 & 
SCST_REG_RESERVE_ALLOWED
) == 0) {

3229 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
,

3230 
SAM_STAT_RESERVATION_CONFLICT
);

3231 
out_com¶‘e
;

3235 ià(!
´“m±_‹¡s_Úly
) {

3236 ià(
dev
->
þ_Ýs
->
	`´_is_£t
(dev)) {

3237 ià(
	`uÆik–y
(!
	`sc¡_´_is_cmd_®lowed
(
cmd
))) {

3238 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
,

3239 
SAM_STAT_RESERVATION_CONFLICT
);

3240 
out_com¶‘e
;

3249 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
))) {

3250 
	`TRACE_MGMT_DBG
("ABORTED s‘,‡bÜtšg cmd %p", 
cmd
);

3251 
out_uncom¶‘e
;

3255 ià((
dev
->
scsi_dev
 !ð
NULL
) &&

3256 
	`uÆik–y
(
dev
->
scsi_dev
->
was_»£t
)) {

3257 ià((
cmd
->
Ý_æags
 & 
SCST_SKIP_UA
) == 0) {

3258 
dÚe
 = 0;

3262 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

3263 ià(
dev
->
scsi_dev
->
was_»£t
) {

3264 
	`TRACE
(
TRACE_MGMT
, "was_reset is %d", 1);

3265 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

3266 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»£t_UA
));

3271 
dev
->
scsi_dev
->
was_»£t
 = 0;

3272 
dÚe
 = 1;

3274 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

3276 ià(
dÚe
)

3277 
out_com¶‘e
;

3281 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_TGT_DEV_UA_PENDING
,

3282 &
cmd
->
tgt_dev
->
tgt_dev_æags
))) {

3283 ià((
cmd
->
Ý_æags
 & 
SCST_SKIP_UA
) == 0) {

3284 
rc
 = 
	`sc¡_£t_³ndšg_UA
(
cmd
, 
NULL
, NULL);

3285 ià(
rc
 == 0)

3286 
out_com¶‘e
;

3290 
»s
 = 0;

3292 
out
:

3293 
	`TRACE_EXIT_RES
(
»s
);

3294  
»s
;

3296 
out_com¶‘e
:

3297 
»s
 = 1;

3298 
	`sBUG_ON
(!
cmd
->
com¶‘ed
);

3299 
out
;

3301 
out_uncom¶‘e
:

3302 
»s
 = -1;

3303 
out
;

3304 
	}
}

3305 
EXPORT_SYMBOL_GPL
(
__sc¡_check_loÿl_ev’ts
);

3317 
boÞ
 
	$sc¡_šc_ex³ùed_¢
(cÚ¡ 
sc¡_cmd
 *
cmd
)

3319 
boÞ
 
»s
 = 
çl£
;

3320 
sc¡_Üd”_d©a
 *
Üd”_d©a
 = 
cmd
->
cur_Üd”_d©a
;

3321 
©omic_t
 *
¦Ù
 = 
cmd
->
¢_¦Ù
;

3323 
	`TRACE_ENTRY
();

3325 
	`EXTRACHECKS_BUG_ON
(!
cmd
->
¢_£t
);

3327 #ifdeà
CONFIG_SCST_EXTRACHECKS


3328 
	`sBUG_ON
(
	`‹¡_b™
(
SCST_CMD_INC_EXPECTED_SN_PASSED
, &
cmd
->
cmd_æags
));

3329 
	`£t_b™
(
SCST_CMD_INC_EXPECTED_SN_PASSED
, &((
sc¡_cmd
 *)
cmd
)->
cmd_æags
);

3334 ià(
¦Ù
 =ð
NULL
)

3335 
Üd”ed
;

3337 
	`TRACE_SN
("SlÙ %zd, v®u%d", 
¦Ù
 - 
Üd”_d©a
->
¢_¦Ùs
,

3338 
	`©omic_»ad
(
¦Ù
));

3340 ià(!
	`©omic_dec_ªd_‹¡
(
¦Ù
))

3341 
out
;

3348 ià(
	`lik–y
(
Üd”_d©a
->
³ndšg_sim¶e_šc_ex³ùed_¢
 == 0))

3349 
out
;

3351 
	`¥š_lock_œq
(&
Üd”_d©a
->
¢_lock
);

3353 ià(
	`uÆik–y
(
Üd”_d©a
->
³ndšg_sim¶e_šc_ex³ùed_¢
 == 0))

3354 
out_uÆock
;

3356 
Üd”_d©a
->
³ndšg_sim¶e_šc_ex³ùed_¢
--;

3357 
	`TRACE_SN
("New dec…ending_simple_inc_expected_sn: %d",

3358 
Üd”_d©a
->
³ndšg_sim¶e_šc_ex³ùed_¢
);

3359 
	`EXTRACHECKS_BUG_ON
(
Üd”_d©a
->
³ndšg_sim¶e_šc_ex³ùed_¢
 < 0);

3361 
šc_ex³ùed_¢_locked
:

3362 
Üd”_d©a
->
ex³ùed_¢
++;

3370 
	`smp_mb
();

3371 
	`TRACE_SN
("Newƒx³ùed_¢: %d", 
Üd”_d©a
->
ex³ùed_¢
);

3372 
»s
 = 
Œue
;

3374 
out_uÆock
:

3375 
	`¥š_uÆock_œq
(&
Üd”_d©a
->
¢_lock
);

3377 
out
:

3378 
	`TRACE_EXIT_RES
(
»s
);

3379  
»s
;

3381 
Üd”ed
:

3383 
	`EXTRACHECKS_BUG_ON
((
cmd
->
queue_ty³
 !ð
SCST_CMD_QUEUE_SIMPLE
) &&

3384 (
cmd
->
queue_ty³
 !ð
SCST_CMD_QUEUE_ORDERED
));

3385 
	`¥š_lock_œq
(&
Üd”_d©a
->
¢_lock
);

3386 
šc_ex³ùed_¢_locked
;

3387 
	}
}

3390 
sc¡_cmd
 *
	$sc¡_po¡_exec_¢
(
sc¡_cmd
 *
cmd
,

3391 
boÞ
 
make_aùive
)

3394 
boÞ
 
šc_ex³ùed_¢
 = !
cmd
->
šc_ex³ùed_¢_Ú_dÚe
 &&

3395 
cmd
->
¢_£t
 && !cmd->
»Œy
;

3396 
sc¡_cmd
 *
»s
 = 
NULL
;

3398 
	`TRACE_ENTRY
();

3400 ià(
šc_ex³ùed_¢
) {

3401 
boÞ
 
rc
 = 
	`sc¡_šc_ex³ùed_¢
(
cmd
);

3403 ià(!
rc
)

3404 
out
;

3405 ià(
make_aùive
)

3406 
	`sc¡_make_deã¼ed_commªds_aùive
(
cmd
->
cur_Üd”_d©a
);

3408 
»s
 = 
	`sc¡_check_deã¼ed_commªds
(
cmd
->
cur_Üd”_d©a
, 
Œue
);

3411 
out
:

3412 
	`TRACE_EXIT_HRES
(
»s
);

3413  
»s
;

3414 
	}
}

3417 
	$sc¡_do_»®_exec
(
sc¡_cmd
 *
cmd
)

3419 
»s
 = 
SCST_EXEC_NOT_COMPLETED
;

3420 
rc
;

3421 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

3422 
sc¡_dev_ty³
 *
devt
 = 
cmd
->devt;

3423 
io_cÚ‹xt
 *
Þd_ùx
 = 
NULL
;

3424 
boÞ
 
ùx_chªged
 = 
çl£
;

3425 
scsi_deviû
 *
scsi_dev
;

3427 
	`TRACE_ENTRY
();

3429 
ùx_chªged
 = 
	`sc¡_£t_io_cÚ‹xt
(
cmd
, &
Þd_ùx
);

3431 
cmd
->
¡©e
 = 
SCST_CMD_STATE_EXEC_WAIT
;

3433 ià(
devt
->
exec
) {

3434 
	`TRACE_DBG
("Calling dev handler %sƒxec(%p)",

3435 
devt
->
Çme
, 
cmd
);

3436 
	`sc¡_£t_exec_¡¬t
(
cmd
);

3437 
»s
 = 
devt
->
	`exec
(
cmd
);

3438 
	`TRACE_DBG
("Dev handler %sƒxec()„eturned %d",

3439 
devt
->
Çme
, 
»s
);

3441 ià(
»s
 =ð
SCST_EXEC_COMPLETED
)

3442 
out_com¶‘e
;

3444 
	`sc¡_£t_exec_time
(
cmd
);

3446 
	`sBUG_ON
(
»s
 !ð
SCST_EXEC_NOT_COMPLETED
);

3449 
scsi_dev
 = 
dev
->scsi_dev;

3451 
	`TRACE_DBG
("S’dšg cmd %°tØSCSI mid-Ëv– dev %d:%d:%d:%Îd", 
cmd
,

3452 
scsi_dev
->
ho¡
->
ho¡_no
, scsi_dev->
chªÃl
, scsi_dev->
id
,

3453 (
u64
)
scsi_dev
->
lun
);

3455 ià(
	`uÆik–y
(
scsi_dev
 =ð
NULL
)) {

3456 
	`PRINT_ERROR
("Command for virtual device must be "

3458 ()
cmd
->
lun
);

3459 
out_”rÜ
;

3462 
	`sc¡_£t_exec_¡¬t
(
cmd
);

3464 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 30)

3465 
rc
 = 
	`sc¡_exec_»q
(
scsi_dev
, 
cmd
->
cdb
, cmd->
cdb_Ën
,

3466 
cmd
->
d©a_dœeùiÚ
, cmd->
sg
, cmd->
bufæ’
,

3467 
cmd
->
sg_út
, cmd->
timeout
, cmd->
»Œ›s
, cmd,

3468 
sc¡_·ss_through_cmd_dÚe
, 
cmd
->
cmd_gå_mask
);

3470 
rc
 = 
	`sc¡_scsi_exec_async
(
cmd
, cmd, 
sc¡_·ss_through_cmd_dÚe
);

3472 ià(
	`uÆik–y
(
rc
 != 0)) {

3473 
	`PRINT_ERROR
("sc¡…ass-throughƒxeøçžed: %d", 
rc
);

3475 ià(
rc
 =ð-
EINVAL
 &&

3476 (
cmd
->
bufæ’
 >> 9è> 
	`queue_max_hw_£ùÜs
(
scsi_dev
->
»que¡_queue
))

3477 
	`PRINT_ERROR
("Too†ow max_hw_sectors %d sectors on %s "

3480 
	`queue_max_hw_£ùÜs
(
scsi_dev
->
»que¡_queue
),

3481 
dev
->
vœt_Çme
, 
	`sc¡_g‘_Ýcode_Çme
(
cmd
),

3482 
cmd
->
bufæ’
);

3483 
out_”rÜ
;

3486 
out_com¶‘e
:

3487 
»s
 = 
SCST_EXEC_COMPLETED
;

3489 ià(
ùx_chªged
)

3490 
	`sc¡_»£t_io_cÚ‹xt
(
cmd
->
tgt_dev
, 
Þd_ùx
);

3492 
	`TRACE_EXIT_RES
(
»s
);

3493  
»s
;

3495 
out_”rÜ
:

3496 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

3498 
»s
 = 
SCST_EXEC_COMPLETED
;

3500 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

3501 
out_com¶‘e
;

3502 
	}
}

3504 
šlše
 
	$sc¡_»®_exec
(
sc¡_cmd
 *
cmd
)

3506 
»s
, 
rc
;

3508 
	`TRACE_ENTRY
();

3510 
	`BUILD_BUG_ON
(
SCST_CMD_STATE_RES_CONT_SAME
 !ð
SCST_EXEC_NOT_COMPLETED
);

3511 
	`BUILD_BUG_ON
(
SCST_CMD_STATE_RES_CONT_NEXT
 !ð
SCST_EXEC_COMPLETED
);

3513 
rc
 = 
	`sc¡_check_loÿl_ev’ts
(
cmd
);

3514 ià(
	`uÆik–y
(
rc
 != 0))

3515 
out_dÚe
;

3517 
	`__sc¡_cmd_g‘
(
cmd
);

3519 
»s
 = 
	`sc¡_do_»®_exec
(
cmd
);

3520 ià(
	`lik–y
(
»s
 =ð
SCST_EXEC_COMPLETED
)) {

3521 
	`sc¡_po¡_exec_¢
(
cmd
, 
Œue
);

3522 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 39)

3523 ià(
cmd
->
dev
->
scsi_dev
 !ð
NULL
)

3524 
	`g’”ic_uÅlug_deviû
(

3525 
cmd
->
dev
->
scsi_dev
->
»que¡_queue
);

3528 
	`sBUG
();

3530 
	`__sc¡_cmd_put
(
cmd
);

3534 
out
:

3535 
	`TRACE_EXIT_RES
(
»s
);

3536  
»s
;

3538 
out_dÚe
:

3539 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

3540 
»s
 = 
SCST_CMD_STATE_RES_CONT_NEXT
;

3541 
out
;

3542 
	}
}

3544 (*
	tsc¡_loÿl_exec_â
)(
	tsc¡_cmd
 *
	tcmd
);

3546 
sc¡_loÿl_exec_â
 
sc¡_loÿl_âs
[256] = {

3547 [
RESERVE
] = 
sc¡_»£rve_loÿl
,

3548 [
RESERVE_10
] = 
sc¡_»£rve_loÿl
,

3549 [
RELEASE
] = 
sc¡_»Ëa£_loÿl
,

3550 [
RELEASE_10
] = 
sc¡_»Ëa£_loÿl
,

3551 [
PERSISTENT_RESERVE_IN
] = 
sc¡_³rsi¡’t_»£rve_š_loÿl
,

3552 [
PERSISTENT_RESERVE_OUT
] = 
sc¡_³rsi¡’t_»£rve_out_loÿl
,

3553 [
REPORT_LUNS
] = 
sc¡_»pÜt_luns_loÿl
,

3554 [
REQUEST_SENSE
] = 
sc¡_»que¡_£n£_loÿl
,

3555 [
COMPARE_AND_WRITE
] = 
sc¡_cmp_wr_loÿl
,

3556 [
EXTENDED_COPY
] = 
sc¡_cm_ext_cÝy_exec
,

3557 [
RECEIVE_COPY_RESULTS
] = 
sc¡_cm_rcv_cÝy_»s_exec
,

3558 [
MAINTENANCE_IN
] = 
sc¡_maš‹Çnû_š
,

3559 
	}
};

3561 
	$sc¡_do_loÿl_exec
(
sc¡_cmd
 *
cmd
)

3563 
»s
;

3564 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

3566 
	`TRACE_ENTRY
();

3569 ià((
cmd
->
Ý_æags
 & 
SCST_WRITE_MEDIUM
) &&

3570 (
tgt_dev
->
tgt_dev_rd_Úly
 || 
cmd
->
dev
->
swp
)) {

3571 
	`PRINT_WARNING
("Attempt of write‡ccesso„ead-only device: "

3573 
cmd
->
£ss
->
š™ŸtÜ_Çme
, cmd->
lun
,

3574 
	`sc¡_g‘_Ýcode_Çme
(
cmd
));

3575 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

3576 
	`SCST_LOAD_SENSE
(
sc¡_£n£_d©a_´Ùeù
));

3577 
out_dÚe
;

3580 ià((
cmd
->
Ý_æags
 & 
SCST_LOCAL_CMD
) == 0) {

3581 
»s
 = 
SCST_EXEC_NOT_COMPLETED
;

3582 
out
;

3585 
»s
 = 
sc¡_loÿl_âs
[
cmd
->
cdb
[0]](cmd);

3587 
out
:

3588 
	`TRACE_EXIT_RES
(
»s
);

3589  
»s
;

3591 
out_dÚe
:

3593 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

3594 
»s
 = 
SCST_EXEC_COMPLETED
;

3595 
out
;

3596 
	}
}

3598 
	$sc¡_loÿl_exec
(
sc¡_cmd
 *
cmd
)

3600 
»s
, 
rc
;

3602 
	`TRACE_ENTRY
();

3604 
	`BUILD_BUG_ON
(
SCST_CMD_STATE_RES_CONT_SAME
 !ð
SCST_EXEC_NOT_COMPLETED
);

3605 
	`BUILD_BUG_ON
(
SCST_CMD_STATE_RES_CONT_NEXT
 !ð
SCST_EXEC_COMPLETED
);

3607 
rc
 = 
	`sc¡_check_loÿl_ev’ts
(
cmd
);

3608 ià(
	`uÆik–y
(
rc
 != 0))

3609 
out_dÚe
;

3611 
	`__sc¡_cmd_g‘
(
cmd
);

3613 
»s
 = 
	`sc¡_do_loÿl_exec
(
cmd
);

3614 ià(
	`lik–y
(
»s
 =ð
SCST_EXEC_NOT_COMPLETED
))

3615 
cmd
->
¡©e
 = 
SCST_CMD_STATE_REAL_EXEC
;

3616 ià(
»s
 =ð
SCST_EXEC_COMPLETED
)

3617 
	`sc¡_po¡_exec_¢
(
cmd
, 
Œue
);

3619 
	`sBUG
();

3621 
	`__sc¡_cmd_put
(
cmd
);

3625 
out
:

3626 
	`TRACE_EXIT_RES
(
»s
);

3627  
»s
;

3629 
out_dÚe
:

3630 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

3631 
»s
 = 
SCST_CMD_STATE_RES_CONT_NEXT
;

3632 
out
;

3633 
	}
}

3635 
	$sc¡_´e_exec_checks
(
sc¡_cmd
 *
cmd
)

3637 
»s
, 
rc
;

3639 
	`TRACE_ENTRY
();

3641 
	`EXTRACHECKS_BUG_ON
(
cmd
->
lba
 =ð
SCST_DEF_LBA_DATA_LEN
);

3642 
	`EXTRACHECKS_BUG_ON
(
cmd
->
d©a_Ën
 =ð
SCST_DEF_LBA_DATA_LEN
);

3644 
rc
 = 
	`__sc¡_check_loÿl_ev’ts
(
cmd
, 
çl£
);

3645 ià(
	`uÆik–y
(
rc
 != 0))

3646 
out_dÚe
;

3648 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
;

3650 
out
:

3651 
	`TRACE_EXIT_RES
(
»s
);

3652  
»s
;

3654 
out_dÚe
:

3655 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

3656 
»s
 = 
SCST_CMD_STATE_RES_CONT_NEXT
;

3657 
out
;

3658 
	}
}

3660 
šlše
 
boÞ
 
	$sc¡_check_®ua
(
sc¡_cmd
 *
cmd
, *
out_»s
)

3662 (*
®ua_fž‹r
)(
sc¡_cmd
 *
cmd
);

3663 
boÞ
 
»s
 = 
çl£
;

3665 
®ua_fž‹r
 = 
	`ACCESS_ONCE
(
cmd
->
tgt_dev
->alua_filter);

3666 ià(
	`uÆik–y
(
®ua_fž‹r
)) {

3667 
ac
 = 
	`®ua_fž‹r
(
cmd
);

3669 ià(
ac
 !ð
SCST_ALUA_CHECK_OK
) {

3670 ià(
ac
 !ð
SCST_ALUA_CHECK_DELAYED
) {

3671 
	`EXTRACHECKS_BUG_ON
(
cmd
->
¡©us
 == 0);

3672 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

3673 *
out_»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
;

3675 
»s
 = 
Œue
;

3679  
»s
;

3680 
	}
}

3682 
	$sc¡_exec_check_blockšg
(
sc¡_cmd
 **
aùive_cmd
)

3684 
sc¡_cmd
 *
cmd
 = *
aùive_cmd
;

3685 
sc¡_cmd
 *
»f_cmd
;

3686 
»s
 = 
SCST_CMD_STATE_RES_CONT_NEXT
;

3688 
	`TRACE_ENTRY
();

3690 
cmd
->
¡©e
 = 
SCST_CMD_STATE_EXEC_CHECK_BLOCKING
;

3692 ià(
	`uÆik–y
(
	`sc¡_check_®ua
(
cmd
, &
»s
)))

3693 
out
;

3695 ià(
	`uÆik–y
(
	`sc¡_check_blocked_dev
(
cmd
)))

3696 
out
;

3699 
»f_cmd
 = 
cmd
;

3700 
	`__sc¡_cmd_g‘
(
»f_cmd
);

3703 
rc
;

3705 #ifdeà
CONFIG_SCST_DEBUG_SN


3706 ià((
	`sc¡_¿ndom
() % 120) == 7) {

3707 
t
 = 
	`sc¡_¿ndom
() % 200;

3709 
	`TRACE_SN
("D–ayšg IO oÀ%d ms", 
t
);

3710 
	`m¦“p
(
t
);

3717 
cmd
->
£Á_fÜ_exec
 = 1;

3724 
	`smp_mb
();

3726 
cmd
->
sc¡_cmd_dÚe
 = 
sc¡_cmd_dÚe_loÿl
;

3728 
rc
 = 
	`sc¡_´e_exec_checks
(
cmd
);

3729 ià(
	`uÆik–y
(
rc
 !ð
SCST_CMD_STATE_RES_CONT_SAME
)) {

3730 
	`EXTRACHECKS_BUG_ON
(
rc
 !ð
SCST_CMD_STATE_RES_CONT_NEXT
);

3731 
	`EXTRACHECKS_BUG_ON
(
cmd
->
¡©e
 =ð
SCST_CMD_STATE_EXEC_CHECK_BLOCKING
);

3732 
dÚe
;

3735 
cmd
->
¡©e
 = 
SCST_CMD_STATE_LOCAL_EXEC
;

3737 
rc
 = 
	`sc¡_do_loÿl_exec
(
cmd
);

3738 ià(
	`lik–y
(
rc
 =ð
SCST_EXEC_NOT_COMPLETED
)) {

3741 
	`sBUG_ON
(
rc
 !ð
SCST_EXEC_COMPLETED
);

3742 
dÚe
;

3745 
cmd
->
¡©e
 = 
SCST_CMD_STATE_REAL_EXEC
;

3747 
rc
 = 
	`sc¡_do_»®_exec
(
cmd
);

3748 
	`sBUG_ON
(
rc
 !ð
SCST_EXEC_COMPLETED
);

3750 
dÚe
:

3751 
cmd
 = 
	`sc¡_po¡_exec_¢
(cmd, 
çl£
);

3752 ià(
cmd
 =ð
NULL
)

3755 
	`EXTRACHECKS_BUG_ON
(
cmd
->
¡©e
 !ð
SCST_CMD_STATE_EXEC_CHECK_SN
);

3757 
cmd
->
¡©e
 = 
SCST_CMD_STATE_EXEC_CHECK_BLOCKING
;

3759 ià(
	`uÆik–y
(
	`sc¡_check_®ua
(
cmd
, &
»s
)))

3760 
out
;

3762 ià(
	`uÆik–y
(
	`sc¡_check_blocked_dev
(
cmd
)))

3765 
	`__sc¡_cmd_put
(
»f_cmd
);

3766 
»f_cmd
 = 
cmd
;

3767 
	`__sc¡_cmd_g‘
(
»f_cmd
);

3770 *
aùive_cmd
 = 
cmd
;

3772 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 39)

3773 ià(
»f_cmd
->
dev
->
scsi_dev
 !ð
NULL
)

3774 
	`g’”ic_uÅlug_deviû
(
»f_cmd
->
dev
->
scsi_dev
->
»que¡_queue
);

3777 
	`__sc¡_cmd_put
(
»f_cmd
);

3780 
out
:

3781 
	`TRACE_EXIT_RES
(
»s
);

3782  
»s
;

3783 
	}
}

3785 
	$sc¡_exec_check_¢
(
sc¡_cmd
 **
aùive_cmd
)

3787 
»s
;

3788 
sc¡_cmd
 *
cmd
 = *
aùive_cmd
;

3789 
sc¡_Üd”_d©a
 *
Üd”_d©a
 = 
cmd
->
cur_Üd”_d©a
;

3790 
	`ty³of
(
Üd”_d©a
->
ex³ùed_¢
)ƒxpected_sn;

3792 
	`TRACE_ENTRY
();

3794 ià(
	`uÆik–y
(
cmd
->
š‹º®
))

3795 
exec
;

3797 ià(
	`uÆik–y
(
cmd
->
queue_ty³
 =ð
SCST_CMD_QUEUE_HEAD_OF_QUEUE
))

3798 
exec
;

3800 
	`EXTRACHECKS_BUG_ON
(!
cmd
->
¢_£t
);

3802 
ex³ùed_¢
 = 
	`ACCESS_ONCE
(
Üd”_d©a
->expected_sn);

3804 ià((
cmd
->
¢
 !ð
ex³ùed_¢
è|| (
Üd”_d©a
->
hq_cmd_couÁ
 > 0)) {

3805 
	`¥š_lock_œq
(&
Üd”_d©a
->
¢_lock
);

3807 
Üd”_d©a
->
def_cmd_couÁ
++;

3819 
	`smp_mb
();

3821 
ex³ùed_¢
 = 
Üd”_d©a
->expected_sn;

3822 ià((
cmd
->
¢
 !ð
ex³ùed_¢
è|| (
Üd”_d©a
->
hq_cmd_couÁ
 > 0)) {

3823 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_CMD_ABORTED
,

3824 &
cmd
->
cmd_æags
))) {

3826 
	`TRACE_MGMT_DBG
("Aborting out of sn cmd %p "

3827 "Ñag %Îu, sÀ%u)", 
cmd
,

3828 ()
cmd
->
g
, cmd->
¢
);

3829 
Üd”_d©a
->
def_cmd_couÁ
--;

3830 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

3831 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
;

3833 
	`TRACE_SN
("Deferring cmd %p (sn=%d, set %d, "

3834 "ex³ùed_¢=%d)", 
cmd
, cmd->
¢
,

3835 
cmd
->
¢_£t
, 
ex³ùed_¢
);

3836 
	`li¡_add_ž
(&
cmd
->
deã¼ed_cmd_li¡_’Œy
,

3837 &
Üd”_d©a
->
deã¼ed_cmd_li¡
);

3838 
»s
 = 
SCST_CMD_STATE_RES_CONT_NEXT
;

3840 
	`¥š_uÆock_œq
(&
Üd”_d©a
->
¢_lock
);

3841 
out
;

3843 
	`TRACE_SN
("Somebody incrementedƒxpected_sn %d, "

3844 "cÚtšušg", 
ex³ùed_¢
);

3845 
Üd”_d©a
->
def_cmd_couÁ
--;

3846 
	`¥š_uÆock_œq
(&
Üd”_d©a
->
¢_lock
);

3850 
exec
:

3851 
»s
 = 
	`sc¡_exec_check_blockšg
(
aùive_cmd
);

3853 
out
:

3854 
	`TRACE_EXIT_HRES
(
»s
);

3855  
»s
;

3856 
	}
}

3859 
	$sc¡_check_£n£
(
sc¡_cmd
 *
cmd
)

3861 
»s
 = 0;

3862 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

3864 
	`TRACE_ENTRY
();

3866 ià(
	`uÆik–y
(
cmd
->
ua_ignÜe
)) {

3867 
	`PRINT_BUFF_FLAG
(
TRACE_SCSI
, "LoÿÈUA s’£", 
cmd
->
£n£
,

3868 
cmd
->
£n£_v®id_Ën
);

3869 
out
;

3873 ià((
dev
->
scsi_dev
 !ð
NULL
) &&

3874 
	`uÆik–y
(
cmd
->
ho¡_¡©us
 =ð
DID_RESET
)) {

3875 ià((
cmd
->
Ý_æags
 & 
SCST_SKIP_UA
) == 0) {

3876 
	`TRACE
(
TRACE_MGMT
, "DID_RESET: was_reset=%d host_status=%x",

3877 
dev
->
scsi_dev
->
was_»£t
, 
cmd
->
ho¡_¡©us
);

3878 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»£t_UA
));

3880 
¦
;

3881 
ušt8_t
 
£n£
[
SCST_STANDARD_SENSE_LEN
];

3883 
	`TRACE
(
TRACE_MGMT
, "DID_RESET„eceived for device %s, "

3884 "Œigg”šg„e£ˆUA", 
dev
->
vœt_Çme
);

3885 
¦
 = 
	`sc¡_£t_£n£
(
£n£
, (£n£), 
dev
->
d_£n£
,

3886 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»£t_UA
));

3887 
	`sc¡_dev_check_£t_UA
(
dev
, 
NULL
, 
£n£
, 
¦
);

3888 
	`sc¡_abÜt_cmd
(
cmd
, 
NULL
, 
çl£
, false);

3891 
dev
->
scsi_dev
->
was_»£t
 = 0;

3894 ià(
	`uÆik–y
(
cmd
->
¡©us
 =ð
SAM_STAT_CHECK_CONDITION
) &&

3895 
	`sc¡_£n£_v®id
(
cmd
->
£n£
)) {

3896 
	`TRACE
(
TRACE_SCSI
, "cmd %°w™h v®id s’£„eûived", 
cmd
);

3897 
	`PRINT_BUFF_FLAG
(
TRACE_SCSI
, "S’£", 
cmd
->
£n£
,

3898 
cmd
->
£n£_v®id_Ën
);

3901 ià(
	`sc¡_is_ua_£n£
(
cmd
->
£n£
, cmd->
£n£_v®id_Ën
)) {

3902 ià(
	`sc¡_ª®yze_£n£
(
cmd
->
£n£
, cmd->
£n£_v®id_Ën
,

3903 
SCST_SENSE_ASC_VALID
,

3904 0, 
SCST_SENSE_ASC_UA_RESET
, 0)) {

3905 ià(
cmd
->
doubË_ua_possibË
) {

3906 
	`TRACE_DBG
("Double UA "

3907 "d‘eùed fÜ deviû %p", 
dev
);

3908 
	`TRACE_DBG
("Retrying cmd"

3909 " %°Ñag %Îu)", 
cmd
,

3910 ()
cmd
->
g
);

3912 
cmd
->
¡©us
 = 0;

3913 
cmd
->
msg_¡©us
 = 0;

3914 
cmd
->
ho¡_¡©us
 = 
DID_OK
;

3915 
cmd
->
driv”_¡©us
 = 0;

3916 
cmd
->
com¶‘ed
 = 0;

3918 
	`mempoÞ_ä“
(
cmd
->
£n£
,

3919 
sc¡_£n£_mempoÞ
);

3920 
cmd
->
£n£
 = 
NULL
;

3922 
	`sc¡_check_»¡Üe_sg_buff
(
cmd
);

3923 ià(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
)

3924 
	`sc¡_£t_wr™e_Ën
(
cmd
);

3926 
	`sBUG_ON
(
cmd
->
dbl_ua_Üig_»¥_d©a_Ën
 < 0);

3927 
cmd
->
d©a_dœeùiÚ
 =

3928 
cmd
->
dbl_ua_Üig_d©a_dœeùiÚ
;

3929 
cmd
->
»¥_d©a_Ën
 =

3930 
cmd
->
dbl_ua_Üig_»¥_d©a_Ën
;

3932 
cmd
->
¡©e
 = 
SCST_CMD_STATE_LOCAL_EXEC
;

3933 
cmd
->
»Œy
 = 1;

3934 
»s
 = 1;

3935 
out
;

3938 
	`sc¡_dev_check_£t_UA
(
dev
, 
cmd
, cmd->
£n£
,

3939 
cmd
->
£n£_v®id_Ën
);

3943 ià(
	`uÆik–y
(
cmd
->
doubË_ua_possibË
)) {

3944 ià((
cmd
->
Ý_æags
 & 
SCST_SKIP_UA
) == 0) {

3945 
	`TRACE_DBG
("Clearing dbl_ua_possible flag (dev %p, "

3946 "cmd %p)", 
dev
, 
cmd
);

3953 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

3954 
dev
->
dev_doubË_ua_possibË
 = 0;

3955 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

3959 
out
:

3960 
	`TRACE_EXIT_RES
(
»s
);

3961  
»s
;

3962 
	}
}

3964 
boÞ
 
	$sc¡_check_auto_£n£
(
sc¡_cmd
 *
cmd
)

3966 
boÞ
 
»s
 = 
çl£
;

3968 
	`TRACE_ENTRY
();

3970 ià(
	`uÆik–y
(
cmd
->
¡©us
 =ð
SAM_STAT_CHECK_CONDITION
) &&

3971 !
	`sc¡_£n£_v®id
(
cmd
->
£n£
)) {

3972 ià(!
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
)) {

3973 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR_AND_MGMT_DBG
,

3977 
cmd
->
¡©us
, cmd->
msg_¡©us
, cmd->
ho¡_¡©us
,

3978 
cmd
->
driv”_¡©us
, cmd);

3980 
»s
 = 
Œue
;

3981 } ià(
	`uÆik–y
(
cmd
->
ho¡_¡©us
)) {

3982 ià((
cmd
->
ho¡_¡©us
 =ð
DID_REQUEUE
) ||

3983 (
cmd
->
ho¡_¡©us
 =ð
DID_IMM_RETRY
) ||

3984 (
cmd
->
ho¡_¡©us
 =ð
DID_SOFT_ERROR
) ||

3985 (
cmd
->
ho¡_¡©us
 =ð
DID_BUS_BUSY
) ||

3986 (
cmd
->
ho¡_¡©us
 =ð
DID_TRANSPORT_DISRUPTED
) ||

3987 (
cmd
->
ho¡_¡©us
 =ð
DID_TRANSPORT_FAILFAST
) ||

3988 (
cmd
->
ho¡_¡©us
 =ð
DID_ALLOC_FAILURE
)) {

3989 
	`sc¡_£t_busy
(
cmd
);

3990 } ià(
cmd
->
ho¡_¡©us
 =ð
DID_RESET
) {

3992 } ià((
cmd
->
ho¡_¡©us
 =ð
DID_ABORT
) ||

3993 (
cmd
->
ho¡_¡©us
 =ð
DID_NO_CONNECT
) ||

3994 (
cmd
->
ho¡_¡©us
 =ð
DID_TIME_OUT
) ||

3995 (
cmd
->
ho¡_¡©us
 =ð
DID_NEXUS_FAILURE
)) {

3996 
	`sc¡_abÜt_cmd
(
cmd
, 
NULL
, 
çl£
, false);

3997 } ià(
cmd
->
ho¡_¡©us
 =ð
DID_MEDIUM_ERROR
) {

3998 ià(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
)

3999 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_wr™e_”rÜ
));

4001 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»ad_”rÜ
));

4002 } ià((
cmd
->
ho¡_¡©us
 =ð
DID_TARGET_FAILURE
è&& (cmd->
¡©us
 != 0)) {

4005 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR_AND_MGMT_DBG
, "Host "

4008 "%s)", 
cmd
->
ho¡_¡©us
, cmd, 
	`sc¡_g‘_Ýcode_Çme
(cmd),

4009 
cmd
->
tgt
->
tgt_Çme
, cmd->
dev
->
vœt_Çme
);

4010 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

4011 
	`SCST_LOAD_SENSE
(
sc¡_£n£_š‹º®_çžu»
));

4015 
	`TRACE_EXIT_RES
(
»s
);

4016  
»s
;

4017 
	}
}

4019 
	$sc¡_´e_dev_dÚe
(
sc¡_cmd
 *
cmd
)

4021 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
, 
rc
;

4023 
	`TRACE_ENTRY
();

4025 
agaš
:

4026 
rc
 = 
	`sc¡_check_auto_£n£
(
cmd
);

4027 ià(
	`uÆik–y
(
rc
)) {

4028 ià(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
))

4029 
Ãxt
;

4030 
	`PRINT_INFO
("Command finished with CHECK CONDITION, but "

4032 "REQUEST SENSE", 
	`sc¡_g‘_Ýcode_Çme
(
cmd
));

4033 
rc
 = 
	`sc¡_´•¬e_»que¡_£n£
(
cmd
);

4034 ià(
rc
 == 0)

4035 
»s
 = 
SCST_CMD_STATE_RES_CONT_NEXT
;

4037 
	`PRINT_ERROR
("%s", "Unableo issue REQUEST SENSE, "

4039 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

4040 
	`SCST_LOAD_SENSE
(
sc¡_£n£_š‹º®_çžu»
));

4042 
out
;

4045 
Ãxt
:

4046 
rc
 = 
	`sc¡_check_£n£
(
cmd
);

4047 ià(
	`uÆik–y
(
rc
)) {

4052 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

4053 
out
;

4056 ià(
	`lik–y
(
	`sc¡_cmd_com¶‘ed_good
(
cmd
))) {

4057 ià(
cmd
->
deã¼ed_dif_»ad_check
) {

4058 
rc
 = 
	`sc¡_dif_´oûss_»ad
(
cmd
);

4060 ià(
	`uÆik–y
(
rc
 != 0)) {

4061 
cmd
->
deã¼ed_dif_»ad_check
 = 0;

4062 
agaš
;

4066 ià(
	`uÆik–y
((
cmd
->
cdb
[0] =ð
MODE_SENSE
 ||

4067 
cmd
->
cdb
[0] =ð
MODE_SENSE_10
)) &&

4068 (
cmd
->
tgt_dev
->
tgt_dev_rd_Úly
 || cmd->
dev
->
swp
) &&

4069 (
cmd
->
dev
->
ty³
 =ð
TYPE_DISK
 ||

4070 
cmd
->
dev
->
ty³
 =ð
TYPE_WORM
 ||

4071 
cmd
->
dev
->
ty³
 =ð
TYPE_MOD
 ||

4072 
cmd
->
dev
->
ty³
 =ð
TYPE_TAPE
)) {

4073 
št32_t
 
Ëngth
;

4074 
ušt8_t
 *
add»ss
;

4075 
boÞ
 
”r
 = 
çl£
;

4077 
Ëngth
 = 
	`sc¡_g‘_buf_fuÎ
(
cmd
, &
add»ss
);

4078 ià(
Ëngth
 < 0) {

4079 
	`PRINT_ERROR
("%s", "Unableo get "

4081 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

4082 
	`SCST_LOAD_SENSE
(

4083 
sc¡_£n£_š‹º®_çžu»
));

4084 
”r
 = 
Œue
;

4085 } ià(
Ëngth
 > 2 && 
cmd
->
cdb
[0] =ð
MODE_SENSE
)

4086 
add»ss
[2] |= 0x80;

4087 ià(
Ëngth
 > 3 && 
cmd
->
cdb
[0] =ð
MODE_SENSE_10
)

4088 
add»ss
[3] |= 0x80;

4090 ià(
”r
)

4091 
out
;

4093 
	`sc¡_put_buf_fuÎ
(
cmd
, 
add»ss
);

4100 ià(
	`uÆik–y
((
cmd
->
cdb
[0] =ð
INQUIRY
)) &&

4102 !(
cmd
->
cdb
[1] & 
SCST_INQ_EVPD
) &&

4103 (
cmd
->
»¥_d©a_Ën
 > 
SCST_INQ_BYTE3
)) {

4104 
ušt8_t
 *
bufãr
;

4105 
buæ’
;

4106 
boÞ
 
”r
 = 
çl£
;

4108 
buæ’
 = 
	`sc¡_g‘_buf_fuÎ
(
cmd
, &
bufãr
);

4109 ià(
buæ’
 > 
SCST_INQ_BYTE3
 && !
cmd
->
tg‰
->
çke_aÿ
) {

4110 #ifdeà
CONFIG_SCST_EXTRACHECKS


4111 ià(
bufãr
[
SCST_INQ_BYTE3
] & 
SCST_INQ_NORMACA_BIT
) {

4112 
	`PRINT_INFO
("NormACA set for device: "

4115 ()
cmd
->
lun
,

4116 
bufãr
[0]);

4119 
bufãr
[
SCST_INQ_BYTE3
] &ð~
SCST_INQ_NORMACA_BIT
;

4120 } ià(
buæ’
 <ð
SCST_INQ_BYTE3
 && buflen != 0) {

4121 
	`PRINT_ERROR
("%s", "Unableo get INQUIRY "

4123 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

4124 
	`SCST_LOAD_SENSE
(
sc¡_£n£_š‹º®_çžu»
));

4125 
”r
 = 
Œue
;

4127 ià(
buæ’
 > 0)

4128 
	`sc¡_put_buf_fuÎ
(
cmd
, 
bufãr
);

4130 ià(
”r
)

4131 
out
;

4134 ià(
	`uÆik–y
((
cmd
->
cdb
[0] =ð
MODE_SELECT
) ||

4135 (
cmd
->
cdb
[0] =ð
MODE_SELECT_10
) ||

4136 (
cmd
->
cdb
[0] =ð
LOG_SELECT
))) {

4137 
	`TRACE
(
TRACE_SCSI
, "MODE/LOG SELECT succeeded (LUN %lld)",

4138 ()
cmd
->
lun
);

4139 
cmd
->
¡©e
 = 
SCST_CMD_STATE_MODE_SELECT_CHECKS
;

4140 
out
;

4144 ià((
cmd
->
dev
->
scsi_dev
 !ð
NULL
) &&

4145 (
cmd
->
¡©us
 =ð
SAM_STAT_CHECK_CONDITION
) &&

4146 
	`sc¡_is_ua_£n£
(
cmd
->
£n£
, cmd->
£n£_v®id_Ën
) &&

4147 
	`sc¡_ª®yze_£n£
(
cmd
->
£n£
, cmd->
£n£_v®id_Ën
,

4148 
SCST_SENSE_ASCx_VALID
,

4150 
	`TRACE
(
TRACE_SCSI
, "MODE PARAMETERS CHANGED UA (lun "

4151 "%Îd)", ()
cmd
->
lun
);

4152 
cmd
->
¡©e
 = 
SCST_CMD_STATE_MODE_SELECT_CHECKS
;

4153 
out
;

4157 
cmd
->
¡©e
 = 
SCST_CMD_STATE_DEV_DONE
;

4159 
out
:

4160 
	`TRACE_EXIT_RES
(
»s
);

4161  
»s
;

4162 
	}
}

4164 
	$sc¡_mode_£Ëù_checks
(
sc¡_cmd
 *
cmd
)

4166 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
;

4168 
	`TRACE_ENTRY
();

4170 ià(
	`lik–y
(
	`scsi_¡©us_is_good
(
cmd
->
¡©us
))) {

4171 
©omic
 = 
	`sc¡_cmd_©omic
(
cmd
);

4173 ià(
	`uÆik–y
((
cmd
->
cdb
[0] =ð
MODE_SELECT
) ||

4174 (
cmd
->
cdb
[0] =ð
MODE_SELECT_10
) ||

4175 (
cmd
->
cdb
[0] =ð
LOG_SELECT
))) {

4176 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

4177 
¦
;

4178 
ušt8_t
 
£n£_bufãr
[
SCST_STANDARD_SENSE_LEN
];

4180 ià(
©omic
 && (
dev
->
scsi_dev
 !ð
NULL
)) {

4181 
	`TRACE_DBG
("%s", "MODE/LOG SELECT:hread "

4183 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

4184 
out
;

4187 
	`TRACE
(
TRACE_SCSI
, "MODE/LOG SELECT succeeded, "

4189 ()
cmd
->
lun
);

4191 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

4192 ià(
cmd
->
cdb
[0] =ð
LOG_SELECT
) {

4193 
¦
 = 
	`sc¡_£t_£n£
(
£n£_bufãr
,

4194 (
£n£_bufãr
),

4195 
dev
->
d_£n£
,

4196 
UNIT_ATTENTION
, 0x2a, 0x02);

4198 
¦
 = 
	`sc¡_£t_£n£
(
£n£_bufãr
,

4199 (
£n£_bufãr
),

4200 
dev
->
d_£n£
,

4201 
UNIT_ATTENTION
, 0x2a, 0x01);

4203 
	`sc¡_dev_check_£t_loÿl_UA
(
dev
, 
cmd
, 
£n£_bufãr
, 
¦
);

4204 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

4206 ià(
dev
->
scsi_dev
 !ð
NULL
)

4207 
	`sc¡_obš_deviû_·¿m‘”s
(
dev
, 
cmd
->
cdb
);

4209 } ià((
cmd
->
¡©us
 =ð
SAM_STAT_CHECK_CONDITION
) &&

4210 
	`sc¡_is_ua_£n£
(
cmd
->
£n£
, cmd->
£n£_v®id_Ën
) &&

4212 (
	`sc¡_ª®yze_£n£
(
cmd
->
£n£
, cmd->
£n£_v®id_Ën
,

4213 
SCST_SENSE_ASCx_VALID
,

4215 
	`sc¡_ª®yze_£n£
(
cmd
->
£n£
, cmd->
£n£_v®id_Ën
,

4216 
SCST_SENSE_ASC_VALID
,

4218 
	`sc¡_ª®yze_£n£
(
cmd
->
£n£
, cmd->
£n£_v®id_Ën
,

4219 
SCST_SENSE_ASC_VALID
,

4222 
	`sc¡_ª®yze_£n£
(
cmd
->
£n£
, cmd->
£n£_v®id_Ën
,

4223 
SCST_SENSE_ASC_VALID
,

4225 
©omic
 = 
	`sc¡_cmd_©omic
(
cmd
);

4227 ià(
©omic
) {

4228 
	`TRACE_DBG
("Possible…arameters changed UA %x: "

4229 "th»ad cÚ‹xˆ»quœed", 
cmd
->
£n£
[12]);

4230 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

4231 
out
;

4234 
	`TRACE
(
TRACE_SCSI
, "Possible…arameters changed UA %x "

4235 "(LUN %Îd): g‘tšg‚ew…¬am‘”s", 
cmd
->
£n£
[12],

4236 ()
cmd
->
lun
);

4238 
	`sc¡_obš_deviû_·¿m‘”s
(
cmd
->
dev
, 
NULL
);

4240 
	`sBUG
();

4242 
cmd
->
¡©e
 = 
SCST_CMD_STATE_DEV_DONE
;

4244 
out
:

4245 
	`TRACE_EXIT_HRES
(
»s
);

4246  
»s
;

4247 
	}
}

4249 
	$sc¡_dev_dÚe
(
sc¡_cmd
 *
cmd
)

4251 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
;

4252 
¡©e
;

4253 
sc¡_dev_ty³
 *
devt
 = 
cmd
->devt;

4255 
	`TRACE_ENTRY
();

4257 
¡©e
 = 
SCST_CMD_STATE_PRE_XMIT_RESP1
;

4259 ià(
	`lik–y
((
cmd
->
Ý_æags
 & 
SCST_FULLY_LOCAL_CMD
) == 0) &&

4260 
	`lik–y
(
devt
->
dev_dÚe
 !ð
NULL
)) {

4261 
rc
;

4263 ià(
	`uÆik–y
(!
devt
->
dev_dÚe_©omic
 &&

4264 
	`sc¡_cmd_©omic
(
cmd
))) {

4269 
	`TRACE_MGMT_DBG
("Dev handler %s dev_done()‚eedshread "

4270 "cÚ‹xt,„eschedulšg", 
devt
->
Çme
);

4271 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

4272 
out
;

4275 
	`TRACE_DBG
("Calling dev handler %s dev_done(%p)",

4276 
devt
->
Çme
, 
cmd
);

4277 
	`sc¡_£t_cur_¡¬t
(
cmd
);

4278 
rc
 = 
devt
->
	`dev_dÚe
(
cmd
);

4279 
	`sc¡_£t_dev_dÚe_time
(
cmd
);

4280 
	`TRACE_DBG
("Dev handler %s dev_done()„eturned %d",

4281 
devt
->
Çme
, 
rc
);

4282 ià(
rc
 !ð
SCST_CMD_STATE_DEFAULT
)

4283 
¡©e
 = 
rc
;

4286 
¡©e
) {

4287 #ifdeà
CONFIG_SCST_EXTRACHECKS


4288 
SCST_CMD_STATE_PRE_XMIT_RESP1
:

4289 
SCST_CMD_STATE_PRE_XMIT_RESP2
:

4290 
SCST_CMD_STATE_PARSE
:

4291 
SCST_CMD_STATE_PREPARE_SPACE
:

4292 
SCST_CMD_STATE_RDY_TO_XFER
:

4293 
SCST_CMD_STATE_TGT_PRE_EXEC
:

4294 
SCST_CMD_STATE_EXEC_CHECK_SN
:

4295 
SCST_CMD_STATE_EXEC_CHECK_BLOCKING
:

4296 
SCST_CMD_STATE_LOCAL_EXEC
:

4297 
SCST_CMD_STATE_REAL_EXEC
:

4298 
SCST_CMD_STATE_PRE_DEV_DONE
:

4299 
SCST_CMD_STATE_MODE_SELECT_CHECKS
:

4300 
SCST_CMD_STATE_DEV_DONE
:

4301 
SCST_CMD_STATE_XMIT_RESP
:

4302 
SCST_CMD_STATE_FINISHED
:

4303 
SCST_CMD_STATE_FINISHED_INTERNAL
:

4307 
cmd
->
¡©e
 = state;

4309 
SCST_CMD_STATE_NEED_THREAD_CTX
:

4310 
	`TRACE_DBG
("Dev handler %s dev_done()„equested "

4312 
devt
->
Çme
);

4313 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

4314 
out
;

4315 #ifdeà
CONFIG_SCST_EXTRACHECKS


4317 ià(
¡©e
 >= 0) {

4318 
	`PRINT_ERROR
("Dev handler %s dev_done()„eturned "

4320 
devt
->
Çme
, 
¡©e
);

4322 
	`PRINT_ERROR
("Dev handler %s dev_done()„eturned "

4323 "”rÜ %d", 
devt
->
Çme
, 
¡©e
);

4325 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

4326 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

4327 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

4332 
	`sc¡_check_unblock_dev
(
cmd
);

4334 ià(
cmd
->
šc_ex³ùed_¢_Ú_dÚe
 && cmd->
£Á_fÜ_exec
 && cmd->
¢_£t
) {

4335 
boÞ
 
rc
 = 
	`sc¡_šc_ex³ùed_¢
(
cmd
);

4337 ià(
rc
)

4338 
	`sc¡_make_deã¼ed_commªds_aùive
(
cmd
->
cur_Üd”_d©a
);

4341 ià(
	`uÆik–y
(
cmd
->
š‹º®
))

4342 
cmd
->
¡©e
 = 
SCST_CMD_STATE_FINISHED_INTERNAL
;

4344 #iâdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


4345 #ifdeà
CONFIG_SCST_EXTRACHECKS


4346 ià(
cmd
->
¡©e
 !ð
SCST_CMD_STATE_PRE_XMIT_RESP1
) {

4348 ià(
	`sc¡_cmd_©omic
(
cmd
)) {

4349 
¡©e
) {

4350 
SCST_CMD_STATE_TGT_PRE_EXEC
:

4351 
SCST_CMD_STATE_EXEC_CHECK_SN
:

4352 
SCST_CMD_STATE_EXEC_CHECK_BLOCKING
:

4353 
SCST_CMD_STATE_LOCAL_EXEC
:

4354 
SCST_CMD_STATE_REAL_EXEC
:

4355 
	`TRACE_DBG
("Atomic context‡nd„edirect, "

4356 "»schedulšg (cmd %p)", 
cmd
);

4357 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

4365 
out
:

4366 
	`TRACE_EXIT_HRES
(
»s
);

4367  
»s
;

4368 
	}
}

4370 
	$sc¡_´e_xm™_»¥Ú£2
(
sc¡_cmd
 *
cmd
)

4372 
»s
;

4374 
	`TRACE_ENTRY
();

4376 
agaš
:

4377 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
)))

4378 
	`sc¡_xm™_´oûss_abÜ‹d_cmd
(
cmd
);

4379 ià(
	`uÆik–y
(
cmd
->
¡©us
 =ð
SAM_STAT_CHECK_CONDITION
)) {

4380 ià(
cmd
->
tgt_dev
 !ð
NULL
) {

4381 
rc
 = 
	`sc¡_´oûss_check_cÚd™iÚ
(
cmd
);

4383 ià(
rc
 == -1) {

4384 
»s
 = 
SCST_CMD_STATE_RES_CONT_NEXT
;

4385 
out
;

4386 } ià(
rc
 == 1)

4387 
agaš
;

4391 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_CMD_NO_RESP
, &
cmd
->
cmd_æags
))) {

4392 
	`EXTRACHECKS_BUG_ON
(!
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
));

4393 
	`TRACE_MGMT_DBG
("Flag NO_RESP set for cmd %p (tag %llu), "

4394 "skpšg", 
cmd
, ()cmd->
g
);

4395 
cmd
->
¡©e
 = 
SCST_CMD_STATE_FINISHED
;

4396 
out_§me
;

4399 ià(
	`uÆik–y
(
cmd
->
»sid_possibË
))

4400 
	`sc¡_adju¡_»¥_d©a_Ën
(
cmd
);

4402 
cmd
->
adju¡ed_»¥_d©a_Ën
 = cmd->
»¥_d©a_Ën
;

4404 
cmd
->
¡©e
 = 
SCST_CMD_STATE_XMIT_RESP
;

4406 
out_§me
:

4407 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
;

4409 
out
:

4410 
	`TRACE_EXIT_RES
(
»s
);

4411  
»s
;

4412 
	}
}

4414 
	$sc¡_´e_xm™_»¥Ú£1
(
sc¡_cmd
 *
cmd
)

4416 
»s
;

4418 
	`TRACE_ENTRY
();

4420 
	`EXTRACHECKS_BUG_ON
(
cmd
->
š‹º®
);

4422 #ifdeà
CONFIG_SCST_DEBUG_TM


4423 ià(
cmd
->
tm_dbg_d–ayed
 &&

4424 !
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
)) {

4425 ià(
	`sc¡_cmd_©omic
(
cmd
)) {

4426 
	`TRACE_MGMT_DBG
("%s",

4428 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

4429  
»s
;

4431 
	`TRACE_MGMT_DBG
("Delaying cmd %p (tag %llu) for 1 second",

4432 
cmd
, cmd->
g
);

4433 
	`scheduË_timeout_unš‹¼u±ibË
(
HZ
);

4437 ià(
	`lik–y
(
cmd
->
tgt_dev
 !ð
NULL
)) {

4442 
	`©omic_dec
(&
cmd
->
tgt_dev
->
tgt_dev_cmd_couÁ
);

4443 #ifdeà
CONFIG_SCST_PER_DEVICE_CMD_COUNT_LIMIT


4444 
	`©omic_dec
(&
cmd
->
dev
->
dev_cmd_couÁ
);

4446 ià(
	`uÆik–y
(
cmd
->
queue_ty³
 =ð
SCST_CMD_QUEUE_HEAD_OF_QUEUE
))

4447 
	`sc¡_Ú_hq_cmd_»¥Ú£
(
cmd
);

4448 ià(
	`uÆik–y
(!
cmd
->
£Á_fÜ_exec
)) {

4453 
	`TRACE_SN
("cmd %p was‚ot sent forƒxec (sn %d, "

4454 "£ˆ%d)", 
cmd
, cmd->
¢
, cmd->
¢_£t
);

4455 
	`sc¡_unblock_deã¼ed
(
cmd
->
cur_Üd”_d©a
, cmd);

4459 
cmd
->
dÚe
 = 1;

4460 
	`smp_mb
();

4462 
cmd
->
¡©e
 = 
SCST_CMD_STATE_PRE_XMIT_RESP2
;

4463 
»s
 = 
	`sc¡_´e_xm™_»¥Ú£2
(
cmd
);

4465 
	`TRACE_EXIT_RES
(
»s
);

4466  
»s
;

4467 
	}
}

4469 
	$sc¡_xm™_»¥Ú£
(
sc¡_cmd
 *
cmd
)

4471 
sc¡_tgt_‹m¶©e
 *
tg‰
 = 
cmd
->tgtt;

4472 
»s
, 
rc
;

4474 
	`TRACE_ENTRY
();

4476 
	`EXTRACHECKS_BUG_ON
(
cmd
->
š‹º®
);

4478 ià(
	`uÆik–y
(!
tg‰
->
xm™_»¥Ú£_©omic
 &&

4479 
	`sc¡_cmd_©omic
(
cmd
))) {

4484 
	`TRACE_MGMT_DBG
("Target driver %s xmit_response()‚eedshread "

4485 "cÚ‹xt,„eschedulšg", 
tg‰
->
Çme
);

4486 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

4487 
out
;

4490 
»s
 = 
SCST_CMD_STATE_RES_CONT_NEXT
;

4491 
cmd
->
¡©e
 = 
SCST_CMD_STATE_XMIT_WAIT
;

4493 
	`TRACE_DBG
("C®lšg xm™_»¥Ú£(%p)", 
cmd
);

4495 #ià
	`defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

4496 ià(
	`uÆik–y
(
Œaû_æag
 & 
TRACE_DATA_SEND
) &&

4497 (
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_READ
)) {

4498 
i
, 
sg_út
;

4499 
sÿ‰”li¡
 *
sg
, *
sgi
;

4501 ià(
cmd
->
tgt_i_sg
 !ð
NULL
) {

4502 
sg
 = 
cmd
->
tgt_i_sg
;

4503 
sg_út
 = 
cmd
->
tgt_i_sg_út
;

4505 
sg
 = 
cmd
->sg;

4506 
sg_út
 = 
cmd
->sg_cnt;

4508 ià(
sg
 !ð
NULL
) {

4509 
	`PRINT_INFO
("Xmitting data for cmd %p "

4511 "»¥†’ %d)", 
cmd
, 
sg_út
, 
sg
,

4512 (*)
	`sg_·ge
(&
sg
[0]), 
	`sg_vœt
(sg),

4513 
cmd
->
»¥_d©a_Ën
);

4514 
	`fÜ_—ch_sg
(
sg
, 
sgi
, 
sg_út
, 
i
) {

4515 
	`PRINT_INFO
("sg %d", 
i
);

4516 
	`PRINT_BUFFER
("d©a", 
	`sg_vœt
(
sgi
),

4517 
sgi
->
Ëngth
);

4523 ià(
tg‰
->
Ú_hw_³ndšg_cmd_timeout
 !ð
NULL
) {

4524 
sc¡_£ssiÚ
 *
£ss
 = 
cmd
->sess;

4526 
cmd
->
hw_³ndšg_¡¬t
 = 
jiff›s
;

4527 
cmd
->
cmd_hw_³ndšg
 = 1;

4528 ià(!
	`‹¡_b™
(
SCST_SESS_HW_PENDING_WORK_SCHEDULED
, &
£ss
->
£ss_aæags
)) {

4529 
	`TRACE_DBG
("Sched HW…ending work for sess %p "

4530 "(maxim%d)", 
£ss
,

4531 
tg‰
->
max_hw_³ndšg_time
);

4532 
	`£t_b™
(
SCST_SESS_HW_PENDING_WORK_SCHEDULED
,

4533 &
£ss
->
£ss_aæags
);

4534 
	`scheduË_d–ayed_wÜk
(&
£ss
->
hw_³ndšg_wÜk
,

4535 
tg‰
->
max_hw_³ndšg_time
 * 
HZ
);

4539 
	`sc¡_£t_cur_¡¬t
(
cmd
);

4541 #ifdeà
CONFIG_SCST_DEBUG_RETRY


4542 ià(((
	`sc¡_¿ndom
() % 100) == 77))

4543 
rc
 = 
SCST_TGT_RES_QUEUE_FULL
;

4546 
rc
 = 
tg‰
->
	`xm™_»¥Ú£
(
cmd
);

4547 
	`TRACE_DBG
("xm™_»¥Ú£(è»tuºed %d", 
rc
);

4549 ià(
	`lik–y
(
rc
 =ð
SCST_TGT_RES_SUCCESS
))

4550 
out
;

4552 
	`sc¡_£t_xm™_time
(
cmd
);

4554 
cmd
->
cmd_hw_³ndšg
 = 0;

4557 
cmd
->
¡©e
 = 
SCST_CMD_STATE_XMIT_RESP
;

4559 
rc
) {

4560 
SCST_TGT_RES_QUEUE_FULL
:

4561 
	`sc¡_queue_»Œy_cmd
(
cmd
);

4562 
out
;

4564 
SCST_TGT_RES_NEED_THREAD_CTX
:

4565 
	`TRACE_DBG
("Target driver %s xmit_response() "

4567 
tg‰
->
Çme
);

4568 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

4569 
out
;

4572 ià(
rc
 =ð
SCST_TGT_RES_FATAL_ERROR
) {

4573 
	`PRINT_ERROR
("Target driver %s xmit_response()„eturned "

4574 "çÈ”rÜ", 
tg‰
->
Çme
);

4576 
	`PRINT_ERROR
("Target driver %s xmit_response()„eturned "

4577 "šv®id v®u%d", 
tg‰
->
Çme
, 
rc
);

4579 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

4580 
cmd
->
¡©e
 = 
SCST_CMD_STATE_FINISHED
;

4581 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
;

4582 
out
;

4585 
out
:

4587 
	`TRACE_EXIT_HRES
(
»s
);

4588  
»s
;

4589 
	}
}

4603 
	$sc¡_tgt_cmd_dÚe
(
sc¡_cmd
 *
cmd
,

4604 
sc¡_exec_cÚ‹xt
 
´ef_cÚ‹xt
)

4606 
	`TRACE_ENTRY
();

4608 
	`sBUG_ON
(
cmd
->
¡©e
 !ð
SCST_CMD_STATE_XMIT_WAIT
);

4610 
	`sc¡_£t_xm™_time
(
cmd
);

4612 
cmd
->
cmd_hw_³ndšg
 = 0;

4614 ià(
	`uÆik–y
(
cmd
->
tgt_dev
 =ð
NULL
))

4615 
´ef_cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

4617 
cmd
->
¡©e
 = 
SCST_CMD_STATE_FINISHED
;

4619 
	`sc¡_´oûss_»dœeù_cmd
(
cmd
, 
´ef_cÚ‹xt
, 1);

4621 
	`TRACE_EXIT
();

4623 
	}
}

4624 
EXPORT_SYMBOL
(
sc¡_tgt_cmd_dÚe
);

4626 
	$sc¡_fšish_cmd
(
sc¡_cmd
 *
cmd
)

4628 
»s
;

4629 
sc¡_£ssiÚ
 *
£ss
 = 
cmd
->sess;

4630 
sc¡_io_¡©_’Œy
 *
¡©
;

4631 
block_shiá
, 
®ign_Ën
;

4633 
	`TRACE_ENTRY
();

4635 
	`sc¡_upd©e_Ït_¡©s
(
cmd
);

4637 ià(
	`uÆik–y
(
cmd
->
d–iv”y_¡©us
 !ð
SCST_CMD_DELIVERY_SUCCESS
)) {

4638 ià((
cmd
->
tgt_dev
 !ð
NULL
) &&

4639 (
cmd
->
¡©us
 =ð
SAM_STAT_CHECK_CONDITION
) &&

4640 
	`sc¡_is_ua_£n£
(
cmd
->
£n£
, cmd->
£n£_v®id_Ën
)) {

4642 ià(
	`sc¡_cmd_©omic
(
cmd
) &&

4643 
	`sc¡_is_ua_glob®
(
cmd
->
£n£
, cmd->
£n£_v®id_Ën
)) {

4644 
	`TRACE_MGMT_DBG
("Requeuing of global UA for "

4645 "çžed cmd %°Ãed ¨th»ad", 
cmd
);

4646 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

4647 
out
;

4649 
	`sc¡_»queue_ua
(
cmd
, 
NULL
, 0);

4653 
	`©omic_dec
(&
£ss
->
£ss_cmd_couÁ
);

4655 
	`¥š_lock_œq
(&
£ss
->
£ss_li¡_lock
);

4657 
¡©
 = &
£ss
->
io_¡©s
[
cmd
->
d©a_dœeùiÚ
];

4658 
¡©
->
cmd_couÁ
++;

4659 
¡©
->
io_by‹_couÁ
 +ð
cmd
->
bufæ’
 + cmd->
out_bufæ’
;

4660 ià(
	`lik–y
(
cmd
->
dev
 !ð
NULL
)) {

4661 
block_shiá
 = 
cmd
->
dev
->block_shift;

4663 
®ign_Ën
 = (
block_shiá
 != 0) ? 4095 : 0;

4665 
block_shiá
 = 0;

4666 
®ign_Ën
 = 0;

4669 ià(
	`uÆik–y
(((
cmd
->
lba
 << 
block_shiá
è& 
®ign_Ën
) != 0) ||

4670 
	`uÆik–y
(((
cmd
->
bufæ’
 + cmd->
out_bufæ’
è& 
®ign_Ën
) != 0))

4671 
¡©
->
uÇligÃd_cmd_couÁ
++;

4673 
	`li¡_d–
(&
cmd
->
£ss_cmd_li¡_’Œy
);

4679 
cmd
->
fšished
 = 1;

4681 
	`¥š_uÆock_œq
(&
£ss
->
£ss_li¡_lock
);

4683 ià(
	`uÆik–y
(
cmd
->
cmd_Ú_glob®_¡pg_li¡
)) {

4684 
	`TRACE_DBG
("UÆi¡šg bešg f»ed STPG cmd %p", 
cmd
);

4685 
	`EXTRACHECKS_BUG_ON
(
cmd
->
cmd_glob®_¡pg_blocked
);

4686 
	`sc¡_¡pg_d–_unblock_Ãxt
(
cmd
);

4689 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
)))

4690 
	`sc¡_fšish_cmd_mgmt
(
cmd
);

4692 
	`__sc¡_cmd_put
(
cmd
);

4694 
»s
 = 
SCST_CMD_STATE_RES_CONT_NEXT
;

4696 
out
:

4697 
	`TRACE_EXIT_HRES
(
»s
);

4698  
»s
;

4699 
	}
}

4702 
šlše
 
	$sc¡_šc_ex³ùed_¢_idË
(
sc¡_Üd”_d©a
 *
Üd”_d©a
)

4704 
Üd”_d©a
->
ex³ùed_¢
++;

4712 
	`smp_mb
();

4713 
	`TRACE_SN
("Newƒx³ùed_¢: %d", 
Üd”_d©a
->
ex³ùed_¢
);

4715 
	`sc¡_make_deã¼ed_commªds_aùive_locked
(
Üd”_d©a
);

4717 
	}
}

4738 
	$sc¡_cmd_£t_¢
(
sc¡_cmd
 *
cmd
)

4740 
sc¡_Üd”_d©a
 *
Üd”_d©a
 = 
cmd
->
cur_Üd”_d©a
;

4741 
æags
;

4743 
	`TRACE_ENTRY
();

4745 ià(((
cmd
->
Ý_æags
 & 
SCST_IMPLICIT_HQ
) != 0) &&

4746 
	`lik–y
(
cmd
->
queue_ty³
 =ð
SCST_CMD_QUEUE_SIMPLE
)) {

4747 
	`TRACE_SN
("Im¶ic™ HQ cmd %p", 
cmd
);

4748 
cmd
->
queue_ty³
 = 
SCST_CMD_QUEUE_HEAD_OF_QUEUE
;

4751 
	`EXTRACHECKS_BUG_ON
(
cmd
->
¢_£t
 || cmd->
hq_cmd_šûd
);

4755 
	`sc¡_check_debug_¢
(
cmd
);

4757 #ifdeà
CONFIG_SCST_STRICT_SERIALIZING


4758 ià(
	`lik–y
(
cmd
->
queue_ty³
 !ð
SCST_CMD_QUEUE_HEAD_OF_QUEUE
))

4759 
cmd
->
queue_ty³
 = 
SCST_CMD_QUEUE_ORDERED
;

4762 ià(
cmd
->
dev
->
queue_®g
 =ð
SCST_QUEUE_ALG_0_RESTRICTED_REORDER
) {

4763 ià(
	`lik–y
(
cmd
->
queue_ty³
 !ð
SCST_CMD_QUEUE_HEAD_OF_QUEUE
)) {

4769 
	`TRACE_SN
("Restricted„eorder dev %s (cmd %p)",

4770 
cmd
->
dev
->
vœt_Çme
, cmd);

4771 
cmd
->
queue_ty³
 = 
SCST_CMD_QUEUE_ORDERED
;

4775 
agaš
:

4776 
cmd
->
queue_ty³
) {

4777 
SCST_CMD_QUEUE_SIMPLE
:

4778 ià(
Üd”_d©a
->
´ev_cmd_Üd”ed
) {

4779 ià(
	`©omic_»ad
(
Üd”_d©a
->
cur_¢_¦Ù
) != 0) {

4780 
Üd”_d©a
->
cur_¢_¦Ù
++;

4781 ià(
Üd”_d©a
->
cur_¢_¦Ù
 =ðÜd”_d©a->
¢_¦Ùs
 +

4782 
	`ARRAY_SIZE
(
Üd”_d©a
->
¢_¦Ùs
))

4783 
Üd”_d©a
->
cur_¢_¦Ù
 = ord”_d©a->
¢_¦Ùs
;

4784 ià(
	`uÆik–y
(
	`©omic_»ad
(
Üd”_d©a
->
cur_¢_¦Ù
) != 0)) {

4785 
q
;

4787 ià(
q
++ < 10)

4788 
	`PRINT_WARNING
("Notƒnough SN slots "

4789 "(dev %s)", 
cmd
->
dev
->
vœt_Çme
);

4790 
Üd”ed
;

4792 
	`TRACE_SN
("New cur SN slot %zd",

4793 
Üd”_d©a
->
cur_¢_¦Ù
 - ord”_d©a->
¢_¦Ùs
);

4796 
Üd”_d©a
->
cu¼_¢
++;

4797 
	`TRACE_SN
("Inüem’‹d cu¼_¢ %d", 
Üd”_d©a
->
cu¼_¢
);

4799 
Üd”_d©a
->
´ev_cmd_Üd”ed
 = 0;

4806 
cmd
->
¢_¦Ù
 = 
Üd”_d©a
->
cur_¢_¦Ù
;

4807 
	`©omic_šc
(
cmd
->
¢_¦Ù
);

4808 
cmd
->
¢
 = 
Üd”_d©a
->
cu¼_¢
;

4809 
cmd
->
¢_£t
 = 1;

4812 
SCST_CMD_QUEUE_UNTAGGED
:

4814 
cmd
->
queue_ty³
 = 
SCST_CMD_QUEUE_SIMPLE
;

4815 
agaš
;

4817 
SCST_CMD_QUEUE_ORDERED
:

4818 
	`TRACE_SN
("ORDERED cmd %°(Ý %s)", 
cmd
, 
	`sc¡_g‘_Ýcode_Çme
(cmd));

4819 
Üd”ed
:

4820 
Üd”_d©a
->
cu¼_¢
++;

4821 
	`TRACE_SN
("Inüem’‹d cu¼_¢ %d", 
Üd”_d©a
->
cu¼_¢
);

4823 ià(
Üd”_d©a
->
´ev_cmd_Üd”ed
) {

4824 
	`TRACE_SN
("Prev cmd ordered set");

4830 
Üd”_d©a
->
´ev_cmd_Üd”ed
 = 1;

4832 
	`¥š_lock_œq§ve
(&
Üd”_d©a
->
¢_lock
, 
æags
);

4838 ià(
	`©omic_»ad
(
Üd”_d©a
->
cur_¢_¦Ù
) == 0)

4839 
	`sc¡_šc_ex³ùed_¢_idË
(
Üd”_d©a
);

4841 
Üd”_d©a
->
³ndšg_sim¶e_šc_ex³ùed_¢
++;

4842 
	`TRACE_SN
("New inc…ending_simple_inc_expected_sn: %d",

4843 
Üd”_d©a
->
³ndšg_sim¶e_šc_ex³ùed_¢
);

4844 
	`smp_mb
();

4845 ià(
	`uÆik–y
(
	`©omic_»ad
(
Üd”_d©a
->
cur_¢_¦Ù
) == 0)) {

4846 
Üd”_d©a
->
³ndšg_sim¶e_šc_ex³ùed_¢
--;

4847 
	`TRACE_SN
("New dec…ending_simple_inc_expected_sn: %d",

4848 
Üd”_d©a
->
³ndšg_sim¶e_šc_ex³ùed_¢
);

4849 
	`EXTRACHECKS_BUG_ON
(
Üd”_d©a
->
³ndšg_sim¶e_šc_ex³ùed_¢
 < 0);

4850 
	`sc¡_šc_ex³ùed_¢_idË
(
Üd”_d©a
);

4853 
	`¥š_uÆock_œq»¡Üe
(&
Üd”_d©a
->
¢_lock
, 
æags
);

4856 
cmd
->
¢
 = 
Üd”_d©a
->
cu¼_¢
;

4857 
cmd
->
¢_£t
 = 1;

4860 
SCST_CMD_QUEUE_HEAD_OF_QUEUE
:

4861 
	`TRACE_SN
("HQ cmd %°(Ý %s)", 
cmd
, 
	`sc¡_g‘_Ýcode_Çme
(cmd));

4862 
	`¥š_lock_œq§ve
(&
Üd”_d©a
->
¢_lock
, 
æags
);

4863 
Üd”_d©a
->
hq_cmd_couÁ
++;

4864 
	`¥š_uÆock_œq»¡Üe
(&
Üd”_d©a
->
¢_lock
, 
æags
);

4865 
cmd
->
hq_cmd_šûd
 = 1;

4866 
out
;

4869 
	`sBUG
();

4872 
	`TRACE_SN
("cmd(%p)->sn: %d (order_data %p, *cur_sn_slot %d, "

4873 "´ev_cmd_Üd”ed %d, cur_¢_¦Ù %zd)", 
cmd
,

4874 
cmd
->
¢
, 
Üd”_d©a
, 
	`©omic_»ad
(Üd”_d©a->
cur_¢_¦Ù
),

4875 
Üd”_d©a
->
´ev_cmd_Üd”ed
,

4876 
Üd”_d©a
->
cur_¢_¦Ù
 - ord”_d©a->
¢_¦Ùs
);

4878 
out
:

4879 
	`TRACE_EXIT
();

4881 
	}
}

4883 
sc¡_tgt_dev
 *
	$sc¡_lookup_tgt_dev
(
sc¡_£ssiÚ
 *
£ss
, 
u64
 
lun
)

4885 
li¡_h—d
 *
h—d
;

4886 
sc¡_tgt_dev
 *
tgt_dev
;

4888 #ifdeà
CONFIG_SCST_EXTRACHECKS


4889 ià(
	`sc¡_g‘_cmd_couÁ”
() == 0)

4890 
	`lockd•_as£¹_h–d
(&
sc¡_mu‹x
);

4893 
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
	`SESS_TGT_DEV_LIST_HASH_FN
(
lun
)];

4894 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
, 
£ss_tgt_dev_li¡_’Œy
) {

4895 ià(
tgt_dev
->
lun
 ==†un)

4896  
tgt_dev
;

4899  
NULL
;

4900 
	}
}

4909 
	$sc¡_Œª¦©e_lun
(
sc¡_cmd
 *
cmd
)

4911 
sc¡_tgt_dev
 *
tgt_dev
 = 
NULL
;

4912 
»s
;

4913 
boÞ
 
nul_dev
 = 
çl£
;

4915 
	`TRACE_ENTRY
();

4917 
cmd
->
ýu_cmd_couÁ”
 = 
	`sc¡_g‘
();

4919 ià(
	`lik–y
(!
	`‹¡_b™
(
SCST_FLAG_SUSPENDED
, &
sc¡_æags
))) {

4920 
	`TRACE_DBG
("Fšdšggt_dev fÜ cmd %°ÖuÀ%Îd)", 
cmd
,

4921 ()
cmd
->
lun
);

4922 
»s
 = -1;

4923 
tgt_dev
 = 
	`sc¡_lookup_tgt_dev
(
cmd
->
£ss
, cmd->
lun
);

4924 ià(
tgt_dev
) {

4925 
	`TRACE_DBG
("tgt_dev %°found", 
tgt_dev
);

4927 ià(
	`lik–y
(
tgt_dev
->
dev
->
hªdËr
 !ð&
sc¡_nuÎ_devty³
)) {

4928 
cmd
->
cmd_th»ads
 = 
tgt_dev
->
aùive_cmd_th»ads
;

4929 
cmd
->
tgt_dev
 =gt_dev;

4930 
cmd
->
cur_Üd”_d©a
 = 
tgt_dev
->
cu¼_Üd”_d©a
;

4931 
cmd
->
dev
 = 
tgt_dev
->dev;

4932 
cmd
->
devt
 = 
tgt_dev
->
dev
->
hªdËr
;

4934 
»s
 = 0;

4936 
	`PRINT_INFO
("Dev handler for device %lld is NULL, "

4938 ()
cmd
->
lun
);

4939 
nul_dev
 = 
Œue
;

4942 ià(
	`uÆik–y
(
»s
 != 0)) {

4943 ià(!
nul_dev
) {

4944 
	`TRACE
(
TRACE_MINOR
,

4947 ()
cmd
->
lun
,

4948 
cmd
->
£ss
->
š™ŸtÜ_Çme
, cmd->
tgt
->
tgt_Çme
);

4949 
	`sc¡_ev’t_queue_lun_nÙ_found
(
cmd
);

4951 
	`sc¡_put
(
cmd
->
ýu_cmd_couÁ”
);

4954 
	`sc¡_put
(
cmd
->
ýu_cmd_couÁ”
);

4955 
	`TRACE_MGMT_DBG
("%s", "FLAG SUSPENDED set, skipping");

4956 
»s
 = 1;

4959 
	`TRACE_EXIT_RES
(
»s
);

4960  
»s
;

4961 
	}
}

4969 
	$__sc¡_š™_cmd
(
sc¡_cmd
 *
cmd
)

4971 
»s
 = 0;

4973 
	`TRACE_ENTRY
();

4975 
»s
 = 
	`sc¡_Œª¦©e_lun
(
cmd
);

4976 ià(
	`lik–y
(
»s
 == 0)) {

4977 
út
;

4978 
boÞ
 
çžu»
 = 
çl£
;

4980 
cmd
->
¡©e
 = 
SCST_CMD_STATE_PARSE
;

4982 
út
 = 
	`©omic_šc_»tuº
(&
cmd
->
tgt_dev
->
tgt_dev_cmd_couÁ
);

4983 ià(
	`uÆik–y
(
út
 > 
SCST_MAX_TGT_DEV_COMMANDS
)) {

4984 
	`TRACE
(
TRACE_FLOW_CONTROL
,

4987 
út
, (
cmd
->
£ss
->
š™ŸtÜ_Çme
[0] == '\0') ?

4988 "AnÚymous" : 
cmd
->
£ss
->
š™ŸtÜ_Çme
);

4989 
çžu»
 = 
Œue
;

4992 #ifdeà
CONFIG_SCST_PER_DEVICE_CMD_COUNT_LIMIT


4993 
út
 = 
	`©omic_šc_»tuº
(&
cmd
->
dev
->
dev_cmd_couÁ
);

4994 ià(
	`uÆik–y
(
út
 > 
SCST_MAX_DEV_COMMANDS
)) {

4995 ià(!
çžu»
) {

4996 
	`TRACE
(
TRACE_FLOW_CONTROL
,

4999 "š™ŸtÜ \"%s\"", 
út
,

5000 (
cmd
->
£ss
->
š™ŸtÜ_Çme
[0] == '\0') ?

5002 
cmd
->
£ss
->
š™ŸtÜ_Çme
);

5003 
çžu»
 = 
Œue
;

5008 ià(
	`uÆik–y
(
çžu»
))

5009 
out_busy
;

5019 
	`sc¡_´e_·r£
(
cmd
);

5021 ià(!
cmd
->
£t_¢_Ú_»¡¬t_cmd
) {

5022 ià(!
cmd
->
tg‰
->
muÉ™h»aded_š™_dÚe
)

5023 
	`sc¡_cmd_£t_¢
(
cmd
);

5025 
sc¡_Üd”_d©a
 *
Üd”_d©a
 = 
cmd
->
cur_Üd”_d©a
;

5026 
æags
;

5028 
	`¥š_lock_œq§ve
(&
Üd”_d©a
->
š™_dÚe_lock
, 
æags
);

5029 
	`sc¡_cmd_£t_¢
(
cmd
);

5030 
	`¥š_uÆock_œq»¡Üe
(&
Üd”_d©a
->
š™_dÚe_lock
, 
æags
);

5033 } ià(
»s
 < 0) {

5034 
	`TRACE_DBG
("Fšishšg cmd %p", 
cmd
);

5035 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

5036 
	`SCST_LOAD_SENSE
(
sc¡_£n£_lun_nÙ_suµÜ‹d
));

5037 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

5039 
out
;

5041 
out
:

5042 
	`TRACE_EXIT_RES
(
»s
);

5043  
»s
;

5045 
out_busy
:

5046 
	`sc¡_£t_busy
(
cmd
);

5047 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

5048 
out
;

5049 
	}
}

5052 
	$sc¡_do_job_š™
()

5053 
	$__»Ëa£s
(&
sc¡_š™_lock
)

5054 
	$__acquœes
(&
sc¡_š™_lock
)

5056 
sc¡_cmd
 *
cmd
;

5057 
su¥
;

5059 
	`TRACE_ENTRY
();

5061 
»¡¬t
:

5066 
su¥
 = 
	`‹¡_b™
(
SCST_FLAG_SUSPENDED
, &
sc¡_æags
);

5067 ià(
sc¡_š™_pÞl_út
 > 0)

5068 
sc¡_š™_pÞl_út
--;

5070 
	`li¡_fÜ_—ch_’Œy
(
cmd
, &
sc¡_š™_cmd_li¡
, 
cmd_li¡_’Œy
) {

5071 
rc
;

5073 ià(
su¥
 && !
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
))

5075 ià(!
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
)) {

5076 
	`¥š_uÆock_œq
(&
sc¡_š™_lock
);

5077 
rc
 = 
	`__sc¡_š™_cmd
(
cmd
);

5078 
	`¥š_lock_œq
(&
sc¡_š™_lock
);

5079 ià(
rc
 > 0) {

5080 
	`TRACE_MGMT_DBG
("%s",

5082 
»¡¬t
;

5085 
	`TRACE_MGMT_DBG
("Aborting‚ot inited cmd %p (tag %llu)",

5086 
cmd
, ()cmd->
g
);

5087 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

5103 
	`TRACE_DBG
("D–‘šg cmd %°äom in™ cmd†i¡", 
cmd
);

5104 
	`smp_wmb
();

5105 
	`li¡_d–
(&
cmd
->
cmd_li¡_’Œy
);

5106 
	`¥š_uÆock
(&
sc¡_š™_lock
);

5108 
	`¥š_lock
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

5109 
	`TRACE_DBG
("Addšg cmd %°tØaùivcmd†i¡", 
cmd
);

5110 ià(
	`uÆik–y
(
cmd
->
queue_ty³
 =ð
SCST_CMD_QUEUE_HEAD_OF_QUEUE
))

5111 
	`li¡_add
(&
cmd
->
cmd_li¡_’Œy
,

5112 &
cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

5114 
	`li¡_add_ž
(&
cmd
->
cmd_li¡_’Œy
,

5115 &
cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

5116 
	`wake_up
(&
cmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

5117 
	`¥š_uÆock
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

5119 
	`¥š_lock
(&
sc¡_š™_lock
);

5120 
»¡¬t
;

5123 
	`TRACE_EXIT
();

5125 
	}
}

5127 
šlše
 
	$‹¡_š™_cmd_li¡
()

5129 
»s
 = (!
	`li¡_em±y
(&
sc¡_š™_cmd_li¡
) &&

5130 !
	`‹¡_b™
(
SCST_FLAG_SUSPENDED
, &
sc¡_æags
)) ||

5131 
	`uÆik–y
(
	`kth»ad_should_¡Ý
()) ||

5132 (
sc¡_š™_pÞl_út
 > 0);

5133  
»s
;

5134 
	}
}

5136 
	$sc¡_š™_th»ad
(*
¬g
)

5138 
	`TRACE_ENTRY
();

5140 
	`PRINT_INFO
("Inithread started");

5142 
cu¼’t
->
æags
 |ð
PF_NOFREEZE
;

5144 
	`£t_u£r_niû
(
cu¼’t
, -10);

5146 
	`¥š_lock_œq
(&
sc¡_š™_lock
);

5147 !
	`kth»ad_should_¡Ý
()) {

5148 
	`wa™_ev’t_locked
(
sc¡_š™_cmd_li¡_wa™Q
,

5149 
	`‹¡_š™_cmd_li¡
(),

5150 
lock_œq
, 
sc¡_š™_lock
);

5151 
	`sc¡_do_job_š™
();

5153 
	`¥š_uÆock_œq
(&
sc¡_š™_lock
);

5159 
	`sBUG_ON
(!
	`li¡_em±y
(&
sc¡_š™_cmd_li¡
));

5161 
	`PRINT_INFO
("Inithread finished");

5163 
	`TRACE_EXIT
();

5165 
	}
}

5179 
	$sc¡_ioùx_g‘
(
sc¡_cmd_th»ads
 *
p_cmd_th»ads
)

5181 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 25)

5182 
	`mu‹x_lock
(&
p_cmd_th»ads
->
io_cÚ‹xt_mu‹x
);

5184 
	`WARN_ON
(
cu¼’t
->
io_cÚ‹xt
);

5186 ià(
p_cmd_th»ads
 !ð&
sc¡_maš_cmd_th»ads
) {

5191 ià(
p_cmd_th»ads
->
io_cÚ‹xt
 =ð
NULL
) {

5192 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(3, 3, 0)

5193 
p_cmd_th»ads
->
io_cÚ‹xt
 = 
	`g‘_sk_io_cÚ‹xt
(
cu¼’t
,

5194 
GFP_KERNEL
, 
NUMA_NO_NODE
);

5196 
p_cmd_th»ads
->
io_cÚ‹xt
 = 
	`g‘_io_cÚ‹xt
(
GFP_KERNEL
, -1);

5198 
	`TRACE_DBG
("Alloced‚ew IO context %p "

5199 "Õ_cmd_th»ad %p)", 
p_cmd_th»ads
->
io_cÚ‹xt
,

5200 
p_cmd_th»ads
);

5205 
	`put_io_cÚ‹xt
(
p_cmd_th»ads
->
io_cÚ‹xt
);

5207 #ià(
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(3, 5, 0) && (LINUX_VERSION_CODE < KERNEL_VERSION(3, 6, 0)))

5208 #w¬nšg 
IO
 
cÚ‹xt
 
sh¬šg
 
funùiÚ®™y
 
di§bËd
 
Ú
 3.5 
k”Ãls
 
due
 
to
 
bug
 
š
 
them
. \

5209 
S“
 "h‰p://lkml.Üg/lkml/2012/7/17/515" 
mÜe
 
d‘ažs
.

5210 
q
;

5211 ià(
q
 == 0) {

5212 
q
++;

5213 
	`PRINT_WARNING
("IO context sharing functionality "

5219 
	`ioc_sk_lšk
(
p_cmd_th»ads
->
io_cÚ‹xt
);

5220 
cu¼’t
->
io_cÚ‹xt
 = 
p_cmd_th»ads
->io_context;

5221 
	`TRACE_DBG
("Linked IO context %p "

5222 "Õ_cmd_th»ad %p)", 
p_cmd_th»ads
->
io_cÚ‹xt
,

5223 
p_cmd_th»ads
);

5226 
p_cmd_th»ads
->
io_cÚ‹xt_»fút
++;

5229 
	`mu‹x_uÆock
(&
p_cmd_th»ads
->
io_cÚ‹xt_mu‹x
);

5232 
	`smp_wmb
();

5233 
p_cmd_th»ads
->
io_cÚ‹xt_»ady
 = 
Œue
;

5235 
	}
}

5240 
	$sc¡_ioùx_put
(
sc¡_cmd_th»ads
 *
p_cmd_th»ads
)

5242 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 25)

5243 ià(
p_cmd_th»ads
 !ð&
sc¡_maš_cmd_th»ads
) {

5244 
	`mu‹x_lock
(&
p_cmd_th»ads
->
io_cÚ‹xt_mu‹x
);

5245 ià(--
p_cmd_th»ads
->
io_cÚ‹xt_»fút
 == 0)

5246 
p_cmd_th»ads
->
io_cÚ‹xt
 = 
NULL
;

5247 
	`mu‹x_uÆock
(&
p_cmd_th»ads
->
io_cÚ‹xt_mu‹x
);

5251 
	}
}

5263 
	$sc¡_´oûss_aùive_cmd
(
sc¡_cmd
 *
cmd
, 
boÞ
 
©omic
)

5265 
»s
;

5267 
	`TRACE_ENTRY
();

5274 
	`EXTRACHECKS_BUG_ON
(
	`š_œq
(è|| 
	`œqs_di§bËd
());

5275 
	`EXTRACHECKS_WARN_ON
((
	`š_©omic
(è|| 
	`š_š‹¼u±
()è&& !
©omic
);

5277 
cmd
->
©omic
 =‡tomic;

5279 
	`TRACE_DBG
("cmd %p,‡tomiø%d", 
cmd
, 
©omic
);

5282 
cmd
->
¡©e
) {

5283 
SCST_CMD_STATE_PARSE
:

5284 
»s
 = 
	`sc¡_·r£_cmd
(
cmd
);

5287 
SCST_CMD_STATE_PREPARE_SPACE
:

5288 
»s
 = 
	`sc¡_´•¬e_¥aû
(
cmd
);

5291 
SCST_CMD_STATE_PREPROCESSING_DONE
:

5292 
»s
 = 
	`sc¡_´•roûssšg_dÚe
(
cmd
);

5295 
SCST_CMD_STATE_RDY_TO_XFER
:

5296 
»s
 = 
	`sc¡_rdy_to_xãr
(
cmd
);

5299 
SCST_CMD_STATE_TGT_PRE_EXEC
:

5300 
»s
 = 
	`sc¡_tgt_´e_exec
(
cmd
);

5303 
SCST_CMD_STATE_EXEC_CHECK_SN
:

5304 ià(
	`tm_dbg_check_cmd
(
cmd
) != 0) {

5305 
»s
 = 
SCST_CMD_STATE_RES_CONT_NEXT
;

5306 
	`TRACE_MGMT_DBG
("Skipping cmd %p (tag %llu), "

5307 "beÿu£ oàTM DBG d–ay", 
cmd
,

5308 ()
cmd
->
g
);

5311 
»s
 = 
	`sc¡_exec_check_¢
(&
cmd
);

5312 
	`EXTRACHECKS_BUG_ON
(
»s
 =ð
SCST_CMD_STATE_RES_NEED_THREAD
);

5319 
SCST_CMD_STATE_EXEC_CHECK_BLOCKING
:

5320 
»s
 = 
	`sc¡_exec_check_blockšg
(&
cmd
);

5321 
	`EXTRACHECKS_BUG_ON
(
»s
 =ð
SCST_CMD_STATE_RES_NEED_THREAD
);

5328 
SCST_CMD_STATE_LOCAL_EXEC
:

5329 
»s
 = 
	`sc¡_loÿl_exec
(
cmd
);

5330 
	`EXTRACHECKS_BUG_ON
(
»s
 =ð
SCST_CMD_STATE_RES_NEED_THREAD
);

5337 
SCST_CMD_STATE_REAL_EXEC
:

5338 
»s
 = 
	`sc¡_»®_exec
(
cmd
);

5339 
	`EXTRACHECKS_BUG_ON
(
»s
 =ð
SCST_CMD_STATE_RES_NEED_THREAD
);

5346 
SCST_CMD_STATE_PRE_DEV_DONE
:

5347 
»s
 = 
	`sc¡_´e_dev_dÚe
(
cmd
);

5348 
	`EXTRACHECKS_BUG_ON
((
»s
 =ð
SCST_CMD_STATE_RES_NEED_THREAD
) &&

5349 (
cmd
->
¡©e
 =ð
SCST_CMD_STATE_PRE_DEV_DONE
));

5352 
SCST_CMD_STATE_MODE_SELECT_CHECKS
:

5353 
»s
 = 
	`sc¡_mode_£Ëù_checks
(
cmd
);

5356 
SCST_CMD_STATE_DEV_DONE
:

5357 
»s
 = 
	`sc¡_dev_dÚe
(
cmd
);

5360 
SCST_CMD_STATE_PRE_XMIT_RESP1
:

5361 
»s
 = 
	`sc¡_´e_xm™_»¥Ú£1
(
cmd
);

5362 
	`EXTRACHECKS_BUG_ON
(
»s
 =ð
SCST_CMD_STATE_RES_NEED_THREAD
);

5365 
SCST_CMD_STATE_PRE_XMIT_RESP2
:

5366 
»s
 = 
	`sc¡_´e_xm™_»¥Ú£2
(
cmd
);

5367 
	`EXTRACHECKS_BUG_ON
(
»s
 =ð
SCST_CMD_STATE_RES_NEED_THREAD
);

5370 
SCST_CMD_STATE_XMIT_RESP
:

5371 
»s
 = 
	`sc¡_xm™_»¥Ú£
(
cmd
);

5374 
SCST_CMD_STATE_FINISHED
:

5375 
»s
 = 
	`sc¡_fšish_cmd
(
cmd
);

5378 
SCST_CMD_STATE_FINISHED_INTERNAL
:

5379 
»s
 = 
	`sc¡_fšish_š‹º®_cmd
(
cmd
);

5383 
	`PRINT_CRIT_ERROR
("cmd (%p) in state %d, but shouldn't "

5384 "be", 
cmd
, cmd->
¡©e
);

5385 
	`sBUG
();

5386 #ià
	`defšed
(
RHEL_MAJOR
) && RHEL_MAJOR -0 < 6

5388 
»s
 = 
SCST_CMD_STATE_RES_CONT_NEXT
;

5392 } 
»s
 =ð
SCST_CMD_STATE_RES_CONT_SAME
);

5394 ià(
»s
 =ð
SCST_CMD_STATE_RES_CONT_NEXT
) {

5396 } ià(
»s
 =ð
SCST_CMD_STATE_RES_NEED_THREAD
) {

5397 #ifdeà
CONFIG_SCST_EXTRACHECKS


5398 
cmd
->
¡©e
) {

5399 
SCST_CMD_STATE_PARSE
:

5400 
SCST_CMD_STATE_PREPARE_SPACE
:

5401 
SCST_CMD_STATE_RDY_TO_XFER
:

5402 
SCST_CMD_STATE_TGT_PRE_EXEC
:

5403 
SCST_CMD_STATE_EXEC_CHECK_SN
:

5404 
SCST_CMD_STATE_EXEC_CHECK_BLOCKING
:

5405 
SCST_CMD_STATE_LOCAL_EXEC
:

5406 
SCST_CMD_STATE_REAL_EXEC
:

5407 
SCST_CMD_STATE_DEV_DONE
:

5408 
SCST_CMD_STATE_XMIT_RESP
:

5411 
	`PRINT_CRIT_ERROR
("cmd %°i š inv®id s‹ %d)", 
cmd
,

5412 
cmd
->
¡©e
);

5413 
	`sBUG
();

5416 
	`TRACE_DBG
("Addšg cmd %°tØh—d oàaùivcmd†i¡", 
cmd
);

5418 
	`¥š_lock_œq
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

5419 
	`li¡_add
(&
cmd
->
cmd_li¡_’Œy
,

5420 &
cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

5421 
	`wake_up
(&
cmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

5422 
	`¥š_uÆock_œq
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

5424 
	`sBUG
();

5426 
	`TRACE_EXIT
();

5428 
	}
}

5429 
EXPORT_SYMBOL_GPL
(
sc¡_´oûss_aùive_cmd
);

5432 
	$sc¡_do_job_aùive
(
li¡_h—d
 *
cmd_li¡
,

5433 
¥šlock_t
 *
cmd_li¡_lock
, 
boÞ
 
©omic
)

5434 
	$__»Ëa£s
(
cmd_li¡_lock
)

5435 
	$__acquœes
(
cmd_li¡_lock
)

5437 
	`TRACE_ENTRY
();

5439 !
	`li¡_em±y
(
cmd_li¡
)) {

5440 
sc¡_cmd
 *
cmd
 = 
	`li¡_fœ¡_’Œy
(
cmd_li¡
, 
	`ty³of
(*cmd),

5441 
cmd_li¡_’Œy
);

5442 
	`TRACE_DBG
("D–‘šg cmd %°äom‡ùivcmd†i¡", 
cmd
);

5443 
	`li¡_d–
(&
cmd
->
cmd_li¡_’Œy
);

5444 
	`¥š_uÆock_œq
(
cmd_li¡_lock
);

5445 
	`sc¡_´oûss_aùive_cmd
(
cmd
, 
©omic
);

5446 
	`¥š_lock_œq
(
cmd_li¡_lock
);

5449 
	`TRACE_EXIT
();

5451 
	}
}

5453 
šlše
 
	$‹¡_cmd_th»ads
(
sc¡_cmd_th»ads
 *
p_cmd_th»ads
)

5455 
»s
 = !
	`li¡_em±y
(&
p_cmd_th»ads
->
aùive_cmd_li¡
) ||

5456 
	`uÆik–y
(
	`kth»ad_should_¡Ý
()) ||

5457 
	`tm_dbg_is_»Ëa£
();

5458  
»s
;

5459 
	}
}

5461 
	$sc¡_cmd_th»ad
(*
¬g
)

5463 
sc¡_cmd_th»ads
 *
p_cmd_th»ads
 = 
¬g
;

5465 
	`TRACE_ENTRY
();

5467 
	`TRACE
(
TRACE_MINOR
, "Proûssšgh»ad % ¡¬‹d", 
cu¼’t
->
comm
);

5470 
	`£t_u£r_niû
(
cu¼’t
, 10);

5472 
cu¼’t
->
æags
 |ð
PF_NOFREEZE
;

5474 
	`sc¡_ioùx_g‘
(
p_cmd_th»ads
);

5476 
	`wake_up_®l
(&
p_cmd_th»ads
->
ioùx_wq
);

5478 
	`¥š_lock_œq
(&
p_cmd_th»ads
->
cmd_li¡_lock
);

5479 !
	`kth»ad_should_¡Ý
()) {

5480 
	`wa™_ev’t_locked
(
p_cmd_th»ads
->
cmd_li¡_wa™Q
,

5481 
	`‹¡_cmd_th»ads
(
p_cmd_th»ads
), 
lock_œq
,

5482 
p_cmd_th»ads
->
cmd_li¡_lock
);

5484 ià(
	`tm_dbg_is_»Ëa£
()) {

5485 
	`¥š_uÆock_œq
(&
p_cmd_th»ads
->
cmd_li¡_lock
);

5486 
	`tm_dbg_check_»Ëa£d_cmds
();

5487 
	`¥š_lock_œq
(&
p_cmd_th»ads
->
cmd_li¡_lock
);

5490 
	`sc¡_do_job_aùive
(&
p_cmd_th»ads
->
aùive_cmd_li¡
,

5491 &
p_cmd_th»ads
->
cmd_li¡_lock
, 
çl£
);

5493 
	`¥š_uÆock_œq
(&
p_cmd_th»ads
->
cmd_li¡_lock
);

5495 
	`sc¡_ioùx_put
(
p_cmd_th»ads
);

5497 
	`TRACE
(
TRACE_MINOR
, "Proûssšgh»ad % fšished", 
cu¼’t
->
comm
);

5499 
	`TRACE_EXIT
();

5501 
	}
}

5503 
	$sc¡_cmd_skËt
(
p
)

5505 
sc¡_³rýu_šfo
 *
i
 = (sc¡_³rýu_šfØ*)
p
;

5507 
	`TRACE_ENTRY
();

5509 
	`¥š_lock_œq
(&
i
->
skËt_lock
);

5510 
	`sc¡_do_job_aùive
(&
i
->
skËt_cmd_li¡
, &i->
skËt_lock
, 
Œue
);

5511 
	`¥š_uÆock_œq
(&
i
->
skËt_lock
);

5513 
	`TRACE_EXIT
();

5515 
	}
}

5522 
	$sc¡_g‘_mgmt
(
sc¡_mgmt_cmd
 *
mcmd
)

5524 
»s
 = 0;

5526 
	`TRACE_ENTRY
();

5528 
mcmd
->
ýu_cmd_couÁ”
 = 
	`sc¡_g‘
();

5530 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_FLAG_SUSPENDED
, &
sc¡_æags
) &&

5531 !
	`‹¡_b™
(
SCST_FLAG_SUSPENDING
, &
sc¡_æags
))) {

5532 
	`sc¡_put
(
mcmd
->
ýu_cmd_couÁ”
);

5533 
	`TRACE_MGMT_DBG
("%s", "FLAG SUSPENDED set, skipping");

5534 
»s
 = 1;

5535 
out
;

5538 
out
:

5539 
	`TRACE_EXIT_HRES
(
»s
);

5540  
»s
;

5541 
	}
}

5548 
	$sc¡_mgmt_Œª¦©e_lun
(
sc¡_mgmt_cmd
 *
mcmd
)

5550 
sc¡_tgt_dev
 *
tgt_dev
;

5551 
»s
;

5553 
	`TRACE_ENTRY
();

5555 
	`TRACE_DBG
("Fšdšggt_dev fÜ mgmˆcmd %°ÖuÀ%Îd)", 
mcmd
,

5556 ()
mcmd
->
lun
);

5558 
»s
 = 
	`sc¡_g‘_mgmt
(
mcmd
);

5559 ià(
	`uÆik–y
(
»s
 != 0))

5560 
out
;

5562 
tgt_dev
 = 
	`sc¡_lookup_tgt_dev
(
mcmd
->
£ss
, mcmd->
lun
);

5563 ià(
tgt_dev
) {

5564 
	`TRACE_DBG
("tgt_dev %°found", 
tgt_dev
);

5565 
mcmd
->
mcmd_tgt_dev
 = 
tgt_dev
;

5566 
»s
 = 0;

5568 
	`sc¡_put
(
mcmd
->
ýu_cmd_couÁ”
);

5569 
»s
 = -1;

5572 
out
:

5573 
	`TRACE_EXIT_HRES
(
»s
);

5574  
»s
;

5575 
	}
}

5578 
	$sc¡_dÚe_cmd_mgmt
(
sc¡_cmd
 *
cmd
)

5580 
sc¡_mgmt_cmd_¡ub
 *
m¡b
, *
t
;

5581 
boÞ
 
wake
 = 0;

5582 
æags
;

5584 
	`TRACE_ENTRY
();

5586 
	`TRACE_MGMT_DBG
("cmd %p done (tag %llu)",

5587 
cmd
, ()cmd->
g
);

5589 
	`¥š_lock_œq§ve
(&
sc¡_mcmd_lock
, 
æags
);

5591 
	`li¡_fÜ_—ch_’Œy_§ã
(
m¡b
, 
t
, &
cmd
->
mgmt_cmd_li¡
,

5592 
cmd_mgmt_cmd_li¡_’Œy
) {

5593 
sc¡_mgmt_cmd
 *
mcmd
;

5595 ià(!
m¡b
->
dÚe_couÁed
)

5598 
mcmd
 = 
m¡b
->mcmd;

5599 
	`TRACE_MGMT_DBG
("mcmd %p, mcmd->cmd_done_wait_count %d",

5600 
mcmd
, mcmd->
cmd_dÚe_wa™_couÁ
);

5602 
mcmd
->
cmd_dÚe_wa™_couÁ
--;

5604 
	`sBUG_ON
(
mcmd
->
cmd_dÚe_wa™_couÁ
 < 0);

5606 ià(
mcmd
->
cmd_dÚe_wa™_couÁ
 > 0) {

5607 
	`TRACE_MGMT_DBG
("cmd_done_wait_count(%d)‚ot 0, "

5608 "skpšg", 
mcmd
->
cmd_dÚe_wa™_couÁ
);

5609 
check_ä“
;

5612 ià(
mcmd
->
¡©e
 =ð
SCST_MCMD_STATE_WAITING_AFFECTED_CMDS_DONE
) {

5613 
mcmd
->
¡©e
 = 
SCST_MCMD_STATE_AFFECTED_CMDS_DONE
;

5614 
	`TRACE_MGMT_DBG
("Adding mgmt cmd %po‡ctive mgmt cmd "

5615 "li¡", 
mcmd
);

5616 
	`li¡_add_ž
(&
mcmd
->
mgmt_cmd_li¡_’Œy
,

5617 &
sc¡_aùive_mgmt_cmd_li¡
);

5618 
wake
 = 1;

5621 
check_ä“
:

5622 ià(!
m¡b
->
fšish_couÁed
) {

5623 
	`TRACE_DBG
("R–—sšg m¡b %p", 
m¡b
);

5624 
	`li¡_d–
(&
m¡b
->
cmd_mgmt_cmd_li¡_’Œy
);

5625 
	`mempoÞ_ä“
(
m¡b
, 
sc¡_mgmt_¡ub_mempoÞ
);

5629 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_mcmd_lock
, 
æags
);

5631 ià(
wake
)

5632 
	`wake_up
(&
sc¡_mgmt_cmd_li¡_wa™Q
);

5634 
	`TRACE_EXIT
();

5636 
	}
}

5639 
	$__sc¡_dec_fšish_wa™_couÁ
(
sc¡_mgmt_cmd
 *
mcmd
, 
boÞ
 *
wake
)

5641 
	`TRACE_ENTRY
();

5643 
mcmd
->
cmd_fšish_wa™_couÁ
--;

5645 
	`sBUG_ON
(
mcmd
->
cmd_fšish_wa™_couÁ
 < 0);

5647 ià(
mcmd
->
cmd_fšish_wa™_couÁ
 > 0) {

5648 
	`TRACE_MGMT_DBG
("cmd_finish_wait_count(%d)‚ot 0, "

5649 "skpšg", 
mcmd
->
cmd_fšish_wa™_couÁ
);

5650 
out
;

5653 ià(
mcmd
->
cmd_dÚe_wa™_couÁ
 > 0) {

5654 
	`TRACE_MGMT_DBG
("cmd_done_wait_count(%d)‚ot 0, "

5655 "skpšg", 
mcmd
->
cmd_dÚe_wa™_couÁ
);

5656 
out
;

5659 ià(
mcmd
->
¡©e
 =ð
SCST_MCMD_STATE_WAITING_AFFECTED_CMDS_FINISHED
) {

5660 
mcmd
->
¡©e
 = 
SCST_MCMD_STATE_DONE
;

5661 
	`TRACE_MGMT_DBG
("Adding mgmt cmd %po‡ctive mgmt cmd "

5662 "li¡", 
mcmd
);

5663 
	`li¡_add_ž
(&
mcmd
->
mgmt_cmd_li¡_’Œy
,

5664 &
sc¡_aùive_mgmt_cmd_li¡
);

5665 *
wake
 = 
Œue
;

5668 
out
:

5669 
	`TRACE_EXIT
();

5671 
	}
}

5681 
	$sc¡_´•¬e_async_mcmd
(
sc¡_mgmt_cmd
 *
mcmd
)

5683 
æags
;

5685 
	`TRACE_ENTRY
();

5687 
	`TRACE_MGMT_DBG
("Preparing mcmd %p for‡syncƒxecution "

5688 "(cmd_fšish_wa™_couÁ %d)", 
mcmd
,

5689 
mcmd
->
cmd_fšish_wa™_couÁ
);

5691 
	`¥š_lock_œq§ve
(&
sc¡_mcmd_lock
, 
æags
);

5692 
mcmd
->
cmd_fšish_wa™_couÁ
++;

5693 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_mcmd_lock
, 
æags
);

5695 
	`TRACE_EXIT
();

5697 
	}
}

5698 
EXPORT_SYMBOL_GPL
(
sc¡_´•¬e_async_mcmd
);

5708 
	$sc¡_async_mcmd_com¶‘ed
(
sc¡_mgmt_cmd
 *
mcmd
, 
¡©us
)

5710 
æags
;

5711 
boÞ
 
wake
 = 
çl£
;

5713 
	`TRACE_ENTRY
();

5715 
	`TRACE_MGMT_DBG
("Asynømcmd %°com¶‘ed (¡©u %d)", 
mcmd
, 
¡©us
);

5717 
	`¥š_lock_œq§ve
(&
sc¡_mcmd_lock
, 
æags
);

5719 
	`sc¡_mgmt_cmd_£t_¡©us
(
mcmd
, 
¡©us
);

5721 
	`__sc¡_dec_fšish_wa™_couÁ
(
mcmd
, &
wake
);

5723 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_mcmd_lock
, 
æags
);

5725 ià(
wake
)

5726 
	`wake_up
(&
sc¡_mgmt_cmd_li¡_wa™Q
);

5728 
	`TRACE_EXIT
();

5730 
	}
}

5731 
EXPORT_SYMBOL_GPL
(
sc¡_async_mcmd_com¶‘ed
);

5734 
	$sc¡_fšish_cmd_mgmt
(
sc¡_cmd
 *
cmd
)

5736 
sc¡_mgmt_cmd_¡ub
 *
m¡b
, *
t
;

5737 
boÞ
 
wake
 = 
çl£
;

5738 
æags
;

5740 
	`TRACE_ENTRY
();

5742 
	`TRACE
(
TRACE_MGMT
, "AbÜ‹d cmd %°fšished (g %Îu,„eà%d)", 
cmd
,

5743 ()
cmd
->
g
, 
	`©omic_»ad
(&cmd->
cmd_»f
));

5745 
	`¥š_lock_œq§ve
(&
sc¡_mcmd_lock
, 
æags
);

5747 
	`li¡_fÜ_—ch_’Œy_§ã
(
m¡b
, 
t
, &
cmd
->
mgmt_cmd_li¡
,

5748 
cmd_mgmt_cmd_li¡_’Œy
) {

5749 
sc¡_mgmt_cmd
 *
mcmd
 = 
m¡b
->mcmd;

5751 
	`TRACE_MGMT_DBG
("mcmd %p, mcmd->cmd_fšish_wa™_couÁ %d", 
mcmd
,

5752 
mcmd
->
cmd_fšish_wa™_couÁ
);

5754 
	`sBUG_ON
(!
m¡b
->
fšish_couÁed
);

5756 ià(
cmd
->
com¶‘ed
)

5757 
mcmd
->
com¶‘ed_cmd_couÁ
++;

5759 
	`__sc¡_dec_fšish_wa™_couÁ
(
mcmd
, &
wake
);

5761 
	`TRACE_DBG
("R–—sšg m¡b %p", 
m¡b
);

5762 
	`li¡_d–
(&
m¡b
->
cmd_mgmt_cmd_li¡_’Œy
);

5763 
	`mempoÞ_ä“
(
m¡b
, 
sc¡_mgmt_¡ub_mempoÞ
);

5766 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_mcmd_lock
, 
æags
);

5768 ià(
wake
)

5769 
	`wake_up
(&
sc¡_mgmt_cmd_li¡_wa™Q
);

5771 
	`TRACE_EXIT
();

5773 
	}
}

5775 
	$sc¡_ÿÎ_dev_sk_mgmt_â_»ûived
(
sc¡_mgmt_cmd
 *
mcmd
,

5776 
sc¡_tgt_dev
 *
tgt_dev
)

5778 
sc¡_dev_ty³
 *
h
 = 
tgt_dev
->
dev
->
hªdËr
;

5780 
mcmd
->
sk_mgmt_â_»ûived_ÿÎed
 = 1;

5782 ià(
h
->
sk_mgmt_â_»ûived
) {

5783 
	`TRACE_MGMT_DBG
("Calling dev handler %sask_mgmt_fn_received(fn=%d)",

5784 
h
->
Çme
, 
mcmd
->
â
);

5785 
h
->
	`sk_mgmt_â_»ûived
(
mcmd
, 
tgt_dev
);

5786 
	`TRACE_MGMT_DBG
("Dev handler %sask_mgmt_fn_received()„eturned",

5787 
h
->
Çme
);

5790 
	}
}

5792 
	$sc¡_ÿÎ_dev_sk_mgmt_â_dÚe
(
sc¡_mgmt_cmd
 *
mcmd
,

5793 
sc¡_tgt_dev
 *
tgt_dev
)

5795 
sc¡_dev_ty³
 *
h
 = 
tgt_dev
->
dev
->
hªdËr
;

5797 ià(
h
->
sk_mgmt_â_dÚe
) {

5798 
	`TRACE_MGMT_DBG
("Calling dev handler %sask_mgmt_fn_done(fn=%d)",

5799 
h
->
Çme
, 
mcmd
->
â
);

5800 
h
->
	`sk_mgmt_â_dÚe
(
mcmd
, 
tgt_dev
);

5801 
	`TRACE_MGMT_DBG
("Dev handler %sask_mgmt_fn_done()„eturned",

5802 
h
->
Çme
);

5805 
	}
}

5807 
šlše
 
	$sc¡_is_¡riù_mgmt_â
(
mgmt_â
)

5809 
mgmt_â
) {

5810 #ifdeà
CONFIG_SCST_ABORT_CONSIDER_FINISHED_TASKS_AS_NOT_EXISTING


5811 
SCST_ABORT_TASK
:

5815 
SCST_ABORT_TASK_SET
:

5816 
SCST_CLEAR_TASK_SET
:

5822 
	}
}

5828 
	$sc¡_abÜt_cmd
(
sc¡_cmd
 *
cmd
, 
sc¡_mgmt_cmd
 *
mcmd
,

5829 
boÞ
 
Ùh”_ši
, boÞ 
ÿÎ_dev_sk_mgmt_â_»ûived
)

5831 
æags
;

5832 
	`DEFINE_SPINLOCK
(
Ùh”_ši_lock
);

5834 
	`TRACE_ENTRY
();

5837 
	`sBUG_ON
((
cmd
->
cdb
[0] =ð
EXTENDED_COPY
è&& cmd->
š‹º®
);

5843 ià(
ÿÎ_dev_sk_mgmt_â_»ûived
)

5844 
	`EXTRACHECKS_BUG_ON
(!
mcmd
);

5846 
	`TRACE
(
TRACE_SCSI
|
TRACE_MGMT_DEBUG
, "Aborting cmd %p (tag %llu, op %s)",

5847 
cmd
, ()cmd->
g
, 
	`sc¡_g‘_Ýcode_Çme
(cmd));

5850 
	`¥š_lock_œq§ve
(&
Ùh”_ši_lock
, 
æags
);

5852 ià(
Ùh”_ši
) {

5853 
sc¡_deviû
 *
dev
 = 
NULL
;

5856 ià(!
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
))

5857 
	`£t_b™
(
SCST_CMD_ABORTED_OTHER
, &
cmd
->
cmd_æags
);

5860 ià(
cmd
->
dev
 !ð
NULL
)

5861 
dev
 = 
cmd
->dev;

5862 ià((
mcmd
 !ð
NULL
è&& (mcmd->
mcmd_tgt_dev
 != NULL))

5863 
dev
 = 
mcmd
->
mcmd_tgt_dev
->dev;

5865 ià(
dev
 !ð
NULL
) {

5866 ià(
dev
->
s
)

5867 
	`£t_b™
(
SCST_CMD_DEVICE_TAS
, &
cmd
->
cmd_æags
);

5869 
	`PRINT_WARNING
("Abort cmd %p from other initiator, but "

5871 "TAS infÜm©iÚ cª blo¡", 
cmd
, 
mcmd
);

5874 
	`þ—r_b™
(
SCST_CMD_ABORTED_OTHER
, &
cmd
->
cmd_æags
);

5877 
	`£t_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
);

5879 
	`¥š_uÆock_œq»¡Üe
(&
Ùh”_ši_lock
, 
æags
);

5886 
	`smp_mb__aá”_£t_b™
();

5888 ià(
cmd
->
cdb
[0] =ð
EXTENDED_COPY
)

5889 
	`sc¡_cm_abÜt_ec_cmd
(
cmd
);

5891 ià(
cmd
->
tgt_dev
 =ð
NULL
) {

5892 
	`¥š_lock_œq§ve
(&
sc¡_š™_lock
, 
æags
);

5893 
sc¡_š™_pÞl_út
++;

5894 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_š™_lock
, 
æags
);

5895 
	`wake_up
(&
sc¡_š™_cmd_li¡_wa™Q
);

5898 ià(!
cmd
->
fšished
 && 
ÿÎ_dev_sk_mgmt_â_»ûived
 &&

5899 (
cmd
->
tgt_dev
 !ð
NULL
))

5900 
	`sc¡_ÿÎ_dev_sk_mgmt_â_»ûived
(
mcmd
, 
cmd
->
tgt_dev
);

5902 
	`¥š_lock_œq§ve
(&
sc¡_mcmd_lock
, 
æags
);

5903 ià((
mcmd
 !ð
NULL
è&& !
cmd
->
fšished
) {

5904 
sc¡_mgmt_cmd_¡ub
 *
m¡b
;

5906 
m¡b
 = 
	`mempoÞ_®loc
(
sc¡_mgmt_¡ub_mempoÞ
, 
GFP_ATOMIC
);

5907 ià(
m¡b
 =ð
NULL
) {

5908 
	`PRINT_CRIT_ERROR
("Allocation of management command "

5909 "¡ub fažed (mcmd %p, cmd %p)", 
mcmd
, 
cmd
);

5910 
uÆock
;

5912 
	`mem£t
(
m¡b
, 0, (*mstb));

5914 
	`TRACE_DBG
("m¡b %p, mcmd %p", 
m¡b
, 
mcmd
);

5916 
m¡b
->
mcmd
 = mcmd;

5930 ià(
cmd
->
£Á_fÜ_exec
 && !cmd->
dÚe
) {

5931 
	`TRACE_MGMT_DBG
("cmd %p (tag %llu) is beingƒxecuted",

5932 
cmd
, ()cmd->
g
);

5933 
m¡b
->
dÚe_couÁed
 = 1;

5934 
mcmd
->
cmd_dÚe_wa™_couÁ
++;

5941 ià(!
Ùh”_ši
) {

5942 
m¡b
->
fšish_couÁed
 = 1;

5943 
mcmd
->
cmd_fšish_wa™_couÁ
++;

5946 ià(
m¡b
->
dÚe_couÁed
 || m¡b->
fšish_couÁed
) {

5947 
t
;

5948 
¡©e_Çme
[32];

5950 ià(
mcmd
->
â
 !ð
SCST_PR_ABORT_ALL
)

5951 
t
 = 
TRACE_MGMT
;

5953 
t
 = 
TRACE_MGMT_DEBUG
;

5954 
	`TRACE
(
t
, "cmd %p (tag %llu, "

5960 
cmd
, ()cmd->
g
,

5961 
cmd
->
¢
, 
	`sc¡_g‘_cmd_¡©e_Çme
(
¡©e_Çme
,

5962 (
¡©e_Çme
), 
cmd
->
¡©e
),

5963 
	`sc¡_g‘_Ýcode_Çme
(
cmd
),

5964 ()(
jiff›s
 - 
cmd
->
¡¬t_time
è/ 
HZ
,

5965 
cmd
->
timeout
 / 
HZ
, 
mcmd
->
cmd_dÚe_wa™_couÁ
,

5966 
mcmd
->
cmd_fšish_wa™_couÁ
, 
cmd
->
š‹º®
,

5967 
mcmd
->
â
, mcmd, mcmd->
£ss
->
š™ŸtÜ_Çme
,

5968 
mcmd
->
£ss
->
tgt
->
tgt_Çme
);

5973 
	`li¡_add_ž
(&
m¡b
->
cmd_mgmt_cmd_li¡_’Œy
,

5974 &
cmd
->
mgmt_cmd_li¡
);

5977 
	`mempoÞ_ä“
(
m¡b
, 
sc¡_mgmt_¡ub_mempoÞ
);

5980 ià(!
cmd
->
š‹º®
 && cmd->
tg‰
->
Ú_abÜt_cmd
)

5981 
cmd
->
tg‰
->
	`Ú_abÜt_cmd
(cmd);

5984 
uÆock
:

5985 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_mcmd_lock
, 
æags
);

5987 
	`tm_dbg_»Ëa£_cmd
(
cmd
);

5989 
	`TRACE_EXIT
();

5991 
	}
}

5994 
	$sc¡_£t_mcmd_Ãxt_¡©e
(
sc¡_mgmt_cmd
 *
mcmd
)

5996 
»s
;

5998 
	`¥š_lock_œq
(&
sc¡_mcmd_lock
);

6000 
mcmd
->
¡©e
) {

6001 
SCST_MCMD_STATE_INIT
:

6002 
SCST_MCMD_STATE_EXEC
:

6003 ià(
mcmd
->
cmd_dÚe_wa™_couÁ
 == 0) {

6004 
mcmd
->
¡©e
 = 
SCST_MCMD_STATE_AFFECTED_CMDS_DONE
;

6005 
»s
 = 0;

6007 
	`TRACE
(
TRACE_SCSI
|
TRACE_MGMT_DEBUG
,

6009 "´•¬šgØwa™", 
mcmd
->
cmd_dÚe_wa™_couÁ
);

6010 
mcmd
->
¡©e
 = 
SCST_MCMD_STATE_WAITING_AFFECTED_CMDS_DONE
;

6011 
»s
 = -1;

6015 
SCST_MCMD_STATE_AFFECTED_CMDS_DONE
:

6016 ià(
mcmd
->
cmd_fšish_wa™_couÁ
 == 0) {

6017 
mcmd
->
¡©e
 = 
SCST_MCMD_STATE_DONE
;

6018 
»s
 = 0;

6020 
	`TRACE
(
TRACE_SCSI
|
TRACE_MGMT_DEBUG
,

6023 
mcmd
->
cmd_fšish_wa™_couÁ
);

6024 
mcmd
->
¡©e
 = 
SCST_MCMD_STATE_WAITING_AFFECTED_CMDS_FINISHED
;

6025 
»s
 = -1;

6029 
SCST_MCMD_STATE_DONE
:

6030 
mcmd
->
¡©e
 = 
SCST_MCMD_STATE_FINISHED
;

6031 
»s
 = 0;

6036 
â_Çme
[16], 
¡©e_Çme
[32];

6038 
	`PRINT_CRIT_ERROR
("Wrong mcmd %p state %s (fn %s, "

6040 
mcmd
, 
	`sc¡_g‘_mcmd_¡©e_Çme
(
¡©e_Çme
,

6041 (
¡©e_Çme
), 
mcmd
->
¡©e
),

6042 
	`sc¡_g‘_tm_â_Çme
(
â_Çme
, (â_Çme), 
mcmd
->
â
),

6043 
mcmd
->
cmd_fšish_wa™_couÁ
, mcmd->
cmd_dÚe_wa™_couÁ
);

6044 #ià!
	`defšed
(
__CHECKER__
)

6045 
	`¥š_uÆock_œq
(&
sc¡_mcmd_lock
);

6047 
»s
 = -1;

6048 
	`sBUG
();

6052 
	`¥š_uÆock_œq
(&
sc¡_mcmd_lock
);

6054  
»s
;

6055 
	}
}

6058 
boÞ
 
	$__sc¡_check_unblock_abÜ‹d_cmd
(
sc¡_cmd
 *
cmd
,

6059 
li¡_h—d
 *
li¡_’Œy
, 
boÞ
 
blocked
)

6061 
boÞ
 
»s
;

6063 ià(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
)) {

6064 
	`li¡_d–
(
li¡_’Œy
);

6065 ià(
blocked
)

6066 
cmd
->
cmd_glob®_¡pg_blocked
 = 0;

6067 
	`¥š_lock
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

6068 
	`li¡_add_ž
(&
cmd
->
cmd_li¡_’Œy
,

6069 &
cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

6070 
	`wake_up
(&
cmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

6071 
	`¥š_uÆock
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

6072 
»s
 = 1;

6074 
»s
 = 0;

6075  
»s
;

6076 
	}
}

6078 
	$sc¡_unblock_abÜ‹d_cmds
(cÚ¡ 
sc¡_tgt
 *
tgt
,

6079 cÚ¡ 
sc¡_£ssiÚ
 *
£ss
, cÚ¡ 
sc¡_deviû
 *
deviû
,

6080 
boÞ
 
sc¡_mu‹x_h–d
)

6082 
sc¡_deviû
 *
dev
;

6084 
	`TRACE_ENTRY
();

6086 ià(!
sc¡_mu‹x_h–d
)

6087 
	`mu‹x_lock
(&
sc¡_mu‹x
);

6089 
	`lockd•_as£¹_h–d
(&
sc¡_mu‹x
);

6091 
	`li¡_fÜ_—ch_’Œy
(
dev
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

6092 
sc¡_cmd
 *
cmd
, *
tcmd
;

6093 
sc¡_tgt_dev
 *
tgt_dev
;

6095 ià((
deviû
 !ð
NULL
è&& (deviû !ð
dev
))

6098 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

6099 
	`loÿl_œq_di§bË_nÜt
();

6100 
	`li¡_fÜ_—ch_’Œy_§ã
(
cmd
, 
tcmd
, &
dev
->
blocked_cmd_li¡
,

6101 
blocked_cmd_li¡_’Œy
) {

6103 ià((
tgt
 !ð
NULL
è&& (tgˆ!ð
cmd
->tgt))

6105 ià((
£ss
 !ð
NULL
è&& (£s !ð
cmd
->sess))

6108 ià(
	`__sc¡_check_unblock_abÜ‹d_cmd
(
cmd
,

6109 &
cmd
->
blocked_cmd_li¡_’Œy
, 
Œue
)) {

6110 
	`TRACE_MGMT_DBG
("Unblock‡bÜ‹d blocked cmd %p", 
cmd
);

6113 
	`loÿl_œq_’abË_nÜt
();

6114 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

6116 
	`loÿl_œq_di§bË_nÜt
();

6117 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

6118 
dev_tgt_dev_li¡_’Œy
) {

6119 
sc¡_Üd”_d©a
 *
Üd”_d©a
 = 
tgt_dev
->
cu¼_Üd”_d©a
;

6121 
	`¥š_lock
(&
Üd”_d©a
->
¢_lock
);

6122 
	`li¡_fÜ_—ch_’Œy_§ã
(
cmd
, 
tcmd
,

6123 &
Üd”_d©a
->
deã¼ed_cmd_li¡
,

6124 
deã¼ed_cmd_li¡_’Œy
) {

6126 ià((
tgt
 !ð
NULL
è&& (tgˆ!ð
cmd
->tgt))

6128 ià((
£ss
 !ð
NULL
è&& (£s !ð
cmd
->sess))

6131 ià(
	`__sc¡_check_unblock_abÜ‹d_cmd
(
cmd
,

6132 &
cmd
->
deã¼ed_cmd_li¡_’Œy
, 
çl£
)) {

6133 
	`TRACE_MGMT_DBG
("Unblocked‡borted SN "

6134 "cmd %°(¢ %u)", 
cmd
, cmd->
¢
);

6135 
Üd”_d©a
->
def_cmd_couÁ
--;

6138 
	`¥š_uÆock
(&
Üd”_d©a
->
¢_lock
);

6140 
	`loÿl_œq_’abË_nÜt
();

6143 ià(!
sc¡_mu‹x_h–d
)

6144 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

6146 
	`TRACE_EXIT
();

6148 
	}
}

6150 
	$__sc¡_abÜt_sk_£t
(
sc¡_mgmt_cmd
 *
mcmd
,

6151 
sc¡_tgt_dev
 *
tgt_dev
)

6153 
sc¡_cmd
 *
cmd
;

6154 
sc¡_£ssiÚ
 *
£ss
 = 
tgt_dev
->sess;

6155 
boÞ
 
Ùh”_ši
;

6157 
	`TRACE_ENTRY
();

6159 ià((
mcmd
->
â
 =ð
SCST_PR_ABORT_ALL
) &&

6160 (
mcmd
->
Üigš_´_cmd
->
£ss
 != sess))

6161 
Ùh”_ši
 = 
Œue
;

6163 
Ùh”_ši
 = 
çl£
;

6165 
	`¥š_lock_œq
(&
£ss
->
£ss_li¡_lock
);

6167 
	`TRACE_DBG
("S—rchšg iÀ£s cmd†i¡ (£ss=%p)", 
£ss
);

6168 
	`li¡_fÜ_—ch_’Œy
(
cmd
, &
£ss
->
£ss_cmd_li¡
,

6169 
£ss_cmd_li¡_’Œy
) {

6170 ià((
mcmd
->
â
 =ð
SCST_PR_ABORT_ALL
) &&

6171 (
mcmd
->
Üigš_´_cmd
 =ð
cmd
))

6173 ià((
cmd
->
tgt_dev
 ==gt_dev) ||

6174 ((
cmd
->
tgt_dev
 =ð
NULL
) &&

6175 (
cmd
->
lun
 =ð
tgt_dev
->lun))) {

6176 ià(
mcmd
->
cmd_¢_£t
) {

6177 
	`sBUG_ON
(!
cmd
->
tgt_¢_£t
);

6178 ià(
	`sc¡_¢_befÜe
(
mcmd
->
cmd_¢
, 
cmd
->
tgt_¢
) ||

6179 (
mcmd
->
cmd_¢
 =ð
cmd
->
tgt_¢
))

6182 
	`sc¡_abÜt_cmd
(
cmd
, 
mcmd
, 
Ùh”_ši
, 0);

6185 
	`¥š_uÆock_œq
(&
£ss
->
£ss_li¡_lock
);

6187 
	`TRACE_EXIT
();

6189 
	}
}

6192 
	$sc¡_abÜt_sk_£t
(
sc¡_mgmt_cmd
 *
mcmd
)

6194 
»s
;

6195 
sc¡_tgt_dev
 *
tgt_dev
 = 
mcmd
->
mcmd_tgt_dev
;

6197 
	`TRACE
(
TRACE_MGMT
, "Abortingask set (lun=%lld, mcmd=%p)",

6198 ()
tgt_dev
->
lun
, 
mcmd
);

6200 
	`__sc¡_abÜt_sk_£t
(
mcmd
, 
tgt_dev
);

6202 ià(
mcmd
->
â
 =ð
SCST_PR_ABORT_ALL
) {

6203 
sc¡_´_abÜt_®l_³ndšg_mgmt_cmds_couÁ”
 *
´_út
 =

6204 
mcmd
->
Üigš_´_cmd
->
´_abÜt_couÁ”
;

6205 ià(
	`©omic_dec_ªd_‹¡
(&
´_út
->
´_abÜtšg_út
))

6206 
	`com¶‘e_®l
(&
´_út
->
´_abÜtšg_cm¶
);

6209 
	`tm_dbg_sk_mgmt
(
mcmd
->
mcmd_tgt_dev
->
dev
, "ABORT TASK SET/PR ABORT", 0);

6211 
	`sc¡_unblock_abÜ‹d_cmds
(
tgt_dev
->
£ss
->
tgt
,gt_dev->£ss,gt_dev->
dev
, 
çl£
);

6213 
	`sc¡_ÿÎ_dev_sk_mgmt_â_»ûived
(
mcmd
, 
tgt_dev
);

6215 
»s
 = 
	`sc¡_£t_mcmd_Ãxt_¡©e
(
mcmd
);

6217 
	`TRACE_EXIT_RES
(
»s
);

6218  
»s
;

6219 
	}
}

6221 
boÞ
 
	$sc¡_is_cmd_b–Úgs_to_dev
(
sc¡_cmd
 *
cmd
,

6222 
sc¡_deviû
 *
dev
)

6224 
sc¡_tgt_dev
 *
tgt_dev
;

6225 
boÞ
 
»s
;

6227 
	`TRACE_ENTRY
();

6229 
	`TRACE_DBG
("Finding match for dev %s‡nd cmd %p (lun %lld)",

6230 
dev
->
vœt_Çme
, 
cmd
, ()cmd->
lun
);

6232 
tgt_dev
 = 
	`sc¡_lookup_tgt_dev
(
cmd
->
£ss
, cmd->
lun
);

6233 
»s
 = 
tgt_dev
 &&gt_dev->
dev
 == dev;

6235 
	`TRACE_EXIT_HRES
(
»s
);

6236  
»s
;

6237 
	}
}

6240 
	$sc¡_þ—r_sk_£t
(
sc¡_mgmt_cmd
 *
mcmd
)

6242 
»s
;

6243 
sc¡_deviû
 *
dev
 = 
mcmd
->
mcmd_tgt_dev
->dev;

6244 
sc¡_tgt_dev
 *
tgt_dev
;

6245 
	`LIST_HEAD
(
UA_tgt_devs
);

6247 
	`TRACE_ENTRY
();

6249 
	`TRACE
(
TRACE_MGMT
, "Clearingask set (lun=%lld, mcmd=%p)",

6250 ()
mcmd
->
lun
, mcmd);

6259 
mcmd
->
Ãeds_unblockšg
 = 1;

6260 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

6261 
	`sc¡_block_dev
(
dev
);

6262 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

6265 
	`__sc¡_abÜt_sk_£t
(
mcmd
, mcmd->
mcmd_tgt_dev
);

6267 
	`mu‹x_lock
(&
sc¡_mu‹x
);

6269 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

6270 
dev_tgt_dev_li¡_’Œy
) {

6271 
sc¡_£ssiÚ
 *
£ss
 = 
tgt_dev
->sess;

6272 
sc¡_cmd
 *
cmd
;

6273 
abÜ‹d
 = 0;

6275 ià(
tgt_dev
 =ð
mcmd
->
mcmd_tgt_dev
)

6278 
	`¥š_lock_œq
(&
£ss
->
£ss_li¡_lock
);

6280 
	`TRACE_DBG
("S—rchšg iÀ£s cmd†i¡ (£ss=%p)", 
£ss
);

6281 
	`li¡_fÜ_—ch_’Œy
(
cmd
, &
£ss
->
£ss_cmd_li¡
,

6282 
£ss_cmd_li¡_’Œy
) {

6283 ià((
cmd
->
dev
 == dev) ||

6284 ((
cmd
->
dev
 =ð
NULL
) &&

6285 
	`sc¡_is_cmd_b–Úgs_to_dev
(
cmd
, 
dev
))) {

6286 
	`sc¡_abÜt_cmd
(
cmd
, 
mcmd
, 1, 0);

6287 
abÜ‹d
 = 1;

6290 
	`¥š_uÆock_œq
(&
£ss
->
£ss_li¡_lock
);

6292 ià(
abÜ‹d
)

6293 
	`li¡_add_ž
(&
tgt_dev
->
exŒa_tgt_dev_li¡_’Œy
,

6294 &
UA_tgt_devs
);

6297 
	`tm_dbg_sk_mgmt
(
mcmd
->
mcmd_tgt_dev
->
dev
, "CLEAR TASK SET", 0);

6299 
	`sc¡_unblock_abÜ‹d_cmds
(
NULL
, NULL, 
dev
, 
Œue
);

6301 ià(!
dev
->
s
) {

6302 
ušt8_t
 
£n£_bufãr
[
SCST_STANDARD_SENSE_LEN
];

6303 
¦
;

6305 
¦
 = 
	`sc¡_£t_£n£
(
£n£_bufãr
, (sense_buffer),

6306 
dev
->
d_£n£
,

6307 
	`SCST_LOAD_SENSE
(
sc¡_£n£_þ—»d_by_ªÙh”_ši_UA
));

6309 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
UA_tgt_devs
,

6310 
exŒa_tgt_dev_li¡_’Œy
) {

6323 
	`sc¡_check_£t_UA
(
tgt_dev
, 
£n£_bufãr
, 
¦
, 0);

6327 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

6329 
	`sc¡_ÿÎ_dev_sk_mgmt_â_»ûived
(
mcmd
, mcmd->
mcmd_tgt_dev
);

6331 
»s
 = 
	`sc¡_£t_mcmd_Ãxt_¡©e
(
mcmd
);

6333 
	`TRACE_EXIT_RES
(
»s
);

6334  
»s
;

6335 
	}
}

6341 
	$sc¡_mgmt_cmd_š™
(
sc¡_mgmt_cmd
 *
mcmd
)

6343 
»s
 = 0, 
rc
, 
t
;

6345 
	`TRACE_ENTRY
();

6347 
t
 = 
mcmd
->
£ss
->
acg
->
acg_bÏck_hÞe_ty³
;

6348 ià(
	`uÆik–y
((
t
 =ð
SCST_ACG_BLACK_HOLE_ALL
) ||

6349 (
t
 =ð
SCST_ACG_BLACK_HOLE_DATA_MCMD
))) {

6350 
	`TRACE_MGMT_DBG
("DrÝpšg mcmd %°(â %d, in™ŸtÜ %s)", 
mcmd
,

6351 
mcmd
->
â
, mcmd->
£ss
->
š™ŸtÜ_Çme
);

6352 
mcmd
->
mcmd_drÝ³d
 = 1;

6355 
mcmd
->
â
) {

6356 
SCST_ABORT_TASK
:

6358 
sc¡_£ssiÚ
 *
£ss
 = 
mcmd
->sess;

6359 
sc¡_cmd
 *
cmd
;

6360 
sc¡_tgt_dev
 *
tgt_dev
;

6362 
	`¥š_lock_œq
(&
£ss
->
£ss_li¡_lock
);

6363 
cmd
 = 
	`__sc¡_fšd_cmd_by_g
(
£ss
, 
mcmd
->
g
, 
Œue
);

6364 ià(
cmd
 =ð
NULL
) {

6365 
	`TRACE_MGMT_DBG
("ABORT TASK: command "

6367 ()
mcmd
->
g
);

6368 
	`sc¡_mgmt_cmd_£t_¡©us
(
mcmd
, 
SCST_MGMT_STATUS_TASK_NOT_EXIST
);

6369 
	`¥š_uÆock_œq
(&
£ss
->
£ss_li¡_lock
);

6370 
»s
 = 
	`sc¡_£t_mcmd_Ãxt_¡©e
(
mcmd
);

6371 
out
;

6373 
	`__sc¡_cmd_g‘
(
cmd
);

6374 
tgt_dev
 = 
cmd
->tgt_dev;

6375 ià(
tgt_dev
 !ð
NULL
)

6376 
mcmd
->
ýu_cmd_couÁ”
 = 
	`sc¡_g‘
();

6377 
	`¥š_uÆock_œq
(&
£ss
->
£ss_li¡_lock
);

6378 
	`TRACE_DBG
("Cmdo‡bort %p forag %llu found (tgt_dev %p)",

6379 
cmd
, ()
mcmd
->
g
, 
tgt_dev
);

6380 
mcmd
->
cmd_to_abÜt
 = 
cmd
;

6381 
	`sBUG_ON
(
mcmd
->
mcmd_tgt_dev
 !ð
NULL
);

6382 
mcmd
->
mcmd_tgt_dev
 = 
tgt_dev
;

6383 
mcmd
->
¡©e
 = 
SCST_MCMD_STATE_EXEC
;

6387 
SCST_TARGET_RESET
:

6393 
rc
 = 
	`sc¡_g‘_mgmt
(
mcmd
);

6394 ià(
rc
 == 0) {

6395 
mcmd
->
¡©e
 = 
SCST_MCMD_STATE_EXEC
;

6396 
mcmd
->
sc¡_g‘_ÿÎed
 = 1;

6398 
	`EXTRACHECKS_BUG_ON
(
rc
 < 0);

6399 
»s
 = 
rc
;

6403 
SCST_NEXUS_LOSS_SESS
:

6404 
SCST_ABORT_ALL_TASKS_SESS
:

6405 
SCST_NEXUS_LOSS
:

6406 
SCST_ABORT_ALL_TASKS
:

6407 
SCST_UNREG_SESS_TM
:

6408 
mcmd
->
¡©e
 = 
SCST_MCMD_STATE_EXEC
;

6411 
SCST_ABORT_TASK_SET
:

6412 
SCST_CLEAR_ACA
:

6413 
SCST_CLEAR_TASK_SET
:

6414 
SCST_LUN_RESET
:

6415 
SCST_PR_ABORT_ALL
:

6416 
rc
 = 
	`sc¡_mgmt_Œª¦©e_lun
(
mcmd
);

6417 ià(
rc
 == 0)

6418 
mcmd
->
¡©e
 = 
SCST_MCMD_STATE_EXEC
;

6419 ià(
rc
 < 0) {

6420 
	`PRINT_ERROR
("Corresponding device for LUN %lld‚ot "

6421 "found", ()
mcmd
->
lun
);

6422 
	`sc¡_mgmt_cmd_£t_¡©us
(
mcmd
, 
SCST_MGMT_STATUS_LUN_NOT_EXIST
);

6423 
»s
 = 
	`sc¡_£t_mcmd_Ãxt_¡©e
(
mcmd
);

6425 
»s
 = 
rc
;

6429 
	`sBUG
();

6432 
out
:

6433 
	`sc¡_ev’t_queue_tm_â_»ûived
(
mcmd
);

6435 
	`TRACE_EXIT_RES
(
»s
);

6436  
»s
;

6437 
	}
}

6440 
	$sc¡_rg‘_»£t
(
sc¡_mgmt_cmd
 *
mcmd
)

6442 
»s
, 
rc
;

6443 
sc¡_deviû
 *
dev
;

6444 
sc¡_acg
 *
acg
 = 
mcmd
->
£ss
->acg;

6445 
sc¡_acg_dev
 *
acg_dev
;

6446 
	`LIST_HEAD
(
ho¡_devs
);

6448 
	`TRACE_ENTRY
();

6450 
	`TRACE
(
TRACE_MGMT
, "Target„eset (mcmd %p, cmd count %d)",

6451 
mcmd
, 
	`©omic_»ad
(&mcmd->
£ss
->
£ss_cmd_couÁ
));

6453 
mcmd
->
Ãeds_unblockšg
 = 1;

6455 
	`mu‹x_lock
(&
sc¡_mu‹x
);

6457 
	`li¡_fÜ_—ch_’Œy
(
acg_dev
, &
acg
->
acg_dev_li¡
, 
acg_dev_li¡_’Œy
) {

6458 
sc¡_deviû
 *
d
;

6459 
sc¡_tgt_dev
 *
tgt_dev
;

6460 
sc¡_lksb
 
´_lksb
;

6461 
found
 = 0;

6463 
dev
 = 
acg_dev
->dev;

6465 
	`sc¡_»s_lock
(
dev
, &
´_lksb
);

6466 
	`sc¡_block_dev
(
dev
);

6467 
	`sc¡_´oûss_»£t
(
dev
, 
mcmd
->
£ss
, 
NULL
, mcmd, 
Œue
);

6468 
	`sc¡_»s_uÆock
(
dev
, &
´_lksb
);

6470 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

6471 
dev_tgt_dev_li¡_’Œy
) {

6472 ià(
mcmd
->
£ss
 =ð
tgt_dev
->sess) {

6473 
	`sc¡_ÿÎ_dev_sk_mgmt_â_»ûived
(
mcmd
, 
tgt_dev
);

6478 
	`tm_dbg_sk_mgmt
(
dev
, "TARGET RESET", 0);

6480 ià(
dev
->
scsi_dev
 =ð
NULL
)

6483 
	`li¡_fÜ_—ch_’Œy
(
d
, &
ho¡_devs
, 
tm_dev_li¡_’Œy
) {

6484 ià(
dev
->
scsi_dev
->
ho¡
->
ho¡_no
 ==

6485 
d
->
scsi_dev
->
ho¡
->
ho¡_no
) {

6486 
found
 = 1;

6490 ià(!
found
)

6491 
	`li¡_add_ž
(&
dev
->
tm_dev_li¡_’Œy
, &
ho¡_devs
);

6494 
	`sc¡_unblock_abÜ‹d_cmds
(
NULL
, NULL, NULL, 
Œue
);

6501 
	`li¡_fÜ_—ch_’Œy
(
dev
, &
ho¡_devs
, 
tm_dev_li¡_’Œy
) {

6503 
	`TRACE
(
TRACE_MGMT
, "Resetting host %d bus ",

6504 
dev
->
scsi_dev
->
ho¡
->
ho¡_no
);

6505 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(3, 19, 0)

6507 
¬g
 = 
SG_SCSI_RESET_TARGET
;

6509 
rc
 = 
	`scsi_ioùl_»£t
(
dev
->
scsi_dev
,

6510 (
__fÜû
 
__u£r
 *)&
¬g
);

6512 #–ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 26)

6513 
rc
 = 
	`scsi_»£t_´ovid”
(
dev
->
scsi_dev
, 
SCSI_TRY_RESET_TARGET
);

6515 
rc
 = 
	`scsi_»£t_´ovid”
(
dev
->
scsi_dev
, 
SCSI_TRY_RESET_BUS
);

6517 
	`TRACE
(
TRACE_MGMT
, "Result of host %darget„eset: %s",

6518 
dev
->
scsi_dev
->
ho¡
->
ho¡_no
,

6519 (
rc
 =ð
SUCCESS
) ? "SUCCESS" : "FAILED");

6521 ià((
rc
 !ð
SUCCESS
) &&

6522 (
mcmd
->
¡©us
 =ð
SCST_MGMT_STATUS_SUCCESS
)) {

6527 
	`sc¡_mgmt_cmd_£t_¡©us
(
mcmd
, 
SCST_MGMT_STATUS_FAILED
);

6537 
	`li¡_fÜ_—ch_’Œy
(
acg_dev
, &
acg
->
acg_dev_li¡
, 
acg_dev_li¡_’Œy
) {

6538 
dev
 = 
acg_dev
->dev;

6539 ià(
dev
->
scsi_dev
 !ð
NULL
)

6540 
dev
->
scsi_dev
->
was_»£t
 = 0;

6543 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

6545 
»s
 = 
	`sc¡_£t_mcmd_Ãxt_¡©e
(
mcmd
);

6547 
	`TRACE_EXIT_RES
(
»s
);

6548  
»s
;

6549 
	}
}

6552 
	$sc¡_lun_»£t
(
sc¡_mgmt_cmd
 *
mcmd
)

6554 
»s
, 
rc
;

6555 
sc¡_tgt_dev
 *
tgt_dev
 = 
mcmd
->
mcmd_tgt_dev
;

6556 
sc¡_deviû
 *
dev
 = 
tgt_dev
->dev;

6557 
sc¡_lksb
 
´_lksb
;

6559 
	`TRACE_ENTRY
();

6561 
	`TRACE
(
TRACE_MGMT
, "Resetting LUN %lld (mcmd %p)",

6562 ()
tgt_dev
->
lun
, 
mcmd
);

6564 
mcmd
->
Ãeds_unblockšg
 = 1;

6566 
	`sc¡_»s_lock
(
dev
, &
´_lksb
);

6567 
	`sc¡_block_dev
(
dev
);

6568 
	`sc¡_´oûss_»£t
(
dev
, 
mcmd
->
£ss
, 
NULL
, mcmd, 
Œue
);

6569 
	`sc¡_»s_uÆock
(
dev
, &
´_lksb
);

6571 
	`sc¡_ÿÎ_dev_sk_mgmt_â_»ûived
(
mcmd
, 
tgt_dev
);

6573 ià(
dev
->
scsi_dev
 !ð
NULL
) {

6574 
	`TRACE
(
TRACE_MGMT
, "Resetting host %d bus ",

6575 
dev
->
scsi_dev
->
ho¡
->
ho¡_no
);

6576 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(3, 19, 0)

6578 
¬g
 = 
SG_SCSI_RESET_DEVICE
;

6580 
rc
 = 
	`scsi_ioùl_»£t
(
dev
->
scsi_dev
,

6581 (
__fÜû
 
__u£r
 *)&
¬g
);

6584 
rc
 = 
	`scsi_»£t_´ovid”
(
dev
->
scsi_dev
, 
SCSI_TRY_RESET_DEVICE
);

6586 
	`TRACE
(
TRACE_MGMT
, "scsi_reset_provider(%s)„eturned %d",

6587 
dev
->
vœt_Çme
, 
rc
);

6589 ià(
rc
 !ð
SUCCESS
 && 
mcmd
->
¡©us
 =ð
SCST_MGMT_STATUS_SUCCESS
)

6590 
	`sc¡_mgmt_cmd_£t_¡©us
(
mcmd
, 
SCST_MGMT_STATUS_FAILED
);

6597 
dev
->
scsi_dev
->
was_»£t
 = 0;

6600 
	`sc¡_unblock_abÜ‹d_cmds
(
NULL
, NULL, 
dev
, 
çl£
);

6602 
	`tm_dbg_sk_mgmt
(
mcmd
->
mcmd_tgt_dev
->
dev
, "LUN RESET", 0);

6604 
»s
 = 
	`sc¡_£t_mcmd_Ãxt_¡©e
(
mcmd
);

6606 
	`TRACE_EXIT_RES
(
»s
);

6607  
»s
;

6608 
	}
}

6611 
	$sc¡_do_Ãxus_loss_£ss
(
sc¡_mgmt_cmd
 *
mcmd
)

6613 
i
;

6614 
sc¡_£ssiÚ
 *
£ss
 = 
mcmd
->sess;

6615 
sc¡_tgt_dev
 *
tgt_dev
;

6617 
	`TRACE_ENTRY
();

6619 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

6620 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

6622 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
, 
£ss_tgt_dev_li¡_’Œy
) {

6623 
	`sc¡_Ãxus_loss
(
tgt_dev
,

6624 (
mcmd
->
â
 !ð
SCST_UNREG_SESS_TM
));

6628 
	`TRACE_EXIT
();

6630 
	}
}

6633 
	$sc¡_abÜt_®l_Ãxus_loss_£ss
(
sc¡_mgmt_cmd
 *
mcmd
,

6634 
Ãxus_loss_uÄeg_£ss
)

6636 
»s
;

6637 
i
;

6638 
sc¡_£ssiÚ
 *
£ss
 = 
mcmd
->sess;

6639 
sc¡_tgt_dev
 *
tgt_dev
;

6641 
	`TRACE_ENTRY
();

6643 ià(
Ãxus_loss_uÄeg_£ss
) {

6644 
	`TRACE_MGMT_DBG
("Nexus†oss or UNREG SESS for sess %p (mcmd %p)",

6645 
£ss
, 
mcmd
);

6647 
	`TRACE_MGMT_DBG
("Aborting‡ll from sess %p (mcmd %p)",

6648 
£ss
, 
mcmd
);

6651 
	`mu‹x_lock
(&
sc¡_mu‹x
);

6653 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

6654 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

6656 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
, 
£ss_tgt_dev_li¡_’Œy
) {

6657 
	`__sc¡_abÜt_sk_£t
(
mcmd
, 
tgt_dev
);

6659 
	`sc¡_ÿÎ_dev_sk_mgmt_â_»ûived
(
mcmd
, 
tgt_dev
);

6661 
	`tm_dbg_sk_mgmt
(
tgt_dev
->
dev
, "NEXUS LOSS SESS or "

6663 (
mcmd
->
â
 =ð
SCST_UNREG_SESS_TM
));

6667 
	`sc¡_unblock_abÜ‹d_cmds
(
NULL
, 
£ss
, NULL, 
Œue
);

6669 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

6671 
»s
 = 
	`sc¡_£t_mcmd_Ãxt_¡©e
(
mcmd
);

6673 
	`TRACE_EXIT_RES
(
»s
);

6674  
»s
;

6675 
	}
}

6678 
	$sc¡_do_Ãxus_loss_tgt
(
sc¡_mgmt_cmd
 *
mcmd
)

6680 
i
;

6681 
sc¡_tgt
 *
tgt
 = 
mcmd
->
£ss
->tgt;

6682 
sc¡_£ssiÚ
 *
£ss
;

6684 
	`TRACE_ENTRY
();

6686 
	`li¡_fÜ_—ch_’Œy
(
£ss
, &
tgt
->
£ss_li¡
, 
£ss_li¡_’Œy
) {

6687 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

6688 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

6689 
sc¡_tgt_dev
 *
tgt_dev
;

6691 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
,

6692 
£ss_tgt_dev_li¡_’Œy
) {

6693 
	`sc¡_Ãxus_loss
(
tgt_dev
, 
Œue
);

6698 
	`TRACE_EXIT
();

6700 
	}
}

6702 
	$sc¡_abÜt_®l_Ãxus_loss_tgt
(
sc¡_mgmt_cmd
 *
mcmd
,

6703 
Ãxus_loss
)

6705 
»s
;

6706 
i
;

6707 
sc¡_tgt
 *
tgt
 = 
mcmd
->
£ss
->tgt;

6708 
sc¡_£ssiÚ
 *
£ss
;

6710 
	`TRACE_ENTRY
();

6712 ià(
Ãxus_loss
) {

6713 
	`TRACE_MGMT_DBG
("I_T Nexus†oss (tgt %p, mcmd %p)",

6714 
tgt
, 
mcmd
);

6716 
	`TRACE_MGMT_DBG
("Aborting‡ll fromgt %p (mcmd %p)",

6717 
tgt
, 
mcmd
);

6720 
	`mu‹x_lock
(&
sc¡_mu‹x
);

6722 
	`li¡_fÜ_—ch_’Œy
(
£ss
, &
tgt
->
£ss_li¡
, 
£ss_li¡_’Œy
) {

6723 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

6724 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

6725 
sc¡_tgt_dev
 *
tgt_dev
;

6727 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
,

6728 
£ss_tgt_dev_li¡_’Œy
) {

6729 
	`__sc¡_abÜt_sk_£t
(
mcmd
, 
tgt_dev
);

6731 ià(
mcmd
->
£ss
 =ð
tgt_dev
->sess)

6732 
	`sc¡_ÿÎ_dev_sk_mgmt_â_»ûived
(

6733 
mcmd
, 
tgt_dev
);

6735 
	`tm_dbg_sk_mgmt
(
tgt_dev
->
dev
, "NEXUS LOSS or "

6741 
	`sc¡_unblock_abÜ‹d_cmds
(
tgt
, 
NULL
, NULL, 
Œue
);

6743 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

6745 
»s
 = 
	`sc¡_£t_mcmd_Ãxt_¡©e
(
mcmd
);

6747 
	`TRACE_EXIT_RES
(
»s
);

6748  
»s
;

6749 
	}
}

6751 
	$sc¡_abÜt_sk
(
sc¡_mgmt_cmd
 *
mcmd
)

6753 
»s
;

6754 
sc¡_cmd
 *
cmd
 = 
mcmd
->
cmd_to_abÜt
;

6756 
	`TRACE_ENTRY
();

6758 
	`TRACE_MGMT_DBG
("Abortingask (cmd %p, sn %d, set %d,ag %llu, "

6759 "queue_ty³ %x)", 
cmd
, cmd->
¢
, cmd->
¢_£t
,

6760 ()
mcmd
->
g
, 
cmd
->
queue_ty³
);

6762 ià(
mcmd
->
lun_£t
 && (mcmd->
lun
 !ð
cmd
->lun)) {

6763 
	`PRINT_ERROR
("ABORT TASK: LUN mismatch: mcmd LUN %llx, "

6765 ()
mcmd
->
lun
,

6766 ()
cmd
->
lun
,

6767 ()
mcmd
->
g
);

6768 
	`sc¡_mgmt_cmd_£t_¡©us
(
mcmd
, 
SCST_MGMT_STATUS_REJECTED
);

6769 } ià(
mcmd
->
cmd_¢_£t
 &&

6770 (
	`sc¡_¢_befÜe
(
mcmd
->
cmd_¢
, 
cmd
->
tgt_¢
) ||

6771 (
mcmd
->
cmd_¢
 =ð
cmd
->
tgt_¢
))) {

6772 
	`PRINT_ERROR
("ABORT TASK: SN mismatch: mcmd SN %x, "

6773 "cmd SN %x, cmdag %Îu", 
mcmd
->
cmd_¢
,

6774 
cmd
->
tgt_¢
, ()
mcmd
->
g
);

6775 
	`sc¡_mgmt_cmd_£t_¡©us
(
mcmd
, 
SCST_MGMT_STATUS_REJECTED
);

6777 
	`¥š_lock_œq
(&
cmd
->
£ss
->
£ss_li¡_lock
);

6778 
	`sc¡_abÜt_cmd
(
cmd
, 
mcmd
, 0, 1);

6779 
	`¥š_uÆock_œq
(&
cmd
->
£ss
->
£ss_li¡_lock
);

6781 
	`sc¡_unblock_abÜ‹d_cmds
(
cmd
->
tgt
, cmd->
£ss
, cmd->
dev
, 
çl£
);

6784 
»s
 = 
	`sc¡_£t_mcmd_Ãxt_¡©e
(
mcmd
);

6786 
mcmd
->
cmd_to_abÜt
 = 
NULL
;

6788 
	`__sc¡_cmd_put
(
cmd
);

6790 
	`TRACE_EXIT_RES
(
»s
);

6791  
»s
;

6792 
	}
}

6795 
	$sc¡_mgmt_cmd_exec
(
sc¡_mgmt_cmd
 *
mcmd
)

6797 
»s
 = 0;

6799 
	`TRACE_ENTRY
();

6801 
mcmd
->
â
) {

6802 
SCST_ABORT_TASK
:

6803 
»s
 = 
	`sc¡_abÜt_sk
(
mcmd
);

6806 
SCST_ABORT_TASK_SET
:

6807 
SCST_PR_ABORT_ALL
:

6808 
»s
 = 
	`sc¡_abÜt_sk_£t
(
mcmd
);

6811 
SCST_CLEAR_TASK_SET
:

6812 ià(
mcmd
->
mcmd_tgt_dev
->
dev
->
t¡
 =ð
SCST_TST_1_SEP_TASK_SETS
)

6813 
»s
 = 
	`sc¡_abÜt_sk_£t
(
mcmd
);

6815 
»s
 = 
	`sc¡_þ—r_sk_£t
(
mcmd
);

6818 
SCST_LUN_RESET
:

6819 
»s
 = 
	`sc¡_lun_»£t
(
mcmd
);

6822 
SCST_TARGET_RESET
:

6823 
»s
 = 
	`sc¡_rg‘_»£t
(
mcmd
);

6826 
SCST_ABORT_ALL_TASKS_SESS
:

6827 
»s
 = 
	`sc¡_abÜt_®l_Ãxus_loss_£ss
(
mcmd
, 0);

6830 
SCST_NEXUS_LOSS_SESS
:

6831 
SCST_UNREG_SESS_TM
:

6832 
»s
 = 
	`sc¡_abÜt_®l_Ãxus_loss_£ss
(
mcmd
, 1);

6835 
SCST_ABORT_ALL_TASKS
:

6836 
»s
 = 
	`sc¡_abÜt_®l_Ãxus_loss_tgt
(
mcmd
, 0);

6839 
SCST_NEXUS_LOSS
:

6840 
»s
 = 
	`sc¡_abÜt_®l_Ãxus_loss_tgt
(
mcmd
, 1);

6843 
SCST_CLEAR_ACA
:

6845 
	`sc¡_mgmt_cmd_£t_¡©us
(
mcmd
, 
SCST_MGMT_STATUS_FN_NOT_SUPPORTED
);

6846 
out_dÚe
;

6849 
	`PRINT_ERROR
("UnknowÀsk mªagem’ˆfunùiÚ %d", 
mcmd
->
â
);

6850 
	`sc¡_mgmt_cmd_£t_¡©us
(
mcmd
, 
SCST_MGMT_STATUS_REJECTED
);

6851 
out_dÚe
;

6854 
out
:

6855 
	`TRACE_EXIT_RES
(
»s
);

6856  
»s
;

6858 
out_dÚe
:

6859 
»s
 = 
	`sc¡_£t_mcmd_Ãxt_¡©e
(
mcmd
);

6860 
out
;

6861 
	}
}

6863 
	$sc¡_ÿÎ_sk_mgmt_afãùed_cmds_dÚe
(
sc¡_mgmt_cmd
 *
mcmd
)

6865 
sc¡_£ssiÚ
 *
£ss
 = 
mcmd
->sess;

6867 ià((
£ss
->
tgt
->
tg‰
->
sk_mgmt_afãùed_cmds_dÚe
 !ð
NULL
) &&

6868 (
mcmd
->
â
 !ð
SCST_UNREG_SESS_TM
) &&

6869 (
mcmd
->
â
 !ð
SCST_PR_ABORT_ALL
)) {

6870 
	`TRACE_DBG
("Callingarget %sask_mgmt_affected_cmds_done(%p)",

6871 
£ss
->
tgt
->
tg‰
->
Çme
, sess);

6872 
£ss
->
tgt
->
tg‰
->
	`sk_mgmt_afãùed_cmds_dÚe
(
mcmd
);

6873 
	`TRACE_MGMT_DBG
("Target's %sask_mgmt_affected_cmds_done() "

6874 "»tuºed", 
£ss
->
tgt
->
tg‰
->
Çme
);

6877 
	}
}

6879 
	$sc¡_mgmt_afãùed_cmds_dÚe
(
sc¡_mgmt_cmd
 *
mcmd
)

6881 
»s
, 
i
;

6882 
sc¡_£ssiÚ
 *
£ss
 = 
mcmd
->sess;

6883 
sc¡_deviû
 *
dev
;

6884 
sc¡_tgt_dev
 *
tgt_dev
;

6886 
	`TRACE_ENTRY
();

6888 
	`mu‹x_lock
(&
sc¡_mu‹x
);

6890 
mcmd
->
â
) {

6891 
SCST_NEXUS_LOSS_SESS
:

6892 
SCST_UNREG_SESS_TM
:

6893 
	`sc¡_do_Ãxus_loss_£ss
(
mcmd
);

6896 
SCST_NEXUS_LOSS
:

6897 
	`sc¡_do_Ãxus_loss_tgt
(
mcmd
);

6901 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

6903 ià(!
mcmd
->
sk_mgmt_â_»ûived_ÿÎed
)

6904 
tgt_dÚe
;

6906 
mcmd
->
â
) {

6907 
SCST_ABORT_TASK
:

6908 
SCST_ABORT_TASK_SET
:

6909 
SCST_CLEAR_TASK_SET
:

6910 
SCST_PR_ABORT_ALL
:

6911 
SCST_LUN_RESET
:

6912 
	`sc¡_ÿÎ_dev_sk_mgmt_â_dÚe
(
mcmd
, mcmd->
mcmd_tgt_dev
);

6915 
SCST_TARGET_RESET
:

6917 
sc¡_acg
 *
acg
 = 
£ss
->acg;

6918 
sc¡_acg_dev
 *
acg_dev
;

6920 
	`mu‹x_lock
(&
sc¡_mu‹x
);

6921 
	`li¡_fÜ_—ch_’Œy
(
acg_dev
, &
acg
->
acg_dev_li¡
, 
acg_dev_li¡_’Œy
) {

6922 
dev
 = 
acg_dev
->dev;

6923 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

6924 
dev_tgt_dev_li¡_’Œy
) {

6925 ià(
mcmd
->
£ss
 =ð
tgt_dev
->sess) {

6926 
	`sc¡_ÿÎ_dev_sk_mgmt_â_dÚe
(
mcmd
, 
tgt_dev
);

6931 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

6935 
SCST_ABORT_ALL_TASKS_SESS
:

6936 
SCST_NEXUS_LOSS_SESS
:

6937 
SCST_UNREG_SESS_TM
:

6938 
	`mu‹x_lock
(&
sc¡_mu‹x
);

6939 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

6940 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

6942 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
, 
£ss_tgt_dev_li¡_’Œy
) {

6943 
	`sc¡_ÿÎ_dev_sk_mgmt_â_dÚe
(
mcmd
, 
tgt_dev
);

6946 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

6949 
SCST_ABORT_ALL_TASKS
:

6950 
SCST_NEXUS_LOSS
:

6952 
sc¡_£ssiÚ
 *
s
;

6953 
sc¡_tgt
 *
tgt
 = 
£ss
->tgt;

6955 
	`mu‹x_lock
(&
sc¡_mu‹x
);

6956 
	`li¡_fÜ_—ch_’Œy
(
s
, &
tgt
->
£ss_li¡
, 
£ss_li¡_’Œy
) {

6957 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

6958 
li¡_h—d
 *
h—d
 = &
s
->
£ss_tgt_dev_li¡
[
i
];

6959 
sc¡_tgt_dev
 *
tgt_dev
;

6961 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
,

6962 
£ss_tgt_dev_li¡_’Œy
) {

6963 ià(
mcmd
->
£ss
 =ð
tgt_dev
->sess)

6964 
	`sc¡_ÿÎ_dev_sk_mgmt_â_dÚe
(

6965 
mcmd
, 
tgt_dev
);

6969 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

6974 
	`PRINT_ERROR
("Wrongask management function %d on "

6975 "sk_mgmt_â_dÚe(è¡age", 
mcmd
->
â
);

6979 
tgt_dÚe
:

6980 
	`sc¡_ÿÎ_sk_mgmt_afãùed_cmds_dÚe
(
mcmd
);

6982 
mcmd
->
â
) {

6983 
SCST_LUN_RESET
:

6984 
SCST_TARGET_RESET
:

6985 
SCST_NEXUS_LOSS_SESS
:

6986 
SCST_NEXUS_LOSS
:

6987 
SCST_UNREG_SESS_TM
:

6988 
	`sc¡_cm_ä“_³ndšg_li¡_ids
(
£ss
);

6992 
»s
 = 
	`sc¡_£t_mcmd_Ãxt_¡©e
(
mcmd
);

6994 
	`TRACE_EXIT_RES
(
»s
);

6995  
»s
;

6996 
	}
}

6998 
	$sc¡_mgmt_cmd_£nd_dÚe
(
sc¡_mgmt_cmd
 *
mcmd
)

7000 
sc¡_deviû
 *
dev
;

7001 
sc¡_£ssiÚ
 *
£ss
 = 
mcmd
->sess;

7003 
	`TRACE_ENTRY
();

7005 
mcmd
->
¡©e
 = 
SCST_MCMD_STATE_FINISHED
;

7006 ià(
	`sc¡_is_¡riù_mgmt_â
(
mcmd
->
â
è&& (mcmd->
com¶‘ed_cmd_couÁ
 > 0))

7007 
	`sc¡_mgmt_cmd_£t_¡©us
(
mcmd
, 
SCST_MGMT_STATUS_TASK_NOT_EXIST
);

7009 ià(
mcmd
->
â
 < 
SCST_UNREG_SESS_TM
)

7010 
	`TRACE
(
TRACE_MGMT
, "TM fn %d (mcmd %p) finished, "

7011 "¡©u %d", 
mcmd
->
â
, mcmd, mcmd->
¡©us
);

7013 
	`TRACE_MGMT_DBG
("TM fn %d (mcmd %p) finished, "

7014 "¡©u %d", 
mcmd
->
â
, mcmd, mcmd->
¡©us
);

7016 ià(
mcmd
->
â
 =ð
SCST_PR_ABORT_ALL
) {

7017 
mcmd
->
Üigš_´_cmd
->
	`sc¡_cmd_dÚe
(mcmd->origin_pr_cmd,

7018 
SCST_CMD_STATE_DEFAULT
,

7019 
SCST_CONTEXT_THREAD
);

7020 } ià((
£ss
->
tgt
->
tg‰
->
sk_mgmt_â_dÚe
 !ð
NULL
) &&

7021 (
mcmd
->
â
 !ð
SCST_UNREG_SESS_TM
)) {

7022 
	`TRACE_DBG
("Callingarget %sask_mgmt_fn_done(%p)",

7023 
£ss
->
tgt
->
tg‰
->
Çme
, sess);

7024 
£ss
->
tgt
->
tg‰
->
	`sk_mgmt_â_dÚe
(
mcmd
);

7025 
	`TRACE_MGMT_DBG
("Target's %sask_mgmt_fn_done() "

7026 "»tuºed", 
£ss
->
tgt
->
tg‰
->
Çme
);

7029 ià(
mcmd
->
Ãeds_unblockšg
) {

7030 
mcmd
->
â
) {

7031 
SCST_LUN_RESET
:

7032 
SCST_CLEAR_TASK_SET
:

7033 
dev
 = 
mcmd
->
mcmd_tgt_dev
->dev;

7034 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

7035 
	`sc¡_unblock_dev
(
dev
);

7036 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

7039 
SCST_TARGET_RESET
:

7041 
sc¡_acg
 *
acg
 = 
mcmd
->
£ss
->acg;

7042 
sc¡_acg_dev
 *
acg_dev
;

7044 
	`mu‹x_lock
(&
sc¡_mu‹x
);

7045 
	`li¡_fÜ_—ch_’Œy
(
acg_dev
, &
acg
->
acg_dev_li¡
,

7046 
acg_dev_li¡_’Œy
) {

7047 
dev
 = 
acg_dev
->dev;

7048 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

7049 
	`sc¡_unblock_dev
(
dev
);

7050 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

7052 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

7057 
	`sBUG
();

7062 
mcmd
->
tgt_´iv
 = 
NULL
;

7064 
	`TRACE_EXIT
();

7066 
	}
}

7069 
	$sc¡_´oûss_mgmt_cmd
(
sc¡_mgmt_cmd
 *
mcmd
)

7071 
»s
 = 0;

7073 
	`TRACE_ENTRY
();

7080 
	`TRACE_DBG
("mcmd %p, s‹ %d", 
mcmd
, mcmd->
¡©e
);

7083 
mcmd
->
¡©e
) {

7084 
SCST_MCMD_STATE_INIT
:

7085 
»s
 = 
	`sc¡_mgmt_cmd_š™
(
mcmd
);

7086 ià(
»s
 != 0)

7087 
out
;

7090 
SCST_MCMD_STATE_EXEC
:

7091 ià(
	`sc¡_mgmt_cmd_exec
(
mcmd
))

7092 
out
;

7095 
SCST_MCMD_STATE_AFFECTED_CMDS_DONE
:

7096 ià(
	`sc¡_mgmt_afãùed_cmds_dÚe
(
mcmd
))

7097 
out
;

7100 
SCST_MCMD_STATE_DONE
:

7101 
	`sc¡_mgmt_cmd_£nd_dÚe
(
mcmd
);

7104 
SCST_MCMD_STATE_FINISHED
:

7105 
	`sc¡_ä“_mgmt_cmd
(
mcmd
);

7107 
out
;

7111 
â_Çme
[16], 
¡©e_Çme
[32];

7113 
	`PRINT_CRIT_ERROR
("Wrong mcmd %p state %s (fn %s, "

7115 "%d)", 
mcmd
, 
	`sc¡_g‘_mcmd_¡©e_Çme
(
¡©e_Çme
,

7116 (
¡©e_Çme
), 
mcmd
->
¡©e
),

7117 
	`sc¡_g‘_tm_â_Çme
(
â_Çme
, (â_Çme), 
mcmd
->
â
),

7118 
mcmd
->
cmd_fšish_wa™_couÁ
,

7119 
mcmd
->
cmd_dÚe_wa™_couÁ
);

7120 
	`sBUG
();

7125 
out
:

7126 
	`TRACE_EXIT_RES
(
»s
);

7127  
»s
;

7128 
	}
}

7130 
šlše
 
	$‹¡_mgmt_cmd_li¡
()

7132 
»s
 = !
	`li¡_em±y
(&
sc¡_aùive_mgmt_cmd_li¡
) ||

7133 
	`uÆik–y
(
	`kth»ad_should_¡Ý
());

7134  
»s
;

7135 
	}
}

7137 
	$sc¡_tm_th»ad
(*
¬g
)

7139 
	`TRACE_ENTRY
();

7141 
	`PRINT_INFO
("Task managementhread started");

7143 
cu¼’t
->
æags
 |ð
PF_NOFREEZE
;

7145 
	`£t_u£r_niû
(
cu¼’t
, -10);

7147 
	`¥š_lock_œq
(&
sc¡_mcmd_lock
);

7148 !
	`kth»ad_should_¡Ý
()) {

7149 
	`wa™_ev’t_locked
(
sc¡_mgmt_cmd_li¡_wa™Q
,

7150 
	`‹¡_mgmt_cmd_li¡
(), 
lock_œq
,

7151 
sc¡_mcmd_lock
);

7153 !
	`li¡_em±y
(&
sc¡_aùive_mgmt_cmd_li¡
)) {

7154 
rc
;

7155 
sc¡_mgmt_cmd
 *
mcmd
;

7157 
mcmd
 = 
	`li¡_fœ¡_’Œy
(&
sc¡_aùive_mgmt_cmd_li¡
,

7158 
	`ty³of
(*
mcmd
), 
mgmt_cmd_li¡_’Œy
);

7159 
	`TRACE_MGMT_DBG
("Deleting mgmt cmd %p from‡ctive cmd "

7160 "li¡", 
mcmd
);

7161 
	`li¡_d–
(&
mcmd
->
mgmt_cmd_li¡_’Œy
);

7162 
	`¥š_uÆock_œq
(&
sc¡_mcmd_lock
);

7163 
rc
 = 
	`sc¡_´oûss_mgmt_cmd
(
mcmd
);

7164 
	`¥š_lock_œq
(&
sc¡_mcmd_lock
);

7165 ià(
rc
 > 0) {

7166 ià(
	`‹¡_b™
(
SCST_FLAG_SUSPENDED
, &
sc¡_æags
) &&

7167 !
	`‹¡_b™
(
SCST_FLAG_SUSPENDING
,

7168 &
sc¡_æags
)) {

7169 
	`TRACE_MGMT_DBG
("Adding mgmt cmd %po "

7171 
mcmd
);

7172 
	`li¡_add
(&
mcmd
->
mgmt_cmd_li¡_’Œy
,

7173 &
sc¡_d–ayed_mgmt_cmd_li¡
);

7175 
	`TRACE_MGMT_DBG
("Adding mgmt cmd %po "

7177 
mcmd
);

7178 
	`li¡_add
(&
mcmd
->
mgmt_cmd_li¡_’Œy
,

7179 &
sc¡_aùive_mgmt_cmd_li¡
);

7184 
	`¥š_uÆock_œq
(&
sc¡_mcmd_lock
);

7190 
	`sBUG_ON
(!
	`li¡_em±y
(&
sc¡_aùive_mgmt_cmd_li¡
));

7192 
	`PRINT_INFO
("Task managementhread finished");

7194 
	`TRACE_EXIT
();

7196 
	}
}

7198 
sc¡_mgmt_cmd
 *
	$sc¡_´e_rx_mgmt_cmd
(
sc¡_£ssiÚ


7199 *
£ss
, 
â
, 
©omic
, *
tgt_´iv
)

7201 
sc¡_mgmt_cmd
 *
mcmd
 = 
NULL
;

7203 
	`TRACE_ENTRY
();

7205 ià(
	`uÆik–y
(
£ss
->
tgt
->
tg‰
->
sk_mgmt_â_dÚe
 =ð
NULL
)) {

7206 
	`PRINT_ERROR
("New mgmt cmd, butask_mgmt_fn_done() is NULL "

7207 "Ñ¬g‘ %s)", 
£ss
->
tgt
->
tg‰
->
Çme
);

7208 
out
;

7211 
mcmd
 = 
	`sc¡_®loc_mgmt_cmd
(
©omic
 ? 
GFP_ATOMIC
 : 
GFP_KERNEL
);

7212 ià(
mcmd
 =ð
NULL
) {

7213 
	`PRINT_CRIT_ERROR
("Lo¡ TM fÀ%d, in™ŸtÜ %s", 
â
,

7214 
£ss
->
š™ŸtÜ_Çme
);

7215 
out
;

7218 
mcmd
->
£ss
 = sess;

7219 
	`sc¡_£ss_g‘
(
£ss
);

7221 
	`©omic_šc
(&
£ss
->
£ss_cmd_couÁ
);

7223 
mcmd
->
â
 = fn;

7224 
mcmd
->
¡©e
 = 
SCST_MCMD_STATE_INIT
;

7225 
mcmd
->
tgt_´iv
 =gt_priv;

7227 ià(
â
 =ð
SCST_PR_ABORT_ALL
) {

7228 
	`©omic_šc
(&
mcmd
->
Üigš_´_cmd
->
´_abÜt_couÁ”
->
´_abÜt_³ndšg_út
);

7229 
	`©omic_šc
(&
mcmd
->
Üigš_´_cmd
->
´_abÜt_couÁ”
->
´_abÜtšg_út
);

7232 
out
:

7233 
	`TRACE_EXIT
();

7234  
mcmd
;

7235 
	}
}

7237 
	$sc¡_po¡_rx_mgmt_cmd
(
sc¡_£ssiÚ
 *
£ss
,

7238 
sc¡_mgmt_cmd
 *
mcmd
)

7240 
æags
;

7241 
»s
 = 0;

7243 
	`TRACE_ENTRY
();

7245 ià(
	`uÆik–y
(
£ss
->
shut_pha£
 !ð
SCST_SESS_SPH_READY
)) {

7246 
	`PRINT_CRIT_ERROR
("New mgmt cmd while shutting downhe "

7247 "£ssiÚ %°shut_pha£ %ld", 
£ss
, sess->
shut_pha£
);

7248 
	`sBUG
();

7251 
	`loÿl_œq_§ve_nÜt
(
æags
);

7253 
	`¥š_lock
(&
£ss
->
£ss_li¡_lock
);

7255 ià(
	`uÆik–y
(
£ss
->
š™_pha£
 !ð
SCST_SESS_IPH_READY
)) {

7256 
£ss
->
š™_pha£
) {

7257 
SCST_SESS_IPH_INITING
:

7258 
	`TRACE_DBG
("Adding mcmd %po init deferred mcmd†ist",

7259 
mcmd
);

7260 
	`li¡_add_ž
(&
mcmd
->
mgmt_cmd_li¡_’Œy
,

7261 &
£ss
->
š™_deã¼ed_mcmd_li¡
);

7262 
out_uÆock
;

7263 
SCST_SESS_IPH_SUCCESS
:

7265 
SCST_SESS_IPH_FAILED
:

7266 
»s
 = -1;

7267 
out_uÆock
;

7269 
	`sBUG
();

7273 
	`¥š_uÆock
(&
£ss
->
£ss_li¡_lock
);

7275 
	`TRACE_MGMT_DBG
("Addšg mgmˆcmd %°tØaùivmgmˆcmd†i¡", 
mcmd
);

7276 
	`¥š_lock
(&
sc¡_mcmd_lock
);

7277 
	`li¡_add_ž
(&
mcmd
->
mgmt_cmd_li¡_’Œy
, &
sc¡_aùive_mgmt_cmd_li¡
);

7278 
	`¥š_uÆock
(&
sc¡_mcmd_lock
);

7280 
	`loÿl_œq_»¡Üe_nÜt
(
æags
);

7282 
	`wake_up
(&
sc¡_mgmt_cmd_li¡_wa™Q
);

7284 
out
:

7285 
	`TRACE_EXIT
();

7286  
»s
;

7288 
out_uÆock
:

7289 
	`¥š_uÆock
(&
£ss
->
£ss_li¡_lock
);

7290 
	`loÿl_œq_»¡Üe_nÜt
(
æags
);

7291 
out
;

7292 
	}
}

7305 
	$sc¡_rx_mgmt_â
(
sc¡_£ssiÚ
 *
£ss
,

7306 cÚ¡ 
sc¡_rx_mgmt_·¿ms
 *
·¿ms
)

7308 
»s
 = -
EFAULT
;

7309 
sc¡_mgmt_cmd
 *
mcmd
 = 
NULL
;

7310 
¡©e_Çme
[32];

7312 
	`TRACE_ENTRY
();

7314 
·¿ms
->
â
) {

7315 
SCST_ABORT_TASK
:

7316 
	`sBUG_ON
(!
·¿ms
->
g_£t
);

7318 
SCST_TARGET_RESET
:

7319 
SCST_ABORT_ALL_TASKS
:

7320 
SCST_NEXUS_LOSS
:

7321 
SCST_UNREG_SESS_TM
:

7324 
	`sBUG_ON
(!
·¿ms
->
lun_£t
);

7327 
mcmd
 = 
	`sc¡_´e_rx_mgmt_cmd
(
£ss
, 
·¿ms
->
â
,…¬ams->
©omic
,

7328 
·¿ms
->
tgt_´iv
);

7329 ià(
mcmd
 =ð
NULL
)

7330 
out
;

7332 ià(
·¿ms
->
lun_£t
) {

7333 
mcmd
->
lun
 = 
	`sc¡_uÅack_lun
(
·¿ms
->lun,…¬ams->
lun_Ën
);

7334 ià(
mcmd
->
lun
 =ð
NO_SUCH_LUN
)

7335 
out_ä“
;

7336 
mcmd
->
lun_£t
 = 1;

7339 ià(
·¿ms
->
g_£t
)

7340 
mcmd
->
g
 = 
·¿ms
->tag;

7342 
mcmd
->
cmd_¢_£t
 = 
·¿ms
->cmd_sn_set;

7343 
mcmd
->
cmd_¢
 = 
·¿ms
->cmd_sn;

7345 ià(
·¿ms
->
â
 < 
SCST_UNREG_SESS_TM
)

7346 
	`TRACE
(
TRACE_MGMT
, "TM fn %s/%d (mcmd %p, initiator %s,arget %s)",

7347 
	`sc¡_g‘_tm_â_Çme
(
¡©e_Çme
, (¡©e_Çme), 
·¿ms
->
â
),

7348 
·¿ms
->
â
, 
mcmd
, 
£ss
->
š™ŸtÜ_Çme
, sess->
tgt
->
tgt_Çme
);

7350 
	`TRACE_MGMT_DBG
("TM fn %s/%d (mcmd %p)",

7351 
	`sc¡_g‘_tm_â_Çme
(
¡©e_Çme
, (¡©e_Çme), 
·¿ms
->
â
),

7352 
·¿ms
->
â
, 
mcmd
);

7354 
	`TRACE_MGMT_DBG
("sess=%p,ag_set %d,ag %lld,†un_set %d, "

7355 "lun=%Îd, cmd_¢_£ˆ%d, cmd_¢ %d,…riv %p", 
£ss
,

7356 
·¿ms
->
g_£t
,

7357 ()
·¿ms
->
g
,

7358 
·¿ms
->
lun_£t
,

7359 ()
mcmd
->
lun
,

7360 
·¿ms
->
cmd_¢_£t
,

7361 
·¿ms
->
cmd_¢
,

7362 
·¿ms
->
tgt_´iv
);

7364 ià(
	`sc¡_po¡_rx_mgmt_cmd
(
£ss
, 
mcmd
) != 0)

7365 
out_ä“
;

7367 
»s
 = 0;

7369 
out
:

7370 
	`TRACE_EXIT_RES
(
»s
);

7371  
»s
;

7373 
out_ä“
:

7374 
	`sc¡_ä“_mgmt_cmd
(
mcmd
);

7375 
mcmd
 = 
NULL
;

7376 
out
;

7377 
	}
}

7378 
EXPORT_SYMBOL
(
sc¡_rx_mgmt_â
);

7393 
boÞ
 
	$__wždcmp
(cÚ¡ *
wžd
, cÚ¡ *
¡ršg
, 
»cursiÚ_Ëv–
)

7395 cÚ¡ *
ý
 = 
NULL
, *
mp
 = NULL;

7397 (*
¡ršg
è&& (*
wžd
 != '*')) {

7398 ià((*
wžd
 =ð'!'è&& (
»cursiÚ_Ëv–
 == 0))

7399  !
	`__wždcmp
(++
wžd
, 
¡ršg
, ++
»cursiÚ_Ëv–
);

7401 ià((
	`tÞow”
(*
wžd
è!ðtÞow”(*
¡ršg
)) && (*wild != '?'))

7402  
çl£
;

7404 
wžd
++;

7405 
¡ršg
++;

7408 *
¡ršg
) {

7409 ià((*
wžd
 =ð'!'è&& (
»cursiÚ_Ëv–
 == 0))

7410  !
	`__wždcmp
(++
wžd
, 
¡ršg
, ++
»cursiÚ_Ëv–
);

7412 ià(*
wžd
 == '*') {

7413 ià(!*++
wžd
)

7414  
Œue
;

7416 
mp
 = 
wžd
;

7417 
ý
 = 
¡ršg
+1;

7418 } ià((
	`tÞow”
(*
wžd
è=ðtÞow”(*
¡ršg
)) || (*wild == '?')) {

7419 
wžd
++;

7420 
¡ršg
++;

7422 
wžd
 = 
mp
;

7423 
¡ršg
 = 
ý
++;

7427 *
wžd
 == '*')

7428 
wžd
++;

7430  !*
wžd
;

7431 
	}
}

7456 
boÞ
 
	$wždcmp
(cÚ¡ *
wžd
, cÚ¡ *
¡ršg
)

7458  
	`__wždcmp
(
wžd
, 
¡ršg
, 0);

7459 
	}
}

7461 #ifdeà
CONFIG_SCST_PROC


7464 
sc¡_acg
 *
	$sc¡_fšd_acg_by_Çme_wžd
(cÚ¡ *
š™ŸtÜ_Çme
)

7466 
sc¡_acg
 *
acg
, *
»s
 = 
NULL
;

7467 
sc¡_aú
 *
n
;

7469 
	`TRACE_ENTRY
();

7471 
	`li¡_fÜ_—ch_’Œy
(
acg
, &
sc¡_acg_li¡
, 
acg_li¡_’Œy
) {

7472 
	`li¡_fÜ_—ch_’Œy
(
n
, &
acg
->
aú_li¡
, 
aú_li¡_’Œy
) {

7473 ià(
	`wždcmp
(
n
->
Çme
, 
š™ŸtÜ_Çme
)) {

7474 
	`TRACE_DBG
("Access control group %s found",

7475 
acg
->
acg_Çme
);

7476 
»s
 = 
acg
;

7477 
out
;

7482 
out
:

7483 
	`TRACE_EXIT_HRES
(
»s
);

7484  
»s
;

7485 
	}
}

7488 
sc¡_acg
 *
	$sc¡_fšd_acg_by_Çme
(cÚ¡ *
acg_Çme
)

7490 
sc¡_acg
 *
acg
, *
»s
 = 
NULL
;

7492 
	`TRACE_ENTRY
();

7494 
	`li¡_fÜ_—ch_’Œy
(
acg
, &
sc¡_acg_li¡
, 
acg_li¡_’Œy
) {

7495 ià(
	`¡rcmp
(
acg
->
acg_Çme
,‡cg_name) == 0) {

7496 
	`TRACE_DBG
("Access control group %s found",

7497 
acg
->
acg_Çme
);

7498 
»s
 = 
acg
;

7499 
out
;

7503 
out
:

7504 
	`TRACE_EXIT_HRES
(
»s
);

7505  
»s
;

7506 
	}
}

7511 
sc¡_acg
 *
	$sc¡_fšd_tgt_acg_by_Çme_wžd
(
sc¡_tgt
 *
tgt
,

7512 cÚ¡ *
š™ŸtÜ_Çme
)

7514 
sc¡_acg
 *
acg
, *
»s
 = 
NULL
;

7515 
sc¡_aú
 *
n
;

7517 
	`TRACE_ENTRY
();

7519 ià(
š™ŸtÜ_Çme
 =ð
NULL
)

7520 
out
;

7522 
	`li¡_fÜ_—ch_’Œy
(
acg
, &
tgt
->
tgt_acg_li¡
, 
acg_li¡_’Œy
) {

7523 
	`li¡_fÜ_—ch_’Œy
(
n
, &
acg
->
aú_li¡
, 
aú_li¡_’Œy
) {

7524 ià(
	`wždcmp
(
n
->
Çme
, 
š™ŸtÜ_Çme
)) {

7525 
	`TRACE_DBG
("Access control group %s found",

7526 
acg
->
acg_Çme
);

7527 
»s
 = 
acg
;

7528 
out
;

7533 
out
:

7534 
	`TRACE_EXIT_HRES
(
»s
);

7535  
»s
;

7536 
	}
}

7541 
sc¡_acg
 *
	$__sc¡_fšd_acg
(
sc¡_tgt
 *
tgt
,

7542 cÚ¡ *
š™ŸtÜ_Çme
)

7544 
sc¡_acg
 *
acg
 = 
NULL
;

7546 
	`TRACE_ENTRY
();

7548 #ifdeà
CONFIG_SCST_PROC


7549 ià(
š™ŸtÜ_Çme
)

7550 
acg
 = 
	`sc¡_fšd_acg_by_Çme_wžd
(
š™ŸtÜ_Çme
);

7551 ià((
acg
 =ð
NULL
è&& (
tgt
->
deçuÉ_group_Çme
 != NULL))

7552 
acg
 = 
	`sc¡_fšd_acg_by_Çme
(
tgt
->
deçuÉ_group_Çme
);

7553 ià(
acg
 =ð
NULL
)

7554 
acg
 = 
sc¡_deçuÉ_acg
;

7556 
acg
 = 
	`sc¡_fšd_tgt_acg_by_Çme_wžd
(
tgt
, 
š™ŸtÜ_Çme
);

7557 ià(
acg
 =ð
NULL
)

7558 
acg
 = 
tgt
->
deçuÉ_acg
;

7561 
	`TRACE_EXIT_HRES
(()
acg
);

7562  
acg
;

7563 
	}
}

7566 
sc¡_acg
 *
	$sc¡_fšd_acg
(cÚ¡ 
sc¡_£ssiÚ
 *
£ss
)

7568  
	`__sc¡_fšd_acg
(
£ss
->
tgt
, sess->
š™ŸtÜ_Çme
);

7569 
	}
}

7577 
boÞ
 
	$sc¡_š™ŸtÜ_has_luns
(
sc¡_tgt
 *
tgt
, cÚ¡ *
š™ŸtÜ_Çme
)

7579 
boÞ
 
»s
;

7580 
sc¡_acg
 *
acg
;

7582 
	`TRACE_ENTRY
();

7584 
	`mu‹x_lock
(&
sc¡_mu‹x
);

7586 
acg
 = 
	`__sc¡_fšd_acg
(
tgt
, 
š™ŸtÜ_Çme
);

7588 
»s
 = !
	`li¡_em±y
(&
acg
->
acg_dev_li¡
);

7590 ià(!
»s
)

7591 
	`sc¡_ev’t_queue_Ãg©ive_luns_šquœy
(
tgt
, 
š™ŸtÜ_Çme
);

7593 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

7595 
	`TRACE_EXIT_RES
(
»s
);

7596  
»s
;

7597 
	}
}

7598 
EXPORT_SYMBOL_GPL
(
sc¡_š™ŸtÜ_has_luns
);

7601 *
	$sc¡_g‘_unique_£ss_Çme
(
li¡_h—d
 *
sysfs_£ss_li¡
,

7602 cÚ¡ *
š™ŸtÜ_Çme
)

7604 *
Çme
 = (*)
š™ŸtÜ_Çme
;

7605 
sc¡_£ssiÚ
 *
s
;

7606 
Ën
 = 0, 
n
 = 1;

7608 
	`BUG_ON
(!
š™ŸtÜ_Çme
);

7609 
	`lockd•_as£¹_h–d
(&
sc¡_mu‹x
);

7611 
»¡¬t
:

7612 
	`li¡_fÜ_—ch_’Œy
(
s
, 
sysfs_£ss_li¡
, 
sysfs_£ss_li¡_’Œy
) {

7613 
	`BUG_ON
(!
s
->
£ss_Çme
);

7614 ià(
	`¡rcmp
(
Çme
, 
s
->
£ss_Çme
) == 0) {

7615 
	`TRACE_DBG
("Duplicated session fromhe same initiator "

7616 "% found", 
Çme
);

7618 ià(
Çme
 =ð
š™ŸtÜ_Çme
) {

7619 
Ën
 = 
	`¡¾’
(
š™ŸtÜ_Çme
) + 20;

7620 
Çme
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

7621 ià(
Çme
 =ð
NULL
) {

7622 
	`PRINT_ERROR
("Unableo‡llocate‡ "

7624 
Ën
);

7629 
	`¢´štf
(
Çme
, 
Ën
, "%s_%d", 
š™ŸtÜ_Çme
, 
n
);

7630 
n
++;

7631 
»¡¬t
;

7634  
Çme
;

7635 
	}
}

7637 
	$sc¡_š™_£ssiÚ
(
sc¡_£ssiÚ
 *
£ss
)

7639 
»s
 = 0;

7640 
sc¡_cmd
 *
cmd
, *
cmd_tmp
;

7641 
sc¡_mgmt_cmd
 *
mcmd
, *
tm
;

7642 
mwake
 = 0;

7644 
	`TRACE_ENTRY
();

7646 
	`mu‹x_lock
(&
sc¡_mu‹x
);

7648 
£ss
->
acg
 = 
	`sc¡_fšd_acg
(sess);

7650 
	`PRINT_INFO
("Using security group \"%s\" for initiator \"%s\" "

7651 "Ñ¬g‘ %s)", 
£ss
->
acg
->
acg_Çme
, sess->
š™ŸtÜ_Çme
,

7652 
£ss
->
tgt
->
tgt_Çme
);

7654 
	`sc¡_g‘_acg
(
£ss
->
acg
);

7655 
	`li¡_add_ž
(&
£ss
->
acg_£ss_li¡_’Œy
, &£ss->
acg
->
acg_£ss_li¡
);

7657 
	`TRACE_DBG
("Addšg ses %°tØtgt->£ss_li¡", 
£ss
);

7658 
	`li¡_add_ž
(&
£ss
->
£ss_li¡_’Œy
, &£ss->
tgt
->
£ss_li¡
);

7660 
	`INIT_LIST_HEAD
(&
£ss
->
sysfs_£ss_li¡_’Œy
);

7662 ià(
£ss
->
tgt
->
tg‰
->
g‘_š™ŸtÜ_pÜt_Œª¥Üt_id
 !ð
NULL
) {

7663 
»s
 = 
£ss
->
tgt
->
tg‰
->
	`g‘_š™ŸtÜ_pÜt_Œª¥Üt_id
(

7664 
£ss
->
tgt
, sess, &£ss->
Œª¥Üt_id
);

7665 ià(
»s
 != 0) {

7666 
	`PRINT_ERROR
("Unableo make initiator %s…ort "

7667 "Œª¥Üˆid", 
£ss
->
š™ŸtÜ_Çme
);

7668 
çžed
;

7670 
	`TRACE_PR
("£s %°(š˜%s),¿n¥Üˆid %s/%d", 
£ss
,

7671 
£ss
->
š™ŸtÜ_Çme
,

7672 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(

7673 
£ss
->
Œª¥Üt_id
), sess->
tgt
->
»l_tgt_id
);

7676 
»s
 = -
ENOMEM
;

7677 
£ss
->
£ss_Çme
 = 
	`sc¡_g‘_unique_£ss_Çme
(&£ss->
tgt
->
sysfs_£ss_li¡
,

7678 
£ss
->
š™ŸtÜ_Çme
);

7679 ià(!
£ss
->
£ss_Çme
)

7680 
çžed
;

7682 
»s
 = 
	`sc¡_£ss_sysfs_ü—‹
(
£ss
);

7683 ià(
»s
 != 0)

7684 
çžed
;

7686 
	`li¡_add_ž
(&
£ss
->
sysfs_£ss_li¡_’Œy
,

7687 &
£ss
->
tgt
->
sysfs_£ss_li¡
);

7693 
»s
 = 
	`sc¡_£ss_®loc_tgt_devs
(
£ss
);

7695 
çžed
:

7696 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

7698 ià(
£ss
->
š™_»suÉ_â
) {

7699 
	`TRACE_DBG
("C®lšg in™_»suÉ_â(%p)", 
£ss
);

7700 
£ss
->
	`š™_»suÉ_â
(£ss, sess->
»g_£ss_d©a
, 
»s
);

7701 
	`TRACE_DBG
("%s", "init_result_fn()„eturned");

7704 
	`¥š_lock_œq
(&
£ss
->
£ss_li¡_lock
);

7706 ià(
»s
 == 0)

7707 
£ss
->
š™_pha£
 = 
SCST_SESS_IPH_SUCCESS
;

7709 
£ss
->
š™_pha£
 = 
SCST_SESS_IPH_FAILED
;

7711 
	`li¡_fÜ_—ch_’Œy_§ã
(
cmd
, 
cmd_tmp
, &
£ss
->
š™_deã¼ed_cmd_li¡
,

7712 
cmd_li¡_’Œy
) {

7713 
	`TRACE_DBG
("D–‘šg cmd %°äom in™ deã¼ed cmd†i¡", 
cmd
);

7714 
	`li¡_d–
(&
cmd
->
cmd_li¡_’Œy
);

7715 
	`©omic_dec
(&
£ss
->
£ss_cmd_couÁ
);

7716 
	`¥š_uÆock_œq
(&
£ss
->
£ss_li¡_lock
);

7717 
	`sc¡_cmd_š™_dÚe
(
cmd
, 
SCST_CONTEXT_THREAD
);

7718 
	`¥š_lock_œq
(&
£ss
->
£ss_li¡_lock
);

7721 
	`¥š_lock
(&
sc¡_mcmd_lock
);

7722 
	`li¡_fÜ_—ch_’Œy_§ã
(
mcmd
, 
tm
, &
£ss
->
š™_deã¼ed_mcmd_li¡
,

7723 
mgmt_cmd_li¡_’Œy
) {

7724 
	`TRACE_DBG
("Moving mgmt command %p from init deferred mcmd†ist",

7725 
mcmd
);

7726 
	`li¡_move_ž
(&
mcmd
->
mgmt_cmd_li¡_’Œy
,

7727 &
sc¡_aùive_mgmt_cmd_li¡
);

7728 
mwake
 = 1;

7731 
	`¥š_uÆock
(&
sc¡_mcmd_lock
);

7736 
£ss
->
š™_pha£
 = 
SCST_SESS_IPH_READY
;

7737 
	`¥š_uÆock_œq
(&
£ss
->
£ss_li¡_lock
);

7739 ià(
mwake
)

7740 
	`wake_up
(&
sc¡_mgmt_cmd_li¡_wa™Q
);

7742 
	`sc¡_£ss_put
(
£ss
);

7744 
	`TRACE_EXIT
();

7745  
»s
;

7746 
	}
}

7791 
sc¡_£ssiÚ
 *
sc¡_»gi¡”_£ssiÚ
(
sc¡_tgt
 *
tgt
, 
©omic
,

7792 cÚ¡ *
š™ŸtÜ_Çme
, *
tgt_´iv
, *
»suÉ_â_d©a
,

7793 (*
»suÉ_â
)(
sc¡_£ssiÚ
 *
£ss
, *
d©a
, 
»suÉ
))

7795 
sc¡_£ssiÚ
 *
£ss
;

7796 
»s
;

7797 
æags
;

7799 
	`TRACE_ENTRY
();

7801 
£ss
 = 
	`sc¡_®loc_£ssiÚ
(
tgt
, 
©omic
 ? 
GFP_ATOMIC
 : 
GFP_KERNEL
,

7802 
š™ŸtÜ_Çme
);

7803 ià(
£ss
 =ð
NULL
)

7804 
out
;

7806 
	`sc¡_£ss_£t_tgt_´iv
(
£ss
, 
tgt_´iv
);

7808 
	`sc¡_£ss_g‘
(
£ss
);

7809 
	`sc¡_£ss_g‘
(
£ss
);

7811 ià(
©omic
) {

7812 
£ss
->
»g_£ss_d©a
 = 
»suÉ_â_d©a
;

7813 
£ss
->
š™_»suÉ_â
 = 
»suÉ_â
;

7814 
	`¥š_lock_œq§ve
(&
sc¡_mgmt_lock
, 
æags
);

7815 
	`TRACE_DBG
("Addšg ses %°tØsc¡_£ss_š™_li¡", 
£ss
);

7816 
	`li¡_add_ž
(&
£ss
->
£ss_š™_li¡_’Œy
,

7817 &
sc¡_£ss_š™_li¡
);

7818 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_mgmt_lock
, 
æags
);

7819 
	`wake_up
(&
sc¡_mgmt_wa™Q
);

7821 
»s
 = 
	`sc¡_š™_£ssiÚ
(
£ss
);

7822 ià(
»s
 != 0)

7823 
out_ä“
;

7826 
out
:

7827 
	`TRACE_EXIT
();

7828  
£ss
;

7830 
out_ä“
:

7831 
	`sc¡_ä“_£ssiÚ
(
£ss
);

7832 
£ss
 = 
NULL
;

7833 
out
;

7834 
	}
}

7835 
EXPORT_SYMBOL_GPL
(
sc¡_»gi¡”_£ssiÚ
);

7849 
sc¡_£ssiÚ
 *
	$sc¡_»gi¡”_£ssiÚ_nÚ_g¶
(
sc¡_tgt
 *
tgt
,

7850 cÚ¡ *
š™ŸtÜ_Çme
, *
tgt_´iv
)

7852  
	`sc¡_»gi¡”_£ssiÚ
(
tgt
, 0, 
š™ŸtÜ_Çme
, 
tgt_´iv
,

7853 
NULL
, NULL);

7854 
	}
}

7855 
EXPORT_SYMBOL
(
sc¡_»gi¡”_£ssiÚ_nÚ_g¶
);

7890 
sc¡_uÄegi¡”_£ssiÚ
(
sc¡_£ssiÚ
 *
£ss
, 
wa™
,

7891 (*
uÄeg_dÚe_â
)(
sc¡_£ssiÚ
 *
£ss
))

7893 
æags
;

7894 
	`DECLARE_COMPLETION_ONSTACK
(
c
);

7895 
rc
;

7897 
	`TRACE_ENTRY
();

7899 
	`TRACE_MGMT_DBG
("UÄegi¡”šg sessiÚ %°(wa™ %d)", 
£ss
, 
wa™
);

7901 
£ss
->
uÄeg_dÚe_â
 = unreg_done_fn;

7904 
rc
 = 
	`sc¡_rx_mgmt_â_lun
(
£ss
, 
SCST_UNREG_SESS_TM
,

7905 
NULL
, 0, 
SCST_ATOMIC
, NULL);

7906 ià(
rc
 != 0) {

7907 
	`PRINT_ERROR
("SCST_UNREG_SESS_TM failed %d (sess %p)",

7908 
rc
, 
£ss
);

7911 
£ss
->
shut_pha£
 = 
SCST_SESS_SPH_SHUTDOWN
;

7913 
	`¥š_lock_œq§ve
(&
sc¡_mgmt_lock
, 
æags
);

7915 ià(
wa™
)

7916 
£ss
->
shutdown_com¶
 = &
c
;

7918 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_mgmt_lock
, 
æags
);

7920 
	`sc¡_£ss_put
(
£ss
);

7922 ià(
wa™
) {

7923 
	`TRACE_DBG
("Wa™šg fÜ sessiÚ %°tØcom¶‘e", 
£ss
);

7924 
	`wa™_fÜ_com¶‘iÚ
(&
c
);

7927 
	`TRACE_EXIT
();

7929 
	}
}

7930 
EXPORT_SYMBOL_GPL
(
sc¡_uÄegi¡”_£ssiÚ
);

7940 
	$sc¡_uÄegi¡”_£ssiÚ_nÚ_g¶
(
sc¡_£ssiÚ
 *
£ss
)

7942 
	`TRACE_ENTRY
();

7944 
	`sc¡_uÄegi¡”_£ssiÚ
(
£ss
, 1, 
NULL
);

7946 
	`TRACE_EXIT
();

7948 
	}
}

7949 
EXPORT_SYMBOL
(
sc¡_uÄegi¡”_£ssiÚ_nÚ_g¶
);

7951 
šlše
 
	$‹¡_mgmt_li¡
()

7953 
»s
 = !
	`li¡_em±y
(&
sc¡_£ss_š™_li¡
) ||

7954 !
	`li¡_em±y
(&
sc¡_£ss_shut_li¡
) ||

7955 
	`uÆik–y
(
	`kth»ad_should_¡Ý
());

7956  
»s
;

7957 
	}
}

7959 
	$sc¡_glob®_mgmt_th»ad
(*
¬g
)

7961 
sc¡_£ssiÚ
 *
£ss
;

7963 
	`TRACE_ENTRY
();

7965 
	`PRINT_INFO
("Managementhread started");

7967 
cu¼’t
->
æags
 |ð
PF_NOFREEZE
;

7969 
	`£t_u£r_niû
(
cu¼’t
, -10);

7971 
	`¥š_lock_œq
(&
sc¡_mgmt_lock
);

7972 !
	`kth»ad_should_¡Ý
()) {

7973 
	`wa™_ev’t_locked
(
sc¡_mgmt_wa™Q
, 
	`‹¡_mgmt_li¡
(), 
lock_œq
,

7974 
sc¡_mgmt_lock
);

7976 !
	`li¡_em±y
(&
sc¡_£ss_š™_li¡
)) {

7977 
£ss
 = 
	`li¡_fœ¡_’Œy
(&
sc¡_£ss_š™_li¡
,

7978 
	`ty³of
(*
£ss
), 
£ss_š™_li¡_’Œy
);

7979 
	`TRACE_DBG
("Removing sess %p from scst_sess_init_list",

7980 
£ss
);

7981 
	`li¡_d–
(&
£ss
->
£ss_š™_li¡_’Œy
);

7982 
	`¥š_uÆock_œq
(&
sc¡_mgmt_lock
);

7984 ià(
£ss
->
š™_pha£
 =ð
SCST_SESS_IPH_INITING
) {

7990 
	`sc¡_š™_£ssiÚ
(
£ss
);

7992 
	`PRINT_CRIT_ERROR
("session %p is in "

7994 "š™…ha£ %x", 
£ss
,

7995 
£ss
->
š™_pha£
);

7996 
	`sBUG
();

7999 
	`¥š_lock_œq
(&
sc¡_mgmt_lock
);

8002 !
	`li¡_em±y
(&
sc¡_£ss_shut_li¡
)) {

8003 
£ss
 = 
	`li¡_fœ¡_’Œy
(&
sc¡_£ss_shut_li¡
,

8004 
	`ty³of
(*
£ss
), 
£ss_shut_li¡_’Œy
);

8005 
	`TRACE_DBG
("Removing sess %p from scst_sess_shut_list",

8006 
£ss
);

8007 
	`li¡_d–
(&
£ss
->
£ss_shut_li¡_’Œy
);

8008 
	`¥š_uÆock_œq
(&
sc¡_mgmt_lock
);

8010 
£ss
->
shut_pha£
) {

8011 
SCST_SESS_SPH_SHUTDOWN
:

8012 
	`sBUG_ON
(
	`©omic_»ad
(&
£ss
->
»fút
) != 0);

8013 
	`sc¡_ä“_£ssiÚ_ÿÎback
(
£ss
);

8016 
	`PRINT_CRIT_ERROR
("session %p is in "

8018 "shuˆpha£ %lx", 
£ss
,

8019 
£ss
->
shut_pha£
);

8020 
	`sBUG
();

8024 
	`¥š_lock_œq
(&
sc¡_mgmt_lock
);

8027 
	`¥š_uÆock_œq
(&
sc¡_mgmt_lock
);

8033 
	`sBUG_ON
(!
	`li¡_em±y
(&
sc¡_£ss_š™_li¡
));

8034 
	`sBUG_ON
(!
	`li¡_em±y
(&
sc¡_£ss_shut_li¡
));

8036 
	`PRINT_INFO
("Managementhread finished");

8038 
	`TRACE_EXIT
();

8040 
	}
}

8043 
sc¡_cmd
 *
	$__sc¡_fšd_cmd_by_g
(
sc¡_£ssiÚ
 *
£ss
,

8044 
ušt64_t
 
g
, 
boÞ
 
to_abÜt
)

8046 
sc¡_cmd
 *
cmd
, *
»s
 = 
NULL
;

8048 
	`TRACE_ENTRY
();

8052 
	`TRACE_DBG
("%s (sess=%p,ag=%llu)", "Searching in sess cmd†ist",

8053 
£ss
, ()
g
);

8055 
	`li¡_fÜ_—ch_’Œy
(
cmd
, &
£ss
->
£ss_cmd_li¡
,

8056 
£ss_cmd_li¡_’Œy
) {

8057 ià((
cmd
->
g
 =ðgè&& 
	`lik–y
(!cmd->
š‹º®
)) {

8067 ià(
cmd
->
dÚe
) {

8068 ià(
to_abÜt
) {

8073 ià(
»s
 =ð
NULL
)

8074 
»s
 = 
cmd
;

8076 ià(
	`‹¡_b™
(
SCST_CMD_ABORTED
,

8077 &
»s
->
cmd_æags
)) {

8078 
»s
 = 
cmd
;

8079 } ià(!
	`‹¡_b™
(
SCST_CMD_ABORTED
,

8080 &
cmd
->
cmd_æags
))

8081 
»s
 = 
cmd
;

8086 
»s
 = 
cmd
;

8092 
	`TRACE_EXIT
();

8093  
»s
;

8094 
	}
}

8103 
sc¡_cmd
 *
sc¡_fšd_cmd
(
sc¡_£ssiÚ
 *
£ss
, *
d©a
,

8104 (*
cmp_â
)(
sc¡_cmd
 *
cmd
,

8105 *
d©a
))

8107 
sc¡_cmd
 *
cmd
 = 
NULL
;

8108 
æags
 = 0;

8110 
	`TRACE_ENTRY
();

8112 ià(
cmp_â
 =ð
NULL
)

8113 
out
;

8115 
	`¥š_lock_œq§ve
(&
£ss
->
£ss_li¡_lock
, 
æags
);

8117 
	`TRACE_DBG
("S—rchšg iÀ£s cmd†i¡ (£ss=%p)", 
£ss
);

8118 
	`li¡_fÜ_—ch_’Œy
(
cmd
, &
£ss
->
£ss_cmd_li¡
, 
£ss_cmd_li¡_’Œy
) {

8126 ià(
cmd
->
dÚe
)

8128 ià(
	`cmp_â
(
cmd
, 
d©a
è&& 
	`lik–y
(!cmd->
š‹º®
))

8129 
out_uÆock
;

8132 
cmd
 = 
NULL
;

8134 
out_uÆock
:

8135 
	`¥š_uÆock_œq»¡Üe
(&
£ss
->
£ss_li¡_lock
, 
æags
);

8137 
out
:

8138 
	`TRACE_EXIT
();

8139  
cmd
;

8140 
	}
}

8141 
EXPORT_SYMBOL
(
sc¡_fšd_cmd
);

8150 
sc¡_cmd
 *
	$sc¡_fšd_cmd_by_g
(
sc¡_£ssiÚ
 *
£ss
,

8151 
ušt64_t
 
g
)

8153 
æags
;

8154 
sc¡_cmd
 *
cmd
;

8156 
	`¥š_lock_œq§ve
(&
£ss
->
£ss_li¡_lock
, 
æags
);

8157 
cmd
 = 
	`__sc¡_fšd_cmd_by_g
(
£ss
, 
g
, 
çl£
);

8158 
	`¥š_uÆock_œq»¡Üe
(&
£ss
->
£ss_li¡_lock
, 
æags
);

8159  
cmd
;

8160 
	}
}

8161 
EXPORT_SYMBOL
(
sc¡_fšd_cmd_by_g
);

	@scst/src/scst_tg.c

18 
	~<lšux/moduË·¿m.h
>

19 
	~<lšux/d–ay.h
>

20 
	~<lšux/kmod.h
>

21 
	~<asm/uÇligÃd.h
>

22 #ifdeà
INSIDE_KERNEL_TREE


23 
	~<sc¡/sc¡.h
>

24 
	~<sc¡/sc¡_ev’t.h
>

26 
	~"sc¡.h
"

27 
	~"sc¡_ev’t.h
"

29 
	~"sc¡_´iv.h
"

30 
	~"sc¡_´es.h
"

32 
	s®ua_¡©e_ªd_Çme
 {

33 
sc¡_tg_¡©e
 
	ms
;

34 *
	mn
;

37 cÚ¡ 
®ua_¡©e_ªd_Çme
 
	gsc¡_tg_¡©e_Çmes
[] = {

38 { 
SCST_TG_STATE_OPTIMIZED
, "active" },

39 { 
SCST_TG_STATE_NONOPTIMIZED
, "nonoptimized" },

40 { 
SCST_TG_STATE_STANDBY
, "standby" },

41 { 
SCST_TG_STATE_UNAVAILABLE
, "unavailable" },

42 { 
SCST_TG_STATE_OFFLINE
, "offline" },

43 { 
SCST_TG_STATE_TRANSITIONING
, "transitioning" },

50 
DEFINE_MUTEX
(
sc¡_dg_mu‹x
);

51 
LIST_HEAD
(
sc¡_dev_group_li¡
);

53 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 31) || \

54 
defšed
(
RHEL_MAJOR
è&& 
	gRHEL_MAJOR
 -0 <= 5

55 
®ua_šv¬ŸÁ_check
;

57 
boÞ
 
	g®ua_šv¬ŸÁ_check
;

59 
moduË_·¿m
(
®ua_šv¬ŸÁ_check
, 
boÞ
, 0644);

60 
MODULE_PARM_DESC
(
®ua_šv¬ŸÁ_check
,

63 cÚ¡ *
	$sc¡_®ua_¡©e_Çme
(
sc¡_tg_¡©e
 
s
)

65 
i
;

67 
i
 = 0; i < 
	`ARRAY_SIZE
(
sc¡_tg_¡©e_Çmes
); i++)

68 ià(
sc¡_tg_¡©e_Çmes
[
i
].
s
 == s)

69  
sc¡_tg_¡©e_Çmes
[
i
].
n
;

71  
NULL
;

72 
	}
}

73 
EXPORT_SYMBOL
(
sc¡_®ua_¡©e_Çme
);

75 
sc¡_tg_¡©e
 
	$sc¡_®ua_Çme_to_¡©e
(cÚ¡ *
n
)

77 
i
;

79 
i
 = 0; i < 
	`ARRAY_SIZE
(
sc¡_tg_¡©e_Çmes
); i++)

80 ià(
	`¡rcmp
(
sc¡_tg_¡©e_Çmes
[
i
].
n
,‚) == 0)

81  
sc¡_tg_¡©e_Çmes
[
i
].
s
;

83  
SCST_TG_STATE_UNDEFINED
;

84 
	}
}

87 
sc¡_deviû
 *
	$__lookup_dev
(cÚ¡ *
Çme
)

89 
sc¡_deviû
 *
dev
;

91 
	`lockd•_as£¹_h–d
(&
sc¡_dg_mu‹x
);

93 
	`li¡_fÜ_—ch_’Œy
(
dev
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
)

94 ià(
	`¡rcmp
(
dev
->
vœt_Çme
, 
Çme
) == 0)

95  
dev
;

97  
NULL
;

98 
	}
}

101 
sc¡_tgt
 *
	$__lookup_tgt
(cÚ¡ *
Çme
)

103 
sc¡_tgt_‹m¶©e
 *
t
;

104 
sc¡_tgt
 *
tgt
;

106 
	`lockd•_as£¹_h–d
(&
sc¡_mu‹x
);

108 
	`li¡_fÜ_—ch_’Œy
(
t
, &
sc¡_‹m¶©e_li¡
, 
sc¡_‹m¶©e_li¡_’Œy
)

109 
	`li¡_fÜ_—ch_’Œy
(
tgt
, &
t
->
tgt_li¡
, 
tgt_li¡_’Œy
)

110 ià(
	`¡rcmp
(
tgt
->
tgt_Çme
, 
Çme
) == 0)

111  
tgt
;

113  
NULL
;

114 
	}
}

117 
sc¡_tg_tgt
 *
	$__lookup_dg_tgt
(
sc¡_dev_group
 *
dg
,

118 cÚ¡ *
tgt_Çme
)

120 
sc¡_rg‘_group
 *
tg
;

121 
sc¡_tg_tgt
 *
tg_tgt
;

123 
	`lockd•_as£¹_h–d
(&
sc¡_dg_mu‹x
);

125 
	`BUG_ON
(!
dg
);

126 
	`BUG_ON
(!
tgt_Çme
);

127 
	`li¡_fÜ_—ch_’Œy
(
tg
, &
dg
->
tg_li¡
, 
’Œy
)

128 
	`li¡_fÜ_—ch_’Œy
(
tg_tgt
, &
tg
->
tgt_li¡
, 
’Œy
)

129 ià(
	`¡rcmp
(
tg_tgt
->
Çme
, 
tgt_Çme
) == 0)

130  
tg_tgt
;

132  
NULL
;

133 
	}
}

136 
sc¡_rg‘_group
 *
	$__lookup_tg_by_Çme
(
sc¡_dev_group
 *
dg
,

137 cÚ¡ *
Çme
)

139 
sc¡_rg‘_group
 *
tg
;

141 
	`lockd•_as£¹_h–d
(&
sc¡_dg_mu‹x
);

143 
	`li¡_fÜ_—ch_’Œy
(
tg
, &
dg
->
tg_li¡
, 
’Œy
)

144 ià(
	`¡rcmp
(
tg
->
Çme
,‚ame) == 0)

145  
tg
;

147  
NULL
;

148 
	}
}

151 
sc¡_rg‘_group
 *
	$__lookup_tg_by_group_id
(
sc¡_dev_group
 *
dg
,

152 
ušt16_t
 
group_id
)

154 
sc¡_rg‘_group
 *
tg
;

156 
	`lockd•_as£¹_h–d
(&
sc¡_mu‹x
);

158 
	`li¡_fÜ_—ch_’Œy
(
tg
, &
dg
->
tg_li¡
, 
’Œy
)

159 ià(
tg
->
group_id
 == group_id)

160  
tg
;

162  
NULL
;

163 
	}
}

166 
sc¡_rg‘_group
 *
	$__lookup_tg_by_tgt
(
sc¡_dev_group
 *
dg
,

167 cÚ¡ 
sc¡_tgt
 *
tgt
)

169 
sc¡_rg‘_group
 *
tg
;

170 
sc¡_tg_tgt
 *
tg_tgt
;

172 
	`lockd•_as£¹_h–d
(&
sc¡_dg_mu‹x
);

174 
	`li¡_fÜ_—ch_’Œy
(
tg
, &
dg
->
tg_li¡
, 
’Œy
)

175 
	`li¡_fÜ_—ch_’Œy
(
tg_tgt
, &
tg
->
tgt_li¡
, 
’Œy
)

176 ià(
tg_tgt
->
tgt
 ==gt)

177  
tg
;

179  
NULL
;

180 
	}
}

183 
sc¡_dg_dev
 *
	$__lookup_dg_dev_by_dev
(
sc¡_dev_group
 *
dg
,

184 
sc¡_deviû
 *
dev
)

186 
sc¡_dg_dev
 *
dgd
;

188 
	`lockd•_as£¹_h–d
(&
sc¡_dg_mu‹x
);

190 
	`li¡_fÜ_—ch_’Œy
(
dgd
, &
dg
->
dev_li¡
, 
’Œy
)

191 ià(
dgd
->
dev
 == dev)

192  
dgd
;

194  
NULL
;

195 
	}
}

198 
sc¡_dg_dev
 *
	$__lookup_dg_dev_by_Çme
(
sc¡_dev_group
 *
dg
,

199 cÚ¡ *
Çme
)

201 
sc¡_dg_dev
 *
dgd
;

203 
	`lockd•_as£¹_h–d
(&
sc¡_dg_mu‹x
);

205 
	`li¡_fÜ_—ch_’Œy
(
dgd
, &
dg
->
dev_li¡
, 
’Œy
)

206 ià(
	`¡rcmp
(
dgd
->
dev
->
vœt_Çme
, 
Çme
) == 0)

207  
dgd
;

209  
NULL
;

210 
	}
}

213 
sc¡_dg_dev
 *
	$__glob®_lookup_dg_dev_by_Çme
(cÚ¡ *
Çme
)

215 
sc¡_dev_group
 *
dg
;

216 
sc¡_dg_dev
 *
dgd
;

218 
	`lockd•_as£¹_h–d
(&
sc¡_dg_mu‹x
);

220 
	`li¡_fÜ_—ch_’Œy
(
dg
, &
sc¡_dev_group_li¡
, 
’Œy
) {

221 
dgd
 = 
	`__lookup_dg_dev_by_Çme
(
dg
, 
Çme
);

222 ià(
dgd
)

223  
dgd
;

225  
NULL
;

226 
	}
}

229 
sc¡_dev_group
 *
	$__lookup_dg_by_Çme
(cÚ¡ *
Çme
)

231 
sc¡_dev_group
 *
dg
;

233 
	`lockd•_as£¹_h–d
(&
sc¡_dg_mu‹x
);

235 
	`li¡_fÜ_—ch_’Œy
(
dg
, &
sc¡_dev_group_li¡
, 
’Œy
)

236 ià(
	`¡rcmp
(
dg
->
Çme
,‚ame) == 0)

237  
dg
;

239  
NULL
;

240 
	}
}

243 
sc¡_dev_group
 *
	$__lookup_dg_by_dev
(
sc¡_deviû
 *
dev
)

245 
sc¡_dev_group
 *
dg
;

247 
	`lockd•_as£¹_h–d
(&
sc¡_dg_mu‹x
);

249 
	`li¡_fÜ_—ch_’Œy
(
dg
, &
sc¡_dev_group_li¡
, 
’Œy
)

250 ià(
	`__lookup_dg_dev_by_dev
(
dg
, 
dev
))

251  
dg
;

253  
NULL
;

254 
	}
}

260 
	$sc¡_»Ëa£_tg_tgt
(
kobjeù
 *
kobj
)

262 
sc¡_tg_tgt
 *
tg_tgt
;

264 
tg_tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tg_tgt
, kobj);

265 
	`kä“
(
tg_tgt
->
Çme
);

266 
	`kä“
(
tg_tgt
);

267 
	}
}

269 
kobj_ty³
 
	gsc¡_tg_tgt_kty³
 = {

270 #iâdeà
CONFIG_SCST_PROC


271 .
sysfs_Ýs
 = &
sc¡_sysfs_Ýs
,

273 .
	g»Ëa£
 = 
sc¡_»Ëa£_tg_tgt
,

279 
	$sc¡_tg_acû±_¡ªdby
(
sc¡_cmd
 *
cmd
)

281 
»s
;

283 
	`TRACE_ENTRY
();

285 
cmd
->
cdb
[0]) {

286 
TEST_UNIT_READY
:

287 
GET_EVENT_STATUS_NOTIFICATION
:

288 
INQUIRY
:

289 
MODE_SENSE
:

290 
MODE_SENSE_10
:

291 
READ_CAPACITY
:

292 
REPORT_LUNS
:

293 
REQUEST_SENSE
:

294 
RELEASE
:

295 
RELEASE_10
:

296 
RESERVE
:

297 
RESERVE_10
:

298 
READ_BUFFER
:

299 
WRITE_BUFFER
:

300 
MODE_SELECT
:

301 
MODE_SELECT_10
:

302 
LOG_SELECT
:

303 
LOG_SENSE
:

304 
RECEIVE_DIAGNOSTIC
:

305 
SEND_DIAGNOSTIC
:

306 
PERSISTENT_RESERVE_IN
:

307 
PERSISTENT_RESERVE_OUT
:

308 
»s
 = 
SCST_ALUA_CHECK_OK
;

309 
out
;

310 
SERVICE_ACTION_IN_16
:

311 
cmd
->
cdb
[1] & 0x1f) {

312 
SAI_READ_CAPACITY_16
:

313 
»s
 = 
SCST_ALUA_CHECK_OK
;

314 
out
;

317 
MAINTENANCE_IN
:

318 
cmd
->
cdb
[1] & 0x1f) {

319 
MI_REPORT_TARGET_PGS
:

320 
»s
 = 
SCST_ALUA_CHECK_OK
;

321 
out
;

324 
MAINTENANCE_OUT
:

325 
cmd
->
cdb
[1] & 0x1f) {

326 
MO_SET_TARGET_PGS
:

327 
»s
 = 
SCST_ALUA_CHECK_OK
;

328 
out
;

333 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_®ua_¡ªdby
));

334 
»s
 = 
SCST_ALUA_CHECK_ERROR
;

336 
out
:

337 
	`TRACE_EXIT_RES
(
»s
);

338  
»s
;

339 
	}
}

344 
	$sc¡_tg_acû±_uÇv
(
sc¡_cmd
 *
cmd
)

346 
»s
;

348 
	`TRACE_ENTRY
();

350 
cmd
->
cdb
[0]) {

351 
TEST_UNIT_READY
:

352 
GET_EVENT_STATUS_NOTIFICATION
:

353 
INQUIRY
:

354 
MODE_SENSE
:

355 
MODE_SENSE_10
:

356 
READ_CAPACITY
:

357 
REPORT_LUNS
:

358 
REQUEST_SENSE
:

359 
RELEASE
:

360 
RELEASE_10
:

361 
RESERVE
:

362 
RESERVE_10
:

363 
READ_BUFFER
:

364 
WRITE_BUFFER
:

365 
»s
 = 
SCST_ALUA_CHECK_OK
;

366 
out
;

367 
SERVICE_ACTION_IN_16
:

368 
cmd
->
cdb
[1] & 0x1f) {

369 
SAI_READ_CAPACITY_16
:

370 
»s
 = 
SCST_ALUA_CHECK_OK
;

371 
out
;

374 
MAINTENANCE_IN
:

375 
cmd
->
cdb
[1] & 0x1f) {

376 
MI_REPORT_TARGET_PGS
:

377 
»s
 = 
SCST_ALUA_CHECK_OK
;

378 
out
;

381 
MAINTENANCE_OUT
:

382 
cmd
->
cdb
[1] & 0x1f) {

383 
MO_SET_TARGET_PGS
:

384 
»s
 = 
SCST_ALUA_CHECK_OK
;

385 
out
;

390 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_®ua_uÇv
));

391 
»s
 = 
SCST_ALUA_CHECK_ERROR
;

393 
out
:

394 
	`TRACE_EXIT_RES
(
»s
);

395  
»s
;

396 
	}
}

398 
	ssc¡_®ua_»Œy
 {

399 
sc¡_cmd
 *
	m®ua_»Œy_cmd
;

400 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 20)

401 
wÜk_¡ruù
 
	m®ua_»Œy_wÜk
;

403 
d–ayed_wÜk
 
	m®ua_»Œy_wÜk
;

407 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 20)

408 
	$sc¡_®ua_Œªs™iÚšg_wÜk_â
(*
p
)

410 
sc¡_®ua_»Œy
 *
»Œy
 = 
p
;

412 
	$sc¡_®ua_Œªs™iÚšg_wÜk_â
(
wÜk_¡ruù
 *
wÜk
)

414 
sc¡_®ua_»Œy
 *
»Œy
 =

415 
	`cÚš”_of
(
wÜk
, 
sc¡_®ua_»Œy
,

416 
®ua_»Œy_wÜk
.
wÜk
);

418 
sc¡_cmd
 *
cmd
 = 
»Œy
->
®ua_»Œy_cmd
;

420 
	`TRACE_ENTRY
();

422 
	`TRACE_DBG
("R‘ryšg¿ns™iÚšg cmd %p", 
cmd
);

424 
	`¥š_lock_œq
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

425 
	`li¡_add
(&
cmd
->
cmd_li¡_’Œy
,

426 &
cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

427 
	`wake_up
(&
cmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

428 
	`¥š_uÆock_œq
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

430 
	`kä“
(
»Œy
);

432 
	`TRACE_EXIT
();

434 
	}
}

439 
	$sc¡_tg_acû±_Œªs™iÚšg
(
sc¡_cmd
 *
cmd
)

441 
»s
;

443 
	`TRACE_ENTRY
();

445 
cmd
->
cdb
[0]) {

446 
INQUIRY
:

447 
READ_CAPACITY
:

448 
REPORT_LUNS
:

449 
REQUEST_SENSE
:

450 
READ_BUFFER
:

451 
WRITE_BUFFER
:

452 
»s
 = 
SCST_ALUA_CHECK_OK
;

453 
out
;

454 
SERVICE_ACTION_IN_16
:

455 
cmd
->
cdb
[1] & 0x1f) {

456 
SAI_READ_CAPACITY_16
:

457 
»s
 = 
SCST_ALUA_CHECK_OK
;

458 
out
;

463 ià(
cmd
->
®»ady_Œªs™iÚšg
)

464 
	`TRACE_DBG
("cmd %°®»ady¿ns™iÚed checked, fažšg", 
cmd
);

466 
sc¡_®ua_»Œy
 *
»Œy
;

468 
	`TRACE_DBG
("ALUA¿ns™iÚšg: d–ayšg cmd %p", 
cmd
);

470 
»Œy
 = 
	`kz®loc
((*»Œy), 
GFP_KERNEL
);

471 ià(
»Œy
 =ð
NULL
) {

472 
	`TRACE_DBG
("Unableo‡llocate ALUA„etry "

473 "¡ruù, fažšg cmd %p", 
cmd
);

474 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

475 
	`SCST_LOAD_SENSE
(
sc¡_£n£_®ua_Œªs™iÚšg
));

476 
»s
 = 
SCST_ALUA_CHECK_ERROR
;

477 
out
;

481 
»Œy
->
®ua_»Œy_cmd
 = 
cmd
;

482 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 20)

483 
	`INIT_WORK
(&
»Œy
->
®ua_»Œy_wÜk
,

484 
sc¡_®ua_Œªs™iÚšg_wÜk_â
, 
»Œy
);

486 
	`INIT_DELAYED_WORK
(&
»Œy
->
®ua_»Œy_wÜk
,

487 
sc¡_®ua_Œªs™iÚšg_wÜk_â
);

489 
cmd
->
®»ady_Œªs™iÚšg
 = 1;

490 
	`scheduË_d–ayed_wÜk
(&
»Œy
->
®ua_»Œy_wÜk
, 
HZ
/2);

491 
»s
 = 
SCST_ALUA_CHECK_DELAYED
;

492 
out
;

495 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

496 
	`SCST_LOAD_SENSE
(
sc¡_£n£_®ua_Œªs™iÚšg
));

497 
»s
 = 
SCST_ALUA_CHECK_ERROR
;

499 
out
:

500 
	`TRACE_EXIT_RES
(
»s
);

501  
»s
;

502 
	}
}

504 (*
sc¡_®ua_fž‹r
[])(
sc¡_cmd
 *
cmd
) = {

505 [
SCST_TG_STATE_OPTIMIZED
] = 
NULL
,

506 [
SCST_TG_STATE_NONOPTIMIZED
] = 
NULL
,

507 [
SCST_TG_STATE_STANDBY
] = 
sc¡_tg_acû±_¡ªdby
,

508 [
SCST_TG_STATE_UNAVAILABLE
] = 
sc¡_tg_acû±_uÇv
,

509 [
SCST_TG_STATE_LBA_DEPENDENT
] = 
NULL
,

510 [
SCST_TG_STATE_OFFLINE
] = 
sc¡_tg_acû±_uÇv
,

511 [
SCST_TG_STATE_TRANSITIONING
] = 
sc¡_tg_acû±_Œªs™iÚšg
,

512 
	}
};

518 
	$sc¡_check_®ua_šv¬ŸÁ
()

520 
sc¡_deviû
 *
dev
;

521 
sc¡_tgt_dev
 *
tgt_dev
;

522 
sc¡_dev_group
 *
dg
;

523 
sc¡_rg‘_group
 *
tg
;

524 
sc¡_tg_¡©e
 
ex³ùed_¡©e
;

527 
	`lockd•_as£¹_h–d
(&
sc¡_mu‹x
);

529 
	`lockd•_as£¹_h–d
(&
sc¡_dg_mu‹x
);

531 ià(!
®ua_šv¬ŸÁ_check
)

534 
	`li¡_fÜ_—ch_’Œy
(
dev
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

535 
dg
 = 
	`__lookup_dg_by_dev
(
dev
);

536 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

537 
dev_tgt_dev_li¡_’Œy
) {

538 
tg
 = 
dg
 ?

539 
	`__lookup_tg_by_tgt
(
dg
, 
tgt_dev
->
acg_dev
->
acg
->
tgt
) :

540 
NULL
;

541 
ex³ùed_¡©e
 = 
tg
 ?g->
¡©e
 :

542 
SCST_TG_STATE_OPTIMIZED
;

543 ià(
tgt_dev
->
®ua_fž‹r
 !=

544 
sc¡_®ua_fž‹r
[
ex³ùed_¡©e
]) {

545 
	`PRINT_ERROR
("LUN %s/%s/%s/%lld/%s: ALUA filter"

547 
tgt_dev
->
acg_dev
->
acg
->
tgt
->
tgt_Çme
,

548 
tgt_dev
->
acg_dev
->
acg
->
acg_Çme
 ? :

550 
tgt_dev
->
£ss
->
š™ŸtÜ_Çme
,

551 
tgt_dev
->
lun
,

552 
tgt_dev
->
dev
->
vœt_Çme
 ? : "(null)",

553 
tgt_dev
->
®ua_fž‹r
,

554 
sc¡_®ua_fž‹r
[
ex³ùed_¡©e
]);

558 
	}
}

561 
	$sc¡_upd©e_tgt_dev_®ua_fž‹r
(
sc¡_tgt_dev
 *
tgt_dev
,

562 
sc¡_tg_¡©e
 
¡©e
)

564 
	`lockd•_as£¹_h–d
(&
sc¡_dg_mu‹x
);

566 
tgt_dev
->
®ua_fž‹r
 = 
sc¡_®ua_fž‹r
[
¡©e
];

567 
	}
}

570 
	$sc¡_tg_chªge_tgt_dev_¡©e
(
sc¡_tgt_dev
 *
tgt_dev
,

571 
sc¡_tg_¡©e
 
¡©e
,

572 
boÞ
 
g’_ua
)

574 
	`lockd•_as£¹_h–d
(&
sc¡_dg_mu‹x
);

576 
	`TRACE_MGMT_DBG
("ALUA state ofgt_dev %p has changed (gen_ua %d)",

577 
tgt_dev
, 
g’_ua
);

579 
	`sc¡_upd©e_tgt_dev_®ua_fž‹r
(
tgt_dev
, 
¡©e
);

580 ià(
g’_ua
)

581 
	`sc¡_g’_«n_Ü_ua
(
tgt_dev
,

582 
	`SCST_LOAD_SENSE
(
sc¡_£n£_asym_acûss_¡©e_chªged
));

583 
	}
}

586 
	$sc¡_tg_š™_tgt_dev
(
sc¡_tgt_dev
 *
tgt_dev
)

588 
sc¡_dev_group
 *
dg
;

589 
sc¡_rg‘_group
 *
tg
;

591 
	`mu‹x_lock
(&
sc¡_dg_mu‹x
);

592 
dg
 = 
	`__lookup_dg_by_dev
(
tgt_dev
->
dev
);

593 ià(
dg
) {

594 
tg
 = 
	`__lookup_tg_by_tgt
(
dg
, 
tgt_dev
->
acg_dev
->
acg
->
tgt
);

595 ià(
tg
) {

596 
	`sc¡_upd©e_tgt_dev_®ua_fž‹r
(
tgt_dev
, 
tg
->
¡©e
);

597 
	`sc¡_check_®ua_šv¬ŸÁ
();

600 
	`mu‹x_uÆock
(&
sc¡_dg_mu‹x
);

601 
	}
}

607 
	$sc¡_upd©e_tgt_®ua_fž‹r
(
sc¡_rg‘_group
 *
tg
,

608 
sc¡_tgt
 *
tgt
)

610 
sc¡_dg_dev
 *
dgd
;

611 
sc¡_tgt_dev
 *
tgt_dev
;

613 
	`lockd•_as£¹_h–d
(&
sc¡_dg_mu‹x
);

615 
	`li¡_fÜ_—ch_’Œy
(
dgd
, &
tg
->
dg
->
dev_li¡
, 
’Œy
) {

616 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dgd
->
dev
->
dev_tgt_dev_li¡
,

617 
dev_tgt_dev_li¡_’Œy
) {

618 ià(
tgt_dev
->
acg_dev
->
acg
->
tgt
 ==gt)

619 
	`sc¡_upd©e_tgt_dev_®ua_fž‹r
(
tgt_dev
,

620 
tg
->
¡©e
);

624 
	`sc¡_check_®ua_šv¬ŸÁ
();

625 
	}
}

631 
	$sc¡_»£t_tgt_®ua_fž‹r
(
sc¡_rg‘_group
 *
tg
,

632 
sc¡_tgt
 *
tgt
)

634 
sc¡_dg_dev
 *
dgd
;

635 
sc¡_tgt_dev
 *
tgt_dev
;

637 
	`lockd•_as£¹_h–d
(&
sc¡_dg_mu‹x
);

639 
	`li¡_fÜ_—ch_’Œy
(
dgd
, &
tg
->
dg
->
dev_li¡
, 
’Œy
) {

640 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dgd
->
dev
->
dev_tgt_dev_li¡
,

641 
dev_tgt_dev_li¡_’Œy
) {

642 ià(
tgt_dev
->
acg_dev
->
acg
->
tgt
 ==gt)

643 
	`sc¡_upd©e_tgt_dev_®ua_fž‹r
(
tgt_dev
,

644 
SCST_TG_STATE_OPTIMIZED
);

648 
	`sc¡_check_®ua_šv¬ŸÁ
();

649 
	}
}

654 
	$sc¡_tg_tgt_add
(
sc¡_rg‘_group
 *
tg
, cÚ¡ *
Çme
)

656 
sc¡_tg_tgt
 *
tg_tgt
;

657 
sc¡_tgt
 *
tgt
;

658 
»s
;

660 
	`TRACE_ENTRY
();

661 
	`BUG_ON
(!
tg
);

662 
	`BUG_ON
(!
Çme
);

663 
»s
 = -
ENOMEM
;

664 
tg_tgt
 = 
	`kz®loc
((*tg_tgt), 
GFP_KERNEL
);

665 ià(!
tg_tgt
)

666 
out
;

667 
tg_tgt
->
tg
 =g;

668 #ià
LINUX_VERSION_CODE
 > 
	`KERNEL_VERSION
(2, 6, 24)

669 
	`kobjeù_š™
(&
tg_tgt
->
kobj
, &
sc¡_tg_tgt_kty³
);

671 
	`kobjeù_š™
(&
tg_tgt
->
kobj
);

672 
tg_tgt
->
kobj
.
kty³
 = &
sc¡_tg_tgt_kty³
;

674 
tg_tgt
->
Çme
 = 
	`k¡rdup
Òame, 
GFP_KERNEL
);

675 ià(!
tg_tgt
->
Çme
)

676 
out_put
;

678 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

679 ià(
»s
)

680 
out_put
;

681 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_dg_mu‹x
);

682 ià(
»s
)

683 
out_uÆock_sc¡
;

684 
»s
 = -
EEXIST
;

685 
tgt
 = 
	`__lookup_tgt
(
Çme
);

686 ià(
	`__lookup_dg_tgt
(
tg
->
dg
, 
Çme
))

687 
out_uÆock_dg
;

688 
tg_tgt
->
tgt
 =gt;

689 
»s
 = 
	`sc¡_tg_tgt_sysfs_add
(
tg
, 
tg_tgt
);

690 ià(
»s
)

691 
out_uÆock_dg
;

692 
	`li¡_add_ž
(&
tg_tgt
->
’Œy
, &
tg
->
tgt_li¡
);

693 
	`sc¡_upd©e_tgt_®ua_fž‹r
(
tg
, 
tgt
);

694 
»s
 = 0;

695 
	`mu‹x_uÆock
(&
sc¡_dg_mu‹x
);

696 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

698 
out
:

699 
	`TRACE_EXIT_RES
(
»s
);

700  
»s
;

702 
out_uÆock_dg
:

703 
	`mu‹x_uÆock
(&
sc¡_dg_mu‹x
);

705 
out_uÆock_sc¡
:

706 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

708 
out_put
:

709 
	`kobjeù_put
(&
tg_tgt
->
kobj
);

710 
out
;

711 
	}
}

713 
	$__sc¡_tg_tgt_»move
(
sc¡_rg‘_group
 *
tg
,

714 
sc¡_tg_tgt
 *
tg_tgt
)

716 
	`TRACE_ENTRY
();

717 
	`li¡_d–
(&
tg_tgt
->
’Œy
);

718 
	`sc¡_tg_tgt_sysfs_d–
(
tg
, 
tg_tgt
);

719 
	`sc¡_»£t_tgt_®ua_fž‹r
(
tg
, 
tg_tgt
->
tgt
);

720 
	`kobjeù_put
(&
tg_tgt
->
kobj
);

721 
	`TRACE_EXIT
();

722 
	}
}

727 
	$sc¡_tg_tgt_»move_by_Çme
(
sc¡_rg‘_group
 *
tg
, cÚ¡ *
Çme
)

729 
sc¡_tg_tgt
 *
tg_tgt
;

730 
»s
;

732 
	`TRACE_ENTRY
();

733 
	`BUG_ON
(!
tg
);

734 
	`BUG_ON
(!
Çme
);

735 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_dg_mu‹x
);

736 ià(
»s
)

737 
out
;

738 
»s
 = -
EINVAL
;

739 
tg_tgt
 = 
	`__lookup_dg_tgt
(
tg
->
dg
, 
Çme
);

740 ià(!
tg_tgt
)

741 
out_uÆock
;

742 
	`__sc¡_tg_tgt_»move
(
tg
, 
tg_tgt
);

743 
»s
 = 0;

744 
out_uÆock
:

745 
	`mu‹x_uÆock
(&
sc¡_dg_mu‹x
);

746 
out
:

747 
	`TRACE_EXIT_RES
(
»s
);

748  
»s
;

749 
	}
}

752 
	$sc¡_tg_tgt_»move_by_tgt
(
sc¡_tgt
 *
tgt
)

754 
sc¡_dev_group
 *
dg
;

755 
sc¡_rg‘_group
 *
tg
;

756 
sc¡_tg_tgt
 *
t
, *
t2
;

758 
	`mu‹x_lock
(&
sc¡_dg_mu‹x
);

759 
	`li¡_fÜ_—ch_’Œy
(
dg
, &
sc¡_dev_group_li¡
, 
’Œy
)

760 
	`li¡_fÜ_—ch_’Œy
(
tg
, &
dg
->
tg_li¡
, 
’Œy
)

761 
	`li¡_fÜ_—ch_’Œy_§ã
(
t
, 
t2
, &
tg
->
tgt_li¡
, 
’Œy
)

762 ià(
t
->
tgt
 ==gt)

763 
	`__sc¡_tg_tgt_»move
(
tg
, 
t
);

764 
	`mu‹x_uÆock
(&
sc¡_dg_mu‹x
);

765 
	}
}

771 
	$sc¡_»Ëa£_tg
(
kobjeù
 *
kobj
)

773 
sc¡_rg‘_group
 *
tg
;

775 
tg
 = 
	`cÚš”_of
(
kobj
, 
sc¡_rg‘_group
, kobj);

776 
	`kä“
(
tg
->
Çme
);

777 
	`kä“
(
tg
);

778 
	}
}

780 
kobj_ty³
 
	gsc¡_tg_kty³
 = {

781 #iâdeà
CONFIG_SCST_PROC


782 .
sysfs_Ýs
 = &
sc¡_sysfs_Ýs
,

784 .
	g»Ëa£
 = 
sc¡_»Ëa£_tg
,

790 
	$sc¡_tg_add
(
sc¡_dev_group
 *
dg
, cÚ¡ *
Çme
)

792 
sc¡_rg‘_group
 *
tg
;

793 
»s
;

795 
	`TRACE_ENTRY
();

796 
»s
 = -
ENOMEM
;

797 
tg
 = 
	`kz®loc
((*tg), 
GFP_KERNEL
);

798 ià(!
tg
)

799 
out
;

800 #ià
LINUX_VERSION_CODE
 > 
	`KERNEL_VERSION
(2, 6, 24)

801 
	`kobjeù_š™
(&
tg
->
kobj
, &
sc¡_tg_kty³
);

803 
	`kobjeù_š™
(&
tg
->
kobj
);

804 
tg
->
kobj
.
kty³
 = &
sc¡_tg_kty³
;

806 
tg
->
Çme
 = 
	`k¡rdup
Òame, 
GFP_KERNEL
);

807 ià(!
tg
->
Çme
)

808 
out_put
;

809 
tg
->
dg
 = dg;

810 
tg
->
¡©e
 = 
SCST_TG_STATE_OPTIMIZED
;

811 
	`INIT_LIST_HEAD
(&
tg
->
tgt_li¡
);

813 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_dg_mu‹x
);

814 ià(
»s
)

815 
out_put
;

816 
»s
 = -
EEXIST
;

817 ià(
	`__lookup_tg_by_Çme
(
dg
, 
Çme
))

818 
out_uÆock
;

819 
»s
 = 
	`sc¡_tg_sysfs_add
(
dg
, 
tg
);

820 ià(
»s
)

821 
out_uÆock
;

822 
	`li¡_add_ž
(&
tg
->
’Œy
, &
dg
->
tg_li¡
);

823 
	`mu‹x_uÆock
(&
sc¡_dg_mu‹x
);

825 
out
:

826 
	`TRACE_EXIT_RES
(
»s
);

827  
»s
;

829 
out_uÆock
:

830 
	`mu‹x_uÆock
(&
sc¡_dg_mu‹x
);

831 
out_put
:

832 
	`kobjeù_put
(&
tg
->
kobj
);

833 
out
;

834 
	}
}

836 
	$__sc¡_tg_»move
(
sc¡_dev_group
 *
dg
,

837 
sc¡_rg‘_group
 *
tg
)

839 
sc¡_tg_tgt
 *
tg_tgt
;

841 
	`TRACE_ENTRY
();

842 
	`BUG_ON
(!
dg
);

843 
	`BUG_ON
(!
tg
);

844 !
	`li¡_em±y
(&
tg
->
tgt_li¡
)) {

845 
tg_tgt
 = 
	`li¡_fœ¡_’Œy
(&
tg
->
tgt_li¡
, 
sc¡_tg_tgt
,

846 
’Œy
);

847 
	`__sc¡_tg_tgt_»move
(
tg
, 
tg_tgt
);

849 
	`li¡_d–
(&
tg
->
’Œy
);

850 
	`sc¡_tg_sysfs_d–
(
tg
);

851 
	`kobjeù_put
(&
tg
->
kobj
);

852 
	`TRACE_EXIT
();

853 
	}
}

858 
	$sc¡_tg_»move_by_Çme
(
sc¡_dev_group
 *
dg
, cÚ¡ *
Çme
)

860 
sc¡_rg‘_group
 *
tg
;

861 
»s
;

863 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_dg_mu‹x
);

864 ià(
»s
)

865 
out
;

866 
»s
 = -
EINVAL
;

867 
tg
 = 
	`__lookup_tg_by_Çme
(
dg
, 
Çme
);

868 ià(!
tg
)

869 
out_uÆock
;

870 
	`__sc¡_tg_»move
(
dg
, 
tg
);

871 
»s
 = 0;

872 
out_uÆock
:

873 
	`mu‹x_uÆock
(&
sc¡_dg_mu‹x
);

874 
out
:

875  
»s
;

876 
	}
}

878 
	$sc¡_ev’t_¡pg_nÙify_â
(
sc¡_ev’t
 *
ev’t
,

879 *
´iv
, 
¡©us
)

881 
sc¡_dev_group
 *
dg
;

882 
sc¡_cmd
 *
cmd
 = (sc¡_cmd *)
´iv
;

883 
sc¡_ev’t_¡pg_·ylßd
 *
p
 =

884 (
sc¡_ev’t_¡pg_·ylßd
 *)
ev’t
->
·ylßd
;

885 
sc¡_ev’t_¡pg_desü
 *
d
;

886 
sc¡_dg_dev
 *
dgd
;

887 
i
;

889 
	`TRACE_ENTRY
();

891 
	`PRINT_INFO
("Notification forƒvent %u (id %d)„eceived "

892 "w™h stu %d (´iv %p)", 
ev’t
->
ev’t_code
,

893 
ev’t
->
ev’t_id
, 
¡©us
, 
´iv
);

895 
	`mu‹x_lock
(&
sc¡_mu‹x
);

896 
	`mu‹x_lock
(&
sc¡_dg_mu‹x
);

898 
dg
 = 
	`__lookup_dg_by_dev
(
cmd
->
dev
);

899 ià(!
dg
) {

900 
	`PRINT_ERROR
("STPG: unableo find DG for device %s",

901 
cmd
->
dev
->
vœt_Çme
);

902 
out_çž
;

905 
	`li¡_fÜ_—ch_’Œy
(
dgd
, &
dg
->
dev_li¡
, 
’Œy
) {

906 ià(
dgd
->
dev
->
¡pg_ext_blocked
) {

907 
	`TRACE_DBG
("STPG:ƒxt unblocking dev %s",

908 
dgd
->
dev
->
vœt_Çme
);

909 
	`sc¡_ext_unblock_dev
(
dgd
->
dev
, 
Œue
);

910 
dgd
->
dev
->
¡pg_ext_blocked
 = 0;

914 
	`kä“
(
dg
->
¡pg_Œª¥Üt_id
);

915 
dg
->
¡pg_Œª¥Üt_id
 = 
NULL
;

917 ià(
¡©us
 != 0) {

918 
	`PRINT_ERROR
("on_stpg script for device group %s failed with status %d",

919 
dg
->
Çme
, 
¡©us
);

920 
out_çž
;

923 
i
 = 0, 
d
 = &
p
->
¡pg_desütÜs
[0]; i <…->
¡pg_desütÜs_út
; i++, d++) {

924 
sc¡_rg‘_group
 *
tg
 = 
	`__lookup_tg_by_group_id
(
dg
, 
d
->
group_id
);

926 ià(!
tg
) {

927 
	`PRINT_ERROR
("STPG: uÇbËØfšd TG %d", 
d
->
group_id
);

928 
out_çž
;

929 } ià(
tg
->
¡©e
 =ð
	`sc¡_®ua_Çme_to_¡©e
(
d
->
´ev_¡©e
)) {

930 
	`PRINT_ERROR
("on_stpg script did‚ot change ALUA state"

932 
dg
->
Çme
, 
tg
->name);

933 
out_çž
;

937 
out_uÆock
:

938 
	`mu‹x_uÆock
(&
sc¡_dg_mu‹x
);

939 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

941 
	`sc¡_¡pg_d–_unblock_Ãxt
(
cmd
);

943 
cmd
->
com¶‘ed
 = 1;

944 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_THREAD
);

946 
	`TRACE_EXIT
();

949 
out_çž
:

950 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_£t_rg‘_pgs_çžed
));

951 
out_uÆock
;

952 
	}
}

959 
	$__sc¡_tg_£t_¡©e
(
sc¡_rg‘_group
 *
tg
,

960 
sc¡_tg_¡©e
 
¡©e
)

962 
sc¡_dg_dev
 *
dg_dev
;

963 
sc¡_deviû
 *
dev
;

964 
sc¡_tgt_dev
 *
tgt_dev
;

965 
sc¡_tg_tgt
 *
tg_tgt
;

966 
sc¡_tgt
 *
tgt
;

967 
sc¡_tg_¡©e
 
Þd_¡©e
 = 
tg
->
¡©e
;

969 
	`sBUG_ON
(
¡©e
 >ð
	`ARRAY_SIZE
(
sc¡_®ua_fž‹r
));

970 
	`lockd•_as£¹_h–d
(&
sc¡_dg_mu‹x
);

972 ià(
tg
->
¡©e
 == state)

975 
tg
->
¡©e
 = state;

977 
	`li¡_fÜ_—ch_’Œy
(
dg_dev
, &
tg
->
dg
->
dev_li¡
, 
’Œy
) {

978 
dev
 = 
dg_dev
->dev;

979 ià(
dev
->
hªdËr
->
Ú_®ua_¡©e_chªge_¡¬t
 !ð
NULL
)

980 
dev
->
hªdËr
->
	`Ú_®ua_¡©e_chªge_¡¬t
(dev, 
Þd_¡©e
, 
¡©e
);

981 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

982 
dev_tgt_dev_li¡_’Œy
) {

983 
tgt
 = 
tgt_dev
->
£ss
->tgt;

984 
	`li¡_fÜ_—ch_’Œy
(
tg_tgt
, &
tg
->
tgt_li¡
, 
’Œy
) {

985 ià(
tg_tgt
->
tgt
 ==gt) {

986 
boÞ
 
g’_ua
 = (
¡©e
 !ð
SCST_TG_STATE_TRANSITIONING
);

988 ià((
tg
->
dg
->
¡pg_»l_tgt_id
 =ð
tgt_dev
->
£ss
->
tgt
->
»l_tgt_id
) &&

989 
	`tid_equ®
(
tg
->
dg
->
¡pg_Œª¥Üt_id
, 
tgt_dev
->
£ss
->
Œª¥Üt_id
))

990 
g’_ua
 = 
çl£
;

991 
	`sc¡_tg_chªge_tgt_dev_¡©e
(
tgt_dev
,

992 
¡©e
, 
g’_ua
);

997 ià(
dev
->
hªdËr
->
Ú_®ua_¡©e_chªge_fšish
 !ð
NULL
)

998 
dev
->
hªdËr
->
	`Ú_®ua_¡©e_chªge_fšish
(dev, 
Þd_¡©e
, 
¡©e
);

1001 
	`sc¡_check_®ua_šv¬ŸÁ
();

1003 
	`PRINT_INFO
("Chªged ALUA s‹ oà%s/% štØ%s", 
tg
->
dg
->
Çme
,

1004 
tg
->
Çme
, 
	`sc¡_®ua_¡©e_Çme
(
¡©e
));

1005 
	}
}

1007 
	$sc¡_tg_£t_¡©e
(
sc¡_rg‘_group
 *
tg
, 
sc¡_tg_¡©e
 
¡©e
)

1009 
»s
;

1011 
»s
 = -
EINVAL
;

1012 ià(
¡©e
 >ð
	`ARRAY_SIZE
(
sc¡_®ua_fž‹r
))

1013 
out
;

1015 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_dg_mu‹x
);

1016 ià(
»s
)

1017 
out
;

1019 
	`__sc¡_tg_£t_¡©e
(
tg
, 
¡©e
);

1021 
	`mu‹x_uÆock
(&
sc¡_dg_mu‹x
);

1022 
out
:

1023  
»s
;

1024 
	}
}

1035 
	$__sc¡_g’_®ua_¡©e_chªged_ua
(
sc¡_rg‘_group
 *
tg
)

1037 
sc¡_dg_dev
 *
dg_dev
;

1038 
sc¡_deviû
 *
dev
;

1039 
sc¡_tgt_dev
 *
tgt_dev
;

1040 
sc¡_tg_tgt
 *
tg_tgt
;

1041 
sc¡_tgt
 *
tgt
;

1043 
	`lockd•_as£¹_h–d
(&
sc¡_dg_mu‹x
);

1045 
	`li¡_fÜ_—ch_’Œy
(
dg_dev
, &
tg
->
dg
->
dev_li¡
, 
’Œy
) {

1046 
dev
 = 
dg_dev
->dev;

1047 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

1048 
dev_tgt_dev_li¡_’Œy
) {

1049 
tgt
 = 
tgt_dev
->
£ss
->tgt;

1050 
	`li¡_fÜ_—ch_’Œy
(
tg_tgt
, &
tg
->
tgt_li¡
, 
’Œy
) {

1051 ià(
tg_tgt
->
tgt
 ==gt) {

1052 
	`sc¡_g’_«n_Ü_ua
(
tgt_dev
,

1053 
	`SCST_LOAD_SENSE
(
sc¡_£n£_asym_acûss_¡©e_chªged
));

1059 
	}
}

1061 
	$__sc¡_tg_£t_´eã¼ed
(
sc¡_rg‘_group
 *
tg
,

1062 
boÞ
 
´eã¼ed
)

1064 
boÞ
 
´ev_´eã¼ed
;

1066 
	`lockd•_as£¹_h–d
(&
sc¡_dg_mu‹x
);

1068 ià(
tg
->
´eã¼ed
 ==…referred)

1071 
´ev_´eã¼ed
 = 
tg
->
´eã¼ed
;

1072 
tg
->
´eã¼ed
 =…referred;

1074 
	`PRINT_INFO
("Changed…referred state of %s/%s from %d into %d",

1075 
tg
->
dg
->
Çme
,g->Çme, 
´ev_´eã¼ed
,

1076 
´eã¼ed
);

1078 
	`__sc¡_g’_®ua_¡©e_chªged_ua
(
tg
);

1079 
	}
}

1081 
	$sc¡_tg_£t_´eã¼ed
(
sc¡_rg‘_group
 *
tg
,

1082 
boÞ
 
´eã¼ed
)

1084 
»s
;

1086 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_dg_mu‹x
);

1087 ià(
»s
)

1088 
out
;

1089 
	`__sc¡_tg_£t_´eã¼ed
(
tg
, 
´eã¼ed
);

1090 
	`mu‹x_uÆock
(&
sc¡_dg_mu‹x
);

1091 
out
:

1092  
»s
;

1093 
	}
}

1103 
	$sc¡_upd©e_dev_®ua_fž‹r
(
sc¡_dev_group
 *
dg
,

1104 
sc¡_deviû
 *
dev
)

1106 
sc¡_tgt_dev
 *
tgt_dev
;

1107 
sc¡_rg‘_group
 *
tg
;

1109 
	`lockd•_as£¹_h–d
(&
sc¡_dg_mu‹x
);

1111 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

1112 
dev_tgt_dev_li¡_’Œy
) {

1113 
tg
 = 
	`__lookup_tg_by_tgt
(
dg
, 
tgt_dev
->
acg_dev
->
acg
->
tgt
);

1114 ià(
tg
)

1115 
	`sc¡_upd©e_tgt_dev_®ua_fž‹r
(
tgt_dev
, 
tg
->
¡©e
);

1118 
	`sc¡_check_®ua_šv¬ŸÁ
();

1119 
	}
}

1125 
	$sc¡_»£t_dev_®ua_fž‹r
(
sc¡_deviû
 *
dev
)

1127 
sc¡_tgt_dev
 *
tgt_dev
;

1129 
	`lockd•_as£¹_h–d
(&
sc¡_dg_mu‹x
);

1131 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

1132 
dev_tgt_dev_li¡_’Œy
)

1133 
	`sc¡_upd©e_tgt_dev_®ua_fž‹r
(
tgt_dev
,

1134 
SCST_TG_STATE_OPTIMIZED
);

1136 
	`sc¡_check_®ua_šv¬ŸÁ
();

1137 
	}
}

1145 
	$sc¡_dg_dev_add
(
sc¡_dev_group
 *
dg
, cÚ¡ *
Çme
)

1147 
sc¡_dg_dev
 *
dgdev
;

1148 
sc¡_deviû
 *
dev
;

1149 
»s
;

1151 
»s
 = -
ENOMEM
;

1152 
dgdev
 = 
	`kz®loc
((*dgdev), 
GFP_KERNEL
);

1153 ià(!
dgdev
)

1154 
out
;

1156 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_dg_mu‹x
);

1157 ià(
»s
)

1158 
out_ä“
;

1159 
»s
 = -
EEXIST
;

1160 ià(
	`__glob®_lookup_dg_dev_by_Çme
(
Çme
))

1161 
out_uÆock
;

1162 
»s
 = -
EINVAL
;

1163 
dev
 = 
	`__lookup_dev
(
Çme
);

1164 ià(!
dev
)

1165 
out_uÆock
;

1166 
dgdev
->
dev
 = dev;

1167 
»s
 = 
	`sc¡_dg_dev_sysfs_add
(
dg
, 
dgdev
);

1168 ià(
»s
)

1169 
out_uÆock
;

1170 
	`li¡_add_ž
(&
dgdev
->
’Œy
, &
dg
->
dev_li¡
);

1171 
	`sc¡_upd©e_dev_®ua_fž‹r
(
dg
, 
dev
);

1172 
	`mu‹x_uÆock
(&
sc¡_dg_mu‹x
);

1174 
out
:

1175  
»s
;

1177 
out_uÆock
:

1178 
	`mu‹x_uÆock
(&
sc¡_dg_mu‹x
);

1179 
out_ä“
:

1180 
	`kä“
(
dgdev
);

1181 
out
;

1182 
	}
}

1185 
	$__sc¡_dg_dev_»move
(
sc¡_dev_group
 *
dg
,

1186 
sc¡_dg_dev
 *
dgdev
)

1188 ià(
dgdev
->
dev
->
¡pg_ext_blocked
) {

1189 
	`TRACE_DBG
("DG %s„emove: unblocking STPGƒxt blocked "

1190 "dev %s", 
dg
->
Çme
, 
dgdev
->
dev
->
vœt_Çme
);

1191 
	`sc¡_ext_unblock_dev
(
dgdev
->
dev
, 
Œue
);

1192 
dgdev
->
dev
->
¡pg_ext_blocked
 = 0;

1194 
	`li¡_d–
(&
dgdev
->
’Œy
);

1195 
	`sc¡_dg_dev_sysfs_d–
(
dg
, 
dgdev
);

1196 
	`sc¡_»£t_dev_®ua_fž‹r
(
dgdev
->
dev
);

1197 
	`kä“
(
dgdev
);

1198 
	}
}

1203 
	$sc¡_dg_dev_»move_by_Çme
(
sc¡_dev_group
 *
dg
, cÚ¡ *
Çme
)

1205 
sc¡_dg_dev
 *
dgdev
;

1206 
»s
;

1208 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_dg_mu‹x
);

1209 ià(
»s
)

1210 
out
;

1211 
»s
 = -
EINVAL
;

1212 
dgdev
 = 
	`__lookup_dg_dev_by_Çme
(
dg
, 
Çme
);

1213 ià(!
dgdev
)

1214 
out_uÆock
;

1215 
	`__sc¡_dg_dev_»move
(
dg
, 
dgdev
);

1216 
»s
 = 0;

1217 
out_uÆock
:

1218 
	`mu‹x_uÆock
(&
sc¡_dg_mu‹x
);

1219 
out
:

1220  
»s
;

1221 
	}
}

1224 
	$sc¡_dg_dev_»move_by_dev
(
sc¡_deviû
 *
dev
)

1226 
sc¡_dev_group
 *
dg
;

1227 
sc¡_dg_dev
 *
dgdev
;

1228 
»s
;

1230 
»s
 = -
EINVAL
;

1232 
	`mu‹x_lock
(&
sc¡_dg_mu‹x
);

1233 
dg
 = 
	`__lookup_dg_by_dev
(
dev
);

1234 ià(!
dg
)

1235 
out
;

1236 
dgdev
 = 
	`__lookup_dg_dev_by_dev
(
dg
, 
dev
);

1237 
	`BUG_ON
(!
dgdev
);

1238 
	`__sc¡_dg_dev_»move
(
dg
, 
dgdev
);

1239 
»s
 = 0;

1241 
out
:

1242 
	`mu‹x_uÆock
(&
sc¡_dg_mu‹x
);

1244  
»s
;

1245 
	}
}

1251 
	$sc¡_»Ëa£_dg
(
kobjeù
 *
kobj
)

1253 
sc¡_dev_group
 *
dg
;

1255 
dg
 = 
	`cÚš”_of
(
kobj
, 
sc¡_dev_group
, kobj);

1256 
	`kä“
(
dg
->
Çme
);

1257 
	`kä“
(
dg
);

1258 
	}
}

1260 
kobj_ty³
 
	gsc¡_dg_kty³
 = {

1261 #iâdeà
CONFIG_SCST_PROC


1262 .
sysfs_Ýs
 = &
sc¡_sysfs_Ýs
,

1264 .
	g»Ëa£
 = 
sc¡_»Ëa£_dg
,

1270 
	$sc¡_dg_add
(
kobjeù
 *
·»Á
, cÚ¡ *
Çme
)

1272 
sc¡_dev_group
 *
dg
;

1273 
»s
;

1275 
	`TRACE_ENTRY
();

1277 
»s
 = -
ENOMEM
;

1278 
dg
 = 
	`kz®loc
((*dg), 
GFP_KERNEL
);

1279 ià(!
dg
)

1280 
out
;

1281 #ià
LINUX_VERSION_CODE
 > 
	`KERNEL_VERSION
(2, 6, 24)

1282 
	`kobjeù_š™
(&
dg
->
kobj
, &
sc¡_dg_kty³
);

1284 
	`kobjeù_š™
(&
dg
->
kobj
);

1285 
dg
->
kobj
.
kty³
 = &
sc¡_dg_kty³
;

1287 
dg
->
Çme
 = 
	`k¡rdup
Òame, 
GFP_KERNEL
);

1288 ià(!
dg
->
Çme
)

1289 
out_put
;

1291 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_dg_mu‹x
);

1292 ià(
»s
)

1293 
out_put
;

1294 
»s
 = -
EEXIST
;

1295 ià(
	`__lookup_dg_by_Çme
(
Çme
))

1296 
out_uÆock
;

1297 
»s
 = -
ENOMEM
;

1298 
	`INIT_LIST_HEAD
(&
dg
->
dev_li¡
);

1299 
	`INIT_LIST_HEAD
(&
dg
->
tg_li¡
);

1300 
»s
 = 
	`sc¡_dg_sysfs_add
(
·»Á
, 
dg
);

1301 ià(
»s
)

1302 
out_uÆock
;

1303 
	`li¡_add_ž
(&
dg
->
’Œy
, &
sc¡_dev_group_li¡
);

1304 
	`mu‹x_uÆock
(&
sc¡_dg_mu‹x
);

1305 
out
:

1306 
	`TRACE_EXIT_RES
(
»s
);

1307  
»s
;

1309 
out_uÆock
:

1310 
	`mu‹x_uÆock
(&
sc¡_dg_mu‹x
);

1311 
out_put
:

1312 
	`kobjeù_put
(&
dg
->
kobj
);

1313 
out
;

1314 
	}
}

1316 
	$__sc¡_dg_»move
(
sc¡_dev_group
 *
dg
)

1318 
sc¡_dg_dev
 *
dgdev
;

1319 
sc¡_rg‘_group
 *
tg
;

1321 
	`lockd•_as£¹_h–d
(&
sc¡_dg_mu‹x
);

1323 
	`li¡_d–
(&
dg
->
’Œy
);

1324 
	`sc¡_dg_sysfs_d–
(
dg
);

1325 
	`li¡_fÜ_—ch_’Œy
(
tg
, &
dg
->
tg_li¡
, 
’Œy
)

1326 
	`__sc¡_tg_£t_¡©e
(
tg
, 
SCST_TG_STATE_OPTIMIZED
);

1327 !
	`li¡_em±y
(&
dg
->
dev_li¡
)) {

1328 
dgdev
 = 
	`li¡_fœ¡_’Œy
(&
dg
->
dev_li¡
, 
sc¡_dg_dev
,

1329 
’Œy
);

1330 
	`__sc¡_dg_dev_»move
(
dg
, 
dgdev
);

1332 !
	`li¡_em±y
(&
dg
->
tg_li¡
)) {

1333 
tg
 = 
	`li¡_fœ¡_’Œy
(&
dg
->
tg_li¡
, 
sc¡_rg‘_group
,

1334 
’Œy
);

1335 
	`__sc¡_tg_»move
(
dg
, 
tg
);

1337 
	`kobjeù_put
(&
dg
->
kobj
);

1338 
	}
}

1340 
	$sc¡_dg_»move
(cÚ¡ *
Çme
)

1342 
sc¡_dev_group
 *
dg
;

1343 
»s
;

1345 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_dg_mu‹x
);

1346 ià(
»s
)

1347 
out
;

1348 
»s
 = -
EINVAL
;

1349 
dg
 = 
	`__lookup_dg_by_Çme
(
Çme
);

1350 ià(!
dg
)

1351 
out_uÆock
;

1352 
	`__sc¡_dg_»move
(
dg
);

1353 
»s
 = 0;

1354 
out_uÆock
:

1355 
	`mu‹x_uÆock
(&
sc¡_dg_mu‹x
);

1356 
out
:

1357  
»s
;

1358 
	}
}

1368 
sc¡_dev_group
 *
	$sc¡_lookup_dg_by_kobj
(
kobjeù
 *
kobj
)

1370 
»s
;

1371 
sc¡_dev_group
 *
dg
;

1373 
dg
 = 
NULL
;

1374 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_dg_mu‹x
);

1375 ià(
»s
)

1376 
out
;

1377 
	`li¡_fÜ_—ch_’Œy
(
dg
, &
sc¡_dev_group_li¡
, 
’Œy
)

1378 ià(
dg
->
dev_kobj
 =ð
kobj
 || dg->
tg_kobj
 == kobj)

1379 
out_uÆock
;

1380 
dg
 = 
NULL
;

1381 
out_uÆock
:

1382 
	`mu‹x_uÆock
(&
sc¡_dg_mu‹x
);

1383 
out
:

1384  
dg
;

1385 
	}
}

1392 
	$sc¡_tg_š™
()

1394 
	}
}

1396 
	$sc¡_tg_þ—nup
()

1398 
sc¡_dev_group
 *
tg
;

1400 
	`mu‹x_lock
(&
sc¡_dg_mu‹x
);

1401 !
	`li¡_em±y
(&
sc¡_dev_group_li¡
)) {

1402 
tg
 = 
	`li¡_fœ¡_’Œy
(&
sc¡_dev_group_li¡
,

1403 
sc¡_dev_group
, 
’Œy
);

1404 
	`__sc¡_dg_»move
(
tg
);

1406 
	`mu‹x_uÆock
(&
sc¡_dg_mu‹x
);

1407 
	}
}

1420 
ušt16_t
 
	$sc¡_lookup_tg_id
(
sc¡_deviû
 *
dev
, 
sc¡_tgt
 *
tgt
)

1422 
sc¡_dev_group
 *
dg
;

1423 
sc¡_rg‘_group
 *
tg
;

1424 
sc¡_tg_tgt
 *
tg_tgt
;

1425 
ušt16_t
 
tg_id
 = 0;

1427 
	`TRACE_ENTRY
();

1428 
	`mu‹x_lock
(&
sc¡_dg_mu‹x
);

1429 
dg
 = 
	`__lookup_dg_by_dev
(
dev
);

1430 ià(!
dg
)

1431 
out_uÆock
;

1432 
tg_tgt
 = 
	`__lookup_dg_tgt
(
dg
, 
tgt
->
tgt_Çme
);

1433 ià(!
tg_tgt
)

1434 
out_uÆock
;

1435 
tg
 = 
tg_tgt
->tg;

1436 
	`BUG_ON
(!
tg
);

1437 
tg_id
 = 
tg
->
group_id
;

1438 
out_uÆock
:

1439 
	`mu‹x_uÆock
(&
sc¡_dg_mu‹x
);

1441 
	`TRACE_EXIT_RES
(
tg_id
);

1442  
tg_id
;

1443 
	}
}

1444 
EXPORT_SYMBOL_GPL
(
sc¡_lookup_tg_id
);

1450 
boÞ
 
	$sc¡_®ua_cÚfigu»d
(
sc¡_deviû
 *
dev
)

1452 
sc¡_dev_group
 *
dg
;

1454 
	`mu‹x_lock
(&
sc¡_dg_mu‹x
);

1455 
dg
 = 
	`__lookup_dg_by_dev
(
dev
);

1456 
	`mu‹x_uÆock
(&
sc¡_dg_mu‹x
);

1458  
dg
 !ð
NULL
;

1459 
	}
}

1460 
EXPORT_SYMBOL_GPL
(
sc¡_®ua_cÚfigu»d
);

1469 
	$sc¡_tg_g‘_group_šfo
(**
buf
, 
ušt32_t
 *
Ëngth
,

1470 
sc¡_deviû
 *
dev
, 
ušt8_t
 
d©a_fÜm©
)

1472 
sc¡_dev_group
 *
dg
;

1473 
sc¡_rg‘_group
 *
tg
;

1474 
sc¡_tg_tgt
 *
tgtgt
;

1475 
sc¡_tgt
 *
tgt
;

1476 
ušt8_t
 *
p
;

1477 
ušt32_t
 
»t_d©a_Ën
;

1478 
ušt16_t
 
»l_tgt_id
;

1479 
»s
;

1481 
	`TRACE_ENTRY
();

1483 
	`BUG_ON
(!
buf
);

1484 
	`BUG_ON
(!
Ëngth
);

1486 
»t_d©a_Ën
 = 0;

1488 
»s
 = -
EINVAL
;

1489 
d©a_fÜm©
) {

1494 
»t_d©a_Ën
 += 4;

1497 
out
;

1500 *
Ëngth
 = 4;

1502 
	`mu‹x_lock
(&
sc¡_dg_mu‹x
);

1504 
dg
 = 
	`__lookup_dg_by_dev
(
dev
);

1505 ià(
dg
) {

1506 
	`li¡_fÜ_—ch_’Œy
(
tg
, &
dg
->
tg_li¡
, 
’Œy
) {

1508 
»t_d©a_Ën
 += 8;

1509 
	`li¡_fÜ_—ch_’Œy
(
tgtgt
, &
tg
->
tgt_li¡
, 
’Œy
) {

1511 
»t_d©a_Ën
 += 4;

1516 *
Ëngth
 +ð
»t_d©a_Ën
;

1518 
»s
 = -
ENOMEM
;

1519 *
buf
 = 
	`kz®loc
(*
Ëngth
, 
GFP_KERNEL
);

1520 ià(!*
buf
)

1521 
out_uÆock
;

1523 
p
 = *
buf
;

1525 
	`put_uÇligÃd_be32
(
»t_d©a_Ën
, 
p
);

1526 
p
 += 4;

1527 ià(
d©a_fÜm©
 == 1) {

1529 *
p
++ = 0x10;

1530 *
p
++ = 0x00;

1531 
p
 += 2;

1534 ià(!
dg
)

1535 
dÚe
;

1537 
	`li¡_fÜ_—ch_’Œy
(
tg
, &
dg
->
tg_li¡
, 
’Œy
) {

1539 *
p
++ = (
tg
->
´eã¼ed
 ? 
SCST_TG_PREFERRED
 : 0è|g->
¡©e
;

1540 *
p
++ = 
SCST_TG_SUP_OPTIMIZED


1541 | 
SCST_TG_SUP_NONOPTIMIZED


1542 | 
SCST_TG_SUP_STANDBY


1543 | 
SCST_TG_SUP_UNAVAILABLE
;

1544 
	`put_uÇligÃd_be16
(
tg
->
group_id
, 
p
);

1545 
p
 += 2;

1546 
p
++;

1547 *
p
++ = 2;

1548 
p
++;

1549 
	`li¡_fÜ_—ch_’Œy
(
tgtgt
, &
tg
->
tgt_li¡
, 
’Œy
)

1550 (*
p
)++;

1551 
p
++;

1552 
	`li¡_fÜ_—ch_’Œy
(
tgtgt
, &
tg
->
tgt_li¡
, 
’Œy
) {

1553 
tgt
 = 
tgtgt
->tgt;

1554 
»l_tgt_id
 = 
tgt
 ?gt->»l_tgt_id : 
tgtgt
->rel_tgt_id;

1556 
p
 += 2;

1558 
	`put_uÇligÃd_be16
(
»l_tgt_id
, 
p
);

1559 
p
 += 2;

1563 
dÚe
:

1564 
	`WARN_ON
(
p
 - (
ušt8_t
 *)*
buf
 !ð*
Ëngth
);

1566 
»s
 = 0;

1568 
out_uÆock
:

1569 
	`mu‹x_uÆock
(&
sc¡_dg_mu‹x
);

1570 
out
:

1571 
	`TRACE_EXIT_RES
(
»s
);

1572  
»s
;

1573 
	}
}

1574 
EXPORT_SYMBOL_GPL
(
sc¡_tg_g‘_group_šfo
);

1576 
	ssc¡_¡pg_wa™
 {

1577 
©omic_t
 
	m¡pg_wa™_Ëá
;

1578 
	m¡©us
;

1579 
sc¡_dev_group
 *
	mdg
;

1580 
sc¡_ev’t_’Œy
 *
	mev’t_’Œy
;

1584 
	$sc¡_¡pg_check_blockšg_dÚe
(
sc¡_¡pg_wa™
 *
wa™
)

1586 
	`TRACE_ENTRY
();

1588 
	`TRACE_DBG
("wa™ %p,†eá %d", 
wa™
, 
	`©omic_»ad
(&wa™->
¡pg_wa™_Ëá
));

1590 ià(
	`©omic_dec_ªd_‹¡
(&
wa™
->
¡pg_wa™_Ëá
)) {

1591 ià(
wa™
->
¡©us
 == 0)

1592 
	`sc¡_ev’t_queue
(
SCST_EVENT_STPG_USER_INVOKE
,

1593 
SCST_EVENT_SCST_CORE_ISSUER
, 
wa™
->
ev’t_’Œy
);

1595 
wa™
->
ev’t_’Œy
->
	`ev’t_nÙify_â
(&wa™->ev’t_’Œy->
ev’t
,

1596 
wa™
->
ev’t_’Œy
->
nÙify_â_´iv
, wa™->
¡©us
);

1598 
	`kä“
(
wa™
);

1601 
	`TRACE_EXIT
();

1603 
	}
}

1606 
	$sc¡_¡pg_ext_blockšg_dÚe
(
sc¡_deviû
 *
dev
,

1607 
ušt8_t
 *
d©a
, 
Ën
)

1609 
	`sBUG_ON
(
Ën
 !ð(
d©a
));

1610 
	`sc¡_¡pg_check_blockšg_dÚe
(*((
sc¡_¡pg_wa™
 **)
d©a
));

1611 
	}
}

1624 
	$sc¡_tg_£t_group_šfo
(
sc¡_cmd
 *
cmd
)

1626 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

1627 
ušt8_t
 *
buf
;

1628 
Ën
;

1629 
i
, 
j
, 
»s
 = 1, 
g_desc_couÁ
, 
v®id_desc_couÁ
;

1630 
sc¡_dev_group
 *
dg
;

1631 
	sosi
 {

1632 
ušt16_t
 
group_id
;

1633 
sc¡_rg‘_group
 *
tg
;

1634 
sc¡_tg_¡©e
 
´ev_¡©e
;

1635 
sc¡_tg_¡©e
 
Ãw_¡©e
;

1636 } *
osi
 = 
NULL
;

1637 
ev’t_’Œy_Ën
, 
·ylßd_Ën
;

1638 
sc¡_ev’t_’Œy
 *
ev’t_’Œy
;

1639 
sc¡_ev’t
 *
ev’t
;

1640 
sc¡_ev’t_¡pg_·ylßd
 *
·ylßd
;

1641 
sc¡_ev’t_¡pg_desü
 *
desü
;

1643 
	`TRACE_ENTRY
();

1645 
Ën
 = 
	`sc¡_g‘_buf_fuÎ
(
cmd
, &
buf
);

1646 ià(
Ën
 < 0) {

1647 
	`PRINT_ERROR
("sc¡_g‘_buf_fuÎ(èçžed: %d", 
Ën
);

1648 
»s
 = 
Ën
;

1649 ià(
Ën
 =ð-
ENOMEM
)

1650 
	`sc¡_£t_busy
(
cmd
);

1652 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1653 
out
;

1662 ià(
Ën
 == 0)

1663 
out_put
;

1665 
g_desc_couÁ
 = (
Ën
 - 4) / 4;

1667 ià(
g_desc_couÁ
 > 64) {

1668 
	`PRINT_ERROR
("Too many STPG descriptors (%d) for dev %s",

1669 
g_desc_couÁ
, 
dev
->
vœt_Çme
);

1670 
»s
 = -
EINVAL
;

1671 
	`sc¡_£t_šv®id_f›ld_š_cdb
(
cmd
, 6, 0);

1672 
out_put
;

1675 
	`TRACE_DBG
("g_desc_couÁ %d", 
g_desc_couÁ
);

1677 
osi
 = 
	`kÿÎoc
(
g_desc_couÁ
, (*osi), 
GFP_KERNEL
);

1678 ià(!
osi
) {

1679 
»s
 = -
ENOMEM
;

1680 
	`sc¡_£t_busy
(
cmd
);

1681 
out_put
;

1684 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

1685 ià(
»s
) {

1686 
	`PRINT_INFO
("mutex_lock_interruptible()„eturned %d, finishing "

1687 "cmd %p", 
»s
, 
cmd
);

1688 
	`sc¡_£t_busy
(
cmd
);

1689 
out_put
;

1692 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_dg_mu‹x
);

1693 ià(
»s
) {

1694 
	`PRINT_INFO
("mutex_lock_interruptible()„eturned %d, finishing "

1695 "cmd %p", 
»s
, 
cmd
);

1696 
	`sc¡_£t_busy
(
cmd
);

1697 
out_uÆock_sm_çž
;

1700 
dg
 = 
	`__lookup_dg_by_dev
(
dev
);

1701 ià(!
dg
) {

1702 
»s
 = -
EINVAL
;

1703 
out_uÆock_çž
;

1706 
	`TRACE_DBG
("dg % (%pèfound, dev %s", 
dg
->
Çme
, dg, 
dev
->
vœt_Çme
);

1708 
i
 = 4, 
j
 = 0; i + 4 <ð
Ën
; i += 4, j++) {

1709 #iâdeà
__CHECKER__


1714 
	`WARN_ON_ONCE
(
j
 >ð
g_desc_couÁ
);

1716 
osi
[
j
].
Ãw_¡©e
 = 
buf
[
i
] & 0x1f;

1717 
osi
[
j
].
Ãw_¡©e
) {

1718 
SCST_TG_STATE_OPTIMIZED
:

1719 
SCST_TG_STATE_NONOPTIMIZED
:

1720 
SCST_TG_STATE_STANDBY
:

1721 
SCST_TG_STATE_UNAVAILABLE
:

1722 
SCST_TG_STATE_OFFLINE
:

1725 
	`TRACE_MGMT_DBG
("IncÜ»ù‚ew s‹ %d", 
osi
[
j
].
Ãw_¡©e
);

1726 
»s
 = -
EINVAL
;

1727 
out_uÆock_çž
;

1730 
osi
[
j
].
group_id
 = 
	`g‘_uÇligÃd_be16
(&
buf
[
i
 + 2]);

1731 ià(!
osi
[
j
].
group_id
) {

1732 
	`TRACE_MGMT_DBG
("Inv®id group_id %d", 
osi
[
j
].
group_id
);

1733 
»s
 = -
EINVAL
;

1734 
out_uÆock_çž
;

1737 
osi
[
j
].
tg
 = 
	`__lookup_tg_by_group_id
(
dg
, osi[j].
group_id
);

1738 ià(!
osi
[
j
].
tg
) {

1739 
	`TRACE_MGMT_DBG
("NØTG fÜ group_id %d", 
osi
[
j
].
group_id
);

1740 
»s
 = -
ESRCH
;

1741 
out_uÆock_çž
;

1744 ià(
osi
[
j
].
tg
->
¡©e
 =ð
SCST_TG_STATE_TRANSITIONING
) {

1745 
	`TRACE_MGMT_DBG
("TG %°i Œªs™iÚšg", 
osi
[
j
].
tg
);

1746 
»s
 = -
EBUSY
;

1747 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1748 
	`SCST_LOAD_SENSE
(
sc¡_£n£_®ua_Œªs™iÚšg
));

1750 
out_uÆock_çž
;

1752 
osi
[
j
].
´ev_¡©e
 = osi[j].
tg
->
¡©e
;

1754 
	`TRACE_DBG
("j %d, group_id %u,g % (%p), s‹ %d", 
j
, 
osi
[j].
group_id
,

1755 
osi
[
j
].
tg
->
Çme
, osi[j].tg, osi[j].tg->
¡©e
);

1758 
	`mu‹x_uÆock
(&
sc¡_dg_mu‹x
);

1759 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1761 
	`sc¡_put_buf_fuÎ
(
cmd
, 
buf
);

1763 
·ylßd_Ën
 = (*
·ylßd
è+ (*
desü
è* 
g_desc_couÁ
;

1764 
ev’t_’Œy_Ën
 = (*
ev’t_’Œy
è+ 
·ylßd_Ën
;

1765 
ev’t_’Œy
 = 
	`kz®loc
(
ev’t_’Œy_Ën
, 
GFP_KERNEL
);

1766 ià(
ev’t_’Œy
 =ð
NULL
) {

1767 
	`PRINT_ERROR
("UÇbËØ®loÿ‹ƒv’ˆ(siz%d)", 
ev’t_’Œy_Ën
);

1768 
»s
 = -
ENOMEM
;

1769 
	`sc¡_£t_busy
(
cmd
);

1770 
out_ä“
;

1773 
	`TRACE_MEM
("ev’t_’Œy %°Ö’ %dè®loÿ‹d", 
ev’t_’Œy
,

1774 
ev’t_’Œy_Ën
);

1776 
ev’t
 = &
ev’t_’Œy
->event;

1777 
ev’t
->
·ylßd_Ën
 =…ayload_len;

1779 
·ylßd
 = (
sc¡_ev’t_¡pg_·ylßd
 *)
ev’t
->payload;

1780 
·ylßd
->
¡pg_cmd_g
 = 
cmd
->
g
;

1782 
»s
 = 1;

1784 ià(
	`¡¾’
(
dev
->
vœt_Çme
è>ð(
·ylßd
->
deviû_Çme
)) {

1785 
	`PRINT_ERROR
("Deviû‚am% toØlÚg", 
dev
->
vœt_Çme
);

1786 
out_too_lÚg
;

1788 
	`¡¾ýy
(
·ylßd
->
deviû_Çme
, 
dev
->
vœt_Çme
, (payload->device_name));

1790 
v®id_desc_couÁ
 = 0;

1791 
j
 = 0, 
desü
 = &
·ylßd
->
¡pg_desütÜs
[0]; j < 
g_desc_couÁ
; j++) {

1792 ià(
osi
[
j
].
´ev_¡©e
 =ðosi[j].
Ãw_¡©e
)

1795 ià(
	`¡¾’
(
	`sc¡_®ua_¡©e_Çme
(
osi
[
j
].
´ev_¡©e
)è>ð(
desü
->prev_state)) {

1796 
	`PRINT_ERROR
("´ev s‹oØlÚg (%d)", 
osi
[
j
].
´ev_¡©e
);

1797 
out_too_lÚg
;

1799 
	`¡¾ýy
(
desü
->
´ev_¡©e
, 
	`sc¡_®ua_¡©e_Çme
(
osi
[
j
].prev_state),

1800 (
desü
->
´ev_¡©e
));

1802 ià(
	`¡¾’
(
	`sc¡_®ua_¡©e_Çme
(
osi
[
j
].
Ãw_¡©e
)è>ð(
desü
->new_state)) {

1803 
	`PRINT_ERROR
("Ãw s‹oØlÚg (%d)", 
osi
[
j
].
Ãw_¡©e
);

1804 
out_too_lÚg
;

1806 
	`¡¾ýy
(
desü
->
Ãw_¡©e
, 
	`sc¡_®ua_¡©e_Çme
(
osi
[
j
].new_state),

1807 (
desü
->
Ãw_¡©e
));

1809 ià(
	`¡¾’
(
dg
->
Çme
è>ð(
desü
->
dg_Çme
)) {

1810 
	`PRINT_ERROR
("dg_ÇmtoØlÚg (%s)", 
dg
->
Çme
);

1811 
out_too_lÚg
;

1813 
	`¡¾ýy
(
desü
->
dg_Çme
, 
dg
->
Çme
, (descr->dg_name));

1815 ià(
	`¡¾’
(
osi
[
j
].
tg
->
Çme
è>ð(
desü
->
tg_Çme
)) {

1816 
	`PRINT_ERROR
("tg_ÇmtoØlÚg (%s)", 
osi
[
j
].
tg
->
Çme
);

1817 
out_too_lÚg
;

1819 
	`¡¾ýy
(
desü
->
tg_Çme
, 
osi
[
j
].
tg
->
Çme
,

1820 (
desü
->
tg_Çme
));

1822 
desü
->
group_id
 = 
osi
[
j
].group_id;

1824 
	`TRACE_DBG
("group_id %u,…rev_state %s,‚ew_state %s, dg_name %s, "

1825 "tg_Çm%s", 
desü
->
group_id
, desü->
´ev_¡©e
,

1826 
desü
->
Ãw_¡©e
, desü->
dg_Çme
, desü->
tg_Çme
);

1828 
v®id_desc_couÁ
++;

1829 
desü
++;

1832 
·ylßd
->
¡pg_desütÜs_út
 = 
v®id_desc_couÁ
;

1834 ià(
v®id_desc_couÁ
 > 0) {

1835 
sc¡_dg_dev
 *
dgd
;

1836 
sc¡_¡pg_wa™
 *
wa™
;

1837 
rc
;

1839 
dg
->
¡pg_»l_tgt_id
 = 
cmd
->
tgt
->
»l_tgt_id
;

1840 
dg
->
¡pg_Œª¥Üt_id
 = 
	`kmemdup
(
cmd
->
£ss
->
Œª¥Üt_id
,

1841 
	`sc¡_tid_size
(
cmd
->
£ss
->
Œª¥Üt_id
), 
GFP_KERNEL
);

1842 ià(
dg
->
¡pg_Œª¥Üt_id
 =ð
NULL
) {

1843 
	`PRINT_ERROR
("Unableo duplicate stpg_transport_id");

1844 
out_ä“_ev’t
;

1847 
wa™
 = 
	`kz®loc
((*wa™), 
GFP_KERNEL
);

1848 ià(
wa™
 =ð
NULL
) {

1849 
	`PRINT_ERROR
("Unableo‡llocate STPG wait struct "

1850 "(siz%zd)", (*
wa™
));

1851 
	`sc¡_£t_busy
(
cmd
);

1852 
»s
 = -
ENOMEM
;

1853 
out_ä“_Œ_id
;

1856 
	`©omic_£t
(&
wa™
->
¡pg_wa™_Ëá
, 1);

1857 
wa™
->
ev’t_’Œy
 =ƒvent_entry;

1859 
ev’t_’Œy
->
ev’t_nÙify_â
 = 
sc¡_ev’t_¡pg_nÙify_â
;

1860 
ev’t_’Œy
->
nÙify_â_´iv
 = 
cmd
;

1862 
	`mu‹x_lock
(&
sc¡_dg_mu‹x
);

1863 
	`li¡_fÜ_—ch_’Œy
(
dgd
, &
dg
->
dev_li¡
, 
’Œy
) {

1864 ià(
dgd
->
dev
 == dev)

1867 
	`TRACE_DBG
("STPG:ƒxˆblockšg dev %s", 
dgd
->
dev
->
vœt_Çme
);

1869 
	`©omic_šc
(&
wa™
->
¡pg_wa™_Ëá
);

1871 
rc
 = 
	`sc¡_ext_block_dev
(
dgd
->
dev
, 
sc¡_¡pg_ext_blockšg_dÚe
,

1872 (
ušt8_t
 *)&
wa™
, (wa™), 
SCST_EXT_BLOCK_STPG
);

1873 ià(
rc
 != 0) {

1874 
	`TRACE_DBG
("scst_ext_block_dev() failed "

1875 "w™h %d,„ev”tšg (cmd %p)", 
rc
, 
cmd
);

1876 
wa™
->
¡©us
 = 
rc
;

1877 
wa™
->
dg
 = dg;

1878 
	`©omic_dec
(&
wa™
->
¡pg_wa™_Ëá
);

1879 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

1880 
	`WARN_ON
(
dgd
->
dev
->
¡pg_ext_blocked
);

1881 
dgd
->
dev
->
¡pg_ext_blocked
 = 0;

1882 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

1886 
	`mu‹x_uÆock
(&
sc¡_dg_mu‹x
);

1888 
	`sc¡_¡pg_check_blockšg_dÚe
(
wa™
);

1891 
	`TRACE_DBG
("Nothingo do");

1892 
out_ä“_ev’t
;

1895 
»s
 = 0;

1897 
out_ä“
:

1898 
	`kä“
(
osi
);

1900 
out
:

1901 
	`TRACE_EXIT_RES
(
»s
);

1902  
»s
;

1904 
out_uÆock_çž
:

1905 
	`mu‹x_uÆock
(&
sc¡_dg_mu‹x
);

1907 
out_uÆock_sm_çž
:

1908 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1910 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_£t_rg‘_pgs_çžed
));

1912 
out_put
:

1913 
	`sc¡_put_buf_fuÎ
(
cmd
, 
buf
);

1914 
out_ä“
;

1916 
out_too_lÚg
:

1917 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_£t_rg‘_pgs_çžed
));

1918 
»s
 = -
EOVERFLOW
;

1920 
out_ä“_Œ_id
:

1921 
	`kä“
(
dg
->
¡pg_Œª¥Üt_id
);

1923 
out_ä“_ev’t
:

1924 
	`kä“
(
ev’t_’Œy
);

1925 
out_ä“
;

1926 
	}
}

1927 
EXPORT_SYMBOL_GPL
(
sc¡_tg_£t_group_šfo
);

	@usr/events/debug.c

1 
	~"../šþude/debug.c
"

	@usr/events/events.c

5 
	~<ùy³.h
>

6 
	~<”ºo.h
>

7 
	~<fúŽ.h
>

8 
	~<¡dio.h
>

9 
	~<¡dlib.h
>

10 
	~<¡ršg.h
>

11 
	~<uni¡d.h
>

12 
	~<¡dšt.h
>

13 
	~<g‘Ýt.h
>

14 
	~<m®loc.h
>

15 
	~<š‰y³s.h
>

16 
	~<¡dboÞ.h
>

17 
	~<sigÇl.h
>

18 
	~<sys/ty³s.h
>

19 
	~<sys/u£r.h
>

20 
	~<sys/pÞl.h
>

21 
	~<sys/ioùl.h
>

23 
	~<±h»ad.h
>

25 
	~"v”siÚ.h
"

26 
	~"debug.h
"

27 
	~"sc¡_ev’t.h
"

29 *
	g­p_Çme
;

31 #ià
defšed
(
DEBUG
è|| defšed(
TRACING
)

33 #ifdeà
DEBUG


39 
	#DEFAULT_LOG_FLAGS
 (
TRACE_OUT_OF_MEM
 | 
TRACE_MINOR
 | 
TRACE_PID
 | \

40 
TRACE_FUNCTION
 | 
TRACE_SPECIAL
 | 
TRACE_MGMT
 | 
TRACE_MGMT_DEBUG
 | \

41 
TRACE_TIME
)

	)

43 
	#TRACE_SN
(
¬gs
...è
	`TRACE
(
TRACE_SCSI_SERIALIZING
,‡rgs)

	)

47 #ifdeà
TRACING


48 
	#DEFAULT_LOG_FLAGS
 (
TRACE_OUT_OF_MEM
 | 
TRACE_MGMT
 | \

49 
TRACE_TIME
 | 
TRACE_SPECIAL
)

	)

51 
	#DEFAULT_LOG_FLAGS
 0

	)

55 
boÞ
 
	glog_d«mÚ
 = 
çl£
;

56 
	gŒaû_æag
 = 
DEFAULT_LOG_FLAGS
;

59 
ÝtiÚ
 cÚ¡ 
	glÚg_ÝtiÚs
[] = {

60 {"®lowed_ev’t", 
»quœed_¬gum’t
, 0, 'e'},

61 {"®lowed_issu”", 
»quœed_¬gum’t
, 0, 'i'},

62 {"nÚ_blockšg", 
no_¬gum’t
, 0, 'n'},

63 #ià
defšed
(
DEBUG
è|| defšed(
TRACING
)

64 {"debug", 
»quœed_¬gum’t
, 0, 'd'},

66 {"v”siÚ", 
no_¬gum’t
, 0, 'v'},

67 {"h–p", 
no_¬gum’t
, 0, 'h'},

71 
	#MAX_ALLOWED_EVENTS
 16

	)

72 
sc¡_ev’t
 
	g®lowed_ev’ts
[
MAX_ALLOWED_EVENTS
];

73 
	g®lowed_ev’ts_num
;

74 
	gnÚ_blockšg
;

76 
	$u§ge
()

78 
	`´štf
("U§ge: % [OPTIONS]\n", 
­p_Çme
);

79 
	`´štf
("\nSCSTƒventsesting…rogram\n");

80 
	`´štf
(" -e, --allowed_event=code Allowedƒvent code, 0 -‡nyƒvent\n");

81 
	`´štf
(" -i, --allowed_issuer=issuer Allowed issuer, * -‡ny issuer\n");

82 
	`´štf
(" -n, --non_blocking Use‚on-blocking operations\n");

83 #ià
	`defšed
(
DEBUG
è|| defšed(
TRACING
)

84 
	`´štf
(" -d, --debug=level Debugracing†evel\n");

86 
	}
}

88 
	$hªdË_tm_»ûived
(
sc¡_ev’t_u£r
 *
ev’t_u£r
)

90 
sc¡_ev’t_tm_â_»ûived_·ylßd
 *
p
 = (sc¡_ev’t_tm_â_»ûived_·ylßd *)
ev’t_u£r
->
out_ev’t
.
·ylßd
;

92 
	`´štf
("â %d, deviû %s\n", 
p
->
â
,…->
deviû_Çme
);

95 
	}
}

97 
	$maš
(
¬gc
, **
¬gv
)

99 
»s
 = 0, 
i
;

100 
ch
, 
lÚgšdex
;

101 
ev’t_fd
;

102 
ušt8_t
 
ev’t_u£r_buf
[10240];

103 
sc¡_ev’t_u£r
 *
ev’t_u£r
 = (sc¡_ev’t_u£¸*)
ev’t_u£r_buf
;

104 
pÞlfd
 
¶
;

106 
	`£Žšebuf
(
¡dout
);

108 
»s
 = 
	`debug_š™
();

109 ià(
»s
 != 0)

110 
out
;

112 
­p_Çme
 = 
¬gv
[0];

114 (
ch
 = 
	`g‘Ýt_lÚg
(
¬gc
, 
¬gv
, "+e:i:d:nhv",

115 
lÚg_ÝtiÚs
, &
lÚgšdex
)) >= 0) {

116 
ch
) {

118 ià(
®lowed_ev’ts
[
®lowed_ev’ts_num
].
ev’t_code
 != 0) {

119 
®lowed_ev’ts_num
++;

120 ià(
®lowed_ev’ts_num
 >ð
MAX_ALLOWED_EVENTS
) {

121 
	`PRINT_ERROR
("Too many‡llowedƒvents %d",

122 
®lowed_ev’ts_num
);

123 
	`ex™
(1);

126 
®lowed_ev’ts
[
®lowed_ev’ts_num
].
ev’t_code
 = 
	`©oi
(
Ýrg
);

129 ià(
®lowed_ev’ts
[
®lowed_ev’ts_num
].
issu”_Çme
[0] != '\0') {

130 
®lowed_ev’ts_num
++;

131 ià(
®lowed_ev’ts_num
 >ð
MAX_ALLOWED_EVENTS
) {

132 
	`PRINT_ERROR
("Too many‡llowedƒvents %d",

133 
®lowed_ev’ts_num
);

134 
	`ex™
(1);

137 
	`¡ºýy
(
®lowed_ev’ts
[
®lowed_ev’ts_num
].
issu”_Çme
,

138 
Ýrg
, (
®lowed_ev’ts
[
®lowed_ev’ts_num
].
issu”_Çme
));

139 
®lowed_ev’ts
[
®lowed_ev’ts_num
].
issu”_Çme
[

140 (
®lowed_ev’ts
[
®lowed_ev’ts_num
].
issu”_Çme
)-1] = '\0';

143 
nÚ_blockšg
 = 1;

145 #ià
	`defšed
(
DEBUG
è|| defšed(
TRACING
)

147 
Œaû_æag
 = 
	`¡¹Þ
(
Ýrg
, (**)
NULL
, 0);

151 
	`´štf
("% v”siÚ %s\n", 
­p_Çme
, 
VERSION_STR
);

152 
out_dÚe
;

154 
out_u§ge
;

158 ià(
®lowed_ev’ts_num
 == 0) {

159 ià((
®lowed_ev’ts
[0].
ev’t_code
 == 0) &&

160 (
®lowed_ev’ts
[0].
issu”_Çme
[0] == '\0'))

161 
®lowed_ev’ts
[0].
issu”_Çme
[0] = '*';

164 
®lowed_ev’ts_num
++;

166 #ifdeà
DEBUG


167 
	`PRINT_INFO
("Œaû_æag %lx", 
Œaû_æag
);

170 ià(
nÚ_blockšg
)

171 
	`PRINT_INFO
("%s", "NON-BLOCKING");

173 
ev’t_fd
 = 
	`Ý’
(
SCST_EVENT_DEV
, 
O_RDWR
 | (
nÚ_blockšg
 ? 
O_NONBLOCK
 : 0));

174 ià(
ev’t_fd
 < 0) {

175 
»s
 = -
”ºo
;

176 
	`PRINT_ERROR
("Unableo open SCSTƒvent device %s (%s)",

177 
SCST_EVENT_DEV
, 
	`¡»¼Ü
(-
»s
));

178 
out_dÚe
;

181 
	`mem£t
(&
¶
, 0, (pl));

182 
¶
.
fd
 = 
ev’t_fd
;

183 
¶
.
ev’ts
 = 
POLLIN
;

185 
i
 = 0; i < 
®lowed_ev’ts_num
; i++) {

186 
sc¡_ev’t
 
e
;

188 
	`PRINT_INFO
("Setting‡llowedƒvent code %d, issuer_name %s",

189 
®lowed_ev’ts
[
i
].
ev’t_code
,

190 
®lowed_ev’ts
[
i
].
issu”_Çme
);

191 
	`mem£t
(&
e
, 0, (e));

192 
e
.
ev’t_code
 = 
®lowed_ev’ts
[
i
].event_code;

193 
	`¡ºýy
(
e
.
issu”_Çme
, 
®lowed_ev’ts
[
i
].issuer_name,

194 (
e
.
issu”_Çme
));

195 
e
.
issu”_Çme
[(e.issuer_name)-1] = '\0';

197 
»s
 = 
	`ioùl
(
ev’t_fd
, 
SCST_EVENT_ALLOW_EVENT
, &
e
);

198 ià(
»s
 != 0) {

199 
	`PRINT_ERROR
("SCST_EVENT_ALLOW_EVENT failed: %s (res %d)",

200 
	`¡»¼Ü
(
”ºo
), 
»s
);

201 
out_dÚe
;

206 
	`mem£t
(
ev’t_u£r_buf
, 0, (event_user_buf));

207 
ev’t_u£r
->
max_ev’t_size
 = (
ev’t_u£r_buf
);

208 
»s
 = 
	`ioùl
(
ev’t_fd
, 
SCST_EVENT_GET_NEXT_EVENT
, 
ev’t_u£r
);

209 ià(
»s
 != 0) {

210 
»s
 = 
”ºo
;

211 
»s
) {

212 
ESRCH
:

213 
EBUSY
:

214 
	`TRACE_MGMT_DBG
("SCST_EVENT_GET_NEXT_EVENT„eturned "

215 "%d (%s)", 
»s
, 
	`¡»¼Ü
(res));

217 
EINTR
:

219 
EAGAIN
:

220 
	`TRACE_DBG
("SCST_EVENT_GET_NEXT_EVENT,„eturned "

221 "EAGAIN (%d)", 
»s
);

222 ià(
nÚ_blockšg
)

227 
	`PRINT_ERROR
("SCST_EVENT_GET_NEXT_EVENT failed: %s (res %d)",

228 
	`¡»¼Ü
(
”ºo
), 
»s
);

229 
out_dÚe
;

231 
agaš_pÞl
:

232 
»s
 = 
	`pÞl
(&
¶
, 1, 2000);

233 ià(
»s
 > 0)

235 ià(
»s
 == 0)

236 
agaš_pÞl
;

238 
»s
 = 
”ºo
;

239 
»s
) {

240 
ESRCH
:

241 
EBUSY
:

242 
EAGAIN
:

243 
	`TRACE_MGMT_DBG
("poll()„eturned %d "

244 "(%s)", 
»s
, 
	`¡»¼Ü
(res));

245 
EINTR
:

246 
agaš_pÞl
;

248 
	`PRINT_ERROR
("pÞl(èçžed: %s", 
	`¡»¼Ü
(
»s
));

250 
agaš_pÞl
;

252 
out_þo£
;

259 
	`PRINT_INFO
("\nevent_code %d, issuer_name %s",

260 
ev’t_u£r
->
out_ev’t
.
ev’t_code
,

261 
ev’t_u£r
->
out_ev’t
.
issu”_Çme
);

262 ià(
ev’t_u£r
->
out_ev’t
.
·ylßd_Ën
 != 0)

263 
	`PRINT_BUFFER
("·yßd", 
ev’t_u£r
->
out_ev’t
.
·ylßd
,

264 
ev’t_u£r
->
out_ev’t
.
·ylßd_Ën
);

265 
	`PRINT_INFO
("%s", "");

267 ià(
ev’t_u£r
->
out_ev’t
.
ev’t_code
 == 0x12345) {

268 
sc¡_ev’t_nÙify_dÚe
 
d
;

270 
	`PRINT_INFO
("%s", "Press‡ny keyo send„eplyoƒvent "

272 
	`g‘ch¬
();

274 
	`mem£t
(&
d
, 0, (d));

275 
d
.
ev’t_id
 = 
ev’t_u£r
->
out_ev’t
.event_id;

276 
d
.
¡©us
 = -19;

277 
»s
 = 
	`ioùl
(
ev’t_fd
, 
SCST_EVENT_NOTIFY_DONE
, &
d
);

278 ià(
»s
 != 0)

279 
	`PRINT_ERROR
("SCST_EVENT_NOTIFY_DONE failed: %s "

280 "Ôe %d)", 
	`¡»¼Ü
(
”ºo
), 
»s
);

281 } ià(
ev’t_u£r
->
out_ev’t
.
ev’t_code
 =ð
SCST_EVENT_TM_FN_RECEIVED
)

282 
	`hªdË_tm_»ûived
(
ev’t_u£r
);

283 ià(
ev’t_u£r
->
out_ev’t
.
ev’t_code
 =ð
SCST_EVENT_TM_FN_RECEIVED
) {

284 
sc¡_ev’t_nÙify_dÚe
 
d
;

286 
	`mem£t
(&
d
, 0, (d));

287 
d
.
ev’t_id
 = 
ev’t_u£r
->
out_ev’t
.event_id;

288 
d
.
¡©us
 = -20;

289 
»s
 = 
	`ioùl
(
ev’t_fd
, 
SCST_EVENT_NOTIFY_DONE
, &
d
);

290 ià(
»s
 != 0)

291 
	`PRINT_ERROR
("SCST_EVENT_NOTIFY_DONE failed: %s "

292 "Ôe %d)", 
	`¡»¼Ü
(
”ºo
), 
»s
);

297 
sc¡_ev’t
 
e
;

299 
	`PRINT_INFO
("Deleting‡llowedƒvent code %d, issuer_name %s",

300 
®lowed_ev’ts
[0].
ev’t_code
,

301 
®lowed_ev’ts
[0].
issu”_Çme
);

302 
	`mem£t
(&
e
, 0, (e));

303 
e
.
ev’t_code
 = 
®lowed_ev’ts
[0].event_code;

304 
	`¡ºýy
(
e
.
issu”_Çme
, 
®lowed_ev’ts
[0].issuer_name,

305 (
e
.
issu”_Çme
));

306 
e
.
issu”_Çme
[(e.issuer_name)-1] = '\0';

308 
»s
 = 
	`ioùl
(
ev’t_fd
, 
SCST_EVENT_DISALLOW_EVENT
, &
e
);

309 ià(
»s
 != 0) {

310 
	`PRINT_ERROR
("SCST_EVENT_DISALLOW_EVENT failed: "

311 "% Ôe %d)", 
	`¡»¼Ü
(
”ºo
), 
»s
);

317 
out_dÚe
:

318 
	`debug_dÚe
();

320 
out
:

321  
»s
;

323 
out_u§ge
:

324 
	`u§ge
();

325 
out_dÚe
;

326 
	}
}

	@usr/fileio/common.c

18 
	~<ùy³.h
>

19 
	~<”ºo.h
>

20 
	~<fúŽ.h
>

21 
	~<¡dio.h
>

22 
	~<¡dlib.h
>

23 
	~<¡ršg.h
>

24 
	~<uni¡d.h
>

25 
	~<¡dšt.h
>

26 
	~<g‘Ýt.h
>

27 
	~<š‰y³s.h
>

29 
	~<sys/ioùl.h
>

30 
	~<sys/pÞl.h
>

32 
	~<¬·/š‘.h
>

34 
	~<±h»ad.h
>

36 
	~"commÚ.h
"

38 
exec_šquœy
(
vdisk_cmd
 *
vcmd
);

39 
exec_»que¡_£n£
(
vdisk_cmd
 *
vcmd
);

40 
exec_mode_£n£
(
vdisk_cmd
 *
vcmd
);

41 
exec_mode_£Ëù
(
vdisk_cmd
 *
vcmd
);

42 
exec_»ad_ÿ·c™y
(
vdisk_cmd
 *
vcmd
);

43 
exec_»ad_ÿ·c™y16
(
vdisk_cmd
 *
vcmd
);

44 
exec_»ad_toc
(
vdisk_cmd
 *
vcmd
);

45 
exec_´ev’t_®low_medium_»mov®
(
vdisk_cmd
 *
vcmd
);

46 
exec_fsync
(
vdisk_cmd
 *
vcmd
);

47 
exec_»ad
(
vdisk_cmd
 *
vcmd
, 
loff_t
 
loff
);

48 
exec_wr™e
(
vdisk_cmd
 *
vcmd
, 
loff_t
 
loff
);

49 
exec_v”ify
(
vdisk_cmd
 *
vcmd
, 
loff_t
 
loff
);

50 
exec_wr™e_§me
(
vdisk_cmd
 *
vcmd
);

52 
	$Ý’_dev_fd
(
vdisk_dev
 *
dev
)

54 
»s
;

55 
Ý’_æags
 = 
O_LARGEFILE
;

57 ià(
dev
->
rd_Úly_æag
)

58 
Ý’_æags
 |ð
O_RDONLY
;

60 
Ý’_æags
 |ð
O_RDWR
;

61 ià(
dev
->
o_dœeù_æag
)

62 
Ý’_æags
 |ð
O_DIRECT
;

63 ià(
dev
->
wt_æag
)

64 
Ý’_æags
 |ð
O_DSYNC
;

66 
	`TRACE_DBG
("O³nšg fž%s, fÏg 0x%x", 
dev
->
fže_Çme
, 
Ý’_æags
);

67 
»s
 = 
	`Ý’
(
dev
->
fže_Çme
, 
Ý’_æags
);

69  
»s
;

70 
	}
}

72 
	$£t_»¥_d©a_Ën
(
vdisk_cmd
 *
vcmd
, 
št32_t
 
»¥_d©a_Ën
)

74 
sc¡_u£r_scsi_cmd_»¶y_exec
 *
»¶y
 = &
vcmd
->»¶y->
exec_»¶y
;

76 
	`TRACE_ENTRY
();

78 ià(
vcmd
->
may_Ãed_to_ä“_pbuf
 && (
»¥_d©a_Ën
 == 0)) {

79 
sc¡_u£r_scsi_cmd_exec
 *
cmd
 = &
vcmd
->cmd->
exec_cmd
;

80 
	`ä“
((*)()
cmd
->
pbuf
);

81 
cmd
->
pbuf
 = 0;

82 
»¶y
->
pbuf
 = 0;

85 
»¶y
->
»¥_d©a_Ën
 =„esp_data_len;

87 
	`TRACE_EXIT
();

89 
	}
}

91 
šlše
 
	$£t_cmd_”rÜ_¡©us
(
vdisk_cmd
 *
vcmd
,

92 
¡©us
)

94 
sc¡_u£r_scsi_cmd_»¶y_exec
 *
»¶y
 = &
vcmd
->»¶y->
exec_»¶y
;

95 
»¶y
->
¡©us
 = status;

96 
	`£t_»¥_d©a_Ën
(
vcmd
, 0);

98 
	}
}

100 
	$£t_£n£
(
ušt8_t
 *
bufãr
, 
Ën
, 
key
, 
asc
, 
ascq
)

102 
»s
 = 18;

104 
	`EXTRACHECKS_BUG_ON
(
Ën
 < 
»s
);

106 
	`mem£t
(
bufãr
, 0, 
»s
);

108 
bufãr
[0] = 0x70;

109 
bufãr
[2] = 
key
;

110 
bufãr
[7] = 0x0a;

111 
bufãr
[12] = 
asc
;

112 
bufãr
[13] = 
ascq
;

114 
	`TRACE_BUFFER
("S’£ s‘", 
bufãr
, 
»s
);

115  
»s
;

116 
	}
}

123 
	$£t_cmd_”rÜ
(
vdisk_cmd
 *
vcmd
, 
key
, 
asc
, 
ascq
)

125 
sc¡_u£r_scsi_cmd_»¶y_exec
 *
»¶y
 = &
vcmd
->»¶y->
exec_»¶y
;

127 
	`TRACE_ENTRY
();

129 
	`EXTRACHECKS_BUG_ON
(
vcmd
->
cmd
->
subcode
 !ð
SCST_USER_EXEC
);

131 
	`£t_cmd_”rÜ_¡©us
(
vcmd
, 
SAM_STAT_CHECK_CONDITION
);

132 
»¶y
->
£n£_Ën
 = 
	`£t_£n£
(
vcmd
->
£n£
, (vcmd->£n£), 
key
,

133 
asc
, 
ascq
);

134 
»¶y
->
p£n£_bufãr
 = ()
vcmd
->
£n£
;

136 
	`TRACE_EXIT
();

138 
	}
}

140 
	$£t_busy
(
vdisk_cmd
 *
vcmd
)

142 
	`TRACE_ENTRY
();

144 
	`£t_cmd_”rÜ_¡©us
(
vcmd
, 
SAM_STAT_TASK_SET_FULL
);

145 
	`TRACE_MGMT_DBG
("%s", "Sending QUEUE_FULL status");

147 
	`TRACE_EXIT
();

149 
	}
}

151 
	$do_·r£
(
vdisk_cmd
 *
vcmd
)

153 
»s
 = 0;

154 
sc¡_u£r_scsi_cmd_·r£
 *
cmd
 = &
vcmd
->cmd->
·r£_cmd
;

155 
sc¡_u£r_scsi_cmd_»¶y_·r£
 *
»¶y
 = &
vcmd
->»¶y->
·r£_»¶y
;

157 
	`TRACE_ENTRY
();

159 
	`mem£t
(
»¶y
, 0, (*reply));

160 
vcmd
->
»¶y
->
cmd_h
 = vcmd->
cmd
->cmd_h;

161 
vcmd
->
»¶y
->
subcode
 = vcmd->
cmd
->subcode;

163 ià(
cmd
->
ex³ùed_v®ues_£t
 == 0) {

164 
	`PRINT_ERROR
("%s", "Oops,ƒxpected values‡re‚ot set");

165 
»¶y
->
bufæ’
 = -1;

166 
out
;

169 
»¶y
->
queue_ty³
 = 
cmd
->queue_type;

170 
»¶y
->
d©a_dœeùiÚ
 = 
cmd
->
ex³ùed_d©a_dœeùiÚ
;

171 
»¶y
->
lba
 = 
cmd
->lba;

172 
»¶y
->
d©a_Ën
 = 
cmd
->
ex³ùed_Œªsãr_Ën
;

173 
»¶y
->
bufæ’
 = 
cmd
->
ex³ùed_Œªsãr_Ën
;

174 
»¶y
->
out_bufæ’
 = 
cmd
->
ex³ùed_out_Œªsãr_Ën
;

175 
»¶y
->
cdb_Ën
 = 
cmd
->cdb_len;

177 ià(
cmd
->
Ý_æags
 & 
SCST_INFO_VALID
)

178 
»¶y
->
Ý_æags
 = 
cmd
->op_flags;

180 
	`TRACE_DBG
("ExŒ¨·r£ (Ý %x)", 
cmd
->
cdb
[0]);

182 ià(
»¶y
->
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
)

183 
»¶y
->
Ý_æags
 |ð
SCST_WRITE_MEDIUM
;

184 
»¶y
->
Ý_æags
 |ð
SCST_INFO_VALID
;

187 
out
:

188 
	`TRACE_EXIT_RES
(
»s
);

189  
»s
;

190 
	}
}

192 
vdisk_tgt_dev
 *
	$fšd_tgt_dev
(
vdisk_dev
 *
dev
, 
ušt64_t
 
£ss_h
)

194 
i
;

195 
vdisk_tgt_dev
 *
»s
 = 
NULL
;

197 
i
 = 0; i < 
	`ARRAY_SIZE
(
dev
->
tgt_devs
); i++) {

198 ià(
dev
->
tgt_devs
[
i
].
£ss_h
 == sess_h) {

199 
»s
 = &
dev
->
tgt_devs
[
i
];

203  
»s
;

204 
	}
}

206 
vdisk_tgt_dev
 *
	$fšd_em±y_tgt_dev
(
vdisk_dev
 *
dev
)

208 
i
;

209 
vdisk_tgt_dev
 *
»s
 = 
NULL
;

211 
i
 = 0; i < 
	`ARRAY_SIZE
(
dev
->
tgt_devs
); i++) {

212 ià(
dev
->
tgt_devs
[
i
].
£ss_h
 == 0) {

213 
»s
 = &
dev
->
tgt_devs
[
i
];

217  
»s
;

218 
	}
}

220 
	$do_exec
(
vdisk_cmd
 *
vcmd
)

222 
»s
 = 0;

223 
vdisk_dev
 *
dev
 = 
vcmd
->dev;

224 
sc¡_u£r_scsi_cmd_exec
 *
cmd
 = &
vcmd
->cmd->
exec_cmd
;

225 
sc¡_u£r_scsi_cmd_»¶y_exec
 *
»¶y
 = &
vcmd
->»¶y->
exec_»¶y
;

226 
ušt64_t
 
lba_¡¬t
 = 
cmd
->
lba
;

227 
št64_t
 
d©a_Ën
 = 
cmd
->data_len;

228 
ušt8_t
 *
cdb
 = 
cmd
->cdb;

229 
Ýcode
 = 
cdb
[0];

230 
loff_t
 
loff
;

231 
fua
 = 0;

233 
	`TRACE_ENTRY
();

236 
vcmd
->
may_Ãed_to_ä“_pbuf
 = 0;

238 
cmd
->
queue_ty³
) {

239 
SCST_CMD_QUEUE_ORDERED
:

240 
	`TRACE
(
TRACE_ORDER
, "ORDERED cmd_h %d", 
vcmd
->
cmd
->
cmd_h
);

242 
SCST_CMD_QUEUE_HEAD_OF_QUEUE
:

243 
	`TRACE
(
TRACE_ORDER
, "HQ cmd_h %d", 
vcmd
->
cmd
->
cmd_h
);

249 
	`mem£t
(
»¶y
, 0, (*reply));

250 
vcmd
->
»¶y
->
cmd_h
 = vcmd->
cmd
->cmd_h;

251 
vcmd
->
»¶y
->
subcode
 = vcmd->
cmd
->subcode;

252 
»¶y
->
»¶y_ty³
 = 
SCST_EXEC_REPLY_COMPLETED
;

254 #ifdeà
DEBUG_SENSE


255 ià((
	`¿ndom
() % 100000) == 75) {

256 
	`£t_cmd_”rÜ
(
vcmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_š‹º®_çžu»
));

257 
out
;

261 #ifdeà
DEBUG_TM_IGNORE


262 ià(
dev
->
debug_tm_ignÜe
 && (
	`¿ndom
() % 10000) == 75) {

263 
	`TRACE_MGMT_DBG
("IgnÜcmd o°%x (h=%d)", 
cdb
[0],

264 
vcmd
->
cmd
->
cmd_h
);

265 
»s
 = 150;

266 
out
;

270 ià((
cmd
->
pbuf
 =ð0è&& (cmd->
®loc_Ën
 != 0)) {

271 #ifdeà
DEBUG_NOMEM


272 ià((
	`¿ndom
() % 100) == 75)

273 
cmd
->
pbuf
 = 0;

276 
cmd
->
pbuf
 = ()
dev
->
	`®loc_â
(cmd->
®loc_Ën
);

277 
vcmd
->
may_Ãed_to_ä“_pbuf
 = 1;

278 
	`TRACE_MEM
("Buà%"
PRIx64
"‡Îoûd,†’ %d", 
cmd
->
pbuf
,

279 
cmd
->
®loc_Ën
);

280 
»¶y
->
pbuf
 = 
cmd
->pbuf;

281 ià(
cmd
->
pbuf
 == 0) {

282 
	`TRACE
(
TRACE_OUT_OF_MEM
, "Unableo‡llocate buffer "

283 "Ö’ %d)", 
cmd
->
®loc_Ën
);

284 #iâdeà
DEBUG_NOMEM


285 
	`£t_busy
(
vcmd
);

287 
out
;

291 ià(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_READ
)

292 
»¶y
->
»¥_d©a_Ën
 = 
cmd
->
bufæ’
;

294 
loff
 = (
loff_t
)
lba_¡¬t
 << 
dev
->
block_shiá
;

295 
	`TRACE_DBG
("cmd %d, buà%"
PRIx64
",†ba_¡¬ˆ%"
PRId64
",†off %"PRId64

296 ", d©a_ËÀ%"
PRId64
, 
vcmd
->
cmd
->
cmd_h
, cmd->
pbuf
, 
lba_¡¬t
,

297 (
ušt64_t
)
loff
, 
d©a_Ën
);

298 ià((
loff
 < 0è|| (
d©a_Ën
 < 0è|| (Öofà+ d©a_Ënè> 
dev
->
fže_size
)) {

299 
	`PRINT_INFO
("Access beyondheƒnd ofhe device "

300 "(%"
PRId64
" oà%"PRId64",†’ %"PRId64")", (
ušt64_t
)
loff
,

301 (
ušt64_t
)
dev
->
fže_size
, 
d©a_Ën
);

302 
	`£t_cmd_”rÜ
(
vcmd
, 
	`SCST_LOAD_SENSE
(

303 
sc¡_£n£_block_out_¿nge_”rÜ
));

304 
out
;

307 
Ýcode
) {

308 
WRITE_10
:

309 
WRITE_12
:

310 
WRITE_16
:

311 
fua
 = (
cdb
[1] & 0x8);

312 ià(
cdb
[1] & 0x8) {

313 
	`TRACE
(
TRACE_ORDER
, "FUA(%d):†off=%"
PRId64
", "

314 "d©a_Ën=%"
PRId64
, 
fua
, (
ušt64_t
)
loff
,

315 
d©a_Ën
);

320 
Ýcode
) {

321 
READ_6
:

322 
READ_10
:

323 
READ_12
:

324 
READ_16
:

325 
	`exec_»ad
(
vcmd
, 
loff
);

327 
WRITE_6
:

328 
WRITE_10
:

329 
WRITE_12
:

330 
WRITE_16
:

331 ià(!
dev
->
rd_Úly_æag
) {

332 
vdisk_tgt_dev
 *
tgt_dev
;

334 
tgt_dev
 = 
	`fšd_tgt_dev
(
dev
, 
cmd
->
£ss_h
);

335 ià(
tgt_dev
 =ð
NULL
) {

336 
	`PRINT_ERROR
("SessiÚ %"
PRIx64
"‚ot found",

337 
cmd
->
£ss_h
);

338 
	`£t_cmd_”rÜ
(
vcmd
,

339 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

340 
out
;

343 
	`exec_wr™e
(
vcmd
, 
loff
);

345 ià(
fua
)

346 
	`exec_fsync
(
vcmd
);

348 
	`PRINT_WARNING
("Attempto writeo„ead-only "

349 "deviû %s", 
dev
->
Çme
);

350 
	`£t_cmd_”rÜ
(
vcmd
,

351 
	`SCST_LOAD_SENSE
(
sc¡_£n£_d©a_´Ùeù
));

354 
WRITE_VERIFY
:

355 
WRITE_VERIFY_12
:

356 
WRITE_VERIFY_16
:

357 ià(!
dev
->
rd_Úly_æag
) {

358 
vdisk_tgt_dev
 *
tgt_dev
;

360 
tgt_dev
 = 
	`fšd_tgt_dev
(
dev
, 
cmd
->
£ss_h
);

361 ià(
tgt_dev
 =ð
NULL
) {

362 
	`PRINT_ERROR
("SessiÚ %"
PRIx64
"‚ot found",

363 
cmd
->
£ss_h
);

364 
	`£t_cmd_”rÜ
(
vcmd
,

365 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

366 
out
;

369 
	`exec_wr™e
(
vcmd
, 
loff
);

371 ià(
»¶y
->
¡©us
 == 0)

372 
	`exec_v”ify
(
vcmd
, 
loff
);

374 
	`PRINT_WARNING
("Attempto writeo„ead-only "

375 "deviû %s", 
dev
->
Çme
);

376 
	`£t_cmd_”rÜ
(
vcmd
,

377 
	`SCST_LOAD_SENSE
(
sc¡_£n£_d©a_´Ùeù
));

380 
SYNCHRONIZE_CACHE
:

381 
SYNCHRONIZE_CACHE_16
:

383 
immed
 = 
cdb
[1] & 0x2;

384 ià(
d©a_Ën
 == 0)

385 
d©a_Ën
 = 
dev
->
fže_size
 -

386 ((
loff_t
)
lba_¡¬t
 << 
dev
->
block_shiá
);

387 
	`TRACE
(
TRACE_ORDER
, "SYNCHRONIZE_CACHE: "

388 "loff=%"
PRId64
", data_len=%"PRId64", immed=%d",

389 (
ušt64_t
)
loff
, 
d©a_Ën
, 
immed
);

390 ià(
immed
) {

392 
	`exec_fsync
(
vcmd
);

395 
	`exec_fsync
(
vcmd
);

399 
VERIFY
:

400 
VERIFY_12
:

401 
VERIFY_16
:

402 
	`exec_v”ify
(
vcmd
, 
loff
);

404 
MODE_SENSE
:

405 
MODE_SENSE_10
:

406 
	`exec_mode_£n£
(
vcmd
);

408 
MODE_SELECT
:

409 
MODE_SELECT_10
:

410 
	`exec_mode_£Ëù
(
vcmd
);

412 
ALLOW_MEDIUM_REMOVAL
:

413 
	`exec_´ev’t_®low_medium_»mov®
(
vcmd
);

415 
READ_TOC
:

416 
	`exec_»ad_toc
(
vcmd
);

418 
START_STOP
:

419 
	`exec_fsync
(
vcmd
 );

421 
RESERVE
:

422 
RESERVE_10
:

423 
RELEASE
:

424 
RELEASE_10
:

425 
TEST_UNIT_READY
:

427 
INQUIRY
:

428 
	`exec_šquœy
(
vcmd
);

430 
REQUEST_SENSE
:

431 
	`exec_»que¡_£n£
(
vcmd
);

433 
READ_CAPACITY
:

434 
	`exec_»ad_ÿ·c™y
(
vcmd
);

436 
WRITE_SAME_10
:

437 
WRITE_SAME_16
:

438 
	`exec_wr™e_§me
(
vcmd
);

440 
SERVICE_ACTION_IN_16
:

441 ià((
cmd
->
cdb
[1] & 0x1fè=ð
SAI_READ_CAPACITY_16
)

442 
	`exec_»ad_ÿ·c™y16
(
vcmd
);

444 
	`TRACE_DBG
("Invalid service‡ction %d for SERVICE "

445 "ACTION IN", 
cmd
->
cdb
[1] & 0x1f);

446 
	`£t_cmd_”rÜ
(
vcmd
,

447 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

450 
REPORT_LUNS
:

452 
	`TRACE_DBG
("Inv®id opcod0x%x", 
Ýcode
);

453 
	`£t_cmd_”rÜ
(
vcmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

457 
out
:

458 
	`TRACE_EXIT
();

459  
»s
;

460 
	}
}

462 
	$do_®loc_mem
(
vdisk_cmd
 *
vcmd
)

464 
sc¡_u£r_g‘_cmd
 *
cmd
 = 
vcmd
->cmd;

465 
sc¡_u£r_»¶y_cmd
 *
»¶y
 = 
vcmd
->reply;

466 
»s
 = 0;

468 
	`TRACE_ENTRY
();

470 
	`TRACE_MEM
("AÎoømem (cmd %d, sess_h %"
PRIx64
", cdb_len %d, "

472 
cmd
->
cmd_h
, cmd->
®loc_cmd
.
£ss_h
,

473 
cmd
->
®loc_cmd
.
cdb_Ën
, cmd->®loc_cmd.
®loc_Ën
,

474 
cmd
->
®loc_cmd
.
queue_ty³
, cmd->®loc_cmd.
d©a_dœeùiÚ
);

476 
	`TRACE_BUFF_FLAG
(
TRACE_MEMORY
, "CDB", 
cmd
->
®loc_cmd
.
cdb
,

477 
cmd
->
®loc_cmd
.
cdb_Ën
);

479 
	`mem£t
(
»¶y
, 0, (*reply));

480 
»¶y
->
cmd_h
 = 
cmd
->cmd_h;

481 
»¶y
->
subcode
 = 
cmd
->subcode;

482 #ifdeà
DEBUG_NOMEM


483 ià((
	`¿ndom
() % 100) == 75)

484 
»¶y
->
®loc_»¶y
.
pbuf
 = 0;

487 
»¶y
->
®loc_»¶y
.
pbuf
 = ()
vcmd
->
dev
->
	`®loc_â
(

488 
cmd
->
®loc_cmd
.
®loc_Ën
);

489 
	`TRACE_MEM
("Buà%"
PRIx64
"‡Îoûd,†’ %d", 
»¶y
->
®loc_»¶y
.
pbuf
,

490 
cmd
->
®loc_cmd
.
®loc_Ën
);

491 ià(
»¶y
->
®loc_»¶y
.
pbuf
 == 0) {

492 
	`TRACE
(
TRACE_OUT_OF_MEM
, "Unableo‡llocate buffer (len %d)",

493 
cmd
->
®loc_cmd
.
®loc_Ën
);

496 
	`TRACE_EXIT_RES
(
»s
);

497  
»s
;

498 
	}
}

500 
	$do_ÿched_mem_ä“
(
vdisk_cmd
 *
vcmd
)

502 
sc¡_u£r_g‘_cmd
 *
cmd
 = 
vcmd
->cmd;

503 
sc¡_u£r_»¶y_cmd
 *
»¶y
 = 
vcmd
->reply;

504 
»s
 = 0;

506 
	`TRACE_ENTRY
();

508 
	`TRACE_MEM
("Cached mem f»(cmd %x, buà%"
PRIx64
")", 
cmd
->
cmd_h
,

509 
cmd
->
Ú_ÿched_mem_ä“
.
pbuf
);

511 
	`ä“
((*)()
cmd
->
Ú_ÿched_mem_ä“
.
pbuf
);

513 
	`mem£t
(
»¶y
, 0, (*reply));

514 
»¶y
->
cmd_h
 = 
cmd
->cmd_h;

515 
»¶y
->
subcode
 = 
cmd
->subcode;

517 
	`TRACE_EXIT_RES
(
»s
);

518  
»s
;

519 
	}
}

521 
	$do_Ú_ä“_cmd
(
vdisk_cmd
 *
vcmd
)

523 
sc¡_u£r_g‘_cmd
 *
cmd
 = 
vcmd
->cmd;

524 
sc¡_u£r_»¶y_cmd
 *
»¶y
 = 
vcmd
->reply;

525 
»s
 = 0;

527 
	`TRACE_ENTRY
();

529 
	`TRACE_DBG
("On free cmd (cmd %d,„esp_data_len %d,‡borted %d, "

530 "¡©u %d, d–iv”y_¡©u %d)", 
cmd
->
cmd_h
,

531 
cmd
->
Ú_ä“_cmd
.
»¥_d©a_Ën
, cmd->Ú_ä“_cmd.
abÜ‹d
,

532 
cmd
->
Ú_ä“_cmd
.
¡©us
, cmd->Ú_ä“_cmd.
d–iv”y_¡©us
);

534 
	`TRACE_MEM
("OÀä“ cmd (cmd %d, buà%"
PRIx64
", buffer_cached %d)",

535 
cmd
->
cmd_h
, cmd->
Ú_ä“_cmd
.
pbuf
,

536 
cmd
->
Ú_ä“_cmd
.
bufãr_ÿched
);

538 ià(!
cmd
->
Ú_ä“_cmd
.
bufãr_ÿched
 && (cmd->Ú_ä“_cmd.
pbuf
 != 0)) {

539 
	`TRACE_MEM
("F»ešg buà%"
PRIx64
, 
cmd
->
Ú_ä“_cmd
.
pbuf
);

540 
	`ä“
((*)()
cmd
->
Ú_ä“_cmd
.
pbuf
);

543 
	`mem£t
(
»¶y
, 0, (*reply));

544 
»¶y
->
cmd_h
 = 
cmd
->cmd_h;

545 
»¶y
->
subcode
 = 
cmd
->subcode;

547 
	`TRACE_EXIT_RES
(
»s
);

548  
»s
;

549 
	}
}

551 #ifdeà
DEBUG_EXT_COPY_REMAP


552 
	$do_ext_cÝy_»m­
(
vdisk_cmd
 *
vcmd
)

554 
sc¡_u£r_g‘_cmd
 *
cmd
 = 
vcmd
->cmd;

555 
sc¡_u£r_ext_cÝy_»m­
 *
rcmd
 = &
cmd
->
»m­_cmd
;

556 
sc¡_u£r_»¶y_cmd
 *
»¶y
 = 
vcmd
->reply;

557 
sc¡_u£r_ext_cÝy_»¶y_»m­
 *
¼•ly
 = &
»¶y
->
»m­_»¶y
;

558 
sc¡_u£r_ext_cÝy_d©a_desü
 
d
[1];

559 
»s
 = 0;

561 
	`TRACE_ENTRY
();

563 
	`TRACE_DBG
("ExˆcÝy„em­ cmd %d", 
cmd
->
cmd_h
);

565 
	`mem£t
(
»¶y
, 0, (*reply));

566 
»¶y
->
cmd_h
 = 
cmd
->cmd_h;

567 
»¶y
->
subcode
 = 
cmd
->subcode;

569 
	`mem£t
(
¼•ly
, 0, (*rreply));

573 
	`mem£t
(
d
, 0, (d));

575 
d
[0].
d©a_Ën
 = 
rcmd
->
d©a_desü
.data_len;

576 
d
[0].
¤c_lba
 = 
rcmd
->
d©a_desü
.src_lba;

577 
d
[0].
d¡_lba
 = 
rcmd
->
d©a_desü
.dst_lba;

580 
¼•ly
->
»m­_desütÜs
 = ()
d
;

581 
¼•ly
->
»m­_desütÜs_Ën
 = (
d
);

583 
¼•ly
->
¡©us
 = 
SAM_STAT_CHECK_CONDITION
;

584 
¼•ly
->
£n£_Ën
 = 
	`£t_£n£
(
vcmd
->
£n£
, (vcmd->sense),

585 
	`SCST_LOAD_SENSE
(
sc¡_£n£_d©a_´Ùeù
));

586 
¼•ly
->
p£n£_bufãr
 = ()
vcmd
->
£n£
;

589 
	`TRACE_EXIT_RES
(
»s
);

590  
»s
;

591 
	}
}

594 
	$do_tm
(
vdisk_cmd
 *
vcmd
, 
dÚe
)

596 
sc¡_u£r_g‘_cmd
 *
cmd
 = 
vcmd
->cmd;

597 
sc¡_u£r_»¶y_cmd
 *
»¶y
 = 
vcmd
->reply;

598 
vdisk_dev
 *
dev
 = 
vcmd
->dev;

599 
»s
 = 0;

601 
	`TRACE_ENTRY
();

603 ià(
cmd
->
tm_cmd
.
â
 <ð
SCST_TARGET_RESET
)

604 
	`TRACE
(
TRACE_MGMT
, "% TM fÀ%d (£ss_h %"
PRIx64
", "

605 "cmd_h_to_abÜˆ%d)", 
dÚe
 ? "Done" : "Received",

606 
cmd
->
tm_cmd
.
â
, cmd->tm_cmd.
£ss_h
,

607 
cmd
->
tm_cmd
.
cmd_h_to_abÜt
);

609 
	`TRACE_MGMT_DBG
("% TM fÀ%d (£ss_h %"
PRIx64
", "

610 "cmd_h_to_abÜˆ%d)", 
dÚe
 ? "Done" : "Received",

611 
cmd
->
tm_cmd
.
â
, cmd->tm_cmd.
£ss_h
,

612 
cmd
->
tm_cmd
.
cmd_h_to_abÜt
);

614 ià(
dÚe
) {

615 
cmd
->
tm_cmd
.
â
) {

616 
SCST_LUN_RESET
:

617 
SCST_TARGET_RESET
:

618 
SCST_PR_ABORT_ALL
:

619 
	`±h»ad_mu‹x_lock
(&
dev
->
dev_mu‹x
);

620 
dev
->
´ev’t_®low_medium_»mov®
 = 0;

621 
	`±h»ad_mu‹x_uÆock
(&
dev
->
dev_mu‹x
);

626 
	`mem£t
(
»¶y
, 0, (*reply));

627 
»¶y
->
cmd_h
 = 
cmd
->cmd_h;

628 
»¶y
->
subcode
 = 
cmd
->subcode;

629 
»¶y
->
»suÉ
 = 0;

631 
	`TRACE_EXIT_RES
(
»s
);

632  
»s
;

633 
	}
}

635 
	$do_£ss
(
vdisk_cmd
 *
vcmd
)

637 
sc¡_u£r_g‘_cmd
 *
cmd
 = 
vcmd
->cmd;

638 
sc¡_u£r_»¶y_cmd
 *
»¶y
 = 
vcmd
->reply;

639 
»s
 = 0;

640 
vdisk_tgt_dev
 *
tgt_dev
;

642 
	`TRACE_ENTRY
();

649 
tgt_dev
 = 
	`fšd_tgt_dev
(
vcmd
->
dev
, 
cmd
->
£ss
.
£ss_h
);

651 ià(
cmd
->
subcode
 =ð
SCST_USER_ATTACH_SESS
) {

652 ià(
tgt_dev
 !ð
NULL
) {

653 
	`PRINT_ERROR
("SessiÚ %"
PRIx64
"‡lreadyƒxists)",

654 
cmd
->
£ss
.
£ss_h
);

655 
»s
 = 
EEXIST
;

656 
»¶y
;

659 
tgt_dev
 = 
	`fšd_em±y_tgt_dev
(
vcmd
->
dev
);

660 ià(
tgt_dev
 =ð
NULL
) {

661 
	`PRINT_ERROR
("ToØmªy in™ŸtÜs, sessiÚ %"
PRIx64


662 "„efu£d)", 
cmd
->
£ss
.
£ss_h
);

663 
»s
 = 
ENOMEM
;

664 
»¶y
;

667 
tgt_dev
->
£ss_h
 = 
cmd
->
£ss
.sess_h;

669 
	`PRINT_INFO
("Session from initiator %s (target %s)‡ttached "

670 "(LUN %"
PRIx64
",hreads_num %d,„d_only %d, sess_h "

671 "%"
PRIx64
")", 
cmd
->
£ss
.
š™ŸtÜ_Çme
,

672 
cmd
->
£ss
.
rg‘_Çme
, cmd->£ss.
lun
,

673 
cmd
->
£ss
.
th»ads_num
, cmd->£ss.
rd_Úly
,

674 
cmd
->
£ss
.
£ss_h
);

676 ià(
tgt_dev
 =ð
NULL
) {

677 
	`PRINT_ERROR
("SessiÚ %"
PRIx64
"‚ot found)",

678 
cmd
->
£ss
.
£ss_h
);

679 
»s
 = 
ESRCH
;

680 
»¶y
;

682 
tgt_dev
->
£ss_h
 = 0;

683 
	`PRINT_INFO
("SessiÚ d‘ached (£ss_h %"
PRIx64
")",

684 
cmd
->
£ss
.
£ss_h
);

687 
»¶y
:

688 
	`mem£t
(
»¶y
, 0, (*reply));

689 
»¶y
->
cmd_h
 = 
cmd
->cmd_h;

690 
»¶y
->
subcode
 = 
cmd
->subcode;

691 
»¶y
->
»suÉ
 = 
»s
;

693 
	`TRACE_EXIT_RES
(
»s
);

694  
»s
;

695 
	}
}

697 
	$´oûss_cmd
(
vdisk_cmd
 *
vcmd
)

699 
sc¡_u£r_g‘_cmd
 *
cmd
 = 
vcmd
->cmd;

700 
sc¡_u£r_»¶y_cmd
 *
»¶y
 = 
vcmd
->reply;

701 
»s
 = 0;

703 
	`TRACE_ENTRY
();

705 
	`TRACE_BUFFER
("Reûived cmd", &
cmd
, (cmd));

707 
cmd
->
subcode
) {

708 
SCST_USER_EXEC
:

709 ià(
cmd
->
exec_cmd
.
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
) {

710 
	`TRACE_BUFFER
("Received cmd data",

711 (*)()
cmd
->
exec_cmd
.
pbuf
,

712 
cmd
->
exec_cmd
.
bufæ’
);

714 
»s
 = 
	`do_exec
(
vcmd
);

715 ià((
»¶y
->
exec_»¶y
.
»¥_d©a_Ën
 !ð0è&& (
»s
 != 150)) {

716 
	`TRACE_BUFFER
("Reply data",

717 (*)()
»¶y
->
exec_»¶y
.
pbuf
,

718 
»¶y
->
exec_»¶y
.
»¥_d©a_Ën
);

722 
SCST_USER_ALLOC_MEM
:

723 
»s
 = 
	`do_®loc_mem
(
vcmd
);

726 
SCST_USER_PARSE
:

727 
»s
 = 
	`do_·r£
(
vcmd
);

730 
SCST_USER_ON_CACHED_MEM_FREE
:

731 
»s
 = 
	`do_ÿched_mem_ä“
(
vcmd
);

734 
SCST_USER_ON_FREE_CMD
:

735 
»s
 = 
	`do_Ú_ä“_cmd
(
vcmd
);

738 #ifdeà
DEBUG_EXT_COPY_REMAP


739 
SCST_USER_EXT_COPY_REMAP
:

740 
»s
 = 
	`do_ext_cÝy_»m­
(
vcmd
);

744 
SCST_USER_TASK_MGMT_RECEIVED
:

745 
»s
 = 
	`do_tm
(
vcmd
, 0);

748 
SCST_USER_TASK_MGMT_DONE
:

749 
»s
 = 
	`do_tm
(
vcmd
, 1);

750 #ià
DEBUG_TM_FN_IGNORE


751 ià(
dev
->
debug_tm_ignÜe
) {

752 
	`¦“p
(15);

757 
SCST_USER_ATTACH_SESS
:

758 
SCST_USER_DETACH_SESS
:

759 
»s
 = 
	`do_£ss
(
vcmd
);

763 
	`PRINT_ERROR
("Unknown or wrong cmd subcode %x",

764 
cmd
->
subcode
);

765 
»s
 = -
EINVAL
;

766 
out
;

769 
out
:

770 
	`TRACE_EXIT_RES
(
»s
);

771  
»s
;

772 
	}
}

774 *
	$maš_loÝ
(*
¬g
)

776 
»s
 = 0, 
i
, 
j
;

777 
vdisk_dev
 *
dev
 = (vdisk_dev *)
¬g
;

778 
sc¡_u£r_g‘_cmd
 
cmd
;

779 
sc¡_u£r_»¶y_cmd
 
»¶y
;

780 
vdisk_cmd
 
vcmd
 = {

781 .
fd
 = -1,

782 .
cmd
 = &cmd,

783 .
dev
 = dev,

784 .
may_Ãed_to_ä“_pbuf
 = 0,

785 .
»¶y
 = &reply,

786 .
£n£
 = {0}

788 
sc¡_u¤_fd
 = 
dev
->scst_usr_fd;

789 
pÞlfd
 
¶
;

790 
	#MULTI_CMDS_CNT
 2

	)

792 
sc¡_u£r_»¶y_cmd
 
»¶›s
[
MULTI_CMDS_CNT
];

793 
sc¡_u£r_g‘_muÉi
 
muÉi_cmd
;

794 
sc¡_u£r_g‘_cmd
 
cmds
[
MULTI_CMDS_CNT
];

795 } 
muÉi
;

797 
	`TRACE_ENTRY
();

799 
vcmd
.
fd
 = 
	`Ý’_dev_fd
(
dev
);

800 ià(
vcmd
.
fd
 < 0) {

801 
»s
 = -
”ºo
;

802 
	`PRINT_ERROR
("UÇbËØÝ’ fž% (%s)", 
dev
->
fže_Çme
,

803 
	`¡»¼Ü
(-
»s
));

804 
out
;

807 
	`mem£t
(&
¶
, 0, (pl));

808 
¶
.
fd
 = 
sc¡_u¤_fd
;

809 
¶
.
ev’ts
 = 
POLLIN
;

811 
cmd
.
´•ly
 = 0;

812 
muÉi
.
muÉi_cmd
.
´•l›s
 = (
ušt64_t
)&muÉi.
»¶›s
[0];

813 
muÉi
.
muÉi_cmd
.
»¶›s_út
 = 0;

814 
muÉi
.
muÉi_cmd
.
cmds_út
 = 
MULTI_CMDS_CNT
;

817 #ifdeà
DEBUG_TM_IGNORE_ALL


818 ià(
dev
->
debug_tm_ignÜe
 && (
	`¿ndom
() % 50000) == 55) {

819 
	`TRACE_MGMT_DBG
("%s", "Ignore ALL");

820 
dev
->
debug_tm_ignÜe_®l
 = 1;

822 ià(
dev
->
debug_tm_ignÜe_®l
) {

825 
	`¦“p
(60);

830 ià(
u£_muÉi
) {

831 
	`TRACE_DBG
("preplies %p (first: %p),„eplies_cnt %d, "

832 "»¶›s_dÚ%d, cmds_úˆ%d", (*)
muÉi
.
muÉi_cmd
.
´•l›s
,

833 &
muÉi
.
»¶›s
[0], muÉi.
muÉi_cmd
.
»¶›s_út
,

834 
muÉi
.
muÉi_cmd
.
»¶›s_dÚe
, muÉi.muÉi_cmd.
cmds_út
);

835 
»s
 = 
	`ioùl
(
sc¡_u¤_fd
, 
SCST_USER_REPLY_AND_GET_MULTI
, &
muÉi
.
muÉi_cmd
);

837 
»s
 = 
	`ioùl
(
sc¡_u¤_fd
, 
SCST_USER_REPLY_AND_GET_CMD
, &
cmd
);

838 ià(
»s
 != 0) {

839 
»s
 = 
”ºo
;

840 
»s
) {

841 
ESRCH
:

842 
EBUSY
:

843 
	`TRACE_MGMT_DBG
("SCST_USER„‘uºed %d (%s)", 
»s
, 
	`¡»¼Ü
(res));

844 
cmd
.
´•ly
 = 0;

845 
muÉi
.
muÉi_cmd
.
´•l›s
 = (
ušt64_t
)&muÉi.
»¶›s
[0];

846 
muÉi
.
muÉi_cmd
.
»¶›s_út
 = 0;

847 
muÉi
.
muÉi_cmd
.
cmds_út
 = 
MULTI_CMDS_CNT
;

848 
EINTR
:

850 
EAGAIN
:

851 
	`TRACE_DBG
("SCST_USER„‘uºed EAGAIN (%d)", 
»s
);

852 
cmd
.
´•ly
 = 0;

853 
muÉi
.
muÉi_cmd
.
´•l›s
 = (
ušt64_t
)&muÉi.
»¶›s
[0];

854 
muÉi
.
muÉi_cmd
.
»¶›s_út
 = 0;

855 
muÉi
.
muÉi_cmd
.
cmds_út
 = 
MULTI_CMDS_CNT
;

856 ià(
dev
->
nÚ_blockšg
)

861 
	`PRINT_ERROR
("SCST_USER fažed: % (%d)", 
	`¡»¼Ü
(
»s
),„es);

863 
cmd
.
´•ly
 = 0;

864 
muÉi
.
muÉi_cmd
.
´•l›s
 = (
ušt64_t
)&muÉi.
»¶›s
[0];

865 
muÉi
.
muÉi_cmd
.
»¶›s_út
 = 0;

866 
muÉi
.
muÉi_cmd
.
cmds_út
 = 
MULTI_CMDS_CNT
;

869 
out_þo£
;

872 
agaš_pÞl
:

873 
»s
 = 
	`pÞl
(&
¶
, 1, -1);

874 ià(
»s
 > 0)

876 ià(
»s
 == 0)

877 
agaš_pÞl
;

879 
»s
 = 
”ºo
;

880 
»s
) {

881 
ESRCH
:

882 
EBUSY
:

883 
EAGAIN
:

884 
	`TRACE_MGMT_DBG
("poll()„eturned %d "

885 "(%s)", 
»s
, 
	`¡»¼Ü
(res));

886 
EINTR
:

887 
agaš_pÞl
;

889 
	`PRINT_ERROR
("pÞl(èçžed: %s", 
	`¡»¼Ü
(
»s
));

891 
agaš_pÞl
;

893 
out_þo£
;

899 ià(
u£_muÉi
) {

900 ià(
muÉi
.
muÉi_cmd
.
»¶›s_dÚe
 < muÉi.muÉi_cmd.
»¶›s_út
) {

901 
	`TRACE_MGMT_DBG
("replies_done %d <„eplies_cnt %d (dev %s)",

902 
muÉi
.
muÉi_cmd
.
»¶›s_dÚe
, muÉi.muÉi_cmd.
»¶›s_út
, 
dev
->
Çme
);

903 
muÉi
.
muÉi_cmd
.
´•l›s
 = (
ušt64_t
)&muÉi.
»¶›s
[muÉi.muÉi_cmd.
»¶›s_dÚe
];

904 
muÉi
.
muÉi_cmd
.
»¶›s_út
 = muÉi.muÉi_cmd.»¶›s_úˆ- muÉi.muÉi_cmd.
»¶›s_dÚe
;

905 
muÉi
.
muÉi_cmd
.
cmds_út
 = 
MULTI_CMDS_CNT
;

908 
	`TRACE_DBG
("cmds_úˆ%d", 
muÉi
.
muÉi_cmd
.
cmds_út
);

909 
muÉi
.
muÉi_cmd
.
´•l›s
 = (
ušt64_t
)&muÉi.
»¶›s
[0];

910 
i
 = 0, 
j
 = 0; i < 
muÉi
.
muÉi_cmd
.
cmds_út
; i++, j++) {

911 
vcmd
.
cmd
 = &
muÉi
.
cmds
[
i
];

912 
vcmd
.
»¶y
 = &
muÉi
.
»¶›s
[
j
];

913 
»s
 = 
	`´oûss_cmd
(&
vcmd
);

914 #ifdeà
DEBUG_TM_IGNORE


915 ià(
»s
 == 150) {

916 
j
--;

920 ià(
»s
 != 0)

921 
out_þo£
;

922 
	`TRACE_BUFFER
("S’dšg„•ly", 
vcmd
.
»¶y
, (reply));

924 
muÉi
.
muÉi_cmd
.
»¶›s_út
 = 
j
;

925 
muÉi
.
muÉi_cmd
.
cmds_út
 = 
MULTI_CMDS_CNT
;

927 
»s
 = 
	`´oûss_cmd
(&
vcmd
);

928 #ifdeà
DEBUG_TM_IGNORE


929 ià(
»s
 == 150) {

930 
cmd
.
´•ly
 = 0;

934 ià(
»s
 != 0)

935 
out_þo£
;

937 
cmd
.
´•ly
 = ()&
»¶y
;

938 
	`TRACE_BUFFER
("S’dšg„•ly", &
»¶y
, (reply));

942 
out_þo£
:

943 
	`þo£
(
vcmd
.
fd
);

945 
out
:

946 
	`PRINT_INFO
("Th»ad %dƒx™šg (»s=%d)", 
	`g‘tid
(), 
»s
);

948 
	`TRACE_EXIT_RES
(
»s
);

949  (*)()
»s
;

950 
	}
}

952 
ušt64_t
 
	$g’_dev_id_num
(cÚ¡ 
vdisk_dev
 *
dev
)

954 
ušt32_t
 
dev_id_num
;

956 
dev_id_num
 = 
	`üc32buf
(
dev
->
Çme
, 
	`¡¾’
(dev->name)+1);

958  ((
ušt64_t
)
vdisk_ID
 << 32è| 
dev_id_num
;

959 
	}
}

961 
	$exec_šquœy
(
vdisk_cmd
 *
vcmd
)

963 
vdisk_dev
 *
dev
 = 
vcmd
->dev;

964 
sc¡_u£r_scsi_cmd_exec
 *
cmd
 = &
vcmd
->cmd->
exec_cmd
;

965 
sc¡_u£r_scsi_cmd_»¶y_exec
 *
»¶y
 = &
vcmd
->»¶y->
exec_»¶y
;

966 
»¥_Ën
 = 0;

967 
Ëngth
 = 
cmd
->
bufæ’
;

968 
i
;

969 
ušt8_t
 *
add»ss
 = (ušt8_t*)()
cmd
->
pbuf
;

970 
ušt8_t
 
buf
[
INQ_BUF_SZ
];

972 
	`TRACE_ENTRY
();

974 ià(
cmd
->
cdb
[1] & 
CMDDT
) {

975 
	`TRACE_DBG
("%s", "INQUIRY: CMDDT is unsupported");

976 
	`£t_cmd_”rÜ
(
vcmd
,

977 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

978 
out
;

981 
	`mem£t
(
buf
, 0, (buf));

982 
buf
[0] = 
dev
->
ty³
;

983 ià(
buf
[0] =ð
TYPE_ROM
)

984 
buf
[1] = 0x80;

986 ià(
cmd
->
cdb
[1] & 
EVPD
) {

987 
ušt64_t
 
dev_id_num
 = 
	`g’_dev_id_num
(
dev
);

989 ià(0 =ð
cmd
->
cdb
[2]) {

990 
buf
[3] = 5;

991 
buf
[4] = 0x0;

992 
buf
[5] = 0x80;

993 
buf
[6] = 0x83;

994 
buf
[7] = 0xB0;

995 
buf
[8] = 0xB1;

996 
»¥_Ën
 = 
buf
[3] + 6;

997 } ià(0x80 =ð
cmd
->
cdb
[2]) {

998 
u¢_Ën
 = 
	`¡¾’
(
dev
->
u¢
);

999 
buf
[1] = 0x80;

1000 
buf
[3] = 
u¢_Ën
;

1001 
	`¡ºýy
((*)&
buf
[4], 
dev
->
u¢
, 
u¢_Ën
);

1002 
»¥_Ën
 = 
buf
[3] + 4;

1003 } ià(0x83 =ð
cmd
->
cdb
[2]) {

1004 
num
 = 4;

1005 *
t10_id
 = (*)&
buf
[
num
 + 12];

1007 
buf
[1] = 0x83;

1010 
buf
[
num
 + 0] = 0x2;

1011 
buf
[
num
 + 1] = 0x1;

1012 
	`memýy
(&
buf
[
num
 + 4], 
VENDOR
, 8);

1013 
	`¢´štf
(
t10_id
, (
buf
è- 
num
 - 12,

1014 "%"
PRIx64
"-%s", 
dev_id_num
, 
dev
->
Çme
);

1015 
i
 = 
	`¡¾’
(
t10_id
) + 1;

1016 
	`TRACE_DBG
("t10_dev_id %s", 
t10_id
);

1017 
buf
[
num
 + 3] = 8 + 
i
;

1018 
num
 +ð
buf
[num + 3];

1021 
num
 += 4;

1024 
buf
[
num
] = 0x1;

1025 
buf
[
num
 + 1] = 0x3;

1026 
buf
[
num
 + 2] = 0x0;

1027 
buf
[
num
 + 3] = 0x8;

1028 
buf
[
num
 + 4] = 0x51;

1029 
buf
[
num
 + 5] = 0x23;

1030 
buf
[
num
 + 6] = 0x45;

1031 
buf
[
num
 + 7] = 0x60;

1032 
buf
[
num
 + 8] = (
dev_id_num
 >> 24);

1033 
buf
[
num
 + 9] = (
dev_id_num
 >> 16) & 0xff;

1034 
buf
[
num
 + 10] = (
dev_id_num
 >> 8) & 0xff;

1035 
buf
[
num
 + 11] = 
dev_id_num
 & 0xff;

1036 
num
 =‚um + 12 - 4;

1039 
»¥_Ën
 = 
num
;

1040 
buf
[2] = (
»¥_Ën
 >> 8) & 0xFF;

1041 
buf
[3] = 
»¥_Ën
 & 0xFF;

1042 
»¥_Ën
 += 4;

1043 } ià(0xB0 =ð
cmd
->
cdb
[2]) {

1045 
max_Œªsãr
;

1046 
buf
[1] = 0xB0;

1047 
buf
[3] = 0x3C;

1048 
buf
[5] = 0xFF;

1050 
max_Œªsãr
 = 
	`max
(()(4096/
dev
->
block_size
), ()1);

1051 
buf
[6] = (
max_Œªsãr
 >> 8) & 0xff;

1052 
buf
[7] = 
max_Œªsãr
 & 0xff;

1057 
max_Œªsãr
 = 1*1024*1024;

1058 
buf
[8] = (
max_Œªsãr
 >> 24) & 0xff;

1059 
buf
[9] = (
max_Œªsãr
 >> 16) & 0xff;

1060 
buf
[10] = (
max_Œªsãr
 >> 8) & 0xff;

1061 
buf
[11] = 
max_Œªsãr
 & 0xff;

1069 
max_Œªsãr
 = 
	`mš
(()max_Œªsãr, ()(512*1024 / 
dev
->
block_size
));

1070 
buf
[12] = (
max_Œªsãr
 >> 24) & 0xff;

1071 
buf
[13] = (
max_Œªsãr
 >> 16) & 0xff;

1072 
buf
[14] = (
max_Œªsãr
 >> 8) & 0xff;

1073 
buf
[15] = 
max_Œªsãr
 & 0xff;

1074 
»¥_Ën
 = 
buf
[3] + 4;

1075 } ià(0xB1 =ð
cmd
->
cdb
[2]) {

1076 
r
;

1078 
buf
[1] = 0xB1;

1079 
buf
[3] = 0x3C;

1081 ià(
vœt_dev
->
rÙ©iÚ®
) {

1084 
r
 = 0x3A98;

1087 
r
 = 1;

1089 
buf
[4] = (
r
 >> 8) & 0xff;

1090 
buf
[5] = 
r
 & 0xff;

1091 
»¥_Ën
 = 
buf
[3] + 4;

1093 
	`TRACE_DBG
("INQUIRY: Unsupported EVPD…age %x",

1094 
cmd
->
cdb
[2]);

1095 
	`£t_cmd_”rÜ
(
vcmd
,

1096 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

1097 
out
;

1100 
Ën
;

1102 ià(
cmd
->
cdb
[2] != 0) {

1103 
	`TRACE_DBG
("INQUIRY: UnsuµÜ‹d…ag%x", 
cmd
->
cdb
[2]);

1104 
	`£t_cmd_”rÜ
(
vcmd
,

1105 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

1106 
out
;

1109 
buf
[2] = 6;

1110 
buf
[3] = 0x12;

1111 
buf
[4] = 31;

1112 
buf
[6] = 1;

1113 
buf
[7] = 2;

1116 
	`memýy
(&
buf
[8], 
VENDOR
, 8);

1119 
	`mem£t
(&
buf
[16], ' ', 16);

1120 
Ën
 = 
	`mš
(
	`¡¾’
(
dev
->
Çme
), (
size_t
)16);

1121 
	`memýy
(&
buf
[16], 
dev
->
Çme
, 
Ën
);

1124 
	`memýy
(&
buf
[32], 
FIO_REV
, 4);

1125 
»¥_Ën
 = 
buf
[4] + 5;

1128 
	`sBUG_ON
(
»¥_Ën
 >ð()(
buf
));

1129 ià(
Ëngth
 > 
»¥_Ën
)

1130 
Ëngth
 = 
»¥_Ën
;

1132 
	`memýy
(
add»ss
, 
buf
, 
Ëngth
);

1134 ià(
Ëngth
 < 
»¶y
->
»¥_d©a_Ën
)

1135 
	`£t_»¥_d©a_Ën
(
vcmd
, 
Ëngth
);

1137 
out
:

1138 
	`TRACE_EXIT
();

1140 
	}
}

1142 
	$exec_»que¡_£n£
(
vdisk_cmd
 *
vcmd
)

1144 
sc¡_u£r_scsi_cmd_exec
 *
cmd
 = &
vcmd
->cmd->
exec_cmd
;

1145 
sc¡_u£r_scsi_cmd_»¶y_exec
 *
»¶y
 = &
vcmd
->»¶y->
exec_»¶y
;

1146 
Ëngth
 = 
cmd
->
bufæ’
, 
l
;

1147 
ušt8_t
 *
add»ss
 = (ušt8_t*)()
cmd
->
pbuf
;

1148 
ušt8_t
 
b
[
SCST_STANDARD_SENSE_LEN
];

1150 
	`TRACE_ENTRY
();

1152 
l
 = 
	`£t_£n£
(
b
, (b), 
	`SCST_LOAD_SENSE
(
sc¡_£n£_no_£n£
));

1154 
Ëngth
 = 
	`mš
(
l
,†ength);

1156 
	`memýy
(
add»ss
, 
b
, 
Ëngth
);

1158 ià(
Ëngth
 < 
»¶y
->
»¥_d©a_Ën
)

1159 
	`£t_»¥_d©a_Ën
(
vcmd
, 
Ëngth
);

1161 
	`TRACE_EXIT
();

1163 
	}
}

1171 
	$”r_»cov_pg
(*
p
, 
pcÚŒÞ
)

1173 cÚ¡ 
”r_»cov_pg
[] = {0x1, 0xa, 0xc0, 11, 240, 0, 0, 0,

1176 
	`memýy
(
p
, 
”r_»cov_pg
, (err_recov_pg));

1177 ià(1 =ð
pcÚŒÞ
)

1178 
	`mem£t
(
p
 + 2, 0, (
”r_»cov_pg
) - 2);

1179  (
”r_»cov_pg
);

1180 
	}
}

1182 
	$discÚÃù_pg
(*
p
, 
pcÚŒÞ
)

1184 cÚ¡ 
discÚÃù_pg
[] = {0x2, 0xe, 128, 128, 0, 10, 0, 0,

1187 
	`memýy
(
p
, 
discÚÃù_pg
, (disconnect_pg));

1188 ià(1 =ð
pcÚŒÞ
)

1189 
	`mem£t
(
p
 + 2, 0, (
discÚÃù_pg
) - 2);

1190  (
discÚÃù_pg
);

1191 
	}
}

1193 
	$rigid_geo_pg
(*
p
, 
pcÚŒÞ
,

1194 
vdisk_dev
 *
dev
)

1196 
geo_m_pg
[] = {0x04, 0x16, 0, 0, 0, 
DEF_HEADS
, 0, 0,

1199 
št32_t
 
ncyl
, 
n
;

1201 
	`memýy
(
p
, 
geo_m_pg
, (geo_m_pg));

1202 
ncyl
 = 
dev
->
nblocks
 / (
DEF_HEADS
 * 
DEF_SECTORS
);

1203 ià((
dev
->
nblocks
 % (
DEF_HEADS
 * 
DEF_SECTORS
)) != 0)

1204 
ncyl
++;

1205 
	`memýy
(&
n
, 
p
 + 2, (
ušt32_t
));

1206 
n
 =‚ | (
	`htÚl
(
ncyl
) >> 8);

1207 
	`memýy
(
p
 + 2, &
n
, (
ušt32_t
));

1208 ià(1 =ð
pcÚŒÞ
)

1209 
	`mem£t
(
p
 + 2, 0, (
geo_m_pg
) - 2);

1210  (
geo_m_pg
);

1211 
	}
}

1213 
	$fÜm©_pg
(*
p
, 
pcÚŒÞ
,

1214 
vdisk_dev
 *
dev
)

1216 cÚ¡ 
fÜm©_pg
[] = {0x3, 0x16, 0, 0, 0, 0, 0, 0,

1220 
	`memýy
(
p
, 
fÜm©_pg
, (format_pg));

1221 
p
[10] = (
DEF_SECTORS
 >> 8) & 0xff;

1222 
p
[11] = 
DEF_SECTORS
 & 0xff;

1223 
p
[12] = (
dev
->
block_size
 >> 8) & 0xff;

1224 
p
[13] = 
dev
->
block_size
 & 0xff;

1225 ià(1 =ð
pcÚŒÞ
)

1226 
	`mem£t
(
p
 + 2, 0, (
fÜm©_pg
) - 2);

1227  (
fÜm©_pg
);

1228 
	}
}

1230 
	$ÿchšg_pg
(*
p
, 
pcÚŒÞ
,

1231 
vdisk_dev
 *
dev
)

1233 cÚ¡ 
ÿchšg_pg
[] = {0x8, 18, 0x10, 0, 0xff, 0xff, 0, 0,

1236 
	`memýy
(
p
, 
ÿchšg_pg
, (caching_pg));

1237 
p
[2] |ð!(
dev
->
wt_æag
è? 
WCE
 : 0;

1238 ià(1 =ð
pcÚŒÞ
)

1239 
	`mem£t
(
p
 + 2, 0, (
ÿchšg_pg
) - 2);

1240  (
ÿchšg_pg
);

1241 
	}
}

1243 
	$ù¾_m_pg
(*
p
, 
pcÚŒÞ
,

1244 
vdisk_dev
 *
dev
)

1246 cÚ¡ 
ù¾_m_pg
[] = {0xa, 0xa, 0x20, 0, 0, 0x40, 0, 0,

1249 
	`memýy
(
p
, 
ù¾_m_pg
, (ctrl_m_pg));

1250 ià(!
dev
->
wt_æag
 && !dev->
nv_ÿche
)

1251 
p
[3] |= 0x10;

1252 ià(1 =ð
pcÚŒÞ
)

1253 
	`mem£t
(
p
 + 2, 0, (
ù¾_m_pg
) - 2);

1254  (
ù¾_m_pg
);

1255 
	}
}

1257 
	$›c_m_pg
(*
p
, 
pcÚŒÞ
)

1259 cÚ¡ 
›c_m_pg
[] = {0x1c, 0xa, 0x08, 0, 0, 0, 0, 0,

1261 
	`memýy
(
p
, 
›c_m_pg
, (iec_m_pg));

1262 ià(1 =ð
pcÚŒÞ
)

1263 
	`mem£t
(
p
 + 2, 0, (
›c_m_pg
) - 2);

1264  (
›c_m_pg
);

1265 
	}
}

1267 
	$exec_mode_£n£
(
vdisk_cmd
 *
vcmd
)

1269 
vdisk_dev
 *
dev
 = 
vcmd
->dev;

1270 
sc¡_u£r_scsi_cmd_exec
 *
cmd
 = &
vcmd
->cmd->
exec_cmd
;

1271 
sc¡_u£r_scsi_cmd_»¶y_exec
 *
»¶y
 = &
vcmd
->»¶y->
exec_»¶y
;

1272 
Ëngth
 = 
cmd
->
bufæ’
;

1273 
ušt8_t
 *
add»ss
 = (ušt8_t*)()
cmd
->
pbuf
;

1274 
ušt8_t
 
buf
[
MSENSE_BUF_SZ
];

1275 
blocksize
;

1276 
ušt64_t
 
nblocks
;

1277 
dbd
, 
ty³
;

1278 
pcÚŒÞ
, 
pcode
, 
subpcode
;

1279 
dev_¥ec
;

1280 
m£n£_6
, 
off£t
 = 0, 
Ën
;

1281 *
bp
;

1283 
	`TRACE_ENTRY
();

1285 
blocksize
 = 
dev
->
block_size
;

1286 
nblocks
 = 
dev
->nblocks;

1288 
ty³
 = 
dev
->type;

1289 
dbd
 = 
cmd
->
cdb
[1] & 
DBD
;

1290 
pcÚŒÞ
 = (
cmd
->
cdb
[2] & 0xc0) >> 6;

1291 
pcode
 = 
cmd
->
cdb
[2] & 0x3f;

1292 
subpcode
 = 
cmd
->
cdb
[3];

1293 
m£n£_6
 = (
MODE_SENSE
 =ð
cmd
->
cdb
[0]);

1294 
dev_¥ec
 = (
dev
->
rd_Úly_æag
 ? 
WP
 : 0è| 
DPOFUA
;

1296 
	`mem£t
(
buf
, 0, (buf));

1298 ià(0x3 =ð
pcÚŒÞ
) {

1299 
	`TRACE_DBG
("%s", "MODE SENSE: Saving values‚ot supported");

1300 
	`£t_cmd_”rÜ
(
vcmd
,

1301 
	`SCST_LOAD_SENSE
(
sc¡_£n£_§všg_·¿ms_unsup
));

1302 
out
;

1305 ià(
m£n£_6
) {

1306 
buf
[1] = 
ty³
;

1307 
buf
[2] = 
dev_¥ec
;

1308 
off£t
 = 4;

1310 
buf
[2] = 
ty³
;

1311 
buf
[3] = 
dev_¥ec
;

1312 
off£t
 = 8;

1315 ià(0 !ð
subpcode
) {

1316 
	`TRACE_DBG
("%s", "MODE SENSE: Only subpage 0 is supported");

1317 
	`£t_cmd_”rÜ
(
vcmd
,

1318 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

1319 
out
;

1322 ià(!
dbd
) {

1324 
buf
[
off£t
 - 1] = 0x08;

1325 ià(
nblocks
 >> 32) {

1326 
buf
[
off£t
 + 0] = 0xFF;

1327 
buf
[
off£t
 + 1] = 0xFF;

1328 
buf
[
off£t
 + 2] = 0xFF;

1329 
buf
[
off£t
 + 3] = 0xFF;

1331 
buf
[
off£t
 + 0] = (
nblocks
 >> (
BYTE
 * 3)) & 0xFF;

1332 
buf
[
off£t
 + 1] = (
nblocks
 >> (
BYTE
 * 2)) & 0xFF;

1333 
buf
[
off£t
 + 2] = (
nblocks
 >> (
BYTE
 * 1)) & 0xFF;

1334 
buf
[
off£t
 + 3] = (
nblocks
 >> (
BYTE
 * 0)) & 0xFF;

1336 
buf
[
off£t
 + 4] = 0;

1337 
buf
[
off£t
 + 5] = (
blocksize
 >> (
BYTE
 * 2)) & 0xFF;

1338 
buf
[
off£t
 + 6] = (
blocksize
 >> (
BYTE
 * 1)) & 0xFF;

1339 
buf
[
off£t
 + 7] = (
blocksize
 >> (
BYTE
 * 0)) & 0xFF;

1341 
off£t
 += 8;

1344 
bp
 = 
buf
 + 
off£t
;

1346 
pcode
) {

1348 
Ën
 = 
	`”r_»cov_pg
(
bp
, 
pcÚŒÞ
);

1351 
Ën
 = 
	`discÚÃù_pg
(
bp
, 
pcÚŒÞ
);

1354 
Ën
 = 
	`fÜm©_pg
(
bp
, 
pcÚŒÞ
, 
dev
);

1357 
Ën
 = 
	`rigid_geo_pg
(
bp
, 
pcÚŒÞ
, 
dev
);

1360 
Ën
 = 
	`ÿchšg_pg
(
bp
, 
pcÚŒÞ
, 
dev
);

1363 
Ën
 = 
	`ù¾_m_pg
(
bp
, 
pcÚŒÞ
, 
dev
);

1366 
Ën
 = 
	`›c_m_pg
(
bp
, 
pcÚŒÞ
);

1369 
Ën
 = 
	`”r_»cov_pg
(
bp
, 
pcÚŒÞ
);

1370 
Ën
 +ð
	`discÚÃù_pg
(
bp
 +†’, 
pcÚŒÞ
);

1371 
Ën
 +ð
	`fÜm©_pg
(
bp
 +†’, 
pcÚŒÞ
, 
dev
);

1372 
Ën
 +ð
	`ÿchšg_pg
(
bp
 +†’, 
pcÚŒÞ
, 
dev
);

1373 
Ën
 +ð
	`ù¾_m_pg
(
bp
 +†’, 
pcÚŒÞ
, 
dev
);

1374 
Ën
 +ð
	`›c_m_pg
(
bp
 +†’, 
pcÚŒÞ
);

1375 
Ën
 +ð
	`rigid_geo_pg
(
bp
 +†’, 
pcÚŒÞ
, 
dev
);

1378 
	`TRACE_DBG
("MODE SENSE: UnsuµÜ‹d…ag%x", 
pcode
);

1379 
	`£t_cmd_”rÜ
(
vcmd
,

1380 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

1381 
out
;

1384 
off£t
 +ð
Ën
;

1386 ià(
m£n£_6
)

1387 
buf
[0] = 
off£t
 - 1;

1389 
buf
[0] = ((
off£t
 - 2) >> 8) & 0xff;

1390 
buf
[1] = (
off£t
 - 2) & 0xff;

1393 
	`sBUG_ON
(
off£t
 >ð()(
buf
));

1394 ià(
off£t
 > 
Ëngth
)

1395 
off£t
 = 
Ëngth
;

1397 
	`memýy
(
add»ss
, 
buf
, 
off£t
);

1399 ià(
off£t
 < 
»¶y
->
»¥_d©a_Ën
)

1400 
	`£t_»¥_d©a_Ën
(
vcmd
, 
off£t
);

1402 
out
:

1403 
	`TRACE_EXIT
();

1405 
	}
}

1407 
	$£t_wt
(
vdisk_dev
 *
dev
, 
wt
)

1409 
»s
 = 0;

1411 
	`TRACE_ENTRY
();

1413 ià((
dev
->
wt_æag
 =ð
wt
è|| dev->
nuÎio
)

1414 
out
;

1416 
	`±h»ad_mu‹x_lock
(&
dev
->
dev_mu‹x
);

1417 
dev
->
wt_æag
 = 
wt
;

1418 
	`±h»ad_mu‹x_uÆock
(&
dev
->
dev_mu‹x
);

1420 
out
:

1421 
	`TRACE_EXIT_RES
(
»s
);

1422  
»s
;

1423 
	}
}

1425 
	$exec_mode_£Ëù
(
vdisk_cmd
 *
vcmd
)

1427 
vdisk_dev
 *
dev
 = 
vcmd
->dev;

1428 
sc¡_u£r_scsi_cmd_exec
 *
cmd
 = &
vcmd
->cmd->
exec_cmd
;

1429 
Ëngth
 = 
cmd
->
bufæ’
;

1430 
ušt8_t
 *
add»ss
 = (ušt8_t*)()
cmd
->
pbuf
;

1431 
m£Ëù_6
, 
off£t
;

1433 
	`TRACE_ENTRY
();

1435 
m£Ëù_6
 = (
MODE_SELECT
 =ð
cmd
->
cdb
[0]);

1437 ià(!(
cmd
->
cdb
[1] & 
PF
è|| (cmd->cdb[1] & 
SP
)) {

1438 
	`PRINT_ERROR
("MODE SELECT: PF‡nd/or SP‡re wrongly set "

1439 "(cdb[1]=%x)", 
cmd
->
cdb
[1]);

1440 
	`£t_cmd_”rÜ
(
vcmd
,

1441 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

1442 
out
;

1445 ià(
m£Ëù_6
) {

1446 
off£t
 = 4;

1448 
off£t
 = 8;

1451 ià(
add»ss
[
off£t
 - 1] == 8) {

1452 
off£t
 += 8;

1453 } ià(
add»ss
[
off£t
 - 1] != 0) {

1454 
	`PRINT_ERROR
("%s", "MODE SELECT: Wrong…arameters†ist "

1456 
	`£t_cmd_”rÜ
(
vcmd
,

1457 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_·rm_li¡
));

1458 
out
;

1461 
Ëngth
 > 
off£t
 + 2) {

1462 ià(
add»ss
[
off£t
] & 
PS
) {

1463 
	`PRINT_ERROR
("%s", "MODE SELECT: Illegal PS bit");

1464 
	`£t_cmd_”rÜ
(
vcmd
, 
	`SCST_LOAD_SENSE
(

1465 
sc¡_£n£_šv®id_f›ld_š_·rm_li¡
));

1466 
out
;

1468 ià((
add»ss
[
off£t
] & 0x3f) == 0x8) {

1469 ià(
add»ss
[
off£t
 + 1] != 18) {

1470 
	`PRINT_ERROR
("%s", "MODE SELECT: Invalid "

1472 
	`£t_cmd_”rÜ
(
vcmd
, 
	`SCST_LOAD_SENSE
(

1473 
sc¡_£n£_šv®id_f›ld_š_·rm_li¡
));

1474 
out
;

1476 ià(
	`£t_wt
(
dev
,

1477 (
add»ss
[
off£t
 + 2] & 
WCE
) ? 0 : 1) != 0) {

1478 
	`£t_cmd_”rÜ
(
vcmd
,

1479 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1480 
out
;

1484 
off£t
 +ð
add»ss
[offset + 1];

1487 
out
:

1488 
	`TRACE_EXIT
();

1490 
	}
}

1492 
	$exec_»ad_ÿ·c™y
(
vdisk_cmd
 *
vcmd
)

1494 
vdisk_dev
 *
dev
 = 
vcmd
->dev;

1495 
sc¡_u£r_scsi_cmd_exec
 *
cmd
 = &
vcmd
->cmd->
exec_cmd
;

1496 
sc¡_u£r_scsi_cmd_»¶y_exec
 *
»¶y
 = &
vcmd
->»¶y->
exec_»¶y
;

1497 
Ëngth
 = 
cmd
->
bufæ’
;

1498 
ušt8_t
 *
add»ss
 = (ušt8_t*)()
cmd
->
pbuf
;

1499 
ušt32_t
 
blocksize
;

1500 
ušt64_t
 
nblocks
;

1501 
ušt8_t
 
bufãr
[8];

1503 
	`TRACE_ENTRY
();

1505 
blocksize
 = 
dev
->
block_size
;

1506 
nblocks
 = 
dev
->nblocks;

1509 
	`mem£t
(
bufãr
, 0, (buffer));

1510 ià(
nblocks
 >> 32) {

1511 
bufãr
[0] = 0xFF;

1512 
bufãr
[1] = 0xFF;

1513 
bufãr
[2] = 0xFF;

1514 
bufãr
[3] = 0xFF;

1516 
bufãr
[0] = ((
nblocks
 - 1è>> (
BYTE
 * 3)) & 0xFF;

1517 
bufãr
[1] = ((
nblocks
 - 1è>> (
BYTE
 * 2)) & 0xFF;

1518 
bufãr
[2] = ((
nblocks
 - 1è>> (
BYTE
 * 1)) & 0xFF;

1519 
bufãr
[3] = ((
nblocks
 - 1è>> (
BYTE
 * 0)) & 0xFF;

1521 
bufãr
[4] = (
blocksize
 >> (
BYTE
 * 3)) & 0xFF;

1522 
bufãr
[5] = (
blocksize
 >> (
BYTE
 * 2)) & 0xFF;

1523 
bufãr
[6] = (
blocksize
 >> (
BYTE
 * 1)) & 0xFF;

1524 
bufãr
[7] = (
blocksize
 >> (
BYTE
 * 0)) & 0xFF;

1526 
Ëngth
 = 
	`mš
Ö’gth, ()(
bufãr
));

1528 
	`memýy
(
add»ss
, 
bufãr
, 
Ëngth
);

1530 ià(
Ëngth
 < 
»¶y
->
»¥_d©a_Ën
)

1531 
	`£t_»¥_d©a_Ën
(
vcmd
, 
Ëngth
);

1533 
	`TRACE_EXIT
();

1535 
	}
}

1537 
	$exec_»ad_ÿ·c™y16
(
vdisk_cmd
 *
vcmd
)

1539 
vdisk_dev
 *
dev
 = 
vcmd
->dev;

1540 
sc¡_u£r_scsi_cmd_exec
 *
cmd
 = &
vcmd
->cmd->
exec_cmd
;

1541 
sc¡_u£r_scsi_cmd_»¶y_exec
 *
»¶y
 = &
vcmd
->»¶y->
exec_»¶y
;

1542 
Ëngth
 = 
cmd
->
bufæ’
;

1543 
ušt8_t
 *
add»ss
 = (ušt8_t*)()
cmd
->
pbuf
;

1544 
ušt32_t
 
blocksize
;

1545 
ušt64_t
 
nblocks
;

1546 
ušt8_t
 
bufãr
[32];

1548 
	`TRACE_ENTRY
();

1550 
blocksize
 = 
dev
->
block_size
;

1551 
nblocks
 = 
dev
->nblocks - 1;

1553 
	`mem£t
(
bufãr
, 0, (buffer));

1555 
bufãr
[0] = 
nblocks
 >> 56;

1556 
bufãr
[1] = (
nblocks
 >> 48) & 0xFF;

1557 
bufãr
[2] = (
nblocks
 >> 40) & 0xFF;

1558 
bufãr
[3] = (
nblocks
 >> 32) & 0xFF;

1559 
bufãr
[4] = (
nblocks
 >> 24) & 0xFF;

1560 
bufãr
[5] = (
nblocks
 >> 16) & 0xFF;

1561 
bufãr
[6] = (
nblocks
 >> 8) & 0xFF;

1562 
bufãr
[7] = 
nblocks
& 0xFF;

1564 
bufãr
[8] = (
blocksize
 >> (
BYTE
 * 3)) & 0xFF;

1565 
bufãr
[9] = (
blocksize
 >> (
BYTE
 * 2)) & 0xFF;

1566 
bufãr
[10] = (
blocksize
 >> (
BYTE
 * 1)) & 0xFF;

1567 
bufãr
[11] = (
blocksize
 >> (
BYTE
 * 0)) & 0xFF;

1569 
blocksize
) {

1571 
bufãr
[13] = 3;

1574 
bufãr
[13] = 2;

1577 
bufãr
[13] = 1;

1581 
bufãr
[13] = 0;

1585 
Ëngth
 = 
	`mš
Ö’gth, ()(
bufãr
));

1587 
	`memýy
(
add»ss
, 
bufãr
, 
Ëngth
);

1589 ià(
Ëngth
 < 
»¶y
->
»¥_d©a_Ën
)

1590 
	`£t_»¥_d©a_Ën
(
vcmd
, 
Ëngth
);

1592 
	`TRACE_EXIT
();

1594 
	}
}

1596 
	$exec_»ad_toc
(
vdisk_cmd
 *
vcmd
)

1598 
vdisk_dev
 *
dev
 = 
vcmd
->dev;

1599 
sc¡_u£r_scsi_cmd_exec
 *
cmd
 = &
vcmd
->cmd->
exec_cmd
;

1600 
sc¡_u£r_scsi_cmd_»¶y_exec
 *
»¶y
 = &
vcmd
->»¶y->
exec_»¶y
;

1601 
št32_t
 
off
 = 0;

1602 
Ëngth
 = 
cmd
->
bufæ’
;

1603 
ušt8_t
 *
add»ss
 = (ušt8_t*)()
cmd
->
pbuf
;

1604 
ušt32_t
 
nblocks
;

1605 
ušt8_t
 
bufãr
[4+8+8] = { 0x00, 0x0a, 0x01, 0x01, 0x00, 0x14,

1608 
	`TRACE_ENTRY
();

1610 ià(
dev
->
ty³
 !ð
TYPE_ROM
) {

1611 
	`PRINT_ERROR
("%s", "READ TOC for‚on-CDROM device");

1612 
	`£t_cmd_”rÜ
(
vcmd
,

1613 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

1614 
out
;

1617 ià(
cmd
->
cdb
[2] & 0x0e ) {

1618 
	`PRINT_ERROR
("%s", "READ TOC: invalid„equested data format");

1619 
	`£t_cmd_”rÜ
(
vcmd
,

1620 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

1621 
out
;

1624 ià((
cmd
->
cdb
[6] != 0 && (cmd->cdb[2] & 0x01)) ||

1625 (
cmd
->
cdb
[6] > 1 && cmd->cdb[6] != 0xAA)) {

1626 
	`PRINT_ERROR
("READ TOC: invalid„equestedrack‚umber %x",

1627 
cmd
->
cdb
[6]);

1628 
	`£t_cmd_”rÜ
(
vcmd
,

1629 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

1630 
out
;

1634 
nblocks
 = (
ušt32_t
)
dev
->nblocks;

1637 
	`mem£t
(
bufãr
, 0, (buffer));

1638 
bufãr
[2] = 0x01;

1639 
bufãr
[3] = 0x01;

1640 
off
 = 4;

1641 ià(
cmd
->
cdb
[6] <= 1)

1644 
bufãr
[
off
+1] = 0x14;

1646 
bufãr
[
off
+2] = 0x01;

1647 
off
 += 8;

1649 ià(!(
cmd
->
cdb
[2] & 0x01))

1652 
bufãr
[
off
+1] = 0x14;

1653 
bufãr
[
off
+2] = 0xAA;

1654 
bufãr
[
off
+4] = (
nblocks
 >> (
BYTE
 * 3)) & 0xFF;

1655 
bufãr
[
off
+5] = (
nblocks
 >> (
BYTE
 * 2)) & 0xFF;

1656 
bufãr
[
off
+6] = (
nblocks
 >> (
BYTE
 * 1)) & 0xFF;

1657 
bufãr
[
off
+7] = (
nblocks
 >> (
BYTE
 * 0)) & 0xFF;

1658 
off
 += 8;

1661 
bufãr
[1] = 
off
 - 2;

1663 ià(
off
 > 
Ëngth
)

1664 
off
 = 
Ëngth
;

1666 
	`memýy
(
add»ss
, 
bufãr
, 
off
);

1668 ià(
off
 < 
»¶y
->
»¥_d©a_Ën
)

1669 
	`£t_»¥_d©a_Ën
(
vcmd
, 
off
);

1671 
out
:

1672 
	`TRACE_EXIT
();

1674 
	}
}

1676 
	$exec_´ev’t_®low_medium_»mov®
(
vdisk_cmd
 *
vcmd
)

1678 
vdisk_dev
 *
dev
 = 
vcmd
->dev;

1679 
sc¡_u£r_scsi_cmd_exec
 *
cmd
 = &
vcmd
->cmd->
exec_cmd
;

1681 
	`TRACE_DBG
("PERSIST/PREVENT 0x%02x", 
cmd
->
cdb
[4]);

1683 
	`±h»ad_mu‹x_lock
(&
dev
->
dev_mu‹x
);

1684 
dev
->
´ev’t_®low_medium_»mov®
 = 
cmd
->
cdb
[4] & 0x01 ? 1 : 0;

1685 
	`±h»ad_mu‹x_uÆock
(&
dev
->
dev_mu‹x
);

1688 
	}
}

1690 
	$exec_fsync
(
vdisk_cmd
 *
vcmd
)

1692 
»s
 = 0;

1693 
vdisk_dev
 *
dev
 = 
vcmd
->dev;

1696 ià(
dev
->
nv_ÿche
 || dev->
wt_æag
 || dev->
rd_Úly_æag
 ||

1697 
dev
->
o_dœeù_æag
 || dev->
nuÎio
)

1698 
out
;

1701 
	`fsync
(
vcmd
->
fd
);

1703 
out
:

1704 
	`TRACE_EXIT_RES
(
»s
);

1705  
»s
;

1706 
	}
}

1708 
	$exec_»ad
(
vdisk_cmd
 *
vcmd
, 
loff_t
 
loff
)

1710 
vdisk_dev
 *
dev
 = 
vcmd
->dev;

1711 
sc¡_u£r_scsi_cmd_exec
 *
cmd
 = &
vcmd
->cmd->
exec_cmd
;

1712 
Ëngth
 = 
cmd
->
bufæ’
;

1713 
ušt8_t
 *
add»ss
 = (ušt8_t*)()
cmd
->
pbuf
;

1714 
fd
 = 
vcmd
->fd;

1715 
loff_t
 
”r
;

1717 
	`TRACE_ENTRY
();

1719 
	`TRACE_DBG
("»adšg ofà%"
PRId64
",†’ %d", 
loff
, 
Ëngth
);

1720 ià(
dev
->
nuÎio
)

1721 
”r
 = 
Ëngth
;

1724 
”r
 = 
	`l£ek64
(
fd
, 
loff
, 0 );

1725 ià(
”r
 !ð
loff
) {

1726 
	`PRINT_ERROR
("l£ekroubË %"
PRId64
" != %"PRId64

1727 " (”ºØ%d)", (
ušt64_t
)
”r
, (ušt64_t)
loff
,

1728 
”ºo
);

1729 
	`£t_cmd_”rÜ
(
vcmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1730 
out
;

1733 
”r
 = 
	`»ad
(
fd
, 
add»ss
, 
Ëngth
);

1736 ià((
”r
 < 0è|| (”¸< 
Ëngth
)) {

1737 
	`PRINT_ERROR
("»ad(è»tuºed %"
PRId64
" from %d (errno %d)",

1738 (
ušt64_t
)
”r
, 
Ëngth
, 
”ºo
);

1739 ià(
”r
 =ð-
EAGAIN
)

1740 
	`£t_busy
(
vcmd
);

1742 
	`£t_cmd_”rÜ
(
vcmd
,

1743 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»ad_”rÜ
));

1745 
out
;

1748 
	`£t_»¥_d©a_Ën
(
vcmd
, 
cmd
->
bufæ’
);

1750 
out
:

1751 
	`TRACE_EXIT
();

1753 
	}
}

1755 
	$exec_wr™e
(
vdisk_cmd
 *
vcmd
, 
loff_t
 
loff
)

1757 
vdisk_dev
 *
dev
 = 
vcmd
->dev;

1758 
sc¡_u£r_scsi_cmd_exec
 *
cmd
 = &
vcmd
->cmd->
exec_cmd
;

1759 
loff_t
 
”r
;

1760 
Ëngth
 = 
cmd
->
bufæ’
;

1761 
ušt8_t
 *
add»ss
 = (ušt8_t*)()
cmd
->
pbuf
;

1762 
fd
 = 
vcmd
->fd;

1764 
	`TRACE_ENTRY
();

1766 
»¡¬t
:

1767 
	`TRACE_DBG
("wr™šg ofà%"
PRId64
",†’ %d", 
loff
, 
Ëngth
);

1769 ià(
dev
->
nuÎio
)

1770 
”r
 = 
Ëngth
;

1773 
”r
 = 
	`l£ek64
(
fd
, 
loff
, 0 );

1774 ià(
”r
 !ð
loff
) {

1775 
	`PRINT_ERROR
("l£ekroubË %"
PRId64
" != %"PRId64

1776 " (”ºØ%d)", (
ušt64_t
)
”r
, (ušt64_t)
loff
,

1777 
”ºo
);

1778 
	`£t_cmd_”rÜ
(
vcmd
,

1779 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1780 
out
;

1784 
”r
 = 
	`wr™e
(
fd
, 
add»ss
, 
Ëngth
);

1787 ià(
”r
 < 0) {

1788 
	`PRINT_ERROR
("wr™e(è»tuºed %"
PRId64
" from %d (errno %d, "

1789 "cmd_h %x)", 
”r
, 
Ëngth
, 
”ºo
, 
vcmd
->
cmd
->
cmd_h
);

1790 ià(
”r
 =ð-
EAGAIN
)

1791 
	`£t_busy
(
vcmd
);

1793 
	`£t_cmd_”rÜ
(
vcmd
,

1794 
	`SCST_LOAD_SENSE
(
sc¡_£n£_wr™e_”rÜ
));

1796 
out
;

1797 } ià(
”r
 < 
Ëngth
) {

1802 
	`TRACE_MGMT_DBG
("wr™e(è»tuºed %d from %d", ()
”r
, 
Ëngth
);

1803 ià(
”r
 == 0) {

1804 
	`PRINT_INFO
("Suspicious: write()„eturned 0 from "

1805 "%d", 
Ëngth
);

1807 
Ëngth
 -ð
”r
;

1808 
»¡¬t
;

1811 
out
:

1812 
	`TRACE_EXIT
();

1814 
	}
}

1816 
	$exec_v”ify
(
vdisk_cmd
 *
vcmd
, 
loff_t
 
loff
)

1818 
vdisk_dev
 *
dev
 = 
vcmd
->dev;

1819 
sc¡_u£r_scsi_cmd_exec
 *
cmd
 = &
vcmd
->cmd->
exec_cmd
;

1820 
loff_t
 
”r
;

1821 
št64_t
 
Ëngth
 = 
cmd
->
bufæ’
;

1822 
ušt8_t
 *
add»ss
 = (ušt8_ˆ*)()
cmd
->
pbuf
;

1823 
com·»
;

1824 
fd
 = 
vcmd
->fd;

1825 
ušt8_t
 
mem_v”ify
[128*1024];

1827 
	`TRACE_ENTRY
();

1829 ià(
	`exec_fsync
(
vcmd
) != 0)

1830 
out
;

1841 ià(!
dev
->
nuÎio
) {

1842 
”r
 = 
	`l£ek64
(
fd
, 
loff
, 0 );

1843 ià(
”r
 !ð
loff
) {

1844 
	`PRINT_ERROR
("l£ekroubË %"
PRId64
" != %"PRId64

1845 " (”ºØ%d)", (
ušt64_t
)
”r
,

1846 (
ušt64_t
)
loff
, 
”ºo
);

1847 
	`£t_cmd_”rÜ
(
vcmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1848 
out
;

1852 ià((
Ëngth
 =ð0è&& (
cmd
->
d©a_Ën
 != 0)) {

1853 
Ëngth
 = 
cmd
->
d©a_Ën
;

1854 
com·»
 = 0;

1856 
com·»
 = 1;

1858 
Ëngth
 > 0) {

1859 
št64_t
 
Ën_mem
 = (
Ëngth
 > ()(
mem_v”ify
)) ?

1860 ()(
mem_v”ify
è: 
Ëngth
;

1861 
	`TRACE_DBG
("V”ify:†’gth %"
PRId64
" -†en_mem %"PRId64,

1862 
Ëngth
, 
Ën_mem
);

1864 ià(!
dev
->
nuÎio
)

1865 
”r
 = 
	`»ad
(
fd
, (*)
mem_v”ify
, 
Ën_mem
);

1867 
”r
 = 
Ën_mem
;

1868 ià((
”r
 < 0è|| (”¸< 
Ën_mem
)) {

1869 
	`PRINT_ERROR
("»ad(è»tuºed %"
PRId64
" from %"PRId64" "

1870 "Ó¼nØ%d)", (
ušt64_t
)
”r
, 
Ën_mem
, 
”ºo
);

1871 ià(
”r
 =ð-
EAGAIN
)

1872 
	`£t_busy
(
vcmd
);

1874 
	`£t_cmd_”rÜ
(
vcmd
,

1875 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»ad_”rÜ
));

1877 
out
;

1879 ià(
com·»
 && 
	`memcmp
(
add»ss
, 
mem_v”ify
, 
Ën_mem
) != 0) {

1880 
	`TRACE_DBG
("V”ify:ƒ¼Ü memcm°Ëngth %"
PRId64
, 
Ëngth
);

1881 
	`£t_cmd_”rÜ
(
vcmd
,

1882 
	`SCST_LOAD_SENSE
(
sc¡_£n£_miscom·»_”rÜ
));

1883 
out
;

1885 
Ëngth
 -ð
Ën_mem
;

1886 
add»ss
 +ð
Ën_mem
;

1889 ià(
Ëngth
 < 0) {

1890 
	`PRINT_ERROR
("Fažu»: %"
PRId64
, 
Ëngth
);

1891 
	`£t_cmd_”rÜ
(
vcmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1894 
out
:

1895 
	`TRACE_EXIT
();

1897 
	}
}

1899 
	$exec_wr™e_§me
(
vdisk_cmd
 *
vcmd
)

1901 
vdisk_dev
 *
dev
 = 
vcmd
->dev;

1902 
sc¡_u£r_scsi_cmd_exec
 *
cmd
 = &
vcmd
->cmd->
exec_cmd
;

1903 
sc¡_u£r_scsi_cmd_»¶y_exec
 *
»¶y
 = &
vcmd
->»¶y->
exec_»¶y
;

1904 
ušt64_t
 
blocks
 = 
cmd
->
d©a_Ën
 >> 
dev
->
block_shiá
;

1905 
sc¡_u£r_d©a_desütÜ
 
uwh”e
[3];

1907 
	`TRACE_ENTRY
();

1909 ià(
blocks
 < 2)

1910 
out
;

1914 
	`mem£t
(
uwh”e
, 0, (uwhere));

1916 
uwh”e
[0].
usdd_lba
 = 
cmd
->
lba
;

1917 
uwh”e
[0].
usdd_blocks
 = 1;

1918 
uwh”e
[1].
usdd_lba
 = 
cmd
->
lba
+1;

1919 
uwh”e
[1].
usdd_blocks
 = 
blocks
-1;

1921 
»¶y
->
»¶y_ty³
 = 
SCST_EXEC_REPLY_DO_WRITE_SAME
;

1922 
»¶y
->
ws_desütÜs_Ën
 = (
uwh”e
);

1923 
»¶y
->
ws_desütÜs
 = ()
uwh”e
;

1925 
out
:

1926 
	`TRACE_EXIT
();

1928 
	}
}

	@usr/fileio/common.h

18 
	~<¡dšt.h
>

19 
	~<¡ddef.h
>

20 
	~<¡dboÞ.h
>

22 
	~<sc¡_u£r.h
>

24 
	~"debug.h
"

26 #iâdeà
WRITE_SAME_10


27 
	#WRITE_SAME_10
 0x41

	)

31 
	#VENDOR
 "SCST_USR"

	)

33 
	#FIO_REV
 " 310"

	)

35 
	#MAX_USN_LEN
 (20+1è

	)

37 
	#INQ_BUF_SZ
 128

	)

38 
	#EVPD
 0x01

	)

39 
	#CMDDT
 0x02

	)

41 
	#MSENSE_BUF_SZ
 256

	)

42 
	#DBD
 0x08

	)

43 
	#WP
 0x80

	)

44 
	#DPOFUA
 0x10

	)

45 
	#WCE
 0x04

	)

47 
	#PF
 0x10

	)

48 
	#SP
 0x01

	)

49 
	#PS
 0x80

	)

51 
	#BYTE
 8

	)

52 
	#DEF_SECTORS
 56

	)

53 
	#DEF_HEADS
 255

	)

55 
	svdisk_tgt_dev
 {

56 
ušt64_t
 
	m£ss_h
;

59 
	svdisk_dev
 {

60 
	msc¡_u¤_fd
;

61 
ušt32_t
 
	mblock_size
;

62 
ušt64_t
 
	mnblocks
;

63 
	mblock_shiá
;

64 
loff_t
 
	mfže_size
;

65 *(*
	m®loc_â
)(
size_t
 
	msize
);

67 
±h»ad_mu‹x_t
 
	mdev_mu‹x
;

70 
	mrd_Úly_æag
:1;

71 
	mwt_æag
:1;

72 
	mnv_ÿche
:1;

73 
	mo_dœeù_æag
:1;

74 
	mmedŸ_chªged
:1;

75 
	m´ev’t_®low_medium_»mov®
:1;

76 
	mnuÎio
:1;

77 
	mcdrom_em±y
:1;

78 
	mnÚ_blockšg
:1;

79 #ià
defšed
(
DEBUG_TM_IGNORE
è|| defšed(
DEBUG_TM_IGNORE_ALL
)

80 
	mdebug_tm_ignÜe
:1;

81 #ià
defšed
(
DEBUG_TM_IGNORE_ALL
)

82 vÞ©ž
	mdebug_tm_ignÜe_®l
;

86 
vdisk_tgt_dev
 
	mtgt_devs
[64];

88 *
	mÇme
;

90 *
	mfže_Çme
;

91 
	mu¢
[
MAX_USN_LEN
];

92 
	mty³
;

95 
	svdisk_cmd


97 
	mfd
;

98 
sc¡_u£r_g‘_cmd
 *
	mcmd
;

99 
vdisk_dev
 *
	mdev
;

100 
	mmay_Ãed_to_ä“_pbuf
:1;

101 
sc¡_u£r_»¶y_cmd
 *
	m»¶y
;

102 
ušt8_t
 
	m£n£
[
SCST_SENSE_BUFFERSIZE
];

110 
	#mš
(
x
,
y
) ({ \

111 
	`ty³of
(
x
è
_x
 = (x); \

112 
	`ty³of
(
y
è
_y
 = (y); \

113 (è(&
_x
 =ð&
_y
); \

114 
_x
 < 
_y
 ? _x : _y; })

	)

116 
	#max
(
x
,
y
) ({ \

117 
	`ty³of
(
x
è
_x
 = (x); \

118 
	`ty³of
(
y
è
_y
 = (y); \

119 (è(&
_x
 =ð&
_y
); \

120 
_x
 > 
_y
 ? _x : _y; })

	)

122 
	#ARRAY_SIZE
(
x
è((xè/ ((x)[0]))

	)

124 
vdisk_ID
;

125 
boÞ
 
u£_muÉi
;

127 
ušt32_t
 
üc32buf
(cÚ¡ *
buf
, 
size_t
 
Ën
);

129 
ušt64_t
 
g’_dev_id_num
(cÚ¡ 
vdisk_dev
 *
dev
);

130 *
maš_loÝ
(*
¬g
);

	@usr/fileio/crc32.c

4 
	~"commÚ.h
"

49 
ušt32_t
 
	güc_32_b
[] = {

95 
	#UPDC32
(
où‘
,
üc
è(
üc_32_b
[((ücè^ ((
ušt8_t
)où‘)è& 0xff] ^ ((ücè>> 8))

	)

97 
ušt32_t
 
	$üc32buf
(cÚ¡ *
buf
, 
size_t
 
Ën
)

99 
ušt32_t
 
Þdüc32
;

101 
Þdüc32
 = 0xFFFFFFFF;

103  ; 
Ën
; --Ën, ++
buf
) {

104 
Þdüc32
 = 
	`UPDC32
(*
buf
, oldcrc32);

107  ~
Þdüc32
;

108 
	}
}

	@usr/fileio/debug.c

1 
	~"../šþude/debug.c
"

	@usr/fileio/fileio.c

18 
	~<ùy³.h
>

19 
	~<”ºo.h
>

20 
	~<fúŽ.h
>

21 
	~<¡dio.h
>

22 
	~<¡dlib.h
>

23 
	~<¡ršg.h
>

24 
	~<uni¡d.h
>

25 
	~<¡dšt.h
>

26 
	~<g‘Ýt.h
>

27 
	~<m®loc.h
>

28 
	~<¡dboÞ.h
>

29 
	~<š‰y³s.h
>

30 
	~<sigÇl.h
>

31 
	~<sys/ty³s.h
>

32 
	~<sys/u£r.h
>

33 
	~<sys/pÞl.h
>

34 
	~<sys/ioùl.h
>

36 
	~<±h»ad.h
>

38 *
	g­p_Çme
;

40 
	~"v”siÚ.h
"

41 
	~"commÚ.h
"

42 
	~"debug.h
"

44 #ià
defšed
(
DEBUG
è|| defšed(
TRACING
)

46 #ifdeà
DEBUG


52 
	#DEFAULT_LOG_FLAGS
 (
TRACE_OUT_OF_MEM
 | 
TRACE_MINOR
 | 
TRACE_PID
 | \

53 
TRACE_FUNCTION
 | 
TRACE_SPECIAL
 | 
TRACE_MGMT
 | 
TRACE_MGMT_DEBUG
 | \

54 
TRACE_TIME
)

	)

56 
	#TRACE_SN
(
¬gs
...è
	`TRACE
(
TRACE_SCSI_SERIALIZING
,‡rgs)

	)

60 #ifdeà
TRACING


61 
	#DEFAULT_LOG_FLAGS
 (
TRACE_OUT_OF_MEM
 | 
TRACE_MGMT
 | 
TRACE_PID
 | \

62 
TRACE_TIME
 | 
TRACE_SPECIAL
)

	)

64 
	#DEFAULT_LOG_FLAGS
 0

	)

68 
	gŒaû_æag
 = 
DEFAULT_LOG_FLAGS
;

71 
boÞ
 
	glog_d«mÚ
 = 
çl£
;

73 
	#DEF_BLOCK_SHIFT
 9

	)

74 
	#THREADS
 7

	)

76 
	#MAX_VDEVS
 10

	)

78 *
®ign_®loc
(
size_t
 
size
);

80 
vdisk_dev
 
	gdevs
[
MAX_VDEVS
];

81 
	gnum_devs
;

83 
	gvdisk_ID
;

84 
	gæush_š‹rv®
;

86 
	g·r£_ty³
 = 
SCST_USER_PARSE_STANDARD
;

87 
	gÚ_ä“_cmd_ty³
 = 
SCST_USER_ON_FREE_CMD_IGNORE
;

88 
	gÚ_ä“_cmd_ty³_£t
;

89 
	gmemÜy_»u£_ty³
 = 
SCST_USER_MEM_REUSE_ALL
;

90 
	gth»ads
 = 
THREADS
;

91 
	guÄeg_befÜe_þo£
;

92 
	gblock_size
 = (1 << 
DEF_BLOCK_SHIFT
);

93 
	gblock_shiá
 = 
DEF_BLOCK_SHIFT
;

94 
	gwt_æag
, 
	grd_Úly_æag
, 
	go_dœeù_æag
, 
	gnuÎio
, 
	gnv_ÿche
;

95 #ià
defšed
(
DEBUG_TM_IGNORE
è|| defšed(
DEBUG_TM_IGNORE_ALL
)

96 
	gdebug_tm_ignÜe
;

98 
	gnÚ_blockšg
, 
	gsgv_sh¬ed
, 
	gsgv_sšgË_®loc_·ges
, 
	gsgv_purge_š‹rv®
;

99 
	gsgv_di§bË_þu¡”ed_poÞ
, 
	g´—Îoc_bufãrs_num
, 
	g´—Îoc_bufãr_size
;

100 
boÞ
 
	gu£_muÉi
 = 
Œue
;

102 *(*
	g®loc_â
)(
size_t
 
	gsize
èð
®ign_®loc
;

104 
ÝtiÚ
 cÚ¡ 
	glÚg_ÝtiÚs
[] =

106 {"block", 
»quœed_¬gum’t
, 0, 'b'},

107 {"th»ads", 
»quœed_¬gum’t
, 0, 'e'},

108 {"wr™e_through", 
no_¬gum’t
, 0, 't'},

109 {"»ad_Úly", 
no_¬gum’t
, 0, 'r'},

110 {"dœeù", 
no_¬gum’t
, 0, 'o'},

111 {"nuÎio", 
no_¬gum’t
, 0, 'n'},

112 {"nv_ÿche", 
no_¬gum’t
, 0, 'c'},

113 {"·r£", 
»quœed_¬gum’t
, 0, 'p'},

114 {"Ú_ä“", 
»quœed_¬gum’t
, 0, 'f'},

115 {"mem_»u£", 
»quœed_¬gum’t
, 0, 'm'},

116 {"nÚ_blockšg", 
no_¬gum’t
, 0, 'l'},

117 {"vdisk_id", 
»quœed_¬gum’t
, 0, 'I'},

118 {"æush", 
»quœed_¬gum’t
, 0, 'F'},

119 {"uÄeg_befÜe_þo£", 
no_¬gum’t
, 0, 'u'},

120 {"sgv_sh¬ed", 
no_¬gum’t
, 0, 's'},

121 {"sgv_sšgË_ÿche", 
»quœed_¬gum’t
, 0, 'S'},

122 {"sgv_purge_š‹rv®", 
»quœed_¬gum’t
, 0, 'P'},

123 {"sgv_di§bË_þu¡”ed_poÞ", 
no_¬gum’t
, 0, 'D'},

124 {"´—Îoc_bufãrs", 
»quœed_¬gum’t
, 0, 'R'},

125 {"´—Îoc_bufãr_size", 
»quœed_¬gum’t
, 0, 'Z'},

126 {"muÉi_cmd", 
»quœed_¬gum’t
, 0, 'M'},

127 #ià
defšed
(
DEBUG
è|| defšed(
TRACING
)

128 {"debug", 
»quœed_¬gum’t
, 0, 'd'},

130 #ià
defšed
(
DEBUG_TM_IGNORE
è|| defšed(
DEBUG_TM_IGNORE_ALL
)

131 {"debug_tm_ignÜe", 
no_¬gum’t
, 0, 'g'},

133 {"v”siÚ", 
no_¬gum’t
, 0, 'v'},

134 {"h–p", 
no_¬gum’t
, 0, 'h'},

138 
	$u§ge
()

140 
	`´štf
("U§ge: % [OPTIONS]‚am·th [Çm·th] ...\n", 
­p_Çme
);

141 
	`´štf
("\nFILEIO diskargetƒmulator for SCST\n");

142 
	`´štf
(" -b, --block=size Block size, must be…ower of 2‡nd >=512\n");

143 
	`´štf
(" -e, --th»ads=couÁ Numb” oàth»ads, %d by deçuÉ\n", 
THREADS
);

144 
	`´štf
(" -t, --write_through Writehrough mode\n");

145 
	`´štf
(" -r, --read_only Read only\n");

146 
	`´štf
(" -o, --direct O_DIRECT mode\n");

147 
	`´štf
(" -n, --nullio NULLIO mode\n");

148 
	`´štf
(" -c, --nv_cache NV_CACHE mode\n");

149 
	`´štf
(" -p, --parse=type Parseype, one of \"std\" "

151 
	`´štf
(" -f, --on_free=type On free callype, one of \"ignore\" "

153 
	`´štf
(" -m, --mem_reuse=type Memory„euseype, one of \"all\" "

155 
	`´štf
(" -l, --non_blocking Use‚on-blocking operations\n");

156 
	`´štf
(" -I, --vdisk_id=ID Vdisk ID (used in multi-targets setups)\n");

157 
	`´štf
(" -F, --flush=n Flush SGV cacheƒach‚ seconds\n");

158 
	`´štf
(" -s, --sgv_shared Use shared SGV cache\n");

159 
	`´štf
(" -S, --sgv_single_cache=n Use singleƒntry SGV cache with‚…ages/entry\n");

160 
	`´štf
(" -P, --sgv_purge_interval=n Use SGV cache…urge interval‚ seconds\n");

161 
	`´štf
(" -u, --unreg_before_close Unregister before close\n");

162 
	`´štf
(" -D, --sgv_disable_clustered_pool Disable clustered SGV…ool\n");

163 
	`´štf
(" -R, --prealloc_buffers=n Prealloc‚ buffers\n");

164 
	`´štf
(" -Z, --prealloc_buffer_size=n Setshe size in KB ofƒach…realloced buffer\n");

165 
	`´štf
(" -M, --multi_cmd=v Use or‚ot multi-commands…rocessing (default: 1)\n");

166 #ià
	`defšed
(
DEBUG
è|| defšed(
TRACING
)

167 
	`´štf
(" -d, --debug=level Debugracing†evel\n");

169 #ià
	`defšed
(
DEBUG_TM_IGNORE
è|| defšed(
DEBUG_TM_IGNORE_ALL
)

170 
	`´štf
(" -g, --debug_tm_ignore Turn on DEBUG_TM_IGNORE\n");

173 
	}
}

175 
	$sc¡_ÿlc_block_shiá
(
£ùÜ_size
)

177 
block_shiá
 = 0;

178 
t
 = 
£ùÜ_size
;

180 ià(
£ùÜ_size
 == 0)

181 
out
;

183 
t
 = 
£ùÜ_size
;

185 ià((
t
 & 1) != 0)

187 
t
 >>= 1;

188 
block_shiá
++;

190 ià(
block_shiá
 < 9) {

191 
	`PRINT_ERROR
("WrÚg seùÜ siz%d", 
£ùÜ_size
);

192 
block_shiá
 = -1;

195 
out
:

196 
	`TRACE_EXIT_RES
(
block_shiá
);

197  
block_shiá
;

198 
	}
}

200 *
	$®ign_®loc
(
size_t
 
size
)

202 
	`TRACE_MEM
("Reque¡Ø®loø%zdKB", 
size
 / 1024);

203  
	`mem®ign
(
PAGE_SIZE
, 
size
);

204 
	}
}

206 
	$sig®rm_hªdËr
(
signo
)

208 
»s
, 
i
;

210 
	`TRACE_ENTRY
();

212 
	`TRACE_DBG
("%s", "Flushing cache...");

214 
i
 = 0; i < 
num_devs
; i++) {

215 
»s
 = 
	`ioùl
(
devs
[
i
].
sc¡_u¤_fd
, 
SCST_USER_FLUSH_CACHE
, 
NULL
);

216 ià(
»s
 != 0) {

217 
»s
 = 
”ºo
;

218 
	`PRINT_ERROR
("UÇbËØæush cache: %s", 
	`¡»¼Ü
(
»s
));

219 
out
;

223 
	`TRACE_DBG
("%s", "Flushing cache done.");

225 
»s
 = 
	`®¬m
(
æush_š‹rv®
);

226 ià(
»s
 != 0) {

227 
»s
 = 
”ºo
;

228 
	`PRINT_ERROR
("®¬m(èçžed: %s", 
	`¡»¼Ü
(
»s
));

229 
out
;

232 
out
:

233 
	`TRACE_EXIT
();

235 
	}
}

237 
	$sigu¤1_hªdËr
(
signo
)

239 
»s
, 
i
;

241 
	`TRACE_ENTRY
();

243 
	`TRACE_MGMT_DBG
("%s", "Capacity data changed...");

245 
i
 = 0; i < 
num_devs
; i++) {

246 
»s
 = 
	`ioùl
(
devs
[
i
].
sc¡_u¤_fd
, 
SCST_USER_DEVICE_CAPACITY_CHANGED
, 
NULL
);

247 ià(
»s
 != 0) {

248 
»s
 = 
”ºo
;

249 
	`PRINT_ERROR
("C­ac™y d©¨chªged fažed: %s", 
	`¡»¼Ü
(
»s
));

250 
out
;

254 
	`TRACE_DBG
("%s", "Capacity data changed done.");

256 
out
:

257 
	`TRACE_EXIT
();

259 
	}
}

261 
	$´—Îoc_bufãrs
(
vdisk_dev
 *
dev
)

263 
i
, 
c
, 
»s
 = 0;

265 ià(
sgv_di§bË_þu¡”ed_poÞ
)

266 
c
 = 0;

268 
c
 = 1;

271 
i
 = 0; i < 
´—Îoc_bufãrs_num
; i++) {

272 
sc¡_u£r_´—Îoc_bufãr
 
´e
;

274 
	`mem£t
(&
´e
, 0, (pre));

275 
´e
.
š
.
pbuf
 = ()
	`®loc_â
(
´—Îoc_bufãr_size
);

276 
´e
.
š
.
bufæ’
 = 
´—Îoc_bufãr_size
;

277 
´e
.
š
.
fÜ_þu¡_poÞ
 = 
c
;

279 ià(
´e
.
š
.
pbuf
 == 0) {

280 
»s
 = 
”ºo
;

281 
	`PRINT_ERROR
("Unableo…realloc buffer: %s",

282 
	`¡»¼Ü
(
»s
));

283 
out
;

286 
»s
 = 
	`ioùl
(
dev
->
sc¡_u¤_fd
, 
SCST_USER_PREALLOC_BUFFER
, &
´e
);

287 ià(
»s
 != 0) {

288 
»s
 = 
”ºo
;

289 
	`PRINT_ERROR
("Unableo send…realloced buffer: %s",

290 
	`¡»¼Ü
(
»s
));

291 
	`ä“
((*)()
´e
.
š
.
pbuf
);

292 
out
;

294 
	`TRACE_MEM
("P»®loûd bufã¸cmd_h %x", 
´e
.
out
.
cmd_h
);

296 
c
--;

297 } 
c
 >= 0);

299 
out
:

300  
»s
;

301 
	}
}

303 
	$¡¬t
(
¬gc
, **
¬gv
)

305 
»s
 = 0;

306 
fd
;

307 
i
, 
rc
;

308 *
rc1
;

309 
sc¡_u£r_dev_desc
 
desc
;

310 
±h»ad_t
 
th»ad
[
MAX_VDEVS
][
th»ads
];

312 
	`mem£t
(
th»ad
, 0, (thread));

314 
i
 = 0;

315 
Ýtšd
 -= 2;

317 
j
;

319 
Ýtšd
 += 2;

320 ià(
Ýtšd
 > (
¬gc
-2))

323 
devs
[
i
].
block_size
 = block_size;

324 
devs
[
i
].
block_shiá
 = block_shift;

325 
devs
[
i
].
®loc_â
 =‡lloc_fn;

327 
devs
[
i
].
rd_Úly_æag
 =„d_only_flag;

328 
devs
[
i
].
wt_æag
 = wt_flag;

329 
devs
[
i
].
nv_ÿche
 =‚v_cache;

330 
devs
[
i
].
o_dœeù_æag
 = o_direct_flag;

331 
devs
[
i
].
nuÎio
 =‚ullio;

332 
devs
[
i
].
nÚ_blockšg
 =‚on_blocking;

333 #ià
	`defšed
(
DEBUG_TM_IGNORE
è|| defšed(
DEBUG_TM_IGNORE_ALL
)

334 
devs
[
i
].
debug_tm_ignÜe
 = debug_tm_ignore;

336 
devs
[
i
].
ty³
 = 
TYPE_DISK
;

337 
devs
[
i
].
Çme
 = 
¬gv
[
Ýtšd
];

338 
devs
[
i
].
fže_Çme
 = 
¬gv
[
Ýtšd
+1];

340 
	`TRACE_DBG
("O³nšg fž%s", 
devs
[
i
].
fže_Çme
);

341 
fd
 = 
	`Ý’
(
devs
[
i
].
fže_Çme
, 
O_RDONLY
|
O_LARGEFILE
);

342 ià(
fd
 < 0) {

343 
»s
 = -
”ºo
;

344 
	`PRINT_ERROR
("UÇbËØÝ’ fž% (%s)", 
devs
[
i
].
fže_Çme
,

345 
	`¡»¼Ü
(-
»s
));

349 
devs
[
i
].
fže_size
 = 
	`l£ek64
(
fd
, 0, 
SEEK_END
);

350 
devs
[
i
].
nblocks
 = devs[i].
fže_size
 >> devs[i].
block_shiá
;

352 
	`þo£
(
fd
);

354 
	`PRINT_INFO
("%s", " ");

355 
	`PRINT_INFO
("Vœtu® deviû \"%s\",…©h \"%s\", siz%"
PRId64
"MB, "

356 "block siz%d,‚block %"
PRId64
", o±iÚs:", 
devs
[
i
].
Çme
,

357 
devs
[
i
].
fže_Çme
, (
ušt64_t
)devs[i].
fže_size
/1024/1024,

358 
devs
[
i
].
block_size
, (
ušt64_t
)devs[i].
nblocks
);

360 
	`¢´štf
(
devs
[
i
].
u¢
, (devs[i].u¢), "%"
PRIx64
,

361 
	`g’_dev_id_num
(&
devs
[
i
]));

362 
	`TRACE_DBG
("u¢ %s", 
devs
[
i
].
u¢
);

364 
devs
[
i
].
sc¡_u¤_fd
 = 
	`Ý’
(
DEV_USER_PATH
 
DEV_USER_NAME
, 
O_RDWR
 |

365 (
devs
[
i
].
nÚ_blockšg
 ? 
O_NONBLOCK
 : 0));

366 ià(
devs
[
i
].
sc¡_u¤_fd
 < 0) {

367 
»s
 = -
”ºo
;

368 
	`PRINT_ERROR
("Unableo open SCST device %s (%s)",

369 
DEV_USER_PATH
 
DEV_USER_NAME
, 
	`¡»¼Ü
(-
»s
));

370 
out_uÄeg
;

373 
	`mem£t
(&
desc
, 0, (desc));

374 
desc
.
liûn£_¡r
 = ()"GPL";

375 
desc
.
v”siÚ_¡r
 = ()
DEV_USER_VERSION
;

376 
	`¡ºýy
(
desc
.
Çme
, 
devs
[
i
].name, (desc.name)-1);

377 
desc
.
Çme
[(desc.name)-1] = '\0';

378 ià(
sgv_sh¬ed
) {

379 
desc
.
sgv_sh¬ed
 = 1;

380 
	`¡ºýy
(
desc
.
sgv_Çme
, 
devs
[0].
Çme
, (desc.sgv_name)-1);

381 
desc
.
sgv_Çme
[(desc.sgv_name)-1] = '\0';

383 
desc
.
sgv_sšgË_®loc_·ges
 = sgv_single_alloc_pages;

384 
desc
.
sgv_purge_š‹rv®
 = sgv_purge_interval;

385 
desc
.
sgv_di§bË_þu¡”ed_poÞ
 = sgv_disable_clustered_pool;

386 
desc
.
ty³
 = 
devs
[
i
].type;

387 
desc
.
block_size
 = 
devs
[
i
].block_size;

389 
desc
.
Ýt
.
·r£_ty³
 =…arse_type;

390 
desc
.
Ýt
.
Ú_ä“_cmd_ty³
 = on_free_cmd_type;

391 
desc
.
Ýt
.
memÜy_»u£_ty³
 = memory_reuse_type;

393 
desc
.
Ýt
.
t¡
 = 
SCST_TST_1_SEP_TASK_SETS
;

394 
desc
.
Ýt
.
tmf_Úly
 = 0;

395 
desc
.
Ýt
.
queue_®g
 = 
SCST_QUEUE_ALG_1_UNRESTRICTED_REORDER
;

396 
desc
.
Ýt
.
q”r
 = 
SCST_QERR_0_ALL_RESUME
;

397 
desc
.
Ýt
.
d_£n£
 = 
SCST_D_SENSE_0_FIXED_SENSE
;

398 #ifdeà
DEBUG_EXT_COPY_REMAP


399 
desc
.
Ýt
.
ext_cÝy_»m­_suµÜ‹d
 = 1;

402 
»s
 = 
	`ioùl
(
devs
[
i
].
sc¡_u¤_fd
, 
SCST_USER_REGISTER_DEVICE
, &
desc
);

403 ià(
»s
 != 0) {

404 
»s
 = 
”ºo
;

405 
	`PRINT_ERROR
("UÇbËØ»gi¡” deviû: %s", 
	`¡»¼Ü
(
»s
));

406 
out_uÄeg
;

409 ià((
´—Îoc_bufãrs_num
 > 0è&& (
´—Îoc_bufãr_size
 > 0)) {

410 
»s
 = 
	`´—Îoc_bufãrs
(&
devs
[
i
]);

411 ià(
»s
 != 0)

412 
out_uÄeg
;

418 
sc¡_u£r_Ýt
 
Ýt
;

420 
»s
 = 
	`ioùl
(
devs
[
i
].
sc¡_u¤_fd
, 
SCST_USER_GET_OPTIONS
, &
Ýt
);

421 ià(
»s
 != 0) {

422 
»s
 = 
”ºo
;

423 
	`PRINT_ERROR
("UÇbËØg‘ o±iÚs: %s", 
	`¡»¼Ü
(
»s
));

424 
out_uÄeg
;

427 
Ýt
.
·r£_ty³
 =…arse_type;

428 
Ýt
.
Ú_ä“_cmd_ty³
 = on_free_cmd_type;

429 
Ýt
.
memÜy_»u£_ty³
 = memory_reuse_type;

431 
»s
 = 
	`ioùl
(
devs
[
i
].
sc¡_u¤_fd
, 
SCST_USER_SET_OPTIONS
, &
Ýt
);

432 ià(
»s
 != 0) {

433 
»s
 = 
”ºo
;

434 
	`PRINT_ERROR
("UÇbËØ£ˆÝtiÚs: %s", 
	`¡»¼Ü
(
»s
));

435 
out_uÄeg
;

440 
»s
 = 
	`±h»ad_mu‹x_š™
(&
devs
[
i
].
dev_mu‹x
, 
NULL
);

441 ià(
»s
 != 0) {

442 
»s
 = 
”ºo
;

443 
	`PRINT_ERROR
("±h»ad_mu‹x_š™(èçžed: %s", 
	`¡»¼Ü
(
»s
));

444 
out_uÄeg
;

447 
j
 = 0; j < 
th»ads
; j++) {

448 
rc
 = 
	`±h»ad_ü—‹
(&
th»ad
[
i
][
j
], 
NULL
, 
maš_loÝ
, &
devs
[i]);

449 ià(
rc
 != 0) {

450 
»s
 = 
”ºo
;

451 
	`PRINT_ERROR
("pthread_create() failed: %s",

452 
	`¡»¼Ü
(
»s
));

457 
i
++;

458 
num_devs
++;

459 ià(
num_devs
 >ð
MAX_VDEVS
) {

460 
	`PRINT_INFO
("Max deviû lim™ %d„—ched", 
i
);

465 
i
 = 0; i < 
num_devs
; i++) {

466 
j
 = 0;

467 
th»ad
[
i
][
j
] != 0) {

468 
rc
 = 
	`±h»ad_još
(
th»ad
[
i
][
j
], &
rc1
);

469 ià(
rc
 != 0) {

470 
»s
 = 
”ºo
;

471 
	`PRINT_ERROR
("pthread_join() failed: %s",

472 
	`¡»¼Ü
(
»s
));

473 } ià(
rc1
 !ð
NULL
) {

474 
»s
 = ()
rc1
;

475 
	`PRINT_INFO
("Th»ad %dƒx™ed (dev %s),„e %lx", 
j
,

476 
devs
[
i
].
Çme
, ()
rc1
);

478 
	`PRINT_INFO
("Th»ad %dƒx™ed (dev %s)", 
j
,

479 
devs
[
i
].
Çme
);

480 
j
++;

482 
	`±h»ad_mu‹x_de¡roy
(&
devs
[
i
].
dev_mu‹x
);

485 
out_uÄeg
:

486 
	`®¬m
(0);

487 
i
 = 0; i < 
num_devs
; i++) {

488 ià(
uÄeg_befÜe_þo£
) {

490 
»s
 = 
	`ioùl
(
devs
[
i
].
sc¡_u¤_fd
, 
SCST_USER_UNREGISTER_DEVICE
, 
NULL
);

491 ià(
»s
 != 0) {

492 
»s
 = 
”ºo
;

493 
	`PRINT_ERROR
("Unableo unregister device: %s",

494 
	`¡»¼Ü
(
»s
));

498 
	`þo£
(
devs
[
i
].
sc¡_u¤_fd
);

501  
»s
;

502 
	}
}

504 
	$maš
(
¬gc
, **
¬gv
)

506 
»s
 = 0;

507 
ch
, 
lÚgšdex
;

508 
sigaùiÚ
 
aù
;

510 
	`£Žšebuf
(
¡dout
);

512 
»s
 = 
	`debug_š™
();

513 ià(
»s
 != 0)

514 
out
;

516 
­p_Çme
 = 
¬gv
[0];

518 
	`mem£t
(
devs
, 0, (devs));

520 (
ch
 = 
	`g‘Ýt_lÚg
(
¬gc
, 
¬gv
, "+b:e:trongluF:I:cp:f:m:d:vsS:P:hDR:Z:M:",

521 
lÚg_ÝtiÚs
, &
lÚgšdex
)) >= 0) {

522 
ch
) {

524 
block_size
 = 
	`©oi
(
Ýrg
);

525 
	`PRINT_INFO
("block_siz%x (%s)", 
block_size
, 
Ýrg
);

526 
block_shiá
 = 
	`sc¡_ÿlc_block_shiá
(
block_size
);

527 ià(
block_shiá
 < 9) {

528 
»s
 = -
EINVAL
;

529 
out_u§ge
;

533 
th»ads
 = 
	`¡¹Þ
(
Ýrg
, (**)
NULL
, 0);

536 
wt_æag
 = 1;

538 #ià
	`defšed
(
DEBUG
è|| defšed(
TRACING
)

540 
Œaû_æag
 = 
	`¡¹Þ
(
Ýrg
, (**)
NULL
, 0);

544 
rd_Úly_æag
 = 1;

547 
o_dœeù_æag
 = 1;

550 
nuÎio
 = 1;

553 
nv_ÿche
 = 1;

556 ià(
	`¡ºcmp
(
Ýrg
, "std", 3) == 0)

557 
·r£_ty³
 = 
SCST_USER_PARSE_STANDARD
;

558 ià(
	`¡ºcmp
(
Ýrg
, "call", 3) == 0)

559 
·r£_ty³
 = 
SCST_USER_PARSE_CALL
;

560 ià(
	`¡ºcmp
(
Ýrg
, "excpt", 5) == 0)

561 
·r£_ty³
 = 
SCST_USER_PARSE_EXCEPTION
;

563 
out_u§ge
;

566 
Ú_ä“_cmd_ty³_£t
 = 1;

567 ià(
	`¡ºcmp
(
Ýrg
, "ignore", 6) == 0)

568 
Ú_ä“_cmd_ty³
 = 
SCST_USER_ON_FREE_CMD_IGNORE
;

569 ià(
	`¡ºcmp
(
Ýrg
, "call", 3) == 0)

570 
Ú_ä“_cmd_ty³
 = 
SCST_USER_ON_FREE_CMD_CALL
;

572 
out_u§ge
;

575 
sgv_sh¬ed
 = 1;

578 
sgv_sšgË_®loc_·ges
 = 
	`©oi
(
Ýrg
);

581 
sgv_purge_š‹rv®
 = 
	`©oi
(
Ýrg
);

584 
sgv_di§bË_þu¡”ed_poÞ
 = 1;

587 
´—Îoc_bufãrs_num
 = 
	`©oi
(
Ýrg
);

590 
´—Îoc_bufãr_size
 = 
	`©oi
(
Ýrg
) * 1024;

593 
u£_muÉi
 = 
	`©oi
(
Ýrg
);

596 ià(
	`¡ºcmp
(
Ýrg
, "all", 3) == 0)

597 
memÜy_»u£_ty³
 = 
SCST_USER_MEM_REUSE_ALL
;

598 ià(
	`¡ºcmp
(
Ýrg
, "read", 4) == 0)

599 
memÜy_»u£_ty³
 = 
SCST_USER_MEM_REUSE_READ
;

600 ià(
	`¡ºcmp
(
Ýrg
, "write", 5) == 0)

601 
memÜy_»u£_ty³
 = 
SCST_USER_MEM_REUSE_WRITE
;

602 ià(
	`¡ºcmp
(
Ýrg
, "none", 4) == 0)

603 
memÜy_»u£_ty³
 = 
SCST_USER_MEM_NO_REUSE
;

605 
out_u§ge
;

608 
nÚ_blockšg
 = 1;

611 
vdisk_ID
 = 
	`¡¹Þ
(
Ýrg
, (**)
NULL
, 0);

614 
æush_š‹rv®
 = 
	`¡¹Þ
(
Ýrg
, (**)
NULL
, 0);

615 ià(
æush_š‹rv®
 < 0) {

616 
	`PRINT_ERROR
("Wrong flush interval %d",

617 
æush_š‹rv®
);

618 
æush_š‹rv®
 = 0;

622 
uÄeg_befÜe_þo£
 = 1;

624 #ià
	`defšed
(
DEBUG_TM_IGNORE
è|| defšed(
DEBUG_TM_IGNORE_ALL
)

626 
debug_tm_ignÜe
 = 1;

630 
	`´štf
("% v”siÚ %s\n", 
­p_Çme
, 
VERSION_STR
);

631 
out_dÚe
;

633 
out_u§ge
;

637 ià(
Ýtšd
 > (
¬gc
-2))

638 
out_u§ge
;

640 ià(!
Ú_ä“_cmd_ty³_£t
 &&

641 (
memÜy_»u£_ty³
 !ð
SCST_USER_MEM_REUSE_ALL
))

642 
Ú_ä“_cmd_ty³
 = 
SCST_USER_ON_FREE_CMD_CALL
;

644 
	`PRINT_INFO
("%s", "Options:");

646 ià(
rd_Úly_æag
)

647 
	`PRINT_INFO
(" %s", "READ ONLY");

648 ià(
wt_æag
)

649 
	`PRINT_INFO
(" %s", "WRITE THROUGH");

650 ià(
nv_ÿche
)

651 
	`PRINT_INFO
(" %s", "NV_CACHE");

652 ià(
o_dœeù_æag
)

653 
	`PRINT_INFO
(" %s", "O_DIRECT");

654 ià(
nuÎio
)

655 
	`PRINT_INFO
(" %s", "NULLIO");

656 ià(
nÚ_blockšg
)

657 
	`PRINT_INFO
(" %s", "NON-BLOCKING");

659 
·r£_ty³
) {

660 
SCST_USER_PARSE_STANDARD
:

661 
	`PRINT_INFO
(" %s", "Standard…arse");

663 
SCST_USER_PARSE_CALL
:

664 
	`PRINT_INFO
(" %s", "Call…arse");

666 
SCST_USER_PARSE_EXCEPTION
:

667 
	`PRINT_INFO
(" %s", "Exception…arse");

670 
	`sBUG
();

673 
Ú_ä“_cmd_ty³
) {

674 
SCST_USER_ON_FREE_CMD_IGNORE
:

675 
	`PRINT_INFO
(" %s", "Ignore on_free_cmd");

677 
SCST_USER_ON_FREE_CMD_CALL
:

678 
	`PRINT_INFO
(" %s", "Call on_free_cmd");

681 
	`sBUG
();

684 
memÜy_»u£_ty³
) {

685 
SCST_USER_MEM_REUSE_ALL
:

686 
	`PRINT_INFO
(" %s", "Full memory„euseƒnabled");

688 
SCST_USER_MEM_REUSE_READ
:

689 
	`PRINT_INFO
(" %s", "READ memory„euseƒnabled");

691 
SCST_USER_MEM_REUSE_WRITE
:

692 
	`PRINT_INFO
(" %s", "WRITE memory„euseƒnabled");

694 
SCST_USER_MEM_NO_REUSE
:

695 
	`PRINT_INFO
(" %s", "Memory„euse disabled");

698 
	`sBUG
();

701 ià(
sgv_sh¬ed
)

702 
	`PRINT_INFO
(" %s", "SGV shared");

704 ià(
sgv_sšgË_®loc_·ges
 != 0)

705 
	`PRINT_INFO
(" Use singleƒntry SGV cache with %d…ages/entry",

706 
sgv_sšgË_®loc_·ges
);

708 ià(
sgv_purge_š‹rv®
 != 0) {

709 ià(
sgv_purge_š‹rv®
 > 0)

710 
	`PRINT_INFO
(" Use SGV cache…urge interval %d seconds",

711 
sgv_purge_š‹rv®
);

713 
	`PRINT_INFO
(" %s", "SGV cache…urging disabled");

716 ià(
sgv_di§bË_þu¡”ed_poÞ
)

717 
	`PRINT_INFO
(" %s", "Disable clustered SGV…ool");

719 ià((
´—Îoc_bufãrs_num
 > 0è&& (
´—Îoc_bufãr_size
 > 0))

720 
	`PRINT_INFO
(" Prealloc %d buffers of %dKB",

721 
´—Îoc_bufãrs_num
, 
´—Îoc_bufãr_size
 / 1024);

723 ià(!
o_dœeù_æag
 && (
memÜy_»u£_ty³
 =ð
SCST_USER_MEM_NO_REUSE
)) {

724 
	`PRINT_INFO
(" %s", "Using unaligned buffers");

725 
®loc_â
 = 
m®loc
;

728 ià(!
u£_muÉi
)

729 
	`PRINT_INFO
(" %s", "Using SCST_USER_REPLY_AND_GET_CMD");

731 #ià
	`defšed
(
DEBUG_TM_IGNORE
è|| defšed(
DEBUG_TM_IGNORE_ALL
)

732 ià(
debug_tm_ignÜe
)

733 
	`PRINT_INFO
(" %s", "DEBUG_TM_IGNORE");

736 #ifdeà
DEBUG


737 
	`PRINT_INFO
("Œaû_æag %lx", 
Œaû_æag
);

740 
	`mem£t
(&
aù
, 0, (act));

741 
aù
.
§_hªdËr
 = 
sigu¤1_hªdËr
;

742 
aù
.
§_æags
 = 
SA_RESTART
;

743 
	`sigem±y£t
(&
aù
.
§_mask
);

744 
»s
 = 
	`sigaùiÚ
(
SIGUSR1
, &
aù
, 
NULL
);

745 ià(
»s
 != 0) {

746 
»s
 = 
”ºo
;

747 
	`PRINT_ERROR
("sigaction() failed: %s",

748 
	`¡»¼Ü
(
»s
));

752 ià(
æush_š‹rv®
 != 0) {

753 
	`mem£t
(&
aù
, 0, (act));

754 
aù
.
§_hªdËr
 = 
sig®rm_hªdËr
;

755 
aù
.
§_æags
 = 
SA_RESTART
;

756 
	`sigem±y£t
(&
aù
.
§_mask
);

757 
»s
 = 
	`sigaùiÚ
(
SIGALRM
, &
aù
, 
NULL
);

758 ià(
»s
 != 0) {

759 
»s
 = 
”ºo
;

760 
	`PRINT_ERROR
("sigaction() failed: %s",

761 
	`¡»¼Ü
(
»s
));

762 
out_dÚe
;

765 
»s
 = 
	`®¬m
(
æush_š‹rv®
);

766 ià(
»s
 != 0) {

767 
»s
 = 
”ºo
;

768 
	`PRINT_ERROR
("alarm() failed: %s",

769 
	`¡»¼Ü
(
»s
));

770 
out_dÚe
;

774 
»s
 = 
	`¡¬t
(
¬gc
, 
¬gv
);

776 
out_dÚe
:

777 
	`debug_dÚe
();

779 
out
:

780  
»s
;

782 
out_u§ge
:

783 
	`u§ge
();

784 
out_dÚe
;

785 
	}
}

	@usr/include/debug.c

22 
	~<¡dio.h
>

23 
	~<time.h
>

24 
	~<±h»ad.h
>

25 
	~<¡ršg.h
>

26 
	~<uni¡d.h
>

27 
	~<sys/sysÿÎ.h
>

29 
	~"debug.h
"

31 
pid_t
 
	$g‘tid
()

33  
	`sysÿÎ
(
__NR_g‘tid
);

34 
	}
}

36 #ià
defšed
(
DEBUG
è|| defšed(
TRACING
)

38 
	#TRACE_BUF_SIZE
 512

	)

40 
	gŒaû_buf
[
TRACE_BUF_SIZE
];

41 
±h»ad_¥šlock_t
 
	gŒaû_buf_lock
;

43 
	$debug_´št_´efix
(
Œaû_æag
, cÚ¡ *
´efix
,

44 cÚ¡ *
func
, 
lše
)

46 
i
 = 0;

48 
	`±h»ad_¥š_lock
(&
Œaû_buf_lock
);

50 ià(
Œaû_æag
 & 
TRACE_TIME
) {

51 
tm
 
t
;

52 
time_t
 
‰
;

54 
	`time
(&
‰
);

55 
	`loÿÉime_r
(&
‰
, &
t
);

56 
i
 +ð
	`¢´štf
(&
Œaû_buf
[i], 
TRACE_BUF_SIZE
 - i, "%d:%d:%d ",

57 
t
.
tm_hour
,.
tm_mš
,.
tm_£c
);

59 ià(
Œaû_æag
 & 
TRACE_PID
)

60 
i
 +ð
	`¢´štf
(&
Œaû_buf
[i], 
TRACE_BUF_SIZE
 - i, "[%d]: ",

61 
	`g‘tid
());

62 ià(
´efix
 !ð
NULL
)

63 
i
 +ð
	`¢´štf
(&
Œaû_buf
[i], 
TRACE_BUF_SIZE
 - i, "%s:", 
´efix
);

64 ià(
Œaû_æag
 & 
TRACE_FUNCTION
)

65 
i
 +ð
	`¢´štf
(&
Œaû_buf
[i], 
TRACE_BUF_SIZE
 - i, "%s:", 
func
);

66 ià(
Œaû_æag
 & 
TRACE_LINE
)

67 
i
 +ð
	`¢´štf
(&
Œaû_buf
[i], 
TRACE_BUF_SIZE
 - i, "%i:", 
lše
);

69 ià(
i
 > 0)

70 
	`PRINTN
(
LOG_INFO
, "%s", 
Œaû_buf
);

72 
	`±h»ad_¥š_uÆock
(&
Œaû_buf_lock
);

74  
i
;

75 
	}
}

77 
	$debug_´št_bufãr
(cÚ¡ *
d©a
, 
Ën
)

79 
z
, 
z1
, 
i
;

80 cÚ¡ *
buf
 = (cÚ¡ *è
d©a
;

81 
f
 = 0;

83 ià(
buf
 =ð
NULL
)

86 
	`±h»ad_¥š_lock
(&
Œaû_buf_lock
);

88 
	`PRINT
(
LOG_INFO
, " (h)___0__1__2__3__4__5__6__7__8__9__A__B__C__D__E__F");

89 
z
 = 0, 
z1
 = 0, 
i
 = 0; z < 
Ën
; z++) {

90 ià(
z
 % 16 == 0) {

91 ià(
z
 != 0) {

92 
i
 +ð
	`¢´štf
(&
Œaû_buf
[i], 
TRACE_BUF_SIZE
 - i,

94 ; (
z1
 < 
z
è&& (
i
 < 
TRACE_BUF_SIZE
 - 1);

95 
z1
++) {

96 ià((
buf
[
z1
] >= 0x20) &&

97 (
buf
[
z1
] < 0x80))

98 
Œaû_buf
[
i
++] = 
buf
[
z1
];

100 
Œaû_buf
[
i
++] = '.';

102 
Œaû_buf
[
i
] = '\0';

103 
	`PRINT
(
LOG_INFO
, "%s", 
Œaû_buf
);

104 
i
 = 0;

105 
f
 = 1;

107 
i
 +ð
	`¢´štf
(&
Œaû_buf
[i], 
TRACE_BUF_SIZE
 - i,

108 "%4x: ", 
z
);

110 
i
 +ð
	`¢´štf
(&
Œaû_buf
[i], 
TRACE_BUF_SIZE
 - i, "%02x ",

111 
buf
[
z
]);

113 
i
 +ð
	`¢´štf
(&
Œaû_buf
[i], 
TRACE_BUF_SIZE
 - i, " ");

114 ; (
z1
 < 
z
è&& (
i
 < 
TRACE_BUF_SIZE
 - 1); z1++) {

115 ià((
buf
[
z1
] > 0x20) && (buf[z1] < 0x80))

116 
Œaû_buf
[
i
++] = 
buf
[
z1
];

118 
Œaû_buf
[
i
++] = '.';

120 
Œaû_buf
[
i
] = '\0';

121 ià(
f
)

122 
	`PRINT
(
LOG_INFO
, "%s", 
Œaû_buf
);

124 
	`PRINT
(
LOG_INFO
, "%s", 
Œaû_buf
);

126 
	`±h»ad_¥š_uÆock
(&
Œaû_buf_lock
);

127 
	}
}

129 
	$debug_š™
()

131 
»s
;

133 
»s
 = 
	`±h»ad_¥š_š™
(&
Œaû_buf_lock
, 
PTHREAD_PROCESS_PRIVATE
);

134 ià(
»s
 != 0) {

135 
»s
 = 
”ºo
;

136 
	`PRINT_ERROR
("±h»ad_¥š_š™(èçžed: %s", 
	`¡»¼Ü
(
»s
));

139  
»s
;

140 
	}
}

142 
	$debug_dÚe
()

144 
	`±h»ad_¥š_de¡roy
(&
Œaû_buf_lock
);

145 
	}
}

	@usr/include/debug.h

21 #iâdeà
__DEBUG_H


22 
	#__DEBUG_H


	)

24 
	~<sys/ty³s.h
>

25 
	~<lšux/uni¡d.h
>

26 
	~<”ºo.h
>

27 
	~<sy¦og.h
>

28 
	~<¡dboÞ.h
>

30 
pid_t
 
g‘tid
();

32 
	#sBUG
(è
	`as£¹
(0)

	)

33 
	#sBUG_ON
(
p
è
	`as£¹
(!Õ))

	)

35 #ifdeà
EXTRACHECKS


36 
	#EXTRACHECKS_BUG_ON
(
a
è
	`sBUG_ON
×)

	)

38 
	#EXTRACHECKS_BUG_ON
(
a
èdØ{ } 0)

	)

41 
	#TRACE_NULL
 0x00000000

	)

42 
	#TRACE_DEBUG
 0x00000001

	)

43 
	#TRACE_FUNCTION
 0x00000002

	)

44 
	#TRACE_LINE
 0x00000004

	)

45 
	#TRACE_PID
 0x00000008

	)

46 
	#TRACE_ENTRYEXIT
 0x00000010

	)

47 
	#TRACE_BUFF
 0x00000020

	)

48 
	#TRACE_MEMORY
 0x00000040

	)

49 
	#TRACE_SG
 0x00000080

	)

50 
	#TRACE_OUT_OF_MEM
 0x00000100

	)

51 
	#TRACE_MINOR
 0x00000200

	)

52 
	#TRACE_MGMT
 0x00000400

	)

53 
	#TRACE_MGMT_DEBUG
 0x00000800

	)

54 
	#TRACE_SCSI
 0x00001000

	)

55 
	#TRACE_SPECIAL
 0x00002000

	)

56 
	#TRACE_TIME
 0x00004000

	)

57 
	#TRACE_ORDER
 0x00008000

	)

58 
	#TRACE_ALL
 0xffffffff

	)

60 
	#PRINT
(
´iÜ™y
, 
fÜm©
, 
¬gs
...) \

62 ià(
log_d«mÚ
) \

63 
	`sy¦og
(
´iÜ™y
, 
fÜm©
 "\n", ## 
¬gs
); \

65 
	`årštf
(
¡dout
, 
fÜm©
 "\n", ## 
¬gs
); \

66 } 0)

	)

68 
	#PRINTN
(
´iÜ™y
, 
fÜm©
, 
¬gs
...) \

70 ià(
log_d«mÚ
) \

71 
	`sy¦og
(
´iÜ™y
, 
fÜm©
, ## 
¬gs
); \

73 
	`årštf
(
¡dout
, 
fÜm©
, ## 
¬gs
); \

74 } 0)

	)

76 *
­p_Çme
;

77 
	#LOG_PREFIX
 
­p_Çme


	)

79 #ifdeà
LOG_PREFIX


80 
	#__LOG_PREFIX
 
LOG_PREFIX


	)

82 
	#__LOG_PREFIX
 
NULL


	)

85 
boÞ
 
log_d«mÚ
;

87 #ià
defšed
(
DEBUG
è|| defšed(
TRACING
)

89 
Œaû_æag
;

91 
debug_š™
();

92 
debug_dÚe
();

99 
debug_´št_´efix
(
Œaû_æag
, cÚ¡ *
´efix
,

100 cÚ¡ *
func
, 
lše
);

101 
debug_´št_bufãr
(cÚ¡ *
d©a
, 
Ën
);

103 
	#TRACE
(
Œaû
, 
fÜm©
, 
¬gs
...) \

105 ià(
Œaû_æag
 & (
Œaû
)) { \

106 
	`debug_´št_´efix
(
Œaû_æag
, 
__LOG_PREFIX
, \

107 
__func__
, 
__LINE__
); \

108 
	`PRINT
(
LOG_DEBUG
, 
fÜm©
, 
¬gs
); \

110 } 0)

	)

112 
	#PRINT_BUFFER
(
mes§ge
, 
buff
, 
Ën
) \

114 
	`PRINT
(
LOG_INFO
, "%s:", 
mes§ge
); \

115 
	`debug_´št_bufãr
(
buff
, 
Ën
); \

116 } 0)

	)

120 
	#TRACE
(
Œaû
, 
¬gs
...èdØ{} 0)

	)

121 
	#PRINT_BUFFER
(
mes§ge
, 
buff
, 
Ën
èdØ{} 0)

	)

123 
šlše
 
	$debug_š™
(è{  0; 
	}
}

124 
šlše
 
	$debug_dÚe
(è{
	}
}

128 #ifdeà
DEBUG


130 
	~<as£¹.h
>

132 
	#TRACE_MEM
(
fÜm©
, 
¬gs
...) \

134 ià(
Œaû_æag
 & 
TRACE_MEMORY
) { \

135 
	`debug_´št_´efix
(
Œaû_æag
, 
NULL
, \

136 
__func__
, 
__LINE__
); \

137 
	`PRINT
(
LOG_DEBUG
, 
fÜm©
, 
¬gs
); \

139 } 0)

	)

141 
	#TRACE_DBG
(
fÜm©
, 
¬gs
...) \

143 ià(
Œaû_æag
 & 
TRACE_DEBUG
) { \

144 
	`debug_´št_´efix
(
Œaû_æag
, 
NULL
, \

145 
__func__
, 
__LINE__
); \

146 
	`PRINT
(
LOG_DEBUG
, 
fÜm©
, 
¬gs
); \

148 } 0)

	)

150 
	#TRACE_DBG_SPECIAL
(
¬gs
...è
	`TRACE
(
TRACE_DEBUG
|
TRACE_SPECIAL
,‡rgs)

	)

152 
	#TRACE_MGMT_DBG
(
fÜm©
, 
¬gs
...) \

154 ià(
Œaû_æag
 & 
TRACE_MGMT_DEBUG
) { \

155 
	`debug_´št_´efix
(
Œaû_æag
, 
NULL
, \

156 
__func__
, 
__LINE__
); \

157 
	`PRINT
(
LOG_DEBUG
, 
fÜm©
, 
¬gs
); \

159 } 0)

	)

161 
	#TRACE_BUFFER
(
mes§ge
, 
buff
, 
Ën
) \

163 ià(
Œaû_æag
 & 
TRACE_BUFF
) { \

164 
	`debug_´št_´efix
(
Œaû_æag
, 
NULL
, \

165 
__func__
, 
__LINE__
); \

166 
	`PRINT
(
LOG_DEBUG
, "%s:", 
mes§ge
); \

167 
	`debug_´št_bufãr
(
buff
, 
Ën
); \

169 } 0)

	)

171 
	#TRACE_BUFF_FLAG
(
æag
, 
mes§ge
, 
buff
, 
Ën
) \

173 ià(
Œaû_æag
 & (
æag
)) { \

174 
	`debug_´št_´efix
(
Œaû_æag
, 
NULL
, \

175 
__func__
, 
__LINE__
); \

176 
	`PRINT
(
LOG_DEBUG
, "%s:", 
mes§ge
); \

177 
	`debug_´št_bufãr
(
buff
, 
Ën
); \

179 } 0)

	)

181 
	#PRINT_INFO
(
fÜm©
, 
¬gs
...) \

183 
	`debug_´št_´efix
(
Œaû_æag
, 
__LOG_PREFIX
, \

184 
__func__
, 
__LINE__
); \

185 
	`PRINT
(
LOG_INFO
, 
fÜm©
, 
¬gs
); \

186 } 0)

	)

188 
	#PRINT_WARNING
(
fÜm©
, 
¬gs
...) \

190 
	`debug_´št_´efix
(
Œaû_æag
, 
__LOG_PREFIX
, \

191 
__func__
, 
__LINE__
); \

192 
	`PRINT
(
LOG_WARNING
, "***WARNING*** " 
fÜm©
, 
¬gs
); \

193 } 0)

	)

195 
	#PRINT_ERROR
(
fÜm©
, 
¬gs
...) \

197 
	`debug_´št_´efix
(
Œaû_æag
, 
__LOG_PREFIX
, \

198 
__func__
, 
__LINE__
); \

199 
	`PRINT
(
LOG_ERR
, "***ERROR*** " 
fÜm©
, 
¬gs
); \

200 } 0)

	)

202 
	#TRACE_ENTRY
() \

204 ià(
Œaû_æag
 & 
TRACE_ENTRYEXIT
) { \

205 ià(
Œaû_æag
 & 
TRACE_PID
) { \

206 
	`PRINT
(
LOG_DEBUG
, "[%d]: ENTRY %s", \

207 
	`g‘tid
(), 
__func__
); \

209 
	`PRINT
(
LOG_DEBUG
, "ENTRY %s", \

210 
__func__
); \

213 } 0)

	)

215 
	#TRACE_EXIT
() \

217 ià(
Œaû_æag
 & 
TRACE_ENTRYEXIT
) { \

218 ià(
Œaû_æag
 & 
TRACE_PID
) { \

219 
	`PRINT
(
LOG_DEBUG
, "[%d]: EXIT %s", \

220 
	`g‘tid
(), 
__func__
); \

222 
	`PRINT
(
LOG_DEBUG
, "EXIT %s", 
__func__
); \

225 } 0)

	)

227 
	#TRACE_EXIT_RES
(
»s
) \

229 ià(
Œaû_æag
 & 
TRACE_ENTRYEXIT
) { \

230 ià(
Œaû_æag
 & 
TRACE_PID
) { \

231 
	`PRINT
(
LOG_DEBUG
, "[%d]: EXIT %s: %ld", \

232 
	`g‘tid
(), 
__func__
, \

233 ()(
»s
)); \

235 
	`PRINT
(
LOG_DEBUG
, "EXIT %s: %ld", \

236 
__func__
, ()(
»s
)); \

239 } 0)

	)

241 
	#TRACE_EXIT_HRES
(
»s
) \

243 ià(
Œaû_æag
 & 
TRACE_ENTRYEXIT
) { \

244 ià(
Œaû_æag
 & 
TRACE_PID
) { \

245 
	`PRINT
(
LOG_DEBUG
, "[%d]: EXIT %s: 0x%lx",\

246 
	`g‘tid
(), 
__func__
, \

247 ()(
»s
)); \

249 
	`PRINT
(
LOG_DEBUG
, "EXIT %s: %lx", \

250 
__func__
, ()(
»s
)); \

253 } 0)

	)

257 
	#NDEBUG


	)

258 
	~<as£¹.h
>

260 
	#TRACE_MEM
(
fÜm©
, 
¬gs
...èdØ{} 0)

	)

261 
	#TRACE_DBG
(
fÜm©
, 
¬gs
...èdØ{} 0)

	)

262 
	#TRACE_DBG_SPECIAL
(
¬gs
...èdØ{} 0)

	)

263 
	#TRACE_MGMT_DBG
(
fÜm©
, 
¬gs
...èdØ{} 0)

	)

264 
	#TRACE_BUFFER
(
mes§ge
, 
buff
, 
Ën
èdØ{} 0)

	)

265 
	#TRACE_BUFF_FLAG
(
æag
, 
mes§ge
, 
buff
, 
Ën
èdØ{} 0)

	)

266 
	#TRACE_ENTRY
(èdØ{} 0)

	)

267 
	#TRACE_EXIT
(èdØ{} 0)

	)

268 
	#TRACE_EXIT_RES
(
»s
èdØ{} 0)

	)

269 
	#TRACE_EXIT_HRES
(
»s
èdØ{} 0)

	)

271 #ifdeà
LOG_PREFIX


273 
	#PRINT_INFO
(
fÜm©
, 
¬gs
...) \

274 
	`PRINT
(
LOG_INFO
, "%s: " 
fÜm©
, 
LOG_PREFIX
, 
¬gs
) \

275 

	)

276 
	#PRINT_WARNING
(
fÜm©
, 
¬gs
...) \

277 
	`PRINT
(
LOG_WARNING
, "%s: ***WARNING*** " 
fÜm©
, \

278 
LOG_PREFIX
, 
¬gs
) \

279 

	)

280 
	#PRINT_ERROR
(
fÜm©
, 
¬gs
...) \

281 
	`PRINT
(
LOG_ERR
, "%s: ***ERROR*** " 
fÜm©
, \

282 
LOG_PREFIX
, 
¬gs
) \

283 

	)

286 
	#PRINT_INFO
(
fÜm©
, 
¬gs
...è
	`PRINT
(
LOG_INFO
, fÜm©,‡rgs)

	)

288 
	#PRINT_WARNING
(
fÜm©
, 
¬gs
...) \

289 
	`PRINT
(
LOG_WARNING
, "***WARNING*** " 
fÜm©
, 
¬gs
) \

290 

	)

291 
	#PRINT_ERROR
(
fÜm©
, 
¬gs
...) \

292 
	`PRINT
(
LOG_ERR
, "***ERROR*** " 
fÜm©
, 
¬gs
) \

293 

	)

	@usr/include/version.h

19 #iâdeà
__VERSION_H


20 
	#__VERSION_H


	)

22 
	#VERSION_STR
 "3.1.1"

	)

	@usr/stpgd/debug.c

1 
	~"../šþude/debug.c
"

	@usr/stpgd/stpgd_main.c

5 
	~<fúŽ.h
>

6 
	~<¡dlib.h
>

7 
	~<¡ršg.h
>

8 
	~<g‘Ýt.h
>

9 
	~<m®loc.h
>

10 
	~<š‰y³s.h
>

11 
	~<sys/wa™.h
>

12 
	~<sys/pÞl.h
>

13 
	~<sys/ioùl.h
>

14 
	~<¡dboÞ.h
>

15 
	~<±h»ad.h
>

16 
	~<uni¡d.h
>

17 
	~<sy¦og.h
>

18 
	~<sigÇl.h
>

19 
	~<sy¦og.h
>

21 
	~"v”siÚ.h
"

22 
	~"debug.h
"

23 
	~"sc¡_ev’t.h
"

25 *
	g­p_Çme
;

27 
	#DEFAULT_TRANSITION_TIME
 17

	)

29 #ià
defšed
(
DEBUG
è|| defšed(
TRACING
)

31 #ifdeà
DEBUG


33 
	#DEFAULT_LOG_FLAGS
 (
TRACE_OUT_OF_MEM
 | 
TRACE_MINOR
 | 
TRACE_PID
 | \

34 
TRACE_FUNCTION
 | 
TRACE_SPECIAL
 | 
TRACE_MGMT
 | 
TRACE_MGMT_DEBUG
 | \

35 
TRACE_TIME
)

	)

37 
	#TRACE_SN
(
¬gs
...è
	`TRACE
(
TRACE_SCSI_SERIALIZING
,‡rgs)

	)

41 #ifdeà
TRACING


42 
	#DEFAULT_LOG_FLAGS
 (
TRACE_OUT_OF_MEM
 | 
TRACE_MGMT
 | \

43 
TRACE_TIME
 | 
TRACE_SPECIAL
)

	)

45 
	#DEFAULT_LOG_FLAGS
 0

	)

49 
	#ARRAY_SIZE
(
x
è((x)/(x[0]))

	)

51 
boÞ
 
	glog_d«mÚ
 = 
Œue
;

52 
	gŒaû_æag
 = 
DEFAULT_LOG_FLAGS
;

55 
	gŒªs™iÚ_timeout
 = 
DEFAULT_TRANSITION_TIME
;

57 
ÝtiÚ
 cÚ¡ 
	glÚg_ÝtiÚs
[] = {

58 {"·th", 
»quœed_¬gum’t
, 0, 'p'},

59 {"timeout", 
»quœed_¬gum’t
, 0, 't'},

60 {"fÜeground", 
no_¬gum’t
, 0, 'f'},

61 #ià
defšed
(
DEBUG
è|| defšed(
TRACING
)

62 {"debug", 
»quœed_¬gum’t
, 0, 'd'},

64 {"v”siÚ", 
no_¬gum’t
, 0, 'v'},

65 {"h–p", 
no_¬gum’t
, 0, 'h'},

69 
	g¡pg_š™_»pÜt_pe
[2];

70 *
	g¡pg_·th
;

72 
	$u§ge
(
¡©us
)

74 ià(
¡©us
 != 0)

75 
	`årštf
(
¡d”r
, "Try '% --h–p' fÜ mÜšfÜm©iÚ.\n", 
­p_Çme
);

77 
	`´štf
("U§ge: % [OPTIONS]\n", 
­p_Çme
);

78 
	`´štf
("STPGarget daemon\n");

79 
	`´štf
(" -f, --foreground makehe…rogram„un inhe foreground\n");

80 
	`´štf
(" -p, --path‡bsolute…athohe STPG script\n");

81 
	`´štf
(" -t, --timeoutransitionimeout\n");

82 #ià
	`defšed
(
DEBUG
è|| defšed(
TRACING
)

83 
	`´štf
(" -d, --debug=level debugracing†evel\n");

85 
	`´štf
(" -h, --help displayhis help‡ndƒxit\n");

87 
	}
}

89 
	$¡pg_hªdË_tm_»ûived
(
sc¡_ev’t_u£r
 *
ev’t_u£r
)

95 
	}
}

97 
	$švoke_¡pg
(cÚ¡ 
ušt8_t
 *
deviû_Çme
,

98 cÚ¡ 
sc¡_ev’t_¡pg_desü
 *
desü
, 
pid_t
 *
out_pid
)

100 *
¬gs
[7], *
’v
[7];

101 
»s
 = 0, 
»t
, 
i
;

102 
pid_t
 
c_pid
;

104 
¬gs
[0] = 
¡pg_·th
;

105 
¬gs
[1] = (*)
deviû_Çme
;

106 
¬gs
[2] = (*)
desü
->
´ev_¡©e
;

107 
¬gs
[3] = (*)
desü
->
Ãw_¡©e
;

108 
¬gs
[4] = (*)
desü
->
dg_Çme
;

109 
¬gs
[5] = (*)
desü
->
tg_Çme
;

110 
¬gs
[6] = 
NULL
;

112 
’v
[0] = "PATH=/bin:/usr/bin:/sbin:/usr/sbin";

113 
»t
 = 
	`a¥rštf
(&
’v
[1], "SCST_DEVICE_NAME=%s", 
deviû_Çme
);

114 ià(
»t
 < 0) {

115 
»s
 = -
”ºo
;

116 
	`PRINT_ERROR
("a¥rštf(èçžed: %d (%s)", 
»s
, 
	`¡»¼Ü
(-res));

117 
out
;

119 
»t
 = 
	`a¥rštf
(&
’v
[2], "SCST_PREV_ALUA_STATE=%s", 
desü
->
´ev_¡©e
);

120 ià(
»t
 < 0) {

121 
»s
 = -
”ºo
;

122 
	`PRINT_ERROR
("a¥rštf(èçžed: %d (%s)", 
»s
, 
	`¡»¼Ü
(-res));

123 
out
;

125 
»t
 = 
	`a¥rštf
(&
’v
[3], "SCST_ALUA_STATE=%s", 
desü
->
Ãw_¡©e
);

126 ià(
»t
 < 0) {

127 
»s
 = -
”ºo
;

128 
	`PRINT_ERROR
("a¥rštf(èçžed: %d (%s)", 
»s
, 
	`¡»¼Ü
(-res));

129 
out
;

131 
»t
 = 
	`a¥rštf
(&
’v
[4], "SCST_DEVICE_GROUP=%s", 
desü
->
dg_Çme
);

132 ià(
»t
 < 0) {

133 
»s
 = -
”ºo
;

134 
	`PRINT_ERROR
("a¥rštf(èçžed: %d (%s)", 
»s
, 
	`¡»¼Ü
(-res));

135 
out
;

137 
»t
 = 
	`a¥rštf
(&
’v
[5], "SCST_TARGET_GROUP=%s", 
desü
->
tg_Çme
);

138 ià(
»t
 < 0) {

139 
»s
 = -
”ºo
;

140 
	`PRINT_ERROR
("a¥rštf(èçžed: %d (%s)", 
»s
, 
	`¡»¼Ü
(-res));

141 
out
;

143 
’v
[6] = 
NULL
;

145 
	`PRINT_INFO
("Invoking script %s with…arameters: %s %s %s %s %s‡ndƒnvironment: "

146 "% % % % %s", 
¡pg_·th
, 
¬gs
[1],‡rgs[2],‡rgs[3],

147 
¬gs
[4],‡rgs[5], 
’v
[1],ƒnv[2],ƒnv[3],ƒnv[4],ƒnv[5]);

149 
c_pid
 = 
	`fÜk
();

150 ià(
c_pid
 == 0) {

151 
»t
 = 
	`£gid
(
	`g‘pid
(), getpid());

152 ià(
»t
 < 0) {

153 
»s
 = -
”ºo
;

154 
	`PRINT_ERROR
("£tgid fažed %d (%s)", 
»t
, 
	`¡»¼Ü
(-ret));

156 
	`TRACE_DBG
("pgid %d (pid %d)", 
	`g‘pgid
(
	`g‘pid
()), getpid());

157 
»t
 = 
	`execve
(
¡pg_·th
, 
¬gs
, 
’v
);

158 ià(
»t
 < 0) {

159 
»s
 = -
”ºo
;

160 
	`PRINT_ERROR
("EXEC fažed %d (%s)", 
»t
, 
	`¡»¼Ü
(-ret));

162 
	`ex™
(0);

163 } ià(
c_pid
 < 0) {

164 
»s
 = -
”ºo
;

165 
	`PRINT_ERROR
("fÜk(èçžed: %d (%s)", 
»s
, 
	`¡»¼Ü
(-res));

168 *
out_pid
 = 
c_pid
;

170 
i
 = 1; i < (sigÃd)
	`ARRAY_SIZE
(
’v
); i++)

171 
	`ä“
(
’v
[
i
]);

173 
out
:

174  
»s
;

175 
	}
}

178 
	$wa™_uÁž_fšished
(
pid_t
 
pid
, 
d—dlše
, *
¡©us
, 
chžd
)

180 
»s
;

181 
time_t
 
¡¬t
, 
’d
;

182 
–­£d
;

184 
	`TRACE_ENTRY
();

186 
	`time
(&
¡¬t
);

188 
»s
 = 
	`wa™pid
(
pid
, 
¡©us
, 
WNOHANG
);

189 ià(
»s
 != 0) {

190 ià(
»s
 < 0) {

191 
»s
 = -
”ºo
;

192 
	`PRINT_ERROR
("Waitpid for…id %d (child %d) "

193 "çžed: %d (%s)", 
pid
, 
chžd
,

194 
”ºo
, 
	`¡»¼Ü
(errno));

198 
	`¦“p
(0.1);

199 
	`time
(&
’d
);

200 
–­£d
 = 
	`difáime
(
’d
, 
¡¬t
);

201 } 
–­£d
 < 
d—dlše
);

203 
	`TRACE_EXIT_RES
(
»s
);

204  
»s
;

205 
	}
}

207 
	$hªdË_¡pg_»ûived
(
sc¡_ev’t_u£r
 *
ev’t_u£r
)

209 cÚ¡ 
sc¡_ev’t_¡pg_·ylßd
 *
p
 = (sc¡_ev’t_¡pg_·ylßd *)
ev’t_u£r
->
out_ev’t
.
·ylßd
;

210 
num
, 
k
;

211 
»s
 = 0;

212 
pid_t
 
pids
[
p
->
¡pg_desütÜs_út
];

214 
	`TRACE_DBG
("deviû‚am%s, sg_desütÜs_úˆ%d", 
p
->
deviû_Çme
,

215 
p
->
¡pg_desütÜs_út
);

217 
num
 = 0;‚um < 
p
->
¡pg_desütÜs_út
;‚um++) {

218 
»s
 = 
	`švoke_¡pg
(
p
->
deviû_Çme
, &p->
¡pg_desütÜs
[
num
], &
pids
[num]);

219 
	`TRACE_DBG
("num %d,„e %d,…id %d", 
num
, 
»s
, 
pids
[num]);

220 ià(
»s
 != 0)

224 
	`TRACE_DBG
("num %d", 
num
);

225 
k
 = 0; k < 
num
; k++) {

226 
¡©us
 = 0, 
rc
;

228 
	`TRACE_DBG
("k %d,…id %d", 
k
, 
pids
[k]);

230 
rc
 = 
	`wa™_uÁž_fšished
(
pids
[
k
], 
Œªs™iÚ_timeout
, &
¡©us
, k);

231 
	`TRACE_DBG
("rø%d, stu %d", 
rc
, 
	`WEXITSTATUS
(
¡©us
));

232 ià(
rc
 > 0) {

233 ià(
»s
 == 0)

234 
»s
 = 
	`WEXITSTATUS
(
¡©us
);

236 } ià(
rc
 < 0) {

237 ià(
»s
 == 0)

238 
»s
 = 
rc
;

242 
	`PRINT_WARNING
("on_stpg %d (pid %d) did‚ot finish onime - "

243 "£ndšg SIGTERM", 
k
, 
pids
[k]);

244 ià(
»s
 == 0)

245 
»s
 = -
ETIMEDOUT
;

246 
rc
 = 
	`kžÍg
(
pids
[
k
], 
SIGTERM
);

247 ià(
rc
 < 0)

248 
	`PRINT_ERROR
("Failedo send SIGTERMo child %d (pid %d): %d/%s",

249 
k
, 
pids
[k], 
”ºo
, 
	`¡»¼Ü
(errno));

251 
rc
 = 
	`wa™_uÁž_fšished
(
pids
[
k
], 1, &
¡©us
, k);

252 ià(
rc
 != 0)

256 
	`PRINT_WARNING
("on_stpg %d (pid %d) did‚ot finish onime - "

257 "£ndšg SIGKILL", 
k
, 
pids
[k]);

258 
rc
 = 
	`kžÍg
(
pids
[
k
], 
SIGKILL
);

259 ià(
rc
 < 0) {

260 
	`PRINT_ERROR
("Failedo send SIGKILLo child %d "

261 "Õid %d): %d/%s", 
k
, 
pids
[k], 
”ºo
,

262 
	`¡»¼Ü
(
”ºo
));

265 
rc
 = 
	`wa™_uÁž_fšished
(
pids
[
k
], 1, &
¡©us
, k);

266 ià(
rc
 != 0)

271 
	`TRACE_EXIT_RES
(
»s
);

272  
»s
;

273 
	}
}

275 
	$¡pg_ev’t_loÝ
()

277 
»s
 = 0, 
¡©us
;

278 
ev’t_fd
;

279 
ušt8_t
 
ev’t_u£r_buf
[1024*1024];

280 
pid_t
 
c_pid
 = 0;

281 
pÞlfd
 
¶
;

282 
sc¡_ev’t_u£r
 *
ev’t_u£r
 =

283 (
sc¡_ev’t_u£r
 *)
ev’t_u£r_buf
;

284 
sc¡_ev’t
 
e1
;

285 
boÞ
 
fœ¡_”rÜ
 = 
Œue
;

287 
ev’t_fd
 = 
	`Ý’
(
SCST_EVENT_DEV
, 
O_RDWR
);

288 ià(
ev’t_fd
 < 0) {

289 
»s
 = -
”ºo
;

290 
	`PRINT_ERROR
("Unableo open SCSTƒvent device %s (%s)",

291 
SCST_EVENT_DEV
, 
	`¡»¼Ü
(-
»s
));

292 
out
;

295 
	`þo£
(
¡pg_š™_»pÜt_pe
[0]);

297 ià(
log_d«mÚ
)

298 
»s
 = 
	`wr™e
(
¡pg_š™_»pÜt_pe
[1], &res, (res));

300 
	`þo£
(
¡pg_š™_»pÜt_pe
[1]);

302 
	`mem£t
(&
¶
, 0, (pl));

303 
¶
.
fd
 = 
ev’t_fd
;

304 
¶
.
ev’ts
 = 
POLLIN
;

306 
	`mem£t
(&
e1
, 0, (e1));

307 
e1
.
ev’t_code
 = 
SCST_EVENT_STPG_USER_INVOKE
;

308 
	`¡ºýy
(
e1
.
issu”_Çme
, 
SCST_EVENT_SCST_CORE_ISSUER
,

309 (
e1
.
issu”_Çme
));

310 
e1
.
issu”_Çme
[(e1.issuer_name)-1] = '\0';

311 
	`PRINT_INFO
("Setting‡llowedƒvent code %d, issuer_name %s",

312 
e1
.
ev’t_code
,ƒ1.
issu”_Çme
);

314 
»s
 = 
	`ioùl
(
ev’t_fd
, 
SCST_EVENT_ALLOW_EVENT
, &
e1
);

315 ià(
»s
 != 0) {

316 
»s
 = -
”ºo
;

317 
	`PRINT_ERROR
("SCST_EVENT_ALLOW_EVENT failed: %d (%s)",

318 
»s
, 
	`¡»¼Ü
(-res));

319 
out
;

322 
e1
.
ev’t_code
 = 
SCST_EVENT_TM_FN_RECEIVED
;

323 
	`¡ºýy
(
e1
.
issu”_Çme
, 
SCST_EVENT_SCST_CORE_ISSUER
,

324 (
e1
.
issu”_Çme
));

325 
e1
.
issu”_Çme
[(e1.issuer_name)-1] = '\0';

326 
	`PRINT_INFO
("Setting‡llowedƒvent code %d, issuer_name %s",

327 
e1
.
ev’t_code
,ƒ1.
issu”_Çme
);

328 
»s
 = 
	`ioùl
(
ev’t_fd
, 
SCST_EVENT_ALLOW_EVENT
, &
e1
);

329 ià(
»s
 != 0) {

330 
»s
 = -
”ºo
;

331 
	`PRINT_ERROR
("SCST_EVENT_ALLOW_EVENT failed: %d (%s)",

332 
»s
, 
	`¡»¼Ü
(-res));

333 
out
;

337 
	`mem£t
(
ev’t_u£r_buf
, 0, (event_user_buf));

338 
ev’t_u£r
->
max_ev’t_size
 = (
ev’t_u£r_buf
);

339 
»s
 = 
	`ioùl
(
ev’t_fd
, 
SCST_EVENT_GET_NEXT_EVENT
, 
ev’t_u£r
);

340 ià(
»s
 != 0) {

341 
»s
 = -
”ºo
;

342 -
»s
) {

343 
ESRCH
:

344 
EBUSY
:

345 
	`TRACE_MGMT_DBG
("SCST_EVENT_GET_NEXT_EVENT "

346 "»tuºed %d (%s)", 
»s
, 
	`¡»¼Ü
(res));

348 
EINTR
:

350 
EAGAIN
:

351 
	`TRACE_DBG
("SCST_EVENT_GET_NEXT_EVENT, "

352 "»tuºed EAGAIN (%d)", -
»s
);

355 
	`PRINT_ERROR
("SCST_EVENT_GET_NEXT_EVENT "

356 "çžed: %d (%s)", 
»s
, 
	`¡»¼Ü
(-res));

357 ià(!
fœ¡_”rÜ
)

358 
out
;

359 
fœ¡_”rÜ
 = 
çl£
;

362 
fœ¡_”rÜ
 = 
Œue
;

363 
agaš_pÞl
:

364 
»s
 = 
	`pÞl
(&
¶
, 1, 
c_pid
 > 0 ? 1 : 0);

365 ià(
»s
 > 0)

367 ià(
»s
 == 0)

368 
agaš_pÞl
;

370 
»s
 = -
”ºo
;

371 
»s
) {

372 
ESRCH
:

373 
EBUSY
:

374 
EAGAIN
:

375 
	`TRACE_MGMT_DBG
("poll()„eturned %d "

376 "(%s)", 
»s
, 
	`¡»¼Ü
(-res));

377 
EINTR
:

378 
agaš_pÞl
;

380 
	`PRINT_ERROR
("poll() failed: %d (%s)",

381 
»s
, 
	`¡»¼Ü
(-res));

382 
agaš_pÞl
;

386 
fœ¡_”rÜ
 = 
Œue
;

387 #ifdeà
DEBUG


388 
	`PRINT_INFO
("event_code %d, issuer_name %s",

389 
ev’t_u£r
->
out_ev’t
.
ev’t_code
,

390 
ev’t_u£r
->
out_ev’t
.
issu”_Çme
);

392 ià(
ev’t_u£r
->
out_ev’t
.
·ylßd_Ën
 != 0)

393 
	`TRACE_BUFFER
("·ylßd", 
ev’t_u£r
->
out_ev’t
.
·ylßd
,

394 
ev’t_u£r
->
out_ev’t
.
·ylßd_Ën
);

396 ià(
ev’t_u£r
->
out_ev’t
.
ev’t_code
 =ð
SCST_EVENT_STPG_USER_INVOKE
) {

397 
c_pid
 = 
	`fÜk
();

398 ià(
c_pid
 == -1)

399 
	`PRINT_ERROR
("FažedØfÜk: %d", 
c_pid
);

400 ià(
c_pid
 == 0) {

401 
sc¡_ev’t_nÙify_dÚe
 
d
;

403 
	`sigÇl
(
SIGCHLD
, 
SIG_DFL
);

405 
¡©us
 = 
	`hªdË_¡pg_»ûived
(
ev’t_u£r
);

407 
	`mem£t
(&
d
, 0, (d));

408 
d
.
ev’t_id
 = 
ev’t_u£r
->
out_ev’t
.event_id;

409 
d
.
¡©us
 = status;

410 
»s
 = 
	`ioùl
(
ev’t_fd
, 
SCST_EVENT_NOTIFY_DONE
, &
d
);

411 ià(
»s
 != 0) {

412 
»s
 = -
”ºo
;

413 
	`PRINT_ERROR
("SCST_EVENT_NOTIFY_DONE "

415 
	`¡»¼Ü
(-
»s
),„es);

417 
	`PRINT_INFO
("STPGƒv’ˆcom¶‘ed w™h stu %d", 
¡©us
);

418 
	`ex™
(
»s
);

420 } ià(
ev’t_u£r
->
out_ev’t
.
ev’t_code
 =ð
SCST_EVENT_TM_FN_RECEIVED
)

421 
	`¡pg_hªdË_tm_»ûived
(
ev’t_u£r
);

423 
	`PRINT_ERROR
("UnknowÀev’ˆ%d„eûived", 
ev’t_u£r
->
out_ev’t
.
ev’t_code
);

425 
out
:

426  
»s
;

427 
	}
}

429 
	$sig_chld
(
sigÇl
)

432 ià(
sigÇl
 =ð
SIGCHLD
) {

433 
	`TRACE_DBG
("CËªu°zomb› (pid %d)", 
	`g‘pid
());

434 
	`wa™
(
NULL
);

436 
	}
}

438 
	$maš
(
¬gc
, **
¬gv
)

440 
»s
 = 0, 
ch
, 
lÚgšdex
;

441 
pid_t
 
pid
;

442 
sigaùiÚ
 
§
;

444 
	`£Žšebuf
(
¡dout
);

446 
	`Ý’log
(
¬gv
[0], 
LOG_PID
, 
LOG_USER
);

448 
»s
 = 
	`pe
(
¡pg_š™_»pÜt_pe
);

449 ià(
»s
 == -1) {

450 
»s
 = -
”ºo
;

451 
	`PRINT_ERROR
("Pçžed: %d (%s)", 
»s
, 
	`¡»¼Ü
(-res));

452 
out
;

455 
§
.
§_hªdËr
 = &
sig_chld
;

456 
	`sigem±y£t
(&
§
.
§_mask
);

457 
§
.
§_æags
 = 
SA_RESTART
 | 
SA_NOCLDSTOP
;

458 ià(
	`sigaùiÚ
(
SIGCHLD
, &
§
, 0) == -1) {

459 
	`PRINT_ERROR
("sigaùiÚ(èçžed: %d/%s", 
”ºo
, 
	`¡»¼Ü
(errno));

460 
	`ex™
(1);

467 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

469 
»s
 = 
	`debug_š™
();

470 ià(
»s
 != 0)

471 
out
;

473 
­p_Çme
 = 
¬gv
[0];

475 (
ch
 = 
	`g‘Ýt_lÚg
(
¬gc
, 
¬gv
, "+d:fp:t:hv",

476 
lÚg_ÝtiÚs
, &
lÚgšdex
)) >= 0) {

477 
ch
) {

479 
¡pg_·th
 = 
Ýrg
;

481 #ià
	`defšed
(
DEBUG
è|| defšed(
TRACING
)

483 
Œaû_æag
 = 
	`¡¹Þ
(
Ýrg
, (**)
NULL
, 0);

487 
	`´štf
("% v”siÚ %s\n", 
­p_Çme
, 
VERSION_STR
);

488 
out_dÚe
;

490 
log_d«mÚ
 = 
çl£
;

493 
Œªs™iÚ_timeout
 = 
	`¡¹Þ
(
Ýrg
, (**)
NULL
, 0);

494 ià(
Œªs™iÚ_timeout
 < 0) {

495 
	`´štf
("Inv®idimeouˆ%d\n", 
Œªs™iÚ_timeout
);

496 
»s
 = -
EINVAL
;

497 
out_dÚe
;

501 
	`u§ge
(0);

502 
out_dÚe
;

504 
out_u§ge
;

508 ià(!
¡pg_·th
)

509 
¡pg_·th
 = "/usr/local/bin/scst/scst_on_stpg";

511 ià(
	`acûss
(
¡pg_·th
, 
X_OK
) == -1) {

512 
	`PRINT_ERROR
("Script file \" %s \"does‚otƒxist or‚ot "

513 "execubË", 
¡pg_·th
);

514 
»s
 = -1;

515 
out_dÚe
;

518 #ifdeà
DEBUG


519 
	`PRINT_INFO
("Œaû_æag %lx", 
Œaû_æag
);

521 ià(
log_d«mÚ
) {

522 
Œaû_æag
 &ð~
TRACE_TIME
;

523 
Œaû_æag
 &ð~
TRACE_PID
;

525 
pid
 = 
	`fÜk
();

526 ià(
pid
 < 0) {

527 
	`PRINT_ERROR
("¡¬tšg d«mÚ fažed(%d)", 
pid
);

528 
»s
 = 
pid
;

529 
out_dÚe
;

530 } ià(
pid
) {

531 
»s1
 = -1;

533 
	`þo£
(
¡pg_š™_»pÜt_pe
[1]);

534 ià(()
	`»ad
(
¡pg_š™_»pÜt_pe
[0], &
»s1
, (res1)) < (res1)) {

535 
»s
 = -1;

536 
out_dÚe
;

538 
»s
 = 
»s1
;

539 
out_dÚe
;

543 
	`þo£
(0);

544 
	`Ý’
("/dev/nuÎ", 
O_RDWR
);

545 
	`dup2
(0, 1);

546 
	`dup2
(0, 2);

547 
	`£tsid
();

550 
»s
 = 
	`¡pg_ev’t_loÝ
();

552 
out_dÚe
:

553 
	`debug_dÚe
();

555 
out
:

556 
	`þo£log
();

557  
»s
;

559 
out_u§ge
:

560 
	`u§ge
(1);

561 
out_dÚe
;

562 
	}
}

	@
1
.
0
48
1180
scst/include/backport.h
scst/include/scst.h
scst/include/scst_const.h
scst/include/scst_debug.h
scst/include/scst_event.h
scst/include/scst_itf_ver.h
scst/include/scst_sgv.h
scst/include/scst_user.h
scst/src/dev_handlers/scst_cdrom.c
scst/src/dev_handlers/scst_changer.c
scst/src/dev_handlers/scst_dev_handler.h
scst/src/dev_handlers/scst_disk.c
scst/src/dev_handlers/scst_modisk.c
scst/src/dev_handlers/scst_processor.c
scst/src/dev_handlers/scst_raid.c
scst/src/dev_handlers/scst_tape.c
scst/src/dev_handlers/scst_user.c
scst/src/dev_handlers/scst_vdisk.c
scst/src/scst_copy_mgr.c
scst/src/scst_debug.c
scst/src/scst_dlm.c
scst/src/scst_dlm.h
scst/src/scst_event.c
scst/src/scst_lib.c
scst/src/scst_main.c
scst/src/scst_mem.c
scst/src/scst_mem.h
scst/src/scst_module.c
scst/src/scst_no_dlm.c
scst/src/scst_pres.c
scst/src/scst_pres.h
scst/src/scst_priv.h
scst/src/scst_proc.c
scst/src/scst_sysfs.c
scst/src/scst_targ.c
scst/src/scst_tg.c
usr/events/debug.c
usr/events/events.c
usr/fileio/common.c
usr/fileio/common.h
usr/fileio/crc32.c
usr/fileio/debug.c
usr/fileio/fileio.c
usr/include/debug.c
usr/include/debug.h
usr/include/version.h
usr/stpgd/debug.c
usr/stpgd/stpgd_main.c
